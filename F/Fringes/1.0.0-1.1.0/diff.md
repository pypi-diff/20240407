# Comparing `tmp/fringes-1.0.0.tar.gz` & `tmp/fringes-1.1.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "fringes-1.0.0.tar", max compression
+gzip compressed data, was "fringes-1.1.0.tar", max compression
```

## Comparing `fringes-1.0.0.tar` & `fringes-1.1.0.tar`

### file list

```diff
@@ -1,11 +1,11 @@
--rw-r--r--   0        0        0      803 2023-09-08 12:22:42.378616 fringes-1.0.0/fringes/__init__.py
--rw-r--r--   0        0        0    10718 2023-10-31 14:22:40.781429 fringes-1.0.0/fringes/decoder.py
--rw-r--r--   0        0        0   148995 2023-10-31 14:27:48.029568 fringes-1.0.0/fringes/fringes.py
--rw-r--r--   0        0        0     1435 2023-09-15 17:49:38.845283 fringes-1.0.0/fringes/grid.py
--rw-r--r--   0        0        0      120 2023-10-13 22:00:15.301332 fringes-1.0.0/fringes/readme.txt
--rw-r--r--   0        0        0    13772 2023-10-25 21:10:26.370169 fringes-1.0.0/fringes/util.py
--rw-r--r--   0        0        0    21278 2023-08-24 07:23:04.058802 fringes-1.0.0/LICENSE.txt
--rw-r--r--   0        0        0     1153 2023-10-31 14:13:47.282540 fringes-1.0.0/pyproject.toml
--rw-r--r--   0        0        0     3883 2023-10-31 14:30:47.906226 fringes-1.0.0/README.md
--rw-r--r--   0        0        0     4819 1970-01-01 00:00:00.000000 fringes-1.0.0/setup.py
--rw-r--r--   0        0        0     4997 1970-01-01 00:00:00.000000 fringes-1.0.0/PKG-INFO
+-rw-r--r--   0        0        0     2023 2024-04-04 17:33:01.725323 fringes-1.1.0/fringes/__init__.py
+-rw-r--r--   0        0        0    30067 2024-04-04 15:55:32.493493 fringes-1.1.0/fringes/decoder.py
+-rw-r--r--   0        0        0   143373 2024-04-05 08:33:10.871524 fringes-1.1.0/fringes/fringes.py
+-rw-r--r--   0        0        0     1435 2023-09-15 17:49:38.845283 fringes-1.1.0/fringes/grid.py
+-rw-r--r--   0        0        0     1667 2024-04-04 16:58:05.360788 fringes-1.1.0/fringes/main.py
+-rw-r--r--   0        0        0      240 2024-04-07 18:18:17.231413 fringes-1.1.0/fringes/readme.txt
+-rw-r--r--   0        0        0    15646 2024-04-03 12:08:47.548339 fringes-1.1.0/fringes/util.py
+-rw-r--r--   0        0        0    21278 2023-08-24 07:23:04.058802 fringes-1.1.0/LICENSE.txt
+-rw-r--r--   0        0        0     1491 2024-04-05 10:57:46.868229 fringes-1.1.0/pyproject.toml
+-rw-r--r--   0        0        0     5850 2024-04-07 18:35:16.174665 fringes-1.1.0/README.md
+-rw-r--r--   0        0        0     7046 1970-01-01 00:00:00.000000 fringes-1.1.0/PKG-INFO
```

### Comparing `fringes-1.0.0/fringes/fringes.py` & `fringes-1.1.0/fringes/fringes.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,9313 +1,8961 @@
 00000000: 696d 706f 7274 206f 730d 0a69 6d70 6f72  import os..impor
-00000010: 7420 6c6f 6767 696e 6720 6173 206c 670d  t logging as lg.
-00000020: 0a69 6d70 6f72 7420 6974 6572 746f 6f6c  .import itertool
-00000030: 7320 6173 2069 740d 0a66 726f 6d20 636f  s as it..from co
-00000040: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
-00000050: 206e 616d 6564 7475 706c 650d 0a69 6d70   namedtuple..imp
-00000060: 6f72 7420 7469 6d65 0d0a 696d 706f 7274  ort time..import
-00000070: 206a 736f 6e0d 0a0d 0a69 6d70 6f72 7420   json....import 
-00000080: 6e75 6d70 7920 6173 206e 700d 0a69 6d70  numpy as np..imp
-00000090: 6f72 7420 7363 6970 7920 6173 2073 700d  ort scipy as sp.
-000000a0: 0a69 6d70 6f72 7420 7379 6d70 790d 0a69  .import sympy..i
-000000b0: 6d70 6f72 7420 736b 696d 6167 6520 6173  mport skimage as
-000000c0: 2073 6b69 0d0a 696d 706f 7274 2063 7632   ski..import cv2
-000000d0: 0d0a 696d 706f 7274 2074 6f6d 6c0d 0a69  ..import toml..i
-000000e0: 6d70 6f72 7420 7961 6d6c 0d0a 696d 706f  mport yaml..impo
-000000f0: 7274 2061 7364 660d 0a66 726f 6d20 7369  rt asdf..from si
-00000100: 5f70 7265 6669 7820 696d 706f 7274 2073  _prefix import s
-00000110: 695f 666f 726d 6174 2061 7320 7369 0d0a  i_format as si..
-00000120: 0d0a 0d0a 6672 6f6d 202e 7574 696c 2069  ....from .util i
-00000130: 6d70 6f72 7420 7673 6861 7065 2c20 6269  mport vshape, bi
-00000140: 6c61 7465 7261 6c2c 206d 6564 6961 6e2c  lateral, median,
-00000150: 205f 7265 6d61 702c 2063 6972 6375 6c61   _remap, circula
-00000160: 725f 6469 7374 616e 6365 0d0a 6672 6f6d  r_distance..from
-00000170: 202e 2069 6d70 6f72 7420 6772 6964 0d0a   . import grid..
-00000180: 6672 6f6d 202e 6465 636f 6465 7220 696d  from .decoder im
-00000190: 706f 7274 2064 6563 6f64 650d 0a0d 0a0d  port decode.....
-000001a0: 0a63 6c61 7373 2046 7269 6e67 6573 3a0d  .class Fringes:.
-000001b0: 0a20 2020 2022 2222 4561 7379 2d74 6f2d  .    """Easy-to-
-000001c0: 7573 6520 636c 6173 7320 746f 2063 6f6e  use class to con
-000001d0: 6669 6775 7265 2c20 656e 636f 6465 2061  figure, encode a
-000001e0: 6e64 2064 6563 6f64 6520 6672 696e 6765  nd decode fringe
-000001f0: 2070 6174 7465 726e 7320 7769 7468 2070   patterns with p
-00000200: 6861 7365 2073 6869 6674 696e 6720 616c  hase shifting al
-00000210: 676f 7269 7468 6d73 2e22 2222 0d0a 0d0a  gorithms."""....
-00000220: 2020 2020 2320 6e6f 7465 3a20 7468 6520      # note: the 
-00000230: 636c 6173 7320 646f 6373 7472 696e 6720  class docstring 
-00000240: 6973 2063 6f6e 7469 6e75 6174 6564 2061  is continuated a
-00000250: 7420 7468 6520 656e 6420 6f66 2074 6865  t the end of the
-00000260: 2063 6c61 7373 0d0a 0d0a 2020 2020 2320   class....    # 
-00000270: 7661 6c75 6520 6c69 6d69 7473 0d0a 2020  value limits..  
-00000280: 2020 5f48 6d61 7820 3d20 3130 3120 2023    _Hmax = 101  #
-00000290: 2074 6869 7320 6973 2061 7262 6974 7261   this is arbitra
-000002a0: 7279 0d0a 2020 2020 5f44 6d61 7820 3d20  ry..    _Dmax = 
-000002b0: 3220 2023 206d 6178 2032 2064 696d 656e  2  # max 2 dimen
-000002c0: 7369 6f6e 730d 0a20 2020 205f 4b6d 6178  sions..    _Kmax
-000002d0: 203d 2031 3031 2020 2320 7468 6973 2069   = 101  # this i
-000002e0: 7320 6172 6269 7472 6172 792c 2062 7574  s arbitrary, but
-000002f0: 206d 7573 7420 6265 203c 2031 3238 2077   must be < 128 w
-00000300: 6865 6e20 6465 706c 6f79 696e 6720 7370  hen deploying sp
-00000310: 6174 6961 6c20 6f72 2066 7265 7175 656e  atial or frequen
-00000320: 6379 206d 756c 7469 706c 6578 696e 6720  cy multiplexing 
-00000330: 4020 7569 6e74 380d 0a20 2020 205f 4e6d  @ uint8..    _Nm
-00000340: 6178 203d 2031 3030 3120 2023 2074 6869  ax = 1001  # thi
-00000350: 7320 6973 2061 7262 6974 7261 7279 3b20  s is arbitrary; 
-00000360: 6d6f 7265 2069 7320 6265 7474 6572 2062  more is better b
-00000370: 7574 2074 6865 2069 6d70 726f 7665 6d65  ut the improveme
-00000380: 6e74 2073 6361 6c65 7320 7769 7468 2073  nt scales with s
-00000390: 7172 7428 4e29 3b20 4046 444d 3a20 3e20  qrt(N); @FDM: > 
-000003a0: 3220 2a20 5f66 6d61 7820 2b20 310d 0a20  2 * _fmax + 1.. 
-000003b0: 2020 205f 4d6d 6178 203d 2031 3031 2020     _Mmax = 101  
-000003c0: 2320 7468 6973 2069 7320 6172 6269 7472  # this is arbitr
-000003d0: 6172 793b 206d 6f72 6520 6973 2062 6574  ary; more is bet
-000003e0: 7465 7220 6275 7420 7468 6520 696d 7072  ter but the impr
-000003f0: 6f76 656d 656e 7420 7363 616c 6573 2077  ovement scales w
-00000400: 6974 6820 7371 7274 284d 290d 0a20 2020  ith sqrt(M)..   
-00000410: 2023 205f 506d 6178 3a20 696e 7420 3d20   # _Pmax: int = 
-00000420: 3335 3635 3135 3834 2020 2320 7e38 4b20  35651584  # ~8K 
-00000430: 692e 652e 206d 6178 206c 756d 6120 7069  i.e. max luma pi
-00000440: 6374 7572 6520 7369 7a65 206f 6620 6832  cture size of h2
-00000450: 3634 2c20 6832 3635 2c20 6832 3636 2076  64, h265, h266 v
-00000460: 6964 656f 2063 6f64 6563 7320 6173 206f  ideo codecs as o
-00000470: 6620 3230 3232 3b20 746f 646f 3a20 7570  f 2022; todo: up
-00000480: 6461 7465 0d0a 2020 2020 5f50 6d61 7820  date..    _Pmax 
-00000490: 3d20 322a 2a33 3020 2023 2032 5e33 3020  = 2**30  # 2^30 
-000004a0: 3d20 312c 3037 332c 3734 312c 3832 3420  = 1,073,741,824 
-000004b0: 692e 652e 2064 6566 6175 6c74 2073 697a  i.e. default siz
-000004c0: 6520 2020 6c69 6d69 7420 6f66 2069 6d72  e   limit of imr
-000004d0: 6561 6428 2920 696e 204f 7065 6e43 560d  ead() in OpenCV.
-000004e0: 0a20 2020 205f 586d 6178 203d 2032 2a2a  .    _Xmax = 2**
-000004f0: 3230 2020 2320 325e 3230 203d 2031 2c30  20  # 2^20 = 1,0
-00000500: 3438 2c35 3736 2020 2020 2069 2e65 2e20  48,576     i.e. 
-00000510: 6465 6661 756c 7420 7769 6474 6820 206c  default width  l
-00000520: 696d 6974 206f 6620 696d 7265 6164 2829  imit of imread()
-00000530: 2069 6e20 4f70 656e 4356 0d0a 2020 2020   in OpenCV..    
-00000540: 5f59 6d61 7820 3d20 322a 2a32 3020 2023  _Ymax = 2**20  #
-00000550: 2032 5e32 3020 3d20 312c 3034 382c 3537   2^20 = 1,048,57
-00000560: 3620 2020 2020 692e 652e 2064 6566 6175  6     i.e. defau
-00000570: 6c74 2068 6569 6768 7420 6c69 6d69 7420  lt height limit 
-00000580: 6f66 2069 6d72 6561 6428 2920 696e 204f  of imread() in O
-00000590: 7065 6e43 560d 0a20 2020 205f 4c6d 6178  penCV..    _Lmax
-000005a0: 203d 2032 2a2a 3230 2020 2320 325e 3230   = 2**20  # 2^20
-000005b0: 203d 2031 2c30 3438 2c35 3736 2020 2020   = 1,048,576    
-000005c0: 2069 2e65 2e20 6465 6661 756c 7420 6865   i.e. default he
-000005d0: 6967 6874 206c 696d 6974 206f 6620 696d  ight limit of im
-000005e0: 7265 6164 2829 2069 6e20 4f70 656e 4356  read() in OpenCV
-000005f0: 0d0a 2020 2020 5f54 6d61 7820 3d20 5f48  ..    _Tmax = _H
-00000600: 6d61 7820 2a20 5f44 6d61 7820 2a20 5f4b  max * _Dmax * _K
-00000610: 6d61 7820 2a20 5f4e 6d61 780d 0a20 2020  max * _Nmax..   
-00000620: 205f 616c 7068 616d 6178 203d 2032 0d0a   _alphamax = 2..
-00000630: 2020 2020 5f67 616d 6d61 6d61 7820 3d20      _gammamax = 
-00000640: 3320 2023 206d 6f73 7420 7363 7265 656e  3  # most screen
-00000650: 7320 6861 7665 2061 2067 616d 6d61 206f  s have a gamma o
-00000660: 6620 7e32 2e32 0d0a 2020 2020 2320 5f6c  f ~2.2..    # _l
-00000670: 6d69 6e6d 696e 203d 2032 2020 2320 6c20  minmin = 2  # l 
-00000680: 3d3d 2032 206f 6e6c 7920 6966 206f 6666  == 2 only if off
-00000690: 7365 7420 213d 2070 6920 2f20 3220 2b20  set != pi / 2 + 
-000006a0: 3270 692a 6b2c 2062 6573 7420 6966 206f  2pi*k, best if o
-000006b0: 6666 7365 7420 3d3d 2070 6920 2b20 3270  ffset == pi + 2p
-000006c0: 692a 6b20 7769 7468 206b 2069 7320 706f  i*k with k is po
-000006d0: 7369 7469 7665 2069 6e74 6567 6572 0d0a  sitive integer..
-000006e0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-000006f0: 2061 6c73 6f20 6c20 3c3d 2032 2079 6965   also l <= 2 yie
-00000700: 6c64 7320 6572 726f 7273 2069 6e20 5350  lds errors in SP
-00000710: 553a 2070 6861 7365 206a 756d 7073 203d  U: phase jumps =
-00000720: 2032 5049 202f 206c 6d69 6e20 3e3d 206e   2PI / lmin >= n
-00000730: 702e 7069 0d0a 2020 2020 5f6c 6d69 6e6d  p.pi..    _lminm
-00000740: 696e 203d 2033 2020 2320 6c20 3e3d 2033  in = 3  # l >= 3
-00000750: 2079 6965 6c64 7320 7375 6666 6963 6965   yields sufficie
-00000760: 6e74 206d 6f64 756c 6174 696f 6e20 7468  nt modulation th
-00000770: 656f 7265 7469 6361 6c6c 790d 0a20 2020  eoretically..   
-00000780: 2023 205f 6c6d 696e 6d69 6e20 3d20 3820   # _lminmin = 8 
-00000790: 2023 206c 203e 3d20 3820 7969 656c 6473   # l >= 8 yields
-000007a0: 2073 7566 6669 6369 656e 7420 6d6f 6475   sufficient modu
-000007b0: 6c61 7469 6f6e 2070 7261 6374 6963 616c  lation practical
-000007c0: 6c79 205b 4c69 7532 3031 345d 0d0a 0d0a  ly [Liu2014]....
-000007d0: 2020 2020 2320 616c 6c6f 7765 6420 7661      # allowed va
-000007e0: 6c75 6573 3b20 7461 6b65 2063 6172 6520  lues; take care 
-000007f0: 746f 206f 6e6c 7920 7573 6520 696d 6d75  to only use immu
-00000800: 7461 626c 6520 7479 7065 7321 2020 2320  table types!  # 
-00000810: 746f 646f 3a20 6973 2074 6861 7420 736f  todo: is that so
-00000820: 3f0d 0a20 2020 2076 616c 7565 7320 3d20  ?..    values = 
-00000830: 7b0d 0a20 2020 2020 2020 2022 6772 6964  {..        "grid
-00000840: 223a 2028 2269 6d61 6765 222c 2022 4361  ": ("image", "Ca
-00000850: 7274 6573 6961 6e22 2c20 2270 6f6c 6172  rtesian", "polar
-00000860: 222c 2022 6c6f 672d 706f 6c61 7222 292c  ", "log-polar"),
-00000870: 0d0a 2020 2020 2020 2020 2269 6e64 6578  ..        "index
-00000880: 696e 6722 3a20 2822 7879 222c 2022 696a  ing": ("xy", "ij
-00000890: 2229 2c0d 0a20 2020 2020 2020 2022 6474  "),..        "dt
-000008a0: 7970 6522 3a20 280d 0a20 2020 2020 2020  ype": (..       
-000008b0: 2020 2020 2022 626f 6f6c 222c 0d0a 2020       "bool",..  
-000008c0: 2020 2020 2020 2020 2020 2275 696e 7438            "uint8
-000008d0: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
-000008e0: 2275 696e 7431 3622 2c0d 0a20 2020 2020  "uint16",..     
-000008f0: 2020 2020 2020 2023 2022 7569 6e74 3332         # "uint32
-00000900: 222c 2020 2320 696e 7465 6765 7220 6f76  ",  # integer ov
-00000910: 6572 666c 6f77 2069 6e20 7079 7174 6772  erflow in pyqtgr
-00000920: 6170 6820 2d3e 2072 6570 6c61 6365 206c  aph -> replace l
-00000930: 696e 6520 3532 3820 6f66 2049 6d61 6765  ine 528 of Image
-00000940: 4974 656d 2e70 7920 7769 7468 3a0d 0a20  Item.py with:.. 
-00000950: 2020 2020 2020 2020 2020 2023 2022 7569             # "ui
-00000960: 6e74 3634 222c 2020 2320 6269 6e73 203d  nt64",  # bins =
-00000970: 2073 656c 662e 5f78 702e 6172 616e 6765   self._xp.arange
-00000980: 286d 6e2c 206d 7820 2b20 312e 3031 202a  (mn, mx + 1.01 *
-00000990: 2073 7465 702c 2073 7465 702c 2064 7479   step, step, dty
-000009a0: 7065 3d22 7569 6e74 3634 2229 0d0a 2020  pe="uint64")..  
-000009b0: 2020 2020 2020 2020 2020 2320 2266 6c6f            # "flo
-000009c0: 6174 3136 222c 2020 2320 6e75 6d62 6120  at16",  # numba 
-000009d0: 646f 6573 6e27 7420 6861 6e64 6c65 2066  doesn't handle f
-000009e0: 6c6f 6174 3136 2c20 616c 736f 206d 6f73  loat16, also mos
-000009f0: 7420 616c 676f 7269 7468 6d73 2063 6f6e  t algorithms con
-00000a00: 7665 7274 2066 6c6f 6174 3136 2074 6f20  vert float16 to 
-00000a10: 666c 6f61 7433 3220 616e 7977 6179 0d0a  float32 anyway..
-00000a20: 2020 2020 2020 2020 2020 2020 2266 6c6f              "flo
-00000a30: 6174 3332 222c 0d0a 2020 2020 2020 2020  at32",..        
-00000a40: 2020 2020 2266 6c6f 6174 3634 222c 0d0a      "float64",..
-00000a50: 2020 2020 2020 2020 292c 0d0a 2020 2020          ),..    
-00000a60: 2020 2020 226d 6f64 6522 3a20 2822 6661      "mode": ("fa
-00000a70: 7374 222c 2022 7072 6563 6973 6522 292c  st", "precise"),
-00000a80: 0d0a 2020 2020 7d0d 0a0d 0a20 2020 2023  ..    }....    #
-00000a90: 2061 6c6c 6f77 6564 2076 616c 7565 733b   allowed values;
-00000aa0: 2074 616b 6520 6361 7265 2074 6f20 6f6e   take care to on
-00000ab0: 6c79 2075 7365 2069 6d6d 7574 6162 6c65  ly use immutable
-00000ac0: 2074 7970 6573 210d 0a20 2020 205f 6772   types!..    _gr
-00000ad0: 6964 7320 3d20 2822 696d 6167 6522 2c20  ids = ("image", 
-00000ae0: 2243 6172 7465 7369 616e 222c 2022 706f  "Cartesian", "po
-00000af0: 6c61 7222 2c20 226c 6f67 2d70 6f6c 6172  lar", "log-polar
-00000b00: 2229 0d0a 2020 2020 5f69 6e64 6578 696e  ")..    _indexin
-00000b10: 6773 203d 2028 2278 7922 2c20 2269 6a22  gs = ("xy", "ij"
-00000b20: 290d 0a20 2020 205f 6d6f 6465 7320 3d20  )..    _modes = 
-00000b30: 2822 6661 7374 222c 2022 7072 6563 6973  ("fast", "precis
-00000b40: 6522 290d 0a20 2020 205f 6474 7970 6573  e")..    _dtypes
-00000b50: 203d 2028 0d0a 2020 2020 2020 2020 2262   = (..        "b
-00000b60: 6f6f 6c22 2c0d 0a20 2020 2020 2020 2022  ool",..        "
-00000b70: 7569 6e74 3822 2c0d 0a20 2020 2020 2020  uint8",..       
-00000b80: 2022 7569 6e74 3136 222c 0d0a 2020 2020   "uint16",..    
-00000b90: 2020 2020 2320 2275 696e 7433 3222 2c20      # "uint32", 
-00000ba0: 2023 2069 6e74 6567 6572 206f 7665 7266   # integer overf
-00000bb0: 6c6f 7720 696e 2070 7971 7467 7261 7068  low in pyqtgraph
-00000bc0: 202d 3e20 7265 706c 6163 6520 6c69 6e65   -> replace line
-00000bd0: 2035 3238 206f 6620 496d 6167 6549 7465   528 of ImageIte
-00000be0: 6d2e 7079 2077 6974 683a 0d0a 2020 2020  m.py with:..    
-00000bf0: 2020 2020 2320 2275 696e 7436 3422 2c20      # "uint64", 
-00000c00: 2023 2062 696e 7320 3d20 7365 6c66 2e5f   # bins = self._
-00000c10: 7870 2e61 7261 6e67 6528 6d6e 2c20 6d78  xp.arange(mn, mx
-00000c20: 202b 2031 2e30 3120 2a20 7374 6570 2c20   + 1.01 * step, 
-00000c30: 7374 6570 2c20 6474 7970 653d 2275 696e  step, dtype="uin
-00000c40: 7436 3422 290d 0a20 2020 2020 2020 2023  t64")..        #
-00000c50: 2022 666c 6f61 7431 3622 2c20 2023 206e   "float16",  # n
-00000c60: 756d 6261 2064 6f65 736e 2774 2068 616e  umba doesn't han
-00000c70: 646c 6520 666c 6f61 7431 362c 2061 6c73  dle float16, als
-00000c80: 6f20 6d6f 7374 2061 6c67 6f72 6974 686d  o most algorithm
-00000c90: 7320 636f 6e76 6572 7420 666c 6f61 7431  s convert float1
-00000ca0: 3620 746f 2066 6c6f 6174 3332 2061 6e79  6 to float32 any
-00000cb0: 7761 790d 0a20 2020 2020 2020 2022 666c  way..        "fl
-00000cc0: 6f61 7433 3222 2c0d 0a20 2020 2020 2020  oat32",..       
-00000cd0: 2022 666c 6f61 7436 3422 2c0d 0a20 2020   "float64",..   
-00000ce0: 2029 0d0a 0d0a 2020 2020 5f6c 6f61 6465   )....    _loade
-00000cf0: 7220 3d20 7b0d 0a20 2020 2020 2020 2022  r = {..        "
-00000d00: 2e6a 736f 6e22 3a20 6a73 6f6e 2e6c 6f61  .json": json.loa
-00000d10: 642c 0d0a 2020 2020 2020 2020 222e 7961  d,..        ".ya
-00000d20: 6d6c 223a 2079 616d 6c2e 7361 6665 5f6c  ml": yaml.safe_l
-00000d30: 6f61 642c 0d0a 2020 2020 2020 2020 222e  oad,..        ".
-00000d40: 746f 6d6c 223a 2074 6f6d 6c2e 6c6f 6164  toml": toml.load
-00000d50: 2c0d 0a20 2020 2020 2020 2022 2e61 7364  ,..        ".asd
-00000d60: 6622 3a20 6173 6466 2e6f 7065 6e2c 0d0a  f": asdf.open,..
-00000d70: 2020 2020 7d0d 0a0d 0a20 2020 205f 7665      }....    _ve
-00000d80: 7262 6f73 655f 6f75 7470 7574 203d 2028  rbose_output = (
-00000d90: 0d0a 2020 2020 2020 2020 2262 7269 6768  ..        "brigh
-00000da0: 746e 6573 7322 2c0d 0a20 2020 2020 2020  tness",..       
-00000db0: 2022 6d6f 6475 6c61 7469 6f6e 222c 0d0a   "modulation",..
-00000dc0: 2020 2020 2020 2020 2272 6567 6973 7472          "registr
-00000dd0: 6174 696f 6e22 2c0d 0a20 2020 2020 2020  ation",..       
-00000de0: 2022 7068 6173 6522 2c0d 0a20 2020 2020   "phase",..     
-00000df0: 2020 2022 6f72 6465 7222 2c0d 0a20 2020     "order",..   
-00000e00: 2020 2020 2022 7265 7369 6475 616c 7322       "residuals"
-00000e10: 2c0d 0a20 2020 2020 2020 2022 756e 6365  ,..        "unce
-00000e20: 7274 6169 6e74 7922 2c0d 0a20 2020 2020  rtainty",..     
-00000e30: 2020 2022 6578 706f 7375 7265 222c 0d0a     "exposure",..
-00000e40: 2020 2020 2020 2020 2276 6973 6962 696c          "visibil
-00000e50: 6974 7922 2c0d 0a20 2020 2029 0d0a 0d0a  ity",..    )....
-00000e60: 2020 2020 2320 6465 6661 756c 7420 7661      # default va
-00000e70: 6c75 6573 2061 7265 2064 6566 696e 6564  lues are defined
-00000e80: 2068 6572 653b 2074 616b 6520 6361 7265   here; take care
-00000e90: 2074 6f20 6f6e 6c79 2075 7365 2069 6d6d   to only use imm
-00000ea0: 7574 6162 6c65 2074 7970 6573 210d 0a20  utable types!.. 
-00000eb0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00000ec0: 0d0a 2020 2020 2020 2020 7365 6c66 2c0d  ..        self,.
-00000ed0: 0a20 2020 2020 2020 202a 6172 6773 2c20  .        *args, 
-00000ee0: 2023 2062 756e 6465 6c73 2061 6c6c 2061   # bundels all a
-00000ef0: 7267 732c 2077 6861 7420 666f 6c6c 6f77  rgs, what follow
-00000f00: 7320 6172 6520 6f6e 6c79 206b 7761 7267  s are only kwarg
-00000f10: 730d 0a20 2020 2020 2020 2059 3a20 696e  s..        Y: in
-00000f20: 7420 3d20 3132 3030 2c0d 0a20 2020 2020  t = 1200,..     
-00000f30: 2020 2058 3a20 696e 7420 3d20 3139 3230     X: int = 1920
-00000f40: 2c0d 0a20 2020 2020 2020 2048 3a20 696e  ,..        H: in
-00000f50: 7420 3d20 312c 2020 2320 696e 6665 7272  t = 1,  # inferr
-00000f60: 6564 2066 726f 6d20 680d 0a20 2020 2020  ed from h..     
-00000f70: 2020 204d 3a20 666c 6f61 7420 3d20 312e     M: float = 1.
-00000f80: 302c 2020 2320 696e 6665 7272 6564 2066  0,  # inferred f
-00000f90: 726f 6d20 680d 0a20 2020 2020 2020 2044  rom h..        D
-00000fa0: 3a20 696e 7420 3d20 322c 0d0a 2020 2020  : int = 2,..    
-00000fb0: 2020 2020 4b3a 2069 6e74 203d 2033 2c0d      K: int = 3,.
-00000fc0: 0a20 2020 2020 2020 2054 3a20 696e 7420  .        T: int 
-00000fd0: 3d20 3234 2c20 2023 2054 2069 7320 696e  = 24,  # T is in
-00000fe0: 6665 7272 6564 0d0a 2020 2020 2020 2020  ferred..        
-00000ff0: 4e3a 2074 7570 6c65 207c 206e 702e 6e64  N: tuple | np.nd
-00001000: 6172 7261 7920 3d20 6e70 2e61 7272 6179  array = np.array
-00001010: 285b 5b34 2c20 342c 2034 5d2c 205b 342c  ([[4, 4, 4], [4,
-00001020: 2034 2c20 345d 5d2c 2069 6e74 292c 0d0a   4, 4]], int),..
-00001030: 2020 2020 2020 2020 6c3a 2074 7570 6c65          l: tuple
-00001040: 207c 206e 702e 6e64 6172 7261 7920 3d20   | np.ndarray = 
-00001050: 3139 3230 202f 206e 702e 6172 7261 7928  1920 / np.array(
-00001060: 5b5b 3133 2c20 372c 2038 395d 2c20 5b31  [[13, 7, 89], [1
-00001070: 332c 2037 2c20 3839 5d5d 2c20 666c 6f61  3, 7, 89]], floa
-00001080: 7429 2c20 2023 2069 6e66 6572 7265 6420  t),  # inferred 
-00001090: 6672 6f6d 2076 0d0a 2020 2020 2020 2020  from v..        
-000010a0: 763a 2074 7570 6c65 207c 206e 702e 6e64  v: tuple | np.nd
-000010b0: 6172 7261 7920 3d20 6e70 2e61 7272 6179  array = np.array
-000010c0: 285b 5b31 332c 2037 2c20 3839 5d2c 205b  ([[13, 7, 89], [
-000010d0: 3133 2c20 372c 2038 395d 5d2c 2066 6c6f  13, 7, 89]], flo
-000010e0: 6174 292c 0d0a 2020 2020 2020 2020 663a  at),..        f:
-000010f0: 2074 7570 6c65 207c 206e 702e 6e64 6172   tuple | np.ndar
-00001100: 7261 7920 3d20 6e70 2e61 7272 6179 285b  ray = np.array([
-00001110: 5b31 2c20 312c 2031 5d2c 205b 312c 2031  [1, 1, 1], [1, 1
-00001120: 2c20 315d 5d2c 2066 6c6f 6174 292c 0d0a  , 1]], float),..
-00001130: 2020 2020 2020 2020 683a 2074 7570 6c65          h: tuple
-00001140: 207c 206e 702e 6e64 6172 7261 7920 3d20   | np.ndarray = 
-00001150: 6e70 2e61 7272 6179 285b 5b32 3535 2c20  np.array([[255, 
-00001160: 3235 352c 2032 3535 5d5d 2c20 696e 7429  255, 255]], int)
-00001170: 2c0d 0a20 2020 2020 2020 206f 3a20 666c  ,..        o: fl
-00001180: 6f61 7420 3d20 6e70 2e70 692c 0d0a 2020  oat = np.pi,..  
-00001190: 2020 2020 2020 6761 6d6d 613a 2066 6c6f        gamma: flo
-000011a0: 6174 203d 2031 2e30 2c0d 0a20 2020 2020  at = 1.0,..     
-000011b0: 2020 2041 3a20 666c 6f61 7420 3d20 3235     A: float = 25
-000011c0: 3520 2f20 322c 2020 2320 692e 652e 2049  5 / 2,  # i.e. I
-000011d0: 6d61 7820 2f20 3220 4020 7569 6e74 383b  max / 2 @ uint8;
-000011e0: 2069 6e66 6572 7265 6420 6672 6f6d 2049   inferred from I
-000011f0: 6d61 7820 616e 6420 6265 7461 0d0a 2020  max and beta..  
-00001200: 2020 2020 2020 423a 2066 6c6f 6174 203d        B: float =
-00001210: 2032 3535 202f 2032 2c20 2023 2069 2e65   255 / 2,  # i.e
-00001220: 2e20 496d 6178 202f 2032 2040 2075 696e  . Imax / 2 @ uin
-00001230: 7438 3b20 696e 6665 7272 6564 2066 726f  t8; inferred fro
-00001240: 6d20 496d 6178 2061 6e64 2062 6574 6120  m Imax and beta 
-00001250: 616e 6420 560d 0a20 2020 2020 2020 2062  and V..        b
-00001260: 6574 613a 2066 6c6f 6174 203d 2030 2e35  eta: float = 0.5
-00001270: 2c0d 0a20 2020 2020 2020 2056 3a20 666c  ,..        V: fl
-00001280: 6f61 7420 3d20 312e 302c 2020 2320 5620  oat = 1.0,  # V 
-00001290: 6973 2069 6e66 6572 7265 6420 6672 6f6d  is inferred from
-000012a0: 2041 2061 6e64 2042 0d0a 2020 2020 2020   A and B..      
-000012b0: 2020 566d 696e 3a20 666c 6f61 7420 3d20    Vmin: float = 
-000012c0: 302e 302c 0d0a 2020 2020 2020 2020 756d  0.0,..        um
-000012d0: 6178 3a20 666c 6f61 7420 3d20 302e 352c  ax: float = 0.5,
-000012e0: 0d0a 2020 2020 2020 2020 616c 7068 613a  ..        alpha:
-000012f0: 2066 6c6f 6174 203d 2031 2e30 2c0d 0a20   float = 1.0,.. 
-00001300: 2020 2020 2020 2064 7479 7065 3a20 7374         dtype: st
-00001310: 7220 7c20 6e70 2e64 7479 7065 203d 2022  r | np.dtype = "
-00001320: 7569 6e74 3822 2c0d 0a20 2020 2020 2020  uint8",..       
-00001330: 2067 7269 643a 2073 7472 203d 2022 696d   grid: str = "im
-00001340: 6167 6522 2c0d 0a20 2020 2020 2020 2061  age",..        a
-00001350: 6e67 6c65 3a20 666c 6f61 7420 3d20 302e  ngle: float = 0.
-00001360: 302c 0d0a 2020 2020 2020 2020 6178 6973  0,..        axis
-00001370: 3a20 696e 7420 3d20 302c 0d0a 2020 2020  : int = 0,..    
-00001380: 2020 2020 5344 4d3a 2062 6f6f 6c20 3d20      SDM: bool = 
-00001390: 4661 6c73 652c 0d0a 2020 2020 2020 2020  False,..        
-000013a0: 5744 4d3a 2062 6f6f 6c20 3d20 4661 6c73  WDM: bool = Fals
-000013b0: 652c 0d0a 2020 2020 2020 2020 4644 4d3a  e,..        FDM:
-000013c0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0d0a   bool = False,..
-000013d0: 2020 2020 2020 2020 7374 6174 6963 3a20          static: 
-000013e0: 626f 6f6c 203d 2046 616c 7365 2c0d 0a20  bool = False,.. 
-000013f0: 2020 2020 2020 206c 6d69 6e3a 2066 6c6f         lmin: flo
-00001400: 6174 203d 2038 2e30 2c0d 0a20 2020 2020  at = 8.0,..     
-00001410: 2020 2069 6e64 6578 696e 673a 2073 7472     indexing: str
-00001420: 203d 2022 7879 222c 0d0a 2020 2020 2020   = "xy",..      
-00001430: 2020 7265 7665 7273 653a 2062 6f6f 6c20    reverse: bool 
-00001440: 3d20 4661 6c73 652c 0d0a 2020 2020 2020  = False,..      
-00001450: 2020 7665 7262 6f73 653a 2062 6f6f 6c20    verbose: bool 
-00001460: 3d20 4661 6c73 652c 0d0a 2020 2020 2020  = False,..      
-00001470: 2020 6d6f 6465 3a20 7374 7220 3d20 2266    mode: str = "f
-00001480: 6173 7422 2c0d 0a20 2020 2020 2020 2042  ast",..        B
-00001490: 763a 2074 7570 6c65 207c 206e 702e 6e64  v: tuple | np.nd
-000014a0: 6172 7261 7920 3d20 4e6f 6e65 2c0d 0a20  array = None,.. 
-000014b0: 2020 2020 2020 206d 6167 6e69 6669 6361         magnifica
-000014c0: 7469 6f6e 3a20 666c 6f61 7420 3d20 312c  tion: float = 1,
-000014d0: 0d0a 2020 2020 2020 2020 5053 463a 2066  ..        PSF: f
-000014e0: 6c6f 6174 203d 2030 2e30 2c0d 0a20 2020  loat = 0.0,..   
-000014f0: 2020 2020 2064 6172 6b3a 2066 6c6f 6174       dark: float
-00001500: 203d 2030 2e30 2c0d 0a20 2020 2020 2020   = 0.0,..       
-00001510: 2067 6169 6e3a 2066 6c6f 6174 203d 2030   gain: float = 0
-00001520: 2e30 2c0d 0a20 2020 2020 2020 2079 303a  .0,..        y0:
-00001530: 2066 6c6f 6174 203d 2030 2e30 2c0d 0a20   float = 0.0,.. 
-00001540: 2020 2029 202d 3e20 4e6f 6e65 3a0d 0a20     ) -> None:.. 
-00001550: 2020 2020 2020 2023 2067 6976 656e 2076         # given v
-00001560: 616c 7565 7320 7768 6963 6820 6172 6520  alues which are 
-00001570: 696e 2064 6566 6175 6c74 7320 6275 7420  in defaults but 
-00001580: 6172 6520 6e6f 7420 6964 656e 7469 6361  are not identica
-00001590: 6c20 746f 2074 6865 6d0d 0a20 2020 2020  l to them..     
-000015a0: 2020 2067 6976 656e 203d 207b 0d0a 2020     given = {..  
-000015b0: 2020 2020 2020 2020 2020 6b3a 2076 2066            k: v f
-000015c0: 6f72 206b 2c20 7620 696e 2073 6f72 7465  or k, v in sorte
-000015d0: 6428 6c6f 6361 6c73 2829 2e69 7465 6d73  d(locals().items
-000015e0: 2829 2920 6966 206b 2069 6e20 7365 6c66  ()) if k in self
-000015f0: 2e64 6566 6175 6c74 7320 616e 6420 6e6f  .defaults and no
-00001600: 7420 6e70 2e61 7272 6179 5f65 7175 616c  t np.array_equal
-00001610: 2876 2c20 7365 6c66 2e64 6566 6175 6c74  (v, self.default
-00001620: 735b 6b5d 290d 0a20 2020 2020 2020 207d  s[k])..        }
-00001630: 0d0a 0d0a 2020 2020 2020 2020 2320 6c6f  ....        # lo
-00001640: 6767 6572 0d0a 2020 2020 2020 2020 7365  gger..        se
-00001650: 6c66 2e6c 6f67 6765 7220 3d20 6c67 2e67  lf.logger = lg.g
-00001660: 6574 4c6f 6767 6572 2873 656c 662e 5f5f  etLogger(self.__
-00001670: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-00001680: 2920 2023 2074 6f64 6f3a 2067 6976 6520  )  # todo: give 
-00001690: 6561 6368 206c 6f67 6765 7220 6974 7320  each logger its 
-000016a0: 6f77 6e20 696e 7374 616e 6365 206e 616d  own instance nam
-000016b0: 652c 2076 6961 2069 6428 2920 3f0d 0a20  e, via id() ?.. 
-000016c0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-000016d0: 6572 2e73 6574 4c65 7665 6c28 2257 4152  er.setLevel("WAR
-000016e0: 4e49 4e47 2229 0d0a 2020 2020 2020 2020  NING")..        
-000016f0: 6966 206e 6f74 2073 656c 662e 6c6f 6767  if not self.logg
-00001700: 6572 2e68 6173 4861 6e64 6c65 7273 2829  er.hasHandlers()
-00001710: 3a0d 0a20 2020 2020 2020 2020 2020 2066  :..            f
-00001720: 6f72 6d61 7474 6572 203d 206c 672e 466f  ormatter = lg.Fo
-00001730: 726d 6174 7465 7228 2225 2861 7363 7469  rmatter("%(ascti
-00001740: 6d65 2973 2025 286c 6576 656c 6e61 6d65  me)s %(levelname
-00001750: 292d 3873 2025 286e 616d 6529 3773 2e25  )-8s %(name)7s.%
-00001760: 2866 756e 634e 616d 6529 2d31 3173 3a20  (funcName)-11s: 
-00001770: 2528 6d65 7373 6167 6529 7322 290d 0a20  %(message)s").. 
-00001780: 2020 2020 2020 2020 2020 2068 616e 646c             handl
-00001790: 6572 203d 206c 672e 5374 7265 616d 4861  er = lg.StreamHa
-000017a0: 6e64 6c65 7228 290d 0a20 2020 2020 2020  ndler()..       
-000017b0: 2020 2020 2068 616e 646c 6572 2e73 6574       handler.set
-000017c0: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
-000017d0: 7465 7229 0d0a 2020 2020 2020 2020 2020  ter)..          
-000017e0: 2020 7365 6c66 2e6c 6f67 6765 722e 6164    self.logger.ad
-000017f0: 6448 616e 646c 6572 2868 616e 646c 6572  dHandler(handler
-00001800: 290d 0a0d 0a20 2020 2020 2020 2023 2073  )....        # s
-00001810: 6574 2064 6566 6175 6c74 2076 616c 7565  et default value
-00001820: 730d 0a20 2020 2020 2020 2073 656c 662e  s..        self.
-00001830: 5f55 4d52 203d 204e 6f6e 6520 2023 2075  _UMR = None  # u
-00001840: 7365 6420 666f 7220 6361 6368 696e 670d  sed for caching.
-00001850: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
-00001860: 7620 696e 2073 656c 662e 6465 6661 756c  v in self.defaul
-00001870: 7473 2e69 7465 6d73 2829 3a0d 0a20 2020  ts.items():..   
-00001880: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
-00001890: 7420 696e 2022 484d 546c 4142 223a 2020  t in "HMTlAB":  
-000018a0: 2320 7468 6573 6520 7072 6f70 6572 7469  # these properti
-000018b0: 6573 2061 7265 2069 6e66 6572 7265 6420  es are inferred 
-000018c0: 6672 6f6d 206f 7468 6572 730d 0a20 2020  from others..   
-000018d0: 2020 2020 2020 2020 2020 2020 2073 6574               set
-000018e0: 6174 7472 2873 656c 662c 2066 225f 7b6b  attr(self, f"_{k
-000018f0: 7d22 2c20 7629 2020 2320 6465 6669 6e65  }", v)  # define
-00001900: 2070 7269 7661 7465 2076 6172 6961 626c   private variabl
-00001910: 6573 2066 726f 6d20 7768 6572 6520 7468  es from where th
-00001920: 6520 7072 6f70 6572 7469 6573 2067 6574  e properties get
-00001930: 2074 6865 6972 2076 616c 7565 2066 726f   their value fro
-00001940: 6d0d 0a0d 0a20 2020 2020 2020 2023 2073  m....        # s
-00001950: 6574 2067 6976 656e 2076 616c 7565 730d  et given values.
-00001960: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
-00001970: 7261 6d73 203d 2067 6976 656e 0d0a 0d0a  rams = given....
-00001980: 2020 2020 2020 2020 2320 5f20 3d20 7365          # _ = se
-00001990: 6c66 2e55 4d52 2020 2320 7072 6f70 6572  lf.UMR  # proper
-000019a0: 7479 2027 554d 5227 206c 6f67 7320 7761  ty 'UMR' logs wa
-000019b0: 726e 696e 6720 6966 206e 6563 6573 7361  rning if necessa
-000019c0: 7279 0d0a 0d0a 2020 2020 6465 6620 5f5f  ry....    def __
-000019d0: 6361 6c6c 5f5f 2873 656c 662c 202a 6172  call__(self, *ar
-000019e0: 6773 2c20 2a2a 6b77 6172 6773 2920 2d3e  gs, **kwargs) ->
-000019f0: 206e 702e 6e64 6172 7261 793a 0d0a 2020   np.ndarray:..  
-00001a00: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00001a10: 662e 656e 636f 6465 282a 6172 6773 2c20  f.encode(*args, 
-00001a20: 2a2a 6b77 6172 6773 290d 0a0d 0a20 2020  **kwargs)....   
-00001a30: 2064 6566 205f 5f67 6574 6974 656d 5f5f   def __getitem__
-00001a40: 2873 656c 662c 2066 7261 6d65 733a 2069  (self, frames: i
-00001a50: 6e74 207c 2074 7570 6c65 207c 2073 6c69  nt | tuple | sli
-00001a60: 6365 2920 2d3e 206e 702e 6e64 6172 7261  ce) -> np.ndarra
-00001a70: 793a 0d0a 2020 2020 2020 2020 6966 2069  y:..        if i
-00001a80: 7369 6e73 7461 6e63 6528 6672 616d 6573  sinstance(frames
-00001a90: 2c20 736c 6963 6529 3a0d 0a20 2020 2020  , slice):..     
-00001aa0: 2020 2020 2020 2066 7261 6d65 7320 3d20         frames = 
-00001ab0: 6e70 2e61 7261 6e67 6528 7365 6c66 2e54  np.arange(self.T
-00001ac0: 295b 6672 616d 6573 5d0d 0a0d 0a20 2020  )[frames]....   
-00001ad0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00001ae0: 2e65 6e63 6f64 6528 6672 616d 6573 3d66  .encode(frames=f
-00001af0: 7261 6d65 7329 0d0a 0d0a 2020 2020 6465  rames)....    de
-00001b00: 6620 5f5f 6974 6572 5f5f 2873 656c 6629  f __iter__(self)
-00001b10: 3a0d 0a20 2020 2020 2020 2073 656c 662e  :..        self.
-00001b20: 5f74 203d 2030 0d0a 2020 2020 2020 2020  _t = 0..        
-00001b30: 7265 7475 726e 2073 656c 660d 0a0d 0a20  return self.... 
-00001b40: 2020 2064 6566 205f 5f6e 6578 745f 5f28     def __next__(
-00001b50: 7365 6c66 2920 2d3e 206e 702e 6e64 6172  self) -> np.ndar
-00001b60: 7261 793a 0d0a 2020 2020 2020 2020 6966  ray:..        if
-00001b70: 2073 656c 662e 5f74 203c 2073 656c 662e   self._t < self.
-00001b80: 543a 0d0a 2020 2020 2020 2020 2020 2020  T:..            
-00001b90: 4920 3d20 7365 6c66 2e65 6e63 6f64 6528  I = self.encode(
-00001ba0: 6672 616d 6573 3d73 656c 662e 5f74 290d  frames=self._t).
-00001bb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001bc0: 662e 5f74 202b 3d20 310d 0a20 2020 2020  f._t += 1..     
-00001bd0: 2020 2020 2020 2072 6574 7572 6e20 490d         return I.
-00001be0: 0a20 2020 2020 2020 2065 6c73 653a 0d0a  .        else:..
-00001bf0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00001c00: 7365 6c66 2e5f 740d 0a20 2020 2020 2020  self._t..       
-00001c10: 2020 2020 2072 6169 7365 2053 746f 7049       raise StopI
-00001c20: 7465 7261 7469 6f6e 2829 0d0a 0d0a 2020  teration()....  
-00001c30: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
-00001c40: 6c66 2920 2d3e 2069 6e74 3a0d 0a20 2020  lf) -> int:..   
-00001c50: 2020 2020 2022 2222 4e75 6d62 6572 206f       """Number o
-00001c60: 6620 6672 616d 6573 2e22 2222 0d0a 2020  f frames."""..  
-00001c70: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00001c80: 662e 540d 0a0d 0a20 2020 2064 6566 205f  f.T....    def _
-00001c90: 5f65 715f 5f28 7365 6c66 2c20 6f74 6865  _eq__(self, othe
-00001ca0: 7229 202d 3e20 626f 6f6c 3a0d 0a20 2020  r) -> bool:..   
-00001cb0: 2020 2020 2072 6574 7572 6e20 6861 7361       return hasa
-00001cc0: 7474 7228 6f74 6865 722c 2022 7061 7261  ttr(other, "para
-00001cd0: 6d73 2229 2061 6e64 2073 656c 662e 7061  ms") and self.pa
-00001ce0: 7261 6d73 203d 3d20 6f74 6865 722e 7061  rams == other.pa
-00001cf0: 7261 6d73 0d0a 0d0a 2020 2020 6465 6620  rams....    def 
-00001d00: 5f5f 636f 6e74 6169 6e73 5f5f 2873 656c  __contains__(sel
-00001d10: 662c 2069 7465 6d29 3a0d 0a20 2020 2020  f, item):..     
-00001d20: 2020 2072 6574 7572 6e20 6974 656d 2069     return item i
-00001d30: 6e20 7365 6c66 2e70 726f 7065 7274 6965  n self.propertie
-00001d40: 730d 0a0d 0a20 2020 2064 6566 205f 5f73  s....    def __s
-00001d50: 7472 5f5f 2873 656c 6629 202d 3e20 7374  tr__(self) -> st
-00001d60: 723a 0d0a 2020 2020 2020 2020 7265 7475  r:..        retu
-00001d70: 726e 2073 656c 662e 5f5f 6e61 6d65 5f5f  rn self.__name__
-00001d80: 0d0a 0d0a 2020 2020 6465 6620 5f5f 7265  ....    def __re
-00001d90: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
-00001da0: 723a 0d0a 2020 2020 2020 2020 7265 7475  r:..        retu
-00001db0: 726e 2066 227b 7365 6c66 2e70 6172 616d  rn f"{self.param
-00001dc0: 737d 220d 0a0d 0a20 2020 2064 6566 206c  s}"....    def l
-00001dd0: 6f61 6428 7365 6c66 2c20 666e 616d 653a  oad(self, fname:
-00001de0: 2073 7472 203d 204e 6f6e 6529 202d 3e20   str = None) -> 
-00001df0: 6469 6374 3a0d 0a20 2020 2020 2020 2022  dict:..        "
-00001e00: 2222 4c6f 6164 2070 6172 616d 6574 6572  ""Load parameter
-00001e10: 7320 6672 6f6d 2061 2063 6f6e 6669 6720  s from a config 
-00001e20: 6669 6c65 2074 6f20 7468 6520 6046 7269  file to the `Fri
-00001e30: 6e67 6573 6020 696e 7374 616e 6365 2e0d  nges` instance..
-00001e40: 0a0d 0a20 2020 2020 2020 202e 2e20 7761  ...        .. wa
-00001e50: 726e 696e 673a 3a20 5468 6520 7061 7261  rning:: The para
-00001e60: 6d65 7465 7273 2061 7265 206f 6e6c 7920  meters are only 
-00001e70: 6c6f 6164 6564 2069 6620 7468 6520 636f  loaded if the co
-00001e80: 6e66 6967 2066 696c 6520 7072 6f76 6964  nfig file provid
-00001e90: 6573 2074 6865 2073 6563 7469 6f6e 2060  es the section `
-00001ea0: 6672 696e 6765 7360 2e0d 0a0d 0a20 2020  fringes`.....   
-00001eb0: 2020 2020 2050 6172 616d 6574 6572 730d       Parameters.
-00001ec0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00001ed0: 2d2d 2d0d 0a20 2020 2020 2020 2066 6e61  ---..        fna
-00001ee0: 6d65 203a 2073 7472 2c20 6f70 7469 6f6e  me : str, option
-00001ef0: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-00001f00: 4669 6c65 206e 616d 6520 6f66 2074 6865  File name of the
-00001f10: 2066 696c 6520 746f 206c 6f61 642e 0d0a   file to load...
-00001f20: 2020 2020 2020 2020 2020 2020 5375 7070              Supp
-00001f30: 6f72 7465 6420 6669 6c65 2066 6f72 6d61  orted file forma
-00001f40: 7473 2061 7265 3a20 2a2e 6a73 6f6e 2c20  ts are: *.json, 
-00001f50: 2a2e 7961 6d6c 2c20 2a2e 746f 6d6c 2c20  *.yaml, *.toml, 
-00001f60: 2a2e 6173 6466 2e0d 0a20 2020 2020 2020  *.asdf...       
-00001f70: 2020 2020 2049 6620 6066 6e61 6d65 6020       If `fname` 
-00001f80: 6973 206e 6f74 2070 726f 7669 6465 642c  is not provided,
-00001f90: 2074 6865 2066 696c 6520 602e 6672 696e   the file `.frin
-00001fa0: 6765 732e 7961 6d6c 6020 7769 7468 696e  ges.yaml` within
-00001fb0: 2074 6865 2075 7365 7220 686f 6d65 2064   the user home d
-00001fc0: 6972 6563 746f 7279 2069 7320 6c6f 6164  irectory is load
-00001fd0: 6564 2e0d 0a0d 0a20 2020 2020 2020 2052  ed.....        R
-00001fe0: 6574 7572 6e73 0d0a 2020 2020 2020 2020  eturns..        
-00001ff0: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
-00002000: 2070 6172 616d 7320 3a20 6469 6374 0d0a   params : dict..
-00002010: 2020 2020 2020 2020 2020 2020 5468 6520              The 
-00002020: 6c6f 6164 6564 2070 6172 616d 6574 6572  loaded parameter
-00002030: 7320 6173 2061 2064 6963 7469 6f6e 6172  s as a dictionar
-00002040: 792e 0d0a 2020 2020 2020 2020 2020 2020  y...            
-00002050: 6070 6172 616d 7360 206d 6179 2062 6520  `params` may be 
-00002060: 656d 7074 792e 0d0a 0d0a 2020 2020 2020  empty.....      
-00002070: 2020 4578 616d 706c 6573 0d0a 2020 2020    Examples..    
-00002080: 2020 2020 2d2d 2d2d 2d2d 2d2d 0d0a 2020      --------..  
-00002090: 2020 2020 2020 3e3e 3e20 696d 706f 7274        >>> import
-000020a0: 206f 730d 0a20 2020 2020 2020 203e 3e3e   os..        >>>
-000020b0: 2066 6e61 6d65 203d 206f 732e 7061 7468   fname = os.path
-000020c0: 2e6a 6f69 6e28 6f73 2e70 6174 682e 6578  .join(os.path.ex
-000020d0: 7061 6e64 7573 6572 2822 7e22 292c 2022  panduser("~"), "
-000020e0: 2e66 7269 6e67 6573 2e79 616d 6c22 290d  .fringes.yaml").
-000020f0: 0a0d 0a20 2020 2020 2020 203e 3e3e 2069  ...        >>> i
-00002100: 6d70 6f72 7420 6672 696e 6765 7320 6173  mport fringes as
-00002110: 2066 726e 670d 0a20 2020 2020 2020 203e   frng..        >
-00002120: 3e3e 2066 203d 2066 726e 672e 4672 696e  >> f = frng.Frin
-00002130: 6765 7328 290d 0a0d 0a20 2020 2020 2020  ges()....       
-00002140: 203e 3e3e 2066 2e6c 6f61 6428 666e 616d   >>> f.load(fnam
-00002150: 6529 0d0a 2020 2020 2020 2020 2222 220d  e)..        """.
-00002160: 0a0d 0a20 2020 2020 2020 2069 6620 666e  ...        if fn
-00002170: 616d 6520 6973 204e 6f6e 653a 0d0a 2020  ame is None:..  
-00002180: 2020 2020 2020 2020 2020 666e 616d 6520            fname 
-00002190: 3d20 6f73 2e70 6174 682e 6a6f 696e 286f  = os.path.join(o
-000021a0: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
-000021b0: 7228 227e 2229 2c20 222e 6672 696e 6765  r("~"), ".fringe
-000021c0: 732e 7961 6d6c 2229 0d0a 0d0a 2020 2020  s.yaml")....    
-000021d0: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
-000021e0: 7468 2e69 7366 696c 6528 666e 616d 6529  th.isfile(fname)
-000021f0: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
-00002200: 656c 662e 6c6f 6767 6572 2e65 7272 6f72  elf.logger.error
-00002210: 2866 2246 696c 6520 277b 666e 616d 657d  (f"File '{fname}
-00002220: 2720 646f 6573 206e 6f74 2065 7869 7374  ' does not exist
-00002230: 2e22 290d 0a20 2020 2020 2020 2020 2020  .")..           
-00002240: 2072 6574 7572 6e0d 0a0d 0a20 2020 2020   return....     
-00002250: 2020 2065 7874 203d 206f 732e 7061 7468     ext = os.path
-00002260: 2e73 706c 6974 6578 7428 666e 616d 6529  .splitext(fname)
-00002270: 5b2d 315d 0d0a 2020 2020 2020 2020 6966  [-1]..        if
-00002280: 2065 7874 203d 3d20 222e 6173 6466 223a   ext == ".asdf":
-00002290: 0d0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
-000022a0: 7468 2061 7364 662e 6f70 656e 2866 6e61  th asdf.open(fna
-000022b0: 6d65 2920 6173 2066 3a0d 0a20 2020 2020  me) as f:..     
-000022c0: 2020 2020 2020 2020 2020 2070 203d 2066             p = f
-000022d0: 2e63 6f70 7928 290d 0a20 2020 2020 2020  .copy()..       
-000022e0: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-000022f0: 2020 2020 7769 7468 206f 7065 6e28 666e      with open(fn
-00002300: 616d 652c 2022 7222 2920 6173 2066 3a0d  ame, "r") as f:.
-00002310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002320: 2069 6620 6578 7420 3d3d 2022 2e6a 736f   if ext == ".jso
-00002330: 6e22 3a0d 0a20 2020 2020 2020 2020 2020  n":..           
-00002340: 2020 2020 2020 2020 2070 203d 206a 736f           p = jso
-00002350: 6e2e 6c6f 6164 2866 290d 0a20 2020 2020  n.load(f)..     
-00002360: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00002370: 6578 7420 3d3d 2022 2e79 616d 6c22 3a0d  ext == ".yaml":.
-00002380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002390: 2020 2020 2070 203d 2079 616d 6c2e 7361       p = yaml.sa
-000023a0: 6665 5f6c 6f61 6428 6629 0d0a 2020 2020  fe_load(f)..    
-000023b0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-000023c0: 2065 7874 203d 3d20 222e 746f 6d6c 223a   ext == ".toml":
-000023d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000023e0: 2020 2020 2020 7020 3d20 746f 6d6c 2e6c        p = toml.l
-000023f0: 6f61 6428 6629 0d0a 2020 2020 2020 2020  oad(f)..        
-00002400: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-00002410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002420: 2020 2073 656c 662e 6c6f 6767 6572 2e65     self.logger.e
-00002430: 7272 6f72 2866 2255 6e6b 6e6f 776e 2066  rror(f"Unknown f
-00002440: 696c 6520 7479 7065 2027 7b65 7874 7d27  ile type '{ext}'
-00002450: 2e22 290d 0a20 2020 2020 2020 2020 2020  .")..           
-00002460: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00002470: 7b7d 0d0a 0d0a 2020 2020 2020 2020 6966  {}....        if
-00002480: 2022 6672 696e 6765 7322 2069 6e20 703a   "fringes" in p:
-00002490: 0d0a 2020 2020 2020 2020 2020 2020 7061  ..            pa
-000024a0: 7261 6d73 203d 2070 5b22 6672 696e 6765  rams = p["fringe
-000024b0: 7322 5d0d 0a20 2020 2020 2020 2020 2020  s"]..           
-000024c0: 2073 656c 662e 7061 7261 6d73 203d 2070   self.params = p
-000024d0: 6172 616d 730d 0a0d 0a20 2020 2020 2020  arams....       
-000024e0: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-000024f0: 2e69 6e66 6f28 6622 4c6f 6164 6564 2070  .info(f"Loaded p
-00002500: 6172 616d 6574 6572 7320 6672 6f6d 2027  arameters from '
-00002510: 7b66 6e61 6d65 7d27 2e22 290d 0a0d 0a20  {fname}'.").... 
-00002520: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00002530: 6e20 7061 7261 6d73 0d0a 2020 2020 2020  n params..      
-00002540: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-00002550: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00002560: 2e65 7272 6f72 2866 224e 6f20 2766 7269  .error(f"No 'fri
-00002570: 6e67 6573 2720 7365 6374 696f 6e20 696e  nges' section in
-00002580: 2066 696c 6520 277b 666e 616d 657d 272e   file '{fname}'.
-00002590: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
-000025a0: 7265 7475 726e 207b 7d0d 0a0d 0a20 2020  return {}....   
-000025b0: 2064 6566 2073 6176 6528 7365 6c66 2c20   def save(self, 
-000025c0: 666e 616d 653a 2073 7472 203d 204e 6f6e  fname: str = Non
-000025d0: 6529 202d 3e20 4e6f 6e65 3a0d 0a20 2020  e) -> None:..   
-000025e0: 2020 2020 2022 2222 5361 7665 2074 6865       """Save the
-000025f0: 2070 6172 616d 6574 6572 7320 6f66 2074   parameters of t
-00002600: 6865 2060 4672 696e 6765 7360 2069 6e73  he `Fringes` ins
-00002610: 7461 6e63 6520 746f 2061 2063 6f6e 6669  tance to a confi
-00002620: 6720 6669 6c65 2e0d 0a0d 0a20 2020 2020  g file.....     
-00002630: 2020 2057 6974 6869 6e20 7468 6520 6669     Within the fi
-00002640: 6c65 2c20 7468 6520 7061 7261 6d65 7465  le, the paramete
-00002650: 7273 2061 7265 2077 7269 7474 656e 2074  rs are written t
-00002660: 6f20 7468 6520 7365 6374 696f 6e20 6066  o the section `f
-00002670: 7269 6e67 6573 600d 0a0d 0a20 2020 2020  ringes`....     
-00002680: 2020 2050 6172 616d 6574 6572 730d 0a20     Parameters.. 
-00002690: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-000026a0: 2d0d 0a20 2020 2020 2020 2066 6e61 6d65  -..        fname
-000026b0: 203a 2073 7472 2c20 6f70 7469 6f6e 616c   : str, optional
-000026c0: 0d0a 2020 2020 2020 2020 2020 2020 4669  ..            Fi
-000026d0: 6c65 206e 616d 6520 6f66 2074 6865 2066  le name of the f
-000026e0: 696c 6520 746f 2073 6176 652e 0d0a 2020  ile to save...  
-000026f0: 2020 2020 2020 2020 2020 5375 7070 6f72            Suppor
-00002700: 7465 6420 6669 6c65 2066 6f72 6d61 7473  ted file formats
-00002710: 2061 7265 3a20 2a2e 6a73 6f6e 2c20 2a2e   are: *.json, *.
-00002720: 7961 6d6c 2c20 2a2e 746f 6d6c 2c20 2a2e  yaml, *.toml, *.
-00002730: 6173 6466 2e0d 0a20 2020 2020 2020 2020  asdf...         
-00002740: 2020 2049 6620 6066 6e61 6d65 6020 6973     If `fname` is
-00002750: 206e 6f74 2070 726f 7669 6465 642c 2074   not provided, t
-00002760: 6865 2070 6172 616d 6574 6572 7320 6172  he parameters ar
-00002770: 6520 7361 7665 6420 746f 0d0a 2020 2020  e saved to..    
-00002780: 2020 2020 2020 2020 7468 6520 6669 6c65          the file
-00002790: 2060 2e66 7269 6e67 6573 2e79 616d 6c60   `.fringes.yaml`
-000027a0: 2077 6974 6869 6e20 7468 6520 7573 6572   within the user
-000027b0: 2068 6f6d 6520 6469 7265 6374 6f72 792e   home directory.
-000027c0: 0d0a 0d0a 2020 2020 2020 2020 4578 616d  ....        Exam
-000027d0: 706c 6573 0d0a 2020 2020 2020 2020 2d2d  ples..        --
-000027e0: 2d2d 2d2d 2d2d 0d0a 2020 2020 2020 2020  ------..        
-000027f0: 3e3e 3e20 696d 706f 7274 206f 730d 0a20  >>> import os.. 
-00002800: 2020 2020 2020 203e 3e3e 2066 6e61 6d65         >>> fname
-00002810: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-00002820: 6f73 2e70 6174 682e 6578 7061 6e64 7573  os.path.expandus
-00002830: 6572 2822 7e22 292c 2022 2e66 7269 6e67  er("~"), ".fring
-00002840: 6573 2e79 616d 6c22 290d 0a0d 0a20 2020  es.yaml")....   
-00002850: 2020 2020 203e 3e3e 2069 6d70 6f72 7420       >>> import 
-00002860: 6672 696e 6765 7320 6173 2066 726e 670d  fringes as frng.
-00002870: 0a20 2020 2020 2020 203e 3e3e 2066 203d  .        >>> f =
-00002880: 2066 726e 672e 4672 696e 6765 7328 290d   frng.Fringes().
-00002890: 0a0d 0a20 2020 2020 2020 203e 3e3e 2066  ...        >>> f
-000028a0: 2e73 6176 6528 666e 616d 6529 0d0a 2020  .save(fname)..  
-000028b0: 2020 2020 2020 2222 220d 0a0d 0a20 2020        """....   
-000028c0: 2020 2020 2069 6620 666e 616d 6520 6973       if fname is
-000028d0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-000028e0: 2020 2020 666e 616d 6520 3d20 6f73 2e70      fname = os.p
-000028f0: 6174 682e 6a6f 696e 286f 732e 7061 7468  ath.join(os.path
-00002900: 2e65 7870 616e 6475 7365 7228 227e 2229  .expanduser("~")
-00002910: 2c20 222e 6672 696e 6765 732e 7961 6d6c  , ".fringes.yaml
-00002920: 2229 0d0a 0d0a 2020 2020 2020 2020 6966  ")....        if
-00002930: 206e 6f74 206f 732e 7061 7468 2e69 7364   not os.path.isd
-00002940: 6972 286f 732e 7061 7468 2e64 6972 6e61  ir(os.path.dirna
-00002950: 6d65 2866 6e61 6d65 2929 3a0d 0a20 2020  me(fname)):..   
-00002960: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00002970: 6767 6572 2e77 6172 6e69 6e67 2866 2246  gger.warning(f"F
-00002980: 696c 6520 6469 7265 6374 6f72 7920 646f  ile directory do
-00002990: 6573 206e 6f74 2065 7869 7374 2e22 290d  es not exist.").
-000029a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000029b0: 7572 6e0d 0a20 2020 2020 2020 2065 6c69  urn..        eli
-000029c0: 6620 6f73 2e70 6174 682e 7370 6c69 7465  f os.path.splite
-000029d0: 7874 2866 6e61 6d65 295b 2d31 5d20 6e6f  xt(fname)[-1] no
-000029e0: 7420 696e 2073 656c 662e 5f6c 6f61 6465  t in self._loade
-000029f0: 722e 6b65 7973 2829 3a0d 0a20 2020 2020  r.keys():..     
-00002a00: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-00002a10: 6572 2e77 6172 6e69 6e67 2866 2246 696c  er.warning(f"Fil
-00002a20: 6520 6578 7465 6e73 696f 6e20 6973 2075  e extension is u
-00002a30: 6e6b 6e6f 776e 2e20 4d75 7374 2062 6520  nknown. Must be 
-00002a40: 6f6e 6520 6f66 207b 7365 6c66 2e5f 6c6f  one of {self._lo
-00002a50: 6164 6572 732e 6b65 7973 2829 7d22 290d  aders.keys()}").
-00002a60: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00002a70: 7572 6e0d 0a0d 0a20 2020 2020 2020 2065  urn....        e
-00002a80: 7874 203d 206f 732e 7061 7468 2e73 706c  xt = os.path.spl
-00002a90: 6974 6578 7428 666e 616d 6529 5b2d 315d  itext(fname)[-1]
-00002aa0: 0d0a 2020 2020 2020 2020 6966 2065 7874  ..        if ext
-00002ab0: 203d 3d20 222e 6173 6466 223a 0d0a 2020   == ".asdf":..  
-00002ac0: 2020 2020 2020 2020 2020 6173 6466 2e41            asdf.A
-00002ad0: 7364 6646 696c 6528 7b22 6672 696e 6765  sdfFile({"fringe
-00002ae0: 7322 3a20 7365 6c66 2e70 6172 616d 737d  s": self.params}
-00002af0: 292e 7772 6974 655f 746f 2866 6e61 6d65  ).write_to(fname
-00002b00: 290d 0a20 2020 2020 2020 2065 6c73 653a  )..        else:
-00002b10: 0d0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
-00002b20: 7468 206f 7065 6e28 666e 616d 652c 2022  th open(fname, "
-00002b30: 7722 2920 6173 2066 3a0d 0a20 2020 2020  w") as f:..     
-00002b40: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
-00002b50: 7420 3d3d 2022 2e6a 736f 6e22 3a0d 0a20  t == ".json":.. 
-00002b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b70: 2020 206a 736f 6e2e 6475 6d70 287b 2266     json.dump({"f
-00002b80: 7269 6e67 6573 223a 2073 656c 662e 7061  ringes": self.pa
-00002b90: 7261 6d73 7d2c 2066 2c20 696e 6465 6e74  rams}, f, indent
-00002ba0: 3d34 290d 0a20 2020 2020 2020 2020 2020  =4)..           
-00002bb0: 2020 2020 2065 6c69 6620 6578 7420 3d3d       elif ext ==
-00002bc0: 2022 2e79 616d 6c22 3a0d 0a20 2020 2020   ".yaml":..     
-00002bd0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00002be0: 616d 6c2e 6475 6d70 287b 2266 7269 6e67  aml.dump({"fring
-00002bf0: 6573 223a 2073 656c 662e 7061 7261 6d73  es": self.params
-00002c00: 7d2c 2066 290d 0a20 2020 2020 2020 2020  }, f)..         
-00002c10: 2020 2020 2020 2065 6c69 6620 6578 7420         elif ext 
-00002c20: 3d3d 2022 2e74 6f6d 6c22 3a0d 0a20 2020  == ".toml":..   
-00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c40: 2074 6f6d 6c2e 6475 6d70 287b 2266 7269   toml.dump({"fri
-00002c50: 6e67 6573 223a 2073 656c 662e 7061 7261  nges": self.para
-00002c60: 6d73 7d2c 2066 290d 0a0d 0a20 2020 2020  ms}, f)....     
-00002c70: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-00002c80: 6562 7567 2866 2253 6176 6564 2070 6172  ebug(f"Saved par
-00002c90: 616d 6574 6572 7320 746f 207b 666e 616d  ameters to {fnam
-00002ca0: 657d 2e22 2920 2023 2074 6f64 6f3a 2069  e}.")  # todo: i
-00002cb0: 6e66 6f3f 0d0a 0d0a 2020 2020 6465 6620  nfo?....    def 
-00002cc0: 7265 7365 7428 7365 6c66 2920 2d3e 204e  reset(self) -> N
-00002cd0: 6f6e 653a 0d0a 2020 2020 2020 2020 2222  one:..        ""
-00002ce0: 2252 6573 6574 2070 6172 616d 6574 6572  "Reset parameter
-00002cf0: 7320 6f66 2074 6865 2060 4672 696e 6765  s of the `Fringe
-00002d00: 7360 2069 6e73 7461 6e63 6520 746f 2064  s` instance to d
-00002d10: 6566 6175 6c74 2076 616c 7565 732e 2222  efault values.""
-00002d20: 220d 0a0d 0a20 2020 2020 2020 2073 656c  "....        sel
-00002d30: 662e 7061 7261 6d73 203d 2073 656c 662e  f.params = self.
-00002d40: 6465 6661 756c 7473 0d0a 2020 2020 2020  defaults..      
-00002d50: 2020 7365 6c66 2e6c 6f67 6765 722e 696e    self.logger.in
-00002d60: 666f 2822 5265 7365 7420 7061 7261 6d65  fo("Reset parame
-00002d70: 7465 7273 2074 6f20 6465 6661 756c 7473  ters to defaults
-00002d80: 2e22 290d 0a0d 0a20 2020 2064 6566 206f  .")....    def o
-00002d90: 7074 696d 697a 6528 7365 6c66 2c20 543a  ptimize(self, T:
-00002da0: 2069 6e74 203d 204e 6f6e 652c 2075 6d61   int = None, uma
-00002db0: 783a 2066 6c6f 6174 203d 204e 6f6e 6529  x: float = None)
-00002dc0: 202d 3e20 4e6f 6e65 3a20 2023 2074 6f64   -> None:  # tod
-00002dd0: 6f3a 2073 656c 662e 756d 6178 0d0a 2020  o: self.umax..  
-00002de0: 2020 2020 2020 2222 224f 7074 696d 697a        """Optimiz
-00002df0: 6520 7468 6520 7061 7261 6d65 7465 7273  e the parameters
-00002e00: 206f 6620 7468 6520 6046 7269 6e67 6573   of the `Fringes
-00002e10: 6020 696e 7374 616e 6365 2e0d 0a0d 0a20  ` instance..... 
-00002e20: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00002e30: 7273 0d0a 2020 2020 2020 2020 202d 2d2d  rs..         ---
-00002e40: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
-00002e50: 2020 5420 3a20 696e 742c 206f 7074 696f    T : int, optio
-00002e60: 6e61 6c0d 0a20 2020 2020 2020 2020 2020  nal..           
-00002e70: 204e 756d 6265 7220 6f66 2066 7261 6d65   Number of frame
-00002e80: 732e 0d0a 2020 2020 2020 2020 2020 2020  s...            
-00002e90: 4966 2060 5460 2069 7320 6e6f 7420 7072  If `T` is not pr
-00002ea0: 6f76 6964 6564 2c20 7468 6520 6e75 6d62  ovided, the numb
-00002eb0: 6572 206f 6620 6672 616d 6573 2066 726f  er of frames fro
-00002ec0: 6d20 7468 6520 6046 7269 6e67 6573 6020  m the `Fringes` 
-00002ed0: 696e 7374 616e 6365 2069 7320 7573 6564  instance is used
-00002ee0: 2e0d 0a20 2020 2020 2020 2020 2020 2054  ...            T
-00002ef0: 6865 6e2c 2074 6865 2060 4672 696e 6765  hen, the `Fringe
-00002f00: 7360 2069 6e73 7461 6e63 6527 7320 6e75  s` instance's nu
-00002f10: 6d62 6572 206f 6620 7368 6966 7473 2060  mber of shifts `
-00002f20: 4e60 2069 7320 6469 7374 7269 6275 7465  N` is distribute
-00002f30: 6420 6f70 7469 6d61 6c6c 7920 6f76 6572  d optimally over
-00002f40: 2074 6865 2064 6972 6563 7469 6f6e 7320   the directions 
-00002f50: 616e 6420 7365 7473 2e0d 0a0d 0a20 2020  and sets.....   
-00002f60: 2020 2020 2020 756d 6178 203a 2066 6c6f        umax : flo
-00002f70: 6174 2c20 6f70 7469 6f6e 616c 0d0a 2020  at, optional..  
-00002f80: 2020 2020 2020 2020 2020 4d61 7869 6d75            Maximu
-00002f90: 6d20 616c 6c6f 7761 626c 6520 756e 6365  m allowable unce
-00002fa0: 7274 6169 6e74 792e 0d0a 2020 2020 2020  rtainty...      
-00002fb0: 2020 2020 2020 4d75 7374 2062 6520 6772        Must be gr
-00002fc0: 6561 7465 7220 7468 616e 207a 6572 6f2e  eater than zero.
-00002fd0: 0d0a 0d0a 2020 2020 2020 2020 4e6f 7465  ....        Note
-00002fe0: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
-00002ff0: 0d0a 2020 2020 2020 2020 4966 2060 756d  ..        If `um
-00003000: 6178 6020 6973 2073 7065 6369 6669 6564  ax` is specified
-00003010: 2c20 7468 6520 7061 7261 6d65 7465 7273  , the parameters
-00003020: 2061 7265 2064 6574 6572 6d69 6e65 640d   are determined.
-00003030: 0a20 2020 2020 2020 2074 6861 7420 616c  .        that al
-00003040: 6c6f 7720 6120 6d61 7869 6d61 6c20 756e  low a maximal un
-00003050: 6365 7274 6169 6e74 7920 6f66 2060 756d  certainty of `um
-00003060: 6178 600d 0a20 2020 2020 2020 2077 6974  ax`..        wit
-00003070: 6820 6120 6d69 6e69 6d75 6d20 6e75 6d62  h a minimum numb
-00003080: 6572 206f 6620 6672 616d 6573 2e0d 0a0d  er of frames....
-00003090: 0a20 2020 2020 2020 2045 6c73 652c 2074  .        Else, t
-000030a0: 6865 2070 6172 616d 6574 6572 7320 6f66  he parameters of
-000030b0: 2074 6865 2060 4672 696e 6765 7360 2069   the `Fringes` i
-000030c0: 6e73 7461 6e63 6520 6172 6520 6f70 7469  nstance are opti
-000030d0: 6d69 7a65 6420 746f 2079 6965 6c64 2074  mized to yield t
-000030e0: 6865 206d 696e 696d 616c 2075 6e63 6572  he minimal uncer
-000030f0: 7461 696e 7479 0d0a 2020 2020 2020 2020  tainty..        
-00003100: 7573 696e 6720 7468 6520 6769 7665 6e20  using the given 
-00003110: 6e75 6d62 6572 206f 6620 6672 616d 6573  number of frames
-00003120: 2060 5460 2e0d 0a20 2020 2020 2020 2022   `T`...        "
-00003130: 2222 0d0a 0d0a 2020 2020 2020 2020 4b20  ""....        K 
-00003140: 3d20 6e70 2e6c 6f67 2873 656c 662e 4c29  = np.log(self.L)
-00003150: 202f 206e 702e 6c6f 6728 7365 6c66 2e6c   / np.log(self.l
-00003160: 6f70 7429 2020 2320 6c6f 7074 202a 2a20  opt)  # lopt ** 
-00003170: 4b20 3d20 4c0d 0a20 2020 2020 2020 204b  K = L..        K
-00003180: 203d 206e 702e 6365 696c 286d 6178 2832   = np.ceil(max(2
-00003190: 2c20 4b29 290d 0a20 2020 2020 2020 2073  , K))..        s
-000031a0: 656c 662e 4b20 3d20 4b0d 0a20 2020 2020  elf.K = K..     
-000031b0: 2020 2073 656c 662e 7620 3d20 226f 7074     self.v = "opt
-000031c0: 696d 616c 220d 0a0d 0a20 2020 2020 2020  imal"....       
-000031d0: 2069 6620 756d 6178 2069 7320 6e6f 7420   if umax is not 
-000031e0: 4e6f 6e65 3a20 2023 2075 6d61 7820 2d3e  None:  # umax ->
-000031f0: 2054 0d0a 2020 2020 2020 2020 2020 2020   T..            
-00003200: 7365 6c66 2e4e 203d 2069 6e74 286e 702e  self.N = int(np.
-00003210: 6d65 6469 616e 2873 656c 662e 4e29 2920  median(self.N)) 
-00003220: 2023 206d 616b 6520 4e20 636f 6e73 742e   # make N const.
-00003230: 0d0a 2020 2020 2020 2020 2020 2020 6120  ..            a 
-00003240: 3d20 7365 6c66 2e75 2e6d 6178 2829 202f  = self.u.max() /
-00003250: 2075 6d61 780d 0a20 2020 2020 2020 2020   umax..         
-00003260: 2020 204e 203d 2073 656c 662e 4e20 2a20     N = self.N * 
-00003270: 612a 2a32 0d0a 2020 2020 2020 2020 2020  a**2..          
-00003280: 2020 7365 6c66 2e4e 203d 206e 702e 6d61    self.N = np.ma
-00003290: 7869 6d75 6d28 332c 206e 702e 6365 696c  ximum(3, np.ceil
-000032a0: 284e 2929 0d0a 0d0a 2020 2020 2020 2020  (N))....        
-000032b0: 2020 2020 6966 2073 656c 662e 7520 3e20      if self.u > 
-000032c0: 756d 6178 3a0d 0a20 2020 2020 2020 2020  umax:..         
-000032d0: 2020 2020 2020 202e 2e2e 2020 2320 746f         ...  # to
-000032e0: 646f 3a20 6368 6563 6b20 6966 2075 6d61  do: check if uma
-000032f0: 7820 6973 2072 6561 6368 6564 0d0a 2020  x is reached..  
-00003300: 2020 2020 2020 656c 7365 3a20 2023 2054        else:  # T
-00003310: 202d 3e20 750d 0a20 2020 2020 2020 2020   -> u..         
-00003320: 2020 2069 6620 5420 6973 204e 6f6e 653a     if T is None:
-00003330: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00003340: 2020 5420 3d20 7365 6c66 2e54 0d0a 0d0a    T = self.T....
-00003350: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00003360: 2e54 203d 2054 2020 2320 6469 7374 7269  .T = T  # distri
-00003370: 6275 7465 2066 7261 6d65 7320 6f70 7469  bute frames opti
-00003380: 6d61 6c6c 7920 2865 7665 6e6c 7929 206f  mally (evenly) o
-00003390: 6e20 7368 6966 7473 0d0a 0d0a 2020 2020  n shifts....    
-000033a0: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-000033b0: 696e 666f 2822 4f70 7469 6d69 7a65 6420  info("Optimized 
-000033c0: 7061 7261 6d65 7465 7273 2e22 290d 0a0d  parameters.")...
-000033d0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-000033e0: 6f64 0d0a 2020 2020 6465 6620 6761 6d6d  od..    def gamm
-000033f0: 615f 6175 746f 5f63 6f72 7265 6374 2849  a_auto_correct(I
-00003400: 3a20 6e70 2e6e 6461 7272 6179 2920 2d3e  : np.ndarray) ->
-00003410: 206e 702e 6e64 6172 7261 793a 0d0a 2020   np.ndarray:..  
-00003420: 2020 2020 2020 2222 2241 7574 6f6d 6174        """Automat
-00003430: 6963 616c 6c79 2065 7374 696d 6174 6520  ically estimate 
-00003440: 616e 6420 6170 706c 7920 7468 6520 6761  and apply the ga
-00003450: 6d6d 6120 636f 7272 6563 7469 6f6e 2066  mma correction f
-00003460: 6163 746f 720d 0a20 2020 2020 2020 2074  actor..        t
-00003470: 6f20 6c69 6e65 6172 697a 6520 7468 6520  o linearize the 
-00003480: 6469 7370 6c61 792f 6361 6d65 7261 2072  display/camera r
-00003490: 6573 706f 6e73 6520 6375 7276 652e 0d0a  esponse curve...
-000034a0: 0d0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-000034b0: 7465 7273 0d0a 2020 2020 2020 2020 2d2d  ters..        --
-000034c0: 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020 2020  --------..      
-000034d0: 2020 4920 3a20 6e70 2e6e 6461 7272 6179    I : np.ndarray
-000034e0: 0d0a 2020 2020 2020 2020 2020 2020 5265  ..            Re
-000034f0: 636f 7264 6564 2064 6174 612e 0d0a 0d0a  corded data.....
-00003500: 2020 2020 2020 2020 5265 7475 726e 730d          Returns.
-00003510: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00003520: 0d0a 2020 2020 2020 2020 4a20 3a20 6e70  ..        J : np
-00003530: 2e6e 6461 7272 6179 0d0a 2020 2020 2020  .ndarray..      
-00003540: 2020 2020 2020 4c69 6e65 6172 697a 6564        Linearized
-00003550: 2064 6174 612e 0d0a 2020 2020 2020 2020   data...        
-00003560: 2222 220d 0a0d 0a20 2020 2020 2020 2023  """....        #
-00003570: 206e 6f72 6d61 6c69 7a65 2074 6f20 5b30   normalize to [0
-00003580: 2c20 315d 0d0a 2020 2020 2020 2020 496d  , 1]..        Im
-00003590: 6178 203d 206e 702e 6969 6e66 6f28 492e  ax = np.iinfo(I.
-000035a0: 6474 7970 6529 2e6d 6178 2069 6620 492e  dtype).max if I.
-000035b0: 6474 7970 652e 6b69 6e64 2069 6e20 2275  dtype.kind in "u
-000035c0: 6922 2065 6c73 6520 310d 0a20 2020 2020  i" else 1..     
-000035d0: 2020 204a 203d 2049 202f 2049 6d61 780d     J = I / Imax.
-000035e0: 0a0d 0a20 2020 2020 2020 2023 2065 7374  ...        # est
-000035f0: 696d 6174 6520 6761 6d6d 6120 636f 7272  imate gamma corr
-00003600: 6563 7469 6f6e 2066 6163 746f 720d 0a20  ection factor.. 
-00003610: 2020 2020 2020 206d 6564 203d 206e 702e         med = np.
-00003620: 6e61 6e6d 6564 6961 6e28 4a29 2020 2320  nanmedian(J)  # 
-00003630: 4d65 6469 616e 2069 7320 6120 726f 6275  Median is a robu
-00003640: 7374 2065 7374 696d 6174 6f72 2066 6f72  st estimator for
-00003650: 2074 6865 206d 6561 6e2e 0d0a 2020 2020   the mean...    
-00003660: 2020 2020 6761 6d6d 6120 3d20 6e70 2e6c      gamma = np.l
-00003670: 6f67 286d 6564 2920 2f20 6e70 2e6c 6f67  og(med) / np.log
-00003680: 2830 2e35 290d 0a20 2020 2020 2020 2069  (0.5)..        i
-00003690: 6e76 5f67 616d 6d61 203d 2031 202f 2067  nv_gamma = 1 / g
-000036a0: 616d 6d61 0d0a 0d0a 2020 2020 2020 2020  amma....        
-000036b0: 2320 6170 706c 7920 696e 7665 7273 6520  # apply inverse 
-000036c0: 6761 6d6d 610d 0a20 2020 2020 2020 2023  gamma..        #
-000036d0: 2074 6162 6c65 203d 206e 702e 6172 7261   table = np.arra
-000036e0: 7928 5b28 2867 202f 2073 656c 662e 496d  y([((g / self.Im
-000036f0: 6178 2920 2a2a 2069 6e76 4761 6d6d 6129  ax) ** invGamma)
-00003700: 202a 2073 656c 662e 496d 6178 2066 6f72   * self.Imax for
-00003710: 2067 2069 6e20 7261 6e67 6528 7365 6c66   g in range(self
-00003720: 2e49 6d61 7820 2b20 3129 5d2c 2073 656c  .Imax + 1)], sel
-00003730: 662e 6474 7970 6529 0d0a 2020 2020 2020  f.dtype)..      
-00003740: 2020 2320 4a20 3d20 6376 322e 4c55 5428    # J = cv2.LUT(
-00003750: 4a2c 2074 6162 6c65 290d 0a20 2020 2020  J, table)..     
-00003760: 2020 204a 202a 2a3d 2069 6e76 5f67 616d     J **= inv_gam
-00003770: 6d61 0d0a 2020 2020 2020 2020 4a20 2a3d  ma..        J *=
-00003780: 2049 6d61 780d 0a0d 0a20 2020 2020 2020   Imax....       
-00003790: 2072 6574 7572 6e20 4a0d 0a0d 0a20 2020   return J....   
-000037a0: 2064 6566 2064 6569 6e74 6572 6c61 6365   def deinterlace
-000037b0: 2873 656c 662c 2049 3a20 6e70 2e6e 6461  (self, I: np.nda
-000037c0: 7272 6179 2920 2d3e 206e 702e 6e64 6172  rray) -> np.ndar
-000037d0: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
-000037e0: 2244 6569 6e74 6572 6c61 6365 2066 7269  "Deinterlace fri
-000037f0: 6e67 6520 7061 7474 6572 6e73 2e0d 0a0d  nge patterns....
-00003800: 0a20 2020 2020 2020 2054 6869 7320 666f  .        This fo
-00003810: 7220 6672 696e 6765 2070 6174 7465 726e  r fringe pattern
-00003820: 730d 0a20 2020 2020 2020 2077 6869 6368  s..        which
-00003830: 2077 6572 6520 6163 7175 6972 6564 2077   were acquired w
-00003840: 6974 6820 6120 6c69 6e65 2073 6361 6e20  ith a line scan 
-00003850: 6361 6d65 7261 0d0a 2020 2020 2020 2020  camera..        
-00003860: 7768 696c 6520 6561 6368 2066 7261 6d65  while each frame
-00003870: 2068 6173 2062 6565 6e20 6469 7370 6c61   has been displa
-00003880: 7965 6420 616e 6420 6361 7074 7572 6564  yed and captured
-00003890: 0d0a 2020 2020 2020 2020 7768 696c 6520  ..        while 
-000038a0: 7468 6520 6f62 6a65 6374 2077 6173 206d  the object was m
-000038b0: 6f76 696e 6720 6279 206f 6e65 2070 6978  oving by one pix
-000038c0: 656c 2e0d 0a0d 0a20 2020 2020 2020 2050  el.....        P
-000038d0: 6172 616d 6574 6572 730d 0a20 2020 2020  arameters..     
-000038e0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0d 0a20     ----------.. 
-000038f0: 2020 2020 2020 2049 203a 206e 702e 6e64         I : np.nd
-00003900: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
-00003910: 2020 2046 7269 6e67 6520 7061 7474 6572     Fringe patter
-00003920: 6e20 7365 7175 656e 6365 2e0d 0a20 2020  n sequence...   
-00003930: 2020 2020 2020 2020 2049 7420 6973 2072           It is r
-00003940: 6573 6861 7065 6420 746f 2076 6964 656f  eshaped to video
-00003950: 7368 6170 6520 2866 7261 6d65 7320 6054  shape (frames `T
-00003960: 602c 2068 6569 6768 7420 6059 602c 2077  `, height `Y`, w
-00003970: 6964 7468 2060 5860 2c20 636f 6c6f 7220  idth `X`, color 
-00003980: 6368 616e 6e65 6c73 2060 4360 2920 6265  channels `C`) be
-00003990: 666f 7265 2070 726f 6365 7373 696e 672e  fore processing.
-000039a0: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
-000039b0: 726e 730d 0a20 2020 2020 2020 202d 2d2d  rns..        ---
-000039c0: 2d2d 2d2d 0d0a 2020 2020 2020 2020 4920  ----..        I 
-000039d0: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
-000039e0: 2020 2020 2020 2020 2020 4465 696e 7465            Deinte
-000039f0: 726c 6163 6564 2066 7269 6e67 6520 7061  rlaced fringe pa
-00003a00: 7474 6572 6e20 7365 7175 656e 6365 2e0d  ttern sequence..
-00003a10: 0a0d 0a20 2020 2020 2020 2052 6169 7365  ...        Raise
-00003a20: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
-00003a30: 2d0d 0a20 2020 2020 2020 2041 7373 6572  -..        Asser
-00003a40: 7469 6f6e 4572 726f 720d 0a20 2020 2020  tionError..     
-00003a50: 2020 2020 2020 2049 6620 7468 6520 6e75         If the nu
-00003a60: 6d62 6572 206f 6620 6672 616d 6573 206f  mber of frames o
-00003a70: 6620 6049 6020 616e 6420 7468 6520 6174  f `I` and the at
-00003a80: 7472 6962 7574 6520 6054 6020 6f66 2074  tribute `T` of t
-00003a90: 6865 2060 4672 696e 6765 7360 2069 6e73  he `Fringes` ins
-00003aa0: 7461 6e63 6520 646f 6e27 7420 6d61 7463  tance don't matc
-00003ab0: 682e 0d0a 0d0a 2020 2020 2020 2020 4578  h.....        Ex
-00003ac0: 616d 706c 6573 0d0a 2020 2020 2020 2020  amples..        
-00003ad0: 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020 2020  --------..      
-00003ae0: 2020 3e3e 3e20 696d 706f 7274 2066 7269    >>> import fri
-00003af0: 6e67 6573 2061 7320 6672 6e67 0d0a 2020  nges as frng..  
-00003b00: 2020 2020 2020 3e3e 3e20 6620 3d20 6672        >>> f = fr
-00003b10: 6e67 2e46 7269 6e67 6573 2829 0d0a 2020  ng.Fringes()..  
-00003b20: 2020 2020 2020 3e3e 3e20 4920 3d20 662e        >>> I = f.
-00003b30: 6465 696e 7465 726c 6163 6528 4929 0d0a  deinterlace(I)..
-00003b40: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
-00003b50: 2020 2020 2020 2074 3020 3d20 7469 6d65         t0 = time
-00003b60: 2e70 6572 665f 636f 756e 7465 7228 290d  .perf_counter().
-00003b70: 0a0d 0a20 2020 2020 2020 2054 2c20 592c  ...        T, Y,
-00003b80: 2058 2c20 4320 3d20 7673 6861 7065 2849   X, C = vshape(I
-00003b90: 292e 7368 6170 650d 0a20 2020 2020 2020  ).shape..       
-00003ba0: 2061 7373 6572 7420 5420 2a20 5920 2520   assert T * Y % 
-00003bb0: 7365 6c66 2e54 203d 3d20 302c 2022 4e75  self.T == 0, "Nu
-00003bc0: 6d62 6572 206f 6620 6672 616d 6573 206f  mber of frames o
-00003bd0: 6620 7061 7261 6d65 7465 7273 2061 6e64  f parameters and
-00003be0: 2064 6174 6120 646f 6e27 7420 6d61 7463   data don't matc
-00003bf0: 682e 220d 0a0d 0a20 2020 2020 2020 2023  h."....        #
-00003c00: 2049 203d 2049 2e72 6573 6861 7065 2828   I = I.reshape((
-00003c10: 5420 2a20 592c 2058 2c20 4329 2920 2023  T * Y, X, C))  #
-00003c20: 2063 6f6e 6361 7465 6e61 7465 0d0a 2020   concatenate..  
-00003c30: 2020 2020 2020 4920 3d20 492e 7265 7368        I = I.resh
-00003c40: 6170 6528 282d 312c 2073 656c 662e 542c  ape((-1, self.T,
-00003c50: 2058 2c20 4329 292e 7377 6170 6178 6573   X, C)).swapaxes
-00003c60: 2830 2c20 3129 0d0a 0d0a 2020 2020 2020  (0, 1)....      
-00003c70: 2020 7365 6c66 2e6c 6f67 6765 722e 696e    self.logger.in
-00003c80: 666f 2866 227b 7369 2874 696d 652e 7065  fo(f"{si(time.pe
-00003c90: 7266 5f63 6f75 6e74 6572 2829 202d 2074  rf_counter() - t
-00003ca0: 3029 7d73 2229 0d0a 0d0a 2020 2020 2020  0)}s")....      
-00003cb0: 2020 7265 7475 726e 2049 0d0a 0d0a 2020    return I....  
-00003cc0: 2020 6465 6620 636f 6f72 6469 6e61 7465    def coordinate
-00003cd0: 7328 7365 6c66 2920 2d3e 206e 702e 6e64  s(self) -> np.nd
-00003ce0: 6172 7261 793a 0d0a 2020 2020 2020 2020  array:..        
-00003cf0: 2222 2247 656e 6572 6174 6520 7468 6520  """Generate the 
-00003d00: 636f 6f72 6469 6e61 7465 206d 6174 7269  coordinate matri
-00003d10: 6365 7320 6f66 2074 6865 2063 6f6f 7264  ces of the coord
-00003d20: 696e 6174 6520 7379 7374 656d 2064 6566  inate system def
-00003d30: 696e 6564 2069 6e20 6067 7269 6460 2e0d  ined in `grid`..
-00003d40: 0a0d 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-00003d50: 6e73 0d0a 2020 2020 2020 2020 2d2d 2d2d  ns..        ----
-00003d60: 2d2d 2d0d 0a20 2020 2020 2020 2078 6920  ---..        xi 
-00003d70: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
-00003d80: 2020 2020 2020 2020 2020 436f 6f72 6469            Coordi
-00003d90: 6e61 7465 206d 6174 7269 6365 732e 0d0a  nate matrices...
-00003da0: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
-00003db0: 2020 2020 2020 2074 3020 3d20 7469 6d65         t0 = time
-00003dc0: 2e70 6572 665f 636f 756e 7465 7228 290d  .perf_counter().
-00003dd0: 0a0d 0a20 2020 2020 2020 2073 7973 203d  ...        sys =
-00003de0: 2028 0d0a 2020 2020 2020 2020 2020 2020   (..            
-00003df0: 2269 6d67 220d 0a20 2020 2020 2020 2020  "img"..         
-00003e00: 2020 2069 6620 7365 6c66 2e67 7269 6420     if self.grid 
-00003e10: 3d3d 2022 696d 6167 6522 0d0a 2020 2020  == "image"..    
-00003e20: 2020 2020 2020 2020 656c 7365 2022 6361          else "ca
-00003e30: 7274 220d 0a20 2020 2020 2020 2020 2020  rt"..           
-00003e40: 2069 6620 7365 6c66 2e67 7269 6420 3d3d   if self.grid ==
-00003e50: 2022 4361 7274 6573 6961 6e22 0d0a 2020   "Cartesian"..  
-00003e60: 2020 2020 2020 2020 2020 656c 7365 2022            else "
-00003e70: 706f 6c22 0d0a 2020 2020 2020 2020 2020  pol"..          
-00003e80: 2020 6966 2073 656c 662e 6772 6964 203d    if self.grid =
-00003e90: 3d20 2270 6f6c 6172 220d 0a20 2020 2020  = "polar"..     
-00003ea0: 2020 2020 2020 2065 6c73 6520 226c 6f67         else "log
-00003eb0: 706f 6c22 0d0a 2020 2020 2020 2020 290d  pol"..        ).
-00003ec0: 0a0d 0a20 2020 2020 2020 2078 6920 3d20  ...        xi = 
-00003ed0: 6e70 2e61 7272 6179 2867 6574 6174 7472  np.array(getattr
-00003ee0: 2867 7269 642c 2073 7973 2928 7365 6c66  (grid, sys)(self
-00003ef0: 2e59 2c20 7365 6c66 2e58 2c20 7365 6c66  .Y, self.X, self
-00003f00: 2e61 6e67 6c65 2929 0d0a 0d0a 2020 2020  .angle))....    
-00003f10: 2020 2020 6966 2073 656c 662e 696e 6465      if self.inde
-00003f20: 7869 6e67 203d 3d20 2269 6a22 3a0d 0a20  xing == "ij":.. 
-00003f30: 2020 2020 2020 2020 2020 2078 6920 3d20             xi = 
-00003f40: 7869 5b3a 3a2d 315d 2020 2320 7265 7475  xi[::-1]  # retu
-00003f50: 726e 7320 6120 7669 6577 0d0a 0d0a 2020  rns a view....  
-00003f60: 2020 2020 2020 6966 2073 656c 662e 4420        if self.D 
-00003f70: 3d3d 2031 3a0d 0a20 2020 2020 2020 2020  == 1:..         
-00003f80: 2020 2078 6920 3d20 7869 5b73 656c 662e     xi = xi[self.
-00003f90: 6178 6973 5d20 2023 2072 6574 7572 6e73  axis]  # returns
-00003fa0: 2061 2076 6965 770d 0a0d 0a20 2020 2020   a view....     
-00003fb0: 2020 2069 6620 7365 6c66 2e67 7269 6420     if self.grid 
-00003fc0: 696e 205b 2270 6f6c 6172 222c 2022 6c6f  in ["polar", "lo
-00003fd0: 672d 706f 6c61 7222 5d3a 0d0a 2020 2020  g-polar"]:..    
-00003fe0: 2020 2020 2020 2020 7869 202a 3d20 7365          xi *= se
-00003ff0: 6c66 2e4c 0d0a 0d0a 2020 2020 2020 2020  lf.L....        
-00004000: 7365 6c66 2e6c 6f67 6765 722e 696e 666f  self.logger.info
-00004010: 2866 227b 7369 2874 696d 652e 7065 7266  (f"{si(time.perf
-00004020: 5f63 6f75 6e74 6572 2829 202d 2074 3029  _counter() - t0)
-00004030: 7d73 2229 0d0a 0d0a 2020 2020 2020 2020  }s")....        
-00004040: 7265 7475 726e 2078 692e 7265 7368 6170  return xi.reshap
-00004050: 6528 2873 656c 662e 442c 2073 656c 662e  e((self.D, self.
-00004060: 592c 2073 656c 662e 582c 2031 2929 0d0a  Y, self.X, 1))..
-00004070: 0d0a 2020 2020 6465 6620 5f6f 7264 6572  ..    def _order
-00004080: 7328 7365 6c66 2920 2d3e 206e 702e 6e64  s(self) -> np.nd
-00004090: 6172 7261 793a 0d0a 2020 2020 2020 2020  array:..        
-000040a0: 2222 2247 656e 6572 6174 6520 6672 696e  """Generate frin
-000040b0: 6765 206f 7264 6572 732e 0d0a 0d0a 2020  ge orders.....  
-000040c0: 2020 2020 2020 5265 7475 726e 730d 0a20        Returns.. 
-000040d0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0d0a         -------..
-000040e0: 2020 2020 2020 2020 6b20 3a20 6e70 2e6e          k : np.n
-000040f0: 6461 7272 6179 0d0a 2020 2020 2020 2020  darray..        
-00004100: 2020 2020 4672 696e 6765 206f 7264 6572      Fringe order
-00004110: 7320 6f66 2074 6865 2065 6e63 6f64 6564  s of the encoded
-00004120: 2066 7269 6e67 6520 7061 7474 6572 6e20   fringe pattern 
-00004130: 7365 7175 656e 6365 2e0d 0a20 2020 2020  sequence...     
-00004140: 2020 2022 2222 0d0a 0d0a 2020 2020 2020     """....      
-00004150: 2020 6b20 3d20 7365 6c66 2e63 6f6f 7264    k = self.coord
-00004160: 696e 6174 6573 2829 5b3a 2c20 4e6f 6e65  inates()[:, None
-00004170: 2c20 3a2c 203a 2c20 3a5d 202f 2f20 7365  , :, :, :] // se
-00004180: 6c66 2e5f 6c5b 3a2c 203a 2c20 4e6f 6e65  lf._l[:, :, None
-00004190: 2c20 4e6f 6e65 2c20 4e6f 6e65 5d0d 0a0d  , None, None]...
-000041a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000041b0: 6b2e 7265 7368 6170 6528 7365 6c66 2e44  k.reshape(self.D
-000041c0: 202a 2073 656c 662e 4b2c 2073 656c 662e   * self.K, self.
-000041d0: 592c 2073 656c 662e 582c 2073 656c 662e  Y, self.X, self.
-000041e0: 4329 0d0a 0d0a 2020 2020 6465 6620 5f6d  C)....    def _m
-000041f0: 6f64 756c 6174 6528 7365 6c66 2c20 6672  odulate(self, fr
-00004200: 616d 6573 3a20 696e 7420 7c20 7475 706c  ames: int | tupl
-00004210: 6520 3d20 4e6f 6e65 2c20 7269 6e74 3a20  e = None, rint: 
-00004220: 626f 6f6c 203d 2054 7275 6529 202d 3e20  bool = True) -> 
-00004230: 6e70 2e6e 6461 7272 6179 3a0d 0a20 2020  np.ndarray:..   
-00004240: 2020 2020 2022 2222 456e 636f 6465 2062       """Encode b
-00004250: 6173 6520 6672 696e 6765 2070 6174 7465  ase fringe patte
-00004260: 726e 7320 6279 2073 7061 7469 6f2d 7465  rns by spatio-te
-00004270: 6d70 6f72 616c 206d 6f64 756c 6174 696f  mporal modulatio
-00004280: 6e2e 0d0a 0d0a 2020 2020 2020 2020 5061  n.....        Pa
-00004290: 7261 6d65 7465 7273 0d0a 2020 2020 2020  rameters..      
-000042a0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020    ----------..  
-000042b0: 2020 2020 2020 6672 616d 6573 203a 204e        frames : N
-000042c0: 6f6e 6520 6f72 2069 6e74 206f 7220 7475  one or int or tu
-000042d0: 706c 6520 6f66 2069 6e74 732c 206f 7074  ple of ints, opt
-000042e0: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
-000042f0: 2020 2049 6e64 6963 6573 206f 6620 7468     Indices of th
-00004300: 6520 6672 616d 6520 6f72 2066 7261 6d65  e frame or frame
-00004310: 7320 746f 2062 6520 656e 636f 6465 642e  s to be encoded.
-00004320: 0d0a 2020 2020 2020 2020 2020 2020 5468  ..            Th
-00004330: 6520 6465 6661 756c 742c 2066 7261 6d65  e default, frame
-00004340: 733d 4e6f 6e65 2c20 7769 6c6c 2065 6e63  s=None, will enc
-00004350: 6f64 6520 616c 6c20 6672 616d 6573 2061  ode all frames a
-00004360: 7420 6f6e 6365 2e0d 0a20 2020 2020 2020  t once...       
-00004370: 2020 2020 2049 6620 6672 616d 6573 2069       If frames i
-00004380: 7320 6e65 6761 7469 7665 2c20 6974 2063  s negative, it c
-00004390: 6f75 6e74 7320 6672 6f6d 2074 6865 206c  ounts from the l
-000043a0: 6173 7420 746f 2074 6865 2066 6972 7374  ast to the first
-000043b0: 2066 7261 6d65 2e0d 0a20 2020 2020 2020   frame...       
-000043c0: 2020 2020 2049 6620 6672 616d 6573 2063       If frames c
-000043d0: 6f6e 7461 696e 7320 6e75 6d62 6572 7320  ontains numbers 
-000043e0: 7768 6f73 6520 6d61 676e 6974 7564 6520  whose magnitude 
-000043f0: 6973 206c 6172 6765 7220 7468 616e 2074  is larger than t
-00004400: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-00004410: 6f66 2066 7261 6d65 730d 0a20 2020 2020  of frames..     
-00004420: 2020 2020 2020 2028 6173 2073 7065 6369         (as speci
-00004430: 6669 6564 2062 7920 7468 6520 6174 7472  fied by the attr
-00004440: 6962 7574 6520 6054 6020 6f66 2074 6865  ibute `T` of the
-00004450: 2046 7269 6e67 6573 2069 6e73 7461 6e63   Fringes instanc
-00004460: 6529 2c20 6974 2069 7320 7772 6170 7065  e), it is wrappe
-00004470: 6420 6172 6f75 6e64 2e0d 0a20 2020 2020  d around...     
-00004480: 2020 2020 2020 2049 6620 6672 616d 6573         If frames
-00004490: 2069 7320 6120 7475 706c 6520 6f66 2069   is a tuple of i
-000044a0: 6e74 732c 206f 6e6c 7920 7468 6520 6672  nts, only the fr
-000044b0: 616d 6573 2073 7065 6369 6669 6564 2069  ames specified i
-000044c0: 6e20 7468 6520 7475 706c 6520 6172 6520  n the tuple are 
-000044d0: 656e 636f 6465 642e 0d0a 2020 2020 2020  encoded...      
-000044e0: 2020 7269 6e74 203a 2062 6f6f 6c2c 206f    rint : bool, o
-000044f0: 7074 696f 6e61 6c0d 0a20 2020 2020 2020  ptional..       
-00004500: 2020 2020 2049 6620 7468 6973 2069 7320       If this is 
-00004510: 7365 7420 746f 2054 7275 6520 2874 6865  set to True (the
-00004520: 2064 6566 6175 6c74 290d 0a20 2020 2020   default)..     
-00004530: 2020 2020 2020 2061 6e64 2074 6865 2075         and the u
-00004540: 7365 6420 6474 7970 6520 2861 7474 7269  sed dtype (attri
-00004550: 6275 7465 2060 6474 7970 6560 206f 6620  bute `dtype` of 
-00004560: 7468 6520 4672 696e 6765 7320 696e 7374  the Fringes inst
-00004570: 616e 6365 2920 6973 206f 6620 7479 7065  ance) is of type
-00004580: 2069 6e74 6572 6765 722c 0d0a 2020 2020   interger,..    
-00004590: 2020 2020 2020 2020 7468 6520 656e 636f          the enco
-000045a0: 6465 6420 7061 7474 6572 6e73 2077 696c  ded patterns wil
-000045b0: 6c20 6265 2072 6f75 6e64 6564 2074 6f20  l be rounded to 
-000045c0: 7468 6520 6e65 6172 6573 7420 696e 7465  the nearest inte
-000045d0: 6765 722e 0d0a 2020 2020 2020 2020 2020  ger...          
-000045e0: 2020 4966 2074 6869 7320 6973 2073 6574    If this is set
-000045f0: 2046 616c 7365 2061 6e64 2074 6865 2075   False and the u
-00004600: 7365 6420 6474 7970 6520 6973 206f 6620  sed dtype is of 
-00004610: 7479 7065 2069 6e74 6572 6765 722c 0d0a  type interger,..
-00004620: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-00004630: 6672 6163 7469 6f6e 616c 2070 6172 7420  fractional part 
-00004640: 6f66 2074 6865 2065 6e63 6f64 6564 2070  of the encoded p
-00004650: 6174 7465 726e 7320 7769 6c6c 2062 6520  atterns will be 
-00004660: 6469 7363 6172 6465 642e 0d0a 0d0a 2020  discarded.....  
-00004670: 2020 2020 2020 5265 7475 726e 730d 0a20        Returns.. 
-00004680: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0d0a         -------..
-00004690: 2020 2020 2020 2020 4920 3a20 6e70 2e6e          I : np.n
-000046a0: 6461 7272 6179 0d0a 2020 2020 2020 2020  darray..        
-000046b0: 2020 2020 4261 7365 2066 7269 6e67 6520      Base fringe 
-000046c0: 7061 7474 6572 6e73 2e0d 0a20 2020 2020  patterns...     
-000046d0: 2020 2022 2222 0d0a 0d0a 2020 2020 2020     """....      
-000046e0: 2020 7430 203d 2074 696d 652e 7065 7266    t0 = time.perf
-000046f0: 5f63 6f75 6e74 6572 2829 0d0a 0d0a 2020  _counter()....  
-00004700: 2020 2020 2020 6966 2066 7261 6d65 7320        if frames 
-00004710: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
-00004720: 2020 2020 2020 6672 616d 6573 203d 206e        frames = n
-00004730: 702e 6172 616e 6765 286e 702e 7375 6d28  p.arange(np.sum(
-00004740: 7365 6c66 2e5f 4e29 290d 0a0d 0a20 2020  self._N))....   
-00004750: 2020 2020 2074 7279 3a20 2023 2065 6e73       try:  # ens
-00004760: 7572 6520 6672 616d 6573 2069 7320 6974  ure frames is it
-00004770: 6572 6162 6c65 0d0a 2020 2020 2020 2020  erable..        
-00004780: 2020 2020 5420 3d20 6c65 6e28 6672 616d      T = len(fram
-00004790: 6573 290d 0a20 2020 2020 2020 2065 7863  es)..        exc
-000047a0: 6570 7420 5479 7065 4572 726f 723a 0d0a  ept TypeError:..
-000047b0: 2020 2020 2020 2020 2020 2020 5420 3d20              T = 
-000047c0: 310d 0a20 2020 2020 2020 2020 2020 2066  1..            f
-000047d0: 7261 6d65 7320 3d20 5b66 7261 6d65 735d  rames = [frames]
-000047e0: 0d0a 2020 2020 2020 2020 6672 616d 6573  ..        frames
-000047f0: 203d 206e 702e 6172 7261 7928 6672 616d   = np.array(fram
-00004800: 6573 2c20 696e 7429 2e72 6176 656c 2829  es, int).ravel()
-00004810: 2025 206e 702e 7375 6d28 7365 6c66 2e5f   % np.sum(self._
-00004820: 4e29 0d0a 0d0a 2020 2020 2020 2020 6966  N)....        if
-00004830: 2073 656c 662e 6772 6964 2021 3d20 2269   self.grid != "i
-00004840: 6d61 6765 2220 6f72 2073 656c 662e 616e  mage" or self.an
-00004850: 676c 6520 213d 2030 3a0d 0a20 2020 2020  gle != 0:..     
-00004860: 2020 2020 2020 2078 6920 3d20 7365 6c66         xi = self
-00004870: 2e63 6f6f 7264 696e 6174 6573 2829 5b2e  .coordinates()[.
-00004880: 2e2e 2c20 305d 0d0a 2020 2020 2020 2020  .., 0]..        
-00004890: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-000048a0: 2020 2042 203d 2069 6e74 286e 702e 6365     B = int(np.ce
-000048b0: 696c 286e 702e 6c6f 6732 2873 656c 662e  il(np.log2(self.
-000048c0: 522e 6d61 7828 2920 2d20 3129 2929 2020  R.max() - 1)))  
-000048d0: 2320 6e65 7874 2070 6f77 6572 206f 6620  # next power of 
-000048e0: 7477 6f0d 0a20 2020 2020 2020 2020 2020  two..           
-000048f0: 2042 202b 3d20 2d42 2025 2038 2020 2320   B += -B % 8  # 
-00004900: 6e65 7874 2070 6f77 6572 206f 6620 7477  next power of tw
-00004910: 6f20 6469 7669 7369 626c 6520 6279 2038  o divisible by 8
-00004920: 0d0a 2020 2020 2020 2020 2020 2020 7869  ..            xi
-00004930: 203d 206e 702e 696e 6469 6365 7328 2873   = np.indices((s
-00004940: 656c 662e 592c 2073 656c 662e 5829 2c20  elf.Y, self.X), 
-00004950: 6474 7970 653d 6622 7569 6e74 7b42 7d22  dtype=f"uint{B}"
-00004960: 2c20 7370 6172 7365 3d54 7275 6529 0d0a  , sparse=True)..
-00004970: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00004980: 656c 662e 696e 6465 7869 6e67 203d 3d20  elf.indexing == 
-00004990: 2278 7922 3a0d 0a20 2020 2020 2020 2020  "xy":..         
-000049a0: 2020 2020 2020 2078 6920 3d20 7869 5b3a         xi = xi[:
-000049b0: 3a2d 315d 0d0a 2020 2020 2020 2020 2020  :-1]..          
-000049c0: 2020 6966 2073 656c 662e 4420 3d3d 2031    if self.D == 1
-000049d0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000049e0: 2020 2078 6920 3d20 5b78 695b 7365 6c66     xi = [xi[self
-000049f0: 2e61 7869 735d 5d0d 0a0d 0a20 2020 2020  .axis]]....     
-00004a00: 2020 2069 735f 6d69 7865 645f 636f 6c6f     is_mixed_colo
-00004a10: 7220 3d20 6e70 2e61 6e79 2828 7365 6c66  r = np.any((self
-00004a20: 2e68 2021 3d20 3029 202a 2028 7365 6c66  .h != 0) * (self
-00004a30: 2e68 2021 3d20 3235 3529 290d 0a20 2020  .h != 255))..   
-00004a40: 2020 2020 2064 7479 7065 203d 206e 702e       dtype = np.
-00004a50: 6474 7970 6528 2266 6c6f 6174 3634 2229  dtype("float64")
-00004a60: 2069 6620 7365 6c66 2e53 444d 206f 7220   if self.SDM or 
-00004a70: 7365 6c66 2e46 444d 206f 7220 6973 5f6d  self.FDM or is_m
-00004a80: 6978 6564 5f63 6f6c 6f72 2065 6c73 6520  ixed_color else 
-00004a90: 7365 6c66 2e64 7479 7065 0d0a 0d0a 2020  self.dtype....  
-00004aa0: 2020 2020 2020 4920 3d20 6e70 2e65 6d70        I = np.emp
-00004ab0: 7479 285b 542c 2073 656c 662e 592c 2073  ty([T, self.Y, s
-00004ac0: 656c 662e 585d 2c20 6474 7970 6529 0d0a  elf.X], dtype)..
-00004ad0: 2020 2020 2020 2020 6964 7820 3d20 300d          idx = 0.
-00004ae0: 0a20 2020 2020 2020 2066 7261 6d65 203d  .        frame =
-00004af0: 2030 0d0a 2020 2020 2020 2020 666f 7220   0..        for 
-00004b00: 6420 696e 2072 616e 6765 2873 656c 662e  d in range(self.
-00004b10: 4429 3a0d 0a20 2020 2020 2020 2020 2020  D):..           
-00004b20: 2078 203d 2078 695b 645d 202f 2073 656c   x = xi[d] / sel
-00004b30: 662e 4c0d 0a0d 0a20 2020 2020 2020 2020  f.L....         
-00004b40: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00004b50: 6528 7365 6c66 2e4b 293a 0d0a 2020 2020  e(self.K):..    
-00004b60: 2020 2020 2020 2020 2020 2020 6b20 3d20              k = 
-00004b70: 3220 2a20 6e70 2e70 6920 2a20 7365 6c66  2 * np.pi * self
-00004b80: 2e5f 765b 642c 2069 5d0d 0a20 2020 2020  ._v[d, i]..     
-00004b90: 2020 2020 2020 2020 2020 2077 203d 2032             w = 2
-00004ba0: 202a 206e 702e 7069 202a 2073 656c 662e   * np.pi * self.
-00004bb0: 5f66 5b64 2c20 695d 0d0a 0d0a 2020 2020  _f[d, i]....    
-00004bc0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00004bd0: 656c 662e 7265 7665 7273 653a 0d0a 2020  elf.reverse:..  
-00004be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bf0: 2020 7720 2a3d 202d 310d 0a0d 0a20 2020    w *= -1....   
-00004c00: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00004c10: 206e 2069 6e20 7261 6e67 6528 7365 6c66   n in range(self
-00004c20: 2e5f 4e5b 642c 2069 5d29 3a0d 0a20 2020  ._N[d, i]):..   
-00004c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004c40: 2069 6620 6672 616d 6520 696e 2066 7261   if frame in fra
-00004c50: 6d65 733a 0d0a 2020 2020 2020 2020 2020  mes:..          
-00004c60: 2020 2020 2020 2020 2020 2020 2020 7420                t 
-00004c70: 3d20 6e20 2f20 3420 6966 2073 656c 662e  = n / 4 if self.
-00004c80: 5f4e 5b64 2c20 695d 203d 3d20 3220 656c  _N[d, i] == 2 el
-00004c90: 7365 206e 202f 2073 656c 662e 5f4e 5b64  se n / self._N[d
-00004ca0: 2c20 695d 0d0a 0d0a 2020 2020 2020 2020  , i]....        
-00004cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004cc0: 7661 6c20 3d20 7365 6c66 2e49 6d61 7820  val = self.Imax 
-00004cd0: 2a20 2873 656c 662e 6265 7461 202a 2028  * (self.beta * (
-00004ce0: 3120 2b20 7365 6c66 2e56 202a 206e 702e  1 + self.V * np.
-00004cf0: 636f 7328 6b20 2a20 7820 2d20 7720 2a20  cos(k * x - w * 
-00004d00: 7420 2d20 7365 6c66 2e6f 2929 2920 2a2a  t - self.o))) **
-00004d10: 2073 656c 662e 6761 6d6d 610d 0a0d 0a20   self.gamma.... 
-00004d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d30: 2020 2020 2020 2069 6620 6474 7970 652e         if dtype.
-00004d40: 6b69 6e64 2069 6e20 2275 6922 2061 6e64  kind in "ui" and
-00004d50: 2072 696e 743a 0d0a 2020 2020 2020 2020   rint:..        
-00004d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d70: 2020 2020 6e70 2e72 696e 7428 7661 6c2c      np.rint(val,
-00004d80: 206f 7574 3d76 616c 290d 0a20 2020 2020   out=val)..     
-00004d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004da0: 2020 2065 6c69 6620 6474 7970 652e 6b69     elif dtype.ki
-00004db0: 6e64 2069 6e20 2262 223a 0d0a 2020 2020  nd in "b":..    
-00004dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004dd0: 2020 2020 2020 2020 7661 6c20 3d20 7661          val = va
-00004de0: 6c20 3e3d 2030 2e35 0d0a 0d0a 2020 2020  l >= 0.5....    
+00000010: 7420 6c6f 6767 696e 670d 0a69 6d70 6f72  t logging..impor
+00000020: 7420 6974 6572 746f 6f6c 7320 6173 2069  t itertools as i
+00000030: 740d 0a66 726f 6d20 636f 6c6c 6563 7469  t..from collecti
+00000040: 6f6e 7320 696d 706f 7274 206e 616d 6564  ons import named
+00000050: 7475 706c 650d 0a69 6d70 6f72 7420 7469  tuple..import ti
+00000060: 6d65 0d0a 696d 706f 7274 206a 736f 6e0d  me..import json.
+00000070: 0a0d 0a69 6d70 6f72 7420 6e75 6d70 7920  ...import numpy 
+00000080: 6173 206e 700d 0a69 6d70 6f72 7420 7363  as np..import sc
+00000090: 6970 7920 6173 2073 700d 0a69 6d70 6f72  ipy as sp..impor
+000000a0: 7420 7379 6d70 790d 0a69 6d70 6f72 7420  t sympy..import 
+000000b0: 736b 696d 6167 6520 6173 2073 6b69 0d0a  skimage as ski..
+000000c0: 696d 706f 7274 2063 7632 0d0a 696d 706f  import cv2..impo
+000000d0: 7274 2074 6f6d 6c0d 0a69 6d70 6f72 7420  rt toml..import 
+000000e0: 7961 6d6c 0d0a 0d0a 6672 6f6d 202e 7574  yaml....from .ut
+000000f0: 696c 2069 6d70 6f72 7420 7673 6861 7065  il import vshape
+00000100: 2c20 6269 6c61 7465 7261 6c2c 205f 7265  , bilateral, _re
+00000110: 6d61 700d 0a66 726f 6d20 2e20 696d 706f  map..from . impo
+00000120: 7274 2067 7269 640d 0a66 726f 6d20 2e64  rt grid..from .d
+00000130: 6563 6f64 6572 2069 6d70 6f72 7420 6465  ecoder import de
+00000140: 636f 6465 0d0a 0d0a 2320 6c6f 6767 696e  code....# loggin
+00000150: 672e 6765 744c 6f67 6765 7228 5f5f 6e61  g.getLogger(__na
+00000160: 6d65 5f5f 290d 0a23 2066 6f72 6d61 7474  me__)..# formatt
+00000170: 6572 203d 206c 6f67 6769 6e67 2e46 6f72  er = logging.For
+00000180: 6d61 7474 6572 2822 2528 6173 6374 696d  matter("%(asctim
+00000190: 6529 7320 2528 6c65 7665 6c6e 616d 6529  e)s %(levelname)
+000001a0: 2d38 7320 2528 6e61 6d65 2937 732e 2528  -8s %(name)7s.%(
+000001b0: 6675 6e63 4e61 6d65 292d 3131 733a 2025  funcName)-11s: %
+000001c0: 286d 6573 7361 6765 2973 2229 0d0a 2320  (message)s")..# 
+000001d0: 6861 6e64 6c65 7220 3d20 6c6f 6767 696e  handler = loggin
+000001e0: 672e 5374 7265 616d 4861 6e64 6c65 7228  g.StreamHandler(
+000001f0: 290d 0a23 2068 616e 646c 6572 2e73 6574  )..# handler.set
+00000200: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+00000210: 7465 7229 0d0a 2320 6c6f 6767 6572 2e61  ter)..# logger.a
+00000220: 6464 4861 6e64 6c65 7228 6861 6e64 6c65  ddHandler(handle
+00000230: 7229 0d0a 2320 6c6f 6767 696e 672e 6765  r)..# logging.ge
+00000240: 744c 6f67 6765 7228 5f5f 6e61 6d65 5f5f  tLogger(__name__
+00000250: 290d 0a0d 0a0d 0a63 6c61 7373 2046 7269  )......class Fri
+00000260: 6e67 6573 3a0d 0a20 2020 2022 2222 4561  nges:..    """Ea
+00000270: 7379 2d74 6f2d 7573 6520 636c 6173 7320  sy-to-use class 
+00000280: 746f 2063 6f6e 6669 6775 7265 2c20 656e  to configure, en
+00000290: 636f 6465 2061 6e64 2064 6563 6f64 6520  code and decode 
+000002a0: 6375 7374 6f6d 697a 6564 2066 7269 6e67  customized fring
+000002b0: 6520 7061 7474 6572 6e73 2075 7369 6e67  e patterns using
+000002c0: 2070 6861 7365 2073 6869 6674 696e 6720   phase shifting 
+000002d0: 616c 676f 7269 7468 6d73 2e22 2222 0d0a  algorithms."""..
+000002e0: 0d0a 2020 2020 2320 6e6f 7465 3a20 7468  ..    # note: th
+000002f0: 6520 636c 6173 7320 646f 6373 7472 696e  e class docstrin
+00000300: 6720 6973 2063 6f6e 7469 6e75 6174 6564  g is continuated
+00000310: 2061 7420 7468 6520 656e 6420 6f66 2074   at the end of t
+00000320: 6865 2063 6c61 7373 0d0a 0d0a 2020 2020  he class....    
+00000330: 2320 7661 6c75 6520 6c69 6d69 7473 0d0a  # value limits..
+00000340: 2020 2020 5f48 6d61 7820 3d20 3130 3120      _Hmax = 101 
+00000350: 2023 2074 6869 7320 6973 2061 7262 6974   # this is arbit
+00000360: 7261 7279 0d0a 2020 2020 5f44 6d61 7820  rary..    _Dmax 
+00000370: 3d20 3220 2023 206d 6178 2032 2064 696d  = 2  # max 2 dim
+00000380: 656e 7369 6f6e 730d 0a20 2020 205f 4b6d  ensions..    _Km
+00000390: 6178 203d 2031 3031 2020 2320 7468 6973  ax = 101  # this
+000003a0: 2069 7320 6172 6269 7472 6172 792c 2062   is arbitrary, b
+000003b0: 7574 206d 7573 7420 6265 203c 2031 3238  ut must be < 128
+000003c0: 2077 6865 6e20 6465 706c 6f79 696e 6720   when deploying 
+000003d0: 7370 6174 6961 6c20 6f72 2066 7265 7175  spatial or frequ
+000003e0: 656e 6379 206d 756c 7469 706c 6578 696e  ency multiplexin
+000003f0: 6720 4020 7569 6e74 380d 0a20 2020 205f  g @ uint8..    _
+00000400: 4e6d 6178 203d 2031 3030 3120 2023 2074  Nmax = 1001  # t
+00000410: 6869 7320 6973 2061 7262 6974 7261 7279  his is arbitrary
+00000420: 3b20 6d6f 7265 2069 7320 6265 7474 6572  ; more is better
+00000430: 2062 7574 2074 6865 2069 6d70 726f 7665   but the improve
+00000440: 6d65 6e74 2073 6361 6c65 7320 7769 7468  ment scales with
+00000450: 2073 7172 7428 4e29 3b20 4046 444d 3a20   sqrt(N); @FDM: 
+00000460: 3e20 3220 2a20 5f66 6d61 7820 2b20 310d  > 2 * _fmax + 1.
+00000470: 0a20 2020 205f 4d6d 6178 203d 2031 3031  .    _Mmax = 101
+00000480: 2020 2320 7468 6973 2069 7320 6172 6269    # this is arbi
+00000490: 7472 6172 793b 206d 6f72 6520 6973 2062  trary; more is b
+000004a0: 6574 7465 7220 6275 7420 7468 6520 696d  etter but the im
+000004b0: 7072 6f76 656d 656e 7420 7363 616c 6573  provement scales
+000004c0: 2077 6974 6820 7371 7274 284d 290d 0a20   with sqrt(M).. 
+000004d0: 2020 2023 205f 506d 6178 3a20 696e 7420     # _Pmax: int 
+000004e0: 3d20 3335 3635 3135 3834 2020 2320 7e38  = 35651584  # ~8
+000004f0: 4b20 692e 652e 206d 6178 206c 756d 6120  K i.e. max luma 
+00000500: 7069 6374 7572 6520 7369 7a65 206f 6620  picture size of 
+00000510: 6832 3634 2c20 6832 3635 2c20 6832 3636  h264, h265, h266
+00000520: 2076 6964 656f 2063 6f64 6563 7320 6173   video codecs as
+00000530: 206f 6620 3230 3232 3b20 746f 646f 3a20   of 2022; todo: 
+00000540: 7570 6461 7465 0d0a 2020 2020 5f50 6d61  update..    _Pma
+00000550: 7820 3d20 322a 2a33 3020 2023 2032 5e33  x = 2**30  # 2^3
+00000560: 3020 3d20 312c 3037 332c 3734 312c 3832  0 = 1,073,741,82
+00000570: 3420 692e 652e 2064 6566 6175 6c74 2073  4 i.e. default s
+00000580: 697a 6520 2020 6c69 6d69 7420 6f66 2069  ize   limit of i
+00000590: 6d72 6561 6428 2920 696e 204f 7065 6e43  mread() in OpenC
+000005a0: 560d 0a20 2020 205f 586d 6178 203d 2032  V..    _Xmax = 2
+000005b0: 2a2a 3230 2020 2320 325e 3230 203d 2031  **20  # 2^20 = 1
+000005c0: 2c30 3438 2c35 3736 2020 2020 2069 2e65  ,048,576     i.e
+000005d0: 2e20 6465 6661 756c 7420 7769 6474 6820  . default width 
+000005e0: 206c 696d 6974 206f 6620 696d 7265 6164   limit of imread
+000005f0: 2829 2069 6e20 4f70 656e 4356 0d0a 2020  () in OpenCV..  
+00000600: 2020 5f59 6d61 7820 3d20 322a 2a32 3020    _Ymax = 2**20 
+00000610: 2023 2032 5e32 3020 3d20 312c 3034 382c   # 2^20 = 1,048,
+00000620: 3537 3620 2020 2020 692e 652e 2064 6566  576     i.e. def
+00000630: 6175 6c74 2068 6569 6768 7420 6c69 6d69  ault height limi
+00000640: 7420 6f66 2069 6d72 6561 6428 2920 696e  t of imread() in
+00000650: 204f 7065 6e43 560d 0a20 2020 205f 4c6d   OpenCV..    _Lm
+00000660: 6178 203d 2032 2a2a 3230 2020 2320 325e  ax = 2**20  # 2^
+00000670: 3230 203d 2031 2c30 3438 2c35 3736 2020  20 = 1,048,576  
+00000680: 2020 2069 2e65 2e20 6465 6661 756c 7420     i.e. default 
+00000690: 6865 6967 6874 206c 696d 6974 206f 6620  height limit of 
+000006a0: 696d 7265 6164 2829 2069 6e20 4f70 656e  imread() in Open
+000006b0: 4356 0d0a 2020 2020 5f54 6d61 7820 3d20  CV..    _Tmax = 
+000006c0: 5f48 6d61 7820 2a20 5f44 6d61 7820 2a20  _Hmax * _Dmax * 
+000006d0: 5f4b 6d61 7820 2a20 5f4e 6d61 780d 0a20  _Kmax * _Nmax.. 
+000006e0: 2020 205f 616c 7068 616d 6178 203d 2032     _alphamax = 2
+000006f0: 0d0a 2020 2020 5f67 616d 6d61 6d61 7820  ..    _gammamax 
+00000700: 3d20 3320 2023 206d 6f73 7420 7363 7265  = 3  # most scre
+00000710: 656e 7320 6861 7665 2061 2067 616d 6d61  ens have a gamma
+00000720: 206f 6620 7e32 2e32 0d0a 2020 2020 2320   of ~2.2..    # 
+00000730: 5f6c 6d69 6e6d 696e 203d 2032 2020 2320  _lminmin = 2  # 
+00000740: 6c20 3d3d 2032 206f 6e6c 7920 6966 2070  l == 2 only if p
+00000750: 3020 213d 2070 6920 2f20 3220 2b20 3270  0 != pi / 2 + 2p
+00000760: 692a 6b2c 2062 6573 7420 6966 2070 3020  i*k, best if p0 
+00000770: 3d3d 2070 6920 2b20 3270 692a 6b20 7769  == pi + 2pi*k wi
+00000780: 7468 206b 2069 7320 706f 7369 7469 7665  th k is positive
+00000790: 2069 6e74 6567 6572 0d0a 2020 2020 2320   integer..    # 
+000007a0: 2020 2020 2020 2020 2020 2061 6c73 6f20             also 
+000007b0: 6c20 3c3d 2032 2079 6965 6c64 7320 6572  l <= 2 yields er
+000007c0: 726f 7273 2069 6e20 5350 553a 2070 6861  rors in SPU: pha
+000007d0: 7365 206a 756d 7073 203d 2032 5049 202f  se jumps = 2PI /
+000007e0: 206c 6d69 6e20 3e3d 206e 702e 7069 0d0a   lmin >= np.pi..
+000007f0: 2020 2020 5f6c 6d69 6e6d 696e 203d 2033      _lminmin = 3
+00000800: 2020 2320 6c20 3e3d 2033 2079 6965 6c64    # l >= 3 yield
+00000810: 7320 7375 6666 6963 6965 6e74 206d 6f64  s sufficient mod
+00000820: 756c 6174 696f 6e20 7468 656f 7265 7469  ulation theoreti
+00000830: 6361 6c6c 790d 0a20 2020 2023 205f 6c6d  cally..    # _lm
+00000840: 696e 6d69 6e20 3d20 3820 2023 206c 203e  inmin = 8  # l >
+00000850: 3d20 3820 7969 656c 6473 2073 7566 6669  = 8 yields suffi
+00000860: 6369 656e 7420 6d6f 6475 6c61 7469 6f6e  cient modulation
+00000870: 2070 7261 6374 6963 616c 6c79 205b 4c69   practically [Li
+00000880: 7532 3031 345d 0d0a 0d0a 2020 2020 2320  u2014]....    # 
+00000890: 616c 6c6f 7765 6420 7661 6c75 6573 3b20  allowed values; 
+000008a0: 7461 6b65 2063 6172 6520 746f 206f 6e6c  take care to onl
+000008b0: 7920 7573 6520 696d 6d75 7461 626c 6520  y use immutable 
+000008c0: 7479 7065 7321 2020 2320 746f 646f 3a20  types!  # todo: 
+000008d0: 6973 2074 6861 7420 736f 3f0d 0a20 2020  is that so?..   
+000008e0: 2076 616c 7565 7320 3d20 7b0d 0a20 2020   values = {..   
+000008f0: 2020 2020 2022 6772 6964 223a 2028 2269       "grid": ("i
+00000900: 6d61 6765 2229 2c20 2023 2074 6f64 6f3a  mage"),  # todo:
+00000910: 2028 2269 6d61 6765 222c 2022 4361 7274   ("image", "Cart
+00000920: 6573 6961 6e22 2c20 2270 6f6c 6172 222c  esian", "polar",
+00000930: 2022 6c6f 672d 706f 6c61 7222 290d 0a20   "log-polar").. 
+00000940: 2020 2020 2020 2022 696e 6465 7869 6e67         "indexing
+00000950: 223a 2028 2278 7922 2c20 2269 6a22 292c  ": ("xy", "ij"),
+00000960: 0d0a 2020 2020 2020 2020 2264 7479 7065  ..        "dtype
+00000970: 223a 2028 0d0a 2020 2020 2020 2020 2020  ": (..          
+00000980: 2020 2320 2262 6f6f 6c22 2c20 2023 2072    # "bool",  # r
+00000990: 6573 756c 7473 2061 7265 2074 6f6f 2075  esults are too u
+000009a0: 6e70 7265 6369 7365 0d0a 2020 2020 2020  nprecise..      
+000009b0: 2020 2020 2020 2275 696e 7438 222c 0d0a        "uint8",..
+000009c0: 2020 2020 2020 2020 2020 2020 2275 696e              "uin
+000009d0: 7431 3622 2c0d 0a20 2020 2020 2020 2020  t16",..         
+000009e0: 2020 2023 2022 7569 6e74 3332 222c 2020     # "uint32",  
+000009f0: 2320 696e 7465 6765 7220 6f76 6572 666c  # integer overfl
+00000a00: 6f77 2069 6e20 7079 7174 6772 6170 6820  ow in pyqtgraph 
+00000a10: 2d3e 2072 6570 6c61 6365 206c 696e 6520  -> replace line 
+00000a20: 3532 3820 6f66 2049 6d61 6765 4974 656d  528 of ImageItem
+00000a30: 2e70 7920 7769 7468 3a0d 0a20 2020 2020  .py with:..     
+00000a40: 2020 2020 2020 2023 2022 7569 6e74 3634         # "uint64
+00000a50: 222c 2020 2320 6269 6e73 203d 2073 656c  ",  # bins = sel
+00000a60: 662e 5f78 702e 6172 616e 6765 286d 6e2c  f._xp.arange(mn,
+00000a70: 206d 7820 2b20 312e 3031 202a 2073 7465   mx + 1.01 * ste
+00000a80: 702c 2073 7465 702c 2064 7479 7065 3d22  p, step, dtype="
+00000a90: 7569 6e74 3634 2229 0d0a 2020 2020 2020  uint64")..      
+00000aa0: 2020 2020 2020 2320 2266 6c6f 6174 3136        # "float16
+00000ab0: 222c 2020 2320 6e75 6d62 6120 646f 6573  ",  # numba does
+00000ac0: 6e27 7420 6861 6e64 6c65 2066 6c6f 6174  n't handle float
+00000ad0: 3136 2c20 616c 736f 206d 6f73 7420 616c  16, also most al
+00000ae0: 676f 7269 7468 6d73 2063 6f6e 7665 7274  gorithms convert
+00000af0: 2066 6c6f 6174 3136 2074 6f20 666c 6f61   float16 to floa
+00000b00: 7433 3220 616e 7977 6179 0d0a 2020 2020  t32 anyway..    
+00000b10: 2020 2020 2020 2020 2266 6c6f 6174 3332          "float32
+00000b20: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00000b30: 2266 6c6f 6174 3634 222c 0d0a 2020 2020  "float64",..    
+00000b40: 2020 2020 292c 0d0a 2020 2020 2020 2020      ),..        
+00000b50: 226d 6f64 6522 3a20 2822 6661 7374 222c  "mode": ("fast",
+00000b60: 2022 7072 6563 6973 6522 292c 0d0a 2020   "precise"),..  
+00000b70: 2020 7d0d 0a0d 0a20 2020 2023 2061 6c6c    }....    # all
+00000b80: 6f77 6564 2076 616c 7565 733b 2074 616b  owed values; tak
+00000b90: 6520 6361 7265 2074 6f20 6f6e 6c79 2075  e care to only u
+00000ba0: 7365 2069 6d6d 7574 6162 6c65 2074 7970  se immutable typ
+00000bb0: 6573 210d 0a20 2020 205f 6772 6964 7320  es!..    _grids 
+00000bc0: 3d20 2828 2269 6d61 6765 2229 2c29 2020  = (("image"),)  
+00000bd0: 2320 746f 646f 3a20 2822 696d 6167 6522  # todo: ("image"
+00000be0: 2c20 2243 6172 7465 7369 616e 222c 2022  , "Cartesian", "
+00000bf0: 706f 6c61 7222 2c20 226c 6f67 2d70 6f6c  polar", "log-pol
+00000c00: 6172 2229 0d0a 2020 2020 5f69 6e64 6578  ar")..    _index
+00000c10: 696e 6773 203d 2028 2278 7922 2c20 2269  ings = ("xy", "i
+00000c20: 6a22 290d 0a20 2020 205f 6474 7970 6573  j")..    _dtypes
+00000c30: 203d 2028 0d0a 2020 2020 2020 2020 2320   = (..        # 
+00000c40: 2262 6f6f 6c22 2c20 2023 2072 6573 756c  "bool",  # resul
+00000c50: 7473 2061 7265 2074 6f6f 2075 6e70 7265  ts are too unpre
+00000c60: 6369 7365 0d0a 2020 2020 2020 2020 2275  cise..        "u
+00000c70: 696e 7438 222c 0d0a 2020 2020 2020 2020  int8",..        
+00000c80: 2275 696e 7431 3622 2c0d 0a20 2020 2020  "uint16",..     
+00000c90: 2020 2023 2022 7569 6e74 3332 222c 2020     # "uint32",  
+00000ca0: 2320 696e 7465 6765 7220 6f76 6572 666c  # integer overfl
+00000cb0: 6f77 2069 6e20 7079 7174 6772 6170 6820  ow in pyqtgraph 
+00000cc0: 2d3e 2072 6570 6c61 6365 206c 696e 6520  -> replace line 
+00000cd0: 3532 3820 6f66 2049 6d61 6765 4974 656d  528 of ImageItem
+00000ce0: 2e70 7920 7769 7468 3a0d 0a20 2020 2020  .py with:..     
+00000cf0: 2020 2023 2022 7569 6e74 3634 222c 2020     # "uint64",  
+00000d00: 2320 6269 6e73 203d 2073 656c 662e 5f78  # bins = self._x
+00000d10: 702e 6172 616e 6765 286d 6e2c 206d 7820  p.arange(mn, mx 
+00000d20: 2b20 312e 3031 202a 2073 7465 702c 2073  + 1.01 * step, s
+00000d30: 7465 702c 2064 7479 7065 3d22 7569 6e74  tep, dtype="uint
+00000d40: 3634 2229 0d0a 2020 2020 2020 2020 2320  64")..        # 
+00000d50: 2266 6c6f 6174 3136 222c 2020 2320 6e75  "float16",  # nu
+00000d60: 6d62 6120 646f 6573 6e27 7420 6861 6e64  mba doesn't hand
+00000d70: 6c65 2066 6c6f 6174 3136 2c20 616c 736f  le float16, also
+00000d80: 206d 6f73 7420 616c 676f 7269 7468 6d73   most algorithms
+00000d90: 2063 6f6e 7665 7274 2066 6c6f 6174 3136   convert float16
+00000da0: 2074 6f20 666c 6f61 7433 3220 616e 7977   to float32 anyw
+00000db0: 6179 0d0a 2020 2020 2020 2020 2266 6c6f  ay..        "flo
+00000dc0: 6174 3332 222c 0d0a 2020 2020 2020 2020  at32",..        
+00000dd0: 2266 6c6f 6174 3634 222c 0d0a 2020 2020  "float64",..    
+00000de0: 290d 0a20 2020 205f 6d6f 6465 7320 3d20  )..    _modes = 
+00000df0: 2822 6661 7374 222c 2022 7072 6563 6973  ("fast", "precis
+00000e00: 6522 290d 0a0d 0a20 2020 205f 6c6f 6164  e")....    _load
+00000e10: 6572 203d 207b 0d0a 2020 2020 2020 2020  er = {..        
+00000e20: 222e 6a73 6f6e 223a 206a 736f 6e2e 6c6f  ".json": json.lo
+00000e30: 6164 2c0d 0a20 2020 2020 2020 2022 2e79  ad,..        ".y
+00000e40: 616d 6c22 3a20 7961 6d6c 2e73 6166 655f  aml": yaml.safe_
+00000e50: 6c6f 6164 2c0d 0a20 2020 2020 2020 2022  load,..        "
+00000e60: 2e74 6f6d 6c22 3a20 746f 6d6c 2e6c 6f61  .toml": toml.loa
+00000e70: 642c 0d0a 2020 2020 7d0d 0a0d 0a20 2020  d,..    }....   
+00000e80: 205f 7665 7262 6f73 655f 6f75 7470 7574   _verbose_output
+00000e90: 203d 2028 0d0a 2020 2020 2020 2020 2262   = (..        "b
+00000ea0: 7269 6768 746e 6573 7322 2c0d 0a20 2020  rightness",..   
+00000eb0: 2020 2020 2022 6d6f 6475 6c61 7469 6f6e       "modulation
+00000ec0: 222c 0d0a 2020 2020 2020 2020 2272 6567  ",..        "reg
+00000ed0: 6973 7472 6174 696f 6e22 2c0d 0a20 2020  istration",..   
+00000ee0: 2020 2020 2022 7068 6173 6522 2c0d 0a20       "phase",.. 
+00000ef0: 2020 2020 2020 2022 6f72 6465 7222 2c0d         "order",.
+00000f00: 0a20 2020 2020 2020 2022 7265 7369 6475  .        "residu
+00000f10: 616c 7322 2c0d 0a20 2020 2020 2020 2022  als",..        "
+00000f20: 756e 6365 7274 6169 6e74 7922 2c0d 0a20  uncertainty",.. 
+00000f30: 2020 2020 2020 2022 6578 706f 7375 7265         "exposure
+00000f40: 222c 0d0a 2020 2020 2020 2020 2276 6973  ",..        "vis
+00000f50: 6962 696c 6974 7922 2c0d 0a20 2020 2029  ibility",..    )
+00000f60: 0d0a 0d0a 2020 2020 2320 6465 6661 756c  ....    # defaul
+00000f70: 7420 7661 6c75 6573 2061 7265 2064 6566  t values are def
+00000f80: 696e 6564 2068 6572 653b 2074 616b 6520  ined here; take 
+00000f90: 6361 7265 2074 6f20 6f6e 6c79 2075 7365  care to only use
+00000fa0: 2069 6d6d 7574 6162 6c65 2074 7970 6573   immutable types
+00000fb0: 210d 0a20 2020 2064 6566 205f 5f69 6e69  !..    def __ini
+00000fc0: 745f 5f28 0d0a 2020 2020 2020 2020 7365  t__(..        se
+00000fd0: 6c66 2c0d 0a20 2020 2020 2020 202a 6172  lf,..        *ar
+00000fe0: 6773 2c20 2023 2062 756e 6465 6c73 2061  gs,  # bundels a
+00000ff0: 6c6c 2061 7267 732c 2077 6861 7420 666f  ll args, what fo
+00001000: 6c6c 6f77 7320 6172 6520 6f6e 6c79 206b  llows are only k
+00001010: 7761 7267 730d 0a20 2020 2020 2020 2059  wargs..        Y
+00001020: 3a20 696e 7420 3d20 3132 3030 2c0d 0a20  : int = 1200,.. 
+00001030: 2020 2020 2020 2058 3a20 696e 7420 3d20         X: int = 
+00001040: 3139 3230 2c0d 0a20 2020 2020 2020 2048  1920,..        H
+00001050: 3a20 696e 7420 3d20 312c 2020 2320 696e  : int = 1,  # in
+00001060: 6665 7272 6564 2066 726f 6d20 680d 0a20  ferred from h.. 
+00001070: 2020 2020 2020 204d 3a20 666c 6f61 7420         M: float 
+00001080: 3d20 312e 302c 2020 2320 696e 6665 7272  = 1.0,  # inferr
+00001090: 6564 2066 726f 6d20 680d 0a20 2020 2020  ed from h..     
+000010a0: 2020 2044 3a20 696e 7420 3d20 322c 0d0a     D: int = 2,..
+000010b0: 2020 2020 2020 2020 4b3a 2069 6e74 203d          K: int =
+000010c0: 2033 2c0d 0a20 2020 2020 2020 2054 3a20   3,..        T: 
+000010d0: 696e 7420 3d20 3234 2c20 2023 2054 2069  int = 24,  # T i
+000010e0: 7320 696e 6665 7272 6564 0d0a 2020 2020  s inferred..    
+000010f0: 2020 2020 4e3a 2074 7570 6c65 207c 206e      N: tuple | n
+00001100: 702e 6e64 6172 7261 7920 3d20 6e70 2e61  p.ndarray = np.a
+00001110: 7272 6179 285b 5b34 2c20 342c 2034 5d2c  rray([[4, 4, 4],
+00001120: 205b 342c 2034 2c20 345d 5d2c 2069 6e74   [4, 4, 4]], int
+00001130: 292c 0d0a 2020 2020 2020 2020 6c3a 2074  ),..        l: t
+00001140: 7570 6c65 207c 206e 702e 6e64 6172 7261  uple | np.ndarra
+00001150: 7920 3d20 3139 3230 202f 206e 702e 6172  y = 1920 / np.ar
+00001160: 7261 7928 5b5b 3133 2c20 372c 2038 395d  ray([[13, 7, 89]
+00001170: 2c20 5b31 332c 2037 2c20 3839 5d5d 2c20  , [13, 7, 89]], 
+00001180: 666c 6f61 7429 2c20 2023 2069 6e66 6572  float),  # infer
+00001190: 7265 6420 6672 6f6d 2076 0d0a 2020 2020  red from v..    
+000011a0: 2020 2020 763a 2074 7570 6c65 207c 206e      v: tuple | n
+000011b0: 702e 6e64 6172 7261 7920 3d20 6e70 2e61  p.ndarray = np.a
+000011c0: 7272 6179 285b 5b31 332c 2037 2c20 3839  rray([[13, 7, 89
+000011d0: 5d2c 205b 3133 2c20 372c 2038 395d 5d2c  ], [13, 7, 89]],
+000011e0: 2066 6c6f 6174 292c 0d0a 2020 2020 2020   float),..      
+000011f0: 2020 663a 2074 7570 6c65 207c 206e 702e    f: tuple | np.
+00001200: 6e64 6172 7261 7920 3d20 6e70 2e61 7272  ndarray = np.arr
+00001210: 6179 285b 5b31 2c20 312c 2031 5d2c 205b  ay([[1, 1, 1], [
+00001220: 312c 2031 2c20 315d 5d2c 2066 6c6f 6174  1, 1, 1]], float
+00001230: 292c 0d0a 2020 2020 2020 2020 683a 2074  ),..        h: t
+00001240: 7570 6c65 207c 206e 702e 6e64 6172 7261  uple | np.ndarra
+00001250: 7920 3d20 6e70 2e61 7272 6179 285b 5b32  y = np.array([[2
+00001260: 3535 2c20 3235 352c 2032 3535 5d5d 2c20  55, 255, 255]], 
+00001270: 696e 7429 2c0d 0a20 2020 2020 2020 2070  int),..        p
+00001280: 303a 2066 6c6f 6174 203d 206e 702e 7069  0: float = np.pi
+00001290: 2c0d 0a20 2020 2020 2020 2067 616d 6d61  ,..        gamma
+000012a0: 3a20 666c 6f61 7420 3d20 312e 302c 0d0a  : float = 1.0,..
+000012b0: 2020 2020 2020 2020 413a 2066 6c6f 6174          A: float
+000012c0: 203d 2032 3535 202f 2032 2c20 2023 2069   = 255 / 2,  # i
+000012d0: 2e65 2e20 496d 6178 202f 2032 2040 2075  .e. Imax / 2 @ u
+000012e0: 696e 7438 3b20 696e 6665 7272 6564 2066  int8; inferred f
+000012f0: 726f 6d20 496d 6178 2061 6e64 2062 6574  rom Imax and bet
+00001300: 610d 0a20 2020 2020 2020 2042 3a20 666c  a..        B: fl
+00001310: 6f61 7420 3d20 3235 3520 2f20 322c 2020  oat = 255 / 2,  
+00001320: 2320 692e 652e 2049 6d61 7820 2f20 3220  # i.e. Imax / 2 
+00001330: 4020 7569 6e74 383b 2069 6e66 6572 7265  @ uint8; inferre
+00001340: 6420 6672 6f6d 2049 6d61 7820 616e 6420  d from Imax and 
+00001350: 6265 7461 2061 6e64 2056 0d0a 2020 2020  beta and V..    
+00001360: 2020 2020 6265 7461 3a20 666c 6f61 7420      beta: float 
+00001370: 3d20 302e 352c 0d0a 2020 2020 2020 2020  = 0.5,..        
+00001380: 563a 2066 6c6f 6174 203d 2031 2e30 2c20  V: float = 1.0, 
+00001390: 2023 2056 2069 7320 696e 6665 7272 6564   # V is inferred
+000013a0: 2066 726f 6d20 4120 616e 6420 420d 0a20   from A and B.. 
+000013b0: 2020 2020 2020 2056 6d69 6e3a 2066 6c6f         Vmin: flo
+000013c0: 6174 203d 2030 2e30 2c0d 0a20 2020 2020  at = 0.0,..     
+000013d0: 2020 2075 6d61 783a 2066 6c6f 6174 203d     umax: float =
+000013e0: 2030 2e35 2c0d 0a20 2020 2020 2020 2061   0.5,..        a
+000013f0: 6c70 6861 3a20 666c 6f61 7420 3d20 312e  lpha: float = 1.
+00001400: 302c 0d0a 2020 2020 2020 2020 6474 7970  0,..        dtyp
+00001410: 653a 2073 7472 207c 206e 702e 6474 7970  e: str | np.dtyp
+00001420: 6520 3d20 2275 696e 7438 222c 0d0a 2020  e = "uint8",..  
+00001430: 2020 2020 2020 6772 6964 3a20 7374 7220        grid: str 
+00001440: 3d20 2269 6d61 6765 222c 0d0a 2020 2020  = "image",..    
+00001450: 2020 2020 616e 676c 653a 2066 6c6f 6174      angle: float
+00001460: 203d 2030 2e30 2c0d 0a20 2020 2020 2020   = 0.0,..       
+00001470: 2061 7869 733a 2069 6e74 203d 2030 2c0d   axis: int = 0,.
+00001480: 0a20 2020 2020 2020 2053 444d 3a20 626f  .        SDM: bo
+00001490: 6f6c 203d 2046 616c 7365 2c0d 0a20 2020  ol = False,..   
+000014a0: 2020 2020 2057 444d 3a20 626f 6f6c 203d       WDM: bool =
+000014b0: 2046 616c 7365 2c0d 0a20 2020 2020 2020   False,..       
+000014c0: 2046 444d 3a20 626f 6f6c 203d 2046 616c   FDM: bool = Fal
+000014d0: 7365 2c0d 0a20 2020 2020 2020 2073 7461  se,..        sta
+000014e0: 7469 633a 2062 6f6f 6c20 3d20 4661 6c73  tic: bool = Fals
+000014f0: 652c 0d0a 2020 2020 2020 2020 6c6d 696e  e,..        lmin
+00001500: 3a20 666c 6f61 7420 3d20 382e 302c 0d0a  : float = 8.0,..
+00001510: 2020 2020 2020 2020 696e 6465 7869 6e67          indexing
+00001520: 3a20 7374 7220 3d20 2278 7922 2c0d 0a20  : str = "xy",.. 
+00001530: 2020 2020 2020 2072 6576 6572 7365 3a20         reverse: 
+00001540: 626f 6f6c 203d 2046 616c 7365 2c0d 0a20  bool = False,.. 
+00001550: 2020 2020 2020 2076 6572 626f 7365 3a20         verbose: 
+00001560: 626f 6f6c 203d 2046 616c 7365 2c0d 0a20  bool = False,.. 
+00001570: 2020 2020 2020 2042 763a 2074 7570 6c65         Bv: tuple
+00001580: 207c 206e 702e 6e64 6172 7261 7920 3d20   | np.ndarray = 
+00001590: 4e6f 6e65 2c0d 0a20 2020 2020 2020 2050  None,..        P
+000015a0: 5346 3a20 666c 6f61 7420 3d20 302e 302c  SF: float = 0.0,
+000015b0: 0d0a 2020 2020 2020 2020 6461 726b 3a20  ..        dark: 
+000015c0: 666c 6f61 7420 3d20 302e 302c 0d0a 2020  float = 0.0,..  
+000015d0: 2020 2020 2020 6761 696e 3a20 666c 6f61        gain: floa
+000015e0: 7420 3d20 302e 302c 0d0a 2020 2020 2020  t = 0.0,..      
+000015f0: 2020 7930 3a20 666c 6f61 7420 3d20 302e    y0: float = 0.
+00001600: 302c 0d0a 2020 2020 2020 2020 6d6f 6465  0,..        mode
+00001610: 3a20 7374 7220 3d20 2266 6173 7422 2c0d  : str = "fast",.
+00001620: 0a20 2020 2020 2020 2023 2020 2a2a 6b77  .        #  **kw
+00001630: 6172 6773 2c20 2023 2062 756e 646c 6573  args,  # bundles
+00001640: 2061 6c6c 2075 6e64 6566 696e 6564 206b   all undefined k
+00001650: 7761 7267 732c 2065 6c73 6520 6572 726f  wargs, else erro
+00001660: 723a 205f 5f69 6e69 745f 5f28 2920 676f  r: __init__() go
+00001670: 7420 616e 2075 6e65 7870 6563 7465 6420  t an unexpected 
+00001680: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
+00001690: 0d0a 2020 2020 2920 2d3e 204e 6f6e 653a  ..    ) -> None:
+000016a0: 0d0a 2020 2020 2020 2020 2320 6769 7665  ..        # give
+000016b0: 6e20 7661 6c75 6573 2077 6869 6368 2061  n values which a
+000016c0: 7265 2069 6e20 6465 6661 756c 7473 2062  re in defaults b
+000016d0: 7574 2061 7265 206e 6f74 2069 6465 6e74  ut are not ident
+000016e0: 6963 616c 2074 6f20 7468 656d 0d0a 2020  ical to them..  
+000016f0: 2020 2020 2020 6769 7665 6e20 3d20 7b0d        given = {.
+00001700: 0a20 2020 2020 2020 2020 2020 206b 3a20  .            k: 
+00001710: 7620 666f 7220 6b2c 2076 2069 6e20 736f  v for k, v in so
+00001720: 7274 6564 286c 6f63 616c 7328 292e 6974  rted(locals().it
+00001730: 656d 7328 2929 2069 6620 6b20 696e 2073  ems()) if k in s
+00001740: 656c 662e 6465 6661 756c 7473 2061 6e64  elf.defaults and
+00001750: 206e 6f74 206e 702e 6172 7261 795f 6571   not np.array_eq
+00001760: 7561 6c28 762c 2073 656c 662e 6465 6661  ual(v, self.defa
+00001770: 756c 7473 5b6b 5d29 0d0a 2020 2020 2020  ults[k])..      
+00001780: 2020 7d0d 0a0d 0a20 2020 2020 2020 2023    }....        #
+00001790: 206c 6f67 6765 720d 0a20 2020 2020 2020   logger..       
+000017a0: 2073 656c 662e 6c6f 6767 6572 203d 206c   self.logger = l
+000017b0: 6f67 6769 6e67 2e67 6574 4c6f 6767 6572  ogging.getLogger
+000017c0: 2873 656c 662e 5f5f 636c 6173 735f 5f2e  (self.__class__.
+000017d0: 5f5f 6e61 6d65 5f5f 290d 0a20 2020 2020  __name__)..     
+000017e0: 2020 2073 656c 662e 6c6f 6767 6572 2e73     self.logger.s
+000017f0: 6574 4c65 7665 6c28 2257 4152 4e49 4e47  etLevel("WARNING
+00001800: 2229 0d0a 2020 2020 2020 2020 6966 206e  ")..        if n
+00001810: 6f74 2073 656c 662e 6c6f 6767 6572 2e68  ot self.logger.h
+00001820: 6173 4861 6e64 6c65 7273 2829 3a0d 0a20  asHandlers():.. 
+00001830: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00001840: 7474 6572 203d 206c 6f67 6769 6e67 2e46  tter = logging.F
+00001850: 6f72 6d61 7474 6572 2822 2528 6173 6374  ormatter("%(asct
+00001860: 696d 6529 7320 2528 6c65 7665 6c6e 616d  ime)s %(levelnam
+00001870: 6529 2d38 7320 2528 6e61 6d65 2937 732e  e)-8s %(name)7s.
+00001880: 2528 6675 6e63 4e61 6d65 292d 3131 733a  %(funcName)-11s:
+00001890: 2025 286d 6573 7361 6765 2973 2229 0d0a   %(message)s")..
+000018a0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+000018b0: 6c65 7220 3d20 6c6f 6767 696e 672e 5374  ler = logging.St
+000018c0: 7265 616d 4861 6e64 6c65 7228 290d 0a20  reamHandler().. 
+000018d0: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+000018e0: 6572 2e73 6574 466f 726d 6174 7465 7228  er.setFormatter(
+000018f0: 666f 726d 6174 7465 7229 0d0a 2020 2020  formatter)..    
+00001900: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00001910: 6765 722e 6164 6448 616e 646c 6572 2868  ger.addHandler(h
+00001920: 616e 646c 6572 290d 0a0d 0a20 2020 2020  andler)....     
+00001930: 2020 2023 2073 6574 2064 6566 6175 6c74     # set default
+00001940: 2076 616c 7565 730d 0a20 2020 2020 2020   values..       
+00001950: 2073 656c 662e 5f55 4d52 203d 204e 6f6e   self._UMR = Non
+00001960: 6520 2023 2075 7365 6420 666f 7220 6361  e  # used for ca
+00001970: 6368 696e 670d 0a20 2020 2020 2020 2066  ching..        f
+00001980: 6f72 206b 2c20 7620 696e 2073 656c 662e  or k, v in self.
+00001990: 6465 6661 756c 7473 2e69 7465 6d73 2829  defaults.items()
+000019a0: 3a0d 0a20 2020 2020 2020 2020 2020 2069  :..            i
+000019b0: 6620 6b20 6e6f 7420 696e 2022 484d 546c  f k not in "HMTl
+000019c0: 4142 223a 2020 2320 7468 6573 6520 7072  AB":  # these pr
+000019d0: 6f70 6572 7469 6573 2061 7265 2069 6e66  operties are inf
+000019e0: 6572 7265 6420 6672 6f6d 206f 7468 6572  erred from other
+000019f0: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
+00001a00: 2020 2073 6574 6174 7472 2873 656c 662c     setattr(self,
+00001a10: 2066 225f 7b6b 7d22 2c20 7629 2020 2320   f"_{k}", v)  # 
+00001a20: 6465 6669 6e65 2070 7269 7661 7465 2076  define private v
+00001a30: 6172 6961 626c 6573 2066 726f 6d20 7768  ariables from wh
+00001a40: 6572 6520 7468 6520 7072 6f70 6572 7469  ere the properti
+00001a50: 6573 2067 6574 2074 6865 6972 2076 616c  es get their val
+00001a60: 7565 2066 726f 6d0d 0a0d 0a20 2020 2020  ue from....     
+00001a70: 2020 2023 2073 6574 2067 6976 656e 2076     # set given v
+00001a80: 616c 7565 730d 0a20 2020 2020 2020 2073  alues..        s
+00001a90: 656c 662e 7061 7261 6d73 203d 2067 6976  elf.params = giv
+00001aa0: 656e 0d0a 0d0a 2020 2020 2020 2020 2320  en....        # 
+00001ab0: 5f20 3d20 7365 6c66 2e55 4d52 2020 2320  _ = self.UMR  # 
+00001ac0: 7072 6f70 6572 7479 2027 554d 5227 206c  property 'UMR' l
+00001ad0: 6f67 7320 7761 726e 696e 6720 6966 206e  ogs warning if n
+00001ae0: 6563 6573 7361 7279 0d0a 0d0a 2020 2020  ecessary....    
+00001af0: 6465 6620 5f5f 6361 6c6c 5f5f 2873 656c  def __call__(sel
+00001b00: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
+00001b10: 6773 2920 2d3e 206e 702e 6e64 6172 7261  gs) -> np.ndarra
+00001b20: 793a 0d0a 2020 2020 2020 2020 7265 7475  y:..        retu
+00001b30: 726e 2073 656c 662e 656e 636f 6465 282a  rn self.encode(*
+00001b40: 6172 6773 2c20 2a2a 6b77 6172 6773 290d  args, **kwargs).
+00001b50: 0a0d 0a20 2020 2064 6566 205f 5f67 6574  ...    def __get
+00001b60: 6974 656d 5f5f 2873 656c 662c 2066 7261  item__(self, fra
+00001b70: 6d65 733a 2069 6e74 207c 2074 7570 6c65  mes: int | tuple
+00001b80: 207c 2073 6c69 6365 2920 2d3e 206e 702e   | slice) -> np.
+00001b90: 6e64 6172 7261 793a 0d0a 2020 2020 2020  ndarray:..      
+00001ba0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00001bb0: 6672 616d 6573 2c20 736c 6963 6529 3a0d  frames, slice):.
+00001bc0: 0a20 2020 2020 2020 2020 2020 2066 7261  .            fra
+00001bd0: 6d65 7320 3d20 6e70 2e61 7261 6e67 6528  mes = np.arange(
+00001be0: 7365 6c66 2e54 295b 6672 616d 6573 5d0d  self.T)[frames].
+00001bf0: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
+00001c00: 6e20 7365 6c66 2e65 6e63 6f64 6528 6672  n self.encode(fr
+00001c10: 616d 6573 3d66 7261 6d65 7329 0d0a 0d0a  ames=frames)....
+00001c20: 2020 2020 6465 6620 5f5f 6974 6572 5f5f      def __iter__
+00001c30: 2873 656c 6629 3a0d 0a20 2020 2020 2020  (self):..       
+00001c40: 2073 656c 662e 5f74 203d 2030 0d0a 2020   self._t = 0..  
+00001c50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00001c60: 660d 0a0d 0a20 2020 2064 6566 205f 5f6e  f....    def __n
+00001c70: 6578 745f 5f28 7365 6c66 2920 2d3e 206e  ext__(self) -> n
+00001c80: 702e 6e64 6172 7261 793a 0d0a 2020 2020  p.ndarray:..    
+00001c90: 2020 2020 6966 2073 656c 662e 5f74 203c      if self._t <
+00001ca0: 2073 656c 662e 543a 0d0a 2020 2020 2020   self.T:..      
+00001cb0: 2020 2020 2020 4920 3d20 7365 6c66 2e65        I = self.e
+00001cc0: 6e63 6f64 6528 6672 616d 6573 3d73 656c  ncode(frames=sel
+00001cd0: 662e 5f74 290d 0a20 2020 2020 2020 2020  f._t)..         
+00001ce0: 2020 2073 656c 662e 5f74 202b 3d20 310d     self._t += 1.
+00001cf0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00001d00: 7572 6e20 490d 0a20 2020 2020 2020 2065  urn I..        e
+00001d10: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+00001d20: 2020 6465 6c20 7365 6c66 2e5f 740d 0a20    del self._t.. 
+00001d30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00001d40: 2053 746f 7049 7465 7261 7469 6f6e 2829   StopIteration()
+00001d50: 0d0a 0d0a 2020 2020 6465 6620 5f5f 6c65  ....    def __le
+00001d60: 6e5f 5f28 7365 6c66 2920 2d3e 2069 6e74  n__(self) -> int
+00001d70: 3a0d 0a20 2020 2020 2020 2022 2222 4e75  :..        """Nu
+00001d80: 6d62 6572 206f 6620 6672 616d 6573 2e22  mber of frames."
+00001d90: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
+00001da0: 726e 2073 656c 662e 540d 0a0d 0a20 2020  rn self.T....   
+00001db0: 2064 6566 205f 5f65 715f 5f28 7365 6c66   def __eq__(self
+00001dc0: 2c20 6f74 6865 7229 202d 3e20 626f 6f6c  , other) -> bool
+00001dd0: 3a0d 0a20 2020 2020 2020 2072 6574 7572  :..        retur
+00001de0: 6e20 6861 7361 7474 7228 6f74 6865 722c  n hasattr(other,
+00001df0: 2022 7061 7261 6d73 2229 2061 6e64 2073   "params") and s
+00001e00: 656c 662e 7061 7261 6d73 203d 3d20 6f74  elf.params == ot
+00001e10: 6865 722e 7061 7261 6d73 0d0a 0d0a 2020  her.params....  
+00001e20: 2020 6465 6620 5f5f 636f 6e74 6169 6e73    def __contains
+00001e30: 5f5f 2873 656c 662c 2069 7465 6d29 3a0d  __(self, item):.
+00001e40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001e50: 6974 656d 2069 6e20 7365 6c66 2e70 726f  item in self.pro
+00001e60: 7065 7274 6965 730d 0a0d 0a20 2020 2064  perties....    d
+00001e70: 6566 205f 5f73 7472 5f5f 2873 656c 6629  ef __str__(self)
+00001e80: 202d 3e20 7374 723a 0d0a 2020 2020 2020   -> str:..      
+00001e90: 2020 7265 7475 726e 2073 656c 662e 5f5f    return self.__
+00001ea0: 6e61 6d65 5f5f 0d0a 0d0a 2020 2020 6465  name__....    de
+00001eb0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00001ec0: 202d 3e20 7374 723a 0d0a 2020 2020 2020   -> str:..      
+00001ed0: 2020 7265 7475 726e 2066 227b 7365 6c66    return f"{self
+00001ee0: 2e70 6172 616d 737d 220d 0a0d 0a20 2020  .params}"....   
+00001ef0: 2064 6566 206c 6f61 6428 7365 6c66 2c20   def load(self, 
+00001f00: 666e 616d 653a 2073 7472 203d 204e 6f6e  fname: str = Non
+00001f10: 6529 202d 3e20 6469 6374 3a0d 0a20 2020  e) -> dict:..   
+00001f20: 2020 2020 2022 2222 4c6f 6164 2070 6172       """Load par
+00001f30: 616d 6574 6572 7320 6672 6f6d 2061 2063  ameters from a c
+00001f40: 6f6e 6669 6720 6669 6c65 2074 6f20 7468  onfig file to th
+00001f50: 6520 6046 7269 6e67 6573 6020 696e 7374  e `Fringes` inst
+00001f60: 616e 6365 2e0d 0a0d 0a20 2020 2020 2020  ance.....       
+00001f70: 202e 2e20 7761 726e 696e 673a 3a20 5468   .. warning:: Th
+00001f80: 6520 7061 7261 6d65 7465 7273 2061 7265  e parameters are
+00001f90: 206f 6e6c 7920 6c6f 6164 6564 2069 6620   only loaded if 
+00001fa0: 7468 6520 636f 6e66 6967 2066 696c 6520  the config file 
+00001fb0: 7072 6f76 6964 6573 2074 6865 2073 6563  provides the sec
+00001fc0: 7469 6f6e 2060 6672 696e 6765 7360 2e0d  tion `fringes`..
+00001fd0: 0a0d 0a20 2020 2020 2020 2050 6172 616d  ...        Param
+00001fe0: 6574 6572 730d 0a20 2020 2020 2020 202d  eters..        -
+00001ff0: 2d2d 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020  ---------..     
+00002000: 2020 2066 6e61 6d65 203a 2073 7472 2c20     fname : str, 
+00002010: 6f70 7469 6f6e 616c 0d0a 2020 2020 2020  optional..      
+00002020: 2020 2020 2020 4669 6c65 206e 616d 6520        File name 
+00002030: 6f66 2074 6865 2066 696c 6520 746f 206c  of the file to l
+00002040: 6f61 642e 0d0a 2020 2020 2020 2020 2020  oad...          
+00002050: 2020 5375 7070 6f72 7465 6420 6669 6c65    Supported file
+00002060: 2066 6f72 6d61 7473 2061 7265 3a20 2a2e   formats are: *.
+00002070: 6a73 6f6e 2c20 2a2e 7961 6d6c 2c20 2a2e  json, *.yaml, *.
+00002080: 746f 6d6c 2e0d 0a20 2020 2020 2020 2020  toml...         
+00002090: 2020 2049 6620 6066 6e61 6d65 6020 6973     If `fname` is
+000020a0: 206e 6f74 2070 726f 7669 6465 642c 2074   not provided, t
+000020b0: 6865 2066 696c 6520 602e 6672 696e 6765  he file `.fringe
+000020c0: 732e 7961 6d6c 6020 7769 7468 696e 2074  s.yaml` within t
+000020d0: 6865 2075 7365 7220 686f 6d65 2064 6972  he user home dir
+000020e0: 6563 746f 7279 2069 7320 6c6f 6164 6564  ectory is loaded
+000020f0: 2e0d 0a0d 0a20 2020 2020 2020 2052 6574  .....        Ret
+00002100: 7572 6e73 0d0a 2020 2020 2020 2020 2d2d  urns..        --
+00002110: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2070  -----..        p
+00002120: 6172 616d 7320 3a20 6469 6374 0d0a 2020  arams : dict..  
+00002130: 2020 2020 2020 2020 2020 5468 6520 6c6f            The lo
+00002140: 6164 6564 2070 6172 616d 6574 6572 7320  aded parameters 
+00002150: 6173 2061 2064 6963 7469 6f6e 6172 792e  as a dictionary.
+00002160: 0d0a 2020 2020 2020 2020 2020 2020 6070  ..            `p
+00002170: 6172 616d 7360 206d 6179 2062 6520 656d  arams` may be em
+00002180: 7074 792e 0d0a 0d0a 2020 2020 2020 2020  pty.....        
+00002190: 4578 616d 706c 6573 0d0a 2020 2020 2020  Examples..      
+000021a0: 2020 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020    --------..    
+000021b0: 2020 2020 3e3e 3e20 696d 706f 7274 206f      >>> import o
+000021c0: 730d 0a20 2020 2020 2020 203e 3e3e 2066  s..        >>> f
+000021d0: 6e61 6d65 203d 206f 732e 7061 7468 2e6a  name = os.path.j
+000021e0: 6f69 6e28 6f73 2e70 6174 682e 6578 7061  oin(os.path.expa
+000021f0: 6e64 7573 6572 2822 7e22 292c 2022 2e66  nduser("~"), ".f
+00002200: 7269 6e67 6573 2e79 616d 6c22 290d 0a0d  ringes.yaml")...
+00002210: 0a20 2020 2020 2020 203e 3e3e 2069 6d70  .        >>> imp
+00002220: 6f72 7420 6672 696e 6765 7320 6173 2066  ort fringes as f
+00002230: 726e 670d 0a20 2020 2020 2020 203e 3e3e  rng..        >>>
+00002240: 2066 203d 2066 726e 672e 4672 696e 6765   f = frng.Fringe
+00002250: 7328 290d 0a0d 0a20 2020 2020 2020 203e  s()....        >
+00002260: 3e3e 2066 2e6c 6f61 6428 666e 616d 6529  >> f.load(fname)
+00002270: 0d0a 2020 2020 2020 2020 2222 220d 0a0d  ..        """...
+00002280: 0a20 2020 2020 2020 2069 6620 666e 616d  .        if fnam
+00002290: 6520 6973 204e 6f6e 653a 0d0a 2020 2020  e is None:..    
+000022a0: 2020 2020 2020 2020 666e 616d 6520 3d20          fname = 
+000022b0: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
+000022c0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+000022d0: 227e 2229 2c20 222e 6672 696e 6765 732e  "~"), ".fringes.
+000022e0: 7961 6d6c 2229 0d0a 0d0a 2020 2020 2020  yaml")....      
+000022f0: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
+00002300: 2e69 7366 696c 6528 666e 616d 6529 3a0d  .isfile(fname):.
+00002310: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00002320: 6769 6e67 2e65 7272 6f72 2866 2246 696c  ging.error(f"Fil
+00002330: 6520 277b 666e 616d 657d 2720 646f 6573  e '{fname}' does
+00002340: 206e 6f74 2065 7869 7374 2e22 290d 0a20   not exist.").. 
+00002350: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00002360: 6e0d 0a0d 0a20 2020 2020 2020 2077 6974  n....        wit
+00002370: 6820 6f70 656e 2866 6e61 6d65 2c20 2272  h open(fname, "r
+00002380: 2229 2061 7320 663a 0d0a 2020 2020 2020  ") as f:..      
+00002390: 2020 2020 2020 6578 7420 3d20 6f73 2e70        ext = os.p
+000023a0: 6174 682e 7370 6c69 7465 7874 2866 6e61  ath.splitext(fna
+000023b0: 6d65 295b 2d31 5d0d 0a0d 0a20 2020 2020  me)[-1]....     
+000023c0: 2020 2020 2020 2069 6620 6578 7420 3d3d         if ext ==
+000023d0: 2022 2e6a 736f 6e22 3a0d 0a20 2020 2020   ".json":..     
+000023e0: 2020 2020 2020 2020 2020 2070 203d 206a             p = j
+000023f0: 736f 6e2e 6c6f 6164 2866 290d 0a20 2020  son.load(f)..   
+00002400: 2020 2020 2020 2020 2065 6c69 6620 6578           elif ex
+00002410: 7420 3d3d 2022 2e79 616d 6c22 3a0d 0a20  t == ".yaml":.. 
+00002420: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00002430: 203d 2079 616d 6c2e 7361 6665 5f6c 6f61   = yaml.safe_loa
+00002440: 6428 6629 0d0a 2020 2020 2020 2020 2020  d(f)..          
+00002450: 2020 656c 6966 2065 7874 203d 3d20 222e    elif ext == ".
+00002460: 746f 6d6c 223a 0d0a 2020 2020 2020 2020  toml":..        
+00002470: 2020 2020 2020 2020 7020 3d20 746f 6d6c          p = toml
+00002480: 2e6c 6f61 6428 6629 0d0a 2020 2020 2020  .load(f)..      
+00002490: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+000024a0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000024b0: 6769 6e67 2e65 7272 6f72 2866 2255 6e6b  ging.error(f"Unk
+000024c0: 6e6f 776e 2066 696c 6520 7479 7065 2027  nown file type '
+000024d0: 7b65 7874 7d27 2e22 290d 0a20 2020 2020  {ext}'.")..     
+000024e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000024f0: 6e20 7b7d 0d0a 0d0a 2020 2020 2020 2020  n {}....        
+00002500: 6966 2022 6672 696e 6765 7322 2069 6e20  if "fringes" in 
+00002510: 703a 0d0a 2020 2020 2020 2020 2020 2020  p:..            
+00002520: 7061 7261 6d73 203d 2070 5b22 6672 696e  params = p["frin
+00002530: 6765 7322 5d0d 0a20 2020 2020 2020 2020  ges"]..         
+00002540: 2020 2073 656c 662e 7061 7261 6d73 203d     self.params =
+00002550: 2070 6172 616d 730d 0a0d 0a20 2020 2020   params....     
+00002560: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00002570: 6e66 6f28 6622 4c6f 6164 6564 2070 6172  nfo(f"Loaded par
+00002580: 616d 6574 6572 7320 6672 6f6d 2027 7b66  ameters from '{f
+00002590: 6e61 6d65 7d27 2e22 290d 0a0d 0a20 2020  name}'.")....   
+000025a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000025b0: 7061 7261 6d73 0d0a 2020 2020 2020 2020  params..        
+000025c0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+000025d0: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
+000025e0: 2866 224e 6f20 2766 7269 6e67 6573 2720  (f"No 'fringes' 
+000025f0: 7365 6374 696f 6e20 696e 2066 696c 6520  section in file 
+00002600: 277b 666e 616d 657d 272e 2229 0d0a 2020  '{fname}'.")..  
+00002610: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00002620: 207b 7d0d 0a0d 0a20 2020 2064 6566 2073   {}....    def s
+00002630: 6176 6528 7365 6c66 2c20 666e 616d 653a  ave(self, fname:
+00002640: 2073 7472 203d 204e 6f6e 6529 202d 3e20   str = None) -> 
+00002650: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2022  None:..        "
+00002660: 2222 5361 7665 2074 6865 2070 6172 616d  ""Save the param
+00002670: 6574 6572 7320 6f66 2074 6865 2060 4672  eters of the `Fr
+00002680: 696e 6765 7360 2069 6e73 7461 6e63 6520  inges` instance 
+00002690: 746f 2061 2063 6f6e 6669 6720 6669 6c65  to a config file
+000026a0: 2e0d 0a0d 0a20 2020 2020 2020 2057 6974  .....        Wit
+000026b0: 6869 6e20 7468 6520 6669 6c65 2c20 7468  hin the file, th
+000026c0: 6520 7061 7261 6d65 7465 7273 2061 7265  e parameters are
+000026d0: 2077 7269 7474 656e 2074 6f20 7468 6520   written to the 
+000026e0: 7365 6374 696f 6e20 6066 7269 6e67 6573  section `fringes
+000026f0: 602e 0d0a 0d0a 2020 2020 2020 2020 5061  `.....        Pa
+00002700: 7261 6d65 7465 7273 0d0a 2020 2020 2020  rameters..      
+00002710: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020    ----------..  
+00002720: 2020 2020 2020 666e 616d 6520 3a20 7374        fname : st
+00002730: 722c 206f 7074 696f 6e61 6c0d 0a20 2020  r, optional..   
+00002740: 2020 2020 2020 2020 2046 696c 6520 6e61           File na
+00002750: 6d65 206f 6620 7468 6520 6669 6c65 2074  me of the file t
+00002760: 6f20 7361 7665 2e0d 0a20 2020 2020 2020  o save...       
+00002770: 2020 2020 2053 7570 706f 7274 6564 2066       Supported f
+00002780: 696c 6520 666f 726d 6174 7320 6172 653a  ile formats are:
+00002790: 202a 2e6a 736f 6e2c 202a 2e79 616d 6c2c   *.json, *.yaml,
+000027a0: 202a 2e74 6f6d 6c2e 0d0a 2020 2020 2020   *.toml...      
+000027b0: 2020 2020 2020 4966 2060 666e 616d 6560        If `fname`
+000027c0: 2069 7320 6e6f 7420 7072 6f76 6964 6564   is not provided
+000027d0: 2c20 7468 6520 7061 7261 6d65 7465 7273  , the parameters
+000027e0: 2061 7265 2073 6176 6564 2074 6f0d 0a20   are saved to.. 
+000027f0: 2020 2020 2020 2020 2020 2074 6865 2066             the f
+00002800: 696c 6520 602e 6672 696e 6765 732e 7961  ile `.fringes.ya
+00002810: 6d6c 6020 7769 7468 696e 2074 6865 2075  ml` within the u
+00002820: 7365 7220 686f 6d65 2064 6972 6563 746f  ser home directo
+00002830: 7279 2e0d 0a0d 0a20 2020 2020 2020 2045  ry.....        E
+00002840: 7861 6d70 6c65 730d 0a20 2020 2020 2020  xamples..       
+00002850: 202d 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020   --------..     
+00002860: 2020 203e 3e3e 2069 6d70 6f72 7420 6f73     >>> import os
+00002870: 0d0a 2020 2020 2020 2020 3e3e 3e20 666e  ..        >>> fn
+00002880: 616d 6520 3d20 6f73 2e70 6174 682e 6a6f  ame = os.path.jo
+00002890: 696e 286f 732e 7061 7468 2e65 7870 616e  in(os.path.expan
+000028a0: 6475 7365 7228 227e 2229 2c20 222e 6672  duser("~"), ".fr
+000028b0: 696e 6765 732e 7961 6d6c 2229 0d0a 0d0a  inges.yaml")....
+000028c0: 2020 2020 2020 2020 3e3e 3e20 696d 706f          >>> impo
+000028d0: 7274 2066 7269 6e67 6573 2061 7320 6672  rt fringes as fr
+000028e0: 6e67 0d0a 2020 2020 2020 2020 3e3e 3e20  ng..        >>> 
+000028f0: 6620 3d20 6672 6e67 2e46 7269 6e67 6573  f = frng.Fringes
+00002900: 2829 0d0a 0d0a 2020 2020 2020 2020 3e3e  ()....        >>
+00002910: 3e20 662e 7361 7665 2866 6e61 6d65 290d  > f.save(fname).
+00002920: 0a20 2020 2020 2020 2022 2222 0d0a 0d0a  .        """....
+00002930: 2020 2020 2020 2020 6966 2066 6e61 6d65          if fname
+00002940: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+00002950: 2020 2020 2020 2066 6e61 6d65 203d 206f         fname = o
+00002960: 732e 7061 7468 2e6a 6f69 6e28 6f73 2e70  s.path.join(os.p
+00002970: 6174 682e 6578 7061 6e64 7573 6572 2822  ath.expanduser("
+00002980: 7e22 292c 2022 2e66 7269 6e67 6573 2e79  ~"), ".fringes.y
+00002990: 616d 6c22 290d 0a0d 0a20 2020 2020 2020  aml")....       
+000029a0: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
+000029b0: 6973 6469 7228 6f73 2e70 6174 682e 6469  isdir(os.path.di
+000029c0: 726e 616d 6528 666e 616d 6529 293a 0d0a  rname(fname)):..
+000029d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000029e0: 696e 672e 7761 726e 696e 6728 6622 4669  ing.warning(f"Fi
+000029f0: 6c65 2064 6972 6563 746f 7279 2064 6f65  le directory doe
+00002a00: 7320 6e6f 7420 6578 6973 742e 2229 0d0a  s not exist.")..
+00002a10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00002a20: 726e 0d0a 0d0a 2020 2020 2020 2020 6e61  rn....        na
+00002a30: 6d65 2c20 6578 7420 3d20 6f73 2e70 6174  me, ext = os.pat
+00002a40: 682e 7370 6c69 7465 7874 2866 6e61 6d65  h.splitext(fname
+00002a50: 290d 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00002a60: 7420 6578 743a 0d0a 2020 2020 2020 2020  t ext:..        
+00002a70: 2020 2020 6e61 6d65 2c20 6578 7420 3d20      name, ext = 
+00002a80: 6578 742c 206e 616d 650d 0a0d 0a20 2020  ext, name....   
+00002a90: 2020 2020 2069 6620 6578 7420 6e6f 7420       if ext not 
+00002aa0: 696e 2073 656c 662e 5f6c 6f61 6465 722e  in self._loader.
+00002ab0: 6b65 7973 2829 3a0d 0a20 2020 2020 2020  keys():..       
+00002ac0: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
+00002ad0: 6e69 6e67 2866 2246 696c 6520 6578 7465  ning(f"File exte
+00002ae0: 6e73 696f 6e20 6973 2075 6e6b 6e6f 776e  nsion is unknown
+00002af0: 2e20 4d75 7374 2062 6520 6f6e 6520 6f66  . Must be one of
+00002b00: 207b 7365 6c66 2e5f 6c6f 6164 6572 732e   {self._loaders.
+00002b10: 6b65 7973 2829 7d22 290d 0a20 2020 2020  keys()}")..     
+00002b20: 2020 2020 2020 2072 6574 7572 6e0d 0a0d         return...
+00002b30: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
+00002b40: 656e 2866 6e61 6d65 2c20 2277 2229 2061  en(fname, "w") a
+00002b50: 7320 663a 0d0a 2020 2020 2020 2020 2020  s f:..          
+00002b60: 2020 6966 2065 7874 203d 3d20 222e 6a73    if ext == ".js
+00002b70: 6f6e 223a 0d0a 2020 2020 2020 2020 2020  on":..          
+00002b80: 2020 2020 2020 6a73 6f6e 2e64 756d 7028        json.dump(
+00002b90: 7b22 6672 696e 6765 7322 3a20 7365 6c66  {"fringes": self
+00002ba0: 2e70 6172 616d 737d 2c20 662c 2069 6e64  .params}, f, ind
+00002bb0: 656e 743d 3429 0d0a 2020 2020 2020 2020  ent=4)..        
+00002bc0: 2020 2020 656c 6966 2065 7874 203d 3d20      elif ext == 
+00002bd0: 222e 7961 6d6c 223a 0d0a 2020 2020 2020  ".yaml":..      
+00002be0: 2020 2020 2020 2020 2020 7961 6d6c 2e64            yaml.d
+00002bf0: 756d 7028 7b22 6672 696e 6765 7322 3a20  ump({"fringes": 
+00002c00: 7365 6c66 2e70 6172 616d 737d 2c20 6629  self.params}, f)
+00002c10: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00002c20: 6966 2065 7874 203d 3d20 222e 746f 6d6c  if ext == ".toml
+00002c30: 223a 0d0a 2020 2020 2020 2020 2020 2020  ":..            
+00002c40: 2020 2020 746f 6d6c 2e64 756d 7028 7b22      toml.dump({"
+00002c50: 6672 696e 6765 7322 3a20 7365 6c66 2e70  fringes": self.p
+00002c60: 6172 616d 737d 2c20 6629 0d0a 0d0a 2020  arams}, f)....  
+00002c70: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00002c80: 6275 6728 6622 5361 7665 6420 7061 7261  bug(f"Saved para
+00002c90: 6d65 7465 7273 2074 6f20 7b66 6e61 6d65  meters to {fname
+00002ca0: 7d2e 2229 2020 2320 746f 646f 3a20 696e  }.")  # todo: in
+00002cb0: 666f 3f0d 0a0d 0a20 2020 2064 6566 2072  fo?....    def r
+00002cc0: 6573 6574 2873 656c 6629 202d 3e20 4e6f  eset(self) -> No
+00002cd0: 6e65 3a0d 0a20 2020 2020 2020 2022 2222  ne:..        """
+00002ce0: 5265 7365 7420 7061 7261 6d65 7465 7273  Reset parameters
+00002cf0: 206f 6620 7468 6520 6046 7269 6e67 6573   of the `Fringes
+00002d00: 6020 696e 7374 616e 6365 2074 6f20 6465  ` instance to de
+00002d10: 6661 756c 7420 7661 6c75 6573 2e22 2222  fault values."""
+00002d20: 0d0a 0d0a 2020 2020 2020 2020 7365 6c66  ....        self
+00002d30: 2e70 6172 616d 7320 3d20 7365 6c66 2e64  .params = self.d
+00002d40: 6566 6175 6c74 730d 0a20 2020 2020 2020  efaults..       
+00002d50: 206c 6f67 6769 6e67 2e69 6e66 6f28 2252   logging.info("R
+00002d60: 6573 6574 2070 6172 616d 6574 6572 7320  eset parameters 
+00002d70: 746f 2064 6566 6175 6c74 732e 2229 0d0a  to defaults.")..
+00002d80: 0d0a 2020 2020 6465 6620 6f70 7469 6d69  ..    def optimi
+00002d90: 7a65 2873 656c 662c 2054 3a20 696e 7420  ze(self, T: int 
+00002da0: 3d20 4e6f 6e65 2c20 756d 6178 3a20 666c  = None, umax: fl
+00002db0: 6f61 7420 3d20 4e6f 6e65 2920 2d3e 204e  oat = None) -> N
+00002dc0: 6f6e 653a 2020 2320 746f 646f 3a20 7365  one:  # todo: se
+00002dd0: 6c66 2e75 6d61 780d 0a20 2020 2020 2020  lf.umax..       
+00002de0: 2022 2222 4f70 7469 6d69 7a65 2074 6865   """Optimize the
+00002df0: 2070 6172 616d 6574 6572 7320 6f66 2074   parameters of t
+00002e00: 6865 2060 4672 696e 6765 7360 2069 6e73  he `Fringes` ins
+00002e10: 7461 6e63 652e 0d0a 0d0a 2020 2020 2020  tance.....      
+00002e20: 2020 5061 7261 6d65 7465 7273 0d0a 2020    Parameters..  
+00002e30: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
+00002e40: 0d0a 2020 2020 2020 2020 2054 203a 2069  ..         T : i
+00002e50: 6e74 2c20 6f70 7469 6f6e 616c 0d0a 2020  nt, optional..  
+00002e60: 2020 2020 2020 2020 2020 4e75 6d62 6572            Number
+00002e70: 206f 6620 6672 616d 6573 2e0d 0a20 2020   of frames...   
+00002e80: 2020 2020 2020 2020 2049 6620 6054 6020           If `T` 
+00002e90: 6973 206e 6f74 2070 726f 7669 6465 642c  is not provided,
+00002ea0: 2074 6865 206e 756d 6265 7220 6f66 2066   the number of f
+00002eb0: 7261 6d65 7320 6672 6f6d 2074 6865 2060  rames from the `
+00002ec0: 4672 696e 6765 7360 2069 6e73 7461 6e63  Fringes` instanc
+00002ed0: 6520 6973 2075 7365 642e 0d0a 2020 2020  e is used...    
+00002ee0: 2020 2020 2020 2020 5468 656e 2c20 7468          Then, th
+00002ef0: 6520 6046 7269 6e67 6573 6020 696e 7374  e `Fringes` inst
+00002f00: 616e 6365 2773 206e 756d 6265 7220 6f66  ance's number of
+00002f10: 2073 6869 6674 7320 604e 6020 6973 2064   shifts `N` is d
+00002f20: 6973 7472 6962 7574 6564 206f 7074 696d  istributed optim
+00002f30: 616c 6c79 206f 7665 7220 7468 6520 6469  ally over the di
+00002f40: 7265 6374 696f 6e73 2061 6e64 2073 6574  rections and set
+00002f50: 732e 0d0a 0d0a 2020 2020 2020 2020 2075  s.....         u
+00002f60: 6d61 7820 3a20 666c 6f61 742c 206f 7074  max : float, opt
+00002f70: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
+00002f80: 2020 204d 6178 696d 756d 2061 6c6c 6f77     Maximum allow
+00002f90: 6162 6c65 2075 6e63 6572 7461 696e 7479  able uncertainty
+00002fa0: 2e0d 0a20 2020 2020 2020 2020 2020 204d  ...            M
+00002fb0: 7573 7420 6265 2067 7265 6174 6572 2074  ust be greater t
+00002fc0: 6861 6e20 7a65 726f 2e0d 0a0d 0a20 2020  han zero.....   
+00002fd0: 2020 2020 204e 6f74 6573 0d0a 2020 2020       Notes..    
+00002fe0: 2020 2020 2d2d 2d2d 2d0d 0a20 2020 2020      -----..     
+00002ff0: 2020 2049 6620 6075 6d61 7860 2069 7320     If `umax` is 
+00003000: 7370 6563 6966 6965 642c 2074 6865 2070  specified, the p
+00003010: 6172 616d 6574 6572 7320 6172 6520 6465  arameters are de
+00003020: 7465 726d 696e 6564 0d0a 2020 2020 2020  termined..      
+00003030: 2020 7468 6174 2061 6c6c 6f77 2061 206d    that allow a m
+00003040: 6178 696d 616c 2075 6e63 6572 7461 696e  aximal uncertain
+00003050: 7479 206f 6620 6075 6d61 7860 0d0a 2020  ty of `umax`..  
+00003060: 2020 2020 2020 7769 7468 2061 206d 696e        with a min
+00003070: 696d 756d 206e 756d 6265 7220 6f66 2066  imum number of f
+00003080: 7261 6d65 732e 0d0a 0d0a 2020 2020 2020  rames.....      
+00003090: 2020 456c 7365 2c20 7468 6520 7061 7261    Else, the para
+000030a0: 6d65 7465 7273 206f 6620 7468 6520 6046  meters of the `F
+000030b0: 7269 6e67 6573 6020 696e 7374 616e 6365  ringes` instance
+000030c0: 2061 7265 206f 7074 696d 697a 6564 2074   are optimized t
+000030d0: 6f20 7969 656c 6420 7468 6520 6d69 6e69  o yield the mini
+000030e0: 6d61 6c20 756e 6365 7274 6169 6e74 790d  mal uncertainty.
+000030f0: 0a20 2020 2020 2020 2075 7369 6e67 2074  .        using t
+00003100: 6865 2067 6976 656e 206e 756d 6265 7220  he given number 
+00003110: 6f66 2066 7261 6d65 7320 6054 602e 0d0a  of frames `T`...
+00003120: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
+00003130: 2020 2020 2020 204b 203d 206e 702e 6c6f         K = np.lo
+00003140: 6728 7365 6c66 2e4c 2920 2f20 6e70 2e6c  g(self.L) / np.l
+00003150: 6f67 2873 656c 662e 6c6f 7074 2920 2023  og(self.lopt)  #
+00003160: 206c 6f70 7420 2a2a 204b 203d 204c 0d0a   lopt ** K = L..
+00003170: 2020 2020 2020 2020 4b20 3d20 6e70 2e63          K = np.c
+00003180: 6569 6c28 6d61 7828 322c 204b 2929 0d0a  eil(max(2, K))..
+00003190: 2020 2020 2020 2020 7365 6c66 2e4b 203d          self.K =
+000031a0: 204b 0d0a 2020 2020 2020 2020 7365 6c66   K..        self
+000031b0: 2e76 203d 2022 6f70 7469 6d61 6c22 0d0a  .v = "optimal"..
+000031c0: 0d0a 2020 2020 2020 2020 6966 2075 6d61  ..        if uma
+000031d0: 7820 6973 206e 6f74 204e 6f6e 653a 2020  x is not None:  
+000031e0: 2320 756d 6178 202d 3e20 540d 0a20 2020  # umax -> T..   
+000031f0: 2020 2020 2020 2020 2073 656c 662e 4e20           self.N 
+00003200: 3d20 696e 7428 6e70 2e6d 6564 6961 6e28  = int(np.median(
+00003210: 7365 6c66 2e4e 2929 2020 2320 6d61 6b65  self.N))  # make
+00003220: 204e 2063 6f6e 7374 2e0d 0a20 2020 2020   N const...     
+00003230: 2020 2020 2020 2061 203d 2073 656c 662e         a = self.
+00003240: 752e 6d61 7828 2920 2f20 756d 6178 0d0a  u.max() / umax..
+00003250: 2020 2020 2020 2020 2020 2020 4e20 3d20              N = 
+00003260: 7365 6c66 2e4e 202a 2061 2a2a 320d 0a20  self.N * a**2.. 
+00003270: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003280: 4e20 3d20 6e70 2e6d 6178 696d 756d 2833  N = np.maximum(3
+00003290: 2c20 6e70 2e63 6569 6c28 4e29 290d 0a0d  , np.ceil(N))...
+000032a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000032b0: 7365 6c66 2e75 203e 2075 6d61 783a 0d0a  self.u > umax:..
+000032c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000032d0: 2e2e 2e20 2023 2074 6f64 6f3a 2063 6865  ...  # todo: che
+000032e0: 636b 2069 6620 756d 6178 2069 7320 7265  ck if umax is re
+000032f0: 6163 6865 640d 0a20 2020 2020 2020 2065  ached..        e
+00003300: 6c73 653a 2020 2320 5420 2d3e 2075 0d0a  lse:  # T -> u..
+00003310: 2020 2020 2020 2020 2020 2020 6966 2054              if T
+00003320: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+00003330: 2020 2020 2020 2020 2020 2054 203d 2073             T = s
+00003340: 656c 662e 540d 0a0d 0a20 2020 2020 2020  elf.T....       
+00003350: 2020 2020 2073 656c 662e 5420 3d20 5420       self.T = T 
+00003360: 2023 2064 6973 7472 6962 7574 6520 6672   # distribute fr
+00003370: 616d 6573 206f 7074 696d 616c 6c79 2028  ames optimally (
+00003380: 6576 656e 6c79 2920 6f6e 2073 6869 6674  evenly) on shift
+00003390: 730d 0a0d 0a20 2020 2020 2020 206c 6f67  s....        log
+000033a0: 6769 6e67 2e69 6e66 6f28 224f 7074 696d  ging.info("Optim
+000033b0: 697a 6564 2070 6172 616d 6574 6572 732e  ized parameters.
+000033c0: 2229 0d0a 0d0a 2020 2020 4073 7461 7469  ")....    @stati
+000033d0: 636d 6574 686f 640d 0a20 2020 2064 6566  cmethod..    def
+000033e0: 2067 616d 6d61 5f61 7574 6f5f 636f 7272   gamma_auto_corr
+000033f0: 6563 7428 493a 206e 702e 6e64 6172 7261  ect(I: np.ndarra
+00003400: 7929 202d 3e20 6e70 2e6e 6461 7272 6179  y) -> np.ndarray
+00003410: 3a0d 0a20 2020 2020 2020 2022 2222 4175  :..        """Au
+00003420: 746f 6d61 7469 6361 6c6c 7920 6573 7469  tomatically esti
+00003430: 6d61 7465 2061 6e64 2061 7070 6c79 2074  mate and apply t
+00003440: 6865 2067 616d 6d61 2063 6f72 7265 6374  he gamma correct
+00003450: 696f 6e20 6661 6374 6f72 0d0a 2020 2020  ion factor..    
+00003460: 2020 2020 746f 206c 696e 6561 7269 7a65      to linearize
+00003470: 2074 6865 2064 6973 706c 6179 2f63 616d   the display/cam
+00003480: 6572 6120 7265 7370 6f6e 7365 2063 7572  era response cur
+00003490: 7665 2e0d 0a0d 0a20 2020 2020 2020 2050  ve.....        P
+000034a0: 6172 616d 6574 6572 730d 0a20 2020 2020  arameters..     
+000034b0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0d 0a20     ----------.. 
+000034c0: 2020 2020 2020 2049 203a 206e 702e 6e64         I : np.nd
+000034d0: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
+000034e0: 2020 2052 6563 6f72 6465 6420 6461 7461     Recorded data
+000034f0: 2e0d 0a0d 0a20 2020 2020 2020 2052 6574  .....        Ret
+00003500: 7572 6e73 0d0a 2020 2020 2020 2020 2d2d  urns..        --
+00003510: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 204a  -----..        J
+00003520: 203a 206e 702e 6e64 6172 7261 790d 0a20   : np.ndarray.. 
+00003530: 2020 2020 2020 2020 2020 204c 696e 6561             Linea
+00003540: 7269 7a65 6420 6461 7461 2e0d 0a20 2020  rized data...   
+00003550: 2020 2020 2022 2222 0d0a 0d0a 2020 2020       """....    
+00003560: 2020 2020 2320 6e6f 726d 616c 697a 6520      # normalize 
+00003570: 746f 205b 302c 2031 5d0d 0a20 2020 2020  to [0, 1]..     
+00003580: 2020 2049 6d61 7820 3d20 6e70 2e69 696e     Imax = np.iin
+00003590: 666f 2849 2e64 7479 7065 292e 6d61 7820  fo(I.dtype).max 
+000035a0: 6966 2049 2e64 7479 7065 2e6b 696e 6420  if I.dtype.kind 
+000035b0: 696e 2022 7569 2220 656c 7365 2031 0d0a  in "ui" else 1..
+000035c0: 2020 2020 2020 2020 4a20 3d20 4920 2f20          J = I / 
+000035d0: 496d 6178 0d0a 0d0a 2020 2020 2020 2020  Imax....        
+000035e0: 2320 6573 7469 6d61 7465 2067 616d 6d61  # estimate gamma
+000035f0: 2063 6f72 7265 6374 696f 6e20 6661 6374   correction fact
+00003600: 6f72 0d0a 2020 2020 2020 2020 6d65 6420  or..        med 
+00003610: 3d20 6e70 2e6e 616e 6d65 6469 616e 284a  = np.nanmedian(J
+00003620: 2920 2023 204d 6564 6961 6e20 6973 2061  )  # Median is a
+00003630: 2072 6f62 7573 7420 6573 7469 6d61 746f   robust estimato
+00003640: 7220 666f 7220 7468 6520 6d65 616e 2e0d  r for the mean..
+00003650: 0a20 2020 2020 2020 2067 616d 6d61 203d  .        gamma =
+00003660: 206e 702e 6c6f 6728 6d65 6429 202f 206e   np.log(med) / n
+00003670: 702e 6c6f 6728 302e 3529 0d0a 2020 2020  p.log(0.5)..    
+00003680: 2020 2020 696e 765f 6761 6d6d 6120 3d20      inv_gamma = 
+00003690: 3120 2f20 6761 6d6d 610d 0a0d 0a20 2020  1 / gamma....   
+000036a0: 2020 2020 2023 2061 7070 6c79 2069 6e76       # apply inv
+000036b0: 6572 7365 2067 616d 6d61 0d0a 2020 2020  erse gamma..    
+000036c0: 2020 2020 2320 7461 626c 6520 3d20 6e70      # table = np
+000036d0: 2e61 7272 6179 285b 2828 6720 2f20 7365  .array([((g / se
+000036e0: 6c66 2e49 6d61 7829 202a 2a20 696e 7647  lf.Imax) ** invG
+000036f0: 616d 6d61 2920 2a20 7365 6c66 2e49 6d61  amma) * self.Ima
+00003700: 7820 666f 7220 6720 696e 2072 616e 6765  x for g in range
+00003710: 2873 656c 662e 496d 6178 202b 2031 295d  (self.Imax + 1)]
+00003720: 2c20 7365 6c66 2e64 7479 7065 290d 0a20  , self.dtype).. 
+00003730: 2020 2020 2020 2023 204a 203d 2063 7632         # J = cv2
+00003740: 2e4c 5554 284a 2c20 7461 626c 6529 0d0a  .LUT(J, table)..
+00003750: 2020 2020 2020 2020 4a20 2a2a 3d20 696e          J **= in
+00003760: 765f 6761 6d6d 610d 0a20 2020 2020 2020  v_gamma..       
+00003770: 204a 202a 3d20 496d 6178 0d0a 0d0a 2020   J *= Imax....  
+00003780: 2020 2020 2020 7265 7475 726e 204a 0d0a        return J..
+00003790: 0d0a 2020 2020 6465 6620 6465 696e 7465  ..    def deinte
+000037a0: 726c 6163 6528 7365 6c66 2c20 493a 206e  rlace(self, I: n
+000037b0: 702e 6e64 6172 7261 7929 202d 3e20 6e70  p.ndarray) -> np
+000037c0: 2e6e 6461 7272 6179 3a0d 0a20 2020 2020  .ndarray:..     
+000037d0: 2020 2022 2222 4465 696e 7465 726c 6163     """Deinterlac
+000037e0: 6520 6672 696e 6765 2070 6174 7465 726e  e fringe pattern
+000037f0: 732e 0d0a 0d0a 2020 2020 2020 2020 5468  s.....        Th
+00003800: 6973 2066 6f72 2066 7269 6e67 6520 7061  is for fringe pa
+00003810: 7474 6572 6e73 0d0a 2020 2020 2020 2020  tterns..        
+00003820: 7768 6963 6820 7765 7265 2061 6371 7569  which were acqui
+00003830: 7265 6420 7769 7468 2061 206c 696e 6520  red with a line 
+00003840: 7363 616e 2063 616d 6572 610d 0a20 2020  scan camera..   
+00003850: 2020 2020 2077 6869 6c65 2065 6163 6820       while each 
+00003860: 6672 616d 6520 6861 7320 6265 656e 2064  frame has been d
+00003870: 6973 706c 6179 6564 2061 6e64 2063 6170  isplayed and cap
+00003880: 7475 7265 640d 0a20 2020 2020 2020 2077  tured..        w
+00003890: 6869 6c65 2074 6865 206f 626a 6563 7420  hile the object 
+000038a0: 7761 7320 6d6f 7669 6e67 2062 7920 6f6e  was moving by on
+000038b0: 6520 7069 7865 6c2e 0d0a 0d0a 2020 2020  e pixel.....    
+000038c0: 2020 2020 5061 7261 6d65 7465 7273 0d0a      Parameters..
+000038d0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000038e0: 2d2d 0d0a 2020 2020 2020 2020 4920 3a20  --..        I : 
+000038f0: 6e70 2e6e 6461 7272 6179 0d0a 2020 2020  np.ndarray..    
+00003900: 2020 2020 2020 2020 4672 696e 6765 2070          Fringe p
+00003910: 6174 7465 726e 2073 6571 7565 6e63 652e  attern sequence.
+00003920: 0d0a 2020 2020 2020 2020 2020 2020 4974  ..            It
+00003930: 2069 7320 7265 7368 6170 6564 2074 6f20   is reshaped to 
+00003940: 7669 6465 6f73 6861 7065 2028 6672 616d  videoshape (fram
+00003950: 6573 2060 5460 2c20 6865 6967 6874 2060  es `T`, height `
+00003960: 5960 2c20 7769 6474 6820 6058 602c 2063  Y`, width `X`, c
+00003970: 6f6c 6f72 2063 6861 6e6e 656c 7320 6043  olor channels `C
+00003980: 6029 2062 6566 6f72 6520 7072 6f63 6573  `) before proces
+00003990: 7369 6e67 2e0d 0a0d 0a20 2020 2020 2020  sing.....       
+000039a0: 2052 6574 7572 6e73 0d0a 2020 2020 2020   Returns..      
+000039b0: 2020 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020    -------..     
+000039c0: 2020 2049 203a 206e 702e 6e64 6172 7261     I : np.ndarra
+000039d0: 790d 0a20 2020 2020 2020 2020 2020 2044  y..            D
+000039e0: 6569 6e74 6572 6c61 6365 6420 6672 696e  einterlaced frin
+000039f0: 6765 2070 6174 7465 726e 2073 6571 7565  ge pattern seque
+00003a00: 6e63 652e 0d0a 0d0a 2020 2020 2020 2020  nce.....        
+00003a10: 5261 6973 6573 0d0a 2020 2020 2020 2020  Raises..        
+00003a20: 2d2d 2d2d 2d2d 0d0a 2020 2020 2020 2020  ------..        
+00003a30: 4173 7365 7274 696f 6e45 7272 6f72 0d0a  AssertionError..
+00003a40: 2020 2020 2020 2020 2020 2020 4966 2074              If t
+00003a50: 6865 206e 756d 6265 7220 6f66 2066 7261  he number of fra
+00003a60: 6d65 7320 6f66 2060 4960 2061 6e64 2074  mes of `I` and t
+00003a70: 6865 2061 7474 7269 6275 7465 2060 5460  he attribute `T`
+00003a80: 206f 6620 7468 6520 6046 7269 6e67 6573   of the `Fringes
+00003a90: 6020 696e 7374 616e 6365 2064 6f6e 2774  ` instance don't
+00003aa0: 206d 6174 6368 2e0d 0a0d 0a20 2020 2020   match.....     
+00003ab0: 2020 2045 7861 6d70 6c65 730d 0a20 2020     Examples..   
+00003ac0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0d 0a20       --------.. 
+00003ad0: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
+00003ae0: 7420 6672 696e 6765 7320 6173 2066 726e  t fringes as frn
+00003af0: 670d 0a20 2020 2020 2020 203e 3e3e 2066  g..        >>> f
+00003b00: 203d 2066 726e 672e 4672 696e 6765 7328   = frng.Fringes(
+00003b10: 290d 0a20 2020 2020 2020 203e 3e3e 2049  )..        >>> I
+00003b20: 203d 2066 2e64 6569 6e74 6572 6c61 6365   = f.deinterlace
+00003b30: 2849 290d 0a20 2020 2020 2020 2022 2222  (I)..        """
+00003b40: 0d0a 0d0a 2020 2020 2020 2020 7430 203d  ....        t0 =
+00003b50: 2074 696d 652e 7065 7266 5f63 6f75 6e74   time.perf_count
+00003b60: 6572 2829 0d0a 0d0a 2020 2020 2020 2020  er()....        
+00003b70: 542c 2059 2c20 582c 2043 203d 2076 7368  T, Y, X, C = vsh
+00003b80: 6170 6528 4929 2e73 6861 7065 0d0a 2020  ape(I).shape..  
+00003b90: 2020 2020 2020 6173 7365 7274 2054 202a        assert T *
+00003ba0: 2059 2025 2073 656c 662e 5420 3d3d 2030   Y % self.T == 0
+00003bb0: 2c20 224e 756d 6265 7220 6f66 2066 7261  , "Number of fra
+00003bc0: 6d65 7320 6f66 2070 6172 616d 6574 6572  mes of parameter
+00003bd0: 7320 616e 6420 6461 7461 2064 6f6e 2774  s and data don't
+00003be0: 206d 6174 6368 2e22 0d0a 0d0a 2020 2020   match."....    
+00003bf0: 2020 2020 2320 4920 3d20 492e 7265 7368      # I = I.resh
+00003c00: 6170 6528 2854 202a 2059 2c20 582c 2043  ape((T * Y, X, C
+00003c10: 2929 2020 2320 636f 6e63 6174 656e 6174  ))  # concatenat
+00003c20: 650d 0a20 2020 2020 2020 2049 203d 2049  e..        I = I
+00003c30: 2e72 6573 6861 7065 2828 2d31 2c20 7365  .reshape((-1, se
+00003c40: 6c66 2e54 2c20 582c 2043 2929 2e73 7761  lf.T, X, C)).swa
+00003c50: 7061 7865 7328 302c 2031 290d 0a0d 0a20  paxes(0, 1).... 
+00003c60: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00003c70: 6e66 6f28 6622 7b31 3030 3020 2a20 2874  nfo(f"{1000 * (t
+00003c80: 696d 652e 7065 7266 5f63 6f75 6e74 6572  ime.perf_counter
+00003c90: 2829 202d 2074 3029 7d6d 7322 290d 0a0d  () - t0)}ms")...
+00003ca0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00003cb0: 490d 0a0d 0a20 2020 2064 6566 2063 6f6f  I....    def coo
+00003cc0: 7264 696e 6174 6573 2873 656c 6629 202d  rdinates(self) -
+00003cd0: 3e20 6e70 2e6e 6461 7272 6179 3a0d 0a20  > np.ndarray:.. 
+00003ce0: 2020 2020 2020 2022 2222 4765 6e65 7261         """Genera
+00003cf0: 7465 2074 6865 2063 6f6f 7264 696e 6174  te the coordinat
+00003d00: 6520 6d61 7472 6963 6573 206f 6620 7468  e matrices of th
+00003d10: 6520 636f 6f72 6469 6e61 7465 2073 7973  e coordinate sys
+00003d20: 7465 6d20 6465 6669 6e65 6420 696e 2060  tem defined in `
+00003d30: 6772 6964 602e 0d0a 0d0a 2020 2020 2020  grid`.....      
+00003d40: 2020 5265 7475 726e 730d 0a20 2020 2020    Returns..     
+00003d50: 2020 202d 2d2d 2d2d 2d2d 0d0a 2020 2020     -------..    
+00003d60: 2020 2020 7869 203a 206e 702e 6e64 6172      xi : np.ndar
+00003d70: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
+00003d80: 2043 6f6f 7264 696e 6174 6520 6d61 7472   Coordinate matr
+00003d90: 6963 6573 2e0d 0a20 2020 2020 2020 2022  ices...        "
+00003da0: 2222 0d0a 0d0a 2020 2020 2020 2020 7430  ""....        t0
+00003db0: 203d 2074 696d 652e 7065 7266 5f63 6f75   = time.perf_cou
+00003dc0: 6e74 6572 2829 0d0a 0d0a 2020 2020 2020  nter()....      
+00003dd0: 2020 7379 7320 3d20 280d 0a20 2020 2020    sys = (..     
+00003de0: 2020 2020 2020 2022 696d 6722 0d0a 2020         "img"..  
+00003df0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00003e00: 662e 6772 6964 203d 3d20 2269 6d61 6765  f.grid == "image
+00003e10: 220d 0a20 2020 2020 2020 2020 2020 2065  "..            e
+00003e20: 6c73 6520 2263 6172 7422 2069 6620 7365  lse "cart" if se
+00003e30: 6c66 2e67 7269 6420 3d3d 2022 4361 7274  lf.grid == "Cart
+00003e40: 6573 6961 6e22 2065 6c73 6520 2270 6f6c  esian" else "pol
+00003e50: 2220 6966 2073 656c 662e 6772 6964 203d  " if self.grid =
+00003e60: 3d20 2270 6f6c 6172 2220 656c 7365 2022  = "polar" else "
+00003e70: 6c6f 6770 6f6c 220d 0a20 2020 2020 2020  logpol"..       
+00003e80: 2029 0d0a 0d0a 2020 2020 2020 2020 7869   )....        xi
+00003e90: 203d 206e 702e 6172 7261 7928 6765 7461   = np.array(geta
+00003ea0: 7474 7228 6772 6964 2c20 7379 7329 2873  ttr(grid, sys)(s
+00003eb0: 656c 662e 592c 2073 656c 662e 582c 2073  elf.Y, self.X, s
+00003ec0: 656c 662e 616e 676c 6529 290d 0a0d 0a20  elf.angle)).... 
+00003ed0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00003ee0: 6e64 6578 696e 6720 3d3d 2022 696a 223a  ndexing == "ij":
+00003ef0: 0d0a 2020 2020 2020 2020 2020 2020 7869  ..            xi
+00003f00: 203d 2078 695b 3a3a 2d31 5d20 2023 2072   = xi[::-1]  # r
+00003f10: 6574 7572 6e73 2061 2076 6965 770d 0a0d  eturns a view...
+00003f20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00003f30: 2e44 203d 3d20 313a 0d0a 2020 2020 2020  .D == 1:..      
+00003f40: 2020 2020 2020 7869 203d 2078 695b 7365        xi = xi[se
+00003f50: 6c66 2e61 7869 735d 5b4e 6f6e 652c 203a  lf.axis][None, :
+00003f60: 2c20 3a5d 2020 2320 7265 7475 726e 7320  , :]  # returns 
+00003f70: 6120 7669 6577 0d0a 0d0a 2020 2020 2020  a view....      
+00003f80: 2020 6966 2073 656c 662e 6772 6964 2069    if self.grid i
+00003f90: 6e20 5b22 706f 6c61 7222 2c20 226c 6f67  n ["polar", "log
+00003fa0: 2d70 6f6c 6172 225d 3a0d 0a20 2020 2020  -polar"]:..     
+00003fb0: 2020 2020 2020 2078 6920 2a3d 2073 656c         xi *= sel
+00003fc0: 662e 4c0d 0a0d 0a20 2020 2020 2020 206c  f.L....        l
+00003fd0: 6f67 6769 6e67 2e69 6e66 6f28 6622 7b31  ogging.info(f"{1
+00003fe0: 3030 3020 2a20 2874 696d 652e 7065 7266  000 * (time.perf
+00003ff0: 5f63 6f75 6e74 6572 2829 202d 2074 3029  _counter() - t0)
+00004000: 7d6d 7322 290d 0a0d 0a20 2020 2020 2020  }ms")....       
+00004010: 2072 6574 7572 6e20 7869 0d0a 0d0a 2020   return xi....  
+00004020: 2020 6465 6620 5f6f 7264 6572 7328 7365    def _orders(se
+00004030: 6c66 2920 2d3e 206e 702e 6e64 6172 7261  lf) -> np.ndarra
+00004040: 793a 0d0a 2020 2020 2020 2020 2222 2247  y:..        """G
+00004050: 656e 6572 6174 6520 6672 696e 6765 206f  enerate fringe o
+00004060: 7264 6572 732e 0d0a 0d0a 2020 2020 2020  rders.....      
+00004070: 2020 5265 7475 726e 730d 0a20 2020 2020    Returns..     
+00004080: 2020 202d 2d2d 2d2d 2d2d 0d0a 2020 2020     -------..    
+00004090: 2020 2020 6b20 3a20 6e70 2e6e 6461 7272      k : np.ndarr
+000040a0: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
+000040b0: 4672 696e 6765 206f 7264 6572 7320 6f66  Fringe orders of
+000040c0: 2074 6865 2065 6e63 6f64 6564 2066 7269   the encoded fri
+000040d0: 6e67 6520 7061 7474 6572 6e20 7365 7175  nge pattern sequ
+000040e0: 656e 6365 2e0d 0a20 2020 2020 2020 2022  ence...        "
+000040f0: 2222 0d0a 0d0a 2020 2020 2020 2020 6b20  ""....        k 
+00004100: 3d20 7365 6c66 2e63 6f6f 7264 696e 6174  = self.coordinat
+00004110: 6573 2829 5b3a 2c20 4e6f 6e65 2c20 3a2c  es()[:, None, :,
+00004120: 203a 2c20 4e6f 6e65 5d20 2f2f 2073 656c   :, None] // sel
+00004130: 662e 5f6c 5b3a 2c20 3a2c 204e 6f6e 652c  f._l[:, :, None,
+00004140: 204e 6f6e 652c 204e 6f6e 655d 0d0a 0d0a   None, None]....
+00004150: 2020 2020 2020 2020 7265 7475 726e 206b          return k
+00004160: 2e72 6573 6861 7065 2873 656c 662e 4420  .reshape(self.D 
+00004170: 2a20 7365 6c66 2e4b 2c20 7365 6c66 2e59  * self.K, self.Y
+00004180: 2c20 7365 6c66 2e58 2c20 7365 6c66 2e43  , self.X, self.C
+00004190: 290d 0a0d 0a20 2020 2064 6566 205f 6d6f  )....    def _mo
+000041a0: 6475 6c61 7465 2873 656c 662c 2078 693a  dulate(self, xi:
+000041b0: 206e 702e 6e64 6172 7261 792c 2066 7261   np.ndarray, fra
+000041c0: 6d65 733a 206e 702e 6e64 6172 7261 792c  mes: np.ndarray,
+000041d0: 2072 696e 743a 2062 6f6f 6c20 3d20 5472   rint: bool = Tr
+000041e0: 7565 2920 2d3e 206e 702e 6e64 6172 7261  ue) -> np.ndarra
+000041f0: 793a 0d0a 2020 2020 2020 2020 2222 2245  y:..        """E
+00004200: 6e63 6f64 6520 6261 7365 2066 7269 6e67  ncode base fring
+00004210: 6520 7061 7474 6572 6e73 2062 7920 7370  e patterns by sp
+00004220: 6174 696f 2d74 656d 706f 7261 6c20 6d6f  atio-temporal mo
+00004230: 6475 6c61 7469 6f6e 2e0d 0a0d 0a20 2020  dulation.....   
+00004240: 2020 2020 2050 6172 616d 6574 6572 730d       Parameters.
+00004250: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00004260: 2d2d 2d0d 0a20 2020 2020 2020 2078 6920  ---..        xi 
+00004270: 3a20 4e6f 6e65 206f 7220 6c69 7374 206f  : None or list o
+00004280: 6620 6172 7261 7973 206f 7220 6f6e 6520  f arrays or one 
+00004290: 6172 7261 7920 6f66 2067 7269 6420 696e  array of grid in
+000042a0: 6469 6365 732c 206f 7074 696f 6e61 6c0d  dices, optional.
+000042b0: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
+000042c0: 7420 6f66 2063 6f6f 7264 696e 6174 6520  t of coordinate 
+000042d0: 6d61 7472 6963 6573 2066 726f 6d20 636f  matrices from co
+000042e0: 6f72 6469 6e61 7465 2076 6563 746f 7273  ordinate vectors
+000042f0: 2069 6e20 4361 7274 6573 6961 6e20 2827   in Cartesian ('
+00004300: 7879 2729 2069 6e64 6578 696e 670d 0a20  xy') indexing.. 
+00004310: 2020 2020 2020 2020 2020 2028 652e 672e             (e.g.
+00004320: 2066 726f 6d20 606e 756d 7079 2e6d 6573   from `numpy.mes
+00004330: 6867 7269 6420 3c68 7474 7073 3a2f 2f6e  hgrid <https://n
+00004340: 756d 7079 2e6f 7267 2f64 6f63 2f73 7461  umpy.org/doc/sta
+00004350: 626c 652f 7265 6665 7265 6e63 652f 6765  ble/reference/ge
+00004360: 6e65 7261 7465 642f 6e75 6d70 792e 6d65  nerated/numpy.me
+00004370: 7368 6772 6964 2e68 746d 6c3e 605f 292e  shgrid.html>`_).
+00004380: 0d0a 2020 2020 2020 2020 2020 2020 5468  ..            Th
+00004390: 6520 6465 6661 756c 7420 6973 2065 7175  e default is equ
+000043a0: 616c 2074 6f20 276e 756d 7079 2e69 6e64  al to 'numpy.ind
+000043b0: 6963 6573 2828 7365 6c66 2e59 2c20 7365  ices((self.Y, se
+000043c0: 6c66 2e58 2929 272e 0d0a 0d0a 2020 2020  lf.X))'.....    
+000043d0: 2020 2020 6672 616d 6573 203a 206e 702e      frames : np.
+000043e0: 6e64 6172 7261 790d 0a20 2020 2020 2020  ndarray..       
+000043f0: 2020 2020 2049 6e64 6963 6573 206f 6620       Indices of 
+00004400: 7468 6520 6672 616d 6573 2074 6f20 6265  the frames to be
+00004410: 2065 6e63 6f64 6564 2e0d 0a0d 0a20 2020   encoded.....   
+00004420: 2020 2020 2072 696e 7420 3a20 626f 6f6c       rint : bool
+00004430: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
+00004440: 2020 2020 2020 2020 4966 2074 6869 7320          If this 
+00004450: 6973 2073 6574 2074 6f20 5472 7565 2028  is set to True (
+00004460: 7468 6520 6465 6661 756c 7429 0d0a 2020  the default)..  
+00004470: 2020 2020 2020 2020 2020 616e 6420 7468            and th
+00004480: 6520 7573 6564 2064 7479 7065 2028 6174  e used dtype (at
+00004490: 7472 6962 7574 6520 6064 7479 7065 6020  tribute `dtype` 
+000044a0: 6f66 2074 6865 2046 7269 6e67 6573 2069  of the Fringes i
+000044b0: 6e73 7461 6e63 6529 2069 7320 6f66 2074  nstance) is of t
+000044c0: 7970 6520 696e 7465 7267 6572 2c0d 0a20  ype interger,.. 
+000044d0: 2020 2020 2020 2020 2020 2074 6865 2065             the e
+000044e0: 6e63 6f64 6564 2070 6174 7465 726e 7320  ncoded patterns 
+000044f0: 7769 6c6c 2062 6520 726f 756e 6465 6420  will be rounded 
+00004500: 746f 2074 6865 206e 6561 7265 7374 2069  to the nearest i
+00004510: 6e74 6567 6572 2e0d 0a20 2020 2020 2020  nteger...       
+00004520: 2020 2020 2049 6620 7468 6973 2069 7320       If this is 
+00004530: 7365 7420 4661 6c73 6520 616e 6420 7468  set False and th
+00004540: 6520 7573 6564 2064 7479 7065 2069 7320  e used dtype is 
+00004550: 6f66 2074 7970 6520 696e 7465 7267 6572  of type interger
+00004560: 2c0d 0a20 2020 2020 2020 2020 2020 2074  ,..            t
+00004570: 6865 2066 7261 6374 696f 6e61 6c20 7061  he fractional pa
+00004580: 7274 206f 6620 7468 6520 656e 636f 6465  rt of the encode
+00004590: 6420 7061 7474 6572 6e73 2077 696c 6c20  d patterns will 
+000045a0: 6265 2064 6973 6361 7264 6564 2e0d 0a0d  be discarded....
+000045b0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+000045c0: 0d0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  ..        ------
+000045d0: 2d0d 0a20 2020 2020 2020 2049 203a 206e  -..        I : n
+000045e0: 702e 6e64 6172 7261 790d 0a20 2020 2020  p.ndarray..     
+000045f0: 2020 2020 2020 2042 6173 6520 6672 696e         Base frin
+00004600: 6765 2070 6174 7465 726e 732e 0d0a 2020  ge patterns...  
+00004610: 2020 2020 2020 2222 220d 0a0d 0a20 2020        """....   
+00004620: 2020 2020 2074 3020 3d20 7469 6d65 2e70       t0 = time.p
+00004630: 6572 665f 636f 756e 7465 7228 290d 0a0d  erf_counter()...
+00004640: 0a20 2020 2020 2020 2066 7261 6d65 7320  .        frames 
+00004650: 3d20 6e70 2e61 7272 6179 286c 6973 7428  = np.array(list(
+00004660: 7365 7428 7420 2520 6e70 2e73 756d 2873  set(t % np.sum(s
+00004670: 656c 662e 5f4e 2920 666f 7220 7420 696e  elf._N) for t in
+00004680: 2066 7261 6d65 7329 2929 2020 2320 6e75   frames)))  # nu
+00004690: 6d70 792e 756e 6971 7565 2072 6574 7572  mpy.unique retur
+000046a0: 6e73 2073 6f72 7465 640d 0a20 2020 2020  ns sorted..     
+000046b0: 2020 2054 203d 206c 656e 2866 7261 6d65     T = len(frame
+000046c0: 7329 0d0a 2020 2020 2020 2020 5920 3d20  s)..        Y = 
+000046d0: 7365 6c66 2e59 2069 6620 7869 2069 7320  self.Y if xi is 
+000046e0: 4e6f 6e65 2065 6c73 6520 7869 2e73 6861  None else xi.sha
+000046f0: 7065 5b31 5d0d 0a20 2020 2020 2020 2058  pe[1]..        X
+00004700: 203d 2073 656c 662e 5820 6966 2078 6920   = self.X if xi 
+00004710: 6973 204e 6f6e 6520 656c 7365 2078 692e  is None else xi.
+00004720: 7368 6170 655b 325d 0d0a 0d0a 2020 2020  shape[2]....    
+00004730: 2020 2020 6973 5f6d 6978 6564 5f63 6f6c      is_mixed_col
+00004740: 6f72 203d 206e 702e 616e 7928 2873 656c  or = np.any((sel
+00004750: 662e 6820 213d 2030 2920 2a20 2873 656c  f.h != 0) * (sel
+00004760: 662e 6820 213d 2032 3535 2929 0d0a 2020  f.h != 255))..  
+00004770: 2020 2020 2020 6474 7970 6520 3d20 6e70        dtype = np
+00004780: 2e64 7479 7065 2822 666c 6f61 7436 3422  .dtype("float64"
+00004790: 2920 6966 2073 656c 662e 5344 4d20 6f72  ) if self.SDM or
+000047a0: 2073 656c 662e 4644 4d20 6f72 2069 735f   self.FDM or is_
+000047b0: 6d69 7865 645f 636f 6c6f 7220 656c 7365  mixed_color else
+000047c0: 2073 656c 662e 6474 7970 650d 0a0d 0a20   self.dtype.... 
+000047d0: 2020 2020 2020 2023 2063 6f6f 7264 696e         # coordin
+000047e0: 6174 6573 0d0a 2020 2020 2020 2020 6966  ates..        if
+000047f0: 2078 6920 6973 204e 6f6e 653a 0d0a 2020   xi is None:..  
+00004800: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00004810: 662e 6772 6964 2021 3d20 2269 6d61 6765  f.grid != "image
+00004820: 2220 6f72 2073 656c 662e 616e 676c 6520  " or self.angle 
+00004830: 213d 2030 3a0d 0a20 2020 2020 2020 2020  != 0:..         
+00004840: 2020 2020 2020 2078 6920 3d20 7365 6c66         xi = self
+00004850: 2e63 6f6f 7264 696e 6174 6573 2829 0d0a  .coordinates()..
+00004860: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00004870: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00004880: 2020 2042 203d 2069 6e74 286e 702e 6365     B = int(np.ce
+00004890: 696c 286e 702e 6c6f 6732 2873 656c 662e  il(np.log2(self.
+000048a0: 522e 6d61 7828 2920 2d20 3129 2929 2020  R.max() - 1)))  
+000048b0: 2320 6e65 7874 2070 6f77 6572 206f 6620  # next power of 
+000048c0: 7477 6f0d 0a20 2020 2020 2020 2020 2020  two..           
+000048d0: 2020 2020 2042 202b 3d20 2d42 2025 2038       B += -B % 8
+000048e0: 2020 2320 6e65 7874 2070 6f77 6572 206f    # next power o
+000048f0: 6620 7477 6f20 6469 7669 7369 626c 6520  f two divisible 
+00004900: 6279 2038 0d0a 2020 2020 2020 2020 2020  by 8..          
+00004910: 2020 2020 2020 7869 203d 206e 702e 696e        xi = np.in
+00004920: 6469 6365 7328 2873 656c 662e 592c 2073  dices((self.Y, s
+00004930: 656c 662e 5829 2c20 6474 7970 653d 6622  elf.X), dtype=f"
+00004940: 7569 6e74 7b42 7d22 2c20 7370 6172 7365  uint{B}", sparse
+00004950: 3d54 7275 6529 0d0a 2020 2020 2020 2020  =True)..        
+00004960: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00004970: 696e 6465 7869 6e67 203d 3d20 2278 7922  indexing == "xy"
+00004980: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00004990: 2020 2020 2020 2078 6920 3d20 7869 5b3a         xi = xi[:
+000049a0: 3a2d 315d 0d0a 2020 2020 2020 2020 2020  :-1]..          
+000049b0: 2020 2020 2020 6966 2073 656c 662e 4420        if self.D 
+000049c0: 3d3d 2031 3a0d 0a20 2020 2020 2020 2020  == 1:..         
+000049d0: 2020 2020 2020 2020 2020 2078 6920 3d20             xi = 
+000049e0: 5b78 695b 7365 6c66 2e61 7869 735d 5d0d  [xi[self.axis]].
+000049f0: 0a0d 0a20 2020 2020 2020 2049 203d 206e  ...        I = n
+00004a00: 702e 656d 7074 7928 5b54 2c20 592c 2058  p.empty([T, Y, X
+00004a10: 5d2c 2064 7479 7065 290d 0a0d 0a20 2020  ], dtype)....   
+00004a20: 2020 2020 2023 204e 6375 6d20 3d20 6e70       # Ncum = np
+00004a30: 2e63 756d 7375 6d28 7365 6c66 2e5f 4e29  .cumsum(self._N)
+00004a40: 2e72 6573 6861 7065 2873 656c 662e 442c  .reshape(self.D,
+00004a50: 2073 656c 662e 4b29 0d0a 2020 2020 2020   self.K)..      
+00004a60: 2020 2320 666f 7220 7420 696e 2066 7261    # for t in fra
+00004a70: 6d65 733a 0d0a 2020 2020 2020 2020 2320  mes:..        # 
+00004a80: 2020 2020 642c 2069 203d 206e 702e 6172      d, i = np.ar
+00004a90: 6777 6865 7265 2874 203c 204e 6375 6d29  gwhere(t < Ncum)
+00004aa0: 5b30 5d0d 0a20 2020 2020 2020 2023 2020  [0]..        #  
+00004ab0: 2020 206e 203d 2074 202d 204e 6375 6d5b     n = t - Ncum[
+00004ac0: 642c 2069 5d20 2b20 7365 6c66 2e5f 4e5b  d, i] + self._N[
+00004ad0: 302c 2030 5d0d 0a20 2020 2020 2020 2023  0, 0]..        #
+00004ae0: 2020 2020 202e 2e2e 0d0a 0d0a 2020 2020       .......    
+00004af0: 2020 2020 6964 7820 3d20 300d 0a20 2020      idx = 0..   
+00004b00: 2020 2020 2066 7261 6d65 203d 2030 0d0a       frame = 0..
+00004b10: 2020 2020 2020 2020 666f 7220 6420 696e          for d in
+00004b20: 2072 616e 6765 2873 656c 662e 4429 3a0d   range(self.D):.
+00004b30: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
+00004b40: 2028 7869 5b64 5d20 2b20 7365 6c66 2e78   (xi[d] + self.x
+00004b50: 3029 202f 2073 656c 662e 4c0d 0a0d 0a20  0) / self.L.... 
+00004b60: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00004b70: 2069 6e20 7261 6e67 6528 7365 6c66 2e4b   in range(self.K
+00004b80: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00004b90: 2020 2020 6b20 3d20 3220 2a20 6e70 2e70      k = 2 * np.p
+00004ba0: 6920 2a20 7365 6c66 2e5f 765b 642c 2069  i * self._v[d, i
+00004bb0: 5d0d 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00004bc0: 2020 2077 203d 2032 202a 206e 702e 7069     w = 2 * np.pi
+00004bd0: 202a 2073 656c 662e 5f66 5b64 2c20 695d   * self._f[d, i]
+00004be0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00004bf0: 2020 2020 6966 2073 656c 662e 7265 7665      if self.reve
+00004c00: 7273 653a 0d0a 2020 2020 2020 2020 2020  rse:..          
+00004c10: 2020 2020 2020 2020 2020 7720 2a3d 202d            w *= -
+00004c20: 310d 0a0d 0a20 2020 2020 2020 2020 2020  1....           
+00004c30: 2020 2020 2066 6f72 206e 2069 6e20 7261       for n in ra
+00004c40: 6e67 6528 7365 6c66 2e5f 4e5b 642c 2069  nge(self._N[d, i
+00004c50: 5d29 3a0d 0a20 2020 2020 2020 2020 2020  ]):..           
+00004c60: 2020 2020 2020 2020 2069 6620 6672 616d           if fram
+00004c70: 6520 696e 2066 7261 6d65 733a 0d0a 2020  e in frames:..  
+00004c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c90: 2020 2020 2020 7420 3d20 6e20 2f20 3420        t = n / 4 
+00004ca0: 6966 2073 656c 662e 5f4e 5b64 2c20 695d  if self._N[d, i]
+00004cb0: 203d 3d20 3220 656c 7365 206e 202f 2073   == 2 else n / s
+00004cc0: 656c 662e 5f4e 5b64 2c20 695d 0d0a 0d0a  elf._N[d, i]....
+00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ce0: 2020 2020 2020 2020 7661 6c20 3d20 7365          val = se
+00004cf0: 6c66 2e49 6d61 7820 2a20 2873 656c 662e  lf.Imax * (self.
+00004d00: 6265 7461 202a 2028 3120 2b20 7365 6c66  beta * (1 + self
+00004d10: 2e56 202a 206e 702e 636f 7328 6b20 2a20  .V * np.cos(k * 
+00004d20: 7820 2d20 7720 2a20 7420 2d20 7365 6c66  x - w * t - self
+00004d30: 2e70 3029 2929 202a 2a20 7365 6c66 2e67  .p0))) ** self.g
+00004d40: 616d 6d61 0d0a 0d0a 2020 2020 2020 2020  amma....        
+00004d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d60: 6966 2064 7479 7065 2e6b 696e 6420 696e  if dtype.kind in
+00004d70: 2022 7569 2220 616e 6420 7269 6e74 3a0d   "ui" and rint:.
+00004d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004d90: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+00004da0: 7269 6e74 2876 616c 2c20 6f75 743d 7661  rint(val, out=va
+00004db0: 6c29 0d0a 2020 2020 2020 2020 2020 2020  l)..            
+00004dc0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00004dd0: 2064 7479 7065 2e6b 696e 6420 696e 2022   dtype.kind in "
+00004de0: 6222 3a0d 0a20 2020 2020 2020 2020 2020  b":..           
 00004df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e00: 2020 2020 495b 6964 785d 203d 2076 616c      I[idx] = val
-00004e10: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00004e20: 2020 2020 2020 2020 2020 2020 6964 7820              idx 
-00004e30: 2b3d 2031 0d0a 2020 2020 2020 2020 2020  += 1..          
-00004e40: 2020 2020 2020 2020 2020 6672 616d 6520            frame 
-00004e50: 2b3d 2031 0d0a 0d0a 2020 2020 2020 2020  += 1....        
-00004e60: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-00004e70: 6728 6622 7b73 6928 7469 6d65 2e70 6572  g(f"{si(time.per
-00004e80: 665f 636f 756e 7465 7228 2920 2d20 7430  f_counter() - t0
-00004e90: 297d 7322 290d 0a0d 0a20 2020 2020 2020  )}s")....       
-00004ea0: 2072 6574 7572 6e20 492e 7265 7368 6170   return I.reshap
-00004eb0: 6528 2d31 2c20 7365 6c66 2e59 2c20 7365  e(-1, self.Y, se
-00004ec0: 6c66 2e58 2c20 3129 0d0a 0d0a 2020 2020  lf.X, 1)....    
-00004ed0: 6465 6620 5f64 656d 6f64 756c 6174 6528  def _demodulate(
-00004ee0: 7365 6c66 2c20 493a 206e 702e 6e64 6172  self, I: np.ndar
-00004ef0: 7261 792c 2076 6572 626f 7365 3a20 626f  ray, verbose: bo
-00004f00: 6f6c 203d 2046 616c 7365 2c20 6675 6e63  ol = False, func
-00004f10: 3a20 7374 7220 3d20 2273 6b69 2229 202d  : str = "ski") -
-00004f20: 3e20 7475 706c 653a 0d0a 2020 2020 2020  > tuple:..      
-00004f30: 2020 2222 2244 6563 6f64 6520 6261 7365    """Decode base
-00004f40: 2066 7269 6e67 6520 7061 7474 6572 6e73   fringe patterns
-00004f50: 2062 7920 7370 6174 696f 2d74 656d 706f   by spatio-tempo
-00004f60: 7261 6c20 6465 6d6f 6475 6c61 7469 6f6e  ral demodulation
-00004f70: 2e0d 0a0d 0a20 2020 2020 2020 2050 6172  .....        Par
-00004f80: 616d 6574 6572 730d 0a20 2020 2020 2020  ameters..       
-00004f90: 202d 2d2d 2d2d 2d2d 2d2d 2d0d 0a20 2020   ----------..   
-00004fa0: 2020 2020 2049 203a 206e 702e 6e64 6172       I : np.ndar
-00004fb0: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-00004fc0: 2046 7269 6e67 6520 7061 7474 6572 6e20   Fringe pattern 
-00004fd0: 7365 7175 656e 6365 2e0d 0a20 2020 2020  sequence...     
-00004fe0: 2020 2020 2020 2049 7420 6973 2072 6573         It is res
-00004ff0: 6861 7065 6420 746f 2076 6964 656f 7368  haped to videosh
-00005000: 6170 6520 2866 7261 6d65 7320 6054 602c  ape (frames `T`,
-00005010: 2068 6569 6768 7420 6059 602c 2077 6964   height `Y`, wid
-00005020: 7468 2060 5860 2c20 636f 6c6f 7220 6368  th `X`, color ch
-00005030: 616e 6e65 6c73 2060 4360 2920 6265 666f  annels `C`) befo
-00005040: 7265 2070 726f 6365 7373 696e 672e 0d0a  re processing...
-00005050: 0d0a 2020 2020 2020 2020 7665 7262 6f73  ..        verbos
-00005060: 6520 3a20 626f 6f6c 2c20 6f70 7469 6f6e  e : bool, option
-00005070: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-00005080: 4966 2074 6869 7320 6f72 2074 6865 2061  If this or the a
-00005090: 7267 756d 656e 7420 6076 6572 626f 7365  rgument `verbose
-000050a0: 6020 6f66 2074 6865 2046 7269 6e67 6573  ` of the Fringes
-000050b0: 2069 6e73 7461 6e63 6520 6973 2073 6574   instance is set
-000050c0: 2074 6f20 5472 7565 2c0d 0a20 2020 2020   to True,..     
-000050d0: 2020 2020 2020 2061 6464 6974 696f 6e61         additiona
-000050e0: 6c20 696e 666f 6d61 7469 6f6e 2069 7320  l infomation is 
-000050f0: 636f 6d70 7574 6564 2061 6e64 2072 6574  computed and ret
-00005100: 756e 6564 2e0d 0a20 2020 2020 2020 2020  uned...         
-00005110: 2020 2054 6869 7320 696e 636c 7564 6573     This includes
-00005120: 3a20 7068 6173 6520 6d61 7073 2c20 7265  : phase maps, re
-00005130: 7369 6475 616c 732c 2066 7269 6e67 6520  siduals, fringe 
-00005140: 6f72 6465 7273 2c20 7669 7369 6269 6c69  orders, visibili
-00005150: 7479 2061 6e64 2072 656c 6174 6976 6520  ty and relative 
-00005160: 6578 706f 7375 7265 2e0d 0a0d 0a20 2020  exposure.....   
-00005170: 2020 2020 2066 756e 6320 3a20 7374 722c       func : str,
-00005180: 206f 7074 696f 6e61 6c0d 0a20 2020 2020   optional..     
-00005190: 2020 2020 2020 2055 6e77 7261 7070 696e         Unwrappin
-000051a0: 6720 6675 6e63 7469 6f6e 2074 6f20 7573  g function to us
-000051b0: 652e 2054 6865 2064 6566 6175 6c74 2069  e. The default i
-000051c0: 7320 2773 6b69 272e 0d0a 0d0a 2020 2020  s 'ski'.....    
-000051d0: 2020 2020 2020 2020 2d20 2773 6b69 273a          - 'ski':
-000051e0: 2060 5363 696b 6974 2d69 6d61 6765 203c   `Scikit-image <
-000051f0: 6874 7470 733a 2f2f 7363 696b 6974 2d69  https://scikit-i
-00005200: 6d61 6765 2e6f 7267 2f64 6f63 732f 7374  mage.org/docs/st
-00005210: 6162 6c65 2f61 7574 6f5f 6578 616d 706c  able/auto_exampl
-00005220: 6573 2f66 696c 7465 7273 2f70 6c6f 745f  es/filters/plot_
-00005230: 7068 6173 655f 756e 7772 6170 2e68 746d  phase_unwrap.htm
-00005240: 6c3e 605f 0d0a 0d0a 2020 2020 2020 2020  l>`_....        
-00005250: 2020 2020 2d20 656c 7365 3a20 604f 7065      - else: `Ope
-00005260: 6e43 5620 6874 7470 733a 2f2f 646f 6373  nCV https://docs
-00005270: 2e6f 7065 6e63 762e 6f72 672f 342e 372e  .opencv.org/4.7.
-00005280: 302f 6466 2f64 3361 2f67 726f 7570 5f5f  0/df/d3a/group__
-00005290: 7068 6173 655f 5f75 6e77 7261 7070 696e  phase__unwrappin
-000052a0: 672e 6874 6d6c 3e60 5f0d 0a0d 0a20 2020  g.html>`_....   
-000052b0: 2020 2020 2052 6574 7572 6e73 0d0a 2020       Returns..  
-000052c0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0d 0a20        -------.. 
-000052d0: 2020 2020 2020 2062 7269 6768 746e 6573         brightnes
-000052e0: 7320 3a20 6e70 2e6e 6461 7272 6179 0d0a  s : np.ndarray..
-000052f0: 2020 2020 2020 2020 2020 2020 4c6f 6361              Loca
-00005300: 6c20 6261 636b 6772 6f75 6e64 2073 6967  l background sig
-00005310: 6e61 6c2e 0d0a 0d0a 2020 2020 2020 2020  nal.....        
-00005320: 6d6f 6475 6c61 7469 6f6e 203a 206e 702e  modulation : np.
-00005330: 6e64 6172 7261 790d 0a20 2020 2020 2020  ndarray..       
-00005340: 2020 2020 204c 6f63 616c 2061 6d70 6c69       Local ampli
-00005350: 7475 6465 206f 6620 7468 6520 636f 7369  tude of the cosi
-00005360: 6e65 2073 6967 6e61 6c2e 0d0a 0d0a 2020  ne signal.....  
-00005370: 2020 2020 2020 7265 6769 7374 7261 7469        registrati
-00005380: 6f6e 203a 206e 702e 6e64 6172 7261 790d  on : np.ndarray.
-00005390: 0a20 2020 2020 2020 2020 2020 2044 6563  .            Dec
-000053a0: 6f64 6564 2063 6f6f 7264 696e 6174 6573  oded coordinates
-000053b0: 2e0d 0a0d 0a20 2020 2020 2020 2020 2020  .....           
-000053c0: 202e 2e20 6e6f 7465 3a3a 2054 6865 2072   .. note:: The r
-000053d0: 6567 6973 7472 6174 696f 6e20 6973 2061  egistration is a
-000053e0: 206d 6170 7069 6e67 2069 6e20 7468 6520   mapping in the 
-000053f0: 7361 6d65 2070 6978 656c 2067 7269 6420  same pixel grid 
-00005400: 6173 2074 6865 2063 616d 6572 6120 7365  as the camera se
-00005410: 6e73 6f72 0d0a 2020 2020 2020 2020 2020  nsor..          
-00005420: 2020 2020 616e 6420 636f 6e74 6169 6e73      and contains
-00005430: 2074 6865 2069 6e66 6f72 6d61 7469 6f6e   the information
-00005440: 2077 6865 7265 2065 6163 6820 6361 6d65   where each came
-00005450: 7261 2070 6978 656c 2c20 692e 652e 2065  ra pixel, i.e. e
-00005460: 6163 6820 6361 6d65 7261 2073 6967 6874  ach camera sight
-00005470: 7261 792c 0d0a 2020 2020 2020 2020 2020  ray,..          
-00005480: 2020 2020 7761 7320 6c6f 6f6b 696e 6720      was looking 
-00005490: 6174 2064 7572 696e 6720 7468 6520 6672  at during the fr
-000054a0: 696e 6765 2070 6174 7465 726e 2061 6371  inge pattern acq
-000054b0: 7569 7369 7469 6f6e 2e0d 0a0d 0a20 2020  uisition.....   
-000054c0: 2020 2020 2072 6573 6964 7561 6c73 203a       residuals :
-000054d0: 206e 702e 6e64 6172 7261 792c 206f 7074   np.ndarray, opt
-000054e0: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
-000054f0: 2020 2052 6573 6964 7561 6c73 2066 726f     Residuals fro
-00005500: 6d20 7468 6520 6f70 7469 6d69 7a61 7469  m the optimizati
-00005510: 6f6e 2d62 6173 6564 2075 6e77 7261 7070  on-based unwrapp
-00005520: 696e 6720 7072 6f63 6573 732e 0d0a 0d0a  ing process.....
-00005530: 2020 2020 2020 2020 7068 6173 6520 3a20          phase : 
-00005540: 6e70 2e6e 6461 7272 6179 2c20 6f70 7469  np.ndarray, opti
-00005550: 6f6e 616c 0d0a 2020 2020 2020 2020 2020  onal..          
-00005560: 2020 4c6f 6361 6c20 7068 6173 652e 0d0a    Local phase...
-00005570: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
-00005580: 2020 2020 2020 2074 3020 3d20 7469 6d65         t0 = time
-00005590: 2e70 6572 665f 636f 756e 7465 7228 290d  .perf_counter().
-000055a0: 0a0d 0a20 2020 2020 2020 205f 6620 3d20  ...        _f = 
-000055b0: 7365 6c66 2e5f 6620 2a20 282d 3120 6966  self._f * (-1 if
-000055c0: 2073 656c 662e 7265 7665 7273 6520 656c   self.reverse el
-000055d0: 7365 2031 290d 0a0d 0a20 2020 2020 2020  se 1)....       
-000055e0: 2023 2070 6172 7365 0d0a 2020 2020 2020   # parse..      
-000055f0: 2020 542c 2059 2c20 582c 2043 203d 2076    T, Y, X, C = v
-00005600: 7368 6170 6528 4929 2e73 6861 7065 2020  shape(I).shape  
-00005610: 2320 6578 7472 6163 7420 592c 2058 2c20  # extract Y, X, 
-00005620: 4320 6672 6f6d 2064 6174 6120 6173 2074  C from data as t
-00005630: 6865 7365 2070 6172 616d 6574 6572 7320  hese parameters 
-00005640: 6465 7065 6e64 206f 6e20 7573 6564 2063  depend on used c
-00005650: 616d 6572 610d 0a20 2020 2020 2020 2049  amera..        I
-00005660: 203d 2049 2e72 6573 6861 7065 2828 542c   = I.reshape((T,
-00005670: 2059 2c20 582c 2043 2929 0d0a 0d0a 2020   Y, X, C))....  
-00005680: 2020 2020 2020 2320 6966 2073 656c 662e        # if self.
-00005690: 4644 4d3a 0d0a 2020 2020 2020 2020 2320  FDM:..        # 
-000056a0: 2020 2063 203d 206e 702e 6666 742e 7266     c = np.fft.rf
-000056b0: 6674 2849 2c20 6178 6973 3d30 2920 2f20  ft(I, axis=0) / 
-000056c0: 5420 2023 2074 6f64 6f3a 2068 6666 740d  T  # todo: hfft.
-000056d0: 0a20 2020 2020 2020 2023 0d0a 2020 2020  .        #..    
-000056e0: 2020 2020 2320 2020 2023 2069 6620 6e70      #    # if np
-000056f0: 2e61 6e79 2873 656c 662e 5f4e 203e 2032  .any(self._N > 2
-00005700: 202a 2073 656c 662e 4420 2a20 7365 6c66   * self.D * self
-00005710: 2e4b 293a 2020 2320 3220 2a20 6e70 2e61  .K):  # 2 * np.a
-00005720: 6273 285f 6629 2e6d 6178 2829 202b 2031  bs(_f).max() + 1
-00005730: 3a0d 0a20 2020 2020 2020 2023 2020 2020  :..        #    
-00005740: 2320 2020 2020 6920 3d20 6e70 2e61 7070  #     i = np.app
-00005750: 656e 6428 6e70 2e7a 6572 6f73 2831 2c20  end(np.zeros(1, 
-00005760: 696e 7429 2c20 7365 6c66 2e5f 662e 666c  int), self._f.fl
-00005770: 6174 7465 6e28 292e 6173 7479 7065 2869  atten().astype(i
-00005780: 6e74 2c20 636f 7079 3d46 616c 7365 2929  nt, copy=False))
-00005790: 2020 2320 6164 6420 6f66 6673 6574 0d0a    # add offset..
-000057a0: 2020 2020 2020 2020 2320 2020 2023 2020          #    #  
-000057b0: 2020 2063 203d 2063 5b69 5d0d 0a20 2020     c = c[i]..   
-000057c0: 2020 2020 2023 0d0a 2020 2020 2020 2020       #..        
-000057d0: 2320 2020 2061 203d 2061 6273 2863 290d  #    a = abs(c).
-000057e0: 0a20 2020 2020 2020 2023 2020 2020 2320  .        #    # 
-000057f0: 6920 3d20 6e70 2e61 7267 736f 7274 2861  i = np.argsort(a
-00005800: 5b31 3a5d 2c20 6178 6973 3d30 295b 3a3a  [1:], axis=0)[::
-00005810: 2d31 5d20 2023 2069 6e64 6963 6573 206f  -1]  # indices o
-00005820: 6620 6672 6571 7565 6e63 6965 732c 2073  f frequencies, s
-00005830: 6f72 7465 6420 6279 2074 6865 6972 206d  orted by their m
-00005840: 6167 6e69 7475 6465 0d0a 2020 2020 2020  agnitude..      
-00005850: 2020 2320 2020 2070 6869 203d 202d 6e70    #    phi = -np
-00005860: 2e61 6e67 6c65 2863 202a 206e 702e 6578  .angle(c * np.ex
-00005870: 7028 2d31 6a20 2a20 2873 656c 662e 6f20  p(-1j * (self.o 
-00005880: 2d20 6e70 2e70 6929 2929 5b5f 662e 666c  - np.pi)))[_f.fl
-00005890: 6174 7465 6e28 292e 6173 7479 7065 2869  atten().astype(i
-000058a0: 6e74 2c20 636f 7079 3d46 616c 7365 295d  nt, copy=False)]
-000058b0: 2020 2320 746f 646f 3a20 7768 7920 6f66    # todo: why of
-000058c0: 6673 6574 202d 2050 493f 3f3f 0d0a 0d0a  fset - PI???....
-000058d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000058e0: 7577 7220 3d3d 2022 4654 4d22 3a0d 0a20  uwr == "FTM":.. 
-000058f0: 2020 2020 2020 2020 2020 2023 2074 6f64             # tod
-00005900: 6f3a 206d 616b 6520 7061 7373 6261 6e64  o: make passband
-00005910: 2073 796d 6d65 7472 6963 616c 2061 726f   symmetrical aro
-00005920: 756e 6420 6361 7272 6965 7220 6672 6571  und carrier freq
-00005930: 7565 6e63 793f 0d0a 2020 2020 2020 2020  uency?..        
-00005940: 2020 2020 6966 2073 656c 662e 4420 3d3d      if self.D ==
-00005950: 2032 3a0d 0a20 2020 2020 2020 2020 2020   2:..           
-00005960: 2020 2020 2066 7820 3d20 6e70 2e66 6674       fx = np.fft
-00005970: 2e66 6674 7368 6966 7428 6e70 2e66 6674  .fftshift(np.fft
-00005980: 2e66 6674 6672 6571 2858 2929 2020 2320  .fftfreq(X))  # 
-00005990: 746f 646f 3a20 6866 6674 0d0a 2020 2020  todo: hfft..    
-000059a0: 2020 2020 2020 2020 2020 2020 6679 203d              fy =
-000059b0: 206e 702e 6666 742e 6666 7473 6869 6674   np.fft.fftshift
-000059c0: 286e 702e 6666 742e 6666 7466 7265 7128  (np.fft.fftfreq(
-000059d0: 5929 290d 0a20 2020 2020 2020 2020 2020  Y))..           
-000059e0: 2020 2020 2066 7878 2c20 6679 7920 3d20       fxx, fyy = 
-000059f0: 6e70 2e6d 6573 6867 7269 6428 6678 2c20  np.meshgrid(fx, 
-00005a00: 6679 290d 0a20 2020 2020 2020 2020 2020  fy)..           
-00005a10: 2020 2020 206d 7820 3d20 6e70 2e61 6273       mx = np.abs
-00005a20: 2866 7878 2920 3e20 6e70 2e61 6273 280d  (fxx) > np.abs(.
-00005a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005a40: 2020 2020 2066 7979 0d0a 2020 2020 2020       fyy..      
-00005a50: 2020 2020 2020 2020 2020 2920 2023 206d            )  # m
-00005a60: 6173 6b20 666f 7220 782d 6672 6571 7565  ask for x-freque
-00005a70: 6e63 6965 7320 2023 2074 6f64 6f3a 206d  ncies  # todo: m
-00005a80: 616b 6520 6c65 6674 2061 6e64 2072 6967  ake left and rig
-00005a90: 6874 2062 6f72 6465 7273 2072 6f75 6e64  ht borders round
-00005aa0: 2028 7379 6d6d 6574 7269 6361 6c20 6172   (symmetrical ar
-00005ab0: 6f75 6e64 2062 6173 6520 6261 6e64 290d  ound base band).
-00005ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005ad0: 206d 7920 3d20 6e70 2e61 6273 2866 7878   my = np.abs(fxx
-00005ae0: 2920 3c20 6e70 2e61 6273 280d 0a20 2020  ) < np.abs(..   
-00005af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b00: 2066 7979 0d0a 2020 2020 2020 2020 2020   fyy..          
-00005b10: 2020 2020 2020 2920 2023 206d 6173 6b20        )  # mask 
-00005b20: 666f 7220 792d 6672 6571 7565 6e63 6965  for y-frequencie
-00005b30: 7320 2023 2074 6f64 6f3a 206d 616b 6520  s  # todo: make 
-00005b40: 6c6f 7765 7220 616e 6420 7570 7065 7220  lower and upper 
-00005b50: 626f 7264 6572 7320 726f 756e 6420 2873  borders round (s
-00005b60: 796d 6d65 7472 6963 616c 2061 726f 756e  ymmetrical aroun
-00005b70: 6420 6261 7365 2062 616e 6429 0d0a 0d0a  d base band)....
-00005b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b90: 5720 3d20 3130 3020 2023 2061 7373 756d  W = 100  # assum
-00005ba0: 6520 7769 6e64 6f77 2077 6964 7468 2066  e window width f
-00005bb0: 6f72 2066 696c 7465 7269 6e67 206f 7574  or filtering out
-00005bc0: 2062 6173 6562 616e 640d 0a20 2020 2020   baseband..     
-00005bd0: 2020 2020 2020 2020 2020 2057 203d 206d             W = m
-00005be0: 696e 286d 6178 2833 2c20 5729 2c20 6d69  in(max(3, W), mi
-00005bf0: 6e28 582c 2059 2920 2f20 3230 2920 2023  n(X, Y) / 20)  #
-00005c00: 2063 6c69 7020 746f 2065 6e73 7572 6520   clip to ensure 
-00005c10: 706c 6175 7369 626c 6520 7661 6c75 650d  plausible value.
-00005c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005c30: 2061 203d 2069 6e74 286d 696e 286d 6178   a = int(min(max
-00005c40: 2830 2c20 5729 2c20 5820 2f20 3429 202b  (0, W), X / 4) +
-00005c50: 2030 2e35 2920 2023 2074 6f64 6f3a 2066   0.5)  # todo: f
-00005c60: 696e 6420 676f 6f64 2075 7070 6572 2063  ind good upper c
-00005c70: 7574 206f 6666 2066 7265 7175 656e 6379  ut off frequency
-00005c80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005c90: 2020 2320 6120 3d20 5820 2f2f 2034 0d0a    # a = X // 4..
-00005ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cb0: 6d78 5b3a 2c20 3a61 5d20 3d20 3020 2023  mx[:, :a] = 0  #
-00005cc0: 2072 656d 6f76 6520 6869 6768 2066 7265   remove high fre
-00005cd0: 7175 656e 6369 6573 0d0a 2020 2020 2020  quencies..      
-00005ce0: 2020 2020 2020 2020 2020 6220 3d20 696e            b = in
-00005cf0: 7428 5820 2f20 3220 2d20 5720 2f20 3220  t(X / 2 - W / 2 
-00005d00: 2b20 302e 3529 0d0a 2020 2020 2020 2020  + 0.5)..        
-00005d10: 2020 2020 2020 2020 6d78 5b3a 2c20 623a          mx[:, b:
-00005d20: 5d20 3d20 3020 2023 2072 656d 6f76 6520  ] = 0  # remove 
-00005d30: 6261 7365 6261 6e64 2061 6e64 2070 6f73  baseband and pos
-00005d40: 6974 6976 6520 6672 6571 7565 6e63 6965  itive frequencie
-00005d50: 730d 0a0d 0a20 2020 2020 2020 2020 2020  s....           
-00005d60: 2020 2020 2048 203d 2031 3030 2020 2320       H = 100  # 
-00005d70: 6173 7375 6d65 2077 696e 646f 7720 6865  assume window he
-00005d80: 6967 6874 2066 6f72 2066 696c 7465 7269  ight for filteri
-00005d90: 6e67 206f 7574 2062 6173 6562 616e 640d  ng out baseband.
-00005da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005db0: 2048 203d 206d 696e 286d 6178 2833 2c20   H = min(max(3, 
-00005dc0: 4829 2c20 6d69 6e28 582c 2059 2920 2f20  H), min(X, Y) / 
-00005dd0: 3230 2920 2023 2063 6c69 7020 746f 2065  20)  # clip to e
-00005de0: 6e73 7572 6520 706c 6175 7369 626c 6520  nsure plausible 
-00005df0: 7661 6c75 650d 0a20 2020 2020 2020 2020  value..         
-00005e00: 2020 2020 2020 2063 203d 2069 6e74 286d         c = int(m
-00005e10: 696e 286d 6178 2830 2c20 4829 2c20 5920  in(max(0, H), Y 
-00005e20: 2f20 3429 202b 2030 2e35 2920 2023 2074  / 4) + 0.5)  # t
-00005e30: 6f64 6f3a 2066 696e 6420 676f 6f64 2075  odo: find good u
-00005e40: 7070 6572 2063 7574 206f 6666 2066 7265  pper cut off fre
-00005e50: 7175 656e 6379 0d0a 2020 2020 2020 2020  quency..        
-00005e60: 2020 2020 2020 2020 2320 6320 3d20 5920          # c = Y 
-00005e70: 2f2f 2034 0d0a 2020 2020 2020 2020 2020  // 4..          
-00005e80: 2020 2020 2020 6d79 5b3a 632c 203a 5d20        my[:c, :] 
-00005e90: 3d20 3020 2023 2072 656d 6f76 6520 6869  = 0  # remove hi
-00005ea0: 6768 2066 7265 7175 656e 6369 6573 0d0a  gh frequencies..
-00005eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ec0: 6420 3d20 696e 7428 5920 2f20 3220 2d20  d = int(Y / 2 - 
-00005ed0: 4820 2f20 3220 2b20 302e 3529 0d0a 2020  H / 2 + 0.5)..  
-00005ee0: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-00005ef0: 5b64 3a2c 203a 5d20 3d20 3020 2023 2072  [d:, :] = 0  # r
-00005f00: 656d 6f76 6520 6261 7365 6261 6e64 2061  emove baseband a
-00005f10: 6e64 2070 6f73 6974 6976 6520 6672 6571  nd positive freq
-00005f20: 7565 6e63 6965 730d 0a0d 0a20 2020 2020  uencies....     
-00005f30: 2020 2020 2020 2020 2020 2023 2074 6f64             # tod
-00005f40: 6f3a 2073 6d6f 6f74 6820 6564 6765 7320  o: smooth edges 
-00005f50: 6f66 2066 696c 7465 7220 6d61 736b 732c  of filter masks,
-00005f60: 2069 2e65 2e20 6d61 6b65 2074 6865 6d20   i.e. make them 
-00005f70: 4861 6e6e 2057 696e 646f 7773 0d0a 0d0a  Hann Windows....
-00005f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f90: 6966 2043 203e 2031 3a0d 0a20 2020 2020  if C > 1:..     
-00005fa0: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-00005fb0: 203d 2049 5b2e 2e2e 2c20 305d 0d0a 2020   = I[..., 0]..  
-00005fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fd0: 2020 4320 3d20 310d 0a20 2020 2020 2020    C = 1..       
-00005fe0: 2020 2020 2020 2020 2020 2020 2049 203d               I =
-00005ff0: 2049 2e72 6573 6861 7065 2828 542c 2059   I.reshape((T, Y
-00006000: 2c20 582c 2043 2929 0d0a 0d0a 2020 2020  , X, C))....    
-00006010: 2020 2020 2020 2020 2020 2020 7068 6920              phi 
-00006020: 3d20 6e70 2e65 6d70 7479 285b 7365 6c66  = np.empty([self
-00006030: 2e44 2c20 592c 2058 2c20 435d 2c20 6e70  .D, Y, X, C], np
-00006040: 2e66 6c6f 6174 3332 290d 0a20 2020 2020  .float32)..     
-00006050: 2020 2020 2020 2020 2020 2072 6573 203d             res =
-00006060: 206e 702e 656d 7074 7928 5b73 656c 662e   np.empty([self.
-00006070: 442c 2059 2c20 582c 2043 5d2c 206e 702e  D, Y, X, C], np.
-00006080: 666c 6f61 7433 3229 0d0a 2020 2020 2020  float32)..      
-00006090: 2020 2020 2020 2020 2020 2320 6966 2073            # if s
-000060a0: 656c 662e 7665 7262 6f73 653a 0d0a 2020  elf.verbose:..  
-000060b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000060c0: 2020 2020 7068 6920 3d20 6e70 2e65 6d70      phi = np.emp
-000060d0: 7479 285b 7365 6c66 2e44 2c20 592c 2058  ty([self.D, Y, X
-000060e0: 2c20 435d 2c20 6e70 2e66 6c6f 6174 3332  , C], np.float32
-000060f0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00006100: 2020 2023 2020 2020 2072 6573 203d 206e     #     res = n
-00006110: 702e 656d 7074 7928 5b73 656c 662e 442c  p.empty([self.D,
-00006120: 2059 2c20 582c 2043 5d2c 206e 702e 666c   Y, X, C], np.fl
-00006130: 6f61 7433 3229 0d0a 2020 2020 2020 2020  oat32)..        
-00006140: 2020 2020 2020 2020 7265 6720 3d20 6e70          reg = np
-00006150: 2e65 6d70 7479 285b 7365 6c66 2e44 2c20  .empty([self.D, 
-00006160: 592c 2058 2c20 435d 2c20 6e70 2e66 6c6f  Y, X, C], np.flo
-00006170: 6174 3332 290d 0a20 2020 2020 2020 2020  at32)..         
-00006180: 2020 2020 2020 2062 7269 203d 206e 702e         bri = np.
-00006190: 656d 7074 7928 5b73 656c 662e 442c 2059  empty([self.D, Y
-000061a0: 2c20 582c 2043 5d2c 206e 702e 666c 6f61  , X, C], np.floa
-000061b0: 7433 3229 0d0a 2020 2020 2020 2020 2020  t32)..          
-000061c0: 2020 2020 2020 6d6f 6420 3d20 6e70 2e65        mod = np.e
-000061d0: 6d70 7479 285b 7365 6c66 2e44 2c20 592c  mpty([self.D, Y,
-000061e0: 2058 2c20 435d 2c20 6e70 2e66 6c6f 6174   X, C], np.float
-000061f0: 3332 290d 0a20 2020 2020 2020 2020 2020  32)..           
-00006200: 2020 2020 2066 6964 203d 206e 702e 6675       fid = np.fu
-00006210: 6c6c 285b 7365 6c66 2e44 2c20 592c 2058  ll([self.D, Y, X
-00006220: 2c20 435d 2c20 6e70 2e6e 616e 2c20 6e70  , C], np.nan, np
-00006230: 2e66 6c6f 6174 3332 290d 0a20 2020 2020  .float32)..     
-00006240: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-00006250: 2069 6e20 7261 6e67 6528 4329 3a0d 0a20   in range(C):.. 
-00006260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006270: 2020 2023 2074 6f64 6f3a 2068 6666 740d     # todo: hfft.
-00006280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006290: 2020 2020 2049 5f46 4654 203d 206e 702e       I_FFT = np.
-000062a0: 6666 742e 6666 7473 6869 6674 286e 702e  fft.fftshift(np.
-000062b0: 6666 742e 6666 7432 2849 5b30 2c20 2e2e  fft.fft2(I[0, ..
-000062c0: 2e2c 2063 5d29 290d 0a0d 0a20 2020 2020  ., c]))....     
-000062d0: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-000062e0: 5f46 4654 5f78 203d 2049 5f46 4654 202a  _FFT_x = I_FFT *
-000062f0: 206d 780d 0a20 2020 2020 2020 2020 2020   mx..           
-00006300: 2020 2020 2020 2020 2069 7879 2c20 6978           ixy, ix
-00006310: 7820 3d20 6e70 2e75 6e72 6176 656c 5f69  x = np.unravel_i
-00006320: 6e64 6578 2849 5f46 4654 5f78 2e61 7267  ndex(I_FFT_x.arg
-00006330: 6d61 7828 292c 2049 5f46 4654 5f78 2e73  max(), I_FFT_x.s
-00006340: 6861 7065 2920 2023 2067 6574 2069 6e64  hape)  # get ind
-00006350: 6963 6573 206f 6620 6361 7272 6965 7220  ices of carrier 
-00006360: 6672 6571 7565 6e63 790d 0a20 2020 2020  frequency..     
-00006370: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-00006380: 5f46 4654 5f78 203d 206e 702e 726f 6c6c  _FFT_x = np.roll
-00006390: 2849 5f46 4654 5f78 2c20 5820 2f2f 2032  (I_FFT_x, X // 2
-000063a0: 202d 2069 7878 2c20 3129 2020 2320 6d6f   - ixx, 1)  # mo
-000063b0: 7665 2074 6f20 6365 6e74 6572 0d0a 0d0a  ve to center....
-000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063d0: 2020 2020 495f 4646 545f 7920 3d20 495f      I_FFT_y = I_
-000063e0: 4646 5420 2a20 6d79 0d0a 2020 2020 2020  FFT * my..      
-000063f0: 2020 2020 2020 2020 2020 2020 2020 6979                iy
-00006400: 792c 2069 7978 203d 206e 702e 756e 7261  y, iyx = np.unra
-00006410: 7665 6c5f 696e 6465 7828 495f 4646 545f  vel_index(I_FFT_
-00006420: 792e 6172 676d 6178 2829 2c20 495f 4646  y.argmax(), I_FF
-00006430: 545f 792e 7368 6170 6529 2020 2320 6765  T_y.shape)  # ge
-00006440: 7420 696e 6469 6365 7320 6f66 2063 6172  t indices of car
-00006450: 7269 6572 2066 7265 7175 656e 6379 0d0a  rier frequency..
-00006460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006470: 2020 2020 495f 4646 545f 7920 3d20 6e70      I_FFT_y = np
-00006480: 2e72 6f6c 6c28 495f 4646 545f 792c 2059  .roll(I_FFT_y, Y
-00006490: 202f 2f20 3220 2d20 6979 792c 2030 2920   // 2 - iyy, 0) 
-000064a0: 2023 206d 6f76 6520 746f 2063 656e 7465   # move to cente
-000064b0: 720d 0a0d 0a20 2020 2020 2020 2020 2020  r....           
-000064c0: 2020 2020 2020 2020 204a 7820 3d20 6e70           Jx = np
-000064d0: 2e66 6674 2e69 6666 7432 286e 702e 6666  .fft.ifft2(np.ff
-000064e0: 742e 6966 6674 7368 6966 7428 495f 4646  t.ifftshift(I_FF
-000064f0: 545f 7829 290d 0a20 2020 2020 2020 2020  T_x))..         
-00006500: 2020 2020 2020 2020 2020 204a 7920 3d20             Jy = 
-00006510: 6e70 2e66 6674 2e69 6666 7432 286e 702e  np.fft.ifft2(np.
-00006520: 6666 742e 6966 6674 7368 6966 7428 495f  fft.ifftshift(I_
-00006530: 4646 545f 7929 290d 0a0d 0a20 2020 2020  FFT_y))....     
-00006540: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006550: 6567 5b30 2c20 2e2e 2e2c 2063 5d20 3d20  eg[0, ..., c] = 
-00006560: 6e70 2e61 6e67 6c65 284a 7829 0d0a 2020  np.angle(Jx)..  
-00006570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006580: 2020 7265 675b 312c 202e 2e2e 2c20 635d    reg[1, ..., c]
-00006590: 203d 206e 702e 616e 676c 6528 4a79 290d   = np.angle(Jy).
-000065a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000065b0: 2020 2020 2023 2074 6f64 6f3a 2062 7269       # todo: bri
-000065c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000065d0: 2020 2020 2020 6d6f 645b 302c 202e 2e2e        mod[0, ...
-000065e0: 2c20 635d 203d 206e 702e 6162 7328 4a78  , c] = np.abs(Jx
-000065f0: 2920 2a20 3220 2023 2066 6163 746f 7220  ) * 2  # factor 
-00006600: 3220 6265 6361 7573 6520 6f6e 6520 7369  2 because one si
-00006610: 6465 6261 6e64 2069 7320 6669 6c74 6572  deband is filter
-00006620: 6564 206f 7574 0d0a 2020 2020 2020 2020  ed out..        
-00006630: 2020 2020 2020 2020 2020 2020 6d6f 645b              mod[
-00006640: 312c 202e 2e2e 2c20 635d 203d 206e 702e  1, ..., c] = np.
-00006650: 6162 7328 4a79 2920 2a20 3220 2023 2066  abs(Jy) * 2  # f
-00006660: 6163 746f 7220 3220 6265 6361 7573 6520  actor 2 because 
-00006670: 6f6e 6520 7369 6465 6261 6e64 2069 7320  one sideband is 
-00006680: 6669 6c74 6572 6564 206f 7574 0d0a 2020  filtered out..  
-00006690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000066a0: 2020 6966 2073 656c 662e 7665 7262 6f73    if self.verbos
-000066b0: 6520 6f72 2076 6572 626f 7365 3a0d 0a20  e or verbose:.. 
-000066c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000066d0: 2020 2020 2020 2070 6869 5b30 2c20 2e2e         phi[0, ..
-000066e0: 2e2c 2063 5d20 3d20 7265 675b 302c 202e  ., c] = reg[0, .
-000066f0: 2e2e 2c20 635d 0d0a 2020 2020 2020 2020  .., c]..        
-00006700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006710: 7068 695b 312c 202e 2e2e 2c20 635d 203d  phi[1, ..., c] =
-00006720: 2072 6567 5b31 2c20 2e2e 2e2c 2063 5d0d   reg[1, ..., c].
-00006730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006740: 2020 2020 2020 2020 2072 6573 5b30 2c20           res[0, 
-00006750: 2e2e 2e2c 2063 5d20 3d20 6e70 2e6c 6f67  ..., c] = np.log
-00006760: 286e 702e 6162 7328 495f 4646 5429 2920  (np.abs(I_FFT)) 
-00006770: 2023 204a 2020 2320 746f 646f 3a20 6866   # J  # todo: hf
-00006780: 6674 0d0a 2020 2020 2020 2020 2020 2020  ft..            
-00006790: 2020 2020 2020 2020 2020 2020 7265 735b              res[
-000067a0: 312c 202e 2e2e 2c20 635d 203d 206e 702e  1, ..., c] = np.
-000067b0: 6c6f 6728 6e70 2e61 6273 2849 5f46 4654  log(np.abs(I_FFT
-000067c0: 2929 2020 2320 4a0d 0a20 2020 2020 2020  ))  # J..       
-000067d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067e0: 2023 2074 6f64 6f3a 2049 202d 204a 0d0a   # todo: I - J..
-000067f0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00006800: 2073 656c 662e 4420 3d3d 2031 3a0d 0a20   self.D == 1:.. 
-00006810: 2020 2020 2020 2020 2020 2020 2020 204c                 L
-00006820: 203d 206d 6178 2858 2c20 5929 0d0a 2020   = max(X, Y)..  
-00006830: 2020 2020 2020 2020 2020 2020 2020 6678                fx
-00006840: 203d 206e 702e 6666 742e 6666 7473 6869   = np.fft.fftshi
-00006850: 6674 286e 702e 6666 742e 6666 7466 7265  ft(np.fft.fftfre
-00006860: 7128 5829 2920 2a20 5820 2a20 5920 2f20  q(X)) * X * Y / 
-00006870: 4c20 2023 2074 6f64 6f3a 2068 6666 740d  L  # todo: hfft.
-00006880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006890: 2066 7920 3d20 6e70 2e66 6674 2e66 6674   fy = np.fft.fft
-000068a0: 7368 6966 7428 6e70 2e66 6674 2e66 6674  shift(np.fft.fft
-000068b0: 6672 6571 2859 2929 202a 2059 202a 2058  freq(Y)) * Y * X
-000068c0: 202f 204c 0d0a 2020 2020 2020 2020 2020   / L..          
-000068d0: 2020 2020 2020 6678 782c 2066 7979 203d        fxx, fyy =
-000068e0: 206e 702e 6d65 7368 6772 6964 2866 782c   np.meshgrid(fx,
-000068f0: 2066 7929 0d0a 2020 2020 2020 2020 2020   fy)..          
-00006900: 2020 2020 2020 6672 7220 3d20 6e70 2e73        frr = np.s
-00006910: 7172 7428 6678 782a 2a32 202b 2066 7979  qrt(fxx**2 + fyy
-00006920: 2a2a 3229 2020 2320 746f 646f 3a20 6e6f  **2)  # todo: no
-00006930: 726d 616c 697a 6174 696f 6e20 6f66 2062  rmalization of b
-00006940: 6f74 6820 6469 7265 6374 696f 6e73 0d0a  oth directions..
-00006950: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006960: 2020 6d72 203d 2066 7272 203c 3d20 4c20    mr = frr <= L 
-00006970: 2f20 3220 2023 2065 6e73 7572 6520 7361  / 2  # ensure sa
-00006980: 6d65 2073 616d 706c 696e 6720 696e 2061  me sampling in a
-00006990: 6c6c 2064 6972 6563 7469 6f6e 730d 0a20  ll directions.. 
-000069a0: 2020 2020 2020 2020 2020 2020 2020 2057                 W
-000069b0: 203d 2031 300d 0a20 2020 2020 2020 2020   = 10..         
-000069c0: 2020 2020 2020 2057 203d 206d 696e 286d         W = min(m
-000069d0: 6178 2831 2c20 5720 2f20 3229 2c20 4c20  ax(1, W / 2), L 
-000069e0: 2f20 3230 290d 0a20 2020 2020 2020 2020  / 20)..         
-000069f0: 2020 2020 2020 206d 725b 6672 7220 3c20         mr[frr < 
-00006a00: 575d 203d 2030 2020 2320 7265 6d6f 7665  W] = 0  # remove
-00006a10: 2062 6173 6562 616e 640d 0a20 2020 2020   baseband..     
-00006a20: 2020 2020 2020 2020 2020 206d 725b 6672             mr[fr
-00006a30: 7220 3e20 4c20 2f20 345d 203d 2030 2020  r > L / 4] = 0  
-00006a40: 2320 7265 6d6f 7665 2074 6f6f 2068 6967  # remove too hig
-00006a50: 6820 6672 6571 7565 6e63 6965 730d 0a0d  h frequencies...
-00006a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006a70: 206d 6820 3d20 6e70 2e65 6d70 7479 285b   mh = np.empty([
-00006a80: 592c 2058 5d29 0d0a 2020 2020 2020 2020  Y, X])..        
-00006a90: 2020 2020 2020 2020 6d68 5b3a 2c20 3a20          mh[:, : 
-00006aa0: 5820 2f2f 2032 5d20 3d20 310d 0a20 2020  X // 2] = 1..   
-00006ab0: 2020 2020 2020 2020 2020 2020 206d 685b               mh[
-00006ac0: 3a2c 2058 202f 2f20 3220 3a5d 203d 2030  :, X // 2 :] = 0
-00006ad0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00006ae0: 2020 2020 6966 2043 203e 2031 3a0d 0a20      if C > 1:.. 
-00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b00: 2020 2049 203d 2049 5b2e 2e2e 2c20 305d     I = I[..., 0]
-00006b10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006b20: 2020 2020 2020 4320 3d20 310d 0a20 2020        C = 1..   
-00006b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b40: 2049 203d 2049 2e72 6573 6861 7065 2828   I = I.reshape((
-00006b50: 542c 2059 2c20 582c 2043 2929 0d0a 0d0a  T, Y, X, C))....
-00006b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b70: 7068 6920 3d20 6e70 2e65 6d70 7479 285b  phi = np.empty([
-00006b80: 7365 6c66 2e44 2c20 592c 2058 2c20 435d  self.D, Y, X, C]
-00006b90: 2c20 6e70 2e66 6c6f 6174 3332 290d 0a20  , np.float32).. 
-00006ba0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006bb0: 6573 203d 206e 702e 656d 7074 7928 5b73  es = np.empty([s
-00006bc0: 656c 662e 442c 2059 2c20 582c 2043 5d2c  elf.D, Y, X, C],
-00006bd0: 206e 702e 666c 6f61 7433 3229 0d0a 2020   np.float32)..  
-00006be0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00006bf0: 6420 3d20 6e70 2e66 756c 6c28 5b73 656c  d = np.full([sel
-00006c00: 662e 442c 2059 2c20 582c 2043 5d2c 206e  f.D, Y, X, C], n
-00006c10: 702e 6e61 6e2c 206e 702e 666c 6f61 7433  p.nan, np.float3
-00006c20: 3229 0d0a 2020 2020 2020 2020 2020 2020  2)..            
-00006c30: 2020 2020 7265 6720 3d20 6e70 2e65 6d70      reg = np.emp
-00006c40: 7479 285b 7365 6c66 2e44 2c20 592c 2058  ty([self.D, Y, X
-00006c50: 2c20 435d 2c20 6e70 2e66 6c6f 6174 3332  , C], np.float32
-00006c60: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00006c70: 2020 2062 7269 203d 206e 702e 656d 7074     bri = np.empt
-00006c80: 7928 5b73 656c 662e 442c 2059 2c20 582c  y([self.D, Y, X,
-00006c90: 2043 5d2c 206e 702e 666c 6f61 7433 3229   C], np.float32)
-00006ca0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006cb0: 2020 6d6f 6420 3d20 6e70 2e65 6d70 7479    mod = np.empty
-00006cc0: 285b 7365 6c66 2e44 2c20 592c 2058 2c20  ([self.D, Y, X, 
-00006cd0: 435d 2c20 6e70 2e66 6c6f 6174 3332 290d  C], np.float32).
-00006ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006cf0: 2066 6f72 2063 2069 6e20 7261 6e67 6528   for c in range(
-00006d00: 4329 3a0d 0a20 2020 2020 2020 2020 2020  C):..           
-00006d10: 2020 2020 2020 2020 2023 2074 6f64 6f3a           # todo:
-00006d20: 2068 6666 740d 0a20 2020 2020 2020 2020   hfft..         
-00006d30: 2020 2020 2020 2020 2020 2049 5f46 4654             I_FFT
-00006d40: 203d 206e 702e 6666 742e 6666 7473 6869   = np.fft.fftshi
-00006d50: 6674 286e 702e 6666 742e 6666 7432 2849  ft(np.fft.fft2(I
-00006d60: 5b30 2c20 2e2e 2e2c 2063 5d29 290d 0a0d  [0, ..., c]))...
-00006d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006d80: 2020 2020 2049 5f46 4654 5f72 203d 2049       I_FFT_r = I
-00006d90: 5f46 4654 202a 206d 720d 0a20 2020 2020  _FFT * mr..     
-00006da0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006db0: 792c 2069 7820 3d20 6e70 2e75 6e72 6176  y, ix = np.unrav
-00006dc0: 656c 5f69 6e64 6578 2849 5f46 4654 5f72  el_index(I_FFT_r
-00006dd0: 2e6e 616e 6172 676d 6178 2829 2c20 495f  .nanargmax(), I_
-00006de0: 4646 545f 722e 7368 6170 6529 2020 2320  FFT_r.shape)  # 
-00006df0: 6765 7420 696e 6469 6365 7320 6f66 2063  get indices of c
-00006e00: 6172 7269 6572 2066 7265 7175 656e 6379  arrier frequency
-00006e10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006e20: 2020 2020 2020 792c 2078 203d 2059 202f        y, x = Y /
-00006e30: 2032 202d 2069 792c 2058 202f 2032 202d   2 - iy, X / 2 -
-00006e40: 2069 780d 0a20 2020 2020 2020 2020 2020   ix..           
-00006e50: 2020 2020 2020 2020 2061 203d 206e 702e           a = np.
-00006e60: 6465 6772 6565 7328 6e70 2e61 7263 7461  degrees(np.arcta
-00006e70: 6e32 2879 2c20 7829 290d 0a20 2020 2020  n2(y, x))..     
-00006e80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00006e90: 6872 203d 2073 702e 6e64 696d 6167 652e  hr = sp.ndimage.
-00006ea0: 726f 7461 7465 286d 682c 2061 2c20 7265  rotate(mh, a, re
-00006eb0: 7368 6170 653d 4661 6c73 652c 206f 7264  shape=False, ord
-00006ec0: 6572 3d30 2c20 6d6f 6465 3d22 6e65 6172  er=0, mode="near
-00006ed0: 6573 7422 290d 0a0d 0a20 2020 2020 2020  est")....       
-00006ee0: 2020 2020 2020 2020 2020 2020 2049 5f46               I_F
-00006ef0: 4654 5f72 202a 3d20 6d68 7220 2023 2072  FT_r *= mhr  # r
-00006f00: 656d 6f76 6520 6f6e 6520 7369 6465 6261  emove one sideba
-00006f10: 6e64 0d0a 2020 2020 2020 2020 2020 2020  nd..            
-00006f20: 2020 2020 2020 2020 495f 4646 545f 7220          I_FFT_r 
-00006f30: 3d20 6e70 2e72 6f6c 6c28 495f 4646 545f  = np.roll(I_FFT_
-00006f40: 722c 2058 202f 2f20 3220 2d20 6978 2c20  r, X // 2 - ix, 
-00006f50: 3129 2020 2320 6d6f 7665 2074 6f20 6365  1)  # move to ce
-00006f60: 6e74 6572 0d0a 2020 2020 2020 2020 2020  nter..          
-00006f70: 2020 2020 2020 2020 2020 495f 4646 545f            I_FFT_
-00006f80: 7220 3d20 6e70 2e72 6f6c 6c28 495f 4646  r = np.roll(I_FF
-00006f90: 545f 722c 2059 202f 2f20 3220 2d20 6979  T_r, Y // 2 - iy
-00006fa0: 2c20 3029 2020 2320 6d6f 7665 2074 6f20  , 0)  # move to 
-00006fb0: 6365 6e74 6572 0d0a 0d0a 2020 2020 2020  center....      
-00006fc0: 2020 2020 2020 2020 2020 2020 2020 4a20                J 
-00006fd0: 3d20 6e70 2e66 6674 2e69 6666 7432 286e  = np.fft.ifft2(n
-00006fe0: 702e 6666 742e 6966 6674 7368 6966 7428  p.fft.ifftshift(
-00006ff0: 495f 4646 545f 7229 290d 0a0d 0a20 2020  I_FFT_r))....   
-00007000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007010: 2072 6567 5b30 2c20 2e2e 2e2c 2063 5d20   reg[0, ..., c] 
-00007020: 3d20 6e70 2e61 6e67 6c65 284a 290d 0a20  = np.angle(J).. 
-00007030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007040: 2020 2023 2074 6f64 6f3a 2062 7269 0d0a     # todo: bri..
-00007050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007060: 2020 2020 6d6f 645b 302c 202e 2e2e 2c20      mod[0, ..., 
-00007070: 635d 203d 206e 702e 6162 7328 4a29 202a  c] = np.abs(J) *
-00007080: 2032 2020 2320 6661 6374 6f72 2032 2062   2  # factor 2 b
-00007090: 6563 6175 7365 206f 6e65 2073 6964 6562  ecause one sideb
-000070a0: 616e 6420 6973 2066 696c 7465 7265 6420  and is filtered 
-000070b0: 6f75 740d 0a20 2020 2020 2020 2020 2020  out..           
-000070c0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000070d0: 2e76 6572 626f 7365 206f 7220 7665 7262  .verbose or verb
-000070e0: 6f73 653a 0d0a 2020 2020 2020 2020 2020  ose:..          
-000070f0: 2020 2020 2020 2020 2020 2020 2020 7068                ph
-00007100: 695b 302c 202e 2e2e 2c20 635d 203d 2072  i[0, ..., c] = r
-00007110: 6567 5b30 2c20 2e2e 2e2c 2063 5d0d 0a20  eg[0, ..., c].. 
-00007120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007130: 2020 2020 2020 2072 6573 5b30 2c20 2e2e         res[0, ..
-00007140: 2e2c 2063 5d20 3d20 6e70 2e6c 6f67 286e  ., c] = np.log(n
-00007150: 702e 6162 7328 495f 4646 5429 2920 2023  p.abs(I_FFT))  #
-00007160: 204a 0d0a 2020 2020 2020 2020 2020 2020   J..            
-00007170: 2020 2020 2020 2020 2020 2020 2320 746f              # to
-00007180: 646f 3a20 4920 2d20 4a0d 0a20 2020 2020  do: I - J..     
-00007190: 2020 2065 6c69 6620 4661 6c73 653a 2020     elif False:  
-000071a0: 2320 6e70 2e61 6c6c 2873 656c 662e 4e20  # np.all(self.N 
-000071b0: 3e3d 2033 293a 2020 2320 746f 646f 3a20  >= 3):  # todo: 
-000071c0: 6375 7079 0d0a 2020 2020 2020 2020 2020  cupy..          
-000071d0: 2020 2320 7469 6d65 2f66 7261 6d65 2069    # time/frame i
-000071e0: 6e64 6963 6573 2066 6f72 2077 6865 6e20  ndices for when 
-000071f0: 6465 636f 6469 6e67 2073 6869 6674 7320  decoding shifts 
-00007200: 6f66 2065 6163 6820 7365 740d 0a20 2020  of each set..   
-00007210: 2020 2020 2020 2020 204e 6163 6320 3d20           Nacc = 
-00007220: 6e70 2e63 756d 7375 6d28 7365 6c66 2e5f  np.cumsum(self._
-00007230: 4e2e 7261 7665 6c28 2929 2e72 6573 6861  N.ravel()).resha
-00007240: 7065 2873 656c 662e 442c 2073 656c 662e  pe(self.D, self.
-00007250: 4b29 0d0a 2020 2020 2020 2020 2020 2020  K)..            
-00007260: 4e30 203d 206e 702e 6172 7261 7928 5b5b  N0 = np.array([[
-00007270: 305d 2c20 5b4e 6163 635b 302c 202d 315d  0], [Nacc[0, -1]
-00007280: 5d5d 295b 3a20 7365 6c66 2e44 5d0d 0a20  ]])[: self.D].. 
-00007290: 2020 2020 2020 2020 2020 2074 6920 3d20             ti = 
-000072a0: 6e70 2e63 6f6e 6361 7465 6e61 7465 2828  np.concatenate((
-000072b0: 4e30 2c20 4e61 6363 292c 2061 7869 733d  N0, Nacc), axis=
-000072c0: 3129 2e61 7374 7970 6528 6e70 2e69 6e74  1).astype(np.int
-000072d0: 5f29 2020 2320 696e 6469 6365 7320 666f  _)  # indices fo
-000072e0: 7220 7472 6176 6572 7369 6e67 2074 0d0a  r traversing t..
-000072f0: 0d0a 2020 2020 2020 2020 2020 2020 6474  ..            dt
-00007300: 203d 206e 702e 666c 6f61 7433 3220 2023   = np.float32  #
-00007310: 2066 6c6f 6174 3332 2773 2070 7265 6369   float32's preci
-00007320: 7369 6f6e 2069 7320 7573 7561 6c6c 7920  sion is usually 
-00007330: 6265 7474 6572 2074 6861 6e20 7175 616e  better than quan
-00007340: 7469 7a61 7469 6f6e 206e 6f69 7365 2069  tization noise i
-00007350: 6e20 7068 6173 6520 7368 6966 7469 6e67  n phase shifting
-00007360: 2073 6571 7565 6e63 650d 0a20 2020 2020   sequence..     
-00007370: 2020 2020 2020 2041 203d 206e 702e 656d         A = np.em
-00007380: 7074 7928 2873 656c 662e 442c 2059 2c20  pty((self.D, Y, 
-00007390: 582c 2043 292c 2064 7429 2020 2320 6272  X, C), dt)  # br
-000073a0: 6967 6874 6e65 7373 206d 7573 7420 6265  ightness must be
-000073b0: 2069 6465 6e74 6963 616c 2066 6f72 2061   identical for a
-000073c0: 6c6c 2073 6574 732c 2068 656e 6365 2077  ll sets, hence w
-000073d0: 6520 6172 7665 7261 6765 0d0a 2020 2020  e arverage..    
-000073e0: 2020 2020 2020 2020 4220 3d20 6e70 2e65          B = np.e
-000073f0: 6d70 7479 2828 7365 6c66 2e44 2c20 7365  mpty((self.D, se
-00007400: 6c66 2e4b 2c20 592c 2058 2c20 4329 2c20  lf.K, Y, X, C), 
-00007410: 6474 290d 0a20 2020 2020 2020 2020 2020  dt)..           
-00007420: 2078 203d 206e 702e 656d 7074 7928 2873   x = np.empty((s
-00007430: 656c 662e 442c 2059 2c20 582c 2043 292c  elf.D, Y, X, C),
-00007440: 2064 7429 0d0a 2020 2020 2020 2020 2020   dt)..          
-00007450: 2020 7020 3d20 6e70 2e65 6d70 7479 2828    p = np.empty((
-00007460: 7365 6c66 2e44 2c20 7365 6c66 2e4b 2c20  self.D, self.K, 
-00007470: 592c 2058 2c20 4329 2c20 6474 290d 0a20  Y, X, C), dt).. 
-00007480: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00007490: 6c66 2e76 6572 626f 7365 206f 7220 7665  lf.verbose or ve
-000074a0: 7262 6f73 653a 0d0a 2020 2020 2020 2020  rbose:..        
-000074b0: 2020 2020 2020 2020 7520 3d20 6e70 2e65          u = np.e
-000074c0: 6d70 7479 2828 7365 6c66 2e44 2c20 592c  mpty((self.D, Y,
-000074d0: 2058 2c20 4329 2c20 6474 290d 0a20 2020   X, C), dt)..   
-000074e0: 2020 2020 2020 2020 2020 2020 206b 203d               k =
-000074f0: 206e 702e 656d 7074 7928 2873 656c 662e   np.empty((self.
-00007500: 442c 2073 656c 662e 4b2c 2059 2c20 582c  D, self.K, Y, X,
-00007510: 2043 292c 2064 7429 0d0a 2020 2020 2020   C), dt)..      
-00007520: 2020 2020 2020 2020 2020 7373 646d 6178            ssdmax
-00007530: 203d 206e 702e 696e 6620 2023 2074 6f64   = np.inf  # tod
-00007540: 6f3a 2052 202f 2032 2061 6e64 2050 6f70  o: R / 2 and Pop
-00007550: 6f76 6963 6975 2773 2069 6e65 7175 616c  oviciu's inequal
-00007560: 6974 7920 6f6e 2076 6172 6961 6e63 6573  ity on variances
-00007570: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007580: 2020 7220 3d20 6e70 2e66 756c 6c28 2873    r = np.full((s
-00007590: 656c 662e 442c 2059 2c20 582c 2043 292c  elf.D, Y, X, C),
-000075a0: 2073 7364 6d61 782c 2064 7429 0d0a 0d0a   ssdmax, dt)....
-000075b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000075c0: 6420 696e 2072 616e 6765 2873 656c 662e  d in range(self.
-000075d0: 4429 3a0d 0a20 2020 2020 2020 2020 2020  D):..           
-000075e0: 2020 2020 2041 5b64 5d20 3d20 6e70 2e6d       A[d] = np.m
-000075f0: 6561 6e28 495b 7469 5b64 2c20 305d 203a  ean(I[ti[d, 0] :
-00007600: 2074 695b 642c 202d 315d 5d29 0d0a 2020   ti[d, -1]])..  
-00007610: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00007620: 7220 6920 696e 2072 616e 6765 2873 656c  r i in range(sel
-00007630: 662e 4b29 3a0d 0a20 2020 2020 2020 2020  f.K):..         
-00007640: 2020 2020 2020 2020 2020 2074 203d 206e             t = n
-00007650: 702e 6172 616e 6765 2873 656c 662e 5f4e  p.arange(self._N
-00007660: 5b64 2c20 695d 2920 2f20 7365 6c66 2e5f  [d, i]) / self._
-00007670: 4e5b 642c 2069 5d20 2023 2073 616d 706c  N[d, i]  # sampl
-00007680: 696e 6720 706f 696e 7473 2069 2e65 2e20  ing points i.e. 
-00007690: 6e6f 726d 616c 697a 6564 2074 696d 6520  normalized time 
-000076a0: 636f 6f72 6469 6e61 7465 730d 0a20 2020  coordinates..   
-000076b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076c0: 2023 2074 203d 206e 202f 2034 2069 6620   # t = n / 4 if 
-000076d0: 4e5b 642c 206b 5d20 3d3d 2032 2065 6c73  N[d, k] == 2 els
-000076e0: 6520 6e20 2f20 4e5b 642c 206b 5d20 2023  e n / N[d, k]  #
-000076f0: 2074 6f64 6f3a 2076 6172 6961 626c 652f   todo: variable/
-00007700: 696e 6469 7669 6475 616c 2074 2061 7320  individual t as 
-00007710: 696e 2055 6e69 2d50 5341 2d47 656e 0d0a  in Uni-PSA-Gen..
-00007720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007730: 2020 2020 6320 3d20 6e70 2e65 7870 2831      c = np.exp(1
-00007740: 6a20 2a20 3220 2a20 6e70 2e70 6920 2a20  j * 2 * np.pi * 
-00007750: 7365 6c66 2e5f 665b 642c 2069 5d20 2a20  self._f[d, i] * 
-00007760: 7429 0d0a 2020 2020 2020 2020 2020 2020  t)..            
-00007770: 2020 2020 2020 2020 7a20 3d20 6e70 2e73          z = np.s
-00007780: 756d 2863 5b3a 2c20 4e6f 6e65 2c20 4e6f  um(c[:, None, No
-00007790: 6e65 2c20 4e6f 6e65 5d20 2a20 495b 7469  ne, None] * I[ti
-000077a0: 5b64 2c20 695d 203a 2074 695b 642c 2069  [d, i] : ti[d, i
-000077b0: 202b 2031 5d5d 2c20 6178 6973 3d30 290d   + 1]], axis=0).
-000077c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000077d0: 2020 2020 2042 5b64 5d20 3d20 6e70 2e61       B[d] = np.a
-000077e0: 6273 287a 2920 2f20 7365 6c66 2e5f 4e5b  bs(z) / self._N[
-000077f0: 642c 2069 5d20 2a20 320d 0a20 2020 2020  d, i] * 2..     
-00007800: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00007810: 5b64 2c20 695d 203d 206e 702e 616e 676c  [d, i] = np.angl
-00007820: 6528 7a29 0d0a 2020 2020 2020 2020 2020  e(z)..          
-00007830: 2020 2020 2020 2020 2020 2320 705b 642c            # p[d,
-00007840: 2069 5d20 3d20 6e70 2e61 7263 7461 6e32   i] = np.arctan2
-00007850: 287a 2e69 6d61 672c 207a 2e72 6561 6c29  (z.imag, z.real)
-00007860: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00007870: 2020 2020 6966 2073 656c 662e 7665 7262      if self.verb
-00007880: 6f73 6520 6f72 2076 6572 626f 7365 3a0d  ose or verbose:.
-00007890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000078a0: 2020 2020 2064 6172 6b20 3d20 7365 6c66       dark = self
-000078b0: 2e67 6169 6e20 2a20 7365 6c66 2e64 6172  .gain * self.dar
-000078c0: 6b0d 0a20 2020 2020 2020 2020 2020 2020  k..             
-000078d0: 2020 2020 2020 2071 7561 6e74 203d 2030         quant = 0
-000078e0: 2069 6620 7365 6c66 2e64 6172 6b20 3e20   if self.dark > 
-000078f0: 3020 656c 7365 2073 656c 662e 7175 616e  0 else self.quan
-00007900: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
-00007910: 2020 2020 2020 2073 686f 7420 3d20 6e70         shot = np
-00007920: 2e73 7172 7428 7365 6c66 2e67 6169 6e20  .sqrt(self.gain 
-00007930: 2a20 6e70 2e6d 6178 696d 756d 2830 2c20  * np.maximum(0, 
-00007940: 415b 645d 202d 2073 656c 662e 7930 2929  A[d] - self.y0))
-00007950: 2069 6620 7365 6c66 2e67 6169 6e20 213d   if self.gain !=
-00007960: 2030 2065 6c73 6520 300d 0a20 2020 2020   0 else 0..     
-00007970: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00007980: 6920 3d20 6e70 2e73 7172 7428 6461 726b  i = np.sqrt(dark
-00007990: 2a2a 3220 2b20 7175 616e 742a 2a32 202b  **2 + quant**2 +
-000079a0: 2073 686f 742a 2a32 2920 2023 2069 6e74   shot**2)  # int
-000079b0: 656e 7369 7479 206e 6f69 7365 0d0a 2020  ensity noise..  
-000079c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079d0: 2020 534e 5220 3d20 425b 645d 202f 2075    SNR = B[d] / u
-000079e0: 690d 0a20 2020 2020 2020 2020 2020 2020  i..             
-000079f0: 2020 2020 2020 2075 7069 203d 2028 0d0a         upi = (..
-00007a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a10: 2020 2020 2020 2020 6e70 2e73 7172 7428          np.sqrt(
-00007a20: 3229 202f 206e 702e 7371 7274 2873 656c  2) / np.sqrt(sel
-00007a30: 662e 4d29 202f 206e 702e 7371 7274 2873  f.M) / np.sqrt(s
-00007a40: 656c 662e 5f4e 5b64 2c20 3a2c 204e 6f6e  elf._N[d, :, Non
-00007a50: 652c 204e 6f6e 652c 204e 6f6e 655d 2920  e, None, None]) 
-00007a60: 2f20 534e 520d 0a20 2020 2020 2020 2020  / SNR..         
-00007a70: 2020 2020 2020 2020 2020 2029 2020 2320             )  # 
-00007a80: 6c6f 6361 6c20 7068 6173 6520 756e 6365  local phase unce
-00007a90: 7274 6169 6e74 6965 7320 2023 2074 6f64  rtainties  # tod
-00007aa0: 6f3a 204d 0d0a 2020 2020 2020 2020 2020  o: M..          
-00007ab0: 2020 2020 2020 2020 2020 7570 696e 203d            upin =
-00007ac0: 2075 7069 202f 2028 3220 2a20 6e70 2e70   upi / (2 * np.p
-00007ad0: 6929 2020 2320 6e6f 726d 616c 697a 6564  i)  # normalized
-00007ae0: 206c 6f63 616c 2070 6861 7365 2075 6e63   local phase unc
-00007af0: 6572 7461 696e 7469 6573 0d0a 2020 2020  ertainties..    
-00007b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b10: 7578 6920 3d20 7570 696e 202a 2073 656c  uxi = upin * sel
-00007b20: 662e 5f6c 5b64 2c20 3a2c 204e 6f6e 652c  f._l[d, :, None,
-00007b30: 204e 6f6e 652c 204e 6f6e 655d 2020 2320   None, None]  # 
-00007b40: 6c6f 6361 6c20 706f 7369 7469 6f6e 616c  local positional
-00007b50: 2075 6e63 6572 7461 696e 7469 6573 0d0a   uncertainties..
-00007b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b70: 2020 2020 7578 203d 206e 702e 7371 7274      ux = np.sqrt
-00007b80: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00007b90: 2020 2020 2020 2020 2020 2031 202f 206e             1 / n
-00007ba0: 702e 7375 6d28 3120 2f20 7578 692a 2a32  p.sum(1 / uxi**2
-00007bb0: 2c20 6178 6973 3d30 290d 0a20 2020 2020  , axis=0)..     
-00007bc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00007bd0: 2020 2320 676c 6f62 616c 2070 6f73 6974    # global posit
-00007be0: 696f 6e61 6c20 756e 6365 7274 6169 6e74  ional uncertaint
-00007bf0: 7920 2862 7920 696e 7665 7273 6520 7661  y (by inverse va
-00007c00: 7269 616e 6365 2077 6569 6768 7469 6e67  riance weighting
-00007c10: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00007c20: 2020 2020 2020 2075 5b64 5d20 3d20 7578         u[d] = ux
-00007c30: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00007c40: 2020 2020 2020 2020 2320 2320 746f 646f          # # todo
-00007c50: 3a20 206e 702e 7365 7465 7272 2869 6e76  :  np.seterr(inv
-00007c60: 616c 6964 3d27 6967 6e6f 7265 2729 0d0a  alid='ignore')..
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c80: 2020 2020 2320 5620 3d20 2842 2e72 6573      # V = (B.res
-00007c90: 6861 7065 2873 656c 662e 442c 2073 656c  hape(self.D, sel
-00007ca0: 662e 4b2c 2059 2c20 582c 2043 2920 2f20  f.K, Y, X, C) / 
-00007cb0: 415b 3a2c 204e 6f6e 652c 203a 2c20 3a2c  A[:, None, :, :,
-00007cc0: 203a 5d29 2e72 6573 6861 7065 2873 656c   :]).reshape(sel
-00007cd0: 662e 4420 2a20 7365 6c66 2e4b 2c20 592c  f.D * self.K, Y,
-00007ce0: 2058 2c20 4329 0d0a 2020 2020 2020 2020   X, C)..        
-00007cf0: 2020 2020 2020 2020 2020 2020 2320 6966              # if
-00007d00: 2049 2e64 7479 7065 2e6b 696e 6420 696e   I.dtype.kind in
-00007d10: 2022 7569 223a 0d0a 2020 2020 2020 2020   "ui":..        
-00007d20: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00007d30: 2020 6966 206e 702e 6969 6e66 6f28 492e    if np.iinfo(I.
-00007d40: 6474 7970 6529 2e62 6974 7320 3e20 383a  dtype).bits > 8:
-00007d50: 2020 2320 6461 7461 206d 6179 2063 6f6e    # data may con
-00007d60: 7461 696e 2066 6577 6572 2062 6974 7320  tain fewer bits 
-00007d70: 6f66 2069 6e66 6f72 6d61 7469 6f6e 0d0a  of information..
-00007d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d90: 2020 2020 2320 2020 2020 2020 2020 496d      #         Im
-00007da0: 6178 203d 2069 6e74 286e 702e 6365 696c  ax = int(np.ceil
-00007db0: 286e 702e 6c6f 6732 2849 2e6d 6178 2829  (np.log2(I.max()
-00007dc0: 2929 2920 2023 2073 616d 6520 6f72 206e  )))  # same or n
-00007dd0: 6578 7420 706f 7765 7220 6f66 2074 776f  ext power of two
-00007de0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007df0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-00007e00: 496d 6178 202b 3d20 2d49 6d61 7820 2520  Imax += -Imax % 
-00007e10: 3220 2023 2073 616d 6520 6f72 206e 6578  2  # same or nex
-00007e20: 7420 706f 7765 7220 6f66 2074 776f 2064  t power of two d
-00007e30: 6976 6973 6962 6c65 2062 7920 7477 6f0d  ivisible by two.
-00007e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007e50: 2020 2020 2023 2020 2020 2065 6c73 653a       #     else:
-00007e60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007e70: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-00007e80: 496d 6178 203d 206e 702e 6969 6e66 6f28  Imax = np.iinfo(
-00007e90: 492e 6474 7970 6529 2e6d 6178 0d0a 2020  I.dtype).max..  
-00007ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007eb0: 2020 2320 656c 7365 3a20 2023 2066 6c6f    # else:  # flo
-00007ec0: 6174 0d0a 2020 2020 2020 2020 2020 2020  at..            
-00007ed0: 2020 2020 2020 2020 2320 2020 2020 496d          #     Im
-00007ee0: 6178 203d 2031 0d0a 2020 2020 2020 2020  ax = 1..        
-00007ef0: 2020 2020 2020 2020 2020 2020 2320 6220              # b 
-00007f00: 3d20 4120 2f20 496d 6178 0d0a 0d0a 2020  = A / Imax....  
-00007f10: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00007f20: 2073 656c 662e 4b20 3d3d 2031 3a0d 0a20   self.K == 1:.. 
-00007f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f40: 2020 2069 6620 7365 6c66 2e5f 765b 642c     if self._v[d,
-00007f50: 2030 5d20 3d3d 2030 3a20 2023 206e 6f20   0] == 0:  # no 
-00007f60: 7370 6174 6961 6c20 6d6f 6475 6c61 7469  spatial modulati
-00007f70: 6f6e 0d0a 2020 2020 2020 2020 2020 2020  on..            
-00007f80: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00007f90: 656c 662e 525b 645d 203d 3d20 313a 0d0a  elf.R[d] == 1:..
-00007fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fb0: 2020 2020 2020 2020 2020 2020 2320 6974              # it
-00007fc0: 206d 616b 6573 206e 6f20 7365 6e73 6520   makes no sense 
-00007fd0: 746f 2065 6e63 6f64 6520 6f6e 6c79 206f  to encode only o
-00007fe0: 6e65 2073 696e 676c 6520 636f 6f72 6469  ne single coordi
-00007ff0: 6e61 7465 0d0a 2020 2020 2020 2020 2020  nate..          
-00008000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008010: 2020 785b 645d 203d 2030 2020 2320 7468    x[d] = 0  # th
-00008020: 6520 6f6e 6c79 2070 6f73 7369 626c 6520  e only possible 
-00008030: 7661 6c75 650d 0a20 2020 2020 2020 2020  value..         
-00008040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008050: 2020 2069 6620 7365 6c66 2e76 6572 626f     if self.verbo
-00008060: 7365 206f 7220 7665 7262 6f73 653a 0d0a  se or verbose:..
-00008070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008090: 725b 645d 203d 2030 0d0a 2020 2020 2020  r[d] = 0..      
-000080a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080b0: 2020 2020 2020 2020 2020 6b5b 645d 203d            k[d] =
-000080c0: 2030 0d0a 2020 2020 2020 2020 2020 2020   0..            
-000080d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000080e0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000080f0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-00008100: 5b64 5d20 3d20 6e70 2e6e 616e 2020 2320  [d] = np.nan  # 
-00008110: 6e6f 2073 7061 7469 616c 206d 6f64 756c  no spatial modul
-00008120: 6174 696f 6e2c 2074 6865 7265 666f 7265  ation, therefore
-00008130: 2077 6520 6361 6e27 7420 6465 7465 726d   we can't determ
-00008140: 696e 6520 6120 7661 6c75 650d 0a20 2020  ine a value..   
+00004e00: 2076 616c 203d 2076 616c 203e 3d20 302e   val = val >= 0.
+00004e10: 350d 0a0d 0a20 2020 2020 2020 2020 2020  5....           
+00004e20: 2020 2020 2020 2020 2020 2020 2049 5b69               I[i
+00004e30: 6478 5d20 3d20 7661 6c0d 0a0d 0a20 2020  dx] = val....   
+00004e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e50: 2020 2020 2069 6478 202b 3d20 310d 0a20       idx += 1.. 
+00004e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e70: 2020 2066 7261 6d65 202b 3d20 310d 0a0d     frame += 1...
+00004e80: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00004e90: 2e64 6562 7567 2866 227b 3130 3030 202a  .debug(f"{1000 *
+00004ea0: 2028 7469 6d65 2e70 6572 665f 636f 756e   (time.perf_coun
+00004eb0: 7465 7228 2920 2d20 7430 297d 6d73 2229  ter() - t0)}ms")
+00004ec0: 0d0a 0d0a 2020 2020 2020 2020 7265 7475  ....        retu
+00004ed0: 726e 2049 2e72 6573 6861 7065 282d 312c  rn I.reshape(-1,
+00004ee0: 2059 2c20 582c 2031 290d 0a0d 0a20 2020   Y, X, 1)....   
+00004ef0: 2064 6566 205f 6465 6d6f 6475 6c61 7465   def _demodulate
+00004f00: 280d 0a20 2020 2020 2020 2073 656c 662c  (..        self,
+00004f10: 2049 3a20 6e70 2e6e 6461 7272 6179 2c20   I: np.ndarray, 
+00004f20: 7665 7262 6f73 653a 2062 6f6f 6c20 3d20  verbose: bool = 
+00004f30: 4661 6c73 652c 2066 756e 633a 2073 7472  False, func: str
+00004f40: 203d 2022 736b 6922 0d0a 2020 2020 2920   = "ski"..    ) 
+00004f50: 2d3e 2028 6e70 2e6e 6461 7272 6179 2c20  -> (np.ndarray, 
+00004f60: 6e70 2e6e 6461 7272 6179 2c20 6e70 2e6e  np.ndarray, np.n
+00004f70: 6461 7272 6179 2c20 6e70 2e6e 6461 7272  darray, np.ndarr
+00004f80: 6179 2c20 6e70 2e6e 6461 7272 6179 293a  ay, np.ndarray):
+00004f90: 0d0a 2020 2020 2020 2020 2222 2244 6563  ..        """Dec
+00004fa0: 6f64 6520 6261 7365 2066 7269 6e67 6520  ode base fringe 
+00004fb0: 7061 7474 6572 6e73 2062 7920 7370 6174  patterns by spat
+00004fc0: 696f 2d74 656d 706f 7261 6c20 6465 6d6f  io-temporal demo
+00004fd0: 6475 6c61 7469 6f6e 2e0d 0a0d 0a20 2020  dulation.....   
+00004fe0: 2020 2020 2050 6172 616d 6574 6572 730d       Parameters.
+00004ff0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00005000: 2d2d 2d0d 0a20 2020 2020 2020 2049 203a  ---..        I :
+00005010: 206e 702e 6e64 6172 7261 790d 0a20 2020   np.ndarray..   
+00005020: 2020 2020 2020 2020 2046 7269 6e67 6520           Fringe 
+00005030: 7061 7474 6572 6e20 7365 7175 656e 6365  pattern sequence
+00005040: 2e0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
+00005050: 7420 6973 2072 6573 6861 7065 6420 746f  t is reshaped to
+00005060: 2076 6964 656f 7368 6170 6520 2866 7261   videoshape (fra
+00005070: 6d65 7320 6054 602c 2068 6569 6768 7420  mes `T`, height 
+00005080: 6059 602c 2077 6964 7468 2060 5860 2c20  `Y`, width `X`, 
+00005090: 636f 6c6f 7220 6368 616e 6e65 6c73 2060  color channels `
+000050a0: 4360 2920 6265 666f 7265 2070 726f 6365  C`) before proce
+000050b0: 7373 696e 672e 0d0a 0d0a 2020 2020 2020  ssing.....      
+000050c0: 2020 7665 7262 6f73 6520 3a20 626f 6f6c    verbose : bool
+000050d0: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
+000050e0: 2020 2020 2020 2020 4966 2074 6869 7320          If this 
+000050f0: 6f72 2074 6865 2061 7267 756d 656e 7420  or the argument 
+00005100: 6076 6572 626f 7365 6020 6f66 2074 6865  `verbose` of the
+00005110: 2046 7269 6e67 6573 2069 6e73 7461 6e63   Fringes instanc
+00005120: 6520 6973 2073 6574 2074 6f20 5472 7565  e is set to True
+00005130: 2c0d 0a20 2020 2020 2020 2020 2020 2061  ,..            a
+00005140: 6464 6974 696f 6e61 6c20 696e 666f 6d61  dditional infoma
+00005150: 7469 6f6e 2069 7320 636f 6d70 7574 6564  tion is computed
+00005160: 2061 6e64 2072 6574 756e 6564 2e0d 0a20   and retuned... 
+00005170: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+00005180: 696e 636c 7564 6573 3a20 7068 6173 6520  includes: phase 
+00005190: 6d61 7073 2c20 7265 7369 6475 616c 732c  maps, residuals,
+000051a0: 2066 7269 6e67 6520 6f72 6465 7273 2c20   fringe orders, 
+000051b0: 7669 7369 6269 6c69 7479 2061 6e64 2072  visibility and r
+000051c0: 656c 6174 6976 6520 6578 706f 7375 7265  elative exposure
+000051d0: 2e0d 0a0d 0a20 2020 2020 2020 2066 756e  .....        fun
+000051e0: 6320 3a20 7374 722c 206f 7074 696f 6e61  c : str, optiona
+000051f0: 6c0d 0a20 2020 2020 2020 2020 2020 2055  l..            U
+00005200: 6e77 7261 7070 696e 6720 6675 6e63 7469  nwrapping functi
+00005210: 6f6e 2074 6f20 7573 652e 2054 6865 2064  on to use. The d
+00005220: 6566 6175 6c74 2069 7320 2773 6b69 272e  efault is 'ski'.
+00005230: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00005240: 2d20 2773 6b69 273a 2060 5363 696b 6974  - 'ski': `Scikit
+00005250: 2d69 6d61 6765 203c 6874 7470 733a 2f2f  -image <https://
+00005260: 7363 696b 6974 2d69 6d61 6765 2e6f 7267  scikit-image.org
+00005270: 2f64 6f63 732f 7374 6162 6c65 2f61 7574  /docs/stable/aut
+00005280: 6f5f 6578 616d 706c 6573 2f66 696c 7465  o_examples/filte
+00005290: 7273 2f70 6c6f 745f 7068 6173 655f 756e  rs/plot_phase_un
+000052a0: 7772 6170 2e68 746d 6c3e 605f 0d0a 0d0a  wrap.html>`_....
+000052b0: 2020 2020 2020 2020 2020 2020 2d20 656c              - el
+000052c0: 7365 3a20 604f 7065 6e43 5620 6874 7470  se: `OpenCV http
+000052d0: 733a 2f2f 646f 6373 2e6f 7065 6e63 762e  s://docs.opencv.
+000052e0: 6f72 672f 342e 372e 302f 6466 2f64 3361  org/4.7.0/df/d3a
+000052f0: 2f67 726f 7570 5f5f 7068 6173 655f 5f75  /group__phase__u
+00005300: 6e77 7261 7070 696e 672e 6874 6d6c 3e60  nwrapping.html>`
+00005310: 5f0d 0a0d 0a20 2020 2020 2020 2052 6574  _....        Ret
+00005320: 7572 6e73 0d0a 2020 2020 2020 2020 2d2d  urns..        --
+00005330: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2062  -----..        b
+00005340: 7269 6768 746e 6573 7320 3a20 6e70 2e6e  rightness : np.n
+00005350: 6461 7272 6179 0d0a 2020 2020 2020 2020  darray..        
+00005360: 2020 2020 4c6f 6361 6c20 6261 636b 6772      Local backgr
+00005370: 6f75 6e64 2073 6967 6e61 6c2e 0d0a 0d0a  ound signal.....
+00005380: 2020 2020 2020 2020 6d6f 6475 6c61 7469          modulati
+00005390: 6f6e 203a 206e 702e 6e64 6172 7261 790d  on : np.ndarray.
+000053a0: 0a20 2020 2020 2020 2020 2020 204c 6f63  .            Loc
+000053b0: 616c 2061 6d70 6c69 7475 6465 206f 6620  al amplitude of 
+000053c0: 7468 6520 636f 7369 6e65 2073 6967 6e61  the cosine signa
+000053d0: 6c2e 0d0a 0d0a 2020 2020 2020 2020 7265  l.....        re
+000053e0: 6769 7374 7261 7469 6f6e 203a 206e 702e  gistration : np.
+000053f0: 6e64 6172 7261 790d 0a20 2020 2020 2020  ndarray..       
+00005400: 2020 2020 2044 6563 6f64 6564 2063 6f6f       Decoded coo
+00005410: 7264 696e 6174 6573 2e0d 0a0d 0a20 2020  rdinates.....   
+00005420: 2020 2020 2020 2020 202e 2e20 6e6f 7465           .. note
+00005430: 3a3a 2054 6865 2072 6567 6973 7472 6174  :: The registrat
+00005440: 696f 6e20 6973 2061 206d 6170 7069 6e67  ion is a mapping
+00005450: 2069 6e20 7468 6520 7361 6d65 2070 6978   in the same pix
+00005460: 656c 2067 7269 6420 6173 2074 6865 2063  el grid as the c
+00005470: 616d 6572 6120 7365 6e73 6f72 0d0a 2020  amera sensor..  
+00005480: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00005490: 636f 6e74 6169 6e73 2074 6865 2069 6e66  contains the inf
+000054a0: 6f72 6d61 7469 6f6e 2077 6865 7265 2065  ormation where e
+000054b0: 6163 6820 6361 6d65 7261 2070 6978 656c  ach camera pixel
+000054c0: 2c20 692e 652e 2065 6163 6820 6361 6d65  , i.e. each came
+000054d0: 7261 2073 6967 6874 7261 792c 0d0a 2020  ra sightray,..  
+000054e0: 2020 2020 2020 2020 2020 2020 7761 7320              was 
+000054f0: 6c6f 6f6b 696e 6720 6174 2064 7572 696e  looking at durin
+00005500: 6720 7468 6520 6672 696e 6765 2070 6174  g the fringe pat
+00005510: 7465 726e 2061 6371 7569 7369 7469 6f6e  tern acquisition
+00005520: 2e0d 0a0d 0a20 2020 2020 2020 2072 6573  .....        res
+00005530: 6964 7561 6c73 203a 206e 702e 6e64 6172  iduals : np.ndar
+00005540: 7261 792c 206f 7074 696f 6e61 6c0d 0a20  ray, optional.. 
+00005550: 2020 2020 2020 2020 2020 2052 6573 6964             Resid
+00005560: 7561 6c73 2066 726f 6d20 7468 6520 6f70  uals from the op
+00005570: 7469 6d69 7a61 7469 6f6e 2d62 6173 6564  timization-based
+00005580: 2075 6e77 7261 7070 696e 6720 7072 6f63   unwrapping proc
+00005590: 6573 732e 0d0a 0d0a 2020 2020 2020 2020  ess.....        
+000055a0: 7068 6173 6520 3a20 6e70 2e6e 6461 7272  phase : np.ndarr
+000055b0: 6179 2c20 6f70 7469 6f6e 616c 0d0a 2020  ay, optional..  
+000055c0: 2020 2020 2020 2020 2020 4c6f 6361 6c20            Local 
+000055d0: 7068 6173 652e 0d0a 2020 2020 2020 2020  phase...        
+000055e0: 2222 220d 0a0d 0a20 2020 2020 2020 2074  """....        t
+000055f0: 3020 3d20 7469 6d65 2e70 6572 665f 636f  0 = time.perf_co
+00005600: 756e 7465 7228 290d 0a0d 0a20 2020 2020  unter()....     
+00005610: 2020 2023 2070 6172 7365 0d0a 2020 2020     # parse..    
+00005620: 2020 2020 542c 2059 2c20 582c 2043 203d      T, Y, X, C =
+00005630: 2076 7368 6170 6528 4929 2e73 6861 7065   vshape(I).shape
+00005640: 2020 2320 6578 7472 6163 7420 592c 2058    # extract Y, X
+00005650: 2c20 4320 6672 6f6d 2064 6174 6120 6173  , C from data as
+00005660: 2074 6865 7365 2070 6172 616d 6574 6572   these parameter
+00005670: 7320 6465 7065 6e64 206f 6e20 7573 6564  s depend on used
+00005680: 2063 616d 6572 610d 0a20 2020 2020 2020   camera..       
+00005690: 2049 203d 2049 2e72 6573 6861 7065 2828   I = I.reshape((
+000056a0: 542c 2059 2c20 582c 2043 2929 0d0a 0d0a  T, Y, X, C))....
+000056b0: 2020 2020 2020 2020 2320 6966 2073 656c          # if sel
+000056c0: 662e 4644 4d3a 0d0a 2020 2020 2020 2020  f.FDM:..        
+000056d0: 2320 2020 2063 203d 206e 702e 6666 742e  #    c = np.fft.
+000056e0: 7266 6674 2849 2c20 6178 6973 3d30 2920  rfft(I, axis=0) 
+000056f0: 2f20 5420 2023 2074 6f64 6f3a 2068 6666  / T  # todo: hff
+00005700: 740d 0a20 2020 2020 2020 2023 0d0a 2020  t..        #..  
+00005710: 2020 2020 2020 2320 2020 2023 2069 6620        #    # if 
+00005720: 6e70 2e61 6e79 2873 656c 662e 5f4e 203e  np.any(self._N >
+00005730: 2032 202a 2073 656c 662e 4420 2a20 7365   2 * self.D * se
+00005740: 6c66 2e4b 293a 2020 2320 3220 2a20 6e70  lf.K):  # 2 * np
+00005750: 2e61 6273 285f 6629 2e6d 6178 2829 202b  .abs(_f).max() +
+00005760: 2031 3a0d 0a20 2020 2020 2020 2023 2020   1:..        #  
+00005770: 2020 2320 2020 2020 6920 3d20 6e70 2e61    #     i = np.a
+00005780: 7070 656e 6428 6e70 2e7a 6572 6f73 2831  ppend(np.zeros(1
+00005790: 2c20 696e 7429 2c20 7365 6c66 2e5f 662e  , int), self._f.
+000057a0: 666c 6174 7465 6e28 292e 6173 7479 7065  flatten().astype
+000057b0: 2869 6e74 2c20 636f 7079 3d46 616c 7365  (int, copy=False
+000057c0: 2929 2020 2320 6164 6420 7030 0d0a 2020  ))  # add p0..  
+000057d0: 2020 2020 2020 2320 2020 2023 2020 2020        #    #    
+000057e0: 2063 203d 2063 5b69 5d0d 0a20 2020 2020   c = c[i]..     
+000057f0: 2020 2023 0d0a 2020 2020 2020 2020 2320     #..        # 
+00005800: 2020 2061 203d 2061 6273 2863 290d 0a20     a = abs(c).. 
+00005810: 2020 2020 2020 2023 2020 2020 2320 6920         #    # i 
+00005820: 3d20 6e70 2e61 7267 736f 7274 2861 5b31  = np.argsort(a[1
+00005830: 3a5d 2c20 6178 6973 3d30 295b 3a3a 2d31  :], axis=0)[::-1
+00005840: 5d20 2023 2069 6e64 6963 6573 206f 6620  ]  # indices of 
+00005850: 6672 6571 7565 6e63 6965 732c 2073 6f72  frequencies, sor
+00005860: 7465 6420 6279 2074 6865 6972 206d 6167  ted by their mag
+00005870: 6e69 7475 6465 0d0a 2020 2020 2020 2020  nitude..        
+00005880: 2320 2020 2070 6869 203d 202d 6e70 2e61  #    phi = -np.a
+00005890: 6e67 6c65 2863 202a 206e 702e 6578 7028  ngle(c * np.exp(
+000058a0: 2d31 6a20 2a20 2873 656c 662e 7030 202d  -1j * (self.p0 -
+000058b0: 206e 702e 7069 2929 295b 5f66 2e66 6c61   np.pi)))[_f.fla
+000058c0: 7474 656e 2829 2e61 7374 7970 6528 696e  tten().astype(in
+000058d0: 742c 2063 6f70 793d 4661 6c73 6529 5d20  t, copy=False)] 
+000058e0: 2023 2074 6f64 6f3a 2077 6879 2070 3020   # todo: why p0 
+000058f0: 2d20 5049 3f3f 3f0d 0a0d 0a20 2020 2020  - PI???....     
+00005900: 2020 2069 6620 7365 6c66 2e75 7772 203d     if self.uwr =
+00005910: 3d20 2246 544d 223a 0d0a 2020 2020 2020  = "FTM":..      
+00005920: 2020 2020 2020 2320 746f 646f 3a20 6d61        # todo: ma
+00005930: 6b65 2070 6173 7362 616e 6420 7379 6d6d  ke passband symm
+00005940: 6574 7269 6361 6c20 6172 6f75 6e64 2063  etrical around c
+00005950: 6172 7269 6572 2066 7265 7175 656e 6379  arrier frequency
+00005960: 3f0d 0a20 2020 2020 2020 2020 2020 2069  ?..            i
+00005970: 6620 7365 6c66 2e44 203d 3d20 323a 0d0a  f self.D == 2:..
+00005980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005990: 6678 203d 206e 702e 6666 742e 6666 7473  fx = np.fft.ffts
+000059a0: 6869 6674 286e 702e 6666 742e 6666 7466  hift(np.fft.fftf
+000059b0: 7265 7128 5829 2920 2023 2074 6f64 6f3a  req(X))  # todo:
+000059c0: 2068 6666 740d 0a20 2020 2020 2020 2020   hfft..         
+000059d0: 2020 2020 2020 2066 7920 3d20 6e70 2e66         fy = np.f
+000059e0: 6674 2e66 6674 7368 6966 7428 6e70 2e66  ft.fftshift(np.f
+000059f0: 6674 2e66 6674 6672 6571 2859 2929 0d0a  ft.fftfreq(Y))..
+00005a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a10: 6678 782c 2066 7979 203d 206e 702e 6d65  fxx, fyy = np.me
+00005a20: 7368 6772 6964 2866 782c 2066 7929 0d0a  shgrid(fx, fy)..
+00005a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a40: 6d78 203d 206e 702e 6162 7328 6678 7829  mx = np.abs(fxx)
+00005a50: 203e 206e 702e 6162 7328 0d0a 2020 2020   > np.abs(..    
+00005a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a70: 6679 790d 0a20 2020 2020 2020 2020 2020  fyy..           
+00005a80: 2020 2020 2029 2020 2320 6d61 736b 2066       )  # mask f
+00005a90: 6f72 2078 2d66 7265 7175 656e 6369 6573  or x-frequencies
+00005aa0: 2020 2320 746f 646f 3a20 6d61 6b65 206c    # todo: make l
+00005ab0: 6566 7420 616e 6420 7269 6768 7420 626f  eft and right bo
+00005ac0: 7264 6572 7320 726f 756e 6420 2873 796d  rders round (sym
+00005ad0: 6d65 7472 6963 616c 2061 726f 756e 6420  metrical around 
+00005ae0: 6261 7365 2062 616e 6429 0d0a 2020 2020  base band)..    
+00005af0: 2020 2020 2020 2020 2020 2020 6d79 203d              my =
+00005b00: 206e 702e 6162 7328 6678 7829 203c 206e   np.abs(fxx) < n
+00005b10: 702e 6162 7328 0d0a 2020 2020 2020 2020  p.abs(..        
+00005b20: 2020 2020 2020 2020 2020 2020 6679 790d              fyy.
+00005b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005b40: 2029 2020 2320 6d61 736b 2066 6f72 2079   )  # mask for y
+00005b50: 2d66 7265 7175 656e 6369 6573 2020 2320  -frequencies  # 
+00005b60: 746f 646f 3a20 6d61 6b65 206c 6f77 6572  todo: make lower
+00005b70: 2061 6e64 2075 7070 6572 2062 6f72 6465   and upper borde
+00005b80: 7273 2072 6f75 6e64 2028 7379 6d6d 6574  rs round (symmet
+00005b90: 7269 6361 6c20 6172 6f75 6e64 2062 6173  rical around bas
+00005ba0: 6520 6261 6e64 290d 0a0d 0a20 2020 2020  e band)....     
+00005bb0: 2020 2020 2020 2020 2020 2057 203d 2031             W = 1
+00005bc0: 3030 2020 2320 6173 7375 6d65 2077 696e  00  # assume win
+00005bd0: 646f 7720 7769 6474 6820 666f 7220 6669  dow width for fi
+00005be0: 6c74 6572 696e 6720 6f75 7420 6261 7365  ltering out base
+00005bf0: 6261 6e64 0d0a 2020 2020 2020 2020 2020  band..          
+00005c00: 2020 2020 2020 5720 3d20 6d69 6e28 6d61        W = min(ma
+00005c10: 7828 332c 2057 292c 206d 696e 2858 2c20  x(3, W), min(X, 
+00005c20: 5929 202f 2032 3029 2020 2320 636c 6970  Y) / 20)  # clip
+00005c30: 2074 6f20 656e 7375 7265 2070 6c61 7573   to ensure plaus
+00005c40: 6962 6c65 2076 616c 7565 0d0a 2020 2020  ible value..    
+00005c50: 2020 2020 2020 2020 2020 2020 6120 3d20              a = 
+00005c60: 696e 7428 6d69 6e28 6d61 7828 302c 2057  int(min(max(0, W
+00005c70: 292c 2058 202f 2034 2920 2b20 302e 3529  ), X / 4) + 0.5)
+00005c80: 2020 2320 746f 646f 3a20 6669 6e64 2067    # todo: find g
+00005c90: 6f6f 6420 7570 7065 7220 6375 7420 6f66  ood upper cut of
+00005ca0: 6620 6672 6571 7565 6e63 790d 0a20 2020  f frequency..   
+00005cb0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+00005cc0: 203d 2058 202f 2f20 340d 0a20 2020 2020   = X // 4..     
+00005cd0: 2020 2020 2020 2020 2020 206d 785b 3a2c             mx[:,
+00005ce0: 203a 615d 203d 2030 2020 2320 7265 6d6f   :a] = 0  # remo
+00005cf0: 7665 2068 6967 6820 6672 6571 7565 6e63  ve high frequenc
+00005d00: 6965 730d 0a20 2020 2020 2020 2020 2020  ies..           
+00005d10: 2020 2020 2062 203d 2069 6e74 2858 202f       b = int(X /
+00005d20: 2032 202d 2057 202f 2032 202b 2030 2e35   2 - W / 2 + 0.5
+00005d30: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00005d40: 2020 206d 785b 3a2c 2062 3a5d 203d 2030     mx[:, b:] = 0
+00005d50: 2020 2320 7265 6d6f 7665 2062 6173 6562    # remove baseb
+00005d60: 616e 6420 616e 6420 706f 7369 7469 7665  and and positive
+00005d70: 2066 7265 7175 656e 6369 6573 0d0a 0d0a   frequencies....
+00005d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d90: 4820 3d20 3130 3020 2023 2061 7373 756d  H = 100  # assum
+00005da0: 6520 7769 6e64 6f77 2068 6569 6768 7420  e window height 
+00005db0: 666f 7220 6669 6c74 6572 696e 6720 6f75  for filtering ou
+00005dc0: 7420 6261 7365 6261 6e64 0d0a 2020 2020  t baseband..    
+00005dd0: 2020 2020 2020 2020 2020 2020 4820 3d20              H = 
+00005de0: 6d69 6e28 6d61 7828 332c 2048 292c 206d  min(max(3, H), m
+00005df0: 696e 2858 2c20 5929 202f 2032 3029 2020  in(X, Y) / 20)  
+00005e00: 2320 636c 6970 2074 6f20 656e 7375 7265  # clip to ensure
+00005e10: 2070 6c61 7573 6962 6c65 2076 616c 7565   plausible value
+00005e20: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005e30: 2020 6320 3d20 696e 7428 6d69 6e28 6d61    c = int(min(ma
+00005e40: 7828 302c 2048 292c 2059 202f 2034 2920  x(0, H), Y / 4) 
+00005e50: 2b20 302e 3529 2020 2320 746f 646f 3a20  + 0.5)  # todo: 
+00005e60: 6669 6e64 2067 6f6f 6420 7570 7065 7220  find good upper 
+00005e70: 6375 7420 6f66 6620 6672 6571 7565 6e63  cut off frequenc
+00005e80: 790d 0a20 2020 2020 2020 2020 2020 2020  y..             
+00005e90: 2020 2023 2063 203d 2059 202f 2f20 340d     # c = Y // 4.
+00005ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005eb0: 206d 795b 3a63 2c20 3a5d 203d 2030 2020   my[:c, :] = 0  
+00005ec0: 2320 7265 6d6f 7665 2068 6967 6820 6672  # remove high fr
+00005ed0: 6571 7565 6e63 6965 730d 0a20 2020 2020  equencies..     
+00005ee0: 2020 2020 2020 2020 2020 2064 203d 2069             d = i
+00005ef0: 6e74 2859 202f 2032 202d 2048 202f 2032  nt(Y / 2 - H / 2
+00005f00: 202b 2030 2e35 290d 0a20 2020 2020 2020   + 0.5)..       
+00005f10: 2020 2020 2020 2020 206d 795b 643a 2c20           my[d:, 
+00005f20: 3a5d 203d 2030 2020 2320 7265 6d6f 7665  :] = 0  # remove
+00005f30: 2062 6173 6562 616e 6420 616e 6420 706f   baseband and po
+00005f40: 7369 7469 7665 2066 7265 7175 656e 6369  sitive frequenci
+00005f50: 6573 0d0a 0d0a 2020 2020 2020 2020 2020  es....          
+00005f60: 2020 2020 2020 2320 746f 646f 3a20 736d        # todo: sm
+00005f70: 6f6f 7468 2065 6467 6573 206f 6620 6669  ooth edges of fi
+00005f80: 6c74 6572 206d 6173 6b73 2c20 692e 652e  lter masks, i.e.
+00005f90: 206d 616b 6520 7468 656d 2048 616e 6e20   make them Hann 
+00005fa0: 5769 6e64 6f77 730d 0a0d 0a20 2020 2020  Windows....     
+00005fb0: 2020 2020 2020 2020 2020 2069 6620 4320             if C 
+00005fc0: 3e20 313a 0d0a 2020 2020 2020 2020 2020  > 1:..          
+00005fd0: 2020 2020 2020 2020 2020 4920 3d20 495b            I = I[
+00005fe0: 2e2e 2e2c 2030 5d0d 0a20 2020 2020 2020  ..., 0]..       
+00005ff0: 2020 2020 2020 2020 2020 2020 2043 203d               C =
+00006000: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
+00006010: 2020 2020 2020 2020 4920 3d20 492e 7265          I = I.re
+00006020: 7368 6170 6528 2854 2c20 592c 2058 2c20  shape((T, Y, X, 
+00006030: 4329 290d 0a0d 0a20 2020 2020 2020 2020  C))....         
+00006040: 2020 2020 2020 2070 6869 203d 206e 702e         phi = np.
+00006050: 656d 7074 7928 5b73 656c 662e 442c 2059  empty([self.D, Y
+00006060: 2c20 582c 2043 5d2c 206e 702e 666c 6f61  , X, C], np.floa
+00006070: 7433 3229 0d0a 2020 2020 2020 2020 2020  t32)..          
+00006080: 2020 2020 2020 7265 7320 3d20 6e70 2e65        res = np.e
+00006090: 6d70 7479 285b 7365 6c66 2e44 2c20 592c  mpty([self.D, Y,
+000060a0: 2058 2c20 435d 2c20 6e70 2e66 6c6f 6174   X, C], np.float
+000060b0: 3332 290d 0a20 2020 2020 2020 2020 2020  32)..           
+000060c0: 2020 2020 2023 2069 6620 7365 6c66 2e76       # if self.v
+000060d0: 6572 626f 7365 3a0d 0a20 2020 2020 2020  erbose:..       
+000060e0: 2020 2020 2020 2020 2023 2020 2020 2070           #     p
+000060f0: 6869 203d 206e 702e 656d 7074 7928 5b73  hi = np.empty([s
+00006100: 656c 662e 442c 2059 2c20 582c 2043 5d2c  elf.D, Y, X, C],
+00006110: 206e 702e 666c 6f61 7433 3229 0d0a 2020   np.float32)..  
+00006120: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00006130: 2020 2020 7265 7320 3d20 6e70 2e65 6d70      res = np.emp
+00006140: 7479 285b 7365 6c66 2e44 2c20 592c 2058  ty([self.D, Y, X
+00006150: 2c20 435d 2c20 6e70 2e66 6c6f 6174 3332  , C], np.float32
+00006160: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00006170: 2020 2072 6567 203d 206e 702e 656d 7074     reg = np.empt
+00006180: 7928 5b73 656c 662e 442c 2059 2c20 582c  y([self.D, Y, X,
+00006190: 2043 5d2c 206e 702e 666c 6f61 7433 3229   C], np.float32)
+000061a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000061b0: 2020 6272 6920 3d20 6e70 2e65 6d70 7479    bri = np.empty
+000061c0: 285b 7365 6c66 2e44 2c20 592c 2058 2c20  ([self.D, Y, X, 
+000061d0: 435d 2c20 6e70 2e66 6c6f 6174 3332 290d  C], np.float32).
+000061e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000061f0: 206d 6f64 203d 206e 702e 656d 7074 7928   mod = np.empty(
+00006200: 5b73 656c 662e 442c 2059 2c20 582c 2043  [self.D, Y, X, C
+00006210: 5d2c 206e 702e 666c 6f61 7433 3229 0d0a  ], np.float32)..
+00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006230: 6669 6420 3d20 6e70 2e66 756c 6c28 5b73  fid = np.full([s
+00006240: 656c 662e 442c 2059 2c20 582c 2043 5d2c  elf.D, Y, X, C],
+00006250: 206e 702e 6e61 6e2c 206e 702e 666c 6f61   np.nan, np.floa
+00006260: 7433 3229 0d0a 2020 2020 2020 2020 2020  t32)..          
+00006270: 2020 2020 2020 666f 7220 6320 696e 2072        for c in r
+00006280: 616e 6765 2843 293a 0d0a 2020 2020 2020  ange(C):..      
+00006290: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000062a0: 746f 646f 3a20 6866 6674 0d0a 2020 2020  todo: hfft..    
+000062b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062c0: 495f 4646 5420 3d20 6e70 2e66 6674 2e66  I_FFT = np.fft.f
+000062d0: 6674 7368 6966 7428 6e70 2e66 6674 2e66  ftshift(np.fft.f
+000062e0: 6674 3228 495b 302c 202e 2e2e 2c20 635d  ft2(I[0, ..., c]
+000062f0: 2929 0d0a 0d0a 2020 2020 2020 2020 2020  ))....          
+00006300: 2020 2020 2020 2020 2020 495f 4646 545f            I_FFT_
+00006310: 7820 3d20 495f 4646 5420 2a20 6d78 0d0a  x = I_FFT * mx..
+00006320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006330: 2020 2020 6978 792c 2069 7878 203d 206e      ixy, ixx = n
+00006340: 702e 756e 7261 7665 6c5f 696e 6465 7828  p.unravel_index(
+00006350: 495f 4646 545f 782e 6172 676d 6178 2829  I_FFT_x.argmax()
+00006360: 2c20 495f 4646 545f 782e 7368 6170 6529  , I_FFT_x.shape)
+00006370: 2020 2320 6765 7420 696e 6469 6365 7320    # get indices 
+00006380: 6f66 2063 6172 7269 6572 2066 7265 7175  of carrier frequ
+00006390: 656e 6379 0d0a 2020 2020 2020 2020 2020  ency..          
+000063a0: 2020 2020 2020 2020 2020 495f 4646 545f            I_FFT_
+000063b0: 7820 3d20 6e70 2e72 6f6c 6c28 495f 4646  x = np.roll(I_FF
+000063c0: 545f 782c 2058 202f 2f20 3220 2d20 6978  T_x, X // 2 - ix
+000063d0: 782c 2031 2920 2023 206d 6f76 6520 746f  x, 1)  # move to
+000063e0: 2063 656e 7465 720d 0a0d 0a20 2020 2020   center....     
+000063f0: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+00006400: 5f46 4654 5f79 203d 2049 5f46 4654 202a  _FFT_y = I_FFT *
+00006410: 206d 790d 0a20 2020 2020 2020 2020 2020   my..           
+00006420: 2020 2020 2020 2020 2069 7979 2c20 6979           iyy, iy
+00006430: 7820 3d20 6e70 2e75 6e72 6176 656c 5f69  x = np.unravel_i
+00006440: 6e64 6578 2849 5f46 4654 5f79 2e61 7267  ndex(I_FFT_y.arg
+00006450: 6d61 7828 292c 2049 5f46 4654 5f79 2e73  max(), I_FFT_y.s
+00006460: 6861 7065 2920 2023 2067 6574 2069 6e64  hape)  # get ind
+00006470: 6963 6573 206f 6620 6361 7272 6965 7220  ices of carrier 
+00006480: 6672 6571 7565 6e63 790d 0a20 2020 2020  frequency..     
+00006490: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+000064a0: 5f46 4654 5f79 203d 206e 702e 726f 6c6c  _FFT_y = np.roll
+000064b0: 2849 5f46 4654 5f79 2c20 5920 2f2f 2032  (I_FFT_y, Y // 2
+000064c0: 202d 2069 7979 2c20 3029 2020 2320 6d6f   - iyy, 0)  # mo
+000064d0: 7665 2074 6f20 6365 6e74 6572 0d0a 0d0a  ve to center....
+000064e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064f0: 2020 2020 4a78 203d 206e 702e 6666 742e      Jx = np.fft.
+00006500: 6966 6674 3228 6e70 2e66 6674 2e69 6666  ifft2(np.fft.iff
+00006510: 7473 6869 6674 2849 5f46 4654 5f78 2929  tshift(I_FFT_x))
+00006520: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006530: 2020 2020 2020 4a79 203d 206e 702e 6666        Jy = np.ff
+00006540: 742e 6966 6674 3228 6e70 2e66 6674 2e69  t.ifft2(np.fft.i
+00006550: 6666 7473 6869 6674 2849 5f46 4654 5f79  fftshift(I_FFT_y
+00006560: 2929 0d0a 0d0a 2020 2020 2020 2020 2020  ))....          
+00006570: 2020 2020 2020 2020 2020 7265 675b 302c            reg[0,
+00006580: 202e 2e2e 2c20 635d 203d 206e 702e 616e   ..., c] = np.an
+00006590: 676c 6528 4a78 290d 0a20 2020 2020 2020  gle(Jx)..       
+000065a0: 2020 2020 2020 2020 2020 2020 2072 6567               reg
+000065b0: 5b31 2c20 2e2e 2e2c 2063 5d20 3d20 6e70  [1, ..., c] = np
+000065c0: 2e61 6e67 6c65 284a 7929 0d0a 2020 2020  .angle(Jy)..    
+000065d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065e0: 2320 746f 646f 3a20 6272 690d 0a20 2020  # todo: bri..   
+000065f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006600: 206d 6f64 5b30 2c20 2e2e 2e2c 2063 5d20   mod[0, ..., c] 
+00006610: 3d20 6e70 2e61 6273 284a 7829 202a 2032  = np.abs(Jx) * 2
+00006620: 2020 2320 6661 6374 6f72 2032 2062 6563    # factor 2 bec
+00006630: 6175 7365 206f 6e65 2073 6964 6562 616e  ause one sideban
+00006640: 6420 6973 2066 696c 7465 7265 6420 6f75  d is filtered ou
+00006650: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
+00006660: 2020 2020 2020 206d 6f64 5b31 2c20 2e2e         mod[1, ..
+00006670: 2e2c 2063 5d20 3d20 6e70 2e61 6273 284a  ., c] = np.abs(J
+00006680: 7929 202a 2032 2020 2320 6661 6374 6f72  y) * 2  # factor
+00006690: 2032 2062 6563 6175 7365 206f 6e65 2073   2 because one s
+000066a0: 6964 6562 616e 6420 6973 2066 696c 7465  ideband is filte
+000066b0: 7265 6420 6f75 740d 0a20 2020 2020 2020  red out..       
+000066c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000066d0: 7365 6c66 2e76 6572 626f 7365 206f 7220  self.verbose or 
+000066e0: 7665 7262 6f73 653a 0d0a 2020 2020 2020  verbose:..      
+000066f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006700: 2020 7068 695b 302c 202e 2e2e 2c20 635d    phi[0, ..., c]
+00006710: 203d 2072 6567 5b30 2c20 2e2e 2e2c 2063   = reg[0, ..., c
+00006720: 5d0d 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00006730: 2020 2020 2020 2020 2020 2070 6869 5b31             phi[1
+00006740: 2c20 2e2e 2e2c 2063 5d20 3d20 7265 675b  , ..., c] = reg[
+00006750: 312c 202e 2e2e 2c20 635d 0d0a 2020 2020  1, ..., c]..    
+00006760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006770: 2020 2020 7265 735b 302c 202e 2e2e 2c20      res[0, ..., 
+00006780: 635d 203d 206e 702e 6c6f 6728 6e70 2e61  c] = np.log(np.a
+00006790: 6273 2849 5f46 4654 2929 2020 2320 4a20  bs(I_FFT))  # J 
+000067a0: 2023 2074 6f64 6f3a 2068 6666 740d 0a20   # todo: hfft.. 
+000067b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000067c0: 2020 2020 2020 2072 6573 5b31 2c20 2e2e         res[1, ..
+000067d0: 2e2c 2063 5d20 3d20 6e70 2e6c 6f67 286e  ., c] = np.log(n
+000067e0: 702e 6162 7328 495f 4646 5429 2920 2023  p.abs(I_FFT))  #
+000067f0: 204a 0d0a 2020 2020 2020 2020 2020 2020   J..            
+00006800: 2020 2020 2020 2020 2020 2020 2320 746f              # to
+00006810: 646f 3a20 4920 2d20 4a0d 0a20 2020 2020  do: I - J..     
+00006820: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00006830: 2e44 203d 3d20 313a 0d0a 2020 2020 2020  .D == 1:..      
+00006840: 2020 2020 2020 2020 2020 4c20 3d20 6d61            L = ma
+00006850: 7828 582c 2059 290d 0a20 2020 2020 2020  x(X, Y)..       
+00006860: 2020 2020 2020 2020 2066 7820 3d20 6e70           fx = np
+00006870: 2e66 6674 2e66 6674 7368 6966 7428 6e70  .fft.fftshift(np
+00006880: 2e66 6674 2e66 6674 6672 6571 2858 2929  .fft.fftfreq(X))
+00006890: 202a 2058 202a 2059 202f 204c 2020 2320   * X * Y / L  # 
+000068a0: 746f 646f 3a20 6866 6674 0d0a 2020 2020  todo: hfft..    
+000068b0: 2020 2020 2020 2020 2020 2020 6679 203d              fy =
+000068c0: 206e 702e 6666 742e 6666 7473 6869 6674   np.fft.fftshift
+000068d0: 286e 702e 6666 742e 6666 7466 7265 7128  (np.fft.fftfreq(
+000068e0: 5929 2920 2a20 5920 2a20 5820 2f20 4c0d  Y)) * Y * X / L.
+000068f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006900: 2066 7878 2c20 6679 7920 3d20 6e70 2e6d   fxx, fyy = np.m
+00006910: 6573 6867 7269 6428 6678 2c20 6679 290d  eshgrid(fx, fy).
+00006920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006930: 2066 7272 203d 206e 702e 7371 7274 2866   frr = np.sqrt(f
+00006940: 7878 2a2a 3220 2b20 6679 792a 2a32 2920  xx**2 + fyy**2) 
+00006950: 2023 2074 6f64 6f3a 206e 6f72 6d61 6c69   # todo: normali
+00006960: 7a61 7469 6f6e 206f 6620 626f 7468 2064  zation of both d
+00006970: 6972 6563 7469 6f6e 730d 0a0d 0a20 2020  irections....   
+00006980: 2020 2020 2020 2020 2020 2020 206d 7220               mr 
+00006990: 3d20 6672 7220 3c3d 204c 202f 2032 2020  = frr <= L / 2  
+000069a0: 2320 656e 7375 7265 2073 616d 6520 7361  # ensure same sa
+000069b0: 6d70 6c69 6e67 2069 6e20 616c 6c20 6469  mpling in all di
+000069c0: 7265 6374 696f 6e73 0d0a 2020 2020 2020  rections..      
+000069d0: 2020 2020 2020 2020 2020 5720 3d20 3130            W = 10
+000069e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000069f0: 2020 5720 3d20 6d69 6e28 6d61 7828 312c    W = min(max(1,
+00006a00: 2057 202f 2032 292c 204c 202f 2032 3029   W / 2), L / 20)
+00006a10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006a20: 2020 6d72 5b66 7272 203c 2057 5d20 3d20    mr[frr < W] = 
+00006a30: 3020 2023 2072 656d 6f76 6520 6261 7365  0  # remove base
+00006a40: 6261 6e64 0d0a 2020 2020 2020 2020 2020  band..          
+00006a50: 2020 2020 2020 6d72 5b66 7272 203e 204c        mr[frr > L
+00006a60: 202f 2034 5d20 3d20 3020 2023 2072 656d   / 4] = 0  # rem
+00006a70: 6f76 6520 746f 6f20 6869 6768 2066 7265  ove too high fre
+00006a80: 7175 656e 6369 6573 0d0a 0d0a 2020 2020  quencies....    
+00006a90: 2020 2020 2020 2020 2020 2020 6d68 203d              mh =
+00006aa0: 206e 702e 656d 7074 7928 5b59 2c20 585d   np.empty([Y, X]
+00006ab0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00006ac0: 2020 206d 685b 3a2c 203a 2058 202f 2f20     mh[:, : X // 
+00006ad0: 325d 203d 2031 0d0a 2020 2020 2020 2020  2] = 1..        
+00006ae0: 2020 2020 2020 2020 6d68 5b3a 2c20 5820          mh[:, X 
+00006af0: 2f2f 2032 203a 5d20 3d20 300d 0a0d 0a20  // 2 :] = 0.... 
+00006b00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00006b10: 6620 4320 3e20 313a 0d0a 2020 2020 2020  f C > 1:..      
+00006b20: 2020 2020 2020 2020 2020 2020 2020 4920                I 
+00006b30: 3d20 495b 2e2e 2e2c 2030 5d0d 0a20 2020  = I[..., 0]..   
+00006b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b50: 2043 203d 2031 0d0a 2020 2020 2020 2020   C = 1..        
+00006b60: 2020 2020 2020 2020 2020 2020 4920 3d20              I = 
+00006b70: 492e 7265 7368 6170 6528 2854 2c20 592c  I.reshape((T, Y,
+00006b80: 2058 2c20 4329 290d 0a0d 0a20 2020 2020   X, C))....     
+00006b90: 2020 2020 2020 2020 2020 2070 6869 203d             phi =
+00006ba0: 206e 702e 656d 7074 7928 5b73 656c 662e   np.empty([self.
+00006bb0: 442c 2059 2c20 582c 2043 5d2c 206e 702e  D, Y, X, C], np.
+00006bc0: 666c 6f61 7433 3229 0d0a 2020 2020 2020  float32)..      
+00006bd0: 2020 2020 2020 2020 2020 7265 7320 3d20            res = 
+00006be0: 6e70 2e65 6d70 7479 285b 7365 6c66 2e44  np.empty([self.D
+00006bf0: 2c20 592c 2058 2c20 435d 2c20 6e70 2e66  , Y, X, C], np.f
+00006c00: 6c6f 6174 3332 290d 0a20 2020 2020 2020  loat32)..       
+00006c10: 2020 2020 2020 2020 2066 6964 203d 206e           fid = n
+00006c20: 702e 6675 6c6c 285b 7365 6c66 2e44 2c20  p.full([self.D, 
+00006c30: 592c 2058 2c20 435d 2c20 6e70 2e6e 616e  Y, X, C], np.nan
+00006c40: 2c20 6e70 2e66 6c6f 6174 3332 290d 0a20  , np.float32).. 
+00006c50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006c60: 6567 203d 206e 702e 656d 7074 7928 5b73  eg = np.empty([s
+00006c70: 656c 662e 442c 2059 2c20 582c 2043 5d2c  elf.D, Y, X, C],
+00006c80: 206e 702e 666c 6f61 7433 3229 0d0a 2020   np.float32)..  
+00006c90: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00006ca0: 6920 3d20 6e70 2e65 6d70 7479 285b 7365  i = np.empty([se
+00006cb0: 6c66 2e44 2c20 592c 2058 2c20 435d 2c20  lf.D, Y, X, C], 
+00006cc0: 6e70 2e66 6c6f 6174 3332 290d 0a20 2020  np.float32)..   
+00006cd0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00006ce0: 203d 206e 702e 656d 7074 7928 5b73 656c   = np.empty([sel
+00006cf0: 662e 442c 2059 2c20 582c 2043 5d2c 206e  f.D, Y, X, C], n
+00006d00: 702e 666c 6f61 7433 3229 0d0a 2020 2020  p.float32)..    
+00006d10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00006d20: 6320 696e 2072 616e 6765 2843 293a 0d0a  c in range(C):..
+00006d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d40: 2020 2020 2320 746f 646f 3a20 6866 6674      # todo: hfft
+00006d50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006d60: 2020 2020 2020 495f 4646 5420 3d20 6e70        I_FFT = np
+00006d70: 2e66 6674 2e66 6674 7368 6966 7428 6e70  .fft.fftshift(np
+00006d80: 2e66 6674 2e66 6674 3228 495b 302c 202e  .fft.fft2(I[0, .
+00006d90: 2e2e 2c20 635d 2929 0d0a 0d0a 2020 2020  .., c]))....    
+00006da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006db0: 495f 4646 545f 7220 3d20 495f 4646 5420  I_FFT_r = I_FFT 
+00006dc0: 2a20 6d72 0d0a 2020 2020 2020 2020 2020  * mr..          
+00006dd0: 2020 2020 2020 2020 2020 6979 2c20 6978            iy, ix
+00006de0: 203d 206e 702e 756e 7261 7665 6c5f 696e   = np.unravel_in
+00006df0: 6465 7828 495f 4646 545f 722e 6e61 6e61  dex(I_FFT_r.nana
+00006e00: 7267 6d61 7828 292c 2049 5f46 4654 5f72  rgmax(), I_FFT_r
+00006e10: 2e73 6861 7065 2920 2023 2067 6574 2069  .shape)  # get i
+00006e20: 6e64 6963 6573 206f 6620 6361 7272 6965  ndices of carrie
+00006e30: 7220 6672 6571 7565 6e63 790d 0a20 2020  r frequency..   
+00006e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e50: 2079 2c20 7820 3d20 5920 2f20 3220 2d20   y, x = Y / 2 - 
+00006e60: 6979 2c20 5820 2f20 3220 2d20 6978 0d0a  iy, X / 2 - ix..
+00006e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e80: 2020 2020 6120 3d20 6e70 2e64 6567 7265      a = np.degre
+00006e90: 6573 286e 702e 6172 6374 616e 3228 792c  es(np.arctan2(y,
+00006ea0: 2078 2929 0d0a 2020 2020 2020 2020 2020   x))..          
+00006eb0: 2020 2020 2020 2020 2020 6d68 7220 3d20            mhr = 
+00006ec0: 7370 2e6e 6469 6d61 6765 2e72 6f74 6174  sp.ndimage.rotat
+00006ed0: 6528 6d68 2c20 612c 2072 6573 6861 7065  e(mh, a, reshape
+00006ee0: 3d46 616c 7365 2c20 6f72 6465 723d 302c  =False, order=0,
+00006ef0: 206d 6f64 653d 226e 6561 7265 7374 2229   mode="nearest")
+00006f00: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00006f10: 2020 2020 2020 2020 495f 4646 545f 7220          I_FFT_r 
+00006f20: 2a3d 206d 6872 2020 2320 7265 6d6f 7665  *= mhr  # remove
+00006f30: 206f 6e65 2073 6964 6562 616e 640d 0a20   one sideband.. 
+00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f50: 2020 2049 5f46 4654 5f72 203d 206e 702e     I_FFT_r = np.
+00006f60: 726f 6c6c 2849 5f46 4654 5f72 2c20 5820  roll(I_FFT_r, X 
+00006f70: 2f2f 2032 202d 2069 782c 2031 2920 2023  // 2 - ix, 1)  #
+00006f80: 206d 6f76 6520 746f 2063 656e 7465 720d   move to center.
+00006f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006fa0: 2020 2020 2049 5f46 4654 5f72 203d 206e       I_FFT_r = n
+00006fb0: 702e 726f 6c6c 2849 5f46 4654 5f72 2c20  p.roll(I_FFT_r, 
+00006fc0: 5920 2f2f 2032 202d 2069 792c 2030 2920  Y // 2 - iy, 0) 
+00006fd0: 2023 206d 6f76 6520 746f 2063 656e 7465   # move to cente
+00006fe0: 720d 0a0d 0a20 2020 2020 2020 2020 2020  r....           
+00006ff0: 2020 2020 2020 2020 204a 203d 206e 702e           J = np.
+00007000: 6666 742e 6966 6674 3228 6e70 2e66 6674  fft.ifft2(np.fft
+00007010: 2e69 6666 7473 6869 6674 2849 5f46 4654  .ifftshift(I_FFT
+00007020: 5f72 2929 0d0a 0d0a 2020 2020 2020 2020  _r))....        
+00007030: 2020 2020 2020 2020 2020 2020 7265 675b              reg[
+00007040: 302c 202e 2e2e 2c20 635d 203d 206e 702e  0, ..., c] = np.
+00007050: 616e 676c 6528 4a29 0d0a 2020 2020 2020  angle(J)..      
+00007060: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00007070: 746f 646f 3a20 6272 690d 0a20 2020 2020  todo: bri..     
+00007080: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00007090: 6f64 5b30 2c20 2e2e 2e2c 2063 5d20 3d20  od[0, ..., c] = 
+000070a0: 6e70 2e61 6273 284a 2920 2a20 3220 2023  np.abs(J) * 2  #
+000070b0: 2066 6163 746f 7220 3220 6265 6361 7573   factor 2 becaus
+000070c0: 6520 6f6e 6520 7369 6465 6261 6e64 2069  e one sideband i
+000070d0: 7320 6669 6c74 6572 6564 206f 7574 0d0a  s filtered out..
+000070e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070f0: 2020 2020 6966 2073 656c 662e 7665 7262      if self.verb
+00007100: 6f73 6520 6f72 2076 6572 626f 7365 3a0d  ose or verbose:.
+00007110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007120: 2020 2020 2020 2020 2070 6869 5b30 2c20           phi[0, 
+00007130: 2e2e 2e2c 2063 5d20 3d20 7265 675b 302c  ..., c] = reg[0,
+00007140: 202e 2e2e 2c20 635d 0d0a 2020 2020 2020   ..., c]..      
+00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007160: 2020 7265 735b 302c 202e 2e2e 2c20 635d    res[0, ..., c]
+00007170: 203d 206e 702e 6c6f 6728 6e70 2e61 6273   = np.log(np.abs
+00007180: 2849 5f46 4654 2929 2020 2320 4a0d 0a20  (I_FFT))  # J.. 
+00007190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071a0: 2020 2020 2020 2023 2074 6f64 6f3a 2049         # todo: I
+000071b0: 202d 204a 0d0a 2020 2020 2020 2020 656c   - J..        el
+000071c0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+000071d0: 2062 7269 2c20 6d6f 642c 2070 6869 2c20   bri, mod, phi, 
+000071e0: 7265 672c 2072 6573 203d 2064 6563 6f64  reg, res = decod
+000071f0: 6528 0d0a 2020 2020 2020 2020 2020 2020  e(..            
+00007200: 2020 2020 492c 0d0a 2020 2020 2020 2020      I,..        
+00007210: 2020 2020 2020 2020 7365 6c66 2e5f 4e2c          self._N,
+00007220: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007230: 2020 7365 6c66 2e5f 762c 0d0a 2020 2020    self._v,..    
+00007240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00007250: 2e5f 6620 2a20 282d 3120 6966 2073 656c  ._f * (-1 if sel
+00007260: 662e 7265 7665 7273 6520 656c 7365 2031  f.reverse else 1
+00007270: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+00007280: 2020 2020 7365 6c66 2e52 2c0d 0a20 2020      self.R,..   
+00007290: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000072a0: 662e 554d 522c 0d0a 2020 2020 2020 2020  f.UMR,..        
+000072b0: 2020 2020 2020 2020 7365 6c66 2e78 302c          self.x0,
+000072c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000072d0: 2020 7365 6c66 2e70 302c 0d0a 2020 2020    self.p0,..    
+000072e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000072f0: 2e56 6d69 6e2c 0d0a 2020 2020 2020 2020  .Vmin,..        
+00007300: 2020 2020 2020 2020 7365 6c66 2e76 6572          self.ver
+00007310: 626f 7365 206f 7220 7665 7262 6f73 652c  bose or verbose,
+00007320: 0d0a 2020 2020 2020 2020 2020 2020 290d  ..            ).
+00007330: 0a0d 0a20 2020 2020 2020 206c 6f67 6769  ...        loggi
+00007340: 6e67 2e64 6562 7567 2866 227b 3130 3030  ng.debug(f"{1000
+00007350: 202a 2028 7469 6d65 2e70 6572 665f 636f   * (time.perf_co
+00007360: 756e 7465 7228 2920 2d20 7430 297d 6d73  unter() - t0)}ms
+00007370: 2229 0d0a 0d0a 2020 2020 2020 2020 7265  ")....        re
+00007380: 7475 726e 2062 7269 2c20 6d6f 642c 2070  turn bri, mod, p
+00007390: 6869 2c20 7265 672c 2072 6573 0d0a 0d0a  hi, reg, res....
+000073a0: 2020 2020 6465 6620 5f6d 756c 7469 706c      def _multipl
+000073b0: 6578 2873 656c 662c 2049 3a20 6e70 2e6e  ex(self, I: np.n
+000073c0: 6461 7272 6179 2c20 7269 6e74 3a20 626f  darray, rint: bo
+000073d0: 6f6c 203d 2054 7275 6529 202d 3e20 6e70  ol = True) -> np
+000073e0: 2e6e 6461 7272 6179 3a0d 0a20 2020 2020  .ndarray:..     
+000073f0: 2020 2022 2222 4d75 6c74 6970 6c65 7820     """Multiplex 
+00007400: 6672 696e 6765 2070 6174 7465 726e 732e  fringe patterns.
+00007410: 0d0a 0d0a 2020 2020 2020 2020 5061 7261  ....        Para
+00007420: 6d65 7465 7273 0d0a 2020 2020 2020 2020  meters..        
+00007430: 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020  ----------..    
+00007440: 2020 2020 4920 3a20 6e70 2e6e 6461 7272      I : np.ndarr
+00007450: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
+00007460: 4261 7365 2066 7269 6e67 6520 7061 7474  Base fringe patt
+00007470: 6572 6e73 2e0d 0a20 2020 2020 2020 2072  erns...        r
+00007480: 696e 7420 3a20 626f 6f6c 2c20 6f70 7469  int : bool, opti
+00007490: 6f6e 616c 0d0a 2020 2020 2020 2020 2020  onal..          
+000074a0: 2020 4966 2074 6869 7320 6973 2073 6574    If this is set
+000074b0: 2074 6f20 5472 7565 2028 7468 6520 6465   to True (the de
+000074c0: 6661 756c 7429 0d0a 2020 2020 2020 2020  fault)..        
+000074d0: 2020 2020 616e 6420 7468 6520 7573 6564      and the used
+000074e0: 2064 7479 7065 2028 6174 7472 6962 7574   dtype (attribut
+000074f0: 6520 6064 7479 7065 6020 6f66 2074 6865  e `dtype` of the
+00007500: 2046 7269 6e67 6573 2069 6e73 7461 6e63   Fringes instanc
+00007510: 6529 2069 7320 6f66 2074 7970 6520 696e  e) is of type in
+00007520: 7465 7267 6572 2c0d 0a20 2020 2020 2020  terger,..       
+00007530: 2020 2020 2074 6865 2065 6e63 6f64 6564       the encoded
+00007540: 2070 6174 7465 726e 7320 7769 6c6c 2062   patterns will b
+00007550: 6520 726f 756e 6465 6420 746f 2074 6865  e rounded to the
+00007560: 206e 6561 7265 7374 2069 6e74 6567 6572   nearest integer
+00007570: 2e0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
+00007580: 6620 7468 6973 2069 7320 7365 7420 4661  f this is set Fa
+00007590: 6c73 6520 616e 6420 7468 6520 7573 6564  lse and the used
+000075a0: 2064 7479 7065 2069 7320 6f66 2074 7970   dtype is of typ
+000075b0: 6520 696e 7465 7267 6572 2c0d 0a20 2020  e interger,..   
+000075c0: 2020 2020 2020 2020 2074 6865 2066 7261           the fra
+000075d0: 6374 696f 6e61 6c20 7061 7274 206f 6620  ctional part of 
+000075e0: 7468 6520 656e 636f 6465 6420 7061 7474  the encoded patt
+000075f0: 6572 6e73 2077 696c 6c20 6265 2064 6973  erns will be dis
+00007600: 6361 7264 6564 2e0d 0a20 2020 2020 2020  carded...       
+00007610: 2052 6574 7572 6e73 0d0a 2020 2020 2020   Returns..      
+00007620: 2020 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020    -------..     
+00007630: 2020 2049 203a 206e 702e 6e64 6172 7261     I : np.ndarra
+00007640: 790d 0a20 2020 2020 2020 2020 2020 204d  y..            M
+00007650: 756c 7469 706c 6578 6564 2066 7269 6e67  ultiplexed fring
+00007660: 6520 7061 7474 6572 6e73 2e0d 0a20 2020  e patterns...   
+00007670: 2020 2020 2022 2222 0d0a 0d0a 2020 2020       """....    
+00007680: 2020 2020 7430 203d 2074 696d 652e 7065      t0 = time.pe
+00007690: 7266 5f63 6f75 6e74 6572 2829 0d0a 0d0a  rf_counter()....
+000076a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000076b0: 5744 4d3a 0d0a 2020 2020 2020 2020 2020  WDM:..          
+000076c0: 2020 6173 7365 7274 206e 6f74 2073 656c    assert not sel
+000076d0: 662e 4644 4d0d 0a20 2020 2020 2020 2020  f.FDM..         
+000076e0: 2020 2061 7373 6572 7420 7365 6c66 2e5f     assert self._
+000076f0: 6d6f 6e6f 6368 726f 6d65 0d0a 2020 2020  monochrome..    
+00007700: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00007710: 702e 616c 6c28 7365 6c66 2e4e 203d 3d20  p.all(self.N == 
+00007720: 3329 0d0a 0d0a 2020 2020 2020 2020 2020  3)....          
+00007730: 2020 4920 3d20 492e 7265 7368 6170 6528    I = I.reshape(
+00007740: 282d 312c 2033 2c20 7365 6c66 2e59 2c20  (-1, 3, self.Y, 
+00007750: 7365 6c66 2e58 2c20 3129 2920 2023 2072  self.X, 1))  # r
+00007760: 6574 7572 6e73 2061 2076 6965 770d 0a20  eturns a view.. 
+00007770: 2020 2020 2020 2020 2020 2049 203d 2049             I = I
+00007780: 2e73 7761 7061 7865 7328 312c 202d 3129  .swapaxes(1, -1)
+00007790: 2020 2320 7265 7475 726e 7320 6120 7669    # returns a vi
+000077a0: 6577 0d0a 2020 2020 2020 2020 2020 2020  ew..            
+000077b0: 4920 3d20 492e 7265 7368 6170 6528 282d  I = I.reshape((-
+000077c0: 312c 2073 656c 662e 592c 2073 656c 662e  1, self.Y, self.
+000077d0: 582c 2073 656c 662e 4329 2920 2023 2072  X, self.C))  # r
+000077e0: 6574 7572 6e73 2061 2076 6965 770d 0a0d  eturns a view...
+000077f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00007800: 2e53 444d 3a0d 0a20 2020 2020 2020 2020  .SDM:..         
+00007810: 2020 2061 7373 6572 7420 6e6f 7420 7365     assert not se
+00007820: 6c66 2e46 444d 0d0a 2020 2020 2020 2020  lf.FDM..        
+00007830: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+00007840: 6772 6964 2069 6e20 7365 6c66 2e5f 6772  grid in self._gr
+00007850: 6964 735b 3a32 5d0d 0a20 2020 2020 2020  ids[:2]..       
+00007860: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+00007870: 2e44 203d 3d20 320d 0a20 2020 2020 2020  .D == 2..       
+00007880: 2020 2020 2061 7373 6572 7420 492e 6474       assert I.dt
+00007890: 7970 652e 6b69 6e64 203d 3d20 2266 220d  ype.kind == "f".
+000078a0: 0a0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
+000078b0: 203d 2049 2e72 6573 6861 7065 2828 7365   = I.reshape((se
+000078c0: 6c66 2e44 2c20 2d31 2929 2020 2320 7265  lf.D, -1))  # re
+000078d0: 7475 726e 7320 6120 7669 6577 0d0a 2020  turns a view..  
+000078e0: 2020 2020 2020 2020 2020 4920 2d3d 2073            I -= s
+000078f0: 656c 662e 410d 0a20 2020 2020 2020 2020  elf.A..         
+00007900: 2020 2049 203d 206e 702e 7375 6d28 492c     I = np.sum(I,
+00007910: 2061 7869 733d 3029 0d0a 2020 2020 2020   axis=0)..      
+00007920: 2020 2020 2020 4920 2b3d 2073 656c 662e        I += self.
+00007930: 410d 0a20 2020 2020 2020 2020 2020 2023  A..            #
+00007940: 2049 202a 3d20 3120 2f20 7365 6c66 2e44   I *= 1 / self.D
+00007950: 0d0a 2020 2020 2020 2020 2020 2020 4920  ..            I 
+00007960: 3d20 492e 7265 7368 6170 6528 282d 312c  = I.reshape((-1,
+00007970: 2073 656c 662e 592c 2073 656c 662e 582c   self.Y, self.X,
+00007980: 2073 656c 662e 4320 6966 2073 656c 662e   self.C if self.
+00007990: 5744 4d20 656c 7365 2031 2929 2020 2320  WDM else 1))  # 
+000079a0: 7265 7475 726e 7320 6120 7669 6577 0d0a  returns a view..
+000079b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000079c0: 656c 662e 6474 7970 652e 6b69 6e64 2069  elf.dtype.kind i
+000079d0: 6e20 2275 6962 223a 0d0a 2020 2020 2020  n "uib":..      
+000079e0: 2020 2020 2020 2020 2020 6966 2072 696e            if rin
+000079f0: 743a 0d0a 2020 2020 2020 2020 2020 2020  t:..            
+00007a00: 2020 2020 2020 2020 6e70 2e72 696e 7428          np.rint(
+00007a10: 492c 206f 7574 3d49 290d 0a20 2020 2020  I, out=I)..     
+00007a20: 2020 2020 2020 2020 2020 2049 203d 2049             I = I
+00007a30: 2e61 7374 7970 6528 7365 6c66 2e64 7479  .astype(self.dty
+00007a40: 7065 2c20 636f 7079 3d46 616c 7365 2920  pe, copy=False) 
+00007a50: 2023 2072 6574 7572 6e73 2061 2076 6965   # returns a vie
+00007a60: 770d 0a0d 0a20 2020 2020 2020 2069 6620  w....        if 
+00007a70: 7365 6c66 2e46 444d 3a0d 0a20 2020 2020  self.FDM:..     
+00007a80: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00007a90: 7420 7365 6c66 2e57 444d 0d0a 2020 2020  t self.WDM..    
+00007aa0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00007ab0: 6f74 2073 656c 662e 5344 4d0d 0a20 2020  ot self.SDM..   
+00007ac0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00007ad0: 6c65 6e28 6e70 2e75 6e69 7175 6528 7365  len(np.unique(se
+00007ae0: 6c66 2e4e 2929 203d 3d20 310d 0a20 2020  lf.N)) == 1..   
+00007af0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00007b00: 492e 6474 7970 652e 6b69 6e64 203d 3d20  I.dtype.kind == 
+00007b10: 2266 220d 0a0d 0a20 2020 2020 2020 2020  "f"....         
+00007b20: 2020 2069 6620 6e70 2e61 6e79 2873 656c     if np.any(sel
+00007b30: 662e 5f4e 203c 2032 202a 206e 702e 6162  f._N < 2 * np.ab
+00007b40: 7328 7365 6c66 2e5f 6629 2e6d 6178 2829  s(self._f).max()
+00007b50: 202b 2031 293a 2020 2320 746f 646f 3a20   + 1):  # todo: 
+00007b60: 6672 6163 7469 6f6e 616c 2070 6572 696f  fractional perio
+00007b70: 6473 0d0a 2020 2020 2020 2020 2020 2020  ds..            
+00007b80: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+00007b90: 696e 6728 2244 6563 6f64 696e 6720 6d69  ing("Decoding mi
+00007ba0: 6768 7420 6265 2064 6973 7475 7262 6564  ght be disturbed
+00007bb0: 2e22 290d 0a0d 0a20 2020 2020 2020 2020  .")....         
+00007bc0: 2020 2049 203d 2049 2e72 6573 6861 7065     I = I.reshape
+00007bd0: 2828 7365 6c66 2e44 202a 2073 656c 662e  ((self.D * self.
+00007be0: 4b2c 202d 3129 2920 2023 2072 6574 7572  K, -1))  # retur
+00007bf0: 6e73 2061 2076 6965 770d 0a20 2020 2020  ns a view..     
+00007c00: 2020 2020 2020 2049 202d 3d20 7365 6c66         I -= self
+00007c10: 2e41 0d0a 2020 2020 2020 2020 2020 2020  .A..            
+00007c20: 4920 3d20 6e70 2e73 756d 2849 2c20 6178  I = np.sum(I, ax
+00007c30: 6973 3d30 290d 0a20 2020 2020 2020 2020  is=0)..         
+00007c40: 2020 2049 202b 3d20 7365 6c66 2e41 0d0a     I += self.A..
+00007c50: 2020 2020 2020 2020 2020 2020 2320 4920              # I 
+00007c60: 2a3d 2031 202f 2028 7365 6c66 2e44 202a  *= 1 / (self.D *
+00007c70: 2073 656c 662e 4b29 0d0a 2020 2020 2020   self.K)..      
+00007c80: 2020 2020 2020 4920 3d20 492e 7265 7368        I = I.resh
+00007c90: 6170 6528 282d 312c 2073 656c 662e 592c  ape((-1, self.Y,
+00007ca0: 2073 656c 662e 582c 2031 2929 2020 2320   self.X, 1))  # 
+00007cb0: 7265 7475 726e 7320 6120 7669 6577 0d0a  returns a view..
+00007cc0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00007cd0: 656c 662e 6474 7970 652e 6b69 6e64 2069  elf.dtype.kind i
+00007ce0: 6e20 2275 6962 223a 0d0a 2020 2020 2020  n "uib":..      
+00007cf0: 2020 2020 2020 2020 2020 6966 2072 696e            if rin
+00007d00: 743a 0d0a 2020 2020 2020 2020 2020 2020  t:..            
+00007d10: 2020 2020 2020 2020 6e70 2e72 696e 7428          np.rint(
+00007d20: 492c 206f 7574 3d49 290d 0a20 2020 2020  I, out=I)..     
+00007d30: 2020 2020 2020 2020 2020 2049 203d 2049             I = I
+00007d40: 2e61 7374 7970 6528 7365 6c66 2e64 7479  .astype(self.dty
+00007d50: 7065 2c20 636f 7079 3d46 616c 7365 2920  pe, copy=False) 
+00007d60: 2023 2072 6574 7572 6e73 2061 2076 6965   # returns a vie
+00007d70: 770d 0a0d 0a20 2020 2020 2020 206c 6f67  w....        log
+00007d80: 6769 6e67 2e64 6562 7567 2866 227b 3130  ging.debug(f"{10
+00007d90: 3030 202a 2028 7469 6d65 2e70 6572 665f  00 * (time.perf_
+00007da0: 636f 756e 7465 7228 2920 2d20 7430 297d  counter() - t0)}
+00007db0: 6d73 2229 0d0a 0d0a 2020 2020 2020 2020  ms")....        
+00007dc0: 7265 7475 726e 2049 0d0a 0d0a 2020 2020  return I....    
+00007dd0: 6465 6620 5f64 656d 756c 7469 706c 6578  def _demultiplex
+00007de0: 2873 656c 662c 2049 3a20 6e70 2e6e 6461  (self, I: np.nda
+00007df0: 7272 6179 2920 2d3e 206e 702e 6e64 6172  rray) -> np.ndar
+00007e00: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
+00007e10: 2244 656d 756c 7469 706c 6578 2066 7269  "Demultiplex fri
+00007e20: 6e67 6520 7061 7474 6572 6e73 2e0d 0a0d  nge patterns....
+00007e30: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00007e40: 6572 730d 0a20 2020 2020 2020 202d 2d2d  ers..        ---
+00007e50: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
+00007e60: 2049 203a 206e 702e 6e64 6172 7261 790d   I : np.ndarray.
+00007e70: 0a20 2020 2020 2020 2020 2020 204d 756c  .            Mul
+00007e80: 7469 706c 6578 6564 2066 7269 6e67 6520  tiplexed fringe 
+00007e90: 7061 7474 6572 6e73 2e0d 0a0d 0a20 2020  patterns.....   
+00007ea0: 2020 2020 2052 6574 7572 6e73 0d0a 2020       Returns..  
+00007eb0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0d 0a20        -------.. 
+00007ec0: 2020 2020 2020 2049 203a 206e 702e 6e64         I : np.nd
+00007ed0: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
+00007ee0: 2020 2044 656d 756c 7469 706c 6578 6564     Demultiplexed
+00007ef0: 2066 7269 6e67 6520 7061 7474 6572 6e73   fringe patterns
+00007f00: 2e0d 0a20 2020 2020 2020 2022 2222 0d0a  ...        """..
+00007f10: 0d0a 2020 2020 2020 2020 7430 203d 2074  ..        t0 = t
+00007f20: 696d 652e 7065 7266 5f63 6f75 6e74 6572  ime.perf_counter
+00007f30: 2829 0d0a 0d0a 2020 2020 2020 2020 542c  ()....        T,
+00007f40: 2059 2c20 582c 2043 203d 2076 7368 6170   Y, X, C = vshap
+00007f50: 6528 4929 2e73 6861 7065 0d0a 0d0a 2020  e(I).shape....  
+00007f60: 2020 2020 2020 6966 2073 656c 662e 5344        if self.SD
+00007f70: 4d3a 0d0a 2020 2020 2020 2020 2020 2020  M:..            
+00007f80: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
+00007f90: 4644 4d0d 0a20 2020 2020 2020 2020 2020  FDM..           
+00007fa0: 2061 7373 6572 7420 7365 6c66 2e67 7269   assert self.gri
+00007fb0: 6420 696e 2073 656c 662e 5f67 7269 6473  d in self._grids
+00007fc0: 5b3a 325d 0d0a 2020 2020 2020 2020 2020  [:2]..          
+00007fd0: 2020 6173 7365 7274 2073 656c 662e 4420    assert self.D 
+00007fe0: 3d3d 2032 0d0a 0d0a 2020 2020 2020 2020  == 2....        
+00007ff0: 2020 2020 6966 2058 2025 2032 203d 3d20      if X % 2 == 
+00008000: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
+00008010: 2020 2020 6678 203d 206e 702e 6666 742e      fx = np.fft.
+00008020: 6666 7473 6869 6674 286e 702e 6666 742e  fftshift(np.fft.
+00008030: 7266 6674 6672 6571 2858 2929 0d0a 2020  rfftfreq(X))..  
+00008040: 2020 2020 2020 2020 2020 2020 2020 6679                fy
+00008050: 203d 206e 702e 6666 742e 6666 7473 6869   = np.fft.fftshi
+00008060: 6674 286e 702e 6666 742e 6666 7466 7265  ft(np.fft.fftfre
+00008070: 7128 5929 290d 0a20 2020 2020 2020 2020  q(Y))..         
+00008080: 2020 2020 2020 2066 7878 2c20 6679 7920         fxx, fyy 
+00008090: 3d20 6e70 2e6d 6573 6867 7269 6428 6678  = np.meshgrid(fx
+000080a0: 2c20 6679 290d 0a20 2020 2020 2020 2020  , fy)..         
+000080b0: 2020 2020 2020 206d 7820 3d20 6e70 2e61         mx = np.a
+000080c0: 6273 2866 7878 2920 3e3d 206e 702e 6162  bs(fxx) >= np.ab
+000080d0: 7328 6679 7929 0d0a 2020 2020 2020 2020  s(fyy)..        
+000080e0: 2020 2020 2020 2020 6d79 203d 206e 702e          my = np.
+000080f0: 6162 7328 6678 7829 203c 3d20 6e70 2e61  abs(fxx) <= np.a
+00008100: 6273 2866 7979 290d 0a20 2020 2020 2020  bs(fyy)..       
+00008110: 2020 2020 2020 2020 204a 203d 2049 0d0a           J = I..
+00008120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008130: 4920 3d20 6e70 2e65 6d70 7479 2828 3220  I = np.empty((2 
+00008140: 2a20 542c 2059 2c20 582c 2043 2929 0d0a  * T, Y, X, C))..
 00008150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008160: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00008170: 2e76 6572 626f 7365 206f 7220 7665 7262  .verbose or verb
-00008180: 6f73 653a 0d0a 2020 2020 2020 2020 2020  ose:..          
-00008190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081a0: 2020 2020 2020 725b 645d 203d 206e 702e        r[d] = np.
-000081b0: 6e61 6e0d 0a20 2020 2020 2020 2020 2020  nan..           
-000081c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081d0: 2020 2020 206b 5b64 5d20 3d20 6e70 2e6e       k[d] = np.n
-000081e0: 616e 0d0a 2020 2020 2020 2020 2020 2020  an..            
-000081f0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00008200: 662e 5f76 5b64 2c20 305d 203c 3d20 313a  f._v[d, 0] <= 1:
-00008210: 2020 2320 6f6e 6520 7065 7269 6f64 2063    # one period c
-00008220: 6f76 6572 7320 7768 6f6c 6520 7363 7265  overs whole scre
-00008230: 656e 3a20 6f6e 6c79 2073 6361 6c69 6e67  en: only scaling
-00008240: 2c20 6e6f 2075 6e77 7261 7070 696e 670d  , no unwrapping.
-00008250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008260: 2020 2020 2020 2020 2078 5b64 5d20 3d20           x[d] = 
-00008270: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00008280: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00008290: 705b 642c 2030 5d20 2b20 7365 6c66 2e6f  p[d, 0] + self.o
-000082a0: 2920 2f20 2832 202a 206e 702e 7069 2920  ) / (2 * np.pi) 
-000082b0: 2520 3120 2a20 7365 6c66 2e5f 6c5b 642c  % 1 * self._l[d,
-000082c0: 2030 5d0d 0a20 2020 2020 2020 2020 2020   0]..           
-000082d0: 2020 2020 2020 2020 2020 2020 2029 2020               )  
-000082e0: 2320 7265 7665 7274 206f 6666 7365 7420  # revert offset 
-000082f0: 616e 6420 6368 616e 6765 2063 6f64 6f6d  and change codom
-00008300: 6169 6e20 6672 6f6d 205b 2d50 492c 2050  ain from [-PI, P
-00008310: 495d 2074 6f20 5b30 2c20 3129 202d 3e20  I] to [0, 1) -> 
-00008320: 6e6f 726d 616c 697a 6564 2070 6869 0d0a  normalized phi..
-00008330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008340: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00008350: 7665 7262 6f73 6520 6f72 2076 6572 626f  verbose or verbo
-00008360: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00008370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008380: 2072 5b64 5d20 3d20 300d 0a20 2020 2020   r[d] = 0..     
-00008390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083a0: 2020 2020 2020 206b 5b64 5d20 3d20 300d         k[d] = 0.
-000083b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000083c0: 2020 2020 2065 6c73 653a 2020 2320 7370       else:  # sp
-000083d0: 6174 6961 6c20 7068 6173 6520 756e 7772  atial phase unwr
-000083e0: 6170 7069 6e67 0d0a 2020 2020 2020 2020  apping..        
-000083f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008400: 6966 2066 756e 6320 696e 2022 6376 3222  if func in "cv2"
-00008410: 3a20 2023 204f 7065 6e43 5620 756e 7772  :  # OpenCV unwr
-00008420: 6170 7069 6e67 0d0a 2020 2020 2020 2020  apping..        
-00008430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008440: 2020 2020 2320 7061 7261 6d73 203d 2063      # params = c
-00008450: 7632 2e70 6861 7365 5f75 6e77 7261 7070  v2.phase_unwrapp
-00008460: 696e 675f 4869 7374 6f67 7261 6d50 6861  ing_HistogramPha
-00008470: 7365 556e 7772 6170 7069 6e67 5f50 6172  seUnwrapping_Par
-00008480: 616d 7328 290d 0a20 2020 2020 2020 2020  ams()..         
-00008490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084a0: 2020 2070 6172 616d 7320 3d20 6376 322e     params = cv2.
-000084b0: 7068 6173 655f 756e 7772 6170 7069 6e67  phase_unwrapping
-000084c0: 2e48 6973 746f 6772 616d 5068 6173 6555  .HistogramPhaseU
-000084d0: 6e77 7261 7070 696e 672e 5061 7261 6d73  nwrapping.Params
-000084e0: 2829 0d0a 2020 2020 2020 2020 2020 2020  ()..            
-000084f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008500: 7061 7261 6d73 2e68 6569 6768 7420 3d20  params.height = 
-00008510: 590d 0a20 2020 2020 2020 2020 2020 2020  Y..             
-00008520: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00008530: 6172 616d 732e 7769 6474 6820 3d20 580d  arams.width = X.
-00008540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008550: 2020 2020 2020 2020 2020 2020 2023 2075               # u
-00008560: 6e77 7261 7070 696e 675f 696e 7374 616e  nwrapping_instan
-00008570: 6365 203d 2063 7632 2e70 6861 7365 5f75  ce = cv2.phase_u
-00008580: 6e77 7261 7070 696e 672e 4869 7374 6f67  nwrapping.Histog
-00008590: 7261 6d50 6861 7365 556e 7772 6170 7069  ramPhaseUnwrappi
-000085a0: 6e67 5f63 7265 6174 6528 7061 7261 6d73  ng_create(params
-000085b0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-000085c0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000085d0: 6e77 7261 7070 696e 675f 696e 7374 616e  nwrapping_instan
-000085e0: 6365 203d 2063 7632 2e70 6861 7365 5f75  ce = cv2.phase_u
-000085f0: 6e77 7261 7070 696e 672e 4869 7374 6f67  nwrapping.Histog
-00008600: 7261 6d50 6861 7365 556e 7772 6170 7069  ramPhaseUnwrappi
-00008610: 6e67 2e63 7265 6174 6528 7061 7261 6d73  ng.create(params
-00008620: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
-00008630: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-00008640: 2020 2069 6620 7365 6c66 2e4b 203d 3d20     if self.K == 
-00008650: 313a 2020 2320 746f 646f 3a20 7365 6c66  1:  # todo: self
-00008660: 2e4b 5b64 5d20 3d3d 2031 0d0a 2020 2020  .K[d] == 1..    
-00008670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008680: 2020 2020 2320 2020 2020 2020 2020 7365      #         se
-00008690: 6c66 2e6c 6f67 6765 722e 696e 666f 2866  lf.logger.info(f
-000086a0: 2253 7061 7469 616c 2070 6861 7365 2075  "Spatial phase u
-000086b0: 6e77 7261 7070 696e 6720 696e 2032 447b  nwrapping in 2D{
-000086c0: 2720 666f 7220 6561 6368 2063 6f6c 6f72  ' for each color
-000086d0: 2069 6e64 6570 656e 746c 7927 2069 6620   indepently' if 
-000086e0: 4320 3e20 3120 656c 7365 2027 277d 2e22  C > 1 else ''}."
-000086f0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00008700: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00008710: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-00008720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008730: 2320 2020 2020 2020 2020 7365 6c66 2e6c  #         self.l
-00008740: 6f67 6765 722e 696e 666f 2866 2253 7061  ogger.info(f"Spa
-00008750: 7469 616c 2070 6861 7365 2075 6e77 7261  tial phase unwra
-00008760: 7070 696e 6720 696e 2033 447b 2720 666f  pping in 3D{' fo
-00008770: 7220 6561 6368 2063 6f6c 6f72 2069 6e64  r each color ind
-00008780: 6570 656e 746c 7927 2069 6620 4320 3e20  epently' if C > 
-00008790: 3120 656c 7365 2027 277d 2e22 290d 0a20  1 else ''}.").. 
-000087a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000087b0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
-000087c0: 2066 756e 6320 3d20 2273 6b69 2220 2023   func = "ski"  #
-000087d0: 2074 6f64 6f3a 2033 4420 5350 5520 7769   todo: 3D SPU wi
-000087e0: 7468 204f 7065 6e43 563f 0d0a 0d0a 2020  th OpenCV?....  
-000087f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008800: 2020 2020 2020 666f 7220 6320 696e 2072        for c in r
-00008810: 616e 6765 2843 293a 0d0a 2020 2020 2020  ange(C):..      
-00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008830: 2020 2020 2020 2320 4f70 656e 4356 2061        # OpenCV a
-00008840: 6c67 6f72 6974 686d 2069 7320 7573 7561  lgorithm is usua
-00008850: 6c6c 7920 6661 7374 6572 2c20 6275 7420  lly faster, but 
-00008860: 6361 6e20 6265 206d 7563 6820 736c 6f77  can be much slow
-00008870: 6572 2069 6e20 6e6f 6973 7920 696d 6167  er in noisy imag
-00008880: 6573 0d0a 2020 2020 2020 2020 2020 2020  es..            
-00008890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088a0: 6966 2066 756e 6320 696e 2022 6376 3222  if func in "cv2"
-000088b0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000088c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088d0: 2020 2023 2064 7479 7065 206f 6620 7020     # dtype of p 
-000088e0: 6d75 7374 2062 6520 6e70 2e66 6c6f 6174  must be np.float
-000088f0: 3332 2020 2320 746f 646f 3a20 7465 7374  32  # todo: test
-00008900: 2074 6869 730d 0a20 2020 2020 2020 2020   this..         
-00008910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008920: 2020 2020 2020 2069 6620 2873 656c 662e         if (self.
-00008930: 7665 7262 6f73 6520 6f72 2076 6572 626f  verbose or verbo
-00008940: 7365 2920 616e 6420 7365 6c66 2e75 6d61  se) and self.uma
-00008950: 7820 3e20 303a 0d0a 2020 2020 2020 2020  x > 0:..        
-00008960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008970: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-00008980: 203d 2028 755b 645d 203e 2073 656c 662e   = (u[d] > self.
-00008990: 756d 6178 292e 6173 7479 7065 286e 702e  umax).astype(np.
-000089a0: 7569 6e74 382c 2063 6f70 793d 4661 6c73  uint8, copy=Fals
-000089b0: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-000089c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089d0: 2020 2020 2020 2020 785b 642c 203a 2c20          x[d, :, 
-000089e0: 3a2c 2063 5d20 3d20 756e 7772 6170 7069  :, c] = unwrappi
-000089f0: 6e67 5f69 6e73 7461 6e63 652e 756e 7772  ng_instance.unwr
-00008a00: 6170 5068 6173 654d 6170 280d 0a20 2020  apPhaseMap(..   
-00008a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a30: 2020 2020 2070 5b64 2c20 302c 203a 2c20       p[d, 0, :, 
-00008a40: 3a2c 2063 5d2c 206d 6173 6b0d 0a20 2020  :, c], mask..   
-00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a70: 2029 2020 2320 746f 646f 3a20 7465 7374   )  # todo: test
-00008a80: 2074 6869 730d 0a20 2020 2020 2020 2020   this..         
-00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008aa0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ad0: 2020 785b 642c 203a 2c20 3a2c 2063 5d20    x[d, :, :, c] 
-00008ae0: 3d20 756e 7772 6170 7069 6e67 5f69 6e73  = unwrapping_ins
-00008af0: 7461 6e63 652e 756e 7772 6170 5068 6173  tance.unwrapPhas
-00008b00: 654d 6170 2870 5b64 2c20 302c 203a 2c20  eMap(p[d, 0, :, 
-00008b10: 3a2c 2063 5d29 0d0a 0d0a 2020 2020 2020  :, c])....      
-00008b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b30: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00008b40: 662e 7665 7262 6f73 6520 6f72 2076 6572  f.verbose or ver
-00008b50: 626f 7365 3a0d 0a20 2020 2020 2020 2020  bose:..         
-00008b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b70: 2020 2020 2020 2020 2020 2072 5b64 2c20             r[d, 
-00008b80: 3a2c 203a 2c20 635d 203d 2075 6e77 7261  :, :, c] = unwra
-00008b90: 7070 696e 675f 696e 7374 616e 6365 2e67  pping_instance.g
-00008ba0: 6574 496e 7665 7273 6552 656c 6961 6269  etInverseReliabi
-00008bb0: 6c69 7479 4d61 7028 2920 2023 2074 6f64  lityMap()  # tod
-00008bc0: 6f3a 2074 6573 7420 7468 6973 0d0a 2020  o: test this..  
-00008bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bf0: 2020 2320 746f 646f 3a20 7265 7320 7673    # todo: res vs
-00008c00: 2e20 7265 6c0d 0a20 2020 2020 2020 2020  . rel..         
-00008c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c20: 2020 2065 6c73 653a 2020 2320 5363 696b     else:  # Scik
-00008c30: 6974 2d69 6d61 6765 2061 6c67 6f72 6974  it-image algorit
-00008c40: 686d 2069 7320 7573 7561 6c6c 7920 736c  hm is usually sl
-00008c50: 6f77 6572 2c20 6275 7420 6465 6c69 7665  ower, but delive
-00008c60: 7273 2062 6574 7465 7220 7265 7375 6c74  rs better result
-00008c70: 7320 6f6e 2065 6467 6573 0d0a 2020 2020  s on edges..    
-00008c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c90: 2020 2020 2020 2020 2020 2020 785b 642c              x[d,
-00008ca0: 203a 2c20 3a2c 2063 5d20 3d20 736b 692e   :, :, c] = ski.
-00008cb0: 7265 7374 6f72 6174 696f 6e2e 756e 7772  restoration.unwr
-00008cc0: 6170 5f70 6861 7365 2870 5b64 2c20 302c  ap_phase(p[d, 0,
-00008cd0: 203a 2c20 3a2c 2063 5d29 2020 2320 746f   :, :, c])  # to
-00008ce0: 646f 3a20 7265 730d 0a0d 0a20 2020 2020  do: res....     
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d00: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00008d10: 6c66 2e76 6572 626f 7365 206f 7220 7665  lf.verbose or ve
-00008d20: 7262 6f73 653a 0d0a 2020 2020 2020 2020  rbose:..        
-00008d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d40: 2020 2020 2020 2020 2020 2020 725b 642c              r[d,
-00008d50: 203a 2c20 3a2c 2063 5d20 3d20 6e70 2e6e   :, :, c] = np.n
-00008d60: 616e 2020 2320 756e 6b6e 6f77 6e0d 0a0d  an  # unknown...
-00008d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008d80: 2020 2020 2020 2020 2020 2020 2078 6d69               xmi
-00008d90: 6e20 3d20 6e70 2e6d 696e 2878 5b64 2c20  n = np.min(x[d, 
-00008da0: 3a2c 203a 2c20 635d 290d 0a20 2020 2020  :, :, c])..     
-00008db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008dc0: 2020 2020 2020 2069 6620 786d 696e 203c         if xmin <
-00008dd0: 2030 3a0d 0a20 2020 2020 2020 2020 2020   0:..           
-00008de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008df0: 2020 2020 2078 5b64 2c20 3a2c 203a 2c20       x[d, :, :, 
-00008e00: 635d 202d 3d20 786d 696e 0d0a 0d0a 2020  c] -= xmin....  
-00008e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e20: 2020 2020 2020 785b 645d 202a 3d20 3120        x[d] *= 1 
-00008e30: 2f20 2832 202a 206e 702e 7069 2920 2a20  / (2 * np.pi) * 
-00008e40: 7365 6c66 2e5f 6c5b 642c 2030 5d0d 0a0d  self._l[d, 0]...
-00008e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008e60: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00008e70: 2e76 6572 626f 7365 206f 7220 7665 7262  .verbose or verb
-00008e80: 6f73 653a 0d0a 2020 2020 2020 2020 2020  ose:..          
-00008e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ea0: 2020 6b5b 642c 2030 5d20 3d20 6e70 2e6e    k[d, 0] = np.n
-00008eb0: 616e 2020 2320 756e 6b6e 6f77 6e0d 0a20  an  # unknown.. 
-00008ec0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00008ed0: 6c73 653a 2020 2320 7465 6d70 6f72 616c  lse:  # temporal
-00008ee0: 2070 6861 7365 2075 6e77 7261 7070 696e   phase unwrappin
-00008ef0: 670d 0a20 2020 2020 2020 2020 2020 2020  g..             
-00008f00: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
-00008f10: 203d 2022 7072 6563 6973 6522 0d0a 2020   = "precise"..  
-00008f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f30: 2020 6966 2073 656c 662e 6d6f 6465 203d    if self.mode =
-00008f40: 3d20 2266 6173 7422 3a0d 0a20 2020 2020  = "fast":..     
-00008f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f60: 2020 2077 203d 206e 702e 6f6e 6573 2828     w = np.ones((
-00008f70: 7365 6c66 2e4b 2c20 592c 2058 2c20 4329  self.K, Y, X, C)
-00008f80: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00008f90: 2020 2020 2020 2020 2020 2069 3020 3d20             i0 = 
-00008fa0: 6e70 2e61 7267 6d69 6e28 7365 6c66 2e5f  np.argmin(self._
-00008fb0: 765b 645d 290d 0a20 2020 2020 2020 2020  v[d])..         
-00008fc0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00008fd0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00008fe0: 2020 2020 2020 2020 2020 7720 3d20 3120            w = 1 
-00008ff0: 2f20 7365 6c66 2e5f 765b 645d 202f 206e  / self._v[d] / n
-00009000: 702e 7371 7274 2873 656c 662e 5f4e 5b64  p.sqrt(self._N[d
-00009010: 5d29 202f 2073 656c 662e 4d20 2023 202f  ]) / self.M  # /
-00009020: 2042 5b64 5d20 2023 2074 6f64 6f3a 204d   B[d]  # todo: M
-00009030: 2c20 420d 0a20 2020 2020 2020 2020 2020  , B..           
-00009040: 2020 2020 2020 2020 2020 2020 2069 3020               i0 
-00009050: 3d20 6e70 2e61 7267 6d69 6e28 772c 2061  = np.argmin(w, a
-00009060: 7869 733d 3029 0d0a 2020 2020 2020 2020  xis=0)..        
-00009070: 2020 2020 2020 2020 2020 2020 2320 7720              # w 
-00009080: 3d20 775b 3a2c 204e 6f6e 652c 204e 6f6e  = w[:, None, Non
-00009090: 652c 204e 6f6e 655d 202a 2042 5b64 5d0d  e, None] * B[d].
-000090a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000090b0: 2020 2020 2077 202f 3d20 6e70 2e73 756d       w /= np.sum
-000090c0: 2877 2c20 6178 6973 3d30 290d 0a0d 0a20  (w, axis=0).... 
-000090d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090e0: 2020 2070 6e20 3d20 2870 5b64 5d20 2520     pn = (p[d] % 
-000090f0: 2832 202a 206e 702e 7069 2920 2b20 7365  (2 * np.pi) + se
-00009100: 6c66 2e6f 2920 2f20 2832 202a 206e 702e  lf.o) / (2 * np.
-00009110: 7069 2920 2520 3120 2023 206e 6f72 6d61  pi) % 1  # norma
-00009120: 6c69 7a65 6420 7068 6173 650d 0a0d 0a20  lized phase.... 
-00009130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009140: 2020 2076 6365 696c 203d 206e 702e 6365     vceil = np.ce
-00009150: 696c 2873 656c 662e 5f76 5b64 2c20 6930  il(self._v[d, i0
-00009160: 5d20 2f20 7365 6c66 2e61 6c70 6861 292e  ] / self.alpha).
-00009170: 6173 7479 7065 2869 6e74 290d 0a20 2020  astype(int)..   
-00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009190: 2066 6f72 206b 7620 696e 2072 616e 6765   for kv in range
-000091a0: 2876 6365 696c 293a 0d0a 2020 2020 2020  (vceil):..      
-000091b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091c0: 2020 786b 203d 2028 6b76 202b 2070 6e5b    xk = (kv + pn[
-000091d0: 6930 5d29 202a 2073 656c 662e 5f6c 5b64  i0]) * self._l[d
-000091e0: 2c20 6930 5d0d 0a20 2020 2020 2020 2020  , i0]..         
-000091f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00009200: 756d 203d 2077 5b30 5d20 2a20 786b 0d0a  um = w[0] * xk..
-00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009220: 2020 2020 2020 2020 7373 6420 3d20 775b          ssd = w[
-00009230: 305d 202a 2078 6b2a 2a32 2020 2320 746f  0] * xk**2  # to
-00009240: 646f 3a20 6368 6563 6b20 6465 7269 7661  do: check deriva
-00009250: 7469 6f6e 0d0a 0d0a 2020 2020 2020 2020  tion....        
-00009260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009270: 666f 7220 6920 696e 2069 742e 6368 6169  for i in it.chai
-00009280: 6e28 7261 6e67 6528 302c 2069 3029 2c20  n(range(0, i0), 
-00009290: 7261 6e67 6528 6930 202b 2031 2c20 3129  range(i0 + 1, 1)
-000092a0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-000092b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092c0: 6b69 203d 2028 786b 202f 2073 656c 662e  ki = (xk / self.
-000092d0: 5f6c 5b64 2c20 695d 292e 6173 7479 7065  _l[d, i]).astype
-000092e0: 2869 6e74 290d 0a20 2020 2020 2020 2020  (int)..         
-000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009300: 2020 2078 6b69 203d 2028 6b69 202b 2070     xki = (ki + p
-00009310: 6e5b 695d 2920 2a20 7365 6c66 2e5f 6c5b  n[i]) * self._l[
-00009320: 642c 2069 5d0d 0a20 2020 2020 2020 2020  d, i]..         
-00009330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009340: 2020 2073 756d 202b 3d20 775b 695d 202a     sum += w[i] *
-00009350: 2078 6b69 0d0a 2020 2020 2020 2020 2020   xki..          
-00009360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009370: 2020 7373 6420 2b3d 2077 5b69 5d20 2a20    ssd += w[i] * 
-00009380: 786b 692a 2a32 2020 2320 746f 646f 3a20  xki**2  # todo: 
-00009390: 6368 6563 6b20 6465 7269 7661 7469 6f6e  check derivation
-000093a0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-000093b0: 2020 2020 2020 2020 2020 2020 7373 6420              ssd 
-000093c0: 2d3d 2073 756d 2a2a 3220 2023 202f 2073  -= sum**2  # / s
-000093d0: 656c 662e 4b0d 0a20 2020 2020 2020 2020  elf.K..         
-000093e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000093f0: 6478 203d 2073 7364 203c 2072 5b64 5d0d  dx = ssd < r[d].
-00009400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009410: 2020 2020 2020 2020 2078 5b64 2c20 6964           x[d, id
-00009420: 785d 203d 2073 756d 5b69 6478 5d0d 0a0d  x] = sum[idx]...
-00009430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009440: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00009450: 2e76 6572 626f 7365 206f 7220 7665 7262  .verbose or verb
-00009460: 6f73 653a 0d0a 2020 2020 2020 2020 2020  ose:..          
-00009470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009480: 2020 6b5b 642c 2069 302c 2069 6478 5d20    k[d, i0, idx] 
-00009490: 3d20 6b76 0d0a 0d0a 2020 2020 2020 2020  = kv....        
-000094a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094b0: 6e70 2e6d 696e 696d 756d 2872 5b64 5d2c  np.minimum(r[d],
-000094c0: 2073 7364 2c20 6f75 743d 725b 645d 2920   ssd, out=r[d]) 
-000094d0: 2023 2074 6f64 6f3a 2075 7369 6e67 2069   # todo: using i
-000094e0: 6478 2073 6c6f 7773 2064 6f77 6e20 636f  dx slows down co
-000094f0: 6d70 7574 6174 696f 6e3f 0d0a 0d0a 2020  mputation?....  
-00009500: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00009510: 2073 656c 662e 7665 7262 6f73 6520 6f72   self.verbose or
-00009520: 2076 6572 626f 7365 3a0d 0a20 2020 2020   verbose:..     
-00009530: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00009540: 5b64 5d20 2a2a 3d20 3120 2f20 320d 0a0d  [d] **= 1 / 2...
-00009550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009560: 2020 2020 2066 6f72 2069 2069 6e20 6974       for i in it
-00009570: 2e63 6861 696e 2872 616e 6765 2830 2c20  .chain(range(0, 
-00009580: 6930 292c 2072 616e 6765 2869 3020 2b20  i0), range(i0 + 
-00009590: 312c 2031 2929 3a0d 0a20 2020 2020 2020  1, 1)):..       
-000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095b0: 206b 5b64 2c20 695d 203d 2078 5b64 5d20   k[d, i] = x[d] 
-000095c0: 2f2f 2073 656c 662e 5f6c 5b64 2c20 695d  // self._l[d, i]
-000095d0: 2020 2320 6672 696e 6765 206f 7264 6572    # fringe order
-000095e0: 206f 6620 692d 7468 2073 6574 0d0a 0d0a   of i-th set....
-000095f0: 2020 2020 2020 2020 2020 2020 6272 692c              bri,
-00009600: 206d 6f64 2c20 7265 672c 2070 6869 2c20   mod, reg, phi, 
-00009610: 6669 642c 2072 6573 2c20 756e 6320 3d20  fid, res, unc = 
-00009620: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00009630: 2020 2041 2c0d 0a20 2020 2020 2020 2020     A,..         
-00009640: 2020 2020 2020 2042 2e72 6573 6861 7065         B.reshape
-00009650: 282d 312c 2059 2c20 582c 2043 292c 0d0a  (-1, Y, X, C),..
-00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009670: 782c 0d0a 2020 2020 2020 2020 2020 2020  x,..            
-00009680: 2020 2020 702e 7265 7368 6170 6528 2d31      p.reshape(-1
-00009690: 2c20 592c 2058 2c20 4329 2c0d 0a20 2020  , Y, X, C),..   
-000096a0: 2020 2020 2020 2020 2020 2020 206b 2e72               k.r
-000096b0: 6573 6861 7065 282d 312c 2059 2c20 582c  eshape(-1, Y, X,
-000096c0: 2043 292c 0d0a 2020 2020 2020 2020 2020   C),..          
-000096d0: 2020 2020 2020 722c 0d0a 2020 2020 2020        r,..      
-000096e0: 2020 2020 2020 2020 2020 752c 0d0a 2020            u,..  
-000096f0: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
-00009700: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00009710: 2020 2020 2020 2020 2320 6d61 7869 6d61          # maxima
-00009720: 6c20 7265 7369 6475 616c 0d0a 2020 2020  l residual..    
-00009730: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00009740: 6d6f 6465 203d 3d20 2266 6173 7422 3a0d  mode == "fast":.
-00009750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009760: 2053 514e 5220 3d20 7365 6c66 2e42 202f   SQNR = self.B /
-00009770: 2073 656c 662e 7569 0d0a 2020 2020 2020   self.ui..      
-00009780: 2020 2020 2020 2020 2020 726d 6178 203d            rmax =
-00009790: 206d 696e 2873 656c 662e 752e 6d61 7828   min(self.u.max(
-000097a0: 292c 2031 2e30 2920 2023 2074 6f64 6f3a  ), 1.0)  # todo:
-000097b0: 2030 2e35 206f 7220 7365 6c66 2e75 0d0a   0.5 or self.u..
-000097c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000097d0: 2320 746f 646f 3a20 725b 645d 2066 6f72  # todo: r[d] for
-000097e0: 2064 2069 6e20 7261 6e67 6528 7365 6c66   d in range(self
-000097f0: 2e44 290d 0a20 2020 2020 2020 2020 2020  .D)..           
-00009800: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-00009810: 2020 2020 2020 2020 726d 6178 203d 2030          rmax = 0
-00009820: 2e30 0d0a 2020 2020 2020 2020 2020 2020  .0..            
-00009830: 726d 6178 203d 2030 2e30 2020 2320 746f  rmax = 0.0  # to
-00009840: 646f 0d0a 0d0a 2020 2020 2020 2020 2020  do....          
-00009850: 2020 6272 692c 206d 6f64 2c20 7068 692c    bri, mod, phi,
-00009860: 2072 6567 2c20 7265 7320 3d20 6465 636f   reg, res = deco
-00009870: 6465 280d 0a20 2020 2020 2020 2020 2020  de(..           
-00009880: 2020 2020 2049 2c0d 0a20 2020 2020 2020       I,..       
-00009890: 2020 2020 2020 2020 2073 656c 662e 5f4e           self._N
-000098a0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-000098b0: 2020 2073 656c 662e 5f76 2c0d 0a20 2020     self._v,..   
-000098c0: 2020 2020 2020 2020 2020 2020 205f 662c               _f,
-000098d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000098e0: 2020 7365 6c66 2e52 2c0d 0a20 2020 2020    self.R,..     
-000098f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00009900: 616c 7068 612c 0d0a 2020 2020 2020 2020  alpha,..        
-00009910: 2020 2020 2020 2020 7365 6c66 2e6f 2c0d          self.o,.
-00009920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009930: 2072 6d61 782c 0d0a 2020 2020 2020 2020   rmax,..        
-00009940: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-00009950: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
-00009960: 2020 2020 7365 6c66 2e56 6d69 6e2c 0d0a      self.Vmin,..
-00009970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009980: 7365 6c66 2e76 6572 626f 7365 206f 7220  self.verbose or 
-00009990: 7665 7262 6f73 652c 0d0a 2020 2020 2020  verbose,..      
-000099a0: 2020 2020 2020 290d 0a0d 0a20 2020 2020        )....     
-000099b0: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-000099c0: 6562 7567 2866 227b 7369 2874 696d 652e  ebug(f"{si(time.
-000099d0: 7065 7266 5f63 6f75 6e74 6572 2829 202d  perf_counter() -
-000099e0: 2074 3029 7d73 2229 0d0a 0d0a 2020 2020   t0)}s")....    
-000099f0: 2020 2020 7265 7475 726e 2062 7269 2c20      return bri, 
-00009a00: 6d6f 642c 2070 6869 2c20 7265 672c 2072  mod, phi, reg, r
-00009a10: 6573 0d0a 0d0a 2020 2020 6465 6620 5f6d  es....    def _m
-00009a20: 756c 7469 706c 6578 2873 656c 662c 2049  ultiplex(self, I
-00009a30: 3a20 6e70 2e6e 6461 7272 6179 2c20 7269  : np.ndarray, ri
-00009a40: 6e74 3a20 626f 6f6c 203d 2054 7275 6529  nt: bool = True)
-00009a50: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
-00009a60: 0a20 2020 2020 2020 2022 2222 4d75 6c74  .        """Mult
-00009a70: 6970 6c65 7820 6672 696e 6765 2070 6174  iplex fringe pat
-00009a80: 7465 726e 732e 0d0a 0d0a 2020 2020 2020  terns.....      
-00009a90: 2020 5061 7261 6d65 7465 7273 0d0a 2020    Parameters..  
-00009aa0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-00009ab0: 0d0a 2020 2020 2020 2020 4920 3a20 6e70  ..        I : np
-00009ac0: 2e6e 6461 7272 6179 0d0a 2020 2020 2020  .ndarray..      
-00009ad0: 2020 2020 2020 4261 7365 2066 7269 6e67        Base fring
-00009ae0: 6520 7061 7474 6572 6e73 2e0d 0a20 2020  e patterns...   
-00009af0: 2020 2020 2072 696e 7420 3a20 626f 6f6c       rint : bool
-00009b00: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
-00009b10: 2020 2020 2020 2020 4966 2074 6869 7320          If this 
-00009b20: 6973 2073 6574 2074 6f20 5472 7565 2028  is set to True (
-00009b30: 7468 6520 6465 6661 756c 7429 0d0a 2020  the default)..  
-00009b40: 2020 2020 2020 2020 2020 616e 6420 7468            and th
-00009b50: 6520 7573 6564 2064 7479 7065 2028 6174  e used dtype (at
-00009b60: 7472 6962 7574 6520 6064 7479 7065 6020  tribute `dtype` 
-00009b70: 6f66 2074 6865 2046 7269 6e67 6573 2069  of the Fringes i
-00009b80: 6e73 7461 6e63 6529 2069 7320 6f66 2074  nstance) is of t
-00009b90: 7970 6520 696e 7465 7267 6572 2c0d 0a20  ype interger,.. 
-00009ba0: 2020 2020 2020 2020 2020 2074 6865 2065             the e
-00009bb0: 6e63 6f64 6564 2070 6174 7465 726e 7320  ncoded patterns 
-00009bc0: 7769 6c6c 2062 6520 726f 756e 6465 6420  will be rounded 
-00009bd0: 746f 2074 6865 206e 6561 7265 7374 2069  to the nearest i
-00009be0: 6e74 6567 6572 2e0d 0a20 2020 2020 2020  nteger...       
-00009bf0: 2020 2020 2049 6620 7468 6973 2069 7320       If this is 
-00009c00: 7365 7420 4661 6c73 6520 616e 6420 7468  set False and th
-00009c10: 6520 7573 6564 2064 7479 7065 2069 7320  e used dtype is 
-00009c20: 6f66 2074 7970 6520 696e 7465 7267 6572  of type interger
-00009c30: 2c0d 0a20 2020 2020 2020 2020 2020 2074  ,..            t
-00009c40: 6865 2066 7261 6374 696f 6e61 6c20 7061  he fractional pa
-00009c50: 7274 206f 6620 7468 6520 656e 636f 6465  rt of the encode
-00009c60: 6420 7061 7474 6572 6e73 2077 696c 6c20  d patterns will 
-00009c70: 6265 2064 6973 6361 7264 6564 2e0d 0a20  be discarded... 
-00009c80: 2020 2020 2020 2052 6574 7572 6e73 0d0a         Returns..
-00009c90: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0d          -------.
-00009ca0: 0a20 2020 2020 2020 2049 203a 206e 702e  .        I : np.
-00009cb0: 6e64 6172 7261 790d 0a20 2020 2020 2020  ndarray..       
-00009cc0: 2020 2020 204d 756c 7469 706c 6578 6564       Multiplexed
-00009cd0: 2066 7269 6e67 6520 7061 7474 6572 6e73   fringe patterns
-00009ce0: 2e0d 0a20 2020 2020 2020 2022 2222 0d0a  ...        """..
-00009cf0: 0d0a 2020 2020 2020 2020 7430 203d 2074  ..        t0 = t
-00009d00: 696d 652e 7065 7266 5f63 6f75 6e74 6572  ime.perf_counter
-00009d10: 2829 0d0a 0d0a 2020 2020 2020 2020 6966  ()....        if
-00009d20: 2073 656c 662e 5744 4d3a 0d0a 2020 2020   self.WDM:..    
-00009d30: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00009d40: 6f74 2073 656c 662e 4644 4d0d 0a20 2020  ot self.FDM..   
-00009d50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00009d60: 7365 6c66 2e5f 6d6f 6e6f 6368 726f 6d65  self._monochrome
-00009d70: 0d0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-00009d80: 7365 7274 206e 702e 616c 6c28 7365 6c66  sert np.all(self
-00009d90: 2e4e 203d 3d20 3329 0d0a 0d0a 2020 2020  .N == 3)....    
-00009da0: 2020 2020 2020 2020 4920 3d20 492e 7265          I = I.re
-00009db0: 7368 6170 6528 282d 312c 2033 2c20 7365  shape((-1, 3, se
-00009dc0: 6c66 2e59 2c20 7365 6c66 2e58 2c20 3129  lf.Y, self.X, 1)
-00009dd0: 2920 2023 2072 6574 7572 6e73 2061 2076  )  # returns a v
-00009de0: 6965 770d 0a20 2020 2020 2020 2020 2020  iew..           
-00009df0: 2049 203d 2049 2e73 7761 7061 7865 7328   I = I.swapaxes(
-00009e00: 312c 202d 3129 2020 2320 7265 7475 726e  1, -1)  # return
-00009e10: 7320 6120 7669 6577 0d0a 2020 2020 2020  s a view..      
-00009e20: 2020 2020 2020 4920 3d20 492e 7265 7368        I = I.resh
-00009e30: 6170 6528 282d 312c 2073 656c 662e 592c  ape((-1, self.Y,
-00009e40: 2073 656c 662e 582c 2073 656c 662e 4329   self.X, self.C)
-00009e50: 2920 2023 2072 6574 7572 6e73 2061 2076  )  # returns a v
-00009e60: 6965 770d 0a0d 0a20 2020 2020 2020 2069  iew....        i
-00009e70: 6620 7365 6c66 2e53 444d 3a0d 0a20 2020  f self.SDM:..   
-00009e80: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00009e90: 6e6f 7420 7365 6c66 2e46 444d 0d0a 2020  not self.FDM..  
-00009ea0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00009eb0: 2073 656c 662e 6772 6964 2069 6e20 7365   self.grid in se
-00009ec0: 6c66 2e5f 6772 6964 735b 3a32 5d0d 0a20  lf._grids[:2].. 
-00009ed0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00009ee0: 7420 7365 6c66 2e44 203d 3d20 320d 0a20  t self.D == 2.. 
-00009ef0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00009f00: 7420 492e 6474 7970 652e 6b69 6e64 203d  t I.dtype.kind =
-00009f10: 3d20 2266 220d 0a0d 0a20 2020 2020 2020  = "f"....       
-00009f20: 2020 2020 2049 203d 2049 2e72 6573 6861       I = I.resha
-00009f30: 7065 2828 7365 6c66 2e44 2c20 2d31 2929  pe((self.D, -1))
-00009f40: 2020 2320 7265 7475 726e 7320 6120 7669    # returns a vi
-00009f50: 6577 0d0a 2020 2020 2020 2020 2020 2020  ew..            
-00009f60: 4920 2d3d 2073 656c 662e 410d 0a20 2020  I -= self.A..   
-00009f70: 2020 2020 2020 2020 2049 203d 206e 702e           I = np.
-00009f80: 7375 6d28 492c 2061 7869 733d 3029 0d0a  sum(I, axis=0)..
-00009f90: 2020 2020 2020 2020 2020 2020 4920 2b3d              I +=
-00009fa0: 2073 656c 662e 410d 0a20 2020 2020 2020   self.A..       
-00009fb0: 2020 2020 2023 2049 202a 3d20 3120 2f20       # I *= 1 / 
-00009fc0: 7365 6c66 2e44 0d0a 2020 2020 2020 2020  self.D..        
-00009fd0: 2020 2020 4920 3d20 492e 7265 7368 6170      I = I.reshap
-00009fe0: 6528 282d 312c 2073 656c 662e 592c 2073  e((-1, self.Y, s
-00009ff0: 656c 662e 582c 2073 656c 662e 4320 6966  elf.X, self.C if
-0000a000: 2073 656c 662e 5744 4d20 656c 7365 2031   self.WDM else 1
-0000a010: 2929 2020 2320 7265 7475 726e 7320 6120  ))  # returns a 
-0000a020: 7669 6577 0d0a 2020 2020 2020 2020 2020  view..          
-0000a030: 2020 6966 2073 656c 662e 6474 7970 652e    if self.dtype.
-0000a040: 6b69 6e64 2069 6e20 2275 6962 223a 0d0a  kind in "uib":..
-0000a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a060: 6966 2072 696e 743a 0d0a 2020 2020 2020  if rint:..      
-0000a070: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-0000a080: 2e72 696e 7428 492c 206f 7574 3d49 290d  .rint(I, out=I).
-0000a090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a0a0: 2049 203d 2049 2e61 7374 7970 6528 7365   I = I.astype(se
-0000a0b0: 6c66 2e64 7479 7065 2c20 636f 7079 3d46  lf.dtype, copy=F
-0000a0c0: 616c 7365 2920 2023 2072 6574 7572 6e73  alse)  # returns
-0000a0d0: 2061 2076 6965 770d 0a0d 0a20 2020 2020   a view....     
-0000a0e0: 2020 2069 6620 7365 6c66 2e46 444d 3a0d     if self.FDM:.
-0000a0f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000a100: 6572 7420 6e6f 7420 7365 6c66 2e57 444d  ert not self.WDM
-0000a110: 0d0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-0000a120: 7365 7274 206e 6f74 2073 656c 662e 5344  sert not self.SD
-0000a130: 4d0d 0a20 2020 2020 2020 2020 2020 2061  M..            a
-0000a140: 7373 6572 7420 6c65 6e28 6e70 2e75 6e69  ssert len(np.uni
-0000a150: 7175 6528 7365 6c66 2e4e 2929 203d 3d20  que(self.N)) == 
-0000a160: 310d 0a20 2020 2020 2020 2020 2020 2061  1..            a
-0000a170: 7373 6572 7420 492e 6474 7970 652e 6b69  ssert I.dtype.ki
-0000a180: 6e64 203d 3d20 2266 220d 0a0d 0a20 2020  nd == "f"....   
-0000a190: 2020 2020 2020 2020 2069 6620 6e70 2e61           if np.a
-0000a1a0: 6e79 2873 656c 662e 5f4e 203c 2032 202a  ny(self._N < 2 *
-0000a1b0: 206e 702e 6162 7328 7365 6c66 2e5f 6629   np.abs(self._f)
-0000a1c0: 2e6d 6178 2829 202b 2031 293a 2020 2320  .max() + 1):  # 
-0000a1d0: 746f 646f 3a20 6672 6163 7469 6f6e 616c  todo: fractional
-0000a1e0: 2070 6572 696f 6473 0d0a 2020 2020 2020   periods..      
-0000a1f0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0000a200: 6f67 6765 722e 7761 726e 696e 6728 2244  ogger.warning("D
-0000a210: 6563 6f64 696e 6720 6d69 6768 7420 6265  ecoding might be
-0000a220: 2064 6973 7475 7262 6564 2e22 290d 0a0d   disturbed.")...
-0000a230: 0a20 2020 2020 2020 2020 2020 2049 203d  .            I =
-0000a240: 2049 2e72 6573 6861 7065 2828 7365 6c66   I.reshape((self
-0000a250: 2e44 202a 2073 656c 662e 4b2c 202d 3129  .D * self.K, -1)
-0000a260: 2920 2023 2072 6574 7572 6e73 2061 2076  )  # returns a v
-0000a270: 6965 770d 0a20 2020 2020 2020 2020 2020  iew..           
-0000a280: 2049 202d 3d20 7365 6c66 2e41 0d0a 2020   I -= self.A..  
-0000a290: 2020 2020 2020 2020 2020 4920 3d20 6e70            I = np
-0000a2a0: 2e73 756d 2849 2c20 6178 6973 3d30 290d  .sum(I, axis=0).
-0000a2b0: 0a20 2020 2020 2020 2020 2020 2049 202b  .            I +
-0000a2c0: 3d20 7365 6c66 2e41 0d0a 2020 2020 2020  = self.A..      
-0000a2d0: 2020 2020 2020 2320 4920 2a3d 2031 202f        # I *= 1 /
-0000a2e0: 2028 7365 6c66 2e44 202a 2073 656c 662e   (self.D * self.
-0000a2f0: 4b29 0d0a 2020 2020 2020 2020 2020 2020  K)..            
-0000a300: 4920 3d20 492e 7265 7368 6170 6528 282d  I = I.reshape((-
-0000a310: 312c 2073 656c 662e 592c 2073 656c 662e  1, self.Y, self.
-0000a320: 582c 2031 2929 2020 2320 7265 7475 726e  X, 1))  # return
-0000a330: 7320 6120 7669 6577 0d0a 2020 2020 2020  s a view..      
-0000a340: 2020 2020 2020 6966 2073 656c 662e 6474        if self.dt
-0000a350: 7970 652e 6b69 6e64 2069 6e20 2275 6962  ype.kind in "uib
-0000a360: 223a 0d0a 2020 2020 2020 2020 2020 2020  ":..            
-0000a370: 2020 2020 6966 2072 696e 743a 0d0a 2020      if rint:..  
-0000a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a390: 2020 6e70 2e72 696e 7428 492c 206f 7574    np.rint(I, out
-0000a3a0: 3d49 290d 0a20 2020 2020 2020 2020 2020  =I)..           
-0000a3b0: 2020 2020 2049 203d 2049 2e61 7374 7970       I = I.astyp
-0000a3c0: 6528 7365 6c66 2e64 7479 7065 2c20 636f  e(self.dtype, co
-0000a3d0: 7079 3d46 616c 7365 2920 2023 2072 6574  py=False)  # ret
-0000a3e0: 7572 6e73 2061 2076 6965 770d 0a0d 0a20  urns a view.... 
-0000a3f0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-0000a400: 6572 2e64 6562 7567 2866 227b 7369 2874  er.debug(f"{si(t
-0000a410: 696d 652e 7065 7266 5f63 6f75 6e74 6572  ime.perf_counter
-0000a420: 2829 202d 2074 3029 7d73 2229 0d0a 0d0a  () - t0)}s")....
-0000a430: 2020 2020 2020 2020 7265 7475 726e 2049          return I
-0000a440: 0d0a 0d0a 2020 2020 6465 6620 5f64 656d  ....    def _dem
-0000a450: 756c 7469 706c 6578 2873 656c 662c 2049  ultiplex(self, I
-0000a460: 3a20 6e70 2e6e 6461 7272 6179 2920 2d3e  : np.ndarray) ->
-0000a470: 206e 702e 6e64 6172 7261 793a 0d0a 2020   np.ndarray:..  
-0000a480: 2020 2020 2020 2222 2244 656d 756c 7469        """Demulti
-0000a490: 706c 6578 2066 7269 6e67 6520 7061 7474  plex fringe patt
-0000a4a0: 6572 6e73 2e0d 0a0d 0a20 2020 2020 2020  erns.....       
-0000a4b0: 2050 6172 616d 6574 6572 730d 0a20 2020   Parameters..   
-0000a4c0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0d       ----------.
-0000a4d0: 0a20 2020 2020 2020 2049 203a 206e 702e  .        I : np.
-0000a4e0: 6e64 6172 7261 790d 0a20 2020 2020 2020  ndarray..       
-0000a4f0: 2020 2020 204d 756c 7469 706c 6578 6564       Multiplexed
-0000a500: 2066 7269 6e67 6520 7061 7474 6572 6e73   fringe patterns
-0000a510: 2e0d 0a0d 0a20 2020 2020 2020 2052 6574  .....        Ret
-0000a520: 7572 6e73 0d0a 2020 2020 2020 2020 2d2d  urns..        --
-0000a530: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2049  -----..        I
-0000a540: 203a 206e 702e 6e64 6172 7261 790d 0a20   : np.ndarray.. 
-0000a550: 2020 2020 2020 2020 2020 2044 656d 756c             Demul
-0000a560: 7469 706c 6578 6564 2066 7269 6e67 6520  tiplexed fringe 
-0000a570: 7061 7474 6572 6e73 2e0d 0a20 2020 2020  patterns...     
-0000a580: 2020 2022 2222 0d0a 0d0a 2020 2020 2020     """....      
-0000a590: 2020 7430 203d 2074 696d 652e 7065 7266    t0 = time.perf
-0000a5a0: 5f63 6f75 6e74 6572 2829 0d0a 0d0a 2020  _counter()....  
-0000a5b0: 2020 2020 2020 542c 2059 2c20 582c 2043        T, Y, X, C
-0000a5c0: 203d 2076 7368 6170 6528 4929 2e73 6861   = vshape(I).sha
-0000a5d0: 7065 0d0a 0d0a 2020 2020 2020 2020 6966  pe....        if
-0000a5e0: 2073 656c 662e 5344 4d3a 0d0a 2020 2020   self.SDM:..    
-0000a5f0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0000a600: 6f74 2073 656c 662e 4644 4d0d 0a20 2020  ot self.FDM..   
-0000a610: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000a620: 7365 6c66 2e67 7269 6420 696e 2073 656c  self.grid in sel
-0000a630: 662e 5f67 7269 6473 5b3a 325d 0d0a 2020  f._grids[:2]..  
-0000a640: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000a650: 2073 656c 662e 4420 3d3d 2032 0d0a 0d0a   self.D == 2....
-0000a660: 2020 2020 2020 2020 2020 2020 6966 2058              if X
-0000a670: 2025 2032 203d 3d20 303a 0d0a 2020 2020   % 2 == 0:..    
-0000a680: 2020 2020 2020 2020 2020 2020 6678 203d              fx =
-0000a690: 206e 702e 6666 742e 6666 7473 6869 6674   np.fft.fftshift
-0000a6a0: 286e 702e 6666 742e 7266 6674 6672 6571  (np.fft.rfftfreq
-0000a6b0: 2858 2929 0d0a 2020 2020 2020 2020 2020  (X))..          
-0000a6c0: 2020 2020 2020 6679 203d 206e 702e 6666        fy = np.ff
-0000a6d0: 742e 6666 7473 6869 6674 286e 702e 6666  t.fftshift(np.ff
-0000a6e0: 742e 6666 7466 7265 7128 5929 290d 0a20  t.fftfreq(Y)).. 
-0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000a700: 7878 2c20 6679 7920 3d20 6e70 2e6d 6573  xx, fyy = np.mes
-0000a710: 6867 7269 6428 6678 2c20 6679 290d 0a20  hgrid(fx, fy).. 
-0000a720: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000a730: 7820 3d20 6e70 2e61 6273 2866 7878 2920  x = np.abs(fxx) 
-0000a740: 3e3d 206e 702e 6162 7328 6679 7929 0d0a  >= np.abs(fyy)..
-0000a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a760: 6d79 203d 206e 702e 6162 7328 6678 7829  my = np.abs(fxx)
-0000a770: 203c 3d20 6e70 2e61 6273 2866 7979 290d   <= np.abs(fyy).
-0000a780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a790: 204a 203d 2049 0d0a 2020 2020 2020 2020   J = I..        
-0000a7a0: 2020 2020 2020 2020 4920 3d20 6e70 2e65          I = np.e
-0000a7b0: 6d70 7479 2828 3220 2a20 542c 2059 2c20  mpty((2 * T, Y, 
-0000a7c0: 582c 2043 2929 0d0a 2020 2020 2020 2020  X, C))..        
-0000a7d0: 2020 2020 2020 2020 666f 7220 7420 696e          for t in
-0000a7e0: 2072 616e 6765 2854 293a 0d0a 2020 2020   range(T):..    
-0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a800: 666f 7220 6320 696e 2072 616e 6765 2843  for c in range(C
-0000a810: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-0000a820: 2020 2020 2020 2020 2020 2020 495f 4646              I_FF
-0000a830: 5420 3d20 6e70 2e66 6674 2e66 6674 7368  T = np.fft.fftsh
-0000a840: 6966 7428 6e70 2e66 6674 2e72 6666 7432  ift(np.fft.rfft2
-0000a850: 284a 5b74 2c20 2e2e 2e2c 2063 5d29 290d  (J[t, ..., c])).
-0000a860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a870: 2020 2020 2020 2020 2049 5b74 2c20 2e2e           I[t, ..
-0000a880: 2e2c 2063 5d20 3d20 6e70 2e66 6674 2e69  ., c] = np.fft.i
-0000a890: 7266 6674 3228 6e70 2e66 6674 2e69 6666  rfft2(np.fft.iff
-0000a8a0: 7473 6869 6674 2849 5f46 4654 202a 206d  tshift(I_FFT * m
-0000a8b0: 7829 290d 0a20 2020 2020 2020 2020 2020  x))..           
-0000a8c0: 2020 2020 2020 2020 2020 2020 2049 5b54               I[T
-0000a8d0: 202b 2074 2c20 2e2e 2e2c 2063 5d20 3d20   + t, ..., c] = 
-0000a8e0: 6e70 2e66 6674 2e69 7266 6674 3228 6e70  np.fft.irfft2(np
-0000a8f0: 2e66 6674 2e69 6666 7473 6869 6674 2849  .fft.ifftshift(I
-0000a900: 5f46 4654 202a 206d 7929 290d 0a20 2020  _FFT * my))..   
-0000a910: 2020 2020 2020 2020 2065 6c69 6620 5920           elif Y 
-0000a920: 2520 3220 3d3d 2030 3a0d 0a20 2020 2020  % 2 == 0:..     
-0000a930: 2020 2020 2020 2020 2020 2066 7820 3d20             fx = 
-0000a940: 6e70 2e66 6674 2e66 6674 7368 6966 7428  np.fft.fftshift(
-0000a950: 6e70 2e66 6674 2e72 6666 7466 7265 7128  np.fft.rfftfreq(
-0000a960: 5929 290d 0a20 2020 2020 2020 2020 2020  Y))..           
-0000a970: 2020 2020 2066 7920 3d20 6e70 2e66 6674       fy = np.fft
-0000a980: 2e66 6674 7368 6966 7428 6e70 2e66 6674  .fftshift(np.fft
-0000a990: 2e66 6674 6672 6571 2858 2929 0d0a 2020  .fftfreq(X))..  
-0000a9a0: 2020 2020 2020 2020 2020 2020 2020 6678                fx
-0000a9b0: 782c 2066 7979 203d 206e 702e 6d65 7368  x, fyy = np.mesh
-0000a9c0: 6772 6964 2866 782c 2066 7929 0d0a 2020  grid(fx, fy)..  
-0000a9d0: 2020 2020 2020 2020 2020 2020 2020 6d78                mx
-0000a9e0: 203d 206e 702e 6162 7328 6678 7829 203e   = np.abs(fxx) >
-0000a9f0: 3d20 6e70 2e61 6273 2866 7979 290d 0a20  = np.abs(fyy).. 
-0000aa00: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000aa10: 7920 3d20 6e70 2e61 6273 2866 7878 2920  y = np.abs(fxx) 
-0000aa20: 3c3d 206e 702e 6162 7328 6679 7929 0d0a  <= np.abs(fyy)..
-0000aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa40: 4a20 3d20 492e 7472 616e 7370 6f73 6528  J = I.transpose(
-0000aa50: 302c 2032 2c20 312c 2033 290d 0a20 2020  0, 2, 1, 3)..   
-0000aa60: 2020 2020 2020 2020 2020 2020 2049 203d               I =
-0000aa70: 206e 702e 656d 7074 7928 2832 202a 2054   np.empty((2 * T
-0000aa80: 2c20 582c 2059 2c20 4329 290d 0a20 2020  , X, Y, C))..   
-0000aa90: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000aaa0: 2074 2069 6e20 7261 6e67 6528 5429 3a0d   t in range(T):.
-0000aab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aac0: 2020 2020 2066 6f72 2063 2069 6e20 7261       for c in ra
-0000aad0: 6e67 6528 4329 3a0d 0a20 2020 2020 2020  nge(C):..       
-0000aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aaf0: 2049 5f46 4654 203d 206e 702e 6666 742e   I_FFT = np.fft.
-0000ab00: 6666 7473 6869 6674 286e 702e 6666 742e  fftshift(np.fft.
-0000ab10: 7266 6674 3228 4a5b 742c 202e 2e2e 2c20  rfft2(J[t, ..., 
-0000ab20: 635d 2929 0d0a 2020 2020 2020 2020 2020  c]))..          
-0000ab30: 2020 2020 2020 2020 2020 2020 2020 495b                I[
-0000ab40: 742c 202e 2e2e 2c20 635d 203d 206e 702e  t, ..., c] = np.
-0000ab50: 6666 742e 6972 6666 7432 286e 702e 6666  fft.irfft2(np.ff
-0000ab60: 742e 6966 6674 7368 6966 7428 495f 4646  t.ifftshift(I_FF
-0000ab70: 5420 2a20 6d79 2929 0d0a 2020 2020 2020  T * my))..      
-0000ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab90: 2020 495b 5420 2b20 742c 202e 2e2e 2c20    I[T + t, ..., 
-0000aba0: 635d 203d 206e 702e 6666 742e 6972 6666  c] = np.fft.irff
-0000abb0: 7432 286e 702e 6666 742e 6966 6674 7368  t2(np.fft.ifftsh
-0000abc0: 6966 7428 495f 4646 5420 2a20 6d78 2929  ift(I_FFT * mx))
-0000abd0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000abe0: 2020 4920 3d20 492e 7472 616e 7370 6f73    I = I.transpos
-0000abf0: 6528 302c 2032 2c20 312c 2033 290d 0a20  e(0, 2, 1, 3).. 
-0000ac00: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000ac10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000ac20: 2020 6678 203d 206e 702e 6666 742e 6666    fx = np.fft.ff
-0000ac30: 7473 6869 6674 286e 702e 6666 742e 6666  tshift(np.fft.ff
-0000ac40: 7466 7265 7128 5829 290d 0a20 2020 2020  tfreq(X))..     
-0000ac50: 2020 2020 2020 2020 2020 2066 7920 3d20             fy = 
-0000ac60: 6e70 2e66 6674 2e66 6674 7368 6966 7428  np.fft.fftshift(
-0000ac70: 6e70 2e66 6674 2e66 6674 6672 6571 2859  np.fft.fftfreq(Y
-0000ac80: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
-0000ac90: 2020 2020 6678 782c 2066 7979 203d 206e      fxx, fyy = n
-0000aca0: 702e 6d65 7368 6772 6964 2866 782c 2066  p.meshgrid(fx, f
-0000acb0: 7929 0d0a 2020 2020 2020 2020 2020 2020  y)..            
-0000acc0: 2020 2020 6d78 203d 206e 702e 6162 7328      mx = np.abs(
-0000acd0: 6678 7829 203e 3d20 6e70 2e61 6273 2866  fxx) >= np.abs(f
-0000ace0: 7979 290d 0a20 2020 2020 2020 2020 2020  yy)..           
-0000acf0: 2020 2020 206d 7920 3d20 6e70 2e61 6273       my = np.abs
-0000ad00: 2866 7878 2920 3c3d 206e 702e 6162 7328  (fxx) <= np.abs(
-0000ad10: 6679 7929 0d0a 2020 2020 2020 2020 2020  fyy)..          
-0000ad20: 2020 2020 2020 4a20 3d20 490d 0a20 2020        J = I..   
-0000ad30: 2020 2020 2020 2020 2020 2020 2049 203d               I =
-0000ad40: 206e 702e 656d 7074 7928 2832 202a 2054   np.empty((2 * T
-0000ad50: 2c20 592c 2058 2c20 4329 290d 0a20 2020  , Y, X, C))..   
-0000ad60: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000ad70: 2074 2069 6e20 7261 6e67 6528 5429 3a0d   t in range(T):.
-0000ad80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ad90: 2020 2020 2066 6f72 2063 2069 6e20 7261       for c in ra
-0000ada0: 6e67 6528 4329 3a0d 0a20 2020 2020 2020  nge(C):..       
-0000adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adc0: 2049 5f46 4654 203d 206e 702e 6666 742e   I_FFT = np.fft.
-0000add0: 6666 7473 6869 6674 286e 702e 6666 742e  fftshift(np.fft.
-0000ade0: 6666 7432 284a 5b74 2c20 2e2e 2e2c 2063  fft2(J[t, ..., c
-0000adf0: 5d29 290d 0a20 2020 2020 2020 2020 2020  ]))..           
-0000ae00: 2020 2020 2020 2020 2020 2020 2049 5b74               I[t
-0000ae10: 2c20 2e2e 2e2c 2063 5d20 3d20 6e70 2e61  , ..., c] = np.a
-0000ae20: 6273 286e 702e 6666 742e 6966 6674 3228  bs(np.fft.ifft2(
-0000ae30: 6e70 2e66 6674 2e69 6666 7473 6869 6674  np.fft.ifftshift
-0000ae40: 2849 5f46 4654 202a 206d 7829 2929 0d0a  (I_FFT * mx)))..
-0000ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae60: 2020 2020 2020 2020 495b 5420 2b20 742c          I[T + t,
-0000ae70: 202e 2e2e 2c20 635d 203d 206e 702e 6162   ..., c] = np.ab
-0000ae80: 7328 6e70 2e66 6674 2e69 6666 7432 286e  s(np.fft.ifft2(n
-0000ae90: 702e 6666 742e 6966 6674 7368 6966 7428  p.fft.ifftshift(
-0000aea0: 495f 4646 5420 2a20 6d79 2929 290d 0a0d  I_FFT * my)))...
-0000aeb0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000aec0: 2e57 444d 3a0d 0a20 2020 2020 2020 2020  .WDM:..         
-0000aed0: 2020 2061 7373 6572 7420 6e6f 7420 7365     assert not se
-0000aee0: 6c66 2e46 444d 0d0a 2020 2020 2020 2020  lf.FDM..        
-0000aef0: 2020 2020 6173 7365 7274 2043 203d 3d20      assert C == 
-0000af00: 330d 0a20 2020 2020 2020 2020 2020 2049  3..            I
-0000af10: 203d 2049 2e72 6573 6861 7065 2828 2d31   = I.reshape((-1
-0000af20: 2c20 312c 2059 2c20 582c 2043 2929 2020  , 1, Y, X, C))  
-0000af30: 2320 7265 7475 726e 7320 6120 7669 6577  # returns a view
-0000af40: 0d0a 2020 2020 2020 2020 2020 2020 4920  ..            I 
-0000af50: 3d20 492e 7377 6170 6178 6573 282d 312c  = I.swapaxes(-1,
-0000af60: 2031 2920 2023 2072 6574 7572 6e73 2061   1)  # returns a
-0000af70: 2076 6965 770d 0a20 2020 2020 2020 2020   view..         
-0000af80: 2020 2049 203d 2049 2e72 6573 6861 7065     I = I.reshape
-0000af90: 2828 2d31 2c20 592c 2058 2c20 3129 2920  ((-1, Y, X, 1)) 
-0000afa0: 2023 2072 6574 7572 6e73 2061 2076 6965   # returns a vie
-0000afb0: 770d 0a0d 0a20 2020 2020 2020 2069 6620  w....        if 
-0000afc0: 7365 6c66 2e46 444d 3a0d 0a20 2020 2020  self.FDM:..     
-0000afd0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0000afe0: 7420 7365 6c66 2e57 444d 0d0a 2020 2020  t self.WDM..    
-0000aff0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0000b000: 6f74 2073 656c 662e 5344 4d20 2023 2074  ot self.SDM  # t
-0000b010: 6f64 6f3a 2061 6c6c 6f77 2073 656c 662e  odo: allow self.
-0000b020: 5344 4d3f 0d0a 2020 2020 2020 2020 2020  SDM?..          
-0000b030: 2020 6173 7365 7274 206c 656e 286e 702e    assert len(np.
-0000b040: 756e 6971 7565 2873 656c 662e 4e29 2920  unique(self.N)) 
-0000b050: 3d3d 2031 0d0a 2020 2020 2020 2020 2020  == 1..          
-0000b060: 2020 4920 3d20 6e70 2e74 696c 6528 492c    I = np.tile(I,
-0000b070: 2028 7365 6c66 2e44 202a 2073 656c 662e   (self.D * self.
-0000b080: 4b2c 2031 2c20 312c 2031 2929 0d0a 0d0a  K, 1, 1, 1))....
-0000b090: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0000b0a0: 6765 722e 6465 6275 6728 6622 7b73 6928  ger.debug(f"{si(
-0000b0b0: 7469 6d65 2e70 6572 665f 636f 756e 7465  time.perf_counte
-0000b0c0: 7228 2920 2d20 7430 297d 7322 290d 0a0d  r() - t0)}s")...
-0000b0d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b0e0: 490d 0a0d 0a20 2020 2064 6566 205f 636f  I....    def _co
-0000b0f0: 6c6f 7269 7a65 2873 656c 662c 2049 3a20  lorize(self, I: 
-0000b100: 6e70 2e6e 6461 7272 6179 2c20 6672 616d  np.ndarray, fram
-0000b110: 6573 3a20 7475 706c 6520 3d20 4e6f 6e65  es: tuple = None
-0000b120: 2920 2d3e 206e 702e 6e64 6172 7261 793a  ) -> np.ndarray:
-0000b130: 0d0a 2020 2020 2020 2020 2222 2243 6f6c  ..        """Col
-0000b140: 6f72 697a 6520 6672 696e 6765 2070 6174  orize fringe pat
-0000b150: 7465 726e 732e 0d0a 0d0a 2020 2020 2020  terns.....      
-0000b160: 2020 5061 7261 6d65 7465 7273 0d0a 2020    Parameters..  
-0000b170: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-0000b180: 0d0a 2020 2020 2020 2020 4920 3a20 6e70  ..        I : np
-0000b190: 2e6e 6461 7272 6179 0d0a 2020 2020 2020  .ndarray..      
-0000b1a0: 2020 2020 2020 4261 7365 2066 7269 6e67        Base fring
-0000b1b0: 6520 7061 7474 6572 6e73 2e0d 0a20 2020  e patterns...   
-0000b1c0: 2020 2020 2066 7261 6d65 7320 3a20 4e6f       frames : No
-0000b1d0: 6e65 206f 7220 696e 7420 6f72 2074 7570  ne or int or tup
-0000b1e0: 6c65 206f 6620 696e 7473 2c20 6f70 7469  le of ints, opti
-0000b1f0: 6f6e 616c 0d0a 2020 2020 2020 2020 2020  onal..          
-0000b200: 2020 496e 6469 6365 7320 6f66 2074 6865    Indices of the
-0000b210: 2066 7261 6d65 206f 7220 6672 616d 6573   frame or frames
-0000b220: 2074 6f20 6265 2065 6e63 6f64 6564 2e0d   to be encoded..
-0000b230: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-0000b240: 2064 6566 6175 6c74 2c20 6672 616d 6573   default, frames
-0000b250: 3d4e 6f6e 652c 2077 696c 6c20 656e 636f  =None, will enco
-0000b260: 6465 2061 6c6c 2066 7261 6d65 7320 6174  de all frames at
-0000b270: 206f 6e63 652e 0d0a 2020 2020 2020 2020   once...        
-0000b280: 2020 2020 4966 2066 7261 6d65 7320 6973      If frames is
-0000b290: 206e 6567 6174 6976 652c 2069 7420 636f   negative, it co
-0000b2a0: 756e 7473 2066 726f 6d20 7468 6520 6c61  unts from the la
-0000b2b0: 7374 2074 6f20 7468 6520 6669 7273 7420  st to the first 
-0000b2c0: 6672 616d 652e 0d0a 2020 2020 2020 2020  frame...        
-0000b2d0: 2020 2020 4966 2066 7261 6d65 7320 636f      If frames co
-0000b2e0: 6e74 6169 6e73 206e 756d 6265 7273 2077  ntains numbers w
-0000b2f0: 686f 7365 206d 6167 6e69 7475 6465 2069  hose magnitude i
-0000b300: 7320 6c61 7267 6572 2074 6861 6e20 7468  s larger than th
-0000b310: 6520 746f 7461 6c20 6e75 6d62 6572 206f  e total number o
-0000b320: 6620 6672 616d 6573 0d0a 2020 2020 2020  f frames..      
-0000b330: 2020 2020 2020 2861 7320 7370 6563 6966        (as specif
-0000b340: 6965 6420 6279 2074 6865 2061 7474 7269  ied by the attri
-0000b350: 6275 7465 2060 5460 206f 6620 7468 6520  bute `T` of the 
-0000b360: 4672 696e 6765 7320 696e 7374 616e 6365  Fringes instance
-0000b370: 292c 2069 7420 6973 2077 7261 7070 6564  ), it is wrapped
-0000b380: 2061 726f 756e 642e 0d0a 2020 2020 2020   around...      
-0000b390: 2020 2020 2020 4966 2066 7261 6d65 7320        If frames 
-0000b3a0: 6973 2061 2074 7570 6c65 206f 6620 696e  is a tuple of in
-0000b3b0: 7473 2c20 6f6e 6c79 2074 6865 2066 7261  ts, only the fra
-0000b3c0: 6d65 7320 7370 6563 6966 6965 6420 696e  mes specified in
-0000b3d0: 2074 6865 2074 7570 6c65 2061 7265 2065   the tuple are e
-0000b3e0: 6e63 6f64 6564 2e0d 0a0d 0a20 2020 2020  ncoded.....     
-0000b3f0: 2020 2052 6574 7572 6e73 0d0a 2020 2020     Returns..    
-0000b400: 2020 2020 2d2d 2d2d 2d2d 2d0d 0a20 2020      -------..   
-0000b410: 2020 2020 2049 203a 206e 702e 6e64 6172       I : np.ndar
-0000b420: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-0000b430: 2043 6f6c 6f72 697a 6564 2066 7269 6e67   Colorized fring
-0000b440: 6520 7061 7474 6572 6e73 2e0d 0a20 2020  e patterns...   
-0000b450: 2020 2020 2022 2222 0d0a 0d0a 2020 2020       """....    
-0000b460: 2020 2020 7430 203d 2074 696d 652e 7065      t0 = time.pe
-0000b470: 7266 5f63 6f75 6e74 6572 2829 0d0a 0d0a  rf_counter()....
-0000b480: 2020 2020 2020 2020 5420 3d20 6c65 6e28          T = len(
-0000b490: 6672 616d 6573 2920 6966 2066 7261 6d65  frames) if frame
-0000b4a0: 7320 6973 206e 6f74 204e 6f6e 6520 656c  s is not None el
-0000b4b0: 7365 2073 656c 662e 540d 0a20 2020 2020  se self.T..     
-0000b4c0: 2020 204a 203d 206e 702e 656d 7074 7928     J = np.empty(
-0000b4d0: 2854 2c20 7365 6c66 2e59 2c20 7365 6c66  (T, self.Y, self
-0000b4e0: 2e58 2c20 7365 6c66 2e43 292c 2073 656c  .X, self.C), sel
-0000b4f0: 662e 6474 7970 6529 0d0a 0d0a 2020 2020  f.dtype)....    
-0000b500: 2020 2020 5468 203d 2049 2e73 6861 7065      Th = I.shape
-0000b510: 5b30 5d20 2023 206e 756d 6265 7220 6f66  [0]  # number of
-0000b520: 2066 7261 6d65 7373 2066 6f72 2065 6163   framess for eac
-0000b530: 6820 6875 650d 0a0d 0a20 2020 2020 2020  h hue....       
-0000b540: 2069 6620 6672 616d 6573 2069 7320 6e6f   if frames is no
-0000b550: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-0000b560: 2020 2020 2068 7565 7320 3d20 5b69 6e74       hues = [int
-0000b570: 2869 202f 2f20 6e70 2e73 756d 2873 656c  (i // np.sum(sel
-0000b580: 662e 5f4e 2929 2066 6f72 2069 2069 6e20  f._N)) for i in 
-0000b590: 6672 616d 6573 5d0d 0a20 2020 2020 2020  frames]..       
-0000b5a0: 2020 2020 2069 203d 2030 0d0a 0d0a 2020       i = 0....  
-0000b5b0: 2020 2020 2020 666f 7220 6820 696e 2072        for h in r
-0000b5c0: 616e 6765 2873 656c 662e 4829 3a0d 0a20  ange(self.H):.. 
-0000b5d0: 2020 2020 2020 2020 2020 2069 6620 6672             if fr
-0000b5e0: 616d 6573 2069 7320 4e6f 6e65 3a0d 0a20  ames is None:.. 
-0000b5f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000b600: 6f72 2063 2069 6e20 7261 6e67 6528 7365  or c in range(se
-0000b610: 6c66 2e43 293a 0d0a 2020 2020 2020 2020  lf.C):..        
-0000b620: 2020 2020 2020 2020 2020 2020 636a 203d              cj =
-0000b630: 2063 2069 6620 7365 6c66 2e57 444d 2065   c if self.WDM e
-0000b640: 6c73 6520 300d 0a20 2020 2020 2020 2020  lse 0..         
-0000b650: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000b660: 6c66 2e68 5b68 2c20 635d 203d 3d20 303a  lf.h[h, c] == 0:
-0000b670: 2020 2320 7569 6220 2d3e 2075 6962 2c20    # uib -> uib, 
-0000b680: 6620 2d3e 2066 0d0a 2020 2020 2020 2020  f -> f..        
-0000b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6a0: 4a5b 6820 2a20 5468 203a 2028 6820 2b20  J[h * Th : (h + 
-0000b6b0: 3129 202a 2054 682c 202e 2e2e 2c20 635d  1) * Th, ..., c]
-0000b6c0: 203d 2030 0d0a 2020 2020 2020 2020 2020   = 0..          
-0000b6d0: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
-0000b6e0: 656c 662e 685b 682c 2063 5d20 3d3d 2032  elf.h[h, c] == 2
-0000b6f0: 3535 2061 6e64 204a 2e64 7479 7065 203d  55 and J.dtype =
-0000b700: 3d20 7365 6c66 2e64 7479 7065 3a20 2023  = self.dtype:  #
-0000b710: 2075 6962 202d 3e20 7569 622c 2066 202d   uib -> uib, f -
-0000b720: 3e20 660d 0a20 2020 2020 2020 2020 2020  > f..           
-0000b730: 2020 2020 2020 2020 2020 2020 204a 5b68               J[h
-0000b740: 202a 2054 6820 3a20 2868 202b 2031 2920   * Th : (h + 1) 
-0000b750: 2a20 5468 2c20 2e2e 2e2c 2063 5d20 3d20  * Th, ..., c] = 
-0000b760: 495b 2e2e 2e2c 2063 6a5d 0d0a 2020 2020  I[..., cj]..    
-0000b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b780: 656c 6966 2073 656c 662e 6474 7970 652e  elif self.dtype.
-0000b790: 6b69 6e64 2069 6e20 2275 6962 223a 2020  kind in "uib":  
-0000b7a0: 2320 6620 2d3e 2075 6962 0d0a 2020 2020  # f -> uib..    
-0000b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7c0: 2020 2020 4a5b 6820 2a20 5468 203a 2028      J[h * Th : (
-0000b7d0: 6820 2b20 3129 202a 2054 682c 202e 2e2e  h + 1) * Th, ...
-0000b7e0: 2c20 635d 203d 206e 702e 7269 6e74 2849  , c] = np.rint(I
-0000b7f0: 5b2e 2e2e 2c20 636a 5d20 2a20 2873 656c  [..., cj] * (sel
-0000b800: 662e 685b 682c 2063 5d20 2f20 3235 3529  f.h[h, c] / 255)
-0000b810: 292e 6173 7479 7065 280d 0a20 2020 2020  ).astype(..     
-0000b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b830: 2020 2020 2020 2073 656c 662e 6474 7970         self.dtyp
-0000b840: 652c 2063 6f70 793d 4661 6c73 650d 0a20  e, copy=False.. 
-0000b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b860: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-0000b870: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000b880: 7365 3a20 2023 2066 202d 3e20 660d 0a20  se:  # f -> f.. 
-0000b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8a0: 2020 2020 2020 204a 5b68 202a 2054 6820         J[h * Th 
-0000b8b0: 3a20 2868 202b 2031 2920 2a20 5468 2c20  : (h + 1) * Th, 
-0000b8c0: 2e2e 2e2c 2063 5d20 3d20 495b 2e2e 2e2c  ..., c] = I[...,
-0000b8d0: 2063 6a5d 202a 2028 7365 6c66 2e68 5b68   cj] * (self.h[h
-0000b8e0: 2c20 635d 202f 2032 3535 290d 0a20 2020  , c] / 255)..   
-0000b8f0: 2020 2020 2020 2020 2065 6c69 6620 6820           elif h 
-0000b900: 696e 2068 7565 733a 2020 2320 692e 652e  in hues:  # i.e.
-0000b910: 2066 7261 6d65 7320 6973 206e 6f74 204e   frames is not N
-0000b920: 6f6e 6520 616e 6420 6820 696e 2068 7565  one and h in hue
-0000b930: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
-0000b940: 2020 2066 6f72 2063 2069 6e20 7261 6e67     for c in rang
-0000b950: 6528 7365 6c66 2e43 293a 0d0a 2020 2020  e(self.C):..    
-0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b970: 636a 203d 2063 2069 6620 7365 6c66 2e57  cj = c if self.W
-0000b980: 444d 2065 6c73 6520 300d 0a20 2020 2020  DM else 0..     
-0000b990: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b9a0: 6620 7365 6c66 2e68 5b68 2c20 635d 203d  f self.h[h, c] =
-0000b9b0: 3d20 303a 2020 2320 7569 6220 2d3e 2075  = 0:  # uib -> u
-0000b9c0: 6962 2c20 6620 2d3e 2066 0d0a 2020 2020  ib, f -> f..    
-0000b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9e0: 2020 2020 4a5b 692c 202e 2e2e 2c20 635d      J[i, ..., c]
-0000b9f0: 203d 2030 0d0a 2020 2020 2020 2020 2020   = 0..          
-0000ba00: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
-0000ba10: 656c 662e 685b 682c 2063 5d20 3d3d 2032  elf.h[h, c] == 2
-0000ba20: 3535 2061 6e64 204a 2e64 7479 7065 203d  55 and J.dtype =
-0000ba30: 3d20 7365 6c66 2e64 7479 7065 3a20 2023  = self.dtype:  #
-0000ba40: 2075 6962 202d 3e20 7569 622c 2066 202d   uib -> uib, f -
-0000ba50: 3e20 660d 0a20 2020 2020 2020 2020 2020  > f..           
-0000ba60: 2020 2020 2020 2020 2020 2020 204a 5b69               J[i
-0000ba70: 2c20 2e2e 2e2c 2063 5d20 3d20 495b 692c  , ..., c] = I[i,
-0000ba80: 202e 2e2e 2c20 636a 5d0d 0a20 2020 2020   ..., cj]..     
-0000ba90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000baa0: 6c69 6620 7365 6c66 2e64 7479 7065 2e6b  lif self.dtype.k
-0000bab0: 696e 6420 696e 2022 7569 6222 3a20 2023  ind in "uib":  #
-0000bac0: 2066 202d 3e20 7569 620d 0a20 2020 2020   f -> uib..     
-0000bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bae0: 2020 204a 5b69 2c20 2e2e 2e2c 2063 5d20     J[i, ..., c] 
-0000baf0: 3d20 6e70 2e72 696e 7428 495b 692c 202e  = np.rint(I[i, .
-0000bb00: 2e2e 2c20 636a 5d20 2a20 2873 656c 662e  .., cj] * (self.
-0000bb10: 685b 682c 2063 5d20 2f20 3235 3529 292e  h[h, c] / 255)).
-0000bb20: 6173 7479 7065 2873 656c 662e 6474 7970  astype(self.dtyp
-0000bb30: 652c 2063 6f70 793d 4661 6c73 6529 0d0a  e, copy=False)..
-0000bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb50: 2020 2020 656c 7365 3a20 2023 2066 202d      else:  # f -
-0000bb60: 3e20 660d 0a20 2020 2020 2020 2020 2020  > f..           
-0000bb70: 2020 2020 2020 2020 2020 2020 204a 5b69               J[i
-0000bb80: 2c20 2e2e 2e2c 2063 5d20 3d20 495b 692c  , ..., c] = I[i,
-0000bb90: 202e 2e2e 2c20 636a 5d20 2a20 2873 656c   ..., cj] * (sel
-0000bba0: 662e 685b 682c 2063 5d20 2f20 3235 3529  f.h[h, c] / 255)
-0000bbb0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000bbc0: 2020 6920 2b3d 2031 0d0a 0d0a 2020 2020    i += 1....    
-0000bbd0: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-0000bbe0: 6465 6275 6728 6622 7b73 6928 7469 6d65  debug(f"{si(time
-0000bbf0: 2e70 6572 665f 636f 756e 7465 7228 2920  .perf_counter() 
-0000bc00: 2d20 7430 297d 7322 290d 0a0d 0a20 2020  - t0)}s")....   
-0000bc10: 2020 2020 2072 6574 7572 6e20 4a0d 0a0d       return J...
-0000bc20: 0a20 2020 2064 6566 205f 6465 636f 6c6f  .    def _decolo
-0000bc30: 7269 7a65 2873 656c 662c 2049 3a20 6e70  rize(self, I: np
-0000bc40: 2e6e 6461 7272 6179 2920 2d3e 206e 702e  .ndarray) -> np.
-0000bc50: 6e64 6172 7261 793a 0d0a 2020 2020 2020  ndarray:..      
-0000bc60: 2020 2222 2244 6563 6f6c 6f72 697a 6520    """Decolorize 
-0000bc70: 6672 696e 6765 2070 6174 7465 726e 7320  fringe patterns 
-0000bc80: 6279 2077 6569 6768 7465 6420 6176 6572  by weighted aver
-0000bc90: 6167 696e 6720 6f66 2068 7565 732e 0d0a  aging of hues...
-0000bca0: 0d0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-0000bcb0: 7465 7273 0d0a 2020 2020 2020 2020 2d2d  ters..        --
-0000bcc0: 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020 2020  --------..      
-0000bcd0: 2020 4920 3a20 6e70 2e6e 6461 7272 6179    I : np.ndarray
-0000bce0: 0d0a 2020 2020 2020 2020 2020 2020 436f  ..            Co
-0000bcf0: 6c6f 7269 7a65 6420 6672 696e 6765 2070  lorized fringe p
-0000bd00: 6174 7465 726e 732e 0d0a 0d0a 2020 2020  atterns.....    
-0000bd10: 2020 2020 5265 7475 726e 730d 0a20 2020      Returns..   
-0000bd20: 2020 2020 202d 2d2d 2d2d 2d2d 0d0a 2020       -------..  
-0000bd30: 2020 2020 2020 4920 3a20 6e70 2e6e 6461        I : np.nda
-0000bd40: 7272 6179 0d0a 2020 2020 2020 2020 2020  rray..          
-0000bd50: 2020 4465 636f 6c6f 7269 7a65 6420 6672    Decolorized fr
-0000bd60: 696e 6765 2070 6174 7465 726e 732e 2222  inge patterns.""
-0000bd70: 220d 0a0d 0a20 2020 2020 2020 2074 3020  "....        t0 
-0000bd80: 3d20 7469 6d65 2e70 6572 665f 636f 756e  = time.perf_coun
-0000bd90: 7465 7228 290d 0a0d 0a20 2020 2020 2020  ter()....       
-0000bda0: 2054 2c20 592c 2058 2c20 4320 3d20 7673   T, Y, X, C = vs
-0000bdb0: 6861 7065 2849 292e 7368 6170 650d 0a20  hape(I).shape.. 
-0000bdc0: 2020 2020 2020 2049 203d 2049 2e72 6573         I = I.res
-0000bdd0: 6861 7065 2828 7365 6c66 2e48 2c20 5420  hape((self.H, T 
-0000bde0: 2f2f 2073 656c 662e 482c 2059 2c20 582c  // self.H, Y, X,
-0000bdf0: 2043 2929 2020 2320 7265 7475 726e 7320   C))  # returns 
-0000be00: 6120 7669 6577 0d0a 0d0a 2020 2020 2020  a view....      
-0000be10: 2020 6261 7365 203d 206e 702e 616c 6c28    base = np.all(
-0000be20: 6e70 2e63 6f75 6e74 5f6e 6f6e 7a65 726f  np.count_nonzero
-0000be30: 2873 656c 662e 682c 2061 7869 733d 3129  (self.h, axis=1)
-0000be40: 203d 3d20 3129 2020 2320 6561 6368 2068   == 1)  # each h
-0000be50: 7565 2063 6f6e 7369 7374 7320 6f66 206f  ue consists of o
-0000be60: 6e6c 7920 6f6e 6520 5247 4220 6261 7365  nly one RGB base
-0000be70: 2063 6f6c 6f72 0d0a 2020 2020 2020 2020   color..        
-0000be80: 736f 6c6f 203d 206e 702e 616c 6c28 6e70  solo = np.all(np
-0000be90: 2e63 6f75 6e74 5f6e 6f6e 7a65 726f 2873  .count_nonzero(s
-0000bea0: 656c 662e 682c 2061 7869 733d 3029 203d  elf.h, axis=0) =
-0000beb0: 3d20 3129 2020 2320 6561 6368 2052 4742  = 1)  # each RGB
-0000bec0: 2063 6f6d 706f 6e65 6e74 2065 7869 7374   component exist
-0000bed0: 7320 6578 6163 746c 7920 6f6e 6365 0d0a  s exactly once..
-0000bee0: 2020 2020 2020 2020 6d6f 6e6f 203d 206c          mono = l
-0000bef0: 656e 2873 6574 2873 656c 662e 685b 7365  en(set(self.h[se
-0000bf00: 6c66 2e68 2021 3d20 305d 2929 203d 3d20  lf.h != 0])) == 
-0000bf10: 3120 2023 2061 6c6c 2063 6f6c 6f72 7320  1  # all colors 
-0000bf20: 6172 6520 6d6f 6e6f 6368 726f 6d61 7469  are monochromati
-0000bf30: 632c 2069 2e65 2e20 6172 6520 7468 6520  c, i.e. are the 
-0000bf40: 7361 6d65 206f 7220 7a65 726f 0d0a 0d0a  same or zero....
-0000bf50: 2020 2020 2020 2020 2320 6966 2062 6173          # if bas
-0000bf60: 6520 616e 6420 736f 6c6f 3a20 6e6f 2061  e and solo: no a
-0000bf70: 7665 7261 6769 6e67 206e 6563 6573 7361  veraging necessa
-0000bf80: 7279 0d0a 2020 2020 2020 2020 2320 6966  ry..        # if
-0000bf90: 206d 6f6e 6f3a 2061 6c6c 2077 6569 6768   mono: all weigh
-0000bfa0: 7473 2061 7265 2074 6865 2073 616d 650d  ts are the same.
-0000bfb0: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
-0000bfc0: 6c66 2e48 203d 3d20 3320 616e 6420 4320  lf.H == 3 and C 
-0000bfd0: 696e 205b 312c 2033 5d20 616e 6420 6261  in [1, 3] and ba
-0000bfe0: 7365 2061 6e64 2073 6f6c 6f20 616e 6420  se and solo and 
-0000bff0: 6d6f 6e6f 3a0d 0a20 2020 2020 2020 2020  mono:..         
-0000c000: 2020 2049 203d 206e 702e 6d6f 7665 6178     I = np.moveax
-0000c010: 6973 2849 2c20 302c 202d 3229 2020 2320  is(I, 0, -2)  # 
-0000c020: 7265 7475 726e 7320 6120 7669 6577 0d0a  returns a view..
-0000c030: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000c040: 6261 7369 6320 736c 6963 696e 6720 7265  basic slicing re
-0000c050: 7475 726e 7320 6120 7669 6577 0d0a 2020  turns a view..  
-0000c060: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
-0000c070: 6e70 2e61 7267 6d61 7828 7365 6c66 2e68  np.argmax(self.h
-0000c080: 2c20 6178 6973 3d31 290d 0a20 2020 2020  , axis=1)..     
-0000c090: 2020 2020 2020 2069 6620 6e70 2e61 7272         if np.arr
-0000c0a0: 6179 5f65 7175 616c 2869 6478 2c20 5b30  ay_equal(idx, [0
-0000c0b0: 2c20 322c 2031 5d29 3a20 2023 2052 4247  , 2, 1]):  # RBG
-0000c0c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000c0d0: 2020 4920 3d20 495b 2e2e 2e2c 2030 3a3a    I = I[..., 0::
-0000c0e0: 2d31 2c20 3a5d 0d0a 2020 2020 2020 2020  -1, :]..        
-0000c0f0: 2020 2020 656c 6966 206e 702e 6172 7261      elif np.arra
-0000c100: 795f 6571 7561 6c28 6964 782c 205b 312c  y_equal(idx, [1,
-0000c110: 2032 2c20 305d 293a 2020 2320 4742 520d   2, 0]):  # GBR.
-0000c120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c130: 2049 203d 2049 5b2e 2e2e 2c20 313a 313a   I = I[..., 1:1:
-0000c140: 2c20 3a5d 0d0a 2020 2020 2020 2020 2020  , :]..          
-0000c150: 2020 656c 6966 206e 702e 6172 7261 795f    elif np.array_
-0000c160: 6571 7561 6c28 6964 782c 205b 312c 2030  equal(idx, [1, 0
-0000c170: 2c20 325d 293a 2020 2320 4752 420d 0a20  , 2]):  # GRB.. 
-0000c180: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-0000c190: 203d 2049 5b2e 2e2e 2c20 313a 313a 2d31   = I[..., 1:1:-1
-0000c1a0: 2c20 3a5d 0d0a 2020 2020 2020 2020 2020  , :]..          
-0000c1b0: 2020 656c 6966 206e 702e 6172 7261 795f    elif np.array_
-0000c1c0: 6571 7561 6c28 6964 782c 205b 322c 2031  equal(idx, [2, 1
-0000c1d0: 2c20 305d 293a 2020 2320 4247 520d 0a20  , 0]):  # BGR.. 
-0000c1e0: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-0000c1f0: 203d 2049 5b2e 2e2e 2c20 323a 3a2d 312c   = I[..., 2::-1,
-0000c200: 203a 5d0d 0a20 2020 2020 2020 2020 2020   :]..           
-0000c210: 2065 6c69 6620 6e70 2e61 7272 6179 5f65   elif np.array_e
-0000c220: 7175 616c 2869 6478 2c20 5b32 2c20 302c  qual(idx, [2, 0,
-0000c230: 2031 5d29 3a20 2023 2042 5247 0d0a 2020   1]):  # BRG..  
-0000c240: 2020 2020 2020 2020 2020 2020 2020 4920                I 
-0000c250: 3d20 495b 2e2e 2e2c 2032 3a32 3a2d 312c  = I[..., 2:2:-1,
-0000c260: 203a 5d0d 0a20 2020 2020 2020 2020 2020   :]..           
-0000c270: 2023 2065 6c69 6620 6e70 2e61 7272 6179   # elif np.array
-0000c280: 5f65 7175 616c 2869 6478 2c20 5b30 2c20  _equal(idx, [0, 
-0000c290: 312c 2032 5d29 3a20 2023 2052 4742 0d0a  1, 2]):  # RGB..
-0000c2a0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000c2b0: 2020 4920 3d20 495b 2e2e 2e2c 203a 2c20    I = I[..., :, 
-0000c2c0: 3a5d 0d0a 0d0a 2020 2020 2020 2020 2020  :]....          
-0000c2d0: 2020 6966 2043 203d 3d20 313a 0d0a 2020    if C == 1:..  
-0000c2e0: 2020 2020 2020 2020 2020 2020 2020 4920                I 
-0000c2f0: 3d20 495b 2e2e 2e2c 2030 5d20 2023 2072  = I[..., 0]  # r
-0000c300: 6574 7572 6e73 2061 2076 6965 770d 0a20  eturns a view.. 
-0000c310: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000c320: 4320 3d3d 2033 3a0d 0a20 2020 2020 2020  C == 3:..       
-0000c330: 2020 2020 2020 2020 2049 203d 206e 702e           I = np.
-0000c340: 6469 6167 6f6e 616c 2849 2c20 6178 6973  diagonal(I, axis
-0000c350: 313d 2d32 2c20 6178 6973 323d 2d31 2920  1=-2, axis2=-1) 
-0000c360: 2023 2072 6574 7572 6e73 2061 2076 6965   # returns a vie
-0000c370: 770d 0a20 2020 2020 2020 2065 6c69 6620  w..        elif 
-0000c380: 7365 6c66 2e48 203d 3d20 3220 616e 6420  self.H == 2 and 
-0000c390: 4320 696e 205b 312c 2033 5d20 616e 6420  C in [1, 3] and 
-0000c3a0: 736f 6c6f 2061 6e64 206d 6f6e 6f3a 0d0a  solo and mono:..
-0000c3b0: 2020 2020 2020 2020 2020 2020 2320 6164              # ad
-0000c3c0: 7661 6e63 6564 2069 6e64 6578 696e 6720  vanced indexing 
-0000c3d0: 7265 7475 726e 7320 6120 636f 7079 2c20  returns a copy, 
-0000c3e0: 6e6f 7420 6120 7669 6577 0d0a 2020 2020  not a view..    
-0000c3f0: 2020 2020 2020 2020 6966 2043 203d 3d20          if C == 
-0000c400: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
-0000c410: 2020 2020 4920 3d20 6e70 2e73 7175 6565      I = np.squee
-0000c420: 7a65 280d 0a20 2020 2020 2020 2020 2020  ze(..           
-0000c430: 2020 2020 2020 2020 2049 2c0d 0a20 2020           I,..   
-0000c440: 2020 2020 2020 2020 2020 2020 2029 2020               )  
-0000c450: 2320 7265 7475 726e 7320 6120 7669 6577  # returns a view
-0000c460: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000c470: 2020 4920 3d20 6e70 2e6d 6f76 6561 7869    I = np.moveaxi
-0000c480: 7328 492c 2030 2c20 2d31 2920 2023 2072  s(I, 0, -1)  # r
-0000c490: 6574 7572 6e73 2061 2076 6965 770d 0a20  eturns a view.. 
-0000c4a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c4b0: 6478 203d 206e 702e 6172 676d 6178 2873  dx = np.argmax(s
-0000c4c0: 656c 662e 682c 2061 7869 733d 3029 0d0a  elf.h, axis=0)..
-0000c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4e0: 4920 3d20 495b 2e2e 2e2c 2069 6478 5d0d  I = I[..., idx].
-0000c4f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0000c500: 6620 4320 3d3d 2033 3a0d 0a20 2020 2020  f C == 3:..     
-0000c510: 2020 2020 2020 2020 2020 2069 6478 203d             idx =
-0000c520: 2073 656c 662e 6820 213d 2030 0d0a 2020   self.h != 0..  
-0000c530: 2020 2020 2020 2020 2020 2020 2020 4920                I 
-0000c540: 3d20 6e70 2e6d 6f76 6561 7869 7328 492c  = np.moveaxis(I,
-0000c550: 2030 2c20 2d32 2920 2023 2072 6574 7572   0, -2)  # retur
-0000c560: 6e73 2061 2076 6965 770d 0a20 2020 2020  ns a view..     
-0000c570: 2020 2020 2020 2020 2020 2049 203d 2049             I = I
-0000c580: 5b2e 2e2e 2c20 6964 785d 0d0a 2020 2020  [..., idx]..    
-0000c590: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-0000c5a0: 2020 2020 2020 2023 2066 7573 6520 636f         # fuse co
-0000c5b0: 6c6f 7273 2062 7920 7765 6967 6874 6564  lors by weighted
-0000c5c0: 2061 7665 7261 6769 6e67 0d0a 0d0a 2020   averaging....  
-0000c5d0: 2020 2020 2020 2020 2020 7720 3d20 7365            w = se
-0000c5e0: 6c66 2e68 202f 206e 702e 7375 6d28 7365  lf.h / np.sum(se
-0000c5f0: 6c66 2e68 2c20 6178 6973 3d30 2920 2023  lf.h, axis=0)  #
-0000c600: 206e 6f72 6d61 6c69 7a65 6420 7765 6967   normalized weig
-0000c610: 6874 730d 0a20 2020 2020 2020 2020 2020  hts..           
-0000c620: 2023 2077 5b6e 702e 6973 6e61 6e28 7729   # w[np.isnan(w)
-0000c630: 5d20 3d20 300d 0a20 2020 2020 2020 2020  ] = 0..         
-0000c640: 2020 2069 6620 4320 3d3d 2031 2061 6e64     if C == 1 and
-0000c650: 206d 6f6e 6f3a 0d0a 2020 2020 2020 2020   mono:..        
-0000c660: 2020 2020 2020 2020 7720 3d20 775b 3a2c          w = w[:,
-0000c670: 2030 5d5b 3a2c 204e 6f6e 655d 2020 2320   0][:, None]  # 
-0000c680: 656e 7375 7265 7320 7468 6174 2074 6865  ensures that the
-0000c690: 2072 6573 756c 7420 6861 7320 6f6e 6c79   result has only
-0000c6a0: 206f 6e65 2063 6f6c 6f72 2063 6861 6e6e   one color chann
-0000c6b0: 656c 0d0a 0d0a 2020 2020 2020 2020 2020  el....          
-0000c6c0: 2020 2320 6966 206e 702e 616c 6c28 2877    # if np.all((w
-0000c6d0: 203d 3d20 3029 207c 2028 7720 3d3d 2031   == 0) | (w == 1
-0000c6e0: 2929 3a0d 0a20 2020 2020 2020 2020 2020  )):..           
-0000c6f0: 2023 2020 2020 2077 203d 2077 2e61 7374   #     w = w.ast
-0000c700: 7970 6528 626f 6f6c 2c20 636f 7079 3d46  ype(bool, copy=F
-0000c710: 616c 7365 2920 2023 206d 756c 7469 706c  alse)  # multipl
-0000c720: 7969 6e67 2077 6974 6820 626f 6f6c 2070  ying with bool p
-0000c730: 7265 7365 7276 6573 2064 7479 7065 0d0a  reserves dtype..
-0000c740: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000c750: 2020 6474 7970 6520 3d20 492e 6474 7970    dtype = I.dtyp
-0000c760: 6520 2023 2077 6974 686f 7574 2074 6869  e  # without thi
-0000c770: 732c 206e 702e 7375 6d20 6368 6f6f 7365  s, np.sum choose
-0000c780: 7320 6120 6474 7970 6520 7768 6963 6820  s a dtype which 
-0000c790: 6361 6e20 686f 6c64 2074 6865 2074 6865  can hold the the
-0000c7a0: 6f72 6574 6963 616c 206d 6178 696d 616c  oretical maximal
-0000c7b0: 2073 756d 0d0a 2020 2020 2020 2020 2020   sum..          
-0000c7c0: 2020 2320 656c 7365 3a0d 0a0d 0a20 2020    # else:....   
-0000c7d0: 2020 2020 2020 2020 2064 7479 7065 203d           dtype =
-0000c7e0: 2066 6c6f 6174 2020 2320 7769 7468 6f75   float  # withou
-0000c7f0: 7420 7468 6973 2c20 6e70 2e73 756d 2063  t this, np.sum c
-0000c800: 686f 6f73 6573 2061 2064 7479 7065 2077  hooses a dtype w
-0000c810: 6869 6368 2063 616e 2068 6f6c 6420 7468  hich can hold th
-0000c820: 6520 7468 656f 7265 7469 6361 6c20 6d61  e theoretical ma
-0000c830: 7869 6d61 6c20 7375 6d0d 0a0d 0a20 2020  ximal sum....   
-0000c840: 2020 2020 2020 2020 2049 203d 206e 702e           I = np.
-0000c850: 7375 6d28 4920 2a20 775b 3a2c 204e 6f6e  sum(I * w[:, Non
-0000c860: 652c 204e 6f6e 652c 204e 6f6e 652c 203a  e, None, None, :
-0000c870: 5d2c 2061 7869 733d 302c 2064 7479 7065  ], axis=0, dtype
-0000c880: 3d64 7479 7065 290d 0a0d 0a20 2020 2020  =dtype)....     
-0000c890: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-0000c8a0: 6562 7567 2866 227b 7369 2874 696d 652e  ebug(f"{si(time.
-0000c8b0: 7065 7266 5f63 6f75 6e74 6572 2829 202d  perf_counter() -
-0000c8c0: 2074 3029 7d73 2229 0d0a 0d0a 2020 2020   t0)}s")....    
-0000c8d0: 2020 2020 7265 7475 726e 2049 0d0a 0d0a      return I....
-0000c8e0: 2020 2020 6465 6620 656e 636f 6465 280d      def encode(.
-0000c8f0: 0a20 2020 2020 2020 2073 656c 662c 0d0a  .        self,..
-0000c900: 2020 2020 2020 2020 6672 616d 6573 3a20          frames: 
-0000c910: 696e 7420 7c20 7475 706c 6520 3d20 4e6f  int | tuple = No
-0000c920: 6e65 2c0d 0a20 2020 2020 2020 2072 696e  ne,..        rin
-0000c930: 743a 2062 6f6f 6c20 3d20 5472 7565 2c0d  t: bool = True,.
-0000c940: 0a20 2020 2020 2020 2073 696d 756c 6174  .        simulat
-0000c950: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
-0000c960: 0d0a 2020 2020 2920 2d3e 206e 702e 6e64  ..    ) -> np.nd
-0000c970: 6172 7261 793a 0d0a 2020 2020 2020 2020  array:..        
-0000c980: 2222 2245 6e63 6f64 6520 6672 696e 6765  """Encode fringe
-0000c990: 2070 6174 7465 726e 732e 0d0a 0d0a 2020   patterns.....  
-0000c9a0: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-0000c9b0: 0d0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  ..        ------
-0000c9c0: 2d2d 2d2d 0d0a 2020 2020 2020 2020 6672  ----..        fr
-0000c9d0: 616d 6573 203a 204e 6f6e 6520 6f72 2069  ames : None or i
-0000c9e0: 6e74 206f 7220 7475 706c 6520 6f66 2069  nt or tuple of i
-0000c9f0: 6e74 732c 206f 7074 696f 6e61 6c0d 0a20  nts, optional.. 
-0000ca00: 2020 2020 2020 2020 2020 2049 6e64 6963             Indic
-0000ca10: 6573 206f 6620 7468 6520 6672 616d 6520  es of the frame 
-0000ca20: 6f72 2066 7261 6d65 7320 746f 2062 6520  or frames to be 
-0000ca30: 656e 636f 6465 642e 0d0a 2020 2020 2020  encoded...      
-0000ca40: 2020 2020 2020 5468 6520 6465 6661 756c        The defaul
-0000ca50: 742c 2066 7261 6d65 733d 4e6f 6e65 2c20  t, frames=None, 
-0000ca60: 7769 6c6c 2065 6e63 6f64 6520 616c 6c20  will encode all 
-0000ca70: 6672 616d 6573 2061 7420 6f6e 6365 2e0d  frames at once..
-0000ca80: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-0000ca90: 6672 616d 6573 2069 7320 6e65 6761 7469  frames is negati
-0000caa0: 7665 2c20 6974 2063 6f75 6e74 7320 6672  ve, it counts fr
-0000cab0: 6f6d 2074 6865 206c 6173 7420 746f 2074  om the last to t
-0000cac0: 6865 2066 6972 7374 2066 7261 6d65 2e0d  he first frame..
-0000cad0: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-0000cae0: 6672 616d 6573 2063 6f6e 7461 696e 7320  frames contains 
-0000caf0: 6e75 6d62 6572 7320 7768 6f73 6520 6d61  numbers whose ma
-0000cb00: 676e 6974 7564 6520 6973 206c 6172 6765  gnitude is large
-0000cb10: 7220 7468 616e 2074 6865 2074 6f74 616c  r than the total
-0000cb20: 206e 756d 6265 7220 6f66 2066 7261 6d65   number of frame
-0000cb30: 730d 0a20 2020 2020 2020 2020 2020 2028  s..            (
-0000cb40: 6173 2073 7065 6369 6669 6564 2062 7920  as specified by 
-0000cb50: 7468 6520 6174 7472 6962 7574 6520 6054  the attribute `T
-0000cb60: 6020 6f66 2074 6865 2046 7269 6e67 6573  ` of the Fringes
-0000cb70: 2069 6e73 7461 6e63 6529 2c20 6974 2069   instance), it i
-0000cb80: 7320 7772 6170 7065 6420 6172 6f75 6e64  s wrapped around
-0000cb90: 2e0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
-0000cba0: 6620 6672 616d 6573 2069 7320 6120 7475  f frames is a tu
-0000cbb0: 706c 6520 6f66 2069 6e74 732c 206f 6e6c  ple of ints, onl
-0000cbc0: 7920 7468 6520 6672 616d 6573 2073 7065  y the frames spe
-0000cbd0: 6369 6669 6564 2069 6e20 7468 6520 7475  cified in the tu
-0000cbe0: 706c 6520 6172 6520 656e 636f 6465 642e  ple are encoded.
-0000cbf0: 0d0a 0d0a 2020 2020 2020 2020 7269 6e74  ....        rint
-0000cc00: 203a 2062 6f6f 6c2c 206f 7074 696f 6e61   : bool, optiona
-0000cc10: 6c0d 0a20 2020 2020 2020 2020 2020 2049  l..            I
-0000cc20: 6620 7468 6973 2069 7320 7365 7420 746f  f this is set to
-0000cc30: 2054 7275 6520 2874 6865 2064 6566 6175   True (the defau
-0000cc40: 6c74 290d 0a20 2020 2020 2020 2020 2020  lt)..           
-0000cc50: 2061 6e64 2074 6865 2075 7365 6420 6474   and the used dt
-0000cc60: 7970 6520 2861 7474 7269 6275 7465 2060  ype (attribute `
-0000cc70: 6474 7970 6560 206f 6620 7468 6520 4672  dtype` of the Fr
-0000cc80: 696e 6765 7320 696e 7374 616e 6365 2920  inges instance) 
-0000cc90: 6973 206f 6620 7479 7065 2069 6e74 6572  is of type inter
-0000cca0: 6765 722c 0d0a 2020 2020 2020 2020 2020  ger,..          
-0000ccb0: 2020 7468 6520 656e 636f 6465 6420 7061    the encoded pa
-0000ccc0: 7474 6572 6e73 2077 696c 6c20 6265 2072  tterns will be r
-0000ccd0: 6f75 6e64 6564 2074 6f20 7468 6520 6e65  ounded to the ne
-0000cce0: 6172 6573 7420 696e 7465 6765 722e 0d0a  arest integer...
-0000ccf0: 2020 2020 2020 2020 2020 2020 4966 2074              If t
-0000cd00: 6869 7320 6973 2073 6574 2046 616c 7365  his is set False
-0000cd10: 2061 6e64 2074 6865 2075 7365 6420 6474   and the used dt
-0000cd20: 7970 6520 6973 206f 6620 7479 7065 2069  ype is of type i
-0000cd30: 6e74 6572 6765 722c 0d0a 2020 2020 2020  nterger,..      
-0000cd40: 2020 2020 2020 7468 6520 6672 6163 7469        the fracti
-0000cd50: 6f6e 616c 2070 6172 7420 6f66 2074 6865  onal part of the
-0000cd60: 2065 6e63 6f64 6564 2070 6174 7465 726e   encoded pattern
-0000cd70: 7320 7769 6c6c 2062 6520 6469 7363 6172  s will be discar
-0000cd80: 6465 642e 0d0a 0d0a 2020 2020 2020 2020  ded.....        
-0000cd90: 7369 6d75 6c61 7465 203a 2062 6f6f 6c2c  simulate : bool,
-0000cda0: 206f 7074 696f 6e61 6c0d 0a20 2020 2020   optional..     
-0000cdb0: 2020 2020 2020 2049 6620 7468 6973 2069         If this i
-0000cdc0: 7320 7365 7420 746f 2054 7275 652c 2074  s set to True, t
-0000cdd0: 6865 2061 6371 7569 7369 7469 6f6e 2c20  he acquisition, 
-0000cde0: 692e 652e 2074 6865 2074 7261 6e73 6d69  i.e. the transmi
-0000cdf0: 7373 696f 6e20 6368 616e 6e65 6c2c 2077  ssion channel, w
-0000ce00: 696c 6c20 6265 2073 696d 756c 6174 6564  ill be simulated
-0000ce10: 2e0d 0a20 2020 2020 2020 2020 2020 2054  ...            T
-0000ce20: 6869 7320 696e 636c 7564 6573 2074 6865  his includes the
-0000ce30: 206d 6f64 756c 6174 696f 6e20 7472 616e   modulation tran
-0000ce40: 7366 6572 2066 756e 6374 696f 6e0d 0a20  sfer function.. 
-0000ce50: 2020 2020 2020 2020 2020 2028 636f 6d70             (comp
-0000ce60: 7574 6564 2066 726f 6d20 7468 6520 696d  uted from the im
-0000ce70: 6167 696e 6720 7379 7374 656d 2773 2070  aging system's p
-0000ce80: 6f69 6e74 2073 7072 6561 6420 6675 6e63  oint spread func
-0000ce90: 7469 6f6e 290d 0a20 2020 2020 2020 2020  tion)..         
-0000cea0: 2020 2061 6e64 2069 6e74 656e 7369 7479     and intensity
-0000ceb0: 206e 6f69 7365 2061 6464 6564 2062 7920   noise added by 
-0000cec0: 7468 6520 6361 6d65 7261 2e0d 0a20 2020  the camera...   
-0000ced0: 2020 2020 2020 2020 2054 6865 2072 6571           The req
-0000cee0: 7569 7265 6420 7061 7261 6d65 7465 7273  uired parameters
-0000cef0: 2066 6f72 2074 6869 7320 6172 6520 7468   for this are th
-0000cf00: 6520 696e 7374 616e 6365 2773 2061 7474  e instance's att
-0000cf10: 7269 6275 7465 730d 0a20 2020 2020 2020  ributes..       
-0000cf20: 2020 2020 2060 6d61 676e 6966 6963 6174       `magnificat
-0000cf30: 696f 6e60 2c20 6050 5346 602c 2060 6761  ion`, `PSF`, `ga
-0000cf40: 696e 602c 2060 6461 726b 5f63 7572 7265  in`, `dark_curre
-0000cf50: 6e74 602c 2060 6461 726b 602c 2060 7175  nt`, `dark`, `qu
-0000cf60: 616e 7460 2061 6e64 2027 7368 6f74 2720  ant` and 'shot' 
-0000cf70: 2e0d 0a20 2020 2020 2020 2020 2020 2044  ...            D
-0000cf80: 6566 6175 6c74 2069 7320 4661 6c73 652e  efault is False.
-0000cf90: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
-0000cfa0: 726e 730d 0a20 2020 2020 2020 202d 2d2d  rns..        ---
-0000cfb0: 2d2d 2d2d 0d0a 2020 2020 2020 2020 4920  ----..        I 
-0000cfc0: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
-0000cfd0: 2020 2020 2020 2020 2020 4672 696e 6765            Fringe
-0000cfe0: 2070 6174 7465 726e 2073 6571 7565 6e63   pattern sequenc
-0000cff0: 652e 0d0a 0d0a 2020 2020 2020 2020 4e6f  e.....        No
-0000d000: 7465 730d 0a20 2020 2020 2020 202d 2d2d  tes..        ---
-0000d010: 2d2d 0d0a 2020 2020 2020 2020 546f 2072  --..        To r
-0000d020: 6563 6569 7665 2074 6865 2066 7261 6d65  eceive the frame
-0000d030: 7320 6974 6572 6174 6976 656c 7920 2869  s iteratively (i
-0000d040: 2e65 2e20 696e 2061 206c 617a 7920 6d61  .e. in a lazy ma
-0000d050: 6e6e 6572 292c 0d0a 2020 2020 2020 2020  nner),..        
-0000d060: 7369 6d70 6c79 2069 7465 7261 7465 206f  simply iterate o
-0000d070: 7665 7220 7468 6520 4672 696e 6765 7320  ver the Fringes 
-0000d080: 696e 7374 616e 6365 2e0d 0a20 2020 2020  instance...     
-0000d090: 2020 2041 6c74 6572 6e61 7469 7665 6c79     Alternatively
-0000d0a0: 2c20 746f 2072 6563 6569 7665 2061 7262  , to receive arb
-0000d0b0: 6974 7261 7279 2066 7261 6d65 732c 0d0a  itrary frames,..
-0000d0c0: 2020 2020 2020 2020 696e 6465 7820 7468          index th
-0000d0d0: 6520 4672 696e 6765 7320 696e 7374 616e  e Fringes instan
-0000d0e0: 6365 2064 6972 6563 746c 792c 0d0a 2020  ce directly,..  
-0000d0f0: 2020 2020 2020 6569 7468 6572 2077 6974        either wit
-0000d100: 6820 616e 2069 6e74 6567 6572 2c20 6120  h an integer, a 
-0000d110: 7475 706c 6520 6f72 2061 2073 6c69 6365  tuple or a slice
-0000d120: 2e0d 0a0d 0a20 2020 2020 2020 2045 7861  .....        Exa
-0000d130: 6d70 6c65 730d 0a20 2020 2020 2020 202d  mples..        -
-0000d140: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
-0000d150: 203e 3e3e 2069 6d70 6f72 7420 6672 696e   >>> import frin
-0000d160: 6765 7320 6173 2066 726e 670d 0a20 2020  ges as frng..   
-0000d170: 2020 2020 203e 3e3e 2066 203d 2066 726e       >>> f = frn
-0000d180: 672e 4672 696e 6765 7328 290d 0a0d 0a20  g.Fringes().... 
-0000d190: 2020 2020 2020 2045 6e63 6f64 6520 7468         Encode th
-0000d1a0: 6520 636f 6d70 6c65 7465 2066 7269 6e67  e complete fring
-0000d1b0: 6520 7061 7474 6572 6e20 7365 7175 656e  e pattern sequen
-0000d1c0: 6365 2e0d 0a0d 0a20 2020 2020 2020 203e  ce.....        >
-0000d1d0: 3e3e 2049 203d 2066 2e65 6e63 6f64 6528  >> I = f.encode(
-0000d1e0: 290d 0a0d 0a20 2020 2020 2020 2045 6e63  )....        Enc
-0000d1f0: 6f64 6520 7468 6520 6669 7273 7420 6672  ode the first fr
-0000d200: 616d 6520 6f66 2074 6865 2066 7269 6e67  ame of the fring
-0000d210: 6520 7061 7474 6572 6e20 7365 7175 656e  e pattern sequen
-0000d220: 6365 2e0d 0a0d 0a20 2020 2020 2020 203e  ce.....        >
-0000d230: 3e3e 2049 203d 2066 2e65 6e63 6f64 6528  >> I = f.encode(
-0000d240: 6672 616d 6573 3d30 290d 0a20 2020 2020  frames=0)..     
-0000d250: 2020 203e 3e3e 2049 203d 2066 5b30 5d0d     >>> I = f[0].
-0000d260: 0a20 2020 2020 2020 203e 3e3e 2049 203d  .        >>> I =
-0000d270: 206e 6578 7428 6974 6572 2866 2929 0d0a   next(iter(f))..
-0000d280: 0d0a 2020 2020 2020 2020 456e 636f 6465  ..        Encode
-0000d290: 2074 6865 206c 6173 7420 6672 616d 6520   the last frame 
-0000d2a0: 6f66 2074 6865 2066 7269 6e67 6520 7061  of the fringe pa
-0000d2b0: 7474 6572 6e20 7365 7175 656e 6365 2e0d  ttern sequence..
-0000d2c0: 0a0d 0a20 2020 2020 2020 203e 3e3e 2049  ...        >>> I
-0000d2d0: 203d 2066 2e65 6e63 6f64 6528 6672 616d   = f.encode(fram
-0000d2e0: 6573 3d2d 3129 0d0a 2020 2020 2020 2020  es=-1)..        
-0000d2f0: 3e3e 3e20 4920 3d20 665b 2d31 5d0d 0a0d  >>> I = f[-1]...
-0000d300: 0a20 2020 2020 2020 2045 6e63 6f64 6520  .        Encode 
-0000d310: 7468 6520 6669 7273 7420 7477 6f20 6672  the first two fr
-0000d320: 616d 6573 206f 6620 7468 6520 6672 696e  ames of the frin
-0000d330: 6765 2070 6174 7465 726e 2073 6571 7565  ge pattern seque
-0000d340: 6e63 652e 0d0a 0d0a 2020 2020 2020 2020  nce.....        
-0000d350: 3e3e 3e20 4920 3d20 662e 656e 636f 6465  >>> I = f.encode
-0000d360: 2866 7261 6d65 733d 2830 2c20 3129 290d  (frames=(0, 1)).
-0000d370: 0a20 2020 2020 2020 203e 3e3e 2049 203d  .        >>> I =
-0000d380: 2066 5b30 2c20 315d 0d0a 2020 2020 2020   f[0, 1]..      
-0000d390: 2020 3e3e 3e20 4920 3d20 665b 3a32 5d0d    >>> I = f[:2].
-0000d3a0: 0a0d 0a20 2020 2020 2020 2043 7265 6174  ...        Creat
-0000d3b0: 6520 6120 6765 6e65 7261 746f 7220 746f  e a generator to
-0000d3c0: 2072 6563 6569 7665 2074 6865 2066 7261   receive the fra
-0000d3d0: 6d65 7320 6974 6572 6174 6976 656c 792c  mes iteratively,
-0000d3e0: 2069 2e65 2e20 696e 2061 206c 617a 7920   i.e. in a lazy 
-0000d3f0: 6d61 6e6e 6572 2e0d 0a0d 0a20 2020 2020  manner.....     
-0000d400: 2020 203e 3e3e 2049 203d 2028 6672 616d     >>> I = (fram
-0000d410: 6520 666f 7220 6672 616d 6520 696e 2066  e for frame in f
-0000d420: 290d 0a20 2020 2020 2020 2022 2222 0d0a  )..        """..
-0000d430: 0d0a 2020 2020 2020 2020 7430 203d 2074  ..        t0 = t
-0000d440: 696d 652e 7065 7266 5f63 6f75 6e74 6572  ime.perf_counter
-0000d450: 2829 0d0a 0d0a 2020 2020 2020 2020 2320  ()....        # 
-0000d460: 6368 6563 6b20 554d 520d 0a20 2020 2020  check UMR..     
-0000d470: 2020 2069 6620 7365 6c66 2e5f 616d 6269     if self._ambi
-0000d480: 6775 6f75 733a 0d0a 2020 2020 2020 2020  guous:..        
-0000d490: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-0000d4a0: 7761 726e 696e 6728 0d0a 2020 2020 2020  warning(..      
-0000d4b0: 2020 2020 2020 2020 2020 2255 4d52 203c            "UMR <
-0000d4c0: 2052 2e20 556e 7772 6170 7069 6e67 2077   R. Unwrapping w
-0000d4d0: 696c 6c20 6e6f 7420 6265 2073 7061 7469  ill not be spati
-0000d4e0: 616c 6c79 2069 6e64 6570 656e 6465 6e74  ally independent
-0000d4f0: 2061 6e64 206f 6e6c 7920 7969 656c 6420   and only yield 
-0000d500: 6120 7265 6c61 7469 7665 2070 6861 7365  a relative phase
-0000d510: 206d 6170 2e22 0d0a 2020 2020 2020 2020   map."..        
-0000d520: 2020 2020 290d 0a0d 0a20 2020 2020 2020      )....       
-0000d530: 2069 6620 6672 616d 6573 2069 7320 6e6f   if frames is no
-0000d540: 7420 4e6f 6e65 3a20 2023 206c 617a 7920  t None:  # lazy 
-0000d550: 656e 636f 6469 6e67 0d0a 2020 2020 2020  encoding..      
-0000d560: 2020 2020 2020 7472 793a 2020 2320 656e        try:  # en
-0000d570: 7375 7265 2066 7261 6d65 7320 6973 2069  sure frames is i
-0000d580: 7465 7261 626c 650d 0a20 2020 2020 2020  terable..       
-0000d590: 2020 2020 2020 2020 2069 7465 7228 6672           iter(fr
-0000d5a0: 616d 6573 290d 0a20 2020 2020 2020 2020  ames)..         
-0000d5b0: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
-0000d5c0: 726f 723a 0d0a 2020 2020 2020 2020 2020  ror:..          
-0000d5d0: 2020 2020 2020 6672 616d 6573 203d 205b        frames = [
-0000d5e0: 6672 616d 6573 5d0d 0a0d 0a20 2020 2020  frames]....     
-0000d5f0: 2020 2020 2020 2066 7261 6d65 7320 3d20         frames = 
-0000d600: 6e70 2e61 7272 6179 2866 7261 6d65 732c  np.array(frames,
-0000d610: 2069 6e74 292e 7261 7665 6c28 2920 2520   int).ravel() % 
-0000d620: 6e70 2e73 756d 2873 656c 662e 5f4e 290d  np.sum(self._N).
-0000d630: 0a0d 0a20 2020 2020 2020 2020 2020 2069  ...            i
-0000d640: 6620 7365 6c66 2e46 444d 3a0d 0a20 2020  f self.FDM:..   
-0000d650: 2020 2020 2020 2020 2020 2020 2066 7261               fra
-0000d660: 6d65 7320 3d20 6e70 2e61 7272 6179 285b  mes = np.array([
-0000d670: 6e70 2e61 7261 6e67 6528 6920 2a20 7365  np.arange(i * se
-0000d680: 6c66 2e44 202a 2073 656c 662e 4b2c 2028  lf.D * self.K, (
-0000d690: 6920 2b20 3129 202a 2073 656c 662e 4420  i + 1) * self.D 
-0000d6a0: 2a20 7365 6c66 2e4b 2920 666f 7220 6920  * self.K) for i 
-0000d6b0: 696e 2066 7261 6d65 735d 292e 7261 7665  in frames]).rave
-0000d6c0: 6c28 290d 0a0d 0a20 2020 2020 2020 2020  l()....         
-0000d6d0: 2020 2069 6620 7365 6c66 2e57 444d 3a20     if self.WDM: 
-0000d6e0: 2023 2057 444d 2062 6566 6f72 6520 5344   # WDM before SD
-0000d6f0: 4d0d 0a20 2020 2020 2020 2020 2020 2020  M..             
-0000d700: 2020 204e 203d 2033 0d0a 2020 2020 2020     N = 3..      
-0000d710: 2020 2020 2020 2020 2020 6672 616d 6573            frames
-0000d720: 203d 206e 702e 6172 7261 7928 5b6e 702e   = np.array([np.
-0000d730: 6172 616e 6765 2869 202a 204e 2c20 2869  arange(i * N, (i
-0000d740: 202b 2031 2920 2a20 4e29 2066 6f72 2069   + 1) * N) for i
-0000d750: 2069 6e20 6672 616d 6573 5d29 2e72 6176   in frames]).rav
-0000d760: 656c 2829 0d0a 0d0a 2020 2020 2020 2020  el()....        
-0000d770: 2020 2020 6966 2073 656c 662e 5344 4d3a      if self.SDM:
-0000d780: 2020 2320 5744 4d20 6265 666f 7265 2053    # WDM before S
-0000d790: 444d 0d0a 2020 2020 2020 2020 2020 2020  DM..            
-0000d7a0: 2020 2020 6c65 6e5f 4430 203d 206e 702e      len_D0 = np.
-0000d7b0: 7375 6d28 7365 6c66 2e5f 4e5b 305d 290d  sum(self._N[0]).
-0000d7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d7d0: 2066 7261 6d65 7320 3d20 6e70 2e61 7272   frames = np.arr
-0000d7e0: 6179 285b 6e70 2e61 7261 6e67 6528 692c  ay([np.arange(i,
-0000d7f0: 2069 202b 206c 656e 5f44 3020 2b20 312c   i + len_D0 + 1,
-0000d800: 206c 656e 5f44 3029 2066 6f72 2069 2069   len_D0) for i i
-0000d810: 6e20 6672 616d 6573 5d29 2e72 6176 656c  n frames]).ravel
-0000d820: 2829 0d0a 2020 2020 2020 2020 656c 7365  ()..        else
-0000d830: 3a0d 0a20 2020 2020 2020 2020 2020 2066  :..            f
-0000d840: 7261 6d65 7320 3d20 4e6f 6e65 0d0a 0d0a  rames = None....
-0000d850: 2020 2020 2020 2020 2320 6d6f 6475 6c61          # modula
-0000d860: 7465 0d0a 2020 2020 2020 2020 4920 3d20  te..        I = 
-0000d870: 7365 6c66 2e5f 6d6f 6475 6c61 7465 2866  self._modulate(f
-0000d880: 7261 6d65 732c 2072 696e 7429 0d0a 0d0a  rames, rint)....
-0000d890: 2020 2020 2020 2020 2320 6d75 6c74 6970          # multip
-0000d8a0: 6c65 7820 2872 6564 7563 6520 6e75 6d62  lex (reduce numb
-0000d8b0: 6572 206f 6620 6672 616d 6573 290d 0a20  er of frames).. 
-0000d8c0: 2020 2020 2020 2069 6620 7365 6c66 2e53         if self.S
-0000d8d0: 444d 206f 7220 7365 6c66 2e57 444d 206f  DM or self.WDM o
-0000d8e0: 7220 7365 6c66 2e46 444d 3a0d 0a20 2020  r self.FDM:..   
-0000d8f0: 2020 2020 2020 2020 2049 203d 2073 656c           I = sel
-0000d900: 662e 5f6d 756c 7469 706c 6578 2849 2c20  f._multiplex(I, 
-0000d910: 7269 6e74 290d 0a0d 0a20 2020 2020 2020  rint)....       
-0000d920: 2023 2061 7070 6c79 2069 6e73 6372 6962   # apply inscrib
-0000d930: 6564 2063 6972 636c 650d 0a20 2020 2020  ed circle..     
-0000d940: 2020 2069 6620 7365 6c66 2e67 7269 6420     if self.grid 
-0000d950: 696e 205b 2270 6f6c 6172 222c 2022 6c6f  in ["polar", "lo
-0000d960: 672d 706f 6c61 7222 5d3a 0d0a 2020 2020  g-polar"]:..    
-0000d970: 2020 2020 2020 2020 4920 2a3d 2067 7269          I *= gri
-0000d980: 642e 696e 6e65 7263 6972 6328 7365 6c66  d.innercirc(self
-0000d990: 2e59 2c20 7365 6c66 2e58 295b 4e6f 6e65  .Y, self.X)[None
-0000d9a0: 2c20 3a2c 203a 2c20 4e6f 6e65 5d0d 0a0d  , :, :, None]...
-0000d9b0: 0a20 2020 2020 2020 2023 2063 6f6c 6f72  .        # color
-0000d9c0: 697a 6520 2865 7874 656e 6465 6420 6176  ize (extended av
-0000d9d0: 6572 6167 696e 6729 0d0a 2020 2020 2020  eraging)..      
-0000d9e0: 2020 6966 2073 656c 662e 4820 3e20 3120    if self.H > 1 
-0000d9f0: 6f72 206e 702e 616e 7928 7365 6c66 2e68  or np.any(self.h
-0000da00: 2021 3d20 3235 3529 3a20 2023 2063 616e   != 255):  # can
-0000da10: 2062 6520 7573 6564 2066 6f72 2065 7874   be used for ext
-0000da20: 656e 6465 6420 6176 6572 6167 696e 670d  ended averaging.
-0000da30: 0a20 2020 2020 2020 2020 2020 2049 203d  .            I =
-0000da40: 2073 656c 662e 5f63 6f6c 6f72 697a 6528   self._colorize(
-0000da50: 492c 2066 7261 6d65 7329 0d0a 0d0a 2020  I, frames)....  
-0000da60: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-0000da70: 722e 696e 666f 2866 227b 7369 2874 696d  r.info(f"{si(tim
-0000da80: 652e 7065 7266 5f63 6f75 6e74 6572 2829  e.perf_counter()
-0000da90: 202d 2074 3029 7d73 2229 0d0a 0d0a 2020   - t0)}s")....  
-0000daa0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0000dab0: 662e 5f73 696d 756c 6174 6528 492c 2073  f._simulate(I, s
-0000dac0: 656c 662e 6d61 676e 6966 6963 6174 696f  elf.magnificatio
-0000dad0: 6e2c 2073 656c 662e 5053 462c 2073 656c  n, self.PSF, sel
-0000dae0: 662e 6761 696e 2c20 302c 2073 656c 662e  f.gain, 0, self.
-0000daf0: 6461 726b 2920 6966 2073 696d 756c 6174  dark) if simulat
-0000db00: 6520 656c 7365 2049 0d0a 0d0a 2020 2020  e else I....    
-0000db10: 6465 6620 6465 636f 6465 280d 0a20 2020  def decode(..   
-0000db20: 2020 2020 2073 656c 662c 0d0a 2020 2020       self,..    
-0000db30: 2020 2020 493a 206e 702e 6e64 6172 7261      I: np.ndarra
-0000db40: 792c 0d0a 2020 2020 2020 2020 7665 7262  y,..        verb
-0000db50: 6f73 653a 2062 6f6f 6c20 3d20 4661 6c73  ose: bool = Fals
-0000db60: 652c 0d0a 2020 2020 2020 2020 6465 7370  e,..        desp
-0000db70: 696b 653a 2062 6f6f 6c20 3d20 4661 6c73  ike: bool = Fals
-0000db80: 652c 0d0a 2020 2020 2020 2020 6465 6e6f  e,..        deno
-0000db90: 6973 653a 2062 6f6f 6c20 3d20 4661 6c73  ise: bool = Fals
-0000dba0: 652c 0d0a 2020 2020 2920 2d3e 206e 616d  e,..    ) -> nam
-0000dbb0: 6564 7475 706c 653a 0d0a 2020 2020 2020  edtuple:..      
-0000dbc0: 2020 7222 2222 4465 636f 6465 2066 7269    r"""Decode fri
-0000dbd0: 6e67 6520 7061 7474 6572 6e73 2e0d 0a0d  nge patterns....
-0000dbe0: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-0000dbf0: 6572 730d 0a20 2020 2020 2020 202d 2d2d  ers..        ---
-0000dc00: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
-0000dc10: 2049 203a 206e 702e 6e64 6172 7261 790d   I : np.ndarray.
-0000dc20: 0a20 2020 2020 2020 2020 2020 2046 7269  .            Fri
-0000dc30: 6e67 6520 7061 7474 6572 6e20 7365 7175  nge pattern sequ
-0000dc40: 656e 6365 2e0d 0a20 2020 2020 2020 2020  ence...         
-0000dc50: 2020 2049 7420 6973 2072 6573 6861 7065     It is reshape
-0000dc60: 6420 746f 2076 6964 656f 7368 6170 6520  d to videoshape 
-0000dc70: 2866 7261 6d65 7320 6054 602c 2068 6569  (frames `T`, hei
-0000dc80: 6768 7420 6059 602c 2077 6964 7468 2060  ght `Y`, width `
-0000dc90: 5860 2c20 636f 6c6f 7220 6368 616e 6e65  X`, color channe
-0000dca0: 6c73 2060 4360 2920 6265 666f 7265 2070  ls `C`) before p
-0000dcb0: 726f 6365 7373 696e 672e 0d0a 0d0a 2020  rocessing.....  
-0000dcc0: 2020 2020 2020 2020 2020 2e2e 206e 6f74            .. not
-0000dcd0: 653a 3a20 4974 206d 7573 7420 6861 7665  e:: It must have
-0000dce0: 2062 6565 6e20 656e 636f 6465 6420 7769   been encoded wi
-0000dcf0: 7468 2074 6865 2073 616d 6520 7061 7261  th the same para
-0000dd00: 6d65 7465 7273 2073 6574 2074 6f20 7468  meters set to th
-0000dd10: 6520 4672 696e 6765 7320 696e 7374 616e  e Fringes instan
-0000dd20: 6365 2061 7320 7468 6520 656e 636f 6465  ce as the encode
-0000dd30: 6420 6f6e 652e 0d0a 0d0a 2020 2020 2020  d one.....      
-0000dd40: 2020 7665 7262 6f73 6520 3a20 626f 6f6c    verbose : bool
-0000dd50: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
-0000dd60: 2020 2020 2020 2020 4966 2074 6869 7320          If this 
-0000dd70: 6f72 2074 6865 2061 7267 756d 656e 7420  or the argument 
-0000dd80: 6076 6572 626f 7365 6020 6f66 2074 6865  `verbose` of the
-0000dd90: 2046 7269 6e67 6573 2069 6e73 7461 6e63   Fringes instanc
-0000dda0: 6520 6973 2073 6574 2074 6f20 5472 7565  e is set to True
-0000ddb0: 2c0d 0a20 2020 2020 2020 2020 2020 2061  ,..            a
-0000ddc0: 6464 6974 696f 6e61 6c20 696e 666f 6d61  dditional infoma
-0000ddd0: 7469 6f6e 2069 7320 636f 6d70 7574 6564  tion is computed
-0000dde0: 2061 6e64 2072 6574 756e 6564 2e0d 0a20   and retuned... 
-0000ddf0: 2020 2020 2020 2020 2020 2054 6869 7320             This 
-0000de00: 696e 636c 7564 6573 3a20 7068 6173 652c  includes: phase,
-0000de10: 2072 6573 6964 7561 6c73 2c20 6f72 6465   residuals, orde
-0000de20: 7273 2c20 756e 6365 7274 6169 6e74 792c  rs, uncertainty,
-0000de30: 2076 6973 6962 696c 6974 7920 616e 6420   visibility and 
-0000de40: 6578 706f 7375 7265 2e0d 0a0d 0a20 2020  exposure.....   
-0000de50: 2020 2020 2064 6573 7069 6b65 3a20 626f       despike: bo
-0000de60: 6f6c 2c20 6f70 7469 6f6e 616c 0d0a 2020  ol, optional..  
-0000de70: 2020 2020 2020 2020 2020 4966 2074 6869            If thi
-0000de80: 7320 6973 2073 6574 2074 6f20 7472 7565  s is set to true
-0000de90: 2c20 7369 6e67 6c65 2070 6978 656c 206f  , single pixel o
-0000dea0: 7574 6c69 6572 7320 696e 2074 6865 2075  utliers in the u
-0000deb0: 6e77 7261 7070 6564 2070 6861 7365 206d  nwrapped phase m
-0000dec0: 6170 2061 7265 2072 6570 6c61 6365 640d  ap are replaced.
-0000ded0: 0a20 2020 2020 2020 2020 2020 2062 7920  .            by 
-0000dee0: 7468 6569 7220 6c6f 6361 6c20 6e65 6967  their local neig
-0000def0: 6862 6f72 686f 6f64 2075 7369 6e67 2061  hborhood using a
-0000df00: 206d 6564 6961 6e20 6669 6c74 6572 2e0d   median filter..
-0000df10: 0a0d 0a20 2020 2020 2020 2064 656e 6f69  ...        denoi
-0000df20: 7365 3a20 626f 6f6c 2c20 6f70 7469 6f6e  se: bool, option
-0000df30: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-0000df40: 4966 2074 6869 7320 6973 2073 6574 2074  If this is set t
-0000df50: 6f20 5472 7565 2c20 7468 6520 756e 7772  o True, the unwr
-0000df60: 6170 7065 6420 7068 6173 6520 6d61 7020  apped phase map 
-0000df70: 6973 2073 6d6f 6f74 6865 6e65 640d 0a20  is smoothened.. 
-0000df80: 2020 2020 2020 2020 2020 2062 7920 6120             by a 
-0000df90: 6269 6c61 7465 7261 6c20 6669 6c74 6572  bilateral filter
-0000dfa0: 2077 6869 6368 2069 7320 6564 6765 2d70   which is edge-p
-0000dfb0: 7265 7365 7276 696e 672e 0d0a 0d0a 2020  reserving.....  
-0000dfc0: 2020 2020 2020 5265 7475 726e 730d 0a20        Returns.. 
-0000dfd0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0d0a         -------..
-0000dfe0: 2020 2020 2020 2020 6272 6967 6874 6e65          brightne
-0000dff0: 7373 203a 206e 702e 6e64 6172 7261 790d  ss : np.ndarray.
-0000e000: 0a20 2020 2020 2020 2020 2020 204c 6f63  .            Loc
-0000e010: 616c 2062 6163 6b67 726f 756e 6420 7369  al background si
-0000e020: 676e 616c 2e0d 0a0d 0a20 2020 2020 2020  gnal.....       
-0000e030: 206d 6f64 756c 6174 696f 6e20 3a20 6e70   modulation : np
-0000e040: 2e6e 6461 7272 6179 0d0a 2020 2020 2020  .ndarray..      
-0000e050: 2020 2020 2020 4c6f 6361 6c20 616d 706c        Local ampl
-0000e060: 6974 7564 6520 6f66 2074 6865 2063 6f73  itude of the cos
-0000e070: 696e 6520 7369 676e 616c 2e0d 0a0d 0a20  ine signal..... 
-0000e080: 2020 2020 2020 2072 6567 6973 7472 6174         registrat
-0000e090: 696f 6e20 3a20 6e70 2e6e 6461 7272 6179  ion : np.ndarray
-0000e0a0: 0d0a 2020 2020 2020 2020 2020 2020 4465  ..            De
-0000e0b0: 636f 6465 6420 636f 6f72 6469 6e61 7465  coded coordinate
-0000e0c0: 732e 0d0a 0d0a 2020 2020 2020 2020 2020  s.....          
-0000e0d0: 2020 2e2e 206e 6f74 653a 3a20 5468 6520    .. note:: The 
-0000e0e0: 7265 6769 7374 7261 7469 6f6e 2069 7320  registration is 
-0000e0f0: 6120 6d61 7070 696e 6720 696e 2074 6865  a mapping in the
-0000e100: 2073 616d 6520 7069 7865 6c20 6772 6964   same pixel grid
-0000e110: 2061 7320 7468 6520 6361 6d65 7261 2073   as the camera s
-0000e120: 656e 736f 720d 0a20 2020 2020 2020 2020  ensor..         
-0000e130: 2020 2020 2061 6e64 2063 6f6e 7461 696e       and contain
-0000e140: 7320 7468 6520 696e 666f 726d 6174 696f  s the informatio
-0000e150: 6e20 7768 6572 6520 6561 6368 2063 616d  n where each cam
-0000e160: 6572 6120 7069 7865 6c2c 2069 2e65 2e20  era pixel, i.e. 
-0000e170: 6561 6368 2063 616d 6572 6120 7369 6768  each camera sigh
-0000e180: 7472 6179 2c0d 0a20 2020 2020 2020 2020  tray,..         
-0000e190: 2020 2020 2077 6173 206c 6f6f 6b69 6e67       was looking
-0000e1a0: 2061 7420 6475 7269 6e67 2074 6865 2066   at during the f
-0000e1b0: 7269 6e67 6520 7061 7474 6572 6e20 6163  ringe pattern ac
-0000e1c0: 7175 6973 6974 696f 6e2e 0d0a 0d0a 2020  quisition.....  
-0000e1d0: 2020 2020 2020 7068 6173 6520 3a20 6e70        phase : np
-0000e1e0: 2e6e 6461 7272 6179 2c20 6f70 7469 6f6e  .ndarray, option
-0000e1f0: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-0000e200: 4c6f 6361 6c20 7068 6173 652e 0d0a 0d0a  Local phase.....
-0000e210: 2020 2020 2020 2020 6f72 6465 7273 203a          orders :
-0000e220: 206e 702e 6e64 6172 7261 792c 206f 7074   np.ndarray, opt
-0000e230: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
-0000e240: 2020 2046 7269 6e67 6520 6f72 6465 7273     Fringe orders
-0000e250: 2e0d 0a0d 0a20 2020 2020 2020 2072 6573  .....        res
-0000e260: 6964 7561 6c73 203a 206e 702e 6e64 6172  iduals : np.ndar
-0000e270: 7261 792c 206f 7074 696f 6e61 6c0d 0a20  ray, optional.. 
-0000e280: 2020 2020 2020 2020 2020 2052 6573 6964             Resid
-0000e290: 7561 6c73 2066 726f 6d20 7468 6520 6f70  uals from the op
-0000e2a0: 7469 6d69 7a61 7469 6f6e 2d62 6173 6564  timization-based
-0000e2b0: 2075 6e77 7261 7070 696e 6720 7072 6f63   unwrapping proc
-0000e2c0: 6573 732e 0d0a 0d0a 2020 2020 2020 2020  ess.....        
-0000e2d0: 756e 6365 7274 6169 6e74 7920 3a20 6e70  uncertainty : np
-0000e2e0: 2e6e 6461 7272 6179 2c20 6f70 7469 6f6e  .ndarray, option
-0000e2f0: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-0000e300: 756e 6365 7274 6169 6e74 7920 6f66 2070  uncertainty of p
-0000e310: 6f73 6974 696f 6e61 6c20 6465 636f 6469  ositional decodi
-0000e320: 6e67 2069 6e20 7069 7865 6c20 756e 6974  ng in pixel unit
-0000e330: 730d 0a0d 0a20 2020 2020 2020 2076 6973  s....        vis
-0000e340: 6962 696c 6974 7920 3a20 6e70 2e6e 6461  ibility : np.nda
-0000e350: 7272 6179 2c20 6f70 7469 6f6e 616c 0d0a  rray, optional..
-0000e360: 2020 2020 2020 2020 2020 2020 4c6f 6361              Loca
-0000e370: 6c20 7669 7369 6269 6c69 7479 2028 6672  l visibility (fr
-0000e380: 696e 6765 2063 6f6e 7472 6173 7429 2e0d  inge contrast)..
-0000e390: 0a0d 0a20 2020 2020 2020 2065 7870 6f73  ...        expos
-0000e3a0: 7572 6520 3a20 6e70 2e6e 6461 7272 6179  ure : np.ndarray
-0000e3b0: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
-0000e3c0: 2020 2020 2020 2020 4c6f 6361 6c20 6578          Local ex
-0000e3d0: 706f 7375 7265 2028 7265 6c61 7469 7665  posure (relative
-0000e3e0: 2061 7665 7261 6765 2069 6e74 656e 7369   average intensi
-0000e3f0: 7479 292e 0d0a 0d0a 2020 2020 2020 2020  ty).....        
-0000e400: 5261 6973 6573 0d0a 2020 2020 2020 2020  Raises..        
-0000e410: 2d2d 2d2d 2d2d 0d0a 2020 2020 2020 2020  ------..        
-0000e420: 4173 7365 7274 696f 6e45 7272 6f72 0d0a  AssertionError..
-0000e430: 2020 2020 2020 2020 2020 2020 4966 2074              If t
-0000e440: 6865 206e 756d 6265 7220 6f66 2066 7261  he number of fra
-0000e450: 6d65 7320 6f66 2060 4960 2061 6e64 2074  mes of `I` and t
-0000e460: 6865 2061 7474 7269 6275 7465 2060 5460  he attribute `T`
-0000e470: 206f 6620 7468 6520 6046 7269 6e67 6573   of the `Fringes
-0000e480: 6020 696e 7374 616e 6365 2064 6f6e 2774  ` instance don't
-0000e490: 206d 6174 6368 2e0d 0a0d 0a20 2020 2020   match.....     
-0000e4a0: 2020 2045 7861 6d70 6c65 730d 0a20 2020     Examples..   
-0000e4b0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0d 0a20       --------.. 
-0000e4c0: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
-0000e4d0: 7420 6672 696e 6765 7320 6173 2066 726e  t fringes as frn
-0000e4e0: 670d 0a20 2020 2020 2020 203e 3e3e 2066  g..        >>> f
-0000e4f0: 203d 2066 726e 672e 4672 696e 6765 7328   = frng.Fringes(
-0000e500: 290d 0a20 2020 2020 2020 203e 3e3e 2049  )..        >>> I
-0000e510: 203d 2066 2e65 6e63 6f64 6528 290d 0a0d   = f.encode()...
-0000e520: 0a20 2020 2020 2020 203e 3e3e 2041 2c20  .        >>> A, 
-0000e530: 422c 2078 203d 2066 2e64 6563 6f64 6528  B, x = f.decode(
-0000e540: 4929 0d0a 0d0a 2020 2020 2020 2020 3e3e  I)....        >>
-0000e550: 3e20 412c 2042 2c20 782c 2070 2c20 6b2c  > A, B, x, p, k,
-0000e560: 2072 2c20 752c 2056 2c20 4820 3d20 662e   r, u, V, H = f.
-0000e570: 6465 636f 6465 2849 2c20 7665 7262 6f73  decode(I, verbos
-0000e580: 653d 5472 7565 290d 0a20 2020 2020 2020  e=True)..       
-0000e590: 2022 2222 0d0a 0d0a 2020 2020 2020 2020   """....        
-0000e5a0: 7430 203d 2074 696d 652e 7065 7266 5f63  t0 = time.perf_c
-0000e5b0: 6f75 6e74 6572 2829 0d0a 0d0a 2020 2020  ounter()....    
-0000e5c0: 2020 2020 2320 6765 7420 616e 6420 6170      # get and ap
-0000e5d0: 706c 7920 7669 6465 6f73 6861 7065 0d0a  ply videoshape..
-0000e5e0: 2020 2020 2020 2020 542c 2059 2c20 582c          T, Y, X,
-0000e5f0: 2043 203d 2076 7368 6170 6528 4929 2e73   C = vshape(I).s
-0000e600: 6861 7065 2020 2320 6578 7472 6163 7420  hape  # extract 
-0000e610: 592c 2058 2c20 4320 6672 6f6d 2064 6174  Y, X, C from dat
-0000e620: 6120 6173 2074 6865 7365 2070 6172 616d  a as these param
-0000e630: 6574 6572 7320 6465 7065 6e64 206f 6e20  eters depend on 
-0000e640: 7468 6520 7573 6564 2063 616d 6572 610d  the used camera.
-0000e650: 0a20 2020 2020 2020 2049 203d 2049 2e72  .        I = I.r
-0000e660: 6573 6861 7065 2828 542c 2059 2c20 582c  eshape((T, Y, X,
-0000e670: 2043 2929 0d0a 0d0a 2020 2020 2020 2020   C))....        
-0000e680: 2320 7375 6274 7261 6374 2064 6172 6b20  # subtract dark 
-0000e690: 7369 676e 616c 0d0a 2020 2020 2020 2020  signal..        
-0000e6a0: 6966 2073 656c 662e 7930 203e 2030 3a0d  if self.y0 > 0:.
-0000e6b0: 0a20 2020 2020 2020 2020 2020 2049 5b49  .            I[I
-0000e6c0: 203e 3d20 7365 6c66 2e79 305d 203d 2049   >= self.y0] = I
-0000e6d0: 5b49 203e 3d20 7365 6c66 2e79 305d 202d  [I >= self.y0] -
-0000e6e0: 2073 656c 662e 7930 0d0a 2020 2020 2020   self.y0..      
-0000e6f0: 2020 2020 2020 495b 4920 3c20 7365 6c66        I[I < self
-0000e700: 2e79 305d 203d 2030 0d0a 0d0a 2020 2020  .y0] = 0....    
-0000e710: 2020 2020 2320 6465 636f 6c6f 7269 7a65      # decolorize
-0000e720: 2028 6675 7365 2068 7565 732f 636f 6c6f   (fuse hues/colo
-0000e730: 7273 2920 5b66 6f72 2067 7261 7920 6672  rs) [for gray fr
-0000e740: 696e 6765 732c 2063 6f6c 6f72 2066 7573  inges, color fus
-0000e750: 696f 6e20 6973 206e 6f74 2070 6572 666f  ion is not perfo
-0000e760: 726d 6564 2c20 6275 7420 6578 7465 6e64  rmed, but extend
-0000e770: 6564 2061 7665 7261 6769 6e67 2069 735d  ed averaging is]
-0000e780: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0000e790: 662e 4820 3e20 3120 6f72 206e 6f74 2073  f.H > 1 or not s
-0000e7a0: 656c 662e 5f6d 6f6e 6f63 6872 6f6d 653a  elf._monochrome:
-0000e7b0: 0d0a 2020 2020 2020 2020 2020 2020 4920  ..            I 
-0000e7c0: 3d20 7365 6c66 2e5f 6465 636f 6c6f 7269  = self._decolori
-0000e7d0: 7a65 2849 290d 0a0d 0a20 2020 2020 2020  ze(I)....       
-0000e7e0: 2023 2064 656d 756c 7469 706c 6578 0d0a   # demultiplex..
-0000e7f0: 2020 2020 2020 2020 6966 2028 0d0a 2020          if (..  
-0000e800: 2020 2020 2020 2020 2020 7365 6c66 2e53            self.S
-0000e810: 444d 2061 6e64 2031 206e 6f74 2069 6e20  DM and 1 not in 
-0000e820: 7365 6c66 2e4e 206f 7220 7365 6c66 2e57  self.N or self.W
-0000e830: 444d 206f 7220 7365 6c66 2e46 444d 0d0a  DM or self.FDM..
-0000e840: 2020 2020 2020 2020 293a 2020 2320 746f          ):  # to
-0000e850: 646f 3a20 6966 2073 656c 662e 5344 4d20  do: if self.SDM 
-0000e860: 616e 6420 3120 696e 2073 656c 662e 4e3a  and 1 in self.N:
-0000e870: 2046 6f75 7269 6572 2d74 7261 6e73 666f   Fourier-transfo
-0000e880: 726d 206d 6574 686f 640d 0a20 2020 2020  rm method..     
-0000e890: 2020 2020 2020 2049 203d 2073 656c 662e         I = self.
-0000e8a0: 5f64 656d 756c 7469 706c 6578 2849 290d  _demultiplex(I).
-0000e8b0: 0a0d 0a20 2020 2020 2020 2023 2064 656d  ...        # dem
-0000e8c0: 6f64 756c 6174 650d 0a20 2020 2020 2020  odulate..       
-0000e8d0: 2062 7269 2c20 6d6f 642c 2070 6869 2c20   bri, mod, phi, 
-0000e8e0: 7265 672c 2072 6573 203d 2073 656c 662e  reg, res = self.
-0000e8f0: 5f64 656d 6f64 756c 6174 6528 492c 2076  _demodulate(I, v
-0000e900: 6572 626f 7365 290d 0a0d 0a20 2020 2020  erbose)....     
-0000e910: 2020 2023 2076 6572 626f 7365 0d0a 2020     # verbose..  
-0000e920: 2020 2020 2020 6966 2073 656c 662e 7665        if self.ve
-0000e930: 7262 6f73 6520 6f72 2076 6572 626f 7365  rbose or verbose
-0000e940: 3a0d 0a20 2020 2020 2020 2020 2020 2075  :..            u
-0000e950: 6e63 2c20 6669 642c 2076 6973 2c20 6578  nc, fid, vis, ex
-0000e960: 7020 3d20 7365 6c66 2e5f 7665 7262 6f73  p = self._verbos
-0000e970: 655f 2849 2c20 6272 692c 206d 6f64 2c20  e_(I, bri, mod, 
-0000e980: 7265 6729 0d0a 0d0a 2020 2020 2020 2020  reg)....        
-0000e990: 2320 626c 6163 6b65 6e20 7768 6572 6520  # blacken where 
-0000e9a0: 636f 6c6f 7220 7661 6c75 6520 6f66 2068  color value of h
-0000e9b0: 7565 2077 6173 2062 6c61 636b 0d0a 2020  ue was black..  
-0000e9c0: 2020 2020 2020 6966 2073 656c 662e 4820        if self.H 
-0000e9d0: 3e20 3120 616e 6420 4320 3d3d 2033 3a0d  > 1 and C == 3:.
-0000e9e0: 0a20 2020 2020 2020 2020 2020 2069 6478  .            idx
-0000e9f0: 203d 206e 702e 7375 6d28 7365 6c66 2e68   = np.sum(self.h
-0000ea00: 2c20 6178 6973 3d30 2920 3d3d 2030 0d0a  , axis=0) == 0..
-0000ea10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000ea20: 702e 616e 7928 6964 7829 3a20 2023 2062  p.any(idx):  # b
-0000ea30: 6c61 636b 656e 2077 6865 7265 2063 6f6c  lacken where col
-0000ea40: 6f72 2076 616c 7565 206f 6620 6875 6520  or value of hue 
-0000ea50: 7761 7320 626c 6163 6b0d 0a20 2020 2020  was black..     
-0000ea60: 2020 2020 2020 2020 2020 2062 7269 5b2e             bri[.
-0000ea70: 2e2e 2c20 6964 785d 203d 2030 0d0a 2020  .., idx] = 0..  
-0000ea80: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0000ea90: 645b 2e2e 2e2c 2069 6478 5d20 3d20 300d  d[..., idx] = 0.
-0000eaa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eab0: 2072 6567 5b2e 2e2e 2c20 6964 785d 203d   reg[..., idx] =
-0000eac0: 206e 702e 6e61 6e0d 0a20 2020 2020 2020   np.nan..       
-0000ead0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000eae0: 2e76 6572 626f 7365 3a0d 0a20 2020 2020  .verbose:..     
-0000eaf0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0000eb00: 6e63 5b2e 2e2e 2c20 6964 785d 203d 206e  nc[..., idx] = n
-0000eb10: 702e 6e61 6e20 2023 2073 656c 662e 5220  p.nan  # self.R 
-0000eb20: 2f20 6e70 2e73 7172 7428 3132 2920 2023  / np.sqrt(12)  #
-0000eb30: 2074 6f64 6f3a 2063 6972 6375 6c61 7220   todo: circular 
-0000eb40: 6469 7374 7269 6275 7469 6f6e 203d 0d0a  distribution =..
-0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb60: 2020 2020 7068 695b 2e2e 2e2c 2069 6478      phi[..., idx
-0000eb70: 5d20 3d20 6e70 2e6e 616e 0d0a 2020 2020  ] = np.nan..    
-0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb90: 6669 645b 2e2e 2e2c 2069 6478 5d20 3d20  fid[..., idx] = 
-0000eba0: 6e70 2e6e 616e 0d0a 2020 2020 2020 2020  np.nan..        
-0000ebb0: 2020 2020 2020 2020 2020 2020 7669 735b              vis[
-0000ebc0: 2e2e 2e2c 2069 6478 5d20 3d20 300d 0a20  ..., idx] = 0.. 
-0000ebd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebe0: 2020 2065 7870 5b2e 2e2e 2c20 6964 785d     exp[..., idx]
-0000ebf0: 203d 2030 0d0a 0d0a 2020 2020 2020 2020   = 0....        
-0000ec00: 2320 7370 6174 6961 6c20 756e 7772 6170  # spatial unwrap
-0000ec10: 7069 6e67 0d0a 2020 2020 2020 2020 6966  ping..        if
-0000ec20: 2073 656c 662e 5f61 6d62 6967 756f 7573   self._ambiguous
-0000ec30: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
-0000ec40: 656c 662e 6c6f 6767 6572 2e77 6172 6e69  elf.logger.warni
-0000ec50: 6e67 2822 556e 7772 6170 7069 6e67 2069  ng("Unwrapping i
-0000ec60: 7320 6e6f 7420 7370 6174 6961 6c6c 7920  s not spatially 
-0000ec70: 696e 6465 7065 6e64 656e 7420 616e 6420  independent and 
-0000ec80: 6f6e 6c79 2079 6965 6c64 7320 6120 7265  only yields a re
-0000ec90: 6c61 7469 7665 2070 6861 7365 206d 6170  lative phase map
-0000eca0: 2e22 290d 0a20 2020 2020 2020 2020 2020  .")..           
-0000ecb0: 2075 7772 203d 2073 656c 662e 5f75 6e77   uwr = self._unw
-0000ecc0: 7261 7028 7265 672c 2062 7269 290d 0a0d  rap(reg, bri)...
-0000ecd0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000ece0: 7365 6c66 2e76 6572 626f 7365 3a0d 0a20  self.verbose:.. 
-0000ecf0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000ed00: 6567 2c20 7265 7320 3d20 7577 720d 0a20  eg, res = uwr.. 
-0000ed10: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000ed20: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000ed30: 2020 7265 6720 3d20 7577 720d 0a20 2020    reg = uwr..   
-0000ed40: 2020 2020 2065 6c73 653a 2020 2320 636f       else:  # co
-0000ed50: 6f72 6469 616e 7465 2072 6574 7261 6e73  ordiante retrans
-0000ed60: 666f 726d 6174 696f 6e0d 0a20 2020 2020  formation..     
-0000ed70: 2020 2020 2020 2023 2074 6f64 6f3a 2074         # todo: t
-0000ed80: 6573 7473 0d0a 0d0a 2020 2020 2020 2020  ests....        
-0000ed90: 2020 2020 6966 2073 656c 662e 4420 3d3d      if self.D ==
-0000eda0: 2032 3a0d 0a20 2020 2020 2020 2020 2020   2:..           
-0000edb0: 2020 2020 2023 2074 6f64 6f3a 2073 7761       # todo: swa
-0000edc0: 7061 7865 730d 0a20 2020 2020 2020 2020  paxes..         
-0000edd0: 2020 2020 2020 2069 6620 7365 6c66 2e67         if self.g
-0000ede0: 7269 6420 3d3d 2022 4361 7274 6573 6961  rid == "Cartesia
-0000edf0: 6e22 3a0d 0a20 2020 2020 2020 2020 2020  n":..           
-0000ee00: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000ee10: 2e58 203e 3d20 7365 6c66 2e59 3a0d 0a20  .X >= self.Y:.. 
-0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee30: 2020 2020 2020 2072 6567 5b30 5d20 2b3d         reg[0] +=
-0000ee40: 2073 656c 662e 5820 2f20 3220 2d20 302e   self.X / 2 - 0.
-0000ee50: 350d 0a20 2020 2020 2020 2020 2020 2020  5..             
-0000ee60: 2020 2020 2020 2020 2020 2072 6567 5b30             reg[0
-0000ee70: 5d20 253d 2073 656c 662e 580d 0a20 2020  ] %= self.X..   
-0000ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee90: 2020 2020 2072 6567 5b31 5d20 2a3d 202d       reg[1] *= -
-0000eea0: 310d 0a20 2020 2020 2020 2020 2020 2020  1..             
-0000eeb0: 2020 2020 2020 2020 2020 2072 6567 5b31             reg[1
-0000eec0: 5d20 2b3d 2073 656c 662e 5920 2f20 3220  ] += self.Y / 2 
-0000eed0: 2d20 302e 350d 0a20 2020 2020 2020 2020  - 0.5..         
-0000eee0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000eef0: 6567 5b31 5d20 253d 2073 656c 662e 580d  eg[1] %= self.X.
-0000ef00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ef10: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-0000ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef30: 2020 2020 7265 675b 305d 202b 3d20 7365      reg[0] += se
-0000ef40: 6c66 2e58 202f 2032 202d 2030 2e35 0d0a  lf.X / 2 - 0.5..
-0000ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef60: 2020 2020 2020 2020 7265 675b 305d 2025          reg[0] %
-0000ef70: 3d20 7365 6c66 2e59 0d0a 2020 2020 2020  = self.Y..      
-0000ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef90: 2020 7265 675b 315d 202a 3d20 2d31 0d0a    reg[1] *= -1..
-0000efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efb0: 2020 2020 2020 2020 7265 675b 315d 202b          reg[1] +
-0000efc0: 3d20 7365 6c66 2e59 202f 2032 202d 2030  = self.Y / 2 - 0
-0000efd0: 2e35 0d0a 2020 2020 2020 2020 2020 2020  .5..            
-0000efe0: 2020 2020 2020 2020 2020 2020 7265 675b              reg[
-0000eff0: 315d 2025 3d20 7365 6c66 2e59 0d0a 0d0a  1] %= self.Y....
-0000f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f010: 2320 746f 646f 3a20 706f 6c61 722c 206c  # todo: polar, l
-0000f020: 6f67 706f 6c61 720d 0a0d 0a20 2020 2020  ogpolar....     
-0000f030: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000f040: 6c66 2e61 6e67 6c65 2021 3d20 303a 0d0a  lf.angle != 0:..
-0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f060: 2020 2020 7420 3d20 6e70 2e64 6567 3272      t = np.deg2r
-0000f070: 6164 282d 7365 6c66 2e61 6e67 6c65 290d  ad(-self.angle).
-0000f080: 0a0d 0a20 2020 2020 2020 2020 2020 2020  ...             
-0000f090: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
-0000f0a0: 6e67 6c65 2025 2039 3020 3d3d 2030 3a0d  ngle % 90 == 0:.
-0000f0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f0c0: 2020 2020 2020 2020 2063 203d 206e 702e           c = np.
-0000f0d0: 636f 7328 7429 0d0a 2020 2020 2020 2020  cos(t)..        
-0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0f0: 7320 3d20 6e70 2e73 696e 2874 290d 0a20  s = np.sin(t).. 
-0000f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f110: 2020 2020 2020 2052 203d 206e 702e 6172         R = np.ar
-0000f120: 7261 7928 5b5b 632c 202d 735d 2c20 5b73  ray([[c, -s], [s
-0000f130: 2c20 635d 5d29 0d0a 2020 2020 2020 2020  , c]])..        
-0000f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f150: 2320 5220 3d20 6e70 2e6d 6174 7269 7828  # R = np.matrix(
-0000f160: 5b5b 632c 202d 735d 2c20 5b73 2c20 635d  [[c, -s], [s, c]
-0000f170: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
-0000f180: 2020 2020 2020 2020 2020 2020 7572 203d              ur =
-0000f190: 2052 5b30 2c20 305d 202a 2072 6567 5b30   R[0, 0] * reg[0
-0000f1a0: 5d20 2b20 525b 302c 2031 5d20 2a20 7265  ] + R[0, 1] * re
-0000f1b0: 675b 315d 0d0a 2020 2020 2020 2020 2020  g[1]..          
-0000f1c0: 2020 2020 2020 2020 2020 2020 2020 7672                vr
-0000f1d0: 203d 2052 5b31 2c20 305d 202a 2072 6567   = R[1, 0] * reg
-0000f1e0: 5b30 5d20 2b20 525b 312c 2031 5d20 2a20  [0] + R[1, 1] * 
-0000f1f0: 7265 675b 325d 0d0a 2020 2020 2020 2020  reg[2]..        
-0000f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f210: 2320 7520 3d20 6e70 2e64 6f74 2875 752c  # u = np.dot(uu,
-0000f220: 2052 2920 2023 2074 6f64 6f3a 206d 6174   R)  # todo: mat
-0000f230: 7269 7820 6d75 6c74 6970 6c69 6361 7469  rix multiplicati
-0000f240: 6f6e 0d0a 2020 2020 2020 2020 2020 2020  on..            
-0000f250: 2020 2020 2020 2020 2020 2020 2320 7620              # v 
-0000f260: 3d20 6e70 2e64 6f74 2876 762c 2052 290d  = np.dot(vv, R).
-0000f270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f280: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-0000f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2a0: 2020 2020 7461 6e20 3d20 6e70 2e74 616e      tan = np.tan
-0000f2b0: 2874 290d 0a20 2020 2020 2020 2020 2020  (t)..           
-0000f2c0: 2020 2020 2020 2020 2020 2020 2075 7220               ur 
-0000f2d0: 3d20 7265 675b 305d 202d 2072 6567 5b31  = reg[0] - reg[1
-0000f2e0: 5d20 2a20 6e70 2e74 616e 2874 290d 0a20  ] * np.tan(t).. 
-0000f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f300: 2020 2020 2020 2076 7220 3d20 7265 675b         vr = reg[
-0000f310: 305d 202b 2072 6567 5b31 5d20 2f20 6e70  0] + reg[1] / np
-0000f320: 2e74 616e 2874 290d 0a0d 0a20 2020 2020  .tan(t)....     
-0000f330: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0000f340: 7620 3d20 2872 6567 5b31 5d20 2d20 7265  v = (reg[1] - re
-0000f350: 675b 305d 2920 2f20 2831 202f 2074 616e  g[0]) / (1 / tan
-0000f360: 202d 2074 616e 290d 0a20 2020 2020 2020   - tan)..       
-0000f370: 2020 2020 2020 2020 2020 2020 2075 7520               uu 
-0000f380: 3d20 7265 675b 305d 202b 2076 7620 2a20  = reg[0] + vv * 
-0000f390: 7461 6e0d 0a20 2020 2020 2020 2020 2020  tan..           
-0000f3a0: 2020 2020 2020 2020 2072 6567 203d 206e           reg = n
-0000f3b0: 702e 7374 6163 6b28 2875 752c 2076 7629  p.stack((uu, vv)
-0000f3c0: 2c20 6178 6973 3d30 290d 0a20 2020 2020  , axis=0)..     
-0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000f3e0: 6567 203d 206e 702e 7374 6163 6b28 2875  eg = np.stack((u
-0000f3f0: 722c 2076 7229 2c20 6178 6973 3d30 290d  r, vr), axis=0).
-0000f400: 0a0d 0a20 2020 2020 2020 2069 6620 6465  ...        if de
-0000f410: 7370 696b 653a 0d0a 2020 2020 2020 2020  spike:..        
-0000f420: 2020 2020 7265 6720 3d20 6d65 6469 616e      reg = median
-0000f430: 2872 6567 2c20 6b3d 3329 0d0a 0d0a 2020  (reg, k=3)....  
-0000f440: 2020 2020 2020 2020 2020 2320 7265 675b            # reg[
-0000f450: 3a2c 202d 312c 202d 312c 202e 2e2e 5d20  :, -1, -1, ...] 
-0000f460: 3d20 300d 0a20 2020 2020 2020 2020 2020  = 0..           
-0000f470: 2023 2072 6567 5b3a 2c20 2d31 302c 202d   # reg[:, -10, -
-0000f480: 3130 2c20 2e2e 2e5d 203d 2030 0d0a 2020  10, ...] = 0..  
-0000f490: 2020 2020 2020 2020 2020 2320 706f 696e            # poin
-0000f4a0: 7473 203d 206e 702e 6172 616e 6765 2859  ts = np.arange(Y
-0000f4b0: 292c 206e 702e 6172 616e 6765 2858 290d  ), np.arange(X).
-0000f4c0: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
-0000f4d0: 6f72 2064 2069 6e20 7261 6e67 6528 7365  or d in range(se
-0000f4e0: 6c66 2e44 293a 0d0a 2020 2020 2020 2020  lf.D):..        
-0000f4f0: 2020 2020 2320 2020 2020 666f 7220 6320      #     for c 
-0000f500: 696e 2072 616e 6765 2843 293a 0d0a 2020  in range(C):..  
-0000f510: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0000f520: 2020 2020 7370 696b 6573 203d 206e 702e      spikes = np.
-0000f530: 6162 7328 7265 675b 642c 203a 2c20 3a2c  abs(reg[d, :, :,
-0000f540: 2063 5d20 2d20 6d65 6469 616e 2872 6567   c] - median(reg
-0000f550: 5b64 2c20 3a2c 203a 2c20 635d 295b 302c  [d, :, :, c])[0,
-0000f560: 203a 2c20 3a2c 2030 5d29 203e 206e 702e   :, :, 0]) > np.
-0000f570: 7374 6428 7265 675b 642c 203a 2c20 3a2c  std(reg[d, :, :,
-0000f580: 2063 5d29 2020 2320 6269 6c61 7465 7261   c])  # bilatera
-0000f590: 6c0d 0a20 2020 2020 2020 2020 2020 2023  l..            #
-0000f5a0: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-0000f5b0: 3d20 7265 675b 642c 203a 2c20 3a2c 2063  = reg[d, :, :, c
-0000f5c0: 5d0d 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-0000f5d0: 2020 2020 2020 2020 2078 6920 3d20 6e70           xi = np
-0000f5e0: 2e6e 6f6e 7a65 726f 2873 7069 6b65 7329  .nonzero(spikes)
-0000f5f0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000f600: 2020 2020 2020 2020 7661 6c75 6573 5b78          values[x
-0000f610: 695d 203d 2030 0d0a 2020 2020 2020 2020  i] = 0..        
-0000f620: 2020 2020 2320 2020 2020 2020 2020 7869      #         xi
-0000f630: 203d 206e 702e 6172 6777 6865 7265 2873   = np.argwhere(s
-0000f640: 7069 6b65 7329 0d0a 2020 2020 2020 2020  pikes)..        
-0000f650: 2020 2020 2320 2020 2020 2020 2020 6120      #         a 
-0000f660: 3d20 7370 2e69 6e74 6572 706f 6c61 7465  = sp.interpolate
-0000f670: 2e69 6e74 6572 706e 2870 6f69 6e74 732c  .interpn(points,
-0000f680: 2076 616c 7565 732c 2078 692c 206d 6574   values, xi, met
-0000f690: 686f 643d 2263 7562 6963 2229 0d0a 2020  hod="cubic")..  
-0000f6a0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0000f6b0: 2020 2020 7265 675b 645d 203d 2073 702e      reg[d] = sp.
-0000f6c0: 696e 7465 7270 6f6c 6174 652e 696e 7465  interpolate.inte
-0000f6d0: 7270 6e28 706f 696e 7473 2c20 7661 6c75  rpn(points, valu
-0000f6e0: 6573 2c20 7869 2c20 6d65 7468 6f64 3d22  es, xi, method="
-0000f6f0: 6375 6269 6322 290d 0a0d 0a20 2020 2020  cubic")....     
-0000f700: 2020 2069 6620 6465 6e6f 6973 653a 0d0a     if denoise:..
-0000f710: 2020 2020 2020 2020 2020 2020 7265 6720              reg 
-0000f720: 3d20 6269 6c61 7465 7261 6c28 7265 672c  = bilateral(reg,
-0000f730: 206b 3d33 290d 0a0d 0a20 2020 2020 2020   k=3)....       
-0000f740: 2023 2063 7265 6174 6520 6e61 6d65 6420   # create named 
-0000f750: 7475 706c 6520 746f 2072 6574 7572 6e0d  tuple to return.
-0000f760: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000f770: 2e76 6572 626f 7365 206f 7220 7665 7262  .verbose or verb
-0000f780: 6f73 653a 0d0a 2020 2020 2020 2020 2020  ose:..          
-0000f790: 2020 6465 6320 3d20 6e61 6d65 6474 7570    dec = namedtup
-0000f7a0: 6c65 280d 0a20 2020 2020 2020 2020 2020  le(..           
-0000f7b0: 2020 2020 2022 6465 636f 6465 6422 2c0d       "decoded",.
+00008160: 666f 7220 7420 696e 2072 616e 6765 2854  for t in range(T
+00008170: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00008180: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
+00008190: 2072 616e 6765 2843 293a 0d0a 2020 2020   range(C):..    
+000081a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081b0: 2020 2020 495f 4646 5420 3d20 6e70 2e66      I_FFT = np.f
+000081c0: 6674 2e66 6674 7368 6966 7428 6e70 2e66  ft.fftshift(np.f
+000081d0: 6674 2e72 6666 7432 284a 5b74 2c20 2e2e  ft.rfft2(J[t, ..
+000081e0: 2e2c 2063 5d29 290d 0a20 2020 2020 2020  ., c]))..       
+000081f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008200: 2049 5b74 2c20 2e2e 2e2c 2063 5d20 3d20   I[t, ..., c] = 
+00008210: 6e70 2e66 6674 2e69 7266 6674 3228 6e70  np.fft.irfft2(np
+00008220: 2e66 6674 2e69 6666 7473 6869 6674 2849  .fft.ifftshift(I
+00008230: 5f46 4654 202a 206d 7829 290d 0a20 2020  _FFT * mx))..   
+00008240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008250: 2020 2020 2049 5b54 202b 2074 2c20 2e2e       I[T + t, ..
+00008260: 2e2c 2063 5d20 3d20 6e70 2e66 6674 2e69  ., c] = np.fft.i
+00008270: 7266 6674 3228 6e70 2e66 6674 2e69 6666  rfft2(np.fft.iff
+00008280: 7473 6869 6674 2849 5f46 4654 202a 206d  tshift(I_FFT * m
+00008290: 7929 290d 0a20 2020 2020 2020 2020 2020  y))..           
+000082a0: 2065 6c69 6620 5920 2520 3220 3d3d 2030   elif Y % 2 == 0
+000082b0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000082c0: 2020 2066 7820 3d20 6e70 2e66 6674 2e66     fx = np.fft.f
+000082d0: 6674 7368 6966 7428 6e70 2e66 6674 2e72  ftshift(np.fft.r
+000082e0: 6666 7466 7265 7128 5929 290d 0a20 2020  fftfreq(Y))..   
+000082f0: 2020 2020 2020 2020 2020 2020 2066 7920               fy 
+00008300: 3d20 6e70 2e66 6674 2e66 6674 7368 6966  = np.fft.fftshif
+00008310: 7428 6e70 2e66 6674 2e66 6674 6672 6571  t(np.fft.fftfreq
+00008320: 2858 2929 0d0a 2020 2020 2020 2020 2020  (X))..          
+00008330: 2020 2020 2020 6678 782c 2066 7979 203d        fxx, fyy =
+00008340: 206e 702e 6d65 7368 6772 6964 2866 782c   np.meshgrid(fx,
+00008350: 2066 7929 0d0a 2020 2020 2020 2020 2020   fy)..          
+00008360: 2020 2020 2020 6d78 203d 206e 702e 6162        mx = np.ab
+00008370: 7328 6678 7829 203e 3d20 6e70 2e61 6273  s(fxx) >= np.abs
+00008380: 2866 7979 290d 0a20 2020 2020 2020 2020  (fyy)..         
+00008390: 2020 2020 2020 206d 7920 3d20 6e70 2e61         my = np.a
+000083a0: 6273 2866 7878 2920 3c3d 206e 702e 6162  bs(fxx) <= np.ab
+000083b0: 7328 6679 7929 0d0a 2020 2020 2020 2020  s(fyy)..        
+000083c0: 2020 2020 2020 2020 4a20 3d20 492e 7472          J = I.tr
+000083d0: 616e 7370 6f73 6528 302c 2032 2c20 312c  anspose(0, 2, 1,
+000083e0: 2033 290d 0a20 2020 2020 2020 2020 2020   3)..           
+000083f0: 2020 2020 2049 203d 206e 702e 656d 7074       I = np.empt
+00008400: 7928 2832 202a 2054 2c20 582c 2059 2c20  y((2 * T, X, Y, 
+00008410: 4329 290d 0a20 2020 2020 2020 2020 2020  C))..           
+00008420: 2020 2020 2066 6f72 2074 2069 6e20 7261       for t in ra
+00008430: 6e67 6528 5429 3a0d 0a20 2020 2020 2020  nge(T):..       
+00008440: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00008450: 2063 2069 6e20 7261 6e67 6528 4329 3a0d   c in range(C):.
+00008460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008470: 2020 2020 2020 2020 2049 5f46 4654 203d           I_FFT =
+00008480: 206e 702e 6666 742e 6666 7473 6869 6674   np.fft.fftshift
+00008490: 286e 702e 6666 742e 7266 6674 3228 4a5b  (np.fft.rfft2(J[
+000084a0: 742c 202e 2e2e 2c20 635d 2929 0d0a 2020  t, ..., c]))..  
+000084b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084c0: 2020 2020 2020 495b 742c 202e 2e2e 2c20        I[t, ..., 
+000084d0: 635d 203d 206e 702e 6666 742e 6972 6666  c] = np.fft.irff
+000084e0: 7432 286e 702e 6666 742e 6966 6674 7368  t2(np.fft.ifftsh
+000084f0: 6966 7428 495f 4646 5420 2a20 6d79 2929  ift(I_FFT * my))
+00008500: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008510: 2020 2020 2020 2020 2020 495b 5420 2b20            I[T + 
+00008520: 742c 202e 2e2e 2c20 635d 203d 206e 702e  t, ..., c] = np.
+00008530: 6666 742e 6972 6666 7432 286e 702e 6666  fft.irfft2(np.ff
+00008540: 742e 6966 6674 7368 6966 7428 495f 4646  t.ifftshift(I_FF
+00008550: 5420 2a20 6d78 2929 0d0a 2020 2020 2020  T * mx))..      
+00008560: 2020 2020 2020 2020 2020 4920 3d20 492e            I = I.
+00008570: 7472 616e 7370 6f73 6528 302c 2032 2c20  transpose(0, 2, 
+00008580: 312c 2033 290d 0a20 2020 2020 2020 2020  1, 3)..         
+00008590: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+000085a0: 2020 2020 2020 2020 2020 6678 203d 206e            fx = n
+000085b0: 702e 6666 742e 6666 7473 6869 6674 286e  p.fft.fftshift(n
+000085c0: 702e 6666 742e 6666 7466 7265 7128 5829  p.fft.fftfreq(X)
+000085d0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+000085e0: 2020 2066 7920 3d20 6e70 2e66 6674 2e66     fy = np.fft.f
+000085f0: 6674 7368 6966 7428 6e70 2e66 6674 2e66  ftshift(np.fft.f
+00008600: 6674 6672 6571 2859 2929 0d0a 2020 2020  ftfreq(Y))..    
+00008610: 2020 2020 2020 2020 2020 2020 6678 782c              fxx,
+00008620: 2066 7979 203d 206e 702e 6d65 7368 6772   fyy = np.meshgr
+00008630: 6964 2866 782c 2066 7929 0d0a 2020 2020  id(fx, fy)..    
+00008640: 2020 2020 2020 2020 2020 2020 6d78 203d              mx =
+00008650: 206e 702e 6162 7328 6678 7829 203e 3d20   np.abs(fxx) >= 
+00008660: 6e70 2e61 6273 2866 7979 290d 0a20 2020  np.abs(fyy)..   
+00008670: 2020 2020 2020 2020 2020 2020 206d 7920               my 
+00008680: 3d20 6e70 2e61 6273 2866 7878 2920 3c3d  = np.abs(fxx) <=
+00008690: 206e 702e 6162 7328 6679 7929 0d0a 2020   np.abs(fyy)..  
+000086a0: 2020 2020 2020 2020 2020 2020 2020 4a20                J 
+000086b0: 3d20 490d 0a20 2020 2020 2020 2020 2020  = I..           
+000086c0: 2020 2020 2049 203d 206e 702e 656d 7074       I = np.empt
+000086d0: 7928 2832 202a 2054 2c20 592c 2058 2c20  y((2 * T, Y, X, 
+000086e0: 4329 290d 0a20 2020 2020 2020 2020 2020  C))..           
+000086f0: 2020 2020 2066 6f72 2074 2069 6e20 7261       for t in ra
+00008700: 6e67 6528 5429 3a0d 0a20 2020 2020 2020  nge(T):..       
+00008710: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00008720: 2063 2069 6e20 7261 6e67 6528 4329 3a0d   c in range(C):.
+00008730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008740: 2020 2020 2020 2020 2049 5f46 4654 203d           I_FFT =
+00008750: 206e 702e 6666 742e 6666 7473 6869 6674   np.fft.fftshift
+00008760: 286e 702e 6666 742e 6666 7432 284a 5b74  (np.fft.fft2(J[t
+00008770: 2c20 2e2e 2e2c 2063 5d29 290d 0a20 2020  , ..., c]))..   
+00008780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008790: 2020 2020 2049 5b74 2c20 2e2e 2e2c 2063       I[t, ..., c
+000087a0: 5d20 3d20 6e70 2e61 6273 286e 702e 6666  ] = np.abs(np.ff
+000087b0: 742e 6966 6674 3228 6e70 2e66 6674 2e69  t.ifft2(np.fft.i
+000087c0: 6666 7473 6869 6674 2849 5f46 4654 202a  fftshift(I_FFT *
+000087d0: 206d 7829 2929 0d0a 2020 2020 2020 2020   mx)))..        
+000087e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087f0: 495b 5420 2b20 742c 202e 2e2e 2c20 635d  I[T + t, ..., c]
+00008800: 203d 206e 702e 6162 7328 6e70 2e66 6674   = np.abs(np.fft
+00008810: 2e69 6666 7432 286e 702e 6666 742e 6966  .ifft2(np.fft.if
+00008820: 6674 7368 6966 7428 495f 4646 5420 2a20  ftshift(I_FFT * 
+00008830: 6d79 2929 290d 0a0d 0a20 2020 2020 2020  my)))....       
+00008840: 2069 6620 7365 6c66 2e57 444d 3a0d 0a20   if self.WDM:.. 
+00008850: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00008860: 7420 6e6f 7420 7365 6c66 2e46 444d 0d0a  t not self.FDM..
+00008870: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00008880: 7274 2043 203d 3d20 330d 0a20 2020 2020  rt C == 3..     
+00008890: 2020 2020 2020 2049 203d 2049 2e72 6573         I = I.res
+000088a0: 6861 7065 2828 2d31 2c20 312c 2059 2c20  hape((-1, 1, Y, 
+000088b0: 582c 2043 2929 2020 2320 7265 7475 726e  X, C))  # return
+000088c0: 7320 6120 7669 6577 0d0a 2020 2020 2020  s a view..      
+000088d0: 2020 2020 2020 4920 3d20 492e 7377 6170        I = I.swap
+000088e0: 6178 6573 282d 312c 2031 2920 2023 2072  axes(-1, 1)  # r
+000088f0: 6574 7572 6e73 2061 2076 6965 770d 0a20  eturns a view.. 
+00008900: 2020 2020 2020 2020 2020 2049 203d 2049             I = I
+00008910: 2e72 6573 6861 7065 2828 2d31 2c20 592c  .reshape((-1, Y,
+00008920: 2058 2c20 3129 2920 2023 2072 6574 7572   X, 1))  # retur
+00008930: 6e73 2061 2076 6965 770d 0a0d 0a20 2020  ns a view....   
+00008940: 2020 2020 2069 6620 7365 6c66 2e46 444d       if self.FDM
+00008950: 3a0d 0a20 2020 2020 2020 2020 2020 2061  :..            a
+00008960: 7373 6572 7420 6e6f 7420 7365 6c66 2e57  ssert not self.W
+00008970: 444d 0d0a 2020 2020 2020 2020 2020 2020  DM..            
+00008980: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
+00008990: 5344 4d20 2023 2074 6f64 6f3a 2061 6c6c  SDM  # todo: all
+000089a0: 6f77 2073 656c 662e 5344 4d3f 0d0a 2020  ow self.SDM?..  
+000089b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000089c0: 206c 656e 286e 702e 756e 6971 7565 2873   len(np.unique(s
+000089d0: 656c 662e 4e29 2920 3d3d 2031 0d0a 2020  elf.N)) == 1..  
+000089e0: 2020 2020 2020 2020 2020 4920 3d20 6e70            I = np
+000089f0: 2e74 696c 6528 492c 2028 7365 6c66 2e44  .tile(I, (self.D
+00008a00: 202a 2073 656c 662e 4b2c 2031 2c20 312c   * self.K, 1, 1,
+00008a10: 2031 2929 0d0a 0d0a 2020 2020 2020 2020   1))....        
+00008a20: 6c6f 6767 696e 672e 6465 6275 6728 6622  logging.debug(f"
+00008a30: 7b31 3030 3020 2a20 2874 696d 652e 7065  {1000 * (time.pe
+00008a40: 7266 5f63 6f75 6e74 6572 2829 202d 2074  rf_counter() - t
+00008a50: 3029 7d6d 7322 290d 0a0d 0a20 2020 2020  0)}ms")....     
+00008a60: 2020 2072 6574 7572 6e20 490d 0a0d 0a20     return I.... 
+00008a70: 2020 2064 6566 205f 636f 6c6f 7269 7a65     def _colorize
+00008a80: 2873 656c 662c 2049 3a20 6e70 2e6e 6461  (self, I: np.nda
+00008a90: 7272 6179 2c20 6672 616d 6573 3a20 6e70  rray, frames: np
+00008aa0: 2e6e 6461 7272 6179 2920 2d3e 206e 702e  .ndarray) -> np.
+00008ab0: 6e64 6172 7261 793a 0d0a 2020 2020 2020  ndarray:..      
+00008ac0: 2020 2222 2243 6f6c 6f72 697a 6520 6672    """Colorize fr
+00008ad0: 696e 6765 2070 6174 7465 726e 732e 0d0a  inge patterns...
+00008ae0: 0d0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+00008af0: 7465 7273 0d0a 2020 2020 2020 2020 2d2d  ters..        --
+00008b00: 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020 2020  --------..      
+00008b10: 2020 4920 3a20 6e70 2e6e 6461 7272 6179    I : np.ndarray
+00008b20: 0d0a 2020 2020 2020 2020 2020 2020 4261  ..            Ba
+00008b30: 7365 2066 7269 6e67 6520 7061 7474 6572  se fringe patter
+00008b40: 6e73 2c0d 0a20 2020 2020 2020 2020 2020  ns,..           
+00008b50: 2070 6f73 7369 626c 7920 6d75 6c74 6970   possibly multip
+00008b60: 6c65 7865 642e 0d0a 2020 2020 2020 2020  lexed...        
+00008b70: 6672 616d 6573 203a 204e 6f6e 6520 6f72  frames : None or
+00008b80: 2069 6e74 206f 7220 7475 706c 6520 6f66   int or tuple of
+00008b90: 2069 6e74 732c 206f 7074 696f 6e61 6c0d   ints, optional.
+00008ba0: 0a20 2020 2020 2020 2020 2020 2049 6e64  .            Ind
+00008bb0: 6963 6573 206f 6620 7468 6520 6672 616d  ices of the fram
+00008bc0: 6573 2074 6f20 6265 2065 6e63 6f64 6564  es to be encoded
+00008bd0: 2e0d 0a20 2020 2020 2020 2020 2020 2054  ...            T
+00008be0: 6865 2064 6566 6175 6c74 2c20 6672 616d  he default, fram
+00008bf0: 6573 3d4e 6f6e 652c 2077 696c 6c20 656e  es=None, will en
+00008c00: 636f 6465 2061 6c6c 2066 7261 6d65 7320  code all frames 
+00008c10: 6174 206f 6e63 652e 0d0a 2020 2020 2020  at once...      
+00008c20: 2020 2020 2020 4966 2066 7261 6d65 7320        If frames 
+00008c30: 6973 206e 6567 6174 6976 652c 2069 7420  is negative, it 
+00008c40: 636f 756e 7473 2066 726f 6d20 7468 6520  counts from the 
+00008c50: 6c61 7374 2074 6f20 7468 6520 6669 7273  last to the firs
+00008c60: 7420 6672 616d 652e 0d0a 2020 2020 2020  t frame...      
+00008c70: 2020 2020 2020 4966 2066 7261 6d65 7320        If frames 
+00008c80: 636f 6e74 6169 6e73 206e 756d 6265 7273  contains numbers
+00008c90: 2077 686f 7365 206d 6167 6e69 7475 6465   whose magnitude
+00008ca0: 2069 7320 6c61 7267 6572 2074 6861 6e20   is larger than 
+00008cb0: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
+00008cc0: 206f 6620 6672 616d 6573 0d0a 2020 2020   of frames..    
+00008cd0: 2020 2020 2020 2020 2861 7320 7370 6563          (as spec
+00008ce0: 6966 6965 6420 6279 2074 6865 2061 7474  ified by the att
+00008cf0: 7269 6275 7465 2060 5460 206f 6620 7468  ribute `T` of th
+00008d00: 6520 4672 696e 6765 7320 696e 7374 616e  e Fringes instan
+00008d10: 6365 292c 2069 7420 6973 2077 7261 7070  ce), it is wrapp
+00008d20: 6564 2061 726f 756e 642e 0d0a 2020 2020  ed around...    
+00008d30: 2020 2020 2020 2020 4966 2066 7261 6d65          If frame
+00008d40: 7320 6973 2061 2074 7570 6c65 206f 6620  s is a tuple of 
+00008d50: 696e 7473 2c20 6f6e 6c79 2074 6865 2066  ints, only the f
+00008d60: 7261 6d65 7320 7370 6563 6966 6965 6420  rames specified 
+00008d70: 696e 2074 6865 2074 7570 6c65 2061 7265  in the tuple are
+00008d80: 2065 6e63 6f64 6564 2e0d 0a0d 0a20 2020   encoded.....   
+00008d90: 2020 2020 2052 6574 7572 6e73 0d0a 2020       Returns..  
+00008da0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0d 0a20        -------.. 
+00008db0: 2020 2020 2020 2049 203a 206e 702e 6e64         I : np.nd
+00008dc0: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
+00008dd0: 2020 2043 6f6c 6f72 697a 6564 2066 7269     Colorized fri
+00008de0: 6e67 6520 7061 7474 6572 6e73 2e0d 0a20  nge patterns... 
+00008df0: 2020 2020 2020 2022 2222 0d0a 0d0a 2020         """....  
+00008e00: 2020 2020 2020 7430 203d 2074 696d 652e        t0 = time.
+00008e10: 7065 7266 5f63 6f75 6e74 6572 2829 0d0a  perf_counter()..
+00008e20: 0d0a 2020 2020 2020 2020 545f 203d 2049  ..        T_ = I
+00008e30: 2e73 6861 7065 5b30 5d20 2023 206e 756d  .shape[0]  # num
+00008e40: 6265 7220 6f66 2066 7261 6d65 7320 666f  ber of frames fo
+00008e50: 7220 6561 6368 2068 7565 0d0a 2020 2020  r each hue..    
+00008e60: 2020 2020 5420 3d20 6c65 6e28 6672 616d      T = len(fram
+00008e70: 6573 290d 0a20 2020 2020 2020 204a 203d  es)..        J =
+00008e80: 206e 702e 656d 7074 7928 2854 2c20 7365   np.empty((T, se
+00008e90: 6c66 2e59 2c20 7365 6c66 2e58 2c20 7365  lf.Y, self.X, se
+00008ea0: 6c66 2e43 292c 2073 656c 662e 6474 7970  lf.C), self.dtyp
+00008eb0: 6529 0d0a 0d0a 2020 2020 2020 2020 666f  e)....        fo
+00008ec0: 7220 7420 696e 2066 7261 6d65 733a 0d0a  r t in frames:..
+00008ed0: 2020 2020 2020 2020 2020 2020 7462 203d              tb =
+00008ee0: 2074 2025 2049 2e73 6861 7065 5b30 5d20   t % I.shape[0] 
+00008ef0: 2023 2069 6e64 6963 6573 2066 726f 6d20   # indices from 
+00008f00: 6261 7365 2066 7269 6e67 6520 7061 7474  base fringe patt
+00008f10: 6572 6e20 490d 0a0d 0a20 2020 2020 2020  ern I....       
+00008f20: 2020 2020 2066 6f72 2063 2069 6e20 7261       for c in ra
+00008f30: 6e67 6528 7365 6c66 2e43 293a 0d0a 2020  nge(self.C):..  
+00008f40: 2020 2020 2020 2020 2020 2020 2020 6820                h 
+00008f50: 3d20 696e 7428 7420 2f2f 2054 5f29 2020  = int(t // T_)  
+00008f60: 2320 6875 6520 696e 6465 780d 0a20 2020  # hue index..   
+00008f70: 2020 2020 2020 2020 2020 2020 2063 6220               cb 
+00008f80: 3d20 6320 6966 2073 656c 662e 5744 4d20  = c if self.WDM 
+00008f90: 656c 7365 2030 2020 2320 636f 6c6f 7220  else 0  # color 
+00008fa0: 696e 6465 7820 6f66 2062 6173 6520 6672  index of base fr
+00008fb0: 696e 6765 2070 6174 7465 726e 2049 0d0a  inge pattern I..
+00008fc0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008fd0: 2020 6966 2073 656c 662e 685b 682c 2063    if self.h[h, c
+00008fe0: 5d20 3d3d 2030 3a20 2023 2075 6962 6620  ] == 0:  # uibf 
+00008ff0: 2d3e 2075 6962 660d 0a20 2020 2020 2020  -> uibf..       
+00009000: 2020 2020 2020 2020 2020 2020 204a 5b74               J[t
+00009010: 2c20 2e2e 2e2c 2063 5d20 3d20 300d 0a20  , ..., c] = 0.. 
+00009020: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009030: 6c69 6620 7365 6c66 2e68 5b68 2c20 635d  lif self.h[h, c]
+00009040: 203d 3d20 3235 3520 616e 6420 4a2e 6474   == 255 and J.dt
+00009050: 7970 6520 3d3d 2073 656c 662e 6474 7970  ype == self.dtyp
+00009060: 653a 2020 2320 7569 6266 202d 3e20 7569  e:  # uibf -> ui
+00009070: 6266 0d0a 2020 2020 2020 2020 2020 2020  bf..            
+00009080: 2020 2020 2020 2020 4a5b 742c 202e 2e2e          J[t, ...
+00009090: 2c20 635d 203d 2049 5b74 622c 202e 2e2e  , c] = I[tb, ...
+000090a0: 2c20 6362 5d0d 0a20 2020 2020 2020 2020  , cb]..         
+000090b0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+000090c0: 2e64 7479 7065 2e6b 696e 6420 696e 2022  .dtype.kind in "
+000090d0: 7569 6222 3a20 2023 2066 202d 3e20 7569  uib":  # f -> ui
+000090e0: 620d 0a20 2020 2020 2020 2020 2020 2020  b..             
+000090f0: 2020 2020 2020 204a 5b74 2c20 2e2e 2e2c         J[t, ...,
+00009100: 2063 5d20 3d20 6e70 2e72 696e 7428 495b   c] = np.rint(I[
+00009110: 7462 2c20 2e2e 2e2c 2063 625d 202a 2028  tb, ..., cb] * (
+00009120: 7365 6c66 2e68 5b68 2c20 635d 202f 2032  self.h[h, c] / 2
+00009130: 3535 2929 2020 2320 2e61 7374 7970 6528  55))  # .astype(
+00009140: 7365 6c66 2e64 7479 7065 2c20 636f 7079  self.dtype, copy
+00009150: 3d46 616c 7365 290d 0a20 2020 2020 2020  =False)..       
+00009160: 2020 2020 2020 2020 2065 6c73 653a 2020           else:  
+00009170: 2320 6620 2d3e 2066 0d0a 2020 2020 2020  # f -> f..      
+00009180: 2020 2020 2020 2020 2020 2020 2020 4a5b                J[
+00009190: 742c 202e 2e2e 2c20 635d 203d 2049 5b74  t, ..., c] = I[t
+000091a0: 622c 202e 2e2e 2c20 6362 5d20 2a20 2873  b, ..., cb] * (s
+000091b0: 656c 662e 685b 682c 2063 5d20 2f20 3235  elf.h[h, c] / 25
+000091c0: 3529 0d0a 0d0a 2020 2020 2020 2020 2320  5)....        # 
+000091d0: 666f 7220 6820 696e 2072 616e 6765 2873  for h in range(s
+000091e0: 656c 662e 4829 3a0d 0a20 2020 2020 2020  elf.H):..       
+000091f0: 2023 2020 2020 2069 6620 6672 616d 6573   #     if frames
+00009200: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+00009210: 2020 2023 2020 2020 2020 2020 2066 6f72     #         for
+00009220: 2063 2069 6e20 7261 6e67 6528 7365 6c66   c in range(self
+00009230: 2e43 293a 0d0a 2020 2020 2020 2020 2320  .C):..        # 
+00009240: 2020 2020 2020 2020 2020 2020 636a 203d              cj =
+00009250: 2063 2069 6620 7365 6c66 2e57 444d 2065   c if self.WDM e
+00009260: 6c73 6520 3020 2023 2074 6f64 6f3a 203f  lse 0  # todo: ?
+00009270: 3f3f 0d0a 2020 2020 2020 2020 2320 2020  ??..        #   
+00009280: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00009290: 662e 685b 682c 2063 5d20 3d3d 2030 3a20  f.h[h, c] == 0: 
+000092a0: 2023 2075 6962 202d 3e20 7569 622c 2066   # uib -> uib, f
+000092b0: 202d 3e20 660d 0a20 2020 2020 2020 2023   -> f..        #
+000092c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092d0: 204a 5b68 202a 2054 6820 3a20 2868 202b   J[h * Th : (h +
+000092e0: 2031 2920 2a20 5468 2c20 2e2e 2e2c 2063   1) * Th, ..., c
+000092f0: 5d20 3d20 300d 0a20 2020 2020 2020 2023  ] = 0..        #
+00009300: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00009310: 6620 7365 6c66 2e68 5b68 2c20 635d 203d  f self.h[h, c] =
+00009320: 3d20 3235 3520 616e 6420 4a2e 6474 7970  = 255 and J.dtyp
+00009330: 6520 3d3d 2073 656c 662e 6474 7970 653a  e == self.dtype:
+00009340: 2020 2320 7569 6220 2d3e 2075 6962 2c20    # uib -> uib, 
+00009350: 6620 2d3e 2066 0d0a 2020 2020 2020 2020  f -> f..        
+00009360: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00009370: 2020 4a5b 6820 2a20 5468 203a 2028 6820    J[h * Th : (h 
+00009380: 2b20 3129 202a 2054 682c 202e 2e2e 2c20  + 1) * Th, ..., 
+00009390: 635d 203d 2049 5b2e 2e2e 2c20 636a 5d0d  c] = I[..., cj].
+000093a0: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+000093b0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+000093c0: 2e64 7479 7065 2e6b 696e 6420 696e 2022  .dtype.kind in "
+000093d0: 7569 6222 3a20 2023 2066 202d 3e20 7569  uib":  # f -> ui
+000093e0: 620d 0a20 2020 2020 2020 2023 2020 2020  b..        #    
+000093f0: 2020 2020 2020 2020 2020 2020 204a 5b68               J[h
+00009400: 202a 2054 6820 3a20 2868 202b 2031 2920   * Th : (h + 1) 
+00009410: 2a20 5468 2c20 2e2e 2e2c 2063 5d20 3d20  * Th, ..., c] = 
+00009420: 6e70 2e72 696e 7428 495b 2e2e 2e2c 2063  np.rint(I[..., c
+00009430: 6a5d 202a 2028 7365 6c66 2e68 5b68 2c20  j] * (self.h[h, 
+00009440: 635d 202f 2032 3535 2929 2e61 7374 7970  c] / 255)).astyp
+00009450: 6528 0d0a 2020 2020 2020 2020 2320 2020  e(..        #   
+00009460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009470: 2020 7365 6c66 2e64 7479 7065 2c20 636f    self.dtype, co
+00009480: 7079 3d46 616c 7365 0d0a 2020 2020 2020  py=False..      
+00009490: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+000094a0: 2020 2020 290d 0a20 2020 2020 2020 2023      )..        #
+000094b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000094c0: 653a 2020 2320 6620 2d3e 2066 0d0a 2020  e:  # f -> f..  
+000094d0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+000094e0: 2020 2020 2020 2020 4a5b 6820 2a20 5468          J[h * Th
+000094f0: 203a 2028 6820 2b20 3129 202a 2054 682c   : (h + 1) * Th,
+00009500: 202e 2e2e 2c20 635d 203d 2049 5b2e 2e2e   ..., c] = I[...
+00009510: 2c20 636a 5d20 2a20 2873 656c 662e 685b  , cj] * (self.h[
+00009520: 682c 2063 5d20 2f20 3235 3529 0d0a 2020  h, c] / 255)..  
+00009530: 2020 2020 2020 2320 2020 2020 656c 6966        #     elif
+00009540: 2068 2069 6e20 6875 6573 3a20 2023 2069   h in hues:  # i
+00009550: 2e65 2e20 6672 616d 6573 2069 7320 6e6f  .e. frames is no
+00009560: 7420 4e6f 6e65 2061 6e64 2068 2069 6e20  t None and h in 
+00009570: 6875 6573 0d0a 2020 2020 2020 2020 2320  hues..        # 
+00009580: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
+00009590: 2072 616e 6765 2873 656c 662e 4329 3a0d   range(self.C):.
+000095a0: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+000095b0: 2020 2020 2020 2063 6a20 3d20 6320 6966         cj = c if
+000095c0: 2073 656c 662e 5744 4d20 656c 7365 2030   self.WDM else 0
+000095d0: 2020 2320 746f 646f 3a20 3f3f 3f0d 0a20    # todo: ???.. 
+000095e0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+000095f0: 2020 2020 2069 6620 7365 6c66 2e68 5b68       if self.h[h
+00009600: 2c20 635d 203d 3d20 303a 2020 2320 7569  , c] == 0:  # ui
+00009610: 6220 2d3e 2075 6962 2c20 6620 2d3e 2066  b -> uib, f -> f
+00009620: 0d0a 2020 2020 2020 2020 2320 2020 2020  ..        #     
+00009630: 2020 2020 2020 2020 2020 2020 4a5b 692c              J[i,
+00009640: 202e 2e2e 2c20 635d 203d 2030 0d0a 2020   ..., c] = 0..  
+00009650: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00009660: 2020 2020 656c 6966 2073 656c 662e 685b      elif self.h[
+00009670: 682c 2063 5d20 3d3d 2032 3535 2061 6e64  h, c] == 255 and
+00009680: 204a 2e64 7479 7065 203d 3d20 7365 6c66   J.dtype == self
+00009690: 2e64 7479 7065 3a20 2023 2075 6962 202d  .dtype:  # uib -
+000096a0: 3e20 7569 622c 2066 202d 3e20 660d 0a20  > uib, f -> f.. 
+000096b0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+000096c0: 2020 2020 2020 2020 204a 5b69 2c20 2e2e           J[i, ..
+000096d0: 2e2c 2063 5d20 3d20 495b 692c 202e 2e2e  ., c] = I[i, ...
+000096e0: 2c20 636a 5d0d 0a20 2020 2020 2020 2023  , cj]..        #
+000096f0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00009700: 6620 7365 6c66 2e64 7479 7065 2e6b 696e  f self.dtype.kin
+00009710: 6420 696e 2022 7569 6222 3a20 2023 2066  d in "uib":  # f
+00009720: 202d 3e20 7569 620d 0a20 2020 2020 2020   -> uib..       
+00009730: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00009740: 2020 204a 5b69 2c20 2e2e 2e2c 2063 5d20     J[i, ..., c] 
+00009750: 3d20 6e70 2e72 696e 7428 495b 692c 202e  = np.rint(I[i, .
+00009760: 2e2e 2c20 636a 5d20 2a20 2873 656c 662e  .., cj] * (self.
+00009770: 685b 682c 2063 5d20 2f20 3235 3529 292e  h[h, c] / 255)).
+00009780: 6173 7479 7065 2873 656c 662e 6474 7970  astype(self.dtyp
+00009790: 652c 2063 6f70 793d 4661 6c73 6529 0d0a  e, copy=False)..
+000097a0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+000097b0: 2020 2020 2020 656c 7365 3a20 2023 2066        else:  # f
+000097c0: 202d 3e20 660d 0a20 2020 2020 2020 2023   -> f..        #
+000097d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097e0: 204a 5b69 2c20 2e2e 2e2c 2063 5d20 3d20   J[i, ..., c] = 
+000097f0: 495b 692c 202e 2e2e 2c20 636a 5d20 2a20  I[i, ..., cj] * 
+00009800: 2873 656c 662e 685b 682c 2063 5d20 2f20  (self.h[h, c] / 
+00009810: 3235 3529 0d0a 2020 2020 2020 2020 2320  255)..        # 
+00009820: 2020 2020 2020 2020 6920 2b3d 2031 0d0a          i += 1..
+00009830: 0d0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
+00009840: 672e 6465 6275 6728 6622 7b31 3030 3020  g.debug(f"{1000 
+00009850: 2a20 2874 696d 652e 7065 7266 5f63 6f75  * (time.perf_cou
+00009860: 6e74 6572 2829 202d 2074 3029 7d6d 7322  nter() - t0)}ms"
+00009870: 290d 0a0d 0a20 2020 2020 2020 2072 6574  )....        ret
+00009880: 7572 6e20 4a0d 0a0d 0a20 2020 2064 6566  urn J....    def
+00009890: 205f 6465 636f 6c6f 7269 7a65 2873 656c   _decolorize(sel
+000098a0: 662c 2049 3a20 6e70 2e6e 6461 7272 6179  f, I: np.ndarray
+000098b0: 2920 2d3e 206e 702e 6e64 6172 7261 793a  ) -> np.ndarray:
+000098c0: 0d0a 2020 2020 2020 2020 2222 2244 6563  ..        """Dec
+000098d0: 6f6c 6f72 697a 6520 6672 696e 6765 2070  olorize fringe p
+000098e0: 6174 7465 726e 7320 6279 2077 6569 6768  atterns by weigh
+000098f0: 7465 6420 6176 6572 6167 696e 6720 6f66  ted averaging of
+00009900: 2068 7565 732e 0d0a 0d0a 2020 2020 2020   hues.....      
+00009910: 2020 5061 7261 6d65 7465 7273 0d0a 2020    Parameters..  
+00009920: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
+00009930: 0d0a 2020 2020 2020 2020 4920 3a20 6e70  ..        I : np
+00009940: 2e6e 6461 7272 6179 0d0a 2020 2020 2020  .ndarray..      
+00009950: 2020 2020 2020 436f 6c6f 7269 7a65 6420        Colorized 
+00009960: 6672 696e 6765 2070 6174 7465 726e 732e  fringe patterns.
+00009970: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
+00009980: 726e 730d 0a20 2020 2020 2020 202d 2d2d  rns..        ---
+00009990: 2d2d 2d2d 0d0a 2020 2020 2020 2020 4920  ----..        I 
+000099a0: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
+000099b0: 2020 2020 2020 2020 2020 4465 636f 6c6f            Decolo
+000099c0: 7269 7a65 6420 6672 696e 6765 2070 6174  rized fringe pat
+000099d0: 7465 726e 732e 2222 220d 0a0d 0a20 2020  terns."""....   
+000099e0: 2020 2020 2074 3020 3d20 7469 6d65 2e70       t0 = time.p
+000099f0: 6572 665f 636f 756e 7465 7228 290d 0a0d  erf_counter()...
+00009a00: 0a20 2020 2020 2020 2054 2c20 592c 2058  .        T, Y, X
+00009a10: 2c20 4320 3d20 7673 6861 7065 2849 292e  , C = vshape(I).
+00009a20: 7368 6170 650d 0a20 2020 2020 2020 2049  shape..        I
+00009a30: 203d 2049 2e72 6573 6861 7065 2828 7365   = I.reshape((se
+00009a40: 6c66 2e48 2c20 5420 2f2f 2073 656c 662e  lf.H, T // self.
+00009a50: 482c 2059 2c20 582c 2043 2929 2020 2320  H, Y, X, C))  # 
+00009a60: 7265 7475 726e 7320 6120 7669 6577 0d0a  returns a view..
+00009a70: 0d0a 2020 2020 2020 2020 6261 7365 203d  ..        base =
+00009a80: 206e 702e 616c 6c28 6e70 2e63 6f75 6e74   np.all(np.count
+00009a90: 5f6e 6f6e 7a65 726f 2873 656c 662e 682c  _nonzero(self.h,
+00009aa0: 2061 7869 733d 3129 203d 3d20 3129 2020   axis=1) == 1)  
+00009ab0: 2320 6561 6368 2068 7565 2063 6f6e 7369  # each hue consi
+00009ac0: 7374 7320 6f66 206f 6e6c 7920 6f6e 6520  sts of only one 
+00009ad0: 5247 4220 6261 7365 2063 6f6c 6f72 0d0a  RGB base color..
+00009ae0: 2020 2020 2020 2020 736f 6c6f 203d 206e          solo = n
+00009af0: 702e 616c 6c28 6e70 2e63 6f75 6e74 5f6e  p.all(np.count_n
+00009b00: 6f6e 7a65 726f 2873 656c 662e 682c 2061  onzero(self.h, a
+00009b10: 7869 733d 3029 203d 3d20 3129 2020 2320  xis=0) == 1)  # 
+00009b20: 6561 6368 2052 4742 2063 6f6d 706f 6e65  each RGB compone
+00009b30: 6e74 2065 7869 7374 7320 6578 6163 746c  nt exists exactl
+00009b40: 7920 6f6e 6365 0d0a 2020 2020 2020 2020  y once..        
+00009b50: 6d6f 6e6f 203d 206c 656e 2873 6574 2873  mono = len(set(s
+00009b60: 656c 662e 685b 7365 6c66 2e68 2021 3d20  elf.h[self.h != 
+00009b70: 305d 2929 203d 3d20 3120 2023 2061 6c6c  0])) == 1  # all
+00009b80: 2063 6f6c 6f72 7320 6172 6520 6d6f 6e6f   colors are mono
+00009b90: 6368 726f 6d61 7469 632c 2069 2e65 2e20  chromatic, i.e. 
+00009ba0: 6172 6520 7468 6520 7361 6d65 206f 7220  are the same or 
+00009bb0: 7a65 726f 0d0a 2020 2020 2020 2020 2320  zero..        # 
+00009bc0: 6966 2062 6173 6520 616e 6420 736f 6c6f  if base and solo
+00009bd0: 3a20 6e6f 2061 7665 7261 6769 6e67 206e  : no averaging n
+00009be0: 6563 6573 7361 7279 0d0a 2020 2020 2020  ecessary..      
+00009bf0: 2020 2320 6966 206d 6f6e 6f3a 2061 6c6c    # if mono: all
+00009c00: 2077 6569 6768 7473 2061 7265 2074 6865   weights are the
+00009c10: 2073 616d 650d 0a0d 0a20 2020 2020 2020   same....       
+00009c20: 2069 6620 7365 6c66 2e48 203d 3d20 3320   if self.H == 3 
+00009c30: 616e 6420 4320 696e 205b 312c 2033 5d20  and C in [1, 3] 
+00009c40: 616e 6420 6261 7365 2061 6e64 2073 6f6c  and base and sol
+00009c50: 6f20 616e 6420 6d6f 6e6f 3a0d 0a20 2020  o and mono:..   
+00009c60: 2020 2020 2020 2020 2049 203d 206e 702e           I = np.
+00009c70: 6d6f 7665 6178 6973 2849 2c20 302c 202d  moveaxis(I, 0, -
+00009c80: 3229 2020 2320 7265 7475 726e 7320 6120  2)  # returns a 
+00009c90: 7669 6577 0d0a 0d0a 2020 2020 2020 2020  view....        
+00009ca0: 2020 2020 2320 6261 7369 6320 736c 6963      # basic slic
+00009cb0: 696e 6720 7265 7475 726e 7320 6120 7669  ing returns a vi
+00009cc0: 6577 0d0a 2020 2020 2020 2020 2020 2020  ew..            
+00009cd0: 6964 7820 3d20 6e70 2e61 7267 6d61 7828  idx = np.argmax(
+00009ce0: 7365 6c66 2e68 2c20 6178 6973 3d31 290d  self.h, axis=1).
+00009cf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009d00: 6e70 2e61 7272 6179 5f65 7175 616c 2869  np.array_equal(i
+00009d10: 6478 2c20 5b30 2c20 322c 2031 5d29 3a20  dx, [0, 2, 1]): 
+00009d20: 2023 2052 4247 0d0a 2020 2020 2020 2020   # RBG..        
+00009d30: 2020 2020 2020 2020 4920 3d20 495b 2e2e          I = I[..
+00009d40: 2e2c 2030 3a3a 2d31 2c20 3a5d 0d0a 2020  ., 0::-1, :]..  
+00009d50: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+00009d60: 702e 6172 7261 795f 6571 7561 6c28 6964  p.array_equal(id
+00009d70: 782c 205b 312c 2032 2c20 305d 293a 2020  x, [1, 2, 0]):  
+00009d80: 2320 4742 520d 0a20 2020 2020 2020 2020  # GBR..         
+00009d90: 2020 2020 2020 2049 203d 2049 5b2e 2e2e         I = I[...
+00009da0: 2c20 313a 313a 2c20 3a5d 0d0a 2020 2020  , 1:1:, :]..    
+00009db0: 2020 2020 2020 2020 656c 6966 206e 702e          elif np.
+00009dc0: 6172 7261 795f 6571 7561 6c28 6964 782c  array_equal(idx,
+00009dd0: 205b 312c 2030 2c20 325d 293a 2020 2320   [1, 0, 2]):  # 
+00009de0: 4752 420d 0a20 2020 2020 2020 2020 2020  GRB..           
+00009df0: 2020 2020 2049 203d 2049 5b2e 2e2e 2c20       I = I[..., 
+00009e00: 313a 313a 2d31 2c20 3a5d 0d0a 2020 2020  1:1:-1, :]..    
+00009e10: 2020 2020 2020 2020 656c 6966 206e 702e          elif np.
+00009e20: 6172 7261 795f 6571 7561 6c28 6964 782c  array_equal(idx,
+00009e30: 205b 322c 2031 2c20 305d 293a 2020 2320   [2, 1, 0]):  # 
+00009e40: 4247 520d 0a20 2020 2020 2020 2020 2020  BGR..           
+00009e50: 2020 2020 2049 203d 2049 5b2e 2e2e 2c20       I = I[..., 
+00009e60: 323a 3a2d 312c 203a 5d0d 0a20 2020 2020  2::-1, :]..     
+00009e70: 2020 2020 2020 2065 6c69 6620 6e70 2e61         elif np.a
+00009e80: 7272 6179 5f65 7175 616c 2869 6478 2c20  rray_equal(idx, 
+00009e90: 5b32 2c20 302c 2031 5d29 3a20 2023 2042  [2, 0, 1]):  # B
+00009ea0: 5247 0d0a 2020 2020 2020 2020 2020 2020  RG..            
+00009eb0: 2020 2020 4920 3d20 495b 2e2e 2e2c 2032      I = I[..., 2
+00009ec0: 3a32 3a2d 312c 203a 5d0d 0a20 2020 2020  :2:-1, :]..     
+00009ed0: 2020 2020 2020 2023 2065 6c69 6620 6e70         # elif np
+00009ee0: 2e61 7272 6179 5f65 7175 616c 2869 6478  .array_equal(idx
+00009ef0: 2c20 5b30 2c20 312c 2032 5d29 3a20 2023  , [0, 1, 2]):  #
+00009f00: 2052 4742 0d0a 2020 2020 2020 2020 2020   RGB..          
+00009f10: 2020 2320 2020 2020 4920 3d20 495b 2e2e    #     I = I[..
+00009f20: 2e2c 203a 2c20 3a5d 0d0a 0d0a 2020 2020  ., :, :]....    
+00009f30: 2020 2020 2020 2020 6966 2043 203d 3d20          if C == 
+00009f40: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
+00009f50: 2020 2020 4920 3d20 495b 2e2e 2e2c 2030      I = I[..., 0
+00009f60: 5d20 2023 2072 6574 7572 6e73 2061 2076  ]  # returns a v
+00009f70: 6965 770d 0a20 2020 2020 2020 2020 2020  iew..           
+00009f80: 2065 6c69 6620 4320 3d3d 2033 3a0d 0a20   elif C == 3:.. 
+00009f90: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+00009fa0: 203d 206e 702e 6469 6167 6f6e 616c 2849   = np.diagonal(I
+00009fb0: 2c20 6178 6973 313d 2d32 2c20 6178 6973  , axis1=-2, axis
+00009fc0: 323d 2d31 2920 2023 2072 6574 7572 6e73  2=-1)  # returns
+00009fd0: 2061 2076 6965 770d 0a20 2020 2020 2020   a view..       
+00009fe0: 2065 6c69 6620 7365 6c66 2e48 203d 3d20   elif self.H == 
+00009ff0: 3220 616e 6420 4320 696e 205b 312c 2033  2 and C in [1, 3
+0000a000: 5d20 616e 6420 736f 6c6f 2061 6e64 206d  ] and solo and m
+0000a010: 6f6e 6f3a 0d0a 2020 2020 2020 2020 2020  ono:..          
+0000a020: 2020 2320 6164 7661 6e63 6564 2069 6e64    # advanced ind
+0000a030: 6578 696e 6720 7265 7475 726e 7320 6120  exing returns a 
+0000a040: 636f 7079 2c20 6e6f 7420 6120 7669 6577  copy, not a view
+0000a050: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0000a060: 2043 203d 3d20 313a 0d0a 2020 2020 2020   C == 1:..      
+0000a070: 2020 2020 2020 2020 2020 4920 3d20 6e70            I = np
+0000a080: 2e73 7175 6565 7a65 280d 0a20 2020 2020  .squeeze(..     
+0000a090: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+0000a0a0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0000a0b0: 2020 2029 2020 2320 7265 7475 726e 7320     )  # returns 
+0000a0c0: 6120 7669 6577 0d0a 2020 2020 2020 2020  a view..        
+0000a0d0: 2020 2020 2020 2020 4920 3d20 6e70 2e6d          I = np.m
+0000a0e0: 6f76 6561 7869 7328 492c 2030 2c20 2d31  oveaxis(I, 0, -1
+0000a0f0: 2920 2023 2072 6574 7572 6e73 2061 2076  )  # returns a v
+0000a100: 6965 770d 0a20 2020 2020 2020 2020 2020  iew..           
+0000a110: 2020 2020 2069 6478 203d 206e 702e 6172       idx = np.ar
+0000a120: 676d 6178 2873 656c 662e 682c 2061 7869  gmax(self.h, axi
+0000a130: 733d 3029 0d0a 2020 2020 2020 2020 2020  s=0)..          
+0000a140: 2020 2020 2020 4920 3d20 495b 2e2e 2e2c        I = I[...,
+0000a150: 2069 6478 5d0d 0a20 2020 2020 2020 2020   idx]..         
+0000a160: 2020 2065 6c69 6620 4320 3d3d 2033 3a0d     elif C == 3:.
+0000a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a180: 2069 6478 203d 2073 656c 662e 6820 213d   idx = self.h !=
+0000a190: 2030 0d0a 2020 2020 2020 2020 2020 2020   0..            
+0000a1a0: 2020 2020 4920 3d20 6e70 2e6d 6f76 6561      I = np.movea
+0000a1b0: 7869 7328 492c 2030 2c20 2d32 2920 2023  xis(I, 0, -2)  #
+0000a1c0: 2072 6574 7572 6e73 2061 2076 6965 770d   returns a view.
+0000a1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a1e0: 2049 203d 2049 5b2e 2e2e 2c20 6964 785d   I = I[..., idx]
+0000a1f0: 0d0a 2020 2020 2020 2020 656c 7365 3a0d  ..        else:.
+0000a200: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+0000a210: 7573 6520 636f 6c6f 7273 2062 7920 7765  use colors by we
+0000a220: 6967 6874 6564 2061 7665 7261 6769 6e67  ighted averaging
+0000a230: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+0000a240: 7720 3d20 7365 6c66 2e68 202f 206e 702e  w = self.h / np.
+0000a250: 7375 6d28 7365 6c66 2e68 2c20 6178 6973  sum(self.h, axis
+0000a260: 3d30 2920 2023 206e 6f72 6d61 6c69 7a65  =0)  # normalize
+0000a270: 6420 7765 6967 6874 730d 0a20 2020 2020  d weights..     
+0000a280: 2020 2020 2020 2023 2077 5b6e 702e 6973         # w[np.is
+0000a290: 6e61 6e28 7729 5d20 3d20 300d 0a20 2020  nan(w)] = 0..   
+0000a2a0: 2020 2020 2020 2020 2069 6620 4320 3d3d           if C ==
+0000a2b0: 2031 2061 6e64 206d 6f6e 6f3a 0d0a 2020   1 and mono:..  
+0000a2c0: 2020 2020 2020 2020 2020 2020 2020 7720                w 
+0000a2d0: 3d20 775b 3a2c 2030 5d5b 3a2c 204e 6f6e  = w[:, 0][:, Non
+0000a2e0: 655d 2020 2320 656e 7375 7265 7320 7468  e]  # ensures th
+0000a2f0: 6174 2074 6865 2072 6573 756c 7420 6861  at the result ha
+0000a300: 7320 6f6e 6c79 206f 6e65 2063 6f6c 6f72  s only one color
+0000a310: 2063 6861 6e6e 656c 0d0a 0d0a 2020 2020   channel....    
+0000a320: 2020 2020 2020 2020 2320 6966 206e 702e          # if np.
+0000a330: 616c 6c28 2877 203d 3d20 3029 207c 2028  all((w == 0) | (
+0000a340: 7720 3d3d 2031 2929 3a20 2023 2074 6f64  w == 1)):  # tod
+0000a350: 6f3a 2066 7573 6520 6875 6573 2077 6974  o: fuse hues wit
+0000a360: 6820 5741 5647 0d0a 2020 2020 2020 2020  h WAVG..        
+0000a370: 2020 2020 2320 2020 2020 7720 3d20 772e      #     w = w.
+0000a380: 6173 7479 7065 2862 6f6f 6c2c 2063 6f70  astype(bool, cop
+0000a390: 793d 4661 6c73 6529 2020 2320 6d75 6c74  y=False)  # mult
+0000a3a0: 6970 6c79 696e 6720 7769 7468 2062 6f6f  iplying with boo
+0000a3b0: 6c20 7072 6573 6572 7665 7320 6474 7970  l preserves dtyp
+0000a3c0: 650d 0a20 2020 2020 2020 2020 2020 2023  e..            #
+0000a3d0: 2020 2020 2064 7479 7065 203d 2049 2e64       dtype = I.d
+0000a3e0: 7479 7065 2020 2320 7769 7468 6f75 7420  type  # without 
+0000a3f0: 7468 6973 2c20 6e70 2e73 756d 2063 686f  this, np.sum cho
+0000a400: 6f73 6573 2061 2064 7479 7065 2077 6869  oses a dtype whi
+0000a410: 6368 2063 616e 2068 6f6c 6420 7468 6520  ch can hold the 
+0000a420: 7468 656f 7265 7469 6361 6c20 6d61 7869  theoretical maxi
+0000a430: 6d61 6c20 7375 6d0d 0a20 2020 2020 2020  mal sum..       
+0000a440: 2020 2020 2023 2065 6c73 653a 0d0a 0d0a       # else:....
+0000a450: 2020 2020 2020 2020 2020 2020 6474 7970              dtyp
+0000a460: 6520 3d20 666c 6f61 7420 2023 2077 6974  e = float  # wit
+0000a470: 686f 7574 2074 6869 732c 206e 702e 7375  hout this, np.su
+0000a480: 6d20 6368 6f6f 7365 7320 6120 6474 7970  m chooses a dtyp
+0000a490: 6520 7768 6963 6820 6361 6e20 686f 6c64  e which can hold
+0000a4a0: 2074 6865 2074 6865 6f72 6574 6963 616c   the theoretical
+0000a4b0: 206d 6178 696d 616c 2073 756d 0d0a 2020   maximal sum..  
+0000a4c0: 2020 2020 2020 2020 2020 4920 3d20 6e70            I = np
+0000a4d0: 2e73 756d 2849 202a 2077 5b3a 2c20 4e6f  .sum(I * w[:, No
+0000a4e0: 6e65 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20  ne, None, None, 
+0000a4f0: 3a5d 2c20 6178 6973 3d30 2c20 6474 7970  :], axis=0, dtyp
+0000a500: 653d 6474 7970 6529 0d0a 2020 2020 2020  e=dtype)..      
+0000a510: 2020 2020 2020 2320 746f 646f 3a20 6e75        # todo: nu
+0000a520: 6d70 792e 7465 6e73 6f72 646f 7420 3f0d  mpy.tensordot ?.
+0000a530: 0a0d 0a20 2020 2020 2020 206c 6f67 6769  ...        loggi
+0000a540: 6e67 2e64 6562 7567 2866 227b 3130 3030  ng.debug(f"{1000
+0000a550: 202a 2028 7469 6d65 2e70 6572 665f 636f   * (time.perf_co
+0000a560: 756e 7465 7228 2920 2d20 7430 297d 6d73  unter() - t0)}ms
+0000a570: 2229 0d0a 0d0a 2020 2020 2020 2020 7265  ")....        re
+0000a580: 7475 726e 2049 0d0a 0d0a 2020 2020 6465  turn I....    de
+0000a590: 6620 656e 636f 6465 280d 0a20 2020 2020  f encode(..     
+0000a5a0: 2020 2073 656c 662c 0d0a 2020 2020 2020     self,..      
+0000a5b0: 2020 7869 3a20 6c69 7374 207c 206e 702e    xi: list | np.
+0000a5c0: 6e64 6172 7261 7920 3d20 4e6f 6e65 2c0d  ndarray = None,.
+0000a5d0: 0a20 2020 2020 2020 2066 7261 6d65 733a  .        frames:
+0000a5e0: 2069 6e74 207c 2074 7570 6c65 203d 204e   int | tuple = N
+0000a5f0: 6f6e 652c 0d0a 2020 2020 2020 2020 7269  one,..        ri
+0000a600: 6e74 3a20 626f 6f6c 203d 2054 7275 652c  nt: bool = True,
+0000a610: 0d0a 2020 2020 2020 2020 7369 6d75 6c61  ..        simula
+0000a620: 7465 3a20 626f 6f6c 203d 2046 616c 7365  te: bool = False
+0000a630: 2c0d 0a20 2020 2029 202d 3e20 6e70 2e6e  ,..    ) -> np.n
+0000a640: 6461 7272 6179 3a0d 0a20 2020 2020 2020  darray:..       
+0000a650: 2022 2222 456e 636f 6465 2066 7269 6e67   """Encode fring
+0000a660: 6520 7061 7474 6572 6e73 2e0d 0a0d 0a20  e patterns..... 
+0000a670: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+0000a680: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
+0000a690: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2078  -----..        x
+0000a6a0: 6920 3a20 4e6f 6e65 206f 7220 6c69 7374  i : None or list
+0000a6b0: 206f 6620 6172 7261 7973 206f 7220 6f6e   of arrays or on
+0000a6c0: 6520 6172 7261 7920 6f66 2067 7269 6420  e array of grid 
+0000a6d0: 696e 6469 6365 732c 206f 7074 696f 6e61  indices, optiona
+0000a6e0: 6c0d 0a20 2020 2020 2020 2020 2020 204c  l..            L
+0000a6f0: 6973 7420 6f66 2063 6f6f 7264 696e 6174  ist of coordinat
+0000a700: 6520 6d61 7472 6963 6573 2066 726f 6d20  e matrices from 
+0000a710: 636f 6f72 6469 6e61 7465 2076 6563 746f  coordinate vecto
+0000a720: 7273 2069 6e20 4361 7274 6573 6961 6e20  rs in Cartesian 
+0000a730: 2827 7879 2729 2069 6e64 6578 696e 670d  ('xy') indexing.
+0000a740: 0a20 2020 2020 2020 2020 2020 2028 652e  .            (e.
+0000a750: 672e 2066 726f 6d20 606e 756d 7079 2e6d  g. from `numpy.m
+0000a760: 6573 6867 7269 6420 3c68 7474 7073 3a2f  eshgrid <https:/
+0000a770: 2f6e 756d 7079 2e6f 7267 2f64 6f63 2f73  /numpy.org/doc/s
+0000a780: 7461 626c 652f 7265 6665 7265 6e63 652f  table/reference/
+0000a790: 6765 6e65 7261 7465 642f 6e75 6d70 792e  generated/numpy.
+0000a7a0: 6d65 7368 6772 6964 2e68 746d 6c3e 605f  meshgrid.html>`_
+0000a7b0: 292e 0d0a 2020 2020 2020 2020 2020 2020  )...            
+0000a7c0: 5468 6520 6465 6661 756c 7420 6973 2065  The default is e
+0000a7d0: 7175 616c 2074 6f20 276e 756d 7079 2e69  qual to 'numpy.i
+0000a7e0: 6e64 6963 6573 2828 7365 6c66 2e59 2c20  ndices((self.Y, 
+0000a7f0: 7365 6c66 2e58 2929 272e 0d0a 0d0a 2020  self.X))'.....  
+0000a800: 2020 2020 2020 6672 616d 6573 203a 204e        frames : N
+0000a810: 6f6e 6520 6f72 2069 6e74 206f 7220 7475  one or int or tu
+0000a820: 706c 6520 6f66 2069 6e74 732c 206f 7074  ple of ints, opt
+0000a830: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
+0000a840: 2020 2049 6e64 6963 6573 206f 6620 7468     Indices of th
+0000a850: 6520 6672 616d 6573 2074 6f20 6265 2065  e frames to be e
+0000a860: 6e63 6f64 6564 2e0d 0a20 2020 2020 2020  ncoded...       
+0000a870: 2020 2020 2054 6865 2064 6566 6175 6c74       The default
+0000a880: 2c20 6672 616d 6573 3d4e 6f6e 652c 2077  , frames=None, w
+0000a890: 696c 6c20 656e 636f 6465 2061 6c6c 2066  ill encode all f
+0000a8a0: 7261 6d65 7320 6174 206f 6e63 652e 0d0a  rames at once...
+0000a8b0: 2020 2020 2020 2020 2020 2020 4966 2066              If f
+0000a8c0: 7261 6d65 7320 6973 206e 6567 6174 6976  rames is negativ
+0000a8d0: 652c 2069 7420 636f 756e 7473 2066 726f  e, it counts fro
+0000a8e0: 6d20 7468 6520 6c61 7374 2074 6f20 7468  m the last to th
+0000a8f0: 6520 6669 7273 7420 6672 616d 652e 0d0a  e first frame...
+0000a900: 2020 2020 2020 2020 2020 2020 4966 2066              If f
+0000a910: 7261 6d65 7320 636f 6e74 6169 6e73 206e  rames contains n
+0000a920: 756d 6265 7273 2077 686f 7365 206d 6167  umbers whose mag
+0000a930: 6e69 7475 6465 2069 7320 6c61 7267 6572  nitude is larger
+0000a940: 2074 6861 6e20 7468 6520 746f 7461 6c20   than the total 
+0000a950: 6e75 6d62 6572 206f 6620 6672 616d 6573  number of frames
+0000a960: 0d0a 2020 2020 2020 2020 2020 2020 2861  ..            (a
+0000a970: 7320 7370 6563 6966 6965 6420 6279 2074  s specified by t
+0000a980: 6865 2061 7474 7269 6275 7465 2060 5460  he attribute `T`
+0000a990: 206f 6620 7468 6520 4672 696e 6765 7320   of the Fringes 
+0000a9a0: 696e 7374 616e 6365 292c 2069 7420 6973  instance), it is
+0000a9b0: 2077 7261 7070 6564 2061 726f 756e 642e   wrapped around.
+0000a9c0: 0d0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+0000a9d0: 2066 7261 6d65 7320 6973 2061 2074 7570   frames is a tup
+0000a9e0: 6c65 206f 6620 696e 7473 2c20 6f6e 6c79  le of ints, only
+0000a9f0: 2074 6865 2066 7261 6d65 7320 7370 6563   the frames spec
+0000aa00: 6966 6965 6420 696e 2074 6865 2074 7570  ified in the tup
+0000aa10: 6c65 2061 7265 2065 6e63 6f64 6564 2e0d  le are encoded..
+0000aa20: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+0000aa30: 696e 6469 6365 7320 6f63 6375 7220 6d6f  indices occur mo
+0000aa40: 7265 2074 6861 6e20 6f6e 6365 2c20 6f6e  re than once, on
+0000aa50: 6c79 2074 6865 2066 6972 7374 206f 6363  ly the first occ
+0000aa60: 7572 656e 6365 2069 7320 656e 636f 6465  urence is encode
+0000aa70: 642e 0d0a 0d0a 2020 2020 2020 2020 7269  d.....        ri
+0000aa80: 6e74 203a 2062 6f6f 6c2c 206f 7074 696f  nt : bool, optio
+0000aa90: 6e61 6c0d 0a20 2020 2020 2020 2020 2020  nal..           
+0000aaa0: 2049 6620 7468 6973 2069 7320 7365 7420   If this is set 
+0000aab0: 746f 2054 7275 6520 2874 6865 2064 6566  to True (the def
+0000aac0: 6175 6c74 290d 0a20 2020 2020 2020 2020  ault)..         
+0000aad0: 2020 2061 6e64 2074 6865 2075 7365 6420     and the used 
+0000aae0: 6474 7970 6520 2861 7474 7269 6275 7465  dtype (attribute
+0000aaf0: 2060 6474 7970 6560 206f 6620 7468 6520   `dtype` of the 
+0000ab00: 4672 696e 6765 7320 696e 7374 616e 6365  Fringes instance
+0000ab10: 2920 6973 206f 6620 7479 7065 2069 6e74  ) is of type int
+0000ab20: 6572 6765 722c 0d0a 2020 2020 2020 2020  erger,..        
+0000ab30: 2020 2020 7468 6520 656e 636f 6465 6420      the encoded 
+0000ab40: 7061 7474 6572 6e73 2077 696c 6c20 6265  patterns will be
+0000ab50: 2072 6f75 6e64 6564 2074 6f20 7468 6520   rounded to the 
+0000ab60: 6e65 6172 6573 7420 696e 7465 6765 722e  nearest integer.
+0000ab70: 0d0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+0000ab80: 2074 6869 7320 6973 2073 6574 2046 616c   this is set Fal
+0000ab90: 7365 2061 6e64 2074 6865 2075 7365 6420  se and the used 
+0000aba0: 6474 7970 6520 6973 206f 6620 7479 7065  dtype is of type
+0000abb0: 2069 6e74 6572 6765 722c 0d0a 2020 2020   interger,..    
+0000abc0: 2020 2020 2020 2020 7468 6520 6672 6163          the frac
+0000abd0: 7469 6f6e 616c 2070 6172 7420 6f66 2074  tional part of t
+0000abe0: 6865 2065 6e63 6f64 6564 2070 6174 7465  he encoded patte
+0000abf0: 726e 7320 7769 6c6c 2062 6520 6469 7363  rns will be disc
+0000ac00: 6172 6465 642e 0d0a 0d0a 2020 2020 2020  arded.....      
+0000ac10: 2020 7369 6d75 6c61 7465 203a 2062 6f6f    simulate : boo
+0000ac20: 6c2c 206f 7074 696f 6e61 6c0d 0a20 2020  l, optional..   
+0000ac30: 2020 2020 2020 2020 2049 6620 7468 6973           If this
+0000ac40: 2069 7320 7365 7420 746f 2054 7275 652c   is set to True,
+0000ac50: 2074 6865 2061 6371 7569 7369 7469 6f6e   the acquisition
+0000ac60: 2c20 692e 652e 2074 6865 2074 7261 6e73  , i.e. the trans
+0000ac70: 6d69 7373 696f 6e20 6368 616e 6e65 6c2c  mission channel,
+0000ac80: 2077 696c 6c20 6265 2073 696d 756c 6174   will be simulat
+0000ac90: 6564 2e0d 0a20 2020 2020 2020 2020 2020  ed...           
+0000aca0: 2054 6869 7320 696e 636c 7564 6573 2074   This includes t
+0000acb0: 6865 206d 6f64 756c 6174 696f 6e20 7472  he modulation tr
+0000acc0: 616e 7366 6572 2066 756e 6374 696f 6e0d  ansfer function.
+0000acd0: 0a20 2020 2020 2020 2020 2020 2028 636f  .            (co
+0000ace0: 6d70 7574 6564 2066 726f 6d20 7468 6520  mputed from the 
+0000acf0: 696d 6167 696e 6720 7379 7374 656d 2773  imaging system's
+0000ad00: 2070 6f69 6e74 2073 7072 6561 6420 6675   point spread fu
+0000ad10: 6e63 7469 6f6e 290d 0a20 2020 2020 2020  nction)..       
+0000ad20: 2020 2020 2061 6e64 2069 6e74 656e 7369       and intensi
+0000ad30: 7479 206e 6f69 7365 2061 6464 6564 2062  ty noise added b
+0000ad40: 7920 7468 6520 6361 6d65 7261 2e0d 0a20  y the camera... 
+0000ad50: 2020 2020 2020 2020 2020 2054 6865 2072             The r
+0000ad60: 6571 7569 7265 6420 7061 7261 6d65 7465  equired paramete
+0000ad70: 7273 2066 6f72 2074 6869 7320 6172 6520  rs for this are 
+0000ad80: 7468 6520 696e 7374 616e 6365 2773 2061  the instance's a
+0000ad90: 7474 7269 6275 7465 730d 0a20 2020 2020  ttributes..     
+0000ada0: 2020 2020 2020 2060 5053 4660 2c20 6067         `PSF`, `g
+0000adb0: 6169 6e60 2c20 6064 6172 6b5f 6375 7272  ain`, `dark_curr
+0000adc0: 656e 7460 2c20 6064 6172 6b60 2c20 6071  ent`, `dark`, `q
+0000add0: 7561 6e74 6020 616e 6420 2773 686f 7427  uant` and 'shot'
+0000ade0: 202e 0d0a 2020 2020 2020 2020 2020 2020   ...            
+0000adf0: 4465 6661 756c 7420 6973 2046 616c 7365  Default is False
+0000ae00: 2e0d 0a0d 0a20 2020 2020 2020 2052 6574  .....        Ret
+0000ae10: 7572 6e73 0d0a 2020 2020 2020 2020 2d2d  urns..        --
+0000ae20: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2049  -----..        I
+0000ae30: 203a 206e 702e 6e64 6172 7261 790d 0a20   : np.ndarray.. 
+0000ae40: 2020 2020 2020 2020 2020 2046 7269 6e67             Fring
+0000ae50: 6520 7061 7474 6572 6e20 7365 7175 656e  e pattern sequen
+0000ae60: 6365 2e0d 0a0d 0a20 2020 2020 2020 2052  ce.....        R
+0000ae70: 6169 7365 730d 0a20 2020 2020 2020 202d  aises..        -
+0000ae80: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2056  -----..        V
+0000ae90: 616c 7565 2045 7272 6f72 0d0a 2020 2020  alue Error..    
+0000aea0: 2020 2020 2020 2020 5468 6520 6c65 6e67          The leng
+0000aeb0: 7468 206f 6620 7468 6520 6c69 7374 2f6e  th of the list/n
+0000aec0: 756d 6265 7220 6f66 2063 6f6f 7264 696e  umber of coordin
+0000aed0: 6174 6520 6d61 7472 6963 6573 2064 6f65  ate matrices doe
+0000aee0: 736e 2774 206d 6174 6368 2074 6865 2046  sn't match the F
+0000aef0: 7269 6e67 6573 2069 6e73 7461 6e63 6527  ringes instance'
+0000af00: 7320 7061 7261 6d65 7465 7220 6044 602c  s parameter `D`,
+0000af10: 0d0a 2020 2020 2020 2020 2020 2020 7468  ..            th
+0000af20: 6520 736d 616c 6c65 7374 2063 6f6e 7461  e smallest conta
+0000af30: 696e 6564 2063 6f6f 6472 696e 6174 6520  ined coodrinate 
+0000af40: 6973 2073 6d61 6c6c 6572 2074 6861 6e20  is smaller than 
+0000af50: 7a65 726f 0d0a 2020 2020 2020 2020 2020  zero..          
+0000af60: 2020 6f72 2074 6865 206c 6172 6765 7374    or the largest
+0000af70: 2063 6f6e 7461 696e 6564 2063 6f6f 6469   contained coodi
+0000af80: 6e61 7465 2069 7320 6571 7561 6c20 746f  nate is equal to
+0000af90: 206f 7220 6578 6365 6564 7320 7468 6520   or exceeds the 
+0000afa0: 4672 696e 6765 7320 696e 7374 616e 6365  Fringes instance
+0000afb0: 2773 2077 6964 7468 2060 5860 2072 6573  's width `X` res
+0000afc0: 702e 2068 6569 6768 7420 6059 602e 0d0a  p. height `Y`...
+0000afd0: 0d0a 2020 2020 2020 2020 4e6f 7465 730d  ..        Notes.
+0000afe0: 0a20 2020 2020 2020 202d 2d2d 2d2d 0d0a  .        -----..
+0000aff0: 2020 2020 2020 2020 546f 2072 6563 6569          To recei
+0000b000: 7665 2074 6865 2066 7261 6d65 7320 6974  ve the frames it
+0000b010: 6572 6174 6976 656c 7920 2869 2e65 2e20  eratively (i.e. 
+0000b020: 696e 2061 206c 617a 7920 6d61 6e6e 6572  in a lazy manner
+0000b030: 292c 0d0a 2020 2020 2020 2020 7369 6d70  ),..        simp
+0000b040: 6c79 2069 7465 7261 7465 206f 7665 7220  ly iterate over 
+0000b050: 7468 6520 4672 696e 6765 7320 696e 7374  the Fringes inst
+0000b060: 616e 6365 2e0d 0a20 2020 2020 2020 2041  ance...        A
+0000b070: 6c74 6572 6e61 7469 7665 6c79 2c20 746f  lternatively, to
+0000b080: 2072 6563 6569 7665 2061 7262 6974 7261   receive arbitra
+0000b090: 7279 2066 7261 6d65 732c 0d0a 2020 2020  ry frames,..    
+0000b0a0: 2020 2020 696e 6465 7820 7468 6520 4672      index the Fr
+0000b0b0: 696e 6765 7320 696e 7374 616e 6365 2064  inges instance d
+0000b0c0: 6972 6563 746c 792c 0d0a 2020 2020 2020  irectly,..      
+0000b0d0: 2020 6569 7468 6572 2077 6974 6820 616e    either with an
+0000b0e0: 2069 6e74 6567 6572 2c20 6120 7475 706c   integer, a tupl
+0000b0f0: 6520 6f72 2061 2073 6c69 6365 2e0d 0a0d  e or a slice....
+0000b100: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
+0000b110: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
+0000b120: 2d2d 2d0d 0a20 2020 2020 2020 203e 3e3e  ---..        >>>
+0000b130: 2069 6d70 6f72 7420 6672 696e 6765 7320   import fringes 
+0000b140: 6173 2066 726e 670d 0a20 2020 2020 2020  as frng..       
+0000b150: 203e 3e3e 2066 203d 2066 726e 672e 4672   >>> f = frng.Fr
+0000b160: 696e 6765 7328 290d 0a0d 0a20 2020 2020  inges()....     
+0000b170: 2020 2045 6e63 6f64 6520 7468 6520 636f     Encode the co
+0000b180: 6d70 6c65 7465 2066 7269 6e67 6520 7061  mplete fringe pa
+0000b190: 7474 6572 6e20 7365 7175 656e 6365 2e0d  ttern sequence..
+0000b1a0: 0a0d 0a20 2020 2020 2020 203e 3e3e 2049  ...        >>> I
+0000b1b0: 203d 2066 2e65 6e63 6f64 6528 290d 0a0d   = f.encode()...
+0000b1c0: 0a20 2020 2020 2020 2045 6e63 6f64 6520  .        Encode 
+0000b1d0: 7468 6520 6669 7273 7420 6672 616d 6520  the first frame 
+0000b1e0: 6f66 2074 6865 2066 7269 6e67 6520 7061  of the fringe pa
+0000b1f0: 7474 6572 6e20 7365 7175 656e 6365 2e0d  ttern sequence..
+0000b200: 0a0d 0a20 2020 2020 2020 203e 3e3e 2049  ...        >>> I
+0000b210: 203d 2066 2e65 6e63 6f64 6528 6672 616d   = f.encode(fram
+0000b220: 6573 3d30 290d 0a20 2020 2020 2020 203e  es=0)..        >
+0000b230: 3e3e 2049 203d 2066 5b30 5d0d 0a20 2020  >> I = f[0]..   
+0000b240: 2020 2020 203e 3e3e 2049 203d 206e 6578       >>> I = nex
+0000b250: 7428 6974 6572 2866 2929 0d0a 0d0a 2020  t(iter(f))....  
+0000b260: 2020 2020 2020 456e 636f 6465 2074 6865        Encode the
+0000b270: 206c 6173 7420 6672 616d 6520 6f66 2074   last frame of t
+0000b280: 6865 2066 7269 6e67 6520 7061 7474 6572  he fringe patter
+0000b290: 6e20 7365 7175 656e 6365 2e0d 0a0d 0a20  n sequence..... 
+0000b2a0: 2020 2020 2020 203e 3e3e 2049 203d 2066         >>> I = f
+0000b2b0: 2e65 6e63 6f64 6528 6672 616d 6573 3d2d  .encode(frames=-
+0000b2c0: 3129 0d0a 2020 2020 2020 2020 3e3e 3e20  1)..        >>> 
+0000b2d0: 4920 3d20 665b 2d31 5d0d 0a0d 0a20 2020  I = f[-1]....   
+0000b2e0: 2020 2020 2045 6e63 6f64 6520 7468 6520       Encode the 
+0000b2f0: 6669 7273 7420 7477 6f20 6672 616d 6573  first two frames
+0000b300: 206f 6620 7468 6520 6672 696e 6765 2070   of the fringe p
+0000b310: 6174 7465 726e 2073 6571 7565 6e63 652e  attern sequence.
+0000b320: 0d0a 0d0a 2020 2020 2020 2020 3e3e 3e20  ....        >>> 
+0000b330: 4920 3d20 662e 656e 636f 6465 2866 7261  I = f.encode(fra
+0000b340: 6d65 733d 2830 2c20 3129 290d 0a20 2020  mes=(0, 1))..   
+0000b350: 2020 2020 203e 3e3e 2049 203d 2066 5b30       >>> I = f[0
+0000b360: 2c20 315d 0d0a 2020 2020 2020 2020 3e3e  , 1]..        >>
+0000b370: 3e20 4920 3d20 665b 3a32 5d0d 0a0d 0a20  > I = f[:2].... 
+0000b380: 2020 2020 2020 2043 7265 6174 6520 6120         Create a 
+0000b390: 6765 6e65 7261 746f 7220 746f 2072 6563  generator to rec
+0000b3a0: 6569 7665 2074 6865 2066 7261 6d65 7320  eive the frames 
+0000b3b0: 6974 6572 6174 6976 656c 792c 2069 2e65  iteratively, i.e
+0000b3c0: 2e20 696e 2061 206c 617a 7920 6d61 6e6e  . in a lazy mann
+0000b3d0: 6572 2e0d 0a0d 0a20 2020 2020 2020 203e  er.....        >
+0000b3e0: 3e3e 2049 203d 2028 6672 616d 6520 666f  >> I = (frame fo
+0000b3f0: 7220 6672 616d 6520 696e 2066 290d 0a20  r frame in f).. 
+0000b400: 2020 2020 2020 2022 2222 0d0a 0d0a 2020         """....  
+0000b410: 2020 2020 2020 7430 203d 2074 696d 652e        t0 = time.
+0000b420: 7065 7266 5f63 6f75 6e74 6572 2829 0d0a  perf_counter()..
+0000b430: 0d0a 2020 2020 2020 2020 2320 6368 6563  ..        # chec
+0000b440: 6b20 636f 6f72 6469 6e61 7465 730d 0a20  k coordinates.. 
+0000b450: 2020 2020 2020 2069 6620 7869 2069 7320         if xi is 
+0000b460: 6e6f 7420 4e6f 6e65 3a0d 0a20 2020 2020  not None:..     
+0000b470: 2020 2020 2020 2078 6920 3d20 6e70 2e61         xi = np.a
+0000b480: 7272 6179 2878 6929 0d0a 0d0a 2020 2020  rray(xi)....    
+0000b490: 2020 2020 2020 2020 6966 206c 656e 2878          if len(x
+0000b4a0: 6929 2021 3d20 7365 6c66 2e44 3a0d 0a20  i) != self.D:.. 
+0000b4b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000b4c0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000b4d0: 6622 4e75 6d62 6572 206f 6620 636f 6f72  f"Number of coor
+0000b4e0: 6469 6e61 7465 206d 6174 7269 6365 7320  dinate matrices 
+0000b4f0: 213d 207b 7365 6c66 2e44 7d2e 2229 0d0a  != {self.D}.")..
+0000b500: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0000b510: 2073 656c 662e 696e 6465 7869 6e67 203d   self.indexing =
+0000b520: 3d20 2269 6a22 3a0d 0a20 2020 2020 2020  = "ij":..       
+0000b530: 2020 2020 2020 2020 2078 6920 3d20 7869           xi = xi
+0000b540: 5b3a 3a2d 315d 0d0a 0d0a 2020 2020 2020  [::-1]....      
+0000b550: 2020 2020 2020 666f 7220 6420 696e 2072        for d in r
+0000b560: 616e 6765 2873 656c 662e 4429 3a0d 0a20  ange(self.D):.. 
+0000b570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b580: 6620 6e70 2e6d 696e 2878 695b 645d 2920  f np.min(xi[d]) 
+0000b590: 3c20 303a 0d0a 2020 2020 2020 2020 2020  < 0:..          
+0000b5a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000b5b0: 5661 6c75 6545 7272 6f72 2866 2243 6f6f  ValueError(f"Coo
+0000b5c0: 7264 696e 6174 6573 2063 6f6e 7461 696e  rdinates contain
+0000b5d0: 2076 616c 7565 7320 3c20 302e 2229 0d0a   values < 0.")..
+0000b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5f0: 656c 6966 206e 702e 6d61 7828 7869 5b64  elif np.max(xi[d
+0000b600: 5d29 203e 3d20 7365 6c66 2e52 5b64 5d20  ]) >= self.R[d] 
+0000b610: 2b20 7365 6c66 2e78 303a 0d0a 2020 2020  + self.x0:..    
+0000b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b630: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000b640: 2866 2244 6972 6563 7469 6f6e 207b 647d  (f"Direction {d}
+0000b650: 2063 6f6e 7461 696e 7320 636f 6f72 6469   contains coordi
+0000b660: 6e61 7465 7320 3e20 7b73 656c 662e 525b  nates > {self.R[
+0000b670: 645d 7d2e 2229 0d0a 0d0a 2020 2020 2020  d]}.")....      
+0000b680: 2020 2320 6672 616d 6573 0d0a 2020 2020    # frames..    
+0000b690: 2020 2020 6966 2066 7261 6d65 7320 6973      if frames is
+0000b6a0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+0000b6b0: 2020 2020 2320 6672 616d 6573 203d 206e      # frames = n
+0000b6c0: 702e 6172 616e 6765 286e 702e 7375 6d28  p.arange(np.sum(
+0000b6d0: 7365 6c66 2e5f 4e29 290d 0a20 2020 2020  self._N))..     
+0000b6e0: 2020 2020 2020 2066 7261 6d65 7320 3d20         frames = 
+0000b6f0: 6e70 2e61 7261 6e67 6528 7365 6c66 2e48  np.arange(self.H
+0000b700: 202a 206e 702e 7375 6d28 7365 6c66 2e5f   * np.sum(self._
+0000b710: 4e29 290d 0a20 2020 2020 2020 2065 6c73  N))..        els
+0000b720: 653a 2020 2320 6c61 7a79 2065 6e63 6f64  e:  # lazy encod
+0000b730: 696e 670d 0a20 2020 2020 2020 2020 2020  ing..           
+0000b740: 2074 7279 3a20 2023 2065 6e73 7572 6520   try:  # ensure 
+0000b750: 6672 616d 6573 2069 7320 6974 6572 6162  frames is iterab
+0000b760: 6c65 0d0a 2020 2020 2020 2020 2020 2020  le..            
+0000b770: 2020 2020 6974 6572 2866 7261 6d65 7329      iter(frames)
+0000b780: 0d0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+0000b790: 6365 7074 2054 7970 6545 7272 6f72 3a0d  cept TypeError:.
+0000b7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b7b0: 2066 7261 6d65 7320 3d20 5b66 7261 6d65   frames = [frame
+0000b7c0: 735d 0d0a 0d0a 2020 2020 2020 2020 2020  s]....          
+0000b7d0: 2020 6672 616d 6573 203d 206e 702e 6172    frames = np.ar
+0000b7e0: 7261 7928 6672 616d 6573 2c20 696e 7429  ray(frames, int)
+0000b7f0: 2e72 6176 656c 2829 2025 2073 656c 662e  .ravel() % self.
+0000b800: 540d 0a0d 0a20 2020 2020 2020 2020 2020  T....           
+0000b810: 2069 6620 7365 6c66 2e46 444d 3a0d 0a20   if self.FDM:.. 
+0000b820: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000b830: 7261 6d65 7320 3d20 6e70 2e61 7272 6179  rames = np.array
+0000b840: 285b 6e70 2e61 7261 6e67 6528 6920 2a20  ([np.arange(i * 
+0000b850: 7365 6c66 2e44 202a 2073 656c 662e 4b2c  self.D * self.K,
+0000b860: 2028 6920 2b20 3129 202a 2073 656c 662e   (i + 1) * self.
+0000b870: 4420 2a20 7365 6c66 2e4b 2920 666f 7220  D * self.K) for 
+0000b880: 6920 696e 2066 7261 6d65 735d 292e 7261  i in frames]).ra
+0000b890: 7665 6c28 290d 0a0d 0a20 2020 2020 2020  vel()....       
+0000b8a0: 2020 2020 2069 6620 7365 6c66 2e57 444d       if self.WDM
+0000b8b0: 3a20 2023 2057 444d 2062 6566 6f72 6520  :  # WDM before 
+0000b8c0: 5344 4d0d 0a20 2020 2020 2020 2020 2020  SDM..           
+0000b8d0: 2020 2020 204e 203d 2033 0d0a 2020 2020       N = 3..    
+0000b8e0: 2020 2020 2020 2020 2020 2020 6672 616d              fram
+0000b8f0: 6573 203d 206e 702e 6172 7261 7928 5b6e  es = np.array([n
+0000b900: 702e 6172 616e 6765 2869 202a 204e 2c20  p.arange(i * N, 
+0000b910: 2869 202b 2031 2920 2a20 4e29 2066 6f72  (i + 1) * N) for
+0000b920: 2069 2069 6e20 6672 616d 6573 5d29 2e72   i in frames]).r
+0000b930: 6176 656c 2829 0d0a 0d0a 2020 2020 2020  avel()....      
+0000b940: 2020 2020 2020 6966 2073 656c 662e 5344        if self.SD
+0000b950: 4d3a 2020 2320 5744 4d20 6265 666f 7265  M:  # WDM before
+0000b960: 2053 444d 0d0a 2020 2020 2020 2020 2020   SDM..          
+0000b970: 2020 2020 2020 6c65 6e5f 4430 203d 206e        len_D0 = n
+0000b980: 702e 7375 6d28 7365 6c66 2e5f 4e5b 305d  p.sum(self._N[0]
+0000b990: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b9a0: 2020 2066 7261 6d65 7320 3d20 6e70 2e61     frames = np.a
+0000b9b0: 7272 6179 285b 6e70 2e61 7261 6e67 6528  rray([np.arange(
+0000b9c0: 692c 2069 202b 206c 656e 5f44 3020 2b20  i, i + len_D0 + 
+0000b9d0: 312c 206c 656e 5f44 3029 2066 6f72 2069  1, len_D0) for i
+0000b9e0: 2069 6e20 6672 616d 6573 5d29 2e72 6176   in frames]).rav
+0000b9f0: 656c 2829 0d0a 0d0a 2020 2020 2020 2020  el()....        
+0000ba00: 2320 6d6f 6475 6c61 7465 0d0a 2020 2020  # modulate..    
+0000ba10: 2020 2020 4920 3d20 7365 6c66 2e5f 6d6f      I = self._mo
+0000ba20: 6475 6c61 7465 2878 692c 2066 7261 6d65  dulate(xi, frame
+0000ba30: 732c 2072 696e 7429 0d0a 0d0a 2020 2020  s, rint)....    
+0000ba40: 2020 2020 2320 6d75 6c74 6970 6c65 7820      # multiplex 
+0000ba50: 2872 6564 7563 6520 6e75 6d62 6572 206f  (reduce number o
+0000ba60: 6620 6672 616d 6573 290d 0a20 2020 2020  f frames)..     
+0000ba70: 2020 2069 6620 7365 6c66 2e53 444d 206f     if self.SDM o
+0000ba80: 7220 7365 6c66 2e57 444d 206f 7220 7365  r self.WDM or se
+0000ba90: 6c66 2e46 444d 3a0d 0a20 2020 2020 2020  lf.FDM:..       
+0000baa0: 2020 2020 2049 203d 2073 656c 662e 5f6d       I = self._m
+0000bab0: 756c 7469 706c 6578 2849 2c20 7269 6e74  ultiplex(I, rint
+0000bac0: 290d 0a0d 0a20 2020 2020 2020 2023 2061  )....        # a
+0000bad0: 7070 6c79 2069 6e73 6372 6962 6564 2063  pply inscribed c
+0000bae0: 6972 636c 650d 0a20 2020 2020 2020 2069  ircle..        i
+0000baf0: 6620 7365 6c66 2e67 7269 6420 696e 205b  f self.grid in [
+0000bb00: 2270 6f6c 6172 222c 2022 6c6f 672d 706f  "polar", "log-po
+0000bb10: 6c61 7222 5d3a 0d0a 2020 2020 2020 2020  lar"]:..        
+0000bb20: 2020 2020 4920 2a3d 2067 7269 642e 696e      I *= grid.in
+0000bb30: 6e65 7263 6972 6328 7365 6c66 2e59 2c20  nercirc(self.Y, 
+0000bb40: 7365 6c66 2e58 295b 4e6f 6e65 2c20 3a2c  self.X)[None, :,
+0000bb50: 203a 2c20 4e6f 6e65 5d0d 0a0d 0a20 2020   :, None]....   
+0000bb60: 2020 2020 2023 2063 6f6c 6f72 697a 6520       # colorize 
+0000bb70: 2865 7874 656e 6465 6420 6176 6572 6167  (extended averag
+0000bb80: 696e 6729 0d0a 2020 2020 2020 2020 6966  ing)..        if
+0000bb90: 2073 656c 662e 4820 3e20 3120 6f72 206e   self.H > 1 or n
+0000bba0: 702e 616e 7928 7365 6c66 2e68 2021 3d20  p.any(self.h != 
+0000bbb0: 3235 3529 3a20 2023 2063 616e 2062 6520  255):  # can be 
+0000bbc0: 7573 6564 2066 6f72 2065 7874 656e 6465  used for extende
+0000bbd0: 6420 6176 6572 6167 696e 670d 0a20 2020  d averaging..   
+0000bbe0: 2020 2020 2020 2020 2049 203d 2073 656c           I = sel
+0000bbf0: 662e 5f63 6f6c 6f72 697a 6528 492c 2066  f._colorize(I, f
+0000bc00: 7261 6d65 7329 0d0a 0d0a 2020 2020 2020  rames)....      
+0000bc10: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+0000bc20: 227b 3130 3030 202a 2028 7469 6d65 2e70  "{1000 * (time.p
+0000bc30: 6572 665f 636f 756e 7465 7228 2920 2d20  erf_counter() - 
+0000bc40: 7430 297d 6d73 2229 0d0a 0d0a 2020 2020  t0)}ms")....    
+0000bc50: 2020 2020 7265 7475 726e 2028 0d0a 2020      return (..  
+0000bc60: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000bc70: 7369 6d75 6c61 7465 2849 2c20 5053 463d  simulate(I, PSF=
+0000bc80: 302c 2073 7973 7465 6d5f 6761 696e 3d73  0, system_gain=s
+0000bc90: 656c 662e 6761 696e 2c20 6461 726b 5f63  elf.gain, dark_c
+0000bca0: 7572 7265 6e74 3d73 656c 662e 7930 202f  urrent=self.y0 /
+0000bcb0: 2073 656c 662e 6761 696e 2c20 6461 726b   self.gain, dark
+0000bcc0: 5f6e 6f69 7365 3d73 656c 662e 6461 726b  _noise=self.dark
+0000bcd0: 290d 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0000bce0: 6620 7369 6d75 6c61 7465 0d0a 2020 2020  f simulate..    
+0000bcf0: 2020 2020 2020 2020 656c 7365 2049 0d0a          else I..
+0000bd00: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
+0000bd10: 2064 6566 2064 6563 6f64 6528 0d0a 2020   def decode(..  
+0000bd20: 2020 2020 2020 7365 6c66 2c0d 0a20 2020        self,..   
+0000bd30: 2020 2020 2049 3a20 6e70 2e6e 6461 7272       I: np.ndarr
+0000bd40: 6179 2c0d 0a20 2020 2020 2020 2076 6572  ay,..        ver
+0000bd50: 626f 7365 3a20 626f 6f6c 203d 2046 616c  bose: bool = Fal
+0000bd60: 7365 2c0d 0a20 2020 2020 2020 2064 6573  se,..        des
+0000bd70: 7069 6b65 3a20 626f 6f6c 203d 2046 616c  pike: bool = Fal
+0000bd80: 7365 2c0d 0a20 2020 2020 2020 2064 656e  se,..        den
+0000bd90: 6f69 7365 3a20 626f 6f6c 203d 2046 616c  oise: bool = Fal
+0000bda0: 7365 2c0d 0a20 2020 2029 202d 3e20 6e61  se,..    ) -> na
+0000bdb0: 6d65 6474 7570 6c65 3a0d 0a20 2020 2020  medtuple:..     
+0000bdc0: 2020 2072 2222 2244 6563 6f64 6520 6672     r"""Decode fr
+0000bdd0: 696e 6765 2070 6174 7465 726e 732e 0d0a  inge patterns...
+0000bde0: 0d0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+0000bdf0: 7465 7273 0d0a 2020 2020 2020 2020 2d2d  ters..        --
+0000be00: 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020 2020  --------..      
+0000be10: 2020 4920 3a20 6e70 2e6e 6461 7272 6179    I : np.ndarray
+0000be20: 0d0a 2020 2020 2020 2020 2020 2020 4672  ..            Fr
+0000be30: 696e 6765 2070 6174 7465 726e 2073 6571  inge pattern seq
+0000be40: 7565 6e63 652e 0d0a 2020 2020 2020 2020  uence...        
+0000be50: 2020 2020 4974 2069 7320 7265 7368 6170      It is reshap
+0000be60: 6564 2074 6f20 7669 6465 6f73 6861 7065  ed to videoshape
+0000be70: 2028 6672 616d 6573 2060 5460 2c20 6865   (frames `T`, he
+0000be80: 6967 6874 2060 5960 2c20 7769 6474 6820  ight `Y`, width 
+0000be90: 6058 602c 2063 6f6c 6f72 2063 6861 6e6e  `X`, color chann
+0000bea0: 656c 7320 6043 6029 2062 6566 6f72 6520  els `C`) before 
+0000beb0: 7072 6f63 6573 7369 6e67 2e0d 0a0d 0a20  processing..... 
+0000bec0: 2020 2020 2020 2020 2020 202e 2e20 6e6f             .. no
+0000bed0: 7465 3a3a 2049 7420 6d75 7374 2068 6176  te:: It must hav
+0000bee0: 6520 6265 656e 2065 6e63 6f64 6564 2077  e been encoded w
+0000bef0: 6974 6820 7468 6520 7361 6d65 2070 6172  ith the same par
+0000bf00: 616d 6574 6572 7320 7365 7420 746f 2074  ameters set to t
+0000bf10: 6865 2046 7269 6e67 6573 2069 6e73 7461  he Fringes insta
+0000bf20: 6e63 6520 6173 2074 6865 2065 6e63 6f64  nce as the encod
+0000bf30: 6564 206f 6e65 2e0d 0a0d 0a20 2020 2020  ed one.....     
+0000bf40: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
+0000bf50: 6c2c 206f 7074 696f 6e61 6c0d 0a20 2020  l, optional..   
+0000bf60: 2020 2020 2020 2020 2049 6620 7468 6973           If this
+0000bf70: 206f 7220 7468 6520 6172 6775 6d65 6e74   or the argument
+0000bf80: 2060 7665 7262 6f73 6560 206f 6620 7468   `verbose` of th
+0000bf90: 6520 4672 696e 6765 7320 696e 7374 616e  e Fringes instan
+0000bfa0: 6365 2069 7320 7365 7420 746f 2054 7275  ce is set to Tru
+0000bfb0: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
+0000bfc0: 6164 6469 7469 6f6e 616c 2069 6e66 6f6d  additional infom
+0000bfd0: 6174 696f 6e20 6973 2063 6f6d 7075 7465  ation is compute
+0000bfe0: 6420 616e 6420 7265 7475 6e65 642e 0d0a  d and retuned...
+0000bff0: 2020 2020 2020 2020 2020 2020 5468 6973              This
+0000c000: 2069 6e63 6c75 6465 733a 2070 6861 7365   includes: phase
+0000c010: 2c20 7265 7369 6475 616c 732c 206f 7264  , residuals, ord
+0000c020: 6572 732c 2075 6e63 6572 7461 696e 7479  ers, uncertainty
+0000c030: 2c20 7669 7369 6269 6c69 7479 2061 6e64  , visibility and
+0000c040: 2065 7870 6f73 7572 652e 0d0a 0d0a 2020   exposure.....  
+0000c050: 2020 2020 2020 6465 7370 696b 653a 2062        despike: b
+0000c060: 6f6f 6c2c 206f 7074 696f 6e61 6c0d 0a20  ool, optional.. 
+0000c070: 2020 2020 2020 2020 2020 2049 6620 7468             If th
+0000c080: 6973 2069 7320 7365 7420 746f 2074 7275  is is set to tru
+0000c090: 652c 2073 696e 676c 6520 7069 7865 6c20  e, single pixel 
+0000c0a0: 6f75 746c 6965 7273 2069 6e20 7468 6520  outliers in the 
+0000c0b0: 756e 7772 6170 7065 6420 7068 6173 6520  unwrapped phase 
+0000c0c0: 6d61 7020 6172 6520 7265 706c 6163 6564  map are replaced
+0000c0d0: 0d0a 2020 2020 2020 2020 2020 2020 6279  ..            by
+0000c0e0: 2074 6865 6972 206c 6f63 616c 206e 6569   their local nei
+0000c0f0: 6768 626f 7268 6f6f 6420 7573 696e 6720  ghborhood using 
+0000c100: 6120 6d65 6469 616e 2066 696c 7465 722e  a median filter.
+0000c110: 0d0a 0d0a 2020 2020 2020 2020 6465 6e6f  ....        deno
+0000c120: 6973 653a 2062 6f6f 6c2c 206f 7074 696f  ise: bool, optio
+0000c130: 6e61 6c0d 0a20 2020 2020 2020 2020 2020  nal..           
+0000c140: 2049 6620 7468 6973 2069 7320 7365 7420   If this is set 
+0000c150: 746f 2054 7275 652c 2074 6865 2075 6e77  to True, the unw
+0000c160: 7261 7070 6564 2070 6861 7365 206d 6170  rapped phase map
+0000c170: 2069 7320 736d 6f6f 7468 656e 6564 0d0a   is smoothened..
+0000c180: 2020 2020 2020 2020 2020 2020 6279 2061              by a
+0000c190: 2062 696c 6174 6572 616c 2066 696c 7465   bilateral filte
+0000c1a0: 7220 7768 6963 6820 6973 2065 6467 652d  r which is edge-
+0000c1b0: 7072 6573 6572 7669 6e67 2e0d 0a0d 0a20  preserving..... 
+0000c1c0: 2020 2020 2020 2052 6574 7572 6e73 0d0a         Returns..
+0000c1d0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0d          -------.
+0000c1e0: 0a20 2020 2020 2020 2062 7269 6768 746e  .        brightn
+0000c1f0: 6573 7320 3a20 6e70 2e6e 6461 7272 6179  ess : np.ndarray
+0000c200: 0d0a 2020 2020 2020 2020 2020 2020 4c6f  ..            Lo
+0000c210: 6361 6c20 6261 636b 6772 6f75 6e64 2073  cal background s
+0000c220: 6967 6e61 6c2e 0d0a 0d0a 2020 2020 2020  ignal.....      
+0000c230: 2020 6d6f 6475 6c61 7469 6f6e 203a 206e    modulation : n
+0000c240: 702e 6e64 6172 7261 790d 0a20 2020 2020  p.ndarray..     
+0000c250: 2020 2020 2020 204c 6f63 616c 2061 6d70         Local amp
+0000c260: 6c69 7475 6465 206f 6620 7468 6520 636f  litude of the co
+0000c270: 7369 6e65 2073 6967 6e61 6c2e 0d0a 0d0a  sine signal.....
+0000c280: 2020 2020 2020 2020 7265 6769 7374 7261          registra
+0000c290: 7469 6f6e 203a 206e 702e 6e64 6172 7261  tion : np.ndarra
+0000c2a0: 790d 0a20 2020 2020 2020 2020 2020 2044  y..            D
+0000c2b0: 6563 6f64 6564 2063 6f6f 7264 696e 6174  ecoded coordinat
+0000c2c0: 6573 2e0d 0a0d 0a20 2020 2020 2020 2020  es.....         
+0000c2d0: 2020 202e 2e20 6e6f 7465 3a3a 2054 6865     .. note:: The
+0000c2e0: 2072 6567 6973 7472 6174 696f 6e20 6973   registration is
+0000c2f0: 2061 206d 6170 7069 6e67 2069 6e20 7468   a mapping in th
+0000c300: 6520 7361 6d65 2070 6978 656c 2067 7269  e same pixel gri
+0000c310: 6420 6173 2074 6865 2063 616d 6572 6120  d as the camera 
+0000c320: 7365 6e73 6f72 0d0a 2020 2020 2020 2020  sensor..        
+0000c330: 2020 2020 2020 616e 6420 636f 6e74 6169        and contai
+0000c340: 6e73 2074 6865 2069 6e66 6f72 6d61 7469  ns the informati
+0000c350: 6f6e 2077 6865 7265 2065 6163 6820 6361  on where each ca
+0000c360: 6d65 7261 2070 6978 656c 2c20 692e 652e  mera pixel, i.e.
+0000c370: 2065 6163 6820 6361 6d65 7261 2073 6967   each camera sig
+0000c380: 6874 7261 792c 0d0a 2020 2020 2020 2020  htray,..        
+0000c390: 2020 2020 2020 7761 7320 6c6f 6f6b 696e        was lookin
+0000c3a0: 6720 6174 2064 7572 696e 6720 7468 6520  g at during the 
+0000c3b0: 6672 696e 6765 2070 6174 7465 726e 2061  fringe pattern a
+0000c3c0: 6371 7569 7369 7469 6f6e 2e0d 0a0d 0a20  cquisition..... 
+0000c3d0: 2020 2020 2020 2070 6861 7365 203a 206e         phase : n
+0000c3e0: 702e 6e64 6172 7261 792c 206f 7074 696f  p.ndarray, optio
+0000c3f0: 6e61 6c0d 0a20 2020 2020 2020 2020 2020  nal..           
+0000c400: 204c 6f63 616c 2070 6861 7365 2e0d 0a0d   Local phase....
+0000c410: 0a20 2020 2020 2020 206f 7264 6572 7320  .        orders 
+0000c420: 3a20 6e70 2e6e 6461 7272 6179 2c20 6f70  : np.ndarray, op
+0000c430: 7469 6f6e 616c 0d0a 2020 2020 2020 2020  tional..        
+0000c440: 2020 2020 4672 696e 6765 206f 7264 6572      Fringe order
+0000c450: 732e 0d0a 0d0a 2020 2020 2020 2020 7265  s.....        re
+0000c460: 7369 6475 616c 7320 3a20 6e70 2e6e 6461  siduals : np.nda
+0000c470: 7272 6179 2c20 6f70 7469 6f6e 616c 0d0a  rray, optional..
+0000c480: 2020 2020 2020 2020 2020 2020 5265 7369              Resi
+0000c490: 6475 616c 7320 6672 6f6d 2074 6865 206f  duals from the o
+0000c4a0: 7074 696d 697a 6174 696f 6e2d 6261 7365  ptimization-base
+0000c4b0: 6420 756e 7772 6170 7069 6e67 2070 726f  d unwrapping pro
+0000c4c0: 6365 7373 2e0d 0a0d 0a20 2020 2020 2020  cess.....       
+0000c4d0: 2075 6e63 6572 7461 696e 7479 203a 206e   uncertainty : n
+0000c4e0: 702e 6e64 6172 7261 792c 206f 7074 696f  p.ndarray, optio
+0000c4f0: 6e61 6c0d 0a20 2020 2020 2020 2020 2020  nal..           
+0000c500: 2075 6e63 6572 7461 696e 7479 206f 6620   uncertainty of 
+0000c510: 706f 7369 7469 6f6e 616c 2064 6563 6f64  positional decod
+0000c520: 696e 6720 696e 2070 6978 656c 2075 6e69  ing in pixel uni
+0000c530: 7473 0d0a 0d0a 2020 2020 2020 2020 7669  ts....        vi
+0000c540: 7369 6269 6c69 7479 203a 206e 702e 6e64  sibility : np.nd
+0000c550: 6172 7261 792c 206f 7074 696f 6e61 6c0d  array, optional.
+0000c560: 0a20 2020 2020 2020 2020 2020 204c 6f63  .            Loc
+0000c570: 616c 2076 6973 6962 696c 6974 7920 2866  al visibility (f
+0000c580: 7269 6e67 6520 636f 6e74 7261 7374 292e  ringe contrast).
+0000c590: 0d0a 0d0a 2020 2020 2020 2020 6578 706f  ....        expo
+0000c5a0: 7375 7265 203a 206e 702e 6e64 6172 7261  sure : np.ndarra
+0000c5b0: 792c 206f 7074 696f 6e61 6c0d 0a20 2020  y, optional..   
+0000c5c0: 2020 2020 2020 2020 204c 6f63 616c 2065           Local e
+0000c5d0: 7870 6f73 7572 6520 2872 656c 6174 6976  xposure (relativ
+0000c5e0: 6520 6176 6572 6167 6520 696e 7465 6e73  e average intens
+0000c5f0: 6974 7929 2e0d 0a0d 0a20 2020 2020 2020  ity).....       
+0000c600: 2052 6169 7365 730d 0a20 2020 2020 2020   Raises..       
+0000c610: 202d 2d2d 2d2d 2d0d 0a20 2020 2020 2020   ------..       
+0000c620: 2041 7373 6572 7469 6f6e 4572 726f 720d   AssertionError.
+0000c630: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+0000c640: 7468 6520 6e75 6d62 6572 206f 6620 6672  the number of fr
+0000c650: 616d 6573 206f 6620 6049 6020 616e 6420  ames of `I` and 
+0000c660: 7468 6520 6174 7472 6962 7574 6520 6054  the attribute `T
+0000c670: 6020 6f66 2074 6865 2060 4672 696e 6765  ` of the `Fringe
+0000c680: 7360 2069 6e73 7461 6e63 6520 646f 6e27  s` instance don'
+0000c690: 7420 6d61 7463 682e 0d0a 0d0a 2020 2020  t match.....    
+0000c6a0: 2020 2020 4578 616d 706c 6573 0d0a 2020      Examples..  
+0000c6b0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0d0a        --------..
+0000c6c0: 2020 2020 2020 2020 3e3e 3e20 696d 706f          >>> impo
+0000c6d0: 7274 2066 7269 6e67 6573 2061 7320 6672  rt fringes as fr
+0000c6e0: 6e67 0d0a 2020 2020 2020 2020 3e3e 3e20  ng..        >>> 
+0000c6f0: 6620 3d20 6672 6e67 2e46 7269 6e67 6573  f = frng.Fringes
+0000c700: 2829 0d0a 2020 2020 2020 2020 3e3e 3e20  ()..        >>> 
+0000c710: 4920 3d20 662e 656e 636f 6465 2829 0d0a  I = f.encode()..
+0000c720: 0d0a 2020 2020 2020 2020 3e3e 3e20 412c  ..        >>> A,
+0000c730: 2042 2c20 7820 3d20 662e 6465 636f 6465   B, x = f.decode
+0000c740: 2849 290d 0a0d 0a20 2020 2020 2020 203e  (I)....        >
+0000c750: 3e3e 2041 2c20 422c 2078 2c20 702c 206b  >> A, B, x, p, k
+0000c760: 2c20 722c 2075 2c20 562c 2048 203d 2066  , r, u, V, H = f
+0000c770: 2e64 6563 6f64 6528 492c 2076 6572 626f  .decode(I, verbo
+0000c780: 7365 3d54 7275 6529 0d0a 2020 2020 2020  se=True)..      
+0000c790: 2020 2222 220d 0a0d 0a20 2020 2020 2020    """....       
+0000c7a0: 2074 3020 3d20 7469 6d65 2e70 6572 665f   t0 = time.perf_
+0000c7b0: 636f 756e 7465 7228 290d 0a0d 0a20 2020  counter()....   
+0000c7c0: 2020 2020 2023 2067 6574 2061 6e64 2061       # get and a
+0000c7d0: 7070 6c79 2076 6964 656f 7368 6170 650d  pply videoshape.
+0000c7e0: 0a20 2020 2020 2020 2054 2c20 592c 2058  .        T, Y, X
+0000c7f0: 2c20 4320 3d20 7673 6861 7065 2849 292e  , C = vshape(I).
+0000c800: 7368 6170 6520 2023 2065 7874 7261 6374  shape  # extract
+0000c810: 2059 2c20 582c 2043 2066 726f 6d20 6461   Y, X, C from da
+0000c820: 7461 2061 7320 7468 6573 6520 7061 7261  ta as these para
+0000c830: 6d65 7465 7273 2064 6570 656e 6420 6f6e  meters depend on
+0000c840: 2074 6865 2075 7365 6420 6361 6d65 7261   the used camera
+0000c850: 0d0a 2020 2020 2020 2020 4920 3d20 492e  ..        I = I.
+0000c860: 7265 7368 6170 6528 2854 2c20 592c 2058  reshape((T, Y, X
+0000c870: 2c20 4329 290d 0a0d 0a20 2020 2020 2020  , C))....       
+0000c880: 2023 2073 7562 7472 6163 7420 6461 726b   # subtract dark
+0000c890: 2073 6967 6e61 6c0d 0a20 2020 2020 2020   signal..       
+0000c8a0: 2069 6620 7365 6c66 2e79 3020 3e20 303a   if self.y0 > 0:
+0000c8b0: 0d0a 2020 2020 2020 2020 2020 2020 495b  ..            I[
+0000c8c0: 4920 3e3d 2073 656c 662e 7930 5d20 3d20  I >= self.y0] = 
+0000c8d0: 495b 4920 3e3d 2073 656c 662e 7930 5d20  I[I >= self.y0] 
+0000c8e0: 2d20 7365 6c66 2e79 300d 0a20 2020 2020  - self.y0..     
+0000c8f0: 2020 2020 2020 2049 5b49 203c 2073 656c         I[I < sel
+0000c900: 662e 7930 5d20 3d20 300d 0a0d 0a20 2020  f.y0] = 0....   
+0000c910: 2020 2020 2023 2064 6563 6f6c 6f72 697a       # decoloriz
+0000c920: 6520 2866 7573 6520 6875 6573 2f63 6f6c  e (fuse hues/col
+0000c930: 6f72 7329 205b 666f 7220 6772 6179 2066  ors) [for gray f
+0000c940: 7269 6e67 6573 2c20 636f 6c6f 7220 6675  ringes, color fu
+0000c950: 7369 6f6e 2069 7320 6e6f 7420 7065 7266  sion is not perf
+0000c960: 6f72 6d65 642c 2062 7574 2065 7874 656e  ormed, but exten
+0000c970: 6465 6420 6176 6572 6167 696e 6720 6973  ded averaging is
+0000c980: 5d0d 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+0000c990: 6c66 2e48 203e 2031 206f 7220 6e6f 7420  lf.H > 1 or not 
+0000c9a0: 7365 6c66 2e5f 6d6f 6e6f 6368 726f 6d65  self._monochrome
+0000c9b0: 3a0d 0a20 2020 2020 2020 2020 2020 2049  :..            I
+0000c9c0: 203d 2073 656c 662e 5f64 6563 6f6c 6f72   = self._decolor
+0000c9d0: 697a 6528 4929 0d0a 0d0a 2020 2020 2020  ize(I)....      
+0000c9e0: 2020 2320 6465 6d75 6c74 6970 6c65 780d    # demultiplex.
+0000c9f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000ca00: 2e53 444d 2061 6e64 2031 206e 6f74 2069  .SDM and 1 not i
+0000ca10: 6e20 7365 6c66 2e4e 206f 7220 7365 6c66  n self.N or self
+0000ca20: 2e57 444d 206f 7220 7365 6c66 2e46 444d  .WDM or self.FDM
+0000ca30: 3a0d 0a20 2020 2020 2020 2020 2020 2023  :..            #
+0000ca40: 2074 6f64 6f3a 2069 6620 7365 6c66 2e53   todo: if self.S
+0000ca50: 444d 2061 6e64 2031 2069 6e20 7365 6c66  DM and 1 in self
+0000ca60: 2e4e 3a20 466f 7572 6965 722d 7472 616e  .N: Fourier-tran
+0000ca70: 7366 6f72 6d20 6d65 7468 6f64 0d0a 2020  sform method..  
+0000ca80: 2020 2020 2020 2020 2020 4920 3d20 7365            I = se
+0000ca90: 6c66 2e5f 6465 6d75 6c74 6970 6c65 7828  lf._demultiplex(
+0000caa0: 4929 0d0a 0d0a 2020 2020 2020 2020 2320  I)....        # 
+0000cab0: 6465 6d6f 6475 6c61 7465 0d0a 2020 2020  demodulate..    
+0000cac0: 2020 2020 6272 692c 206d 6f64 2c20 7068      bri, mod, ph
+0000cad0: 692c 2072 6567 2c20 7265 7320 3d20 7365  i, reg, res = se
+0000cae0: 6c66 2e5f 6465 6d6f 6475 6c61 7465 2849  lf._demodulate(I
+0000caf0: 2c20 7665 7262 6f73 6529 0d0a 0d0a 2020  , verbose)....  
+0000cb00: 2020 2020 2020 2320 7665 7262 6f73 650d        # verbose.
+0000cb10: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000cb20: 2e76 6572 626f 7365 206f 7220 7665 7262  .verbose or verb
+0000cb30: 6f73 653a 0d0a 2020 2020 2020 2020 2020  ose:..          
+0000cb40: 2020 756e 632c 2066 6964 2c20 7669 732c    unc, fid, vis,
+0000cb50: 2065 7870 203d 2073 656c 662e 5f76 6572   exp = self._ver
+0000cb60: 626f 7365 5f28 492c 2062 7269 2c20 6d6f  bose_(I, bri, mo
+0000cb70: 642c 2072 6567 290d 0a0d 0a20 2020 2020  d, reg)....     
+0000cb80: 2020 2023 2062 6c61 636b 656e 2077 6865     # blacken whe
+0000cb90: 7265 2063 6f6c 6f72 2076 616c 7565 206f  re color value o
+0000cba0: 6620 6875 6520 7761 7320 626c 6163 6b0d  f hue was black.
+0000cbb0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000cbc0: 2e48 203e 2031 2061 6e64 2043 203d 3d20  .H > 1 and C == 
+0000cbd0: 333a 0d0a 2020 2020 2020 2020 2020 2020  3:..            
+0000cbe0: 6964 7820 3d20 6e70 2e73 756d 2873 656c  idx = np.sum(sel
+0000cbf0: 662e 682c 2061 7869 733d 3029 203d 3d20  f.h, axis=0) == 
+0000cc00: 300d 0a20 2020 2020 2020 2020 2020 2069  0..            i
+0000cc10: 6620 6e70 2e61 6e79 2869 6478 293a 2020  f np.any(idx):  
+0000cc20: 2320 626c 6163 6b65 6e20 7768 6572 6520  # blacken where 
+0000cc30: 636f 6c6f 7220 7661 6c75 6520 6f66 2068  color value of h
+0000cc40: 7565 2077 6173 2062 6c61 636b 0d0a 2020  ue was black..  
+0000cc50: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0000cc60: 695b 2e2e 2e2c 2069 6478 5d20 3d20 300d  i[..., idx] = 0.
+0000cc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cc80: 206d 6f64 5b2e 2e2e 2c20 6964 785d 203d   mod[..., idx] =
+0000cc90: 2030 0d0a 2020 2020 2020 2020 2020 2020   0..            
+0000cca0: 2020 2020 7265 675b 2e2e 2e2c 2069 6478      reg[..., idx
+0000ccb0: 5d20 3d20 6e70 2e6e 616e 0d0a 2020 2020  ] = np.nan..    
+0000ccc0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000ccd0: 656c 662e 7665 7262 6f73 653a 0d0a 2020  elf.verbose:..  
+0000cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ccf0: 2020 7265 735b 2e2e 2e2c 2069 6478 5d20    res[..., idx] 
+0000cd00: 3d20 6e70 2e6e 616e 0d0a 2020 2020 2020  = np.nan..      
+0000cd10: 2020 2020 2020 2020 2020 2020 2020 756e                un
+0000cd20: 635b 2e2e 2e2c 2069 6478 5d20 3d20 6e70  c[..., idx] = np
+0000cd30: 2e6e 616e 2020 2320 7365 6c66 2e52 202f  .nan  # self.R /
+0000cd40: 206e 702e 7371 7274 2831 3229 2020 2320   np.sqrt(12)  # 
+0000cd50: 746f 646f 3a20 6369 7263 756c 6172 2064  todo: circular d
+0000cd60: 6973 7472 6962 7574 696f 6e0d 0a20 2020  istribution..   
+0000cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd80: 2070 6869 5b2e 2e2e 2c20 6964 785d 203d   phi[..., idx] =
+0000cd90: 206e 702e 6e61 6e0d 0a20 2020 2020 2020   np.nan..       
+0000cda0: 2020 2020 2020 2020 2020 2020 2066 6964               fid
+0000cdb0: 5b2e 2e2e 2c20 6964 785d 203d 206e 702e  [..., idx] = np.
+0000cdc0: 6e61 6e0d 0a20 2020 2020 2020 2020 2020  nan..           
+0000cdd0: 2020 2020 2020 2020 2076 6973 5b2e 2e2e           vis[...
+0000cde0: 2c20 6964 785d 203d 2030 0d0a 2020 2020  , idx] = 0..    
+0000cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce00: 6578 705b 2e2e 2e2c 2069 6478 5d20 3d20  exp[..., idx] = 
+0000ce10: 300d 0a0d 0a20 2020 2020 2020 2023 2073  0....        # s
+0000ce20: 7061 7469 616c 2075 6e77 7261 7070 696e  patial unwrappin
+0000ce30: 670d 0a20 2020 2020 2020 2069 6620 7365  g..        if se
+0000ce40: 6c66 2e5f 616d 6269 6775 6f75 733a 0d0a  lf._ambiguous:..
+0000ce50: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000ce60: 696e 672e 7761 726e 696e 6728 2255 6e77  ing.warning("Unw
+0000ce70: 7261 7070 696e 6720 6973 206e 6f74 2073  rapping is not s
+0000ce80: 7061 7469 616c 6c79 2069 6e64 6570 656e  patially indepen
+0000ce90: 6465 6e74 2061 6e64 206f 6e6c 7920 7969  dent and only yi
+0000cea0: 656c 6473 2061 2072 656c 6174 6976 6520  elds a relative 
+0000ceb0: 7068 6173 6520 6d61 702e 2229 0d0a 2020  phase map.")..  
+0000cec0: 2020 2020 2020 2020 2020 7265 6720 3d20            reg = 
+0000ced0: 7365 6c66 2e5f 756e 7772 6170 2872 6567  self._unwrap(reg
+0000cee0: 2c20 6272 6929 2020 2320 746f 646f 3a20  , bri)  # todo: 
+0000cef0: 7265 7320 6966 2076 6572 626f 7365 0d0a  res if verbose..
+0000cf00: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
+0000cf10: 2063 6f6f 7264 6961 6e74 6520 7265 7472   coordiante retr
+0000cf20: 616e 7366 6f72 6d61 7469 6f6e 0d0a 2020  ansformation..  
+0000cf30: 2020 2020 2020 2020 2020 2320 746f 646f            # todo
+0000cf40: 3a20 7465 7374 730d 0a0d 0a20 2020 2020  : tests....     
+0000cf50: 2020 2020 2020 2069 6620 7365 6c66 2e44         if self.D
+0000cf60: 203d 3d20 323a 0d0a 2020 2020 2020 2020   == 2:..        
+0000cf70: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
+0000cf80: 7377 6170 6178 6573 0d0a 2020 2020 2020  swapaxes..      
+0000cf90: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0000cfa0: 662e 6772 6964 203d 3d20 2243 6172 7465  f.grid == "Carte
+0000cfb0: 7369 616e 223a 0d0a 2020 2020 2020 2020  sian":..        
+0000cfc0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000cfd0: 656c 662e 5820 3e3d 2073 656c 662e 593a  elf.X >= self.Y:
+0000cfe0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000cff0: 2020 2020 2020 2020 2020 7265 675b 305d            reg[0]
+0000d000: 202b 3d20 7365 6c66 2e58 202f 2032 202d   += self.X / 2 -
+0000d010: 2030 2e35 0d0a 2020 2020 2020 2020 2020   0.5..          
+0000d020: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000d030: 675b 305d 2025 3d20 7365 6c66 2e58 0d0a  g[0] %= self.X..
+0000d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d050: 2020 2020 2020 2020 7265 675b 315d 202a          reg[1] *
+0000d060: 3d20 2d31 0d0a 2020 2020 2020 2020 2020  = -1..          
+0000d070: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000d080: 675b 315d 202b 3d20 7365 6c66 2e59 202f  g[1] += self.Y /
+0000d090: 2032 202d 2030 2e35 0d0a 2020 2020 2020   2 - 0.5..      
+0000d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0b0: 2020 7265 675b 315d 2025 3d20 7365 6c66    reg[1] %= self
+0000d0c0: 2e58 0d0a 2020 2020 2020 2020 2020 2020  .X..            
+0000d0d0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+0000d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0f0: 2020 2020 2020 2072 6567 5b30 5d20 2b3d         reg[0] +=
+0000d100: 2073 656c 662e 5820 2f20 3220 2d20 302e   self.X / 2 - 0.
+0000d110: 350d 0a20 2020 2020 2020 2020 2020 2020  5..             
+0000d120: 2020 2020 2020 2020 2020 2072 6567 5b30             reg[0
+0000d130: 5d20 253d 2073 656c 662e 590d 0a20 2020  ] %= self.Y..   
+0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d150: 2020 2020 2072 6567 5b31 5d20 2a3d 202d       reg[1] *= -
+0000d160: 310d 0a20 2020 2020 2020 2020 2020 2020  1..             
+0000d170: 2020 2020 2020 2020 2020 2072 6567 5b31             reg[1
+0000d180: 5d20 2b3d 2073 656c 662e 5920 2f20 3220  ] += self.Y / 2 
+0000d190: 2d20 302e 350d 0a20 2020 2020 2020 2020  - 0.5..         
+0000d1a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000d1b0: 6567 5b31 5d20 253d 2073 656c 662e 590d  eg[1] %= self.Y.
+0000d1c0: 0a0d 0a20 2020 2020 2020 2020 2020 2020  ...             
+0000d1d0: 2020 2023 2074 6f64 6f3a 2070 6f6c 6172     # todo: polar
+0000d1e0: 2c20 6c6f 6770 6f6c 6172 0d0a 0d0a 2020  , logpolar....  
+0000d1f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000d200: 2073 656c 662e 616e 676c 6520 213d 2030   self.angle != 0
+0000d210: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0000d220: 2020 2020 2020 2074 203d 206e 702e 6465         t = np.de
+0000d230: 6732 7261 6428 2d73 656c 662e 616e 676c  g2rad(-self.angl
+0000d240: 6529 0d0a 0d0a 2020 2020 2020 2020 2020  e)....          
+0000d250: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0000d260: 662e 616e 676c 6520 2520 3930 203d 3d20  f.angle % 90 == 
+0000d270: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
+0000d280: 2020 2020 2020 2020 2020 2020 6320 3d20              c = 
+0000d290: 6e70 2e63 6f73 2874 290d 0a20 2020 2020  np.cos(t)..     
+0000d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2b0: 2020 2073 203d 206e 702e 7369 6e28 7429     s = np.sin(t)
+0000d2c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d2d0: 2020 2020 2020 2020 2020 5220 3d20 6e70            R = np
+0000d2e0: 2e61 7272 6179 285b 5b63 2c20 2d73 5d2c  .array([[c, -s],
+0000d2f0: 205b 732c 2063 5d5d 290d 0a20 2020 2020   [s, c]])..     
+0000d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d310: 2020 2023 2052 203d 206e 702e 6d61 7472     # R = np.matr
+0000d320: 6978 285b 5b63 2c20 2d73 5d2c 205b 732c  ix([[c, -s], [s,
+0000d330: 2063 5d5d 290d 0a20 2020 2020 2020 2020   c]])..         
+0000d340: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0000d350: 7220 3d20 525b 302c 2030 5d20 2a20 7265  r = R[0, 0] * re
+0000d360: 675b 305d 202b 2052 5b30 2c20 315d 202a  g[0] + R[0, 1] *
+0000d370: 2072 6567 5b31 5d0d 0a20 2020 2020 2020   reg[1]..       
+0000d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d390: 2076 7220 3d20 525b 312c 2030 5d20 2a20   vr = R[1, 0] * 
+0000d3a0: 7265 675b 305d 202b 2052 5b31 2c20 315d  reg[0] + R[1, 1]
+0000d3b0: 202a 2072 6567 5b32 5d0d 0a20 2020 2020   * reg[2]..     
+0000d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3d0: 2020 2023 2075 203d 206e 702e 646f 7428     # u = np.dot(
+0000d3e0: 7575 2c20 5229 2020 2320 746f 646f 3a20  uu, R)  # todo: 
+0000d3f0: 6d61 7472 6978 206d 756c 7469 706c 6963  matrix multiplic
+0000d400: 6174 696f 6e0d 0a20 2020 2020 2020 2020  ation..         
+0000d410: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000d420: 2076 203d 206e 702e 646f 7428 7676 2c20   v = np.dot(vv, 
+0000d430: 5229 0d0a 2020 2020 2020 2020 2020 2020  R)..            
+0000d440: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+0000d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d460: 2020 2020 2020 2074 616e 203d 206e 702e         tan = np.
+0000d470: 7461 6e28 7429 0d0a 2020 2020 2020 2020  tan(t)..        
+0000d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d490: 7572 203d 2072 6567 5b30 5d20 2d20 7265  ur = reg[0] - re
+0000d4a0: 675b 315d 202a 206e 702e 7461 6e28 7429  g[1] * np.tan(t)
+0000d4b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d4c0: 2020 2020 2020 2020 2020 7672 203d 2072            vr = r
+0000d4d0: 6567 5b30 5d20 2b20 7265 675b 315d 202f  eg[0] + reg[1] /
+0000d4e0: 206e 702e 7461 6e28 7429 0d0a 0d0a 2020   np.tan(t)....  
+0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d500: 2020 7676 203d 2028 7265 675b 315d 202d    vv = (reg[1] -
+0000d510: 2072 6567 5b30 5d29 202f 2028 3120 2f20   reg[0]) / (1 / 
+0000d520: 7461 6e20 2d20 7461 6e29 0d0a 2020 2020  tan - tan)..    
+0000d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d540: 7575 203d 2072 6567 5b30 5d20 2b20 7676  uu = reg[0] + vv
+0000d550: 202a 2074 616e 0d0a 2020 2020 2020 2020   * tan..        
+0000d560: 2020 2020 2020 2020 2020 2020 7265 6720              reg 
+0000d570: 3d20 6e70 2e73 7461 636b 2828 7575 2c20  = np.stack((uu, 
+0000d580: 7676 292c 2061 7869 733d 3029 0d0a 2020  vv), axis=0)..  
+0000d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5a0: 2020 7265 6720 3d20 6e70 2e73 7461 636b    reg = np.stack
+0000d5b0: 2828 7572 2c20 7672 292c 2061 7869 733d  ((ur, vr), axis=
+0000d5c0: 3029 0d0a 0d0a 2020 2020 2020 2020 6966  0)....        if
+0000d5d0: 2064 6573 7069 6b65 3a0d 0a20 2020 2020   despike:..     
+0000d5e0: 2020 2020 2020 2072 6567 203d 2073 702e         reg = sp.
+0000d5f0: 6e64 696d 6167 652e 6d65 6469 616e 5f66  ndimage.median_f
+0000d600: 696c 7465 7228 7265 672c 2073 697a 653d  ilter(reg, size=
+0000d610: 332c 206d 6f64 653d 226e 6561 7265 7374  3, mode="nearest
+0000d620: 222c 2061 7865 733d 2831 2c20 3229 290d  ", axes=(1, 2)).
+0000d630: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+0000d640: 6f64 6f3a 2064 6573 7069 6b65 2061 6c6c  odo: despike all
+0000d650: 2063 6861 6e6e 656c 730d 0a0d 0a20 2020   channels....   
+0000d660: 2020 2020 2020 2020 2023 2072 6567 5b3a           # reg[:
+0000d670: 2c20 2d31 2c20 2d31 2c20 2e2e 2e5d 203d  , -1, -1, ...] =
+0000d680: 2030 0d0a 2020 2020 2020 2020 2020 2020   0..            
+0000d690: 2320 7265 675b 3a2c 202d 3130 2c20 2d31  # reg[:, -10, -1
+0000d6a0: 302c 202e 2e2e 5d20 3d20 300d 0a20 2020  0, ...] = 0..   
+0000d6b0: 2020 2020 2020 2020 2023 2070 6f69 6e74           # point
+0000d6c0: 7320 3d20 6e70 2e61 7261 6e67 6528 5929  s = np.arange(Y)
+0000d6d0: 2c20 6e70 2e61 7261 6e67 6528 5829 0d0a  , np.arange(X)..
+0000d6e0: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
+0000d6f0: 7220 6420 696e 2072 616e 6765 2873 656c  r d in range(sel
+0000d700: 662e 4429 3a0d 0a20 2020 2020 2020 2020  f.D):..         
+0000d710: 2020 2023 2020 2020 2066 6f72 2063 2069     #     for c i
+0000d720: 6e20 7261 6e67 6528 4329 3a0d 0a20 2020  n range(C):..   
+0000d730: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+0000d740: 2020 2073 7069 6b65 7320 3d20 6e70 2e61     spikes = np.a
+0000d750: 6273 2872 6567 5b64 2c20 3a2c 203a 2c20  bs(reg[d, :, :, 
+0000d760: 635d 202d 206d 6564 6961 6e28 7265 675b  c] - median(reg[
+0000d770: 642c 203a 2c20 3a2c 2063 5d29 5b30 2c20  d, :, :, c])[0, 
+0000d780: 3a2c 203a 2c20 305d 2920 3e20 6e70 2e73  :, :, 0]) > np.s
+0000d790: 7464 2872 6567 5b64 2c20 3a2c 203a 2c20  td(reg[d, :, :, 
+0000d7a0: 635d 2920 2023 2062 696c 6174 6572 616c  c])  # bilateral
+0000d7b0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000d7c0: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
+0000d7d0: 2072 6567 5b64 2c20 3a2c 203a 2c20 635d   reg[d, :, :, c]
+0000d7e0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000d7f0: 2020 2020 2020 2020 7869 203d 206e 702e          xi = np.
+0000d800: 6e6f 6e7a 6572 6f28 7370 696b 6573 290d  nonzero(spikes).
+0000d810: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0000d820: 2020 2020 2020 2076 616c 7565 735b 7869         values[xi
+0000d830: 5d20 3d20 300d 0a20 2020 2020 2020 2020  ] = 0..         
+0000d840: 2020 2023 2020 2020 2020 2020 2078 6920     #         xi 
+0000d850: 3d20 6e70 2e61 7267 7768 6572 6528 7370  = np.argwhere(sp
+0000d860: 696b 6573 290d 0a20 2020 2020 2020 2020  ikes)..         
+0000d870: 2020 2023 2020 2020 2020 2020 2061 203d     #         a =
+0000d880: 2073 702e 696e 7465 7270 6f6c 6174 652e   sp.interpolate.
+0000d890: 696e 7465 7270 6e28 706f 696e 7473 2c20  interpn(points, 
+0000d8a0: 7661 6c75 6573 2c20 7869 2c20 6d65 7468  values, xi, meth
+0000d8b0: 6f64 3d22 6375 6269 6322 290d 0a20 2020  od="cubic")..   
+0000d8c0: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+0000d8d0: 2020 2072 6567 5b64 5d20 3d20 7370 2e69     reg[d] = sp.i
+0000d8e0: 6e74 6572 706f 6c61 7465 2e69 6e74 6572  nterpolate.inter
+0000d8f0: 706e 2870 6f69 6e74 732c 2076 616c 7565  pn(points, value
+0000d900: 732c 2078 692c 206d 6574 686f 643d 2263  s, xi, method="c
+0000d910: 7562 6963 2229 0d0a 0d0a 2020 2020 2020  ubic")....      
+0000d920: 2020 6966 2064 656e 6f69 7365 3a0d 0a20    if denoise:.. 
+0000d930: 2020 2020 2020 2020 2020 2023 2023 2062             # # b
+0000d940: 6c75 7272 696e 6720 6475 6520 746f 2075  lurring due to u
+0000d950: 6e63 6572 7461 696e 7479 2061 6e64 2050  ncertainty and P
+0000d960: 5346 0d0a 2020 2020 2020 2020 2020 2020  SF..            
+0000d970: 2320 7520 3d20 7365 6c66 2e75 2069 6620  # u = self.u if 
+0000d980: 7365 6c66 2e69 6e64 6578 696e 6720 3d3d  self.indexing ==
+0000d990: 2022 696a 2220 656c 7365 2073 656c 662e   "ij" else self.
+0000d9a0: 755b 3a3a 2d31 5d20 2023 2074 6f64 6f3a  u[::-1]  # todo:
+0000d9b0: 2044 203d 2031 2c20 692e 652e 2073 6861   D = 1, i.e. sha
+0000d9c0: 7065 206f 6620 7369 676d 6120 6571 7561  pe of sigma equa
+0000d9d0: 6c20 746f 2061 7865 733f 0d0a 2020 2020  l to axes?..    
+0000d9e0: 2020 2020 2020 2020 2320 7369 676d 6120          # sigma 
+0000d9f0: 3d20 6e70 2e73 7172 7428 7520 2a2a 2032  = np.sqrt(u ** 2
+0000da00: 202b 2073 656c 662e 5053 4620 2a2a 2032   + self.PSF ** 2
+0000da10: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000da20: 2072 6567 203d 2073 702e 6e64 696d 6167   reg = sp.ndimag
+0000da30: 652e 6761 7573 7369 616e 5f66 696c 7465  e.gaussian_filte
+0000da40: 7228 7265 672c 2073 6967 6d61 2c20 6d6f  r(reg, sigma, mo
+0000da50: 6465 3d27 6e65 6172 6573 7427 2c20 6178  de='nearest', ax
+0000da60: 6573 3d28 312c 2032 2929 0d0a 2020 2020  es=(1, 2))..    
+0000da70: 2020 2020 2020 2020 7265 6720 3d20 6269          reg = bi
+0000da80: 6c61 7465 7261 6c28 7265 672c 206b 3d33  lateral(reg, k=3
+0000da90: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000daa0: 2074 6f64 6f3a 2064 656e 6f69 7365 2061   todo: denoise a
+0000dab0: 6c6c 2063 6861 6e6e 656c 730d 0a0d 0a20  ll channels.... 
+0000dac0: 2020 2020 2020 2023 2063 7265 6174 6520         # create 
+0000dad0: 6e61 6d65 6420 7475 706c 6520 746f 2072  named tuple to r
+0000dae0: 6574 7572 6e0d 0a20 2020 2020 2020 2069  eturn..        i
+0000daf0: 6620 7365 6c66 2e76 6572 626f 7365 206f  f self.verbose o
+0000db00: 7220 7665 7262 6f73 653a 0d0a 2020 2020  r verbose:..    
+0000db10: 2020 2020 2020 2020 6465 6320 3d20 6e61          dec = na
+0000db20: 6d65 6474 7570 6c65 280d 0a20 2020 2020  medtuple(..     
+0000db30: 2020 2020 2020 2020 2020 2022 6465 636f             "deco
+0000db40: 6465 6422 2c0d 0a20 2020 2020 2020 2020  ded",..         
+0000db50: 2020 2020 2020 2022 6272 6967 6874 6e65         "brightne
+0000db60: 7373 206d 6f64 756c 6174 696f 6e20 7265  ss modulation re
+0000db70: 6769 7374 7261 7469 6f6e 2072 6573 6964  gistration resid
+0000db80: 7561 6c73 2075 6e63 6572 7461 696e 7479  uals uncertainty
+0000db90: 2070 6861 7365 206f 7264 6572 7320 7669   phase orders vi
+0000dba0: 7369 6269 6c69 7479 2065 7870 6f73 7572  sibility exposur
+0000dbb0: 6522 2c0d 0a20 2020 2020 2020 2020 2020  e",..           
+0000dbc0: 2029 2862 7269 2c20 6d6f 642c 2072 6567   )(bri, mod, reg
+0000dbd0: 2c20 7265 732c 2075 6e63 2c20 7068 692c  , res, unc, phi,
+0000dbe0: 2066 6964 2c20 7669 732c 2065 7870 290d   fid, vis, exp).
+0000dbf0: 0a20 2020 2020 2020 2065 6c73 653a 0d0a  .        else:..
+0000dc00: 2020 2020 2020 2020 2020 2020 6465 6320              dec 
+0000dc10: 3d20 6e61 6d65 6474 7570 6c65 2822 6465  = namedtuple("de
+0000dc20: 636f 6465 6422 2c20 2262 7269 6768 746e  coded", "brightn
+0000dc30: 6573 7320 6d6f 6475 6c61 7469 6f6e 2072  ess modulation r
+0000dc40: 6567 6973 7472 6174 696f 6e22 2928 6272  egistration")(br
+0000dc50: 692c 206d 6f64 2c20 7265 6729 0d0a 0d0a  i, mod, reg)....
+0000dc60: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000dc70: 696e 666f 2866 227b 3130 3030 202a 2028  info(f"{1000 * (
+0000dc80: 7469 6d65 2e70 6572 665f 636f 756e 7465  time.perf_counte
+0000dc90: 7228 2920 2d20 7430 297d 6d73 2229 0d0a  r() - t0)}ms")..
+0000dca0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000dcb0: 2064 6563 0d0a 0d0a 2020 2020 6465 6620   dec....    def 
+0000dcc0: 5f76 6572 626f 7365 5f28 7365 6c66 2c20  _verbose_(self, 
+0000dcd0: 493a 206e 702e 6e64 6172 7261 792c 2041  I: np.ndarray, A
+0000dce0: 3a20 6e70 2e6e 6461 7272 6179 2c20 423a  : np.ndarray, B:
+0000dcf0: 206e 702e 6e64 6172 7261 792c 2078 693a   np.ndarray, xi:
+0000dd00: 206e 702e 6e64 6172 7261 792c 206c 6573   np.ndarray, les
+0000dd10: 7362 6974 733a 2062 6f6f 6c20 3d20 4661  sbits: bool = Fa
+0000dd20: 6c73 6529 3a0d 0a20 2020 2020 2020 2022  lse):..        "
+0000dd30: 2222 436f 6d70 7574 6520 7665 7262 6f73  ""Compute verbos
+0000dd40: 6520 6f75 7470 7574 2e0d 0a0d 0a20 2020  e output.....   
+0000dd50: 2020 2020 2050 6172 616d 6574 6572 730d       Parameters.
+0000dd60: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0000dd70: 2d2d 2d0d 0a20 2020 2020 2020 2049 203a  ---..        I :
+0000dd80: 206e 702e 6e64 6172 7261 790d 0a20 2020   np.ndarray..   
+0000dd90: 2020 2020 2020 2020 2046 7269 6e67 6520           Fringe 
+0000dda0: 7061 7474 6572 6e20 7365 7175 656e 6365  pattern sequence
+0000ddb0: 2e0d 0a0d 0a20 2020 2020 2020 2041 203a  .....        A :
+0000ddc0: 206e 702e 6e64 6172 7261 790d 0a20 2020   np.ndarray..   
+0000ddd0: 2020 2020 2020 2020 2042 7269 6768 746e           Brightn
+0000dde0: 6573 732e 0d0a 0d0a 2020 2020 2020 2020  ess.....        
+0000ddf0: 4220 3a20 6e70 2e6e 6461 7272 6179 0d0a  B : np.ndarray..
+0000de00: 2020 2020 2020 2020 2020 2020 4d6f 6475              Modu
+0000de10: 6c61 7469 6f6e 2e0d 0a0d 0a20 2020 2020  lation.....     
+0000de20: 2020 2078 6920 3a20 6e70 2e6e 6461 7272     xi : np.ndarr
+0000de30: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
+0000de40: 5265 6769 7374 7261 7469 6f6e 2e0d 0a0d  Registration....
+0000de50: 0a20 2020 2020 2020 206c 6573 7362 6974  .        lessbit
+0000de60: 7320 3a20 626f 6f6c 2c20 6f70 7469 6f6e  s : bool, option
+0000de70: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
+0000de80: 5468 6520 6672 696e 6765 2070 6174 7465  The fringe patte
+0000de90: 726e 2073 6571 7565 6e63 6520 2749 2720  rn sequence 'I' 
+0000dea0: 6d61 7920 636f 6e74 6169 6e20 6665 7765  may contain fewe
+0000deb0: 7220 6269 7473 206f 6620 696e 666f 726d  r bits of inform
+0000dec0: 6174 696f 6e20 7468 616e 2069 7473 2063  ation than its c
+0000ded0: 6f72 7265 7370 6f6e 6469 6e67 2064 7479  orresponding dty
+0000dee0: 7065 2e0d 0a20 2020 2020 2020 2020 2020  pe...           
+0000def0: 2054 6869 7320 6f63 6375 7273 2069 6620   This occurs if 
+0000df00: 652e 672e 2061 2031 3020 6f72 2031 3220  e.g. a 10 or 12 
+0000df10: 6269 7420 6361 6d65 7261 2069 7320 7573  bit camera is us
+0000df20: 6564 2c20 666f 7220 7768 6963 6820 7468  ed, for which th
+0000df30: 6520 636f 7272 6573 706f 6e64 696e 6720  e corresponding 
+0000df40: 6474 7970 6520 776f 756c 6420 6265 2027  dtype would be '
+0000df50: 7569 6e74 3136 272e 0d0a 2020 2020 2020  uint16'...      
+0000df60: 2020 2020 2020 4966 2027 6c65 7373 6269        If 'lessbi
+0000df70: 7473 2720 6973 2054 7275 652c 2074 6865  ts' is True, the
+0000df80: 206e 756d 6265 7220 6f66 2062 6974 7320   number of bits 
+0000df90: 6973 2065 7374 696d 6174 6564 2062 6173  is estimated bas
+0000dfa0: 6564 206f 6e20 7468 6520 6d61 7869 6d61  ed on the maxima
+0000dfb0: 6c20 7661 6c75 6520 6f66 2027 4927 2e0d  l value of 'I'..
+0000dfc0: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
+0000dfd0: 7320 6166 6665 6374 7320 7468 6520 7661  s affects the va
+0000dfe0: 6c75 6520 6f66 2074 6865 2065 7870 6f73  lue of the expos
+0000dff0: 7572 6520 2765 272e 0d0a 0d0a 2020 2020  ure 'e'.....    
+0000e000: 2020 2020 5265 7475 726e 730d 0a20 2020      Returns..   
+0000e010: 2020 2020 202d 2d2d 2d2d 2d2d 0d0a 2020       -------..  
+0000e020: 2020 2020 2020 7520 3a20 6e70 2e6e 6461        u : np.nda
+0000e030: 7272 6179 0d0a 2020 2020 2020 2020 2020  rray..          
+0000e040: 2020 556e 6365 7274 6169 6e74 7920 6f66    Uncertainty of
+0000e050: 2070 6f73 6974 696f 6e61 6c20 6465 636f   positional deco
+0000e060: 6469 6e67 2c20 696e 2070 6978 656c 2075  ding, in pixel u
+0000e070: 6e69 7473 2e0d 0a0d 0a20 2020 2020 2020  nits.....       
+0000e080: 206b 203a 206e 702e 6e64 6172 7261 790d   k : np.ndarray.
+0000e090: 0a20 2020 2020 2020 2020 2020 2046 7269  .            Fri
+0000e0a0: 6e67 6520 6f72 6465 7273 2e0d 0a0d 0a20  nge orders..... 
+0000e0b0: 2020 2020 2020 2056 203a 206e 702e 6e64         V : np.nd
+0000e0c0: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
+0000e0d0: 2020 2056 6973 6962 696c 6974 7920 2866     Visibility (f
+0000e0e0: 7269 6e67 6520 636f 6e74 7261 7374 292e  ringe contrast).
+0000e0f0: 0d0a 0d0a 2020 2020 2020 2020 6520 3a20  ....        e : 
+0000e100: 6e70 2e6e 6461 7272 6179 0d0a 2020 2020  np.ndarray..    
+0000e110: 2020 2020 2020 2020 4578 706f 7375 7265          Exposure
+0000e120: 2028 7265 6c61 7469 7665 2061 7665 7261   (relative avera
+0000e130: 6765 2069 6e74 656e 7369 7479 292e 0d0a  ge intensity)...
+0000e140: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
+0000e150: 2020 2020 2020 2059 2c20 582c 2043 203d         Y, X, C =
+0000e160: 2041 2e73 6861 7065 5b31 3a5d 0d0a 0d0a   A.shape[1:]....
+0000e170: 2020 2020 2020 2020 6461 726b 203d 2073          dark = s
+0000e180: 656c 662e 6761 696e 202a 2073 656c 662e  elf.gain * self.
+0000e190: 6461 726b 0d0a 2020 2020 2020 2020 7175  dark..        qu
+0000e1a0: 616e 7420 3d20 3020 6966 2073 656c 662e  ant = 0 if self.
+0000e1b0: 6461 726b 203e 2030 2065 6c73 6520 7365  dark > 0 else se
+0000e1c0: 6c66 2e71 7561 6e74 0d0a 2020 2020 2020  lf.quant..      
+0000e1d0: 2020 7368 6f74 203d 2028 0d0a 2020 2020    shot = (..    
+0000e1e0: 2020 2020 2020 2020 6e70 2e73 7172 7428          np.sqrt(
+0000e1f0: 7365 6c66 2e67 6169 6e20 2a20 6e70 2e6d  self.gain * np.m
+0000e200: 6178 696d 756d 2830 2c20 4120 2d20 7365  aximum(0, A - se
+0000e210: 6c66 2e79 3029 2920 6966 2073 656c 662e  lf.y0)) if self.
+0000e220: 6761 696e 2021 3d20 3020 656c 7365 206e  gain != 0 else n
+0000e230: 702e 7a65 726f 735f 6c69 6b65 2841 290d  p.zeros_like(A).
+0000e240: 0a20 2020 2020 2020 2029 2020 2320 6176  .        )  # av
+0000e250: 6572 6167 6520 696e 7465 6e73 6974 7920  erage intensity 
+0000e260: 3d20 6272 6967 6874 6e65 7373 0d0a 2020  = brightness..  
+0000e270: 2020 2020 2020 7569 203d 206e 702e 7371        ui = np.sq
+0000e280: 7274 2864 6172 6b2a 2a32 202b 2071 7561  rt(dark**2 + qua
+0000e290: 6e74 2a2a 3220 2b20 7368 6f74 2a2a 3229  nt**2 + shot**2)
+0000e2a0: 2020 2320 696e 7465 6e73 6974 7920 6e6f    # intensity no
+0000e2b0: 6973 650d 0a20 2020 2020 2020 2075 7069  ise..        upi
+0000e2c0: 203d 2028 0d0a 2020 2020 2020 2020 2020   = (..          
+0000e2d0: 2020 6e70 2e73 7172 7428 3229 0d0a 2020    np.sqrt(2)..  
+0000e2e0: 2020 2020 2020 2020 2020 2f20 6e70 2e73            / np.s
+0000e2f0: 7172 7428 7365 6c66 2e4d 290d 0a20 2020  qrt(self.M)..   
+0000e300: 2020 2020 2020 2020 202f 206e 702e 7371           / np.sq
+0000e310: 7274 2873 656c 662e 5f4e 5b3a 2c20 3a2c  rt(self._N[:, :,
+0000e320: 204e 6f6e 652c 204e 6f6e 652c 204e 6f6e   None, None, Non
+0000e330: 655d 290d 0a20 2020 2020 2020 2020 2020  e])..           
+0000e340: 202f 2042 2e72 6573 6861 7065 2873 656c   / B.reshape(sel
+0000e350: 662e 442c 2073 656c 662e 4b2c 2059 2c20  f.D, self.K, Y, 
+0000e360: 582c 2043 290d 0a20 2020 2020 2020 2020  X, C)..         
+0000e370: 2020 202a 2075 695b 3a2c 204e 6f6e 652c     * ui[:, None,
+0000e380: 203a 2c20 3a5d 0d0a 2020 2020 2020 2020   :, :]..        
+0000e390: 2920 2023 206c 6f63 616c 2070 6861 7365  )  # local phase
+0000e3a0: 2075 6e63 6572 7461 696e 7469 6573 2020   uncertainties  
+0000e3b0: 2320 746f 646f 3a20 4d0d 0a20 2020 2020  # todo: M..     
+0000e3c0: 2020 2075 7869 203d 2075 7069 202f 2028     uxi = upi / (
+0000e3d0: 3220 2a20 6e70 2e70 6929 202a 2073 656c  2 * np.pi) * sel
+0000e3e0: 662e 5f6c 5b3a 2c20 3a2c 204e 6f6e 652c  f._l[:, :, None,
+0000e3f0: 204e 6f6e 652c 204e 6f6e 655d 2020 2320   None, None]  # 
+0000e400: 6c6f 6361 6c20 706f 7369 7469 6f6e 616c  local positional
+0000e410: 2075 6e63 6572 7461 696e 7469 6573 0d0a   uncertainties..
+0000e420: 2020 2020 2020 2020 7520 3d20 6e70 2e73          u = np.s
+0000e430: 7172 7428 3120 2f20 6e70 2e73 756d 2831  qrt(1 / np.sum(1
+0000e440: 202f 2075 7869 2a2a 322c 2061 7869 733d   / uxi**2, axis=
+0000e450: 3129 2920 2023 2067 6c6f 6261 6c20 706f  1))  # global po
+0000e460: 7369 7469 6f6e 616c 2075 6e63 6572 7461  sitional uncerta
+0000e470: 696e 7479 0d0a 2020 2020 2020 2020 7520  inty..        u 
+0000e480: 3d20 752e 6173 7479 7065 286e 702e 666c  = u.astype(np.fl
+0000e490: 6f61 7433 322c 2063 6f70 793d 4661 6c73  oat32, copy=Fals
+0000e4a0: 6529 0d0a 0d0a 2020 2020 2020 2020 6b20  e)....        k 
+0000e4b0: 3d20 7869 5b3a 2c20 4e6f 6e65 2c20 3a2c  = xi[:, None, :,
+0000e4c0: 203a 2c20 3a5d 202f 2f20 7365 6c66 2e5f   :, :] // self._
+0000e4d0: 6c5b 3a2c 203a 2c20 4e6f 6e65 2c20 4e6f  l[:, :, None, No
+0000e4e0: 6e65 2c20 4e6f 6e65 5d0d 0a20 2020 2020  ne, None]..     
+0000e4f0: 2020 2023 2070 203d 2028 7869 5b3a 2c20     # p = (xi[:, 
+0000e500: 4e6f 6e65 2c20 3a2c 203a 2c20 3a5d 202f  None, :, :, :] /
+0000e510: 2073 656c 662e 5f6c 5b3a 2c20 3a2c 204e   self._l[:, :, N
+0000e520: 6f6e 652c 204e 6f6e 652c 204e 6f6e 655d  one, None, None]
+0000e530: 202d 206b 2920 2a20 3220 2a20 6e70 2e70   - k) * 2 * np.p
+0000e540: 6920 2d20 7365 6c66 2e70 300d 0a20 2020  i - self.p0..   
+0000e550: 2020 2020 206b 203d 206b 2e61 7374 7970       k = k.astyp
+0000e560: 6528 696e 742c 2063 6f70 793d 4661 6c73  e(int, copy=Fals
+0000e570: 6529 2e72 6573 6861 7065 2873 656c 662e  e).reshape(self.
+0000e580: 4420 2a20 7365 6c66 2e4b 2c20 592c 2058  D * self.K, Y, X
+0000e590: 2c20 4329 0d0a 2020 2020 2020 2020 2320  , C)..        # 
+0000e5a0: 7020 3d20 702e 6173 7479 7065 286e 702e  p = p.astype(np.
+0000e5b0: 666c 6f61 7433 322c 2063 6f70 793d 4661  float32, copy=Fa
+0000e5c0: 6c73 6529 2e72 6573 6861 7065 2873 656c  lse).reshape(sel
+0000e5d0: 662e 4420 2a20 7365 6c66 2e4b 2c20 592c  f.D * self.K, Y,
+0000e5e0: 2058 2c20 4329 0d0a 0d0a 2020 2020 2020   X, C)....      
+0000e5f0: 2020 5620 3d20 422e 7265 7368 6170 6528    V = B.reshape(
+0000e600: 7365 6c66 2e44 2c20 7365 6c66 2e4b 2c20  self.D, self.K, 
+0000e610: 592c 2058 2c20 4329 202f 206e 702e 6d61  Y, X, C) / np.ma
+0000e620: 7869 6d75 6d28 0d0a 2020 2020 2020 2020  ximum(..        
+0000e630: 2020 2020 415b 3a2c 204e 6f6e 652c 203a      A[:, None, :
+0000e640: 2c20 3a2c 203a 5d2c 206e 702e 6669 6e66  , :, :], np.finf
+0000e650: 6f28 6e70 2e66 6c6f 6174 5f29 2e65 7073  o(np.float_).eps
+0000e660: 0d0a 2020 2020 2020 2020 2920 2023 2061  ..        )  # a
+0000e670: 766f 6964 2064 6976 6973 696f 6e20 6279  void division by
+0000e680: 207a 6572 6f0d 0a20 2020 2020 2020 2056   zero..        V
+0000e690: 203d 2056 2e61 7374 7970 6528 6e70 2e66   = V.astype(np.f
+0000e6a0: 6c6f 6174 3332 2c20 636f 7079 3d46 616c  loat32, copy=Fal
+0000e6b0: 7365 292e 7265 7368 6170 6528 7365 6c66  se).reshape(self
+0000e6c0: 2e44 202a 2073 656c 662e 4b2c 2059 2c20  .D * self.K, Y, 
+0000e6d0: 582c 2043 290d 0a0d 0a20 2020 2020 2020  X, C)....       
+0000e6e0: 2069 6620 492e 6474 7970 652e 6b69 6e64   if I.dtype.kind
+0000e6f0: 2069 6e20 2275 6922 3a0d 0a20 2020 2020   in "ui":..     
+0000e700: 2020 2020 2020 2069 6620 6c65 7373 6269         if lessbi
+0000e710: 7473 2061 6e64 206e 702e 6969 6e66 6f28  ts and np.iinfo(
+0000e720: 492e 6474 7970 6529 2e62 6974 7320 3e20  I.dtype).bits > 
+0000e730: 383a 2020 2320 6461 7461 206d 6179 2063  8:  # data may c
+0000e740: 6f6e 7461 696e 2066 6577 6572 2062 6974  ontain fewer bit
+0000e750: 7320 6f66 2069 6e66 6f72 6d61 7469 6f6e  s of information
+0000e760: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e770: 2020 496d 6178 203d 2069 6e74 286e 702e    Imax = int(np.
+0000e780: 6365 696c 286e 702e 6c6f 6732 2849 2e6d  ceil(np.log2(I.m
+0000e790: 6178 2829 2929 2920 2023 2073 616d 6520  ax())))  # same 
+0000e7a0: 6f72 206e 6578 7420 706f 7765 7220 6f66  or next power of
+0000e7b0: 2074 776f 0d0a 2020 2020 2020 2020 2020   two..          
+0000e7c0: 2020 2020 2020 496d 6178 202b 3d20 2d49        Imax += -I
+0000e7d0: 6d61 7820 2520 3220 2023 2073 616d 6520  max % 2  # same 
+0000e7e0: 6f72 206e 6578 7420 706f 7765 7220 6f66  or next power of
+0000e7f0: 2074 776f 2064 6976 6973 6962 6c65 2062   two divisible b
+0000e800: 7920 7477 6f0d 0a20 2020 2020 2020 2020  y two..         
+0000e810: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+0000e820: 2020 2020 2020 2020 2020 496d 6178 203d            Imax =
+0000e830: 206e 702e 6969 6e66 6f28 492e 6474 7970   np.iinfo(I.dtyp
+0000e840: 6529 2e6d 6178 0d0a 2020 2020 2020 2020  e).max..        
+0000e850: 656c 7365 3a20 2023 2066 6c6f 6174 0d0a  else:  # float..
+0000e860: 2020 2020 2020 2020 2020 2020 496d 6178              Imax
+0000e870: 203d 2031 0d0a 2020 2020 2020 2020 6520   = 1..        e 
+0000e880: 3d20 4120 2f20 496d 6178 0d0a 2020 2020  = A / Imax..    
+0000e890: 2020 2020 6520 3d20 652e 6173 7479 7065      e = e.astype
+0000e8a0: 286e 702e 666c 6f61 7433 322c 2063 6f70  (np.float32, cop
+0000e8b0: 793d 4661 6c73 6529 0d0a 0d0a 2020 2020  y=False)....    
+0000e8c0: 2020 2020 7265 7475 726e 2075 2c20 6b2c      return u, k,
+0000e8d0: 2056 2c20 650d 0a0d 0a20 2020 2064 6566   V, e....    def
+0000e8e0: 205f 756e 7772 6170 280d 0a20 2020 2020   _unwrap(..     
+0000e8f0: 2020 2073 656c 662c 2070 6869 3a20 6e70     self, phi: np
+0000e900: 2e6e 6461 7272 6179 2c20 423a 206e 702e  .ndarray, B: np.
+0000e910: 6e64 6172 7261 792c 2066 756e 633a 2073  ndarray, func: s
+0000e920: 7472 203d 2022 736b 6922 0d0a 2020 2020  tr = "ski"..    
+0000e930: 2920 2d3e 2028 6e70 2e6e 6461 7272 6179  ) -> (np.ndarray
+0000e940: 2c20 6e70 2e6e 6461 7272 6179 293a 2020  , np.ndarray):  
+0000e950: 2320 746f 646f 3a20 7573 6520 4220 666f  # todo: use B fo
+0000e960: 7220 7175 616c 6974 7920 6775 6964 616e  r quality guidan
+0000e970: 6365 0d0a 2020 2020 2020 2020 2222 2255  ce..        """U
+0000e980: 6e77 7261 7020 7068 6173 6520 6d61 7073  nwrap phase maps
+0000e990: 2073 7061 6369 616c 6c79 2e0d 0a0d 0a20   spacially..... 
+0000e9a0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+0000e9b0: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
+0000e9c0: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2070  -----..        p
+0000e9d0: 6869 203a 206e 702e 6e64 6172 7261 790d  hi : np.ndarray.
+0000e9e0: 0a20 2020 2020 2020 2020 2020 2050 6861  .            Pha
+0000e9f0: 7365 206d 6170 7320 746f 2075 6e77 7261  se maps to unwra
+0000ea00: 7020 7370 6174 6961 6c6c 792c 2073 7461  p spatially, sta
+0000ea10: 636b 6564 2061 6c6f 6e67 2074 6865 2066  cked along the f
+0000ea20: 6972 7374 2064 696d 656e 7369 6f6e 2e0d  irst dimension..
+0000ea30: 0a20 2020 2020 2020 2020 2020 2049 7420  .            It 
+0000ea40: 6973 2072 6573 6861 7065 6420 746f 2076  is reshaped to v
+0000ea50: 6964 656f 7368 6170 6520 2866 7261 6d65  ideoshape (frame
+0000ea60: 7320 6054 602c 2068 6569 6768 7420 6059  s `T`, height `Y
+0000ea70: 602c 2077 6964 7468 2060 5860 2c20 636f  `, width `X`, co
+0000ea80: 6c6f 7220 6368 616e 6e65 6c73 2060 4360  lor channels `C`
+0000ea90: 2920 6265 666f 7265 2070 726f 6365 7373  ) before process
+0000eaa0: 696e 672e 0d0a 2020 2020 2020 2020 2020  ing...          
+0000eab0: 2020 5468 6520 6672 616d 6573 2028 6669    The frames (fi
+0000eac0: 7273 7420 6469 6d65 6e73 696f 6e29 2061  rst dimension) a
+0000ead0: 7320 7765 6c6c 2074 6865 2063 6f6c 6f72  s well the color
+0000eae0: 2063 6861 6e6e 656c 7320 286c 6173 7420   channels (last 
+0000eaf0: 6469 6d65 6e73 696f 6e29 0d0a 2020 2020  dimension)..    
+0000eb00: 2020 2020 2020 2020 6172 6520 756e 7772          are unwr
+0000eb10: 6170 7065 6420 7365 7061 7261 7465 6c79  apped separately
+0000eb20: 2e0d 0a0d 0a20 2020 2020 2020 2042 203a  .....        B :
+0000eb30: 206e 702e 6e64 6172 7261 792c 206f 7074   np.ndarray, opt
+0000eb40: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
+0000eb50: 2020 204d 6f64 756c 6174 696f 6e20 6f66     Modulation of
+0000eb60: 2074 6865 2064 6563 6f64 6564 2070 6861   the decoded pha
+0000eb70: 7365 2e0d 0a20 2020 2020 2020 2020 2020  se...           
+0000eb80: 2049 7420 6973 2072 6573 6861 7065 6420   It is reshaped 
+0000eb90: 746f 2076 6964 656f 7368 6170 6520 2866  to videoshape (f
+0000eba0: 7261 6d65 7320 6054 602c 2068 6569 6768  rames `T`, heigh
+0000ebb0: 7420 6059 602c 2077 6964 7468 2060 5860  t `Y`, width `X`
+0000ebc0: 2c20 636f 6c6f 7220 6368 616e 6e65 6c73  , color channels
+0000ebd0: 2060 4360 2920 6265 666f 7265 2070 726f   `C`) before pro
+0000ebe0: 6365 7373 696e 672e 0d0a 0d0a 2020 2020  cessing.....    
+0000ebf0: 2020 2020 6675 6e63 203a 2073 7472 2c20      func : str, 
+0000ec00: 6f70 7469 6f6e 616c 0d0a 2020 2020 2020  optional..      
+0000ec10: 2020 2020 2020 556e 7772 6170 7069 6e67        Unwrapping
+0000ec20: 2066 756e 6374 696f 6e20 746f 2075 7365   function to use
+0000ec30: 2e20 5468 6520 6465 6661 756c 7420 6973  . The default is
+0000ec40: 2027 736b 6927 2e0d 0a0d 0a20 2020 2020   'ski'.....     
+0000ec50: 2020 2020 2020 202d 2027 736b 6927 3a20         - 'ski': 
+0000ec60: 6053 6369 6b69 742d 696d 6167 655b 315d  `Scikit-image[1]
+0000ec70: 5f20 3c68 7474 7073 3a2f 2f73 6369 6b69  _ <https://sciki
+0000ec80: 742d 696d 6167 652e 6f72 672f 646f 6373  t-image.org/docs
+0000ec90: 2f73 7461 626c 652f 6175 746f 5f65 7861  /stable/auto_exa
+0000eca0: 6d70 6c65 732f 6669 6c74 6572 732f 706c  mples/filters/pl
+0000ecb0: 6f74 5f70 6861 7365 5f75 6e77 7261 702e  ot_phase_unwrap.
+0000ecc0: 6874 6d6c 3e60 5f0d 0a0d 0a20 2020 2020  html>`_....     
+0000ecd0: 2020 2020 2020 202d 2065 6c73 653a 2060         - else: `
+0000ece0: 4f70 656e 4356 5b32 5d5f 203c 6874 7470  OpenCV[2]_ <http
+0000ecf0: 733a 2f2f 646f 6373 2e6f 7065 6e63 762e  s://docs.opencv.
+0000ed00: 6f72 672f 342e 372e 302f 6466 2f64 3361  org/4.7.0/df/d3a
+0000ed10: 2f67 726f 7570 5f5f 7068 6173 655f 5f75  /group__phase__u
+0000ed20: 6e77 7261 7070 696e 672e 6874 6d6c 3e60  nwrapping.html>`
+0000ed30: 5f0d 0a0d 0a20 2020 2020 2020 2052 6574  _....        Ret
+0000ed40: 7572 6e73 0d0a 2020 2020 2020 2020 2d2d  urns..        --
+0000ed50: 2d2d 2d2d 2d0d 0a20 2020 2020 2020 2075  -----..        u
+0000ed60: 6e77 7261 7070 6564 203a 206e 702e 6e64  nwrapped : np.nd
+0000ed70: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
+0000ed80: 2020 2055 6e77 7261 7070 6564 2070 6861     Unwrapped pha
+0000ed90: 7365 206d 6170 732e 0d0a 0d0a 2020 2020  se maps.....    
+0000eda0: 2020 2020 5265 6665 7265 6e63 6573 0d0a      References..
+0000edb0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+0000edc0: 2d2d 0d0a 2020 2020 2020 2020 2e2e 205b  --..        .. [
+0000edd0: 315d 2060 4865 7272 c3a1 657a 2065 7420  1] `Herr..ez et 
+0000ede0: 616c 2e2c 0d0a 2020 2020 2020 2020 2246  al.,..        "F
+0000edf0: 6173 7420 7477 6f2d 6469 6d65 6e73 696f  ast two-dimensio
+0000ee00: 6e61 6c20 7068 6173 652d 756e 7772 6170  nal phase-unwrap
+0000ee10: 7069 6e67 2061 6c67 6f72 6974 686d 2062  ping algorithm b
+0000ee20: 6173 6564 206f 6e20 736f 7274 696e 6720  ased on sorting 
+0000ee30: 6279 2072 656c 6961 6269 6c69 7479 2066  by reliability f
+0000ee40: 6f6c 6c6f 7769 6e67 2061 206e 6f6e 636f  ollowing a nonco
+0000ee50: 6e74 696e 756f 7573 2070 6174 6822 2c0d  ntinuous path",.
+0000ee60: 0a20 2020 2020 2020 2041 7070 6c69 6564  .        Applied
+0000ee70: 204f 7074 6963 732c 0d0a 2020 2020 2020   Optics,..      
+0000ee80: 2020 3230 3032 2e0d 0a20 2020 2020 2020    2002...       
+0000ee90: 203c 6874 7470 733a 2f2f 646f 692e 6f72   <https://doi.or
+0000eea0: 672f 3130 2e31 3336 342f 414f 2e34 312e  g/10.1364/AO.41.
+0000eeb0: 3030 3734 3337 3e60 5f0d 0a0d 0a20 2020  007437>`_....   
+0000eec0: 2020 2020 202e 2e20 5b32 5d20 604c 6569       .. [2] `Lei
+0000eed0: 2065 7420 616c 2e2c 0d0a 2020 2020 2020   et al.,..      
+0000eee0: 2020 2241 206e 6f76 656c 2061 6c67 6f72    "A novel algor
+0000eef0: 6974 686d 2062 6173 6564 206f 6e20 6869  ithm based on hi
+0000ef00: 7374 6f67 7261 6d20 7072 6f63 6573 7369  stogram processi
+0000ef10: 6e67 206f 6620 7265 6c69 6162 696c 6974  ng of reliabilit
+0000ef20: 7920 666f 7220 7477 6f2d 6469 6d65 6e73  y for two-dimens
+0000ef30: 696f 6e61 6c20 7068 6173 6520 756e 7772  ional phase unwr
+0000ef40: 6170 7069 6e67 222c 0d0a 2020 2020 2020  apping",..      
+0000ef50: 2020 4f70 7469 6b20 2d20 496e 7465 726e    Optik - Intern
+0000ef60: 6174 696f 6e61 6c20 4a6f 7572 6e61 6c20  ational Journal 
+0000ef70: 666f 7220 4c69 6768 7420 616e 6420 456c  for Light and El
+0000ef80: 6563 7472 6f6e 204f 7074 6963 732c 0d0a  ectron Optics,..
+0000ef90: 2020 2020 2020 2020 3230 3135 2e0d 0a20          2015... 
+0000efa0: 2020 2020 2020 203c 6874 7470 733a 2f2f         <https://
+0000efb0: 646f 692e 6f72 672f 3130 2e31 3031 362f  doi.org/10.1016/
+0000efc0: 6a2e 696a 6c65 6f2e 3230 3135 2e30 342e  j.ijleo.2015.04.
+0000efd0: 3037 303e 605f 0d0a 2020 2020 2020 2020  070>`_..        
+0000efe0: 2222 220d 0a0d 0a20 2020 2020 2020 2074  """....        t
+0000eff0: 3020 3d20 7469 6d65 2e70 6572 665f 636f  0 = time.perf_co
+0000f000: 756e 7465 7228 290d 0a0d 0a20 2020 2020  unter()....     
+0000f010: 2020 2054 2c20 592c 2058 2c20 4320 3d20     T, Y, X, C = 
+0000f020: 7673 6861 7065 2870 6869 292e 7368 6170  vshape(phi).shap
+0000f030: 650d 0a20 2020 2020 2020 2061 7373 6572  e..        asser
+0000f040: 7420 5420 2520 7365 6c66 2e44 203d 3d20  t T % self.D == 
+0000f050: 302c 2022 4e75 6d62 6572 206f 6620 6672  0, "Number of fr
+0000f060: 616d 6573 206f 6620 7061 7261 6d65 7465  ames of paramete
+0000f070: 7273 2061 6e64 2064 6174 6120 646f 6e27  rs and data don'
+0000f080: 7420 6d61 7463 682e 220d 0a0d 0a20 2020  t match."....   
+0000f090: 2020 2020 2066 756e 6320 3d20 2273 6b69       func = "ski
+0000f0a0: 2220 2023 2074 6f64 6f3a 2065 6e61 626c  "  # todo: enabl
+0000f0b0: 6520 6376 3220 756e 7772 6170 7069 6e67  e cv2 unwrapping
+0000f0c0: 0d0a 0d0a 2020 2020 2020 2020 6966 2066  ....        if f
+0000f0d0: 756e 6320 696e 2022 6376 3222 3a20 2023  unc in "cv2":  #
+0000f0e0: 204f 7065 6e43 5620 756e 7772 6170 7069   OpenCV unwrappi
+0000f0f0: 6e67 0d0a 2020 2020 2020 2020 2020 2020  ng..            
+0000f100: 2320 7061 7261 6d73 203d 2063 7632 2e70  # params = cv2.p
+0000f110: 6861 7365 5f75 6e77 7261 7070 696e 675f  hase_unwrapping_
+0000f120: 4869 7374 6f67 7261 6d50 6861 7365 556e  HistogramPhaseUn
+0000f130: 7772 6170 7069 6e67 5f50 6172 616d 7328  wrapping_Params(
+0000f140: 290d 0a20 2020 2020 2020 2020 2020 2070  )..            p
+0000f150: 6172 616d 7320 3d20 6376 322e 7068 6173  arams = cv2.phas
+0000f160: 655f 756e 7772 6170 7069 6e67 2e48 6973  e_unwrapping.His
+0000f170: 746f 6772 616d 5068 6173 6555 6e77 7261  togramPhaseUnwra
+0000f180: 7070 696e 672e 5061 7261 6d73 2829 0d0a  pping.Params()..
+0000f190: 2020 2020 2020 2020 2020 2020 7061 7261              para
+0000f1a0: 6d73 2e68 6569 6768 7420 3d20 590d 0a20  ms.height = Y.. 
+0000f1b0: 2020 2020 2020 2020 2020 2070 6172 616d             param
+0000f1c0: 732e 7769 6474 6820 3d20 580d 0a20 2020  s.width = X..   
+0000f1d0: 2020 2020 2020 2020 2023 2075 6e77 7261           # unwra
+0000f1e0: 7070 696e 675f 696e 7374 616e 6365 203d  pping_instance =
+0000f1f0: 2063 7632 2e70 6861 7365 5f75 6e77 7261   cv2.phase_unwra
+0000f200: 7070 696e 672e 4869 7374 6f67 7261 6d50  pping.HistogramP
+0000f210: 6861 7365 556e 7772 6170 7069 6e67 5f63  haseUnwrapping_c
+0000f220: 7265 6174 6528 7061 7261 6d73 290d 0a20  reate(params).. 
+0000f230: 2020 2020 2020 2020 2020 2075 6e77 7261             unwra
+0000f240: 7070 696e 675f 696e 7374 616e 6365 203d  pping_instance =
+0000f250: 2063 7632 2e70 6861 7365 5f75 6e77 7261   cv2.phase_unwra
+0000f260: 7070 696e 672e 4869 7374 6f67 7261 6d50  pping.HistogramP
+0000f270: 6861 7365 556e 7772 6170 7069 6e67 2e63  haseUnwrapping.c
+0000f280: 7265 6174 6528 7061 7261 6d73 290d 0a0d  reate(params)...
+0000f290: 0a20 2020 2020 2020 2072 6567 203d 206e  .        reg = n
+0000f2a0: 702e 656d 7074 7928 2873 656c 662e 442c  p.empty((self.D,
+0000f2b0: 2059 2c20 582c 2043 292c 206e 702e 666c   Y, X, C), np.fl
+0000f2c0: 6f61 7433 3229 0d0a 2020 2020 2020 2020  oat32)..        
+0000f2d0: 6966 2073 656c 662e 7665 7262 6f73 653a  if self.verbose:
+0000f2e0: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0000f2f0: 7320 3d20 6e70 2e65 6d70 7479 2828 7365  s = np.empty((se
+0000f300: 6c66 2e44 2c20 592c 2058 2c20 4329 2c20  lf.D, Y, X, C), 
+0000f310: 6e70 2e66 6c6f 6174 3332 290d 0a0d 0a20  np.float32).... 
+0000f320: 2020 2020 2020 2066 6f72 2064 2069 6e20         for d in 
+0000f330: 7261 6e67 6528 7365 6c66 2e44 293a 0d0a  range(self.D):..
+0000f340: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000f350: 656c 662e 4b20 3d3d 2031 3a20 2023 2074  elf.K == 1:  # t
+0000f360: 6f64 6f3a 2073 656c 662e 4b5b 645d 203d  odo: self.K[d] =
+0000f370: 3d20 310d 0a20 2020 2020 2020 2020 2020  = 1..           
+0000f380: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0000f390: 6f28 6622 5370 6174 6961 6c20 7068 6173  o(f"Spatial phas
+0000f3a0: 6520 756e 7772 6170 7069 6e67 2069 6e20  e unwrapping in 
+0000f3b0: 3244 7b27 2066 6f72 2065 6163 6820 636f  2D{' for each co
+0000f3c0: 6c6f 7220 696e 6465 7065 6e74 6c79 2720  lor indepently' 
+0000f3d0: 6966 2043 203e 2031 2065 6c73 6520 2727  if C > 1 else ''
+0000f3e0: 7d2e 2229 0d0a 2020 2020 2020 2020 2020  }.")..          
+0000f3f0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+0000f400: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0000f410: 2e69 6e66 6f28 6622 5370 6174 6961 6c20  .info(f"Spatial 
+0000f420: 7068 6173 6520 756e 7772 6170 7069 6e67  phase unwrapping
+0000f430: 2069 6e20 3344 7b27 2066 6f72 2065 6163   in 3D{' for eac
+0000f440: 6820 636f 6c6f 7220 696e 6465 7065 6e74  h color indepent
+0000f450: 6c79 2720 6966 2043 203e 2031 2065 6c73  ly' if C > 1 els
+0000f460: 6520 2727 7d2e 2229 0d0a 2020 2020 2020  e ''}.")..      
+0000f470: 2020 2020 2020 2020 2020 6675 6e63 203d            func =
+0000f480: 2022 736b 6922 2020 2320 6f6e 6c79 2073   "ski"  # only s
+0000f490: 6b69 2063 616e 2075 6e77 7261 7020 696e  ki can unwrap in
+0000f4a0: 2033 440d 0a0d 0a20 2020 2020 2020 2020   3D....         
+0000f4b0: 2020 2066 6f72 2063 2069 6e20 7261 6e67     for c in rang
+0000f4c0: 6528 4329 3a0d 0a20 2020 2020 2020 2020  e(C):..         
+0000f4d0: 2020 2020 2020 2069 6620 6675 6e63 2069         if func i
+0000f4e0: 6e20 2263 7632 223a 2020 2320 4f70 656e  n "cv2":  # Open
+0000f4f0: 4356 2061 6c67 6f72 6974 686d 2069 7320  CV algorithm is 
+0000f500: 7573 7561 6c6c 7920 6661 7374 6572 2c20  usually faster, 
+0000f510: 6275 7420 6361 6e20 6265 206d 7563 6820  but can be much 
+0000f520: 736c 6f77 6572 2069 6e20 6e6f 6973 7920  slower in noisy 
+0000f530: 696d 6167 6573 0d0a 2020 2020 2020 2020  images..        
+0000f540: 2020 2020 2020 2020 2020 2020 2320 6474              # dt
+0000f550: 7970 6520 6d75 7374 2062 6520 6e70 2e66  ype must be np.f
+0000f560: 6c6f 6174 3332 2020 2320 746f 646f 3a20  loat32  # todo: 
+0000f570: 7465 7374 2074 6869 730d 0a20 2020 2020  test this..     
+0000f580: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000f590: 6620 4661 6c73 653a 2020 2320 746f 646f  f False:  # todo
+0000f5a0: 3a20 6973 696e 7374 616e 6365 2842 2c20  : isinstance(B, 
+0000f5b0: 6e70 2e6e 6461 7272 6179 2920 616e 6420  np.ndarray) and 
+0000f5c0: 7673 6861 7065 2842 292e 7368 6170 6520  vshape(B).shape 
+0000f5d0: 3d3d 2070 6869 2e73 6861 7065 3a0d 0a20  == phi.shape:.. 
+0000f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5f0: 2020 2020 2020 2023 2074 6f64 6f3a 2075         # todo: u
+0000f600: 6e77 7261 7020 7769 7468 206d 6173 6b0d  nwrap with mask.
+0000f610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f620: 2020 2020 2020 2020 2023 2074 6f64 6f3a           # todo:
+0000f630: 2073 7761 7061 7865 7320 3f3f 3f0d 0a20   swapaxes ???.. 
+0000f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f650: 2020 2020 2020 2053 4e52 203d 2073 656c         SNR = sel
+0000f660: 662e 425b 642c 203a 2c20 3a2c 2063 5d20  f.B[d, :, :, c] 
+0000f670: 2f20 7365 6c66 2e75 690d 0a20 2020 2020  / self.ui..     
+0000f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f690: 2020 2075 7069 203d 206e 702e 7371 7274     upi = np.sqrt
+0000f6a0: 2832 2920 2f20 6e70 2e73 7172 7428 7365  (2) / np.sqrt(se
+0000f6b0: 6c66 2e4d 2920 2f20 6e70 2e73 7172 7428  lf.M) / np.sqrt(
+0000f6c0: 7365 6c66 2e5f 4e29 202f 2053 4e52 2020  self._N) / SNR  
+0000f6d0: 2320 6c6f 6361 6c20 7068 6173 6520 756e  # local phase un
+0000f6e0: 6365 7274 6169 6e74 6965 730d 0a20 2020  certainties..   
+0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f700: 2020 2020 2075 7069 6e20 3d20 7570 6920       upin = upi 
+0000f710: 2f20 2832 202a 206e 702e 7069 2920 2023  / (2 * np.pi)  #
+0000f720: 206e 6f72 6d61 6c69 7a65 6420 6c6f 6361   normalized loca
+0000f730: 6c20 7068 6173 6520 756e 6365 7274 6169  l phase uncertai
+0000f740: 6e74 6965 730d 0a20 2020 2020 2020 2020  nties..         
+0000f750: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0000f760: 7869 203d 2075 7069 6e20 2a20 7365 6c66  xi = upin * self
+0000f770: 2e5f 6c5b 645d 2020 2320 6c6f 6361 6c20  ._l[d]  # local 
+0000f780: 706f 7369 7469 6f6e 616c 2075 6e63 6572  positional uncer
+0000f790: 7461 696e 7469 6573 0d0a 2020 2020 2020  tainties..      
+0000f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7b0: 2020 7578 203d 206e 702e 7371 7274 280d    ux = np.sqrt(.
 0000f7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f7d0: 2022 6272 6967 6874 6e65 7373 206d 6f64   "brightness mod
-0000f7e0: 756c 6174 696f 6e20 7265 6769 7374 7261  ulation registra
-0000f7f0: 7469 6f6e 2072 6573 6964 7561 6c73 2075  tion residuals u
-0000f800: 6e63 6572 7461 696e 7479 2070 6861 7365  ncertainty phase
-0000f810: 206f 7264 6572 7320 7669 7369 6269 6c69   orders visibili
-0000f820: 7479 2065 7870 6f73 7572 6522 2c0d 0a20  ty exposure",.. 
-0000f830: 2020 2020 2020 2020 2020 2029 2862 7269             )(bri
-0000f840: 2c20 6d6f 642c 2072 6567 2c20 7265 732c  , mod, reg, res,
-0000f850: 2075 6e63 2c20 7068 692c 2066 6964 2c20   unc, phi, fid, 
-0000f860: 7669 732c 2065 7870 290d 0a20 2020 2020  vis, exp)..     
-0000f870: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-0000f880: 2020 2020 2020 6465 6320 3d20 6e61 6d65        dec = name
-0000f890: 6474 7570 6c65 2822 6465 636f 6465 6422  dtuple("decoded"
-0000f8a0: 2c20 2262 7269 6768 746e 6573 7320 6d6f  , "brightness mo
-0000f8b0: 6475 6c61 7469 6f6e 2072 6567 6973 7472  dulation registr
-0000f8c0: 6174 696f 6e22 2928 6272 692c 206d 6f64  ation")(bri, mod
-0000f8d0: 2c20 7265 6729 0d0a 0d0a 2020 2020 2020  , reg)....      
-0000f8e0: 2020 7365 6c66 2e6c 6f67 6765 722e 696e    self.logger.in
-0000f8f0: 666f 2866 227b 7369 2874 696d 652e 7065  fo(f"{si(time.pe
-0000f900: 7266 5f63 6f75 6e74 6572 2829 202d 2074  rf_counter() - t
-0000f910: 3029 7d73 2229 0d0a 0d0a 2020 2020 2020  0)}s")....      
-0000f920: 2020 7265 7475 726e 2064 6563 0d0a 0d0a    return dec....
-0000f930: 2020 2020 6465 6620 5f76 6572 626f 7365      def _verbose
-0000f940: 5f28 7365 6c66 2c20 493a 206e 702e 6e64  _(self, I: np.nd
-0000f950: 6172 7261 792c 2041 3a20 6e70 2e6e 6461  array, A: np.nda
-0000f960: 7272 6179 2c20 423a 206e 702e 6e64 6172  rray, B: np.ndar
-0000f970: 7261 792c 2078 693a 206e 702e 6e64 6172  ray, xi: np.ndar
-0000f980: 7261 792c 206c 6573 7362 6974 733a 2062  ray, lessbits: b
-0000f990: 6f6f 6c20 3d20 4661 6c73 6529 3a0d 0a20  ool = False):.. 
-0000f9a0: 2020 2020 2020 2022 2222 436f 6d70 7574         """Comput
-0000f9b0: 6520 7665 7262 6f73 6520 6f75 7470 7574  e verbose output
-0000f9c0: 2e0d 0a0d 0a20 2020 2020 2020 2050 6172  .....        Par
-0000f9d0: 616d 6574 6572 730d 0a20 2020 2020 2020  ameters..       
-0000f9e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0d 0a20 2020   ----------..   
-0000f9f0: 2020 2020 2049 203a 206e 702e 6e64 6172       I : np.ndar
-0000fa00: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-0000fa10: 2046 7269 6e67 6520 7061 7474 6572 6e20   Fringe pattern 
-0000fa20: 7365 7175 656e 6365 2e0d 0a0d 0a20 2020  sequence.....   
-0000fa30: 2020 2020 2041 203a 206e 702e 6e64 6172       A : np.ndar
-0000fa40: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-0000fa50: 2042 7269 6768 746e 6573 732e 0d0a 0d0a   Brightness.....
-0000fa60: 2020 2020 2020 2020 4220 3a20 6e70 2e6e          B : np.n
-0000fa70: 6461 7272 6179 0d0a 2020 2020 2020 2020  darray..        
-0000fa80: 2020 2020 4d6f 6475 6c61 7469 6f6e 2e0d      Modulation..
-0000fa90: 0a0d 0a20 2020 2020 2020 2078 6920 3a20  ...        xi : 
-0000faa0: 6e70 2e6e 6461 7272 6179 0d0a 2020 2020  np.ndarray..    
-0000fab0: 2020 2020 2020 2020 5265 6769 7374 7261          Registra
-0000fac0: 7469 6f6e 2e0d 0a0d 0a20 2020 2020 2020  tion.....       
-0000fad0: 206c 6573 7362 6974 7320 3a20 626f 6f6c   lessbits : bool
-0000fae0: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
-0000faf0: 2020 2020 2020 2020 5468 6520 6672 696e          The frin
-0000fb00: 6765 2070 6174 7465 726e 2073 6571 7565  ge pattern seque
-0000fb10: 6e63 6520 2749 2720 6d61 7920 636f 6e74  nce 'I' may cont
-0000fb20: 6169 6e20 6665 7765 7220 6269 7473 206f  ain fewer bits o
-0000fb30: 6620 696e 666f 726d 6174 696f 6e20 7468  f information th
-0000fb40: 616e 2069 7473 2063 6f72 7265 7370 6f6e  an its correspon
-0000fb50: 6469 6e67 2064 7479 7065 2e0d 0a20 2020  ding dtype...   
-0000fb60: 2020 2020 2020 2020 2054 6869 7320 6f63           This oc
-0000fb70: 6375 7273 2069 6620 652e 672e 2061 2031  curs if e.g. a 1
-0000fb80: 3020 6f72 2031 3220 6269 7420 6361 6d65  0 or 12 bit came
-0000fb90: 7261 2069 7320 7573 6564 2c20 666f 7220  ra is used, for 
-0000fba0: 7768 6963 6820 7468 6520 636f 7272 6573  which the corres
-0000fbb0: 706f 6e64 696e 6720 6474 7970 6520 776f  ponding dtype wo
-0000fbc0: 756c 6420 6265 2027 7569 6e74 3136 272e  uld be 'uint16'.
-0000fbd0: 0d0a 2020 2020 2020 2020 2020 2020 4966  ..            If
-0000fbe0: 2027 6c65 7373 6269 7473 2720 6973 2054   'lessbits' is T
-0000fbf0: 7275 652c 2074 6865 206e 756d 6265 7220  rue, the number 
-0000fc00: 6f66 2062 6974 7320 6973 2065 7374 696d  of bits is estim
-0000fc10: 6174 6564 2062 6173 6564 206f 6e20 7468  ated based on th
-0000fc20: 6520 6d61 7869 6d61 6c20 7661 6c75 6520  e maximal value 
-0000fc30: 6f66 2027 4927 2e0d 0a20 2020 2020 2020  of 'I'...       
-0000fc40: 2020 2020 2054 6869 7320 6166 6665 6374       This affect
-0000fc50: 7320 7468 6520 7661 6c75 6520 6f66 2074  s the value of t
-0000fc60: 6865 2065 7870 6f73 7572 6520 2765 272e  he exposure 'e'.
-0000fc70: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
-0000fc80: 726e 730d 0a20 2020 2020 2020 202d 2d2d  rns..        ---
-0000fc90: 2d2d 2d2d 0d0a 2020 2020 2020 2020 7520  ----..        u 
-0000fca0: 3a20 6e70 2e6e 6461 7272 6179 2c20 6f70  : np.ndarray, op
-0000fcb0: 7469 6f6e 616c 0d0a 2020 2020 2020 2020  tional..        
-0000fcc0: 2020 2020 756e 6365 7274 6169 6e74 7920      uncertainty 
-0000fcd0: 6f66 2070 6f73 6974 696f 6e61 6c20 6465  of positional de
-0000fce0: 636f 6469 6e67 2069 6e20 7069 7865 6c20  coding in pixel 
-0000fcf0: 756e 6974 730d 0a0d 0a20 2020 2020 2020  units....       
-0000fd00: 206b 203a 206e 702e 6e64 6172 7261 792c   k : np.ndarray,
-0000fd10: 206f 7074 696f 6e61 6c0d 0a20 2020 2020   optional..     
-0000fd20: 2020 2020 2020 2046 7269 6e67 6520 6f72         Fringe or
-0000fd30: 6465 7273 2e0d 0a0d 0a20 2020 2020 2020  ders.....       
-0000fd40: 2056 203a 206e 702e 6e64 6172 7261 792c   V : np.ndarray,
-0000fd50: 206f 7074 696f 6e61 6c0d 0a20 2020 2020   optional..     
-0000fd60: 2020 2020 2020 2052 6573 6964 7561 6c73         Residuals
-0000fd70: 2066 726f 6d20 7468 6520 6f70 7469 6d69   from the optimi
-0000fd80: 7a61 7469 6f6e 2d62 6173 6564 2075 6e77  zation-based unw
-0000fd90: 7261 7070 696e 6720 7072 6f63 6573 732e  rapping process.
-0000fda0: 0d0a 0d0a 2020 2020 2020 2020 6520 3a20  ....        e : 
-0000fdb0: 6e70 2e6e 6461 7272 6179 2c20 6f70 7469  np.ndarray, opti
-0000fdc0: 6f6e 616c 0d0a 2020 2020 2020 2020 2020  onal..          
-0000fdd0: 2020 4c6f 6361 6c20 6578 706f 7375 7265    Local exposure
-0000fde0: 2028 7265 6c61 7469 7665 2061 7665 7261   (relative avera
-0000fdf0: 6765 2069 6e74 656e 7369 7479 292e 0d0a  ge intensity)...
-0000fe00: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
-0000fe10: 2020 2020 2020 2059 2c20 582c 2043 203d         Y, X, C =
-0000fe20: 2041 2e73 6861 7065 5b31 3a5d 0d0a 0d0a   A.shape[1:]....
-0000fe30: 2020 2020 2020 2020 6461 726b 203d 2073          dark = s
-0000fe40: 656c 662e 6761 696e 202a 2073 656c 662e  elf.gain * self.
-0000fe50: 6461 726b 0d0a 2020 2020 2020 2020 7175  dark..        qu
-0000fe60: 616e 7420 3d20 3020 6966 2073 656c 662e  ant = 0 if self.
-0000fe70: 6461 726b 203e 2030 2065 6c73 6520 7365  dark > 0 else se
-0000fe80: 6c66 2e71 7561 6e74 0d0a 2020 2020 2020  lf.quant..      
-0000fe90: 2020 7368 6f74 203d 2028 0d0a 2020 2020    shot = (..    
-0000fea0: 2020 2020 2020 2020 6e70 2e73 7172 7428          np.sqrt(
-0000feb0: 7365 6c66 2e67 6169 6e20 2a20 6e70 2e6d  self.gain * np.m
-0000fec0: 6178 696d 756d 2830 2c20 4120 2d20 7365  aximum(0, A - se
-0000fed0: 6c66 2e79 3029 2920 6966 2073 656c 662e  lf.y0)) if self.
-0000fee0: 6761 696e 2021 3d20 3020 656c 7365 206e  gain != 0 else n
-0000fef0: 702e 7a65 726f 735f 6c69 6b65 2841 290d  p.zeros_like(A).
-0000ff00: 0a20 2020 2020 2020 2029 2020 2320 6176  .        )  # av
-0000ff10: 6572 6167 6520 696e 7465 6e73 6974 7920  erage intensity 
-0000ff20: 3d20 6272 6967 6874 6e65 7373 0d0a 2020  = brightness..  
-0000ff30: 2020 2020 2020 7569 203d 206e 702e 7371        ui = np.sq
-0000ff40: 7274 2864 6172 6b2a 2a32 202b 2071 7561  rt(dark**2 + qua
-0000ff50: 6e74 2a2a 3220 2b20 7368 6f74 2a2a 3229  nt**2 + shot**2)
-0000ff60: 2020 2320 696e 7465 6e73 6974 7920 6e6f    # intensity no
-0000ff70: 6973 650d 0a20 2020 2020 2020 2075 7069  ise..        upi
-0000ff80: 203d 2028 0d0a 2020 2020 2020 2020 2020   = (..          
-0000ff90: 2020 6e70 2e73 7172 7428 3229 0d0a 2020    np.sqrt(2)..  
-0000ffa0: 2020 2020 2020 2020 2020 2f20 6e70 2e73            / np.s
-0000ffb0: 7172 7428 7365 6c66 2e4d 290d 0a20 2020  qrt(self.M)..   
-0000ffc0: 2020 2020 2020 2020 202f 206e 702e 7371           / np.sq
-0000ffd0: 7274 2873 656c 662e 5f4e 5b3a 2c20 3a2c  rt(self._N[:, :,
-0000ffe0: 204e 6f6e 652c 204e 6f6e 652c 204e 6f6e   None, None, Non
-0000fff0: 655d 290d 0a20 2020 2020 2020 2020 2020  e])..           
-00010000: 202f 2042 2e72 6573 6861 7065 2873 656c   / B.reshape(sel
-00010010: 662e 442c 2073 656c 662e 4b2c 2059 2c20  f.D, self.K, Y, 
-00010020: 582c 2043 290d 0a20 2020 2020 2020 2020  X, C)..         
-00010030: 2020 202a 2075 695b 3a2c 204e 6f6e 652c     * ui[:, None,
-00010040: 203a 2c20 3a5d 0d0a 2020 2020 2020 2020   :, :]..        
-00010050: 2920 2023 206c 6f63 616c 2070 6861 7365  )  # local phase
-00010060: 2075 6e63 6572 7461 696e 7469 6573 2020   uncertainties  
-00010070: 2320 746f 646f 3a20 4d0d 0a20 2020 2020  # todo: M..     
-00010080: 2020 2075 7869 203d 2075 7069 202f 2028     uxi = upi / (
-00010090: 3220 2a20 6e70 2e70 6929 202a 2073 656c  2 * np.pi) * sel
-000100a0: 662e 5f6c 5b3a 2c20 3a2c 204e 6f6e 652c  f._l[:, :, None,
-000100b0: 204e 6f6e 652c 204e 6f6e 655d 2020 2320   None, None]  # 
-000100c0: 6c6f 6361 6c20 706f 7369 7469 6f6e 616c  local positional
-000100d0: 2075 6e63 6572 7461 696e 7469 6573 0d0a   uncertainties..
-000100e0: 2020 2020 2020 2020 7520 3d20 6e70 2e73          u = np.s
-000100f0: 7172 7428 3120 2f20 6e70 2e73 756d 2831  qrt(1 / np.sum(1
-00010100: 202f 2075 7869 2a2a 322c 2061 7869 733d   / uxi**2, axis=
-00010110: 3129 2920 2023 2067 6c6f 6261 6c20 706f  1))  # global po
-00010120: 7369 7469 6f6e 616c 2075 6e63 6572 7461  sitional uncerta
-00010130: 696e 7479 0d0a 0d0a 2020 2020 2020 2020  inty....        
-00010140: 6b20 3d20 2878 695b 3a2c 204e 6f6e 652c  k = (xi[:, None,
-00010150: 203a 2c20 3a2c 203a 5d20 2f2f 2073 656c   :, :, :] // sel
-00010160: 662e 5f6c 5b3a 2c20 3a2c 204e 6f6e 652c  f._l[:, :, None,
-00010170: 204e 6f6e 652c 204e 6f6e 655d 292e 6173   None, None]).as
-00010180: 7479 7065 2869 6e74 292e 7265 7368 6170  type(int).reshap
-00010190: 6528 7365 6c66 2e44 202a 2073 656c 662e  e(self.D * self.
-000101a0: 4b2c 2059 2c20 582c 2043 290d 0a0d 0a20  K, Y, X, C).... 
-000101b0: 2020 2020 2020 2056 203d 2028 422e 7265         V = (B.re
-000101c0: 7368 6170 6528 7365 6c66 2e44 2c20 7365  shape(self.D, se
-000101d0: 6c66 2e4b 2c20 592c 2058 2c20 4329 202f  lf.K, Y, X, C) /
-000101e0: 2041 5b3a 2c20 4e6f 6e65 2c20 3a2c 203a   A[:, None, :, :
-000101f0: 2c20 3a5d 292e 7265 7368 6170 6528 7365  , :]).reshape(se
-00010200: 6c66 2e44 202a 2073 656c 662e 4b2c 2059  lf.D * self.K, Y
-00010210: 2c20 582c 2043 290d 0a0d 0a20 2020 2020  , X, C)....     
-00010220: 2020 2069 6620 492e 6474 7970 652e 6b69     if I.dtype.ki
-00010230: 6e64 2069 6e20 2275 6922 3a0d 0a20 2020  nd in "ui":..   
-00010240: 2020 2020 2020 2020 2069 6620 6c65 7373           if less
-00010250: 6269 7473 2061 6e64 206e 702e 6969 6e66  bits and np.iinf
-00010260: 6f28 492e 6474 7970 6529 2e62 6974 7320  o(I.dtype).bits 
-00010270: 3e20 383a 2020 2320 6461 7461 206d 6179  > 8:  # data may
-00010280: 2063 6f6e 7461 696e 2066 6577 6572 2062   contain fewer b
-00010290: 6974 7320 6f66 2069 6e66 6f72 6d61 7469  its of informati
-000102a0: 6f6e 0d0a 2020 2020 2020 2020 2020 2020  on..            
-000102b0: 2020 2020 496d 6178 203d 2069 6e74 286e      Imax = int(n
-000102c0: 702e 6365 696c 286e 702e 6c6f 6732 2849  p.ceil(np.log2(I
-000102d0: 2e6d 6178 2829 2929 2920 2023 2073 616d  .max())))  # sam
-000102e0: 6520 6f72 206e 6578 7420 706f 7765 7220  e or next power 
-000102f0: 6f66 2074 776f 0d0a 2020 2020 2020 2020  of two..        
-00010300: 2020 2020 2020 2020 496d 6178 202b 3d20          Imax += 
-00010310: 2d49 6d61 7820 2520 3220 2023 2073 616d  -Imax % 2  # sam
-00010320: 6520 6f72 206e 6578 7420 706f 7765 7220  e or next power 
-00010330: 6f66 2074 776f 2064 6976 6973 6962 6c65  of two divisible
-00010340: 2062 7920 7477 6f0d 0a20 2020 2020 2020   by two..       
-00010350: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00010360: 2020 2020 2020 2020 2020 2020 496d 6178              Imax
-00010370: 203d 206e 702e 6969 6e66 6f28 492e 6474   = np.iinfo(I.dt
-00010380: 7970 6529 2e6d 6178 0d0a 2020 2020 2020  ype).max..      
-00010390: 2020 656c 7365 3a20 2023 2066 6c6f 6174    else:  # float
-000103a0: 0d0a 2020 2020 2020 2020 2020 2020 496d  ..            Im
-000103b0: 6178 203d 2031 0d0a 2020 2020 2020 2020  ax = 1..        
-000103c0: 6520 3d20 4120 2f20 496d 6178 0d0a 0d0a  e = A / Imax....
-000103d0: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
-000103e0: 7068 690d 0a0d 0a20 2020 2020 2020 2072  phi....        r
-000103f0: 6574 7572 6e20 752c 206b 2c20 562c 2065  eturn u, k, V, e
-00010400: 0d0a 0d0a 2020 2020 6465 6620 5f75 6e77  ....    def _unw
-00010410: 7261 7028 0d0a 2020 2020 2020 2020 7365  rap(..        se
-00010420: 6c66 2c20 7068 693a 206e 702e 6e64 6172  lf, phi: np.ndar
-00010430: 7261 792c 2042 3a20 6e70 2e6e 6461 7272  ray, B: np.ndarr
-00010440: 6179 2c20 6675 6e63 3a20 7374 7220 3d20  ay, func: str = 
-00010450: 2273 6b69 220d 0a20 2020 2029 202d 3e20  "ski"..    ) -> 
-00010460: 6e70 2e6e 6461 7272 6179 3a20 2023 2074  np.ndarray:  # t
-00010470: 6f64 6f3a 2075 7365 2042 2066 6f72 2071  odo: use B for q
-00010480: 7561 6c69 7479 2067 7569 6461 6e63 650d  uality guidance.
-00010490: 0a20 2020 2020 2020 2022 2222 556e 7772  .        """Unwr
-000104a0: 6170 2070 6861 7365 206d 6170 7320 7370  ap phase maps sp
-000104b0: 6163 6961 6c6c 792e 0d0a 0d0a 2020 2020  acially.....    
-000104c0: 2020 2020 5061 7261 6d65 7465 7273 0d0a      Parameters..
-000104d0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-000104e0: 2d2d 0d0a 2020 2020 2020 2020 7068 6920  --..        phi 
-000104f0: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
-00010500: 2020 2020 2020 2020 2020 5068 6173 6520            Phase 
-00010510: 6d61 7073 2074 6f20 756e 7772 6170 2073  maps to unwrap s
-00010520: 7061 7469 616c 6c79 2c20 7374 6163 6b65  patially, stacke
-00010530: 6420 616c 6f6e 6720 7468 6520 6669 7273  d along the firs
-00010540: 7420 6469 6d65 6e73 696f 6e2e 0d0a 2020  t dimension...  
-00010550: 2020 2020 2020 2020 2020 4974 2069 7320            It is 
-00010560: 7265 7368 6170 6564 2074 6f20 7669 6465  reshaped to vide
-00010570: 6f73 6861 7065 2028 6672 616d 6573 2060  oshape (frames `
-00010580: 5460 2c20 6865 6967 6874 2060 5960 2c20  T`, height `Y`, 
-00010590: 7769 6474 6820 6058 602c 2063 6f6c 6f72  width `X`, color
-000105a0: 2063 6861 6e6e 656c 7320 6043 6029 2062   channels `C`) b
-000105b0: 6566 6f72 6520 7072 6f63 6573 7369 6e67  efore processing
-000105c0: 2e0d 0a20 2020 2020 2020 2020 2020 2054  ...            T
-000105d0: 6865 2066 7261 6d65 7320 2866 6972 7374  he frames (first
-000105e0: 2064 696d 656e 7369 6f6e 2920 6173 2077   dimension) as w
-000105f0: 656c 6c20 7468 6520 636f 6c6f 7220 6368  ell the color ch
-00010600: 616e 6e65 6c73 2028 6c61 7374 2064 696d  annels (last dim
-00010610: 656e 7369 6f6e 290d 0a20 2020 2020 2020  ension)..       
-00010620: 2020 2020 2061 7265 2075 6e77 7261 7070       are unwrapp
-00010630: 6564 2073 6570 6172 6174 656c 792e 0d0a  ed separately...
-00010640: 0d0a 2020 2020 2020 2020 4220 3a20 6e70  ..        B : np
-00010650: 2e6e 6461 7272 6179 2c20 6f70 7469 6f6e  .ndarray, option
-00010660: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-00010670: 4d6f 6475 6c61 7469 6f6e 206f 6620 7468  Modulation of th
-00010680: 6520 6465 636f 6465 6420 7068 6173 652e  e decoded phase.
-00010690: 0d0a 2020 2020 2020 2020 2020 2020 4974  ..            It
-000106a0: 2069 7320 7265 7368 6170 6564 2074 6f20   is reshaped to 
-000106b0: 7669 6465 6f73 6861 7065 2028 6672 616d  videoshape (fram
-000106c0: 6573 2060 5460 2c20 6865 6967 6874 2060  es `T`, height `
-000106d0: 5960 2c20 7769 6474 6820 6058 602c 2063  Y`, width `X`, c
-000106e0: 6f6c 6f72 2063 6861 6e6e 656c 7320 6043  olor channels `C
-000106f0: 6029 2062 6566 6f72 6520 7072 6f63 6573  `) before proces
-00010700: 7369 6e67 2e0d 0a0d 0a20 2020 2020 2020  sing.....       
-00010710: 2066 756e 6320 3a20 7374 722c 206f 7074   func : str, opt
-00010720: 696f 6e61 6c0d 0a20 2020 2020 2020 2020  ional..         
-00010730: 2020 2055 6e77 7261 7070 696e 6720 6675     Unwrapping fu
-00010740: 6e63 7469 6f6e 2074 6f20 7573 652e 2054  nction to use. T
-00010750: 6865 2064 6566 6175 6c74 2069 7320 2773  he default is 's
-00010760: 6b69 272e 0d0a 0d0a 2020 2020 2020 2020  ki'.....        
-00010770: 2020 2020 2d20 2773 6b69 273a 2060 5363      - 'ski': `Sc
-00010780: 696b 6974 2d69 6d61 6765 5b31 5d5f 203c  ikit-image[1]_ <
-00010790: 6874 7470 733a 2f2f 7363 696b 6974 2d69  https://scikit-i
-000107a0: 6d61 6765 2e6f 7267 2f64 6f63 732f 7374  mage.org/docs/st
-000107b0: 6162 6c65 2f61 7574 6f5f 6578 616d 706c  able/auto_exampl
-000107c0: 6573 2f66 696c 7465 7273 2f70 6c6f 745f  es/filters/plot_
-000107d0: 7068 6173 655f 756e 7772 6170 2e68 746d  phase_unwrap.htm
-000107e0: 6c3e 605f 0d0a 0d0a 2020 2020 2020 2020  l>`_....        
-000107f0: 2020 2020 2d20 656c 7365 3a20 604f 7065      - else: `Ope
-00010800: 6e43 565b 325d 5f20 6874 7470 733a 2f2f  nCV[2]_ https://
-00010810: 646f 6373 2e6f 7065 6e63 762e 6f72 672f  docs.opencv.org/
-00010820: 342e 372e 302f 6466 2f64 3361 2f67 726f  4.7.0/df/d3a/gro
-00010830: 7570 5f5f 7068 6173 655f 5f75 6e77 7261  up__phase__unwra
-00010840: 7070 696e 672e 6874 6d6c 3e60 5f0d 0a0d  pping.html>`_...
-00010850: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00010860: 0d0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  ..        ------
-00010870: 2d0d 0a20 2020 2020 2020 2075 6e77 7261  -..        unwra
-00010880: 7070 6564 203a 206e 702e 6e64 6172 7261  pped : np.ndarra
-00010890: 790d 0a20 2020 2020 2020 2020 2020 2055  y..            U
-000108a0: 6e77 7261 7070 6564 2070 6861 7365 206d  nwrapped phase m
-000108b0: 6170 2873 292e 0d0a 0d0a 2020 2020 2020  ap(s).....      
-000108c0: 2020 5265 6665 7265 6e63 6573 0d0a 2020    References..  
-000108d0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-000108e0: 0d0a 2020 2020 2020 2020 2e2e 205b 315d  ..        .. [1]
-000108f0: 2060 4865 7272 c3a1 657a 2065 7420 616c   `Herr..ez et al
-00010900: 2e2c 0d0a 2020 2020 2020 2020 2246 6173  .,..        "Fas
-00010910: 7420 7477 6f2d 6469 6d65 6e73 696f 6e61  t two-dimensiona
-00010920: 6c20 7068 6173 652d 756e 7772 6170 7069  l phase-unwrappi
-00010930: 6e67 2061 6c67 6f72 6974 686d 2062 6173  ng algorithm bas
-00010940: 6564 206f 6e20 736f 7274 696e 6720 6279  ed on sorting by
-00010950: 2072 656c 6961 6269 6c69 7479 2066 6f6c   reliability fol
-00010960: 6c6f 7769 6e67 2061 206e 6f6e 636f 6e74  lowing a noncont
-00010970: 696e 756f 7573 2070 6174 6822 2c0d 0a20  inuous path",.. 
-00010980: 2020 2020 2020 2041 7070 6c69 6564 204f         Applied O
-00010990: 7074 6963 732c 0d0a 2020 2020 2020 2020  ptics,..        
-000109a0: 3230 3032 2e0d 0a20 2020 2020 2020 203c  2002...        <
-000109b0: 6874 7470 733a 2f2f 646f 692e 6f72 672f  https://doi.org/
-000109c0: 3130 2e31 3336 342f 414f 2e34 312e 3030  10.1364/AO.41.00
-000109d0: 3734 3337 3e60 5f0d 0a0d 0a20 2020 2020  7437>`_....     
-000109e0: 2020 202e 2e20 5b32 5d20 604c 6569 2065     .. [2] `Lei e
-000109f0: 7420 616c 2e2c 0d0a 2020 2020 2020 2020  t al.,..        
-00010a00: 2241 206e 6f76 656c 2061 6c67 6f72 6974  "A novel algorit
-00010a10: 686d 2062 6173 6564 206f 6e20 6869 7374  hm based on hist
-00010a20: 6f67 7261 6d20 7072 6f63 6573 7369 6e67  ogram processing
-00010a30: 206f 6620 7265 6c69 6162 696c 6974 7920   of reliability 
-00010a40: 666f 7220 7477 6f2d 6469 6d65 6e73 696f  for two-dimensio
-00010a50: 6e61 6c20 7068 6173 6520 756e 7772 6170  nal phase unwrap
-00010a60: 7069 6e67 222c 0d0a 2020 2020 2020 2020  ping",..        
-00010a70: 4f70 7469 6b20 2d20 496e 7465 726e 6174  Optik - Internat
-00010a80: 696f 6e61 6c20 4a6f 7572 6e61 6c20 666f  ional Journal fo
-00010a90: 7220 4c69 6768 7420 616e 6420 456c 6563  r Light and Elec
-00010aa0: 7472 6f6e 204f 7074 6963 732c 0d0a 2020  tron Optics,..  
-00010ab0: 2020 2020 2020 3230 3135 2e0d 0a20 2020        2015...   
-00010ac0: 2020 2020 203c 6874 7470 733a 2f2f 646f       <https://do
-00010ad0: 692e 6f72 672f 3130 2e31 3031 362f 6a2e  i.org/10.1016/j.
-00010ae0: 696a 6c65 6f2e 3230 3135 2e30 342e 3037  ijleo.2015.04.07
-00010af0: 303e 605f 0d0a 2020 2020 2020 2020 2222  0>`_..        ""
-00010b00: 220d 0a0d 0a20 2020 2020 2020 2074 3020  "....        t0 
-00010b10: 3d20 7469 6d65 2e70 6572 665f 636f 756e  = time.perf_coun
-00010b20: 7465 7228 290d 0a0d 0a20 2020 2020 2020  ter()....       
-00010b30: 2054 2c20 592c 2058 2c20 4320 3d20 7673   T, Y, X, C = vs
-00010b40: 6861 7065 2870 6869 292e 7368 6170 650d  hape(phi).shape.
-00010b50: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00010b60: 5420 2520 7365 6c66 2e44 203d 3d20 302c  T % self.D == 0,
-00010b70: 2022 4e75 6d62 6572 206f 6620 6672 616d   "Number of fram
-00010b80: 6573 206f 6620 7061 7261 6d65 7465 7273  es of parameters
-00010b90: 2061 6e64 2064 6174 6120 646f 6e27 7420   and data don't 
-00010ba0: 6d61 7463 682e 220d 0a20 2020 2020 2020  match."..       
-00010bb0: 2069 6620 7365 6c66 2e44 2021 3d20 543a   if self.D != T:
-00010bc0: 0d0a 2020 2020 2020 2020 2020 2020 7068  ..            ph
-00010bd0: 6920 3d20 7068 692e 7265 7368 6170 6528  i = phi.reshape(
-00010be0: 2873 656c 662e 442c 202d 312c 2059 2c20  (self.D, -1, Y, 
-00010bf0: 582c 2043 2929 0d0a 2020 2020 2020 2020  X, C))..        
-00010c00: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00010c10: 2020 2070 6869 203d 2070 6869 2e72 6573     phi = phi.res
-00010c20: 6861 7065 2828 542c 2059 2c20 582c 2043  hape((T, Y, X, C
-00010c30: 2929 0d0a 0d0a 2020 2020 2020 2020 6966  ))....        if
-00010c40: 2066 756e 6320 696e 2022 6376 3222 3a20   func in "cv2": 
-00010c50: 2023 204f 7065 6e43 5620 756e 7772 6170   # OpenCV unwrap
-00010c60: 7069 6e67 0d0a 2020 2020 2020 2020 2020  ping..          
-00010c70: 2020 2320 7061 7261 6d73 203d 2063 7632    # params = cv2
-00010c80: 2e70 6861 7365 5f75 6e77 7261 7070 696e  .phase_unwrappin
-00010c90: 675f 4869 7374 6f67 7261 6d50 6861 7365  g_HistogramPhase
-00010ca0: 556e 7772 6170 7069 6e67 5f50 6172 616d  Unwrapping_Param
-00010cb0: 7328 290d 0a20 2020 2020 2020 2020 2020  s()..           
-00010cc0: 2070 6172 616d 7320 3d20 6376 322e 7068   params = cv2.ph
-00010cd0: 6173 655f 756e 7772 6170 7069 6e67 2e48  ase_unwrapping.H
-00010ce0: 6973 746f 6772 616d 5068 6173 6555 6e77  istogramPhaseUnw
-00010cf0: 7261 7070 696e 672e 5061 7261 6d73 2829  rapping.Params()
-00010d00: 0d0a 2020 2020 2020 2020 2020 2020 7061  ..            pa
-00010d10: 7261 6d73 2e68 6569 6768 7420 3d20 590d  rams.height = Y.
-00010d20: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-00010d30: 616d 732e 7769 6474 6820 3d20 580d 0a20  ams.width = X.. 
-00010d40: 2020 2020 2020 2020 2020 2023 2075 6e77             # unw
-00010d50: 7261 7070 696e 675f 696e 7374 616e 6365  rapping_instance
-00010d60: 203d 2063 7632 2e70 6861 7365 5f75 6e77   = cv2.phase_unw
-00010d70: 7261 7070 696e 672e 4869 7374 6f67 7261  rapping.Histogra
-00010d80: 6d50 6861 7365 556e 7772 6170 7069 6e67  mPhaseUnwrapping
-00010d90: 5f63 7265 6174 6528 7061 7261 6d73 290d  _create(params).
-00010da0: 0a20 2020 2020 2020 2020 2020 2075 6e77  .            unw
-00010db0: 7261 7070 696e 675f 696e 7374 616e 6365  rapping_instance
-00010dc0: 203d 2063 7632 2e70 6861 7365 5f75 6e77   = cv2.phase_unw
-00010dd0: 7261 7070 696e 672e 4869 7374 6f67 7261  rapping.Histogra
-00010de0: 6d50 6861 7365 556e 7772 6170 7069 6e67  mPhaseUnwrapping
-00010df0: 2e63 7265 6174 6528 7061 7261 6d73 290d  .create(params).
-00010e00: 0a20 2020 2020 2020 2072 6567 203d 206e  .        reg = n
-00010e10: 702e 656d 7074 7928 2873 656c 662e 442c  p.empty((self.D,
-00010e20: 2059 2c20 582c 2043 292c 206e 702e 666c   Y, X, C), np.fl
-00010e30: 6f61 7433 3229 0d0a 0d0a 2020 2020 2020  oat32)....      
-00010e40: 2020 6966 2073 656c 662e 7665 7262 6f73    if self.verbos
-00010e50: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00010e60: 7265 7320 3d20 6e70 2e65 6d70 7479 2828  res = np.empty((
-00010e70: 7365 6c66 2e44 2c20 592c 2058 2c20 4329  self.D, Y, X, C)
-00010e80: 2c20 6e70 2e66 6c6f 6174 3332 290d 0a0d  , np.float32)...
-00010e90: 0a20 2020 2020 2020 2066 6f72 2064 2069  .        for d i
-00010ea0: 6e20 7261 6e67 6528 7365 6c66 2e44 293a  n range(self.D):
-00010eb0: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00010ec0: 2073 656c 662e 4b20 3d3d 2031 3a20 2023   self.K == 1:  #
-00010ed0: 2074 6f64 6f3a 2073 656c 662e 4b5b 645d   todo: self.K[d]
-00010ee0: 203d 3d20 310d 0a20 2020 2020 2020 2020   == 1..         
-00010ef0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-00010f00: 6572 2e69 6e66 6f28 6622 5370 6174 6961  er.info(f"Spatia
-00010f10: 6c20 7068 6173 6520 756e 7772 6170 7069  l phase unwrappi
-00010f20: 6e67 2069 6e20 3244 7b27 2066 6f72 2065  ng in 2D{' for e
-00010f30: 6163 6820 636f 6c6f 7220 696e 6465 7065  ach color indepe
-00010f40: 6e74 6c79 2720 6966 2043 203e 2031 2065  ntly' if C > 1 e
-00010f50: 6c73 6520 2727 7d2e 2229 0d0a 2020 2020  lse ''}.")..    
-00010f60: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-00010f70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010f80: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
-00010f90: 6622 5370 6174 6961 6c20 7068 6173 6520  f"Spatial phase 
-00010fa0: 756e 7772 6170 7069 6e67 2069 6e20 3344  unwrapping in 3D
-00010fb0: 7b27 2066 6f72 2065 6163 6820 636f 6c6f  {' for each colo
-00010fc0: 7220 696e 6465 7065 6e74 6c79 2720 6966  r indepently' if
-00010fd0: 2043 203e 2031 2065 6c73 6520 2727 7d2e   C > 1 else ''}.
-00010fe0: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
-00010ff0: 2020 2020 6675 6e63 203d 2022 736b 6922      func = "ski"
-00011000: 2020 2320 746f 646f 3a20 3344 2053 5055    # todo: 3D SPU
-00011010: 2077 6974 6820 4f70 656e 4356 3f0d 0a0d   with OpenCV?...
-00011020: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00011030: 2063 2069 6e20 7261 6e67 6528 4329 3a0d   c in range(C):.
-00011040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011050: 2069 6620 5820 3d3d 2031 3a0d 0a20 2020   if X == 1:..   
-00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011070: 2072 6567 5b64 2c20 3a2c 203a 2c20 635d   reg[d, :, :, c]
-00011080: 203d 206e 702e 756e 7772 6170 2870 6869   = np.unwrap(phi
-00011090: 5b64 2c20 3a2c 203a 2c20 635d 2c20 6178  [d, :, :, c], ax
-000110a0: 6973 3d31 290d 0a20 2020 2020 2020 2020  is=1)..         
-000110b0: 2020 2020 2020 2065 6c69 6620 5920 3d3d         elif Y ==
-000110c0: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
-000110d0: 2020 2020 2020 2020 2072 6567 5b64 2c20           reg[d, 
-000110e0: 3a2c 203a 2c20 635d 203d 206e 702e 756e  :, :, c] = np.un
-000110f0: 7772 6170 2870 6869 5b64 2c20 3a2c 203a  wrap(phi[d, :, :
-00011100: 2c20 635d 2c20 6178 6973 3d30 290d 0a20  , c], axis=0).. 
-00011110: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011120: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-00011130: 2020 2020 2020 2020 2020 6966 2066 756e            if fun
-00011140: 6320 696e 2022 6376 3222 3a20 2023 204f  c in "cv2":  # O
-00011150: 7065 6e43 5620 616c 676f 7269 7468 6d20  penCV algorithm 
-00011160: 6973 2075 7375 616c 6c79 2066 6173 7465  is usually faste
-00011170: 722c 2062 7574 2063 616e 2062 6520 6d75  r, but can be mu
-00011180: 6368 2073 6c6f 7765 7220 696e 206e 6f69  ch slower in noi
-00011190: 7379 2069 6d61 6765 730d 0a20 2020 2020  sy images..     
-000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111b0: 2020 2023 2064 7479 7065 206d 7573 7420     # dtype must 
-000111c0: 6265 206e 702e 666c 6f61 7433 3220 2023  be np.float32  #
-000111d0: 2074 6f64 6f3a 2074 6573 7420 7468 6973   todo: test this
-000111e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000111f0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00011200: 6e73 7461 6e63 6528 422c 206e 702e 6e64  nstance(B, np.nd
-00011210: 6172 7261 7929 2061 6e64 2076 7368 6170  array) and vshap
-00011220: 6528 4229 2e73 6861 7065 203d 3d20 7068  e(B).shape == ph
-00011230: 692e 7368 6170 653a 0d0a 2020 2020 2020  i.shape:..      
-00011240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011250: 2020 2020 2020 2320 746f 646f 3a20 7377        # todo: sw
-00011260: 6170 6178 6573 0d0a 2020 2020 2020 2020  apaxes..        
-00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011280: 2020 2020 534e 5220 3d20 7365 6c66 2e42      SNR = self.B
-00011290: 5b64 2c20 3a2c 203a 2c20 635d 202f 2073  [d, :, :, c] / s
-000112a0: 656c 662e 7569 0d0a 2020 2020 2020 2020  elf.ui..        
-000112b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112c0: 2020 2020 7570 6920 3d20 6e70 2e73 7172      upi = np.sqr
-000112d0: 7428 3229 202f 206e 702e 7371 7274 2873  t(2) / np.sqrt(s
-000112e0: 656c 662e 4d29 202f 206e 702e 7371 7274  elf.M) / np.sqrt
-000112f0: 2873 656c 662e 5f4e 2920 2f20 534e 5220  (self._N) / SNR 
-00011300: 2023 206c 6f63 616c 2070 6861 7365 2075   # local phase u
-00011310: 6e63 6572 7461 696e 7469 6573 0d0a 2020  ncertainties..  
-00011320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011330: 2020 2020 2020 2020 2020 7570 696e 203d            upin =
-00011340: 2075 7069 202f 2028 3220 2a20 6e70 2e70   upi / (2 * np.p
-00011350: 6929 2020 2320 6e6f 726d 616c 697a 6564  i)  # normalized
-00011360: 206c 6f63 616c 2070 6861 7365 2075 6e63   local phase unc
-00011370: 6572 7461 696e 7469 6573 0d0a 2020 2020  ertainties..    
-00011380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011390: 2020 2020 2020 2020 7578 6920 3d20 7570          uxi = up
-000113a0: 696e 202a 2073 656c 662e 5f6c 5b64 5d20  in * self._l[d] 
-000113b0: 2023 206c 6f63 616c 2070 6f73 6974 696f   # local positio
-000113c0: 6e61 6c20 756e 6365 7274 6169 6e74 6965  nal uncertaintie
-000113d0: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
-000113e0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000113f0: 7820 3d20 6e70 2e73 7172 7428 0d0a 2020  x = np.sqrt(..  
-00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011410: 2020 2020 2020 2020 2020 2020 2020 3120                1 
-00011420: 2f20 6e70 2e73 756d 2831 202f 2075 7869  / np.sum(1 / uxi
-00011430: 2a2a 3229 0d0a 2020 2020 2020 2020 2020  **2)..          
-00011440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011450: 2020 2920 2023 2067 6c6f 6261 6c20 7068    )  # global ph
-00011460: 6173 6520 756e 6365 7274 6169 6e74 7920  ase uncertainty 
-00011470: 2862 7920 696e 7665 7273 6520 7661 7269  (by inverse vari
-00011480: 616e 6365 2077 6569 6768 7469 6e67 206f  ance weighting o
-00011490: 6620 7578 6929 0d0a 2020 2020 2020 2020  f uxi)..        
-000114a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114b0: 2020 2020 6d61 736b 203d 206e 702e 6173      mask = np.as
-000114c0: 7479 7065 2875 7820 3c20 302e 352c 2063  type(ux < 0.5, c
-000114d0: 6f70 793d 4661 6c73 6529 2020 2320 746f  opy=False)  # to
-000114e0: 646f 3a20 7768 6963 6820 6c69 6d69 743f  do: which limit?
-000114f0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00011500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011510: 7265 675b 642c 203a 2c20 3a2c 2063 5d20  reg[d, :, :, c] 
-00011520: 3d20 756e 7772 6170 7069 6e67 5f69 6e73  = unwrapping_ins
-00011530: 7461 6e63 652e 756e 7772 6170 5068 6173  tance.unwrapPhas
-00011540: 654d 6170 280d 0a20 2020 2020 2020 2020  eMap(..         
-00011550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011560: 2020 2020 2020 2070 6869 5b64 2c20 3a2c         phi[d, :,
-00011570: 203a 2c20 635d 2c20 6d61 736b 0d0a 2020   :, c], mask..  
-00011580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011590: 2020 2020 2020 2020 2020 2920 2023 2074            )  # t
-000115a0: 6f64 6f3a 2074 6573 7420 7468 6973 0d0a  odo: test this..
-000115b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115c0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-000115d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115e0: 2020 2020 2020 2020 2020 2072 6567 5b64             reg[d
-000115f0: 2c20 3a2c 203a 2c20 635d 203d 2075 6e77  , :, :, c] = unw
-00011600: 7261 7070 696e 675f 696e 7374 616e 6365  rapping_instance
-00011610: 2e75 6e77 7261 7050 6861 7365 4d61 7028  .unwrapPhaseMap(
-00011620: 7068 695b 642c 203a 2c20 3a2c 2063 5d29  phi[d, :, :, c])
-00011630: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00011640: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00011650: 656c 662e 7665 7262 6f73 653a 0d0a 2020  elf.verbose:..  
-00011660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011670: 2020 2020 2020 2020 2020 7265 735b 642c            res[d,
-00011680: 203a 2c20 3a2c 2063 5d20 3d20 756e 7772   :, :, c] = unwr
-00011690: 6170 7069 6e67 5f69 6e73 7461 6e63 652e  apping_instance.
-000116a0: 6765 7449 6e76 6572 7365 5265 6c69 6162  getInverseReliab
-000116b0: 696c 6974 794d 6170 2829 2020 2320 746f  ilityMap()  # to
-000116c0: 646f 3a20 7465 7374 2074 6869 730d 0a20  do: test this.. 
-000116d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116e0: 2020 2020 2020 2020 2020 2023 2074 6f64             # tod
-000116f0: 6f3a 2072 6573 2076 732e 2072 656c 0d0a  o: res vs. rel..
-00011700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011710: 2020 2020 656c 7365 3a20 2023 2053 6369      else:  # Sci
-00011720: 6b69 742d 696d 6167 6520 616c 676f 7269  kit-image algori
-00011730: 7468 6d20 6973 2073 6c6f 7765 7220 6275  thm is slower bu
-00011740: 7420 6465 6c69 7665 7273 2062 6574 7465  t delivers bette
-00011750: 7220 7265 7375 6c74 7320 6f6e 2065 6467  r results on edg
-00011760: 6573 0d0a 2020 2020 2020 2020 2020 2020  es..            
-00011770: 2020 2020 2020 2020 2020 2020 7265 675b              reg[
-00011780: 642c 203a 2c20 3a2c 2063 5d20 3d20 736b  d, :, :, c] = sk
-00011790: 692e 7265 7374 6f72 6174 696f 6e2e 756e  i.restoration.un
-000117a0: 7772 6170 5f70 6861 7365 2870 6869 5b64  wrap_phase(phi[d
-000117b0: 2c20 3a2c 203a 2c20 635d 290d 0a20 2020  , :, :, c])..   
-000117c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117d0: 2020 2020 2023 2074 6f64 6f3a 2072 6573       # todo: res
-000117e0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-000117f0: 7265 676d 696e 203d 206e 702e 616d 696e  regmin = np.amin
-00011800: 2872 6567 5b64 5d29 0d0a 2020 2020 2020  (reg[d])..      
-00011810: 2020 2020 2020 6966 2072 6567 6d69 6e20        if regmin 
-00011820: 3c20 303a 0d0a 2020 2020 2020 2020 2020  < 0:..          
-00011830: 2020 2020 2020 7265 675b 645d 202d 3d20        reg[d] -= 
-00011840: 7265 676d 696e 0d0a 0d0a 2020 2020 2020  regmin....      
-00011850: 2020 7265 6720 2a3d 2073 656c 662e 5f6c    reg *= self._l
-00011860: 5b3a 2c20 302c 204e 6f6e 652c 204e 6f6e  [:, 0, None, Non
-00011870: 652c 204e 6f6e 655d 202f 2028 0d0a 2020  e, None] / (..  
-00011880: 2020 2020 2020 2020 2020 3220 2a20 6e70            2 * np
-00011890: 2e70 690d 0a20 2020 2020 2020 2029 2020  .pi..        )  
-000118a0: 2320 746f 646f 3a20 7768 6174 2069 6620  # todo: what if 
-000118b0: 6361 6d20 6973 2039 30c2 b020 6167 6169  cam is 90.. agai
-000118c0: 6e73 7420 7363 7265 656e 3f20 616c 736f  nst screen? also
-000118d0: 2073 656c 662e 726f 6c6c 6178 6973 0d0a   self.rollaxis..
-000118e0: 0d0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-000118f0: 6f67 6765 722e 6465 6275 6728 6622 7b73  ogger.debug(f"{s
-00011900: 6928 7469 6d65 2e70 6572 665f 636f 756e  i(time.perf_coun
-00011910: 7465 7228 2920 2d20 7430 297d 7322 290d  ter() - t0)}s").
-00011920: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
-00011930: 6e20 7265 670d 0a0d 0a20 2020 2040 7374  n reg....    @st
-00011940: 6174 6963 6d65 7468 6f64 0d0a 2020 2020  aticmethod..    
-00011950: 6465 6620 756e 7772 6170 2870 6869 3a20  def unwrap(phi: 
-00011960: 6e70 2e6e 6461 7272 6179 2c20 6d61 736b  np.ndarray, mask
-00011970: 3a20 6e70 2e6e 6461 7272 6179 203d 204e  : np.ndarray = N
-00011980: 6f6e 652c 2066 756e 633a 2073 7472 203d  one, func: str =
-00011990: 2022 736b 6922 2920 2d3e 206e 702e 6172   "ski") -> np.ar
-000119a0: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
-000119b0: 2255 6e77 7261 7020 7068 6173 6520 6d61  "Unwrap phase ma
-000119c0: 7073 2073 7061 6369 616c 6c79 2e0d 0a0d  ps spacially....
-000119d0: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-000119e0: 6572 730d 0a20 2020 2020 2020 202d 2d2d  ers..        ---
-000119f0: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
-00011a00: 2070 6869 203a 206e 702e 6e64 6172 7261   phi : np.ndarra
-00011a10: 790d 0a20 2020 2020 2020 2020 2020 2050  y..            P
-00011a20: 6861 7365 206d 6170 7320 746f 2075 6e77  hase maps to unw
-00011a30: 7261 7020 7370 6174 6961 6c6c 792c 2073  rap spatially, s
-00011a40: 7461 636b 6564 2061 6c6f 6e67 2074 6865  tacked along the
-00011a50: 2066 6972 7374 2064 696d 656e 7369 6f6e   first dimension
-00011a60: 2e0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
-00011a70: 7420 6973 2072 6573 6861 7065 6420 746f  t is reshaped to
-00011a80: 2076 6964 656f 7368 6170 6520 2866 7261   videoshape (fra
-00011a90: 6d65 7320 6054 602c 2068 6569 6768 7420  mes `T`, height 
-00011aa0: 6059 602c 2077 6964 7468 2060 5860 2c20  `Y`, width `X`, 
-00011ab0: 636f 6c6f 7220 6368 616e 6e65 6c73 2060  color channels `
-00011ac0: 4360 2920 6265 666f 7265 2070 726f 6365  C`) before proce
-00011ad0: 7373 696e 672e 0d0a 2020 2020 2020 2020  ssing...        
-00011ae0: 2020 2020 5468 6520 6672 616d 6573 2028      The frames (
-00011af0: 6669 7273 7420 6469 6d65 6e73 696f 6e29  first dimension)
-00011b00: 2061 7320 7765 6c6c 2074 6865 2063 6f6c   as well the col
-00011b10: 6f72 2063 6861 6e6e 656c 7320 286c 6173  or channels (las
-00011b20: 7420 6469 6d65 6e73 696f 6e29 0d0a 2020  t dimension)..  
-00011b30: 2020 2020 2020 2020 2020 6172 6520 756e            are un
-00011b40: 7772 6170 7065 6420 7365 7061 7261 7465  wrapped separate
-00011b50: 6c79 2e0d 0a0d 0a20 2020 2020 2020 206d  ly.....        m
-00011b60: 6173 6b20 3a20 6e70 2e6e 6461 7272 6179  ask : np.ndarray
-00011b70: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
-00011b80: 2020 2020 2020 2020 4d61 736b 2069 6d61          Mask ima
-00011b90: 6765 2077 6974 6820 6474 7970 6520 276e  ge with dtype 'n
-00011ba0: 702e 7569 6e74 3827 2075 7365 6420 7768  p.uint8' used wh
-00011bb0: 656e 2073 6f6d 6520 7069 7865 6c73 2064  en some pixels d
-00011bc0: 6f20 6e6f 7420 686f 6c64 2061 6e79 2070  o not hold any p
-00011bd0: 6861 7365 2069 6e66 6f72 6d61 7469 6f6e  hase information
-00011be0: 2e0d 0a0d 0a20 2020 2020 2020 2066 756e  .....        fun
-00011bf0: 6320 3a20 7374 722c 206f 7074 696f 6e61  c : str, optiona
-00011c00: 6c0d 0a20 2020 2020 2020 2020 2020 2055  l..            U
-00011c10: 6e77 7261 7070 696e 6720 6675 6e63 7469  nwrapping functi
-00011c20: 6f6e 2074 6f20 7573 652e 2054 6865 2064  on to use. The d
-00011c30: 6566 6175 6c74 2069 7320 2773 6b69 272e  efault is 'ski'.
-00011c40: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00011c50: 2d20 2773 6b69 273a 2060 5363 696b 6974  - 'ski': `Scikit
-00011c60: 2d69 6d61 6765 5b31 5d5f 203c 6874 7470  -image[1]_ <http
-00011c70: 733a 2f2f 7363 696b 6974 2d69 6d61 6765  s://scikit-image
-00011c80: 2e6f 7267 2f64 6f63 732f 7374 6162 6c65  .org/docs/stable
-00011c90: 2f61 7574 6f5f 6578 616d 706c 6573 2f66  /auto_examples/f
-00011ca0: 696c 7465 7273 2f70 6c6f 745f 7068 6173  ilters/plot_phas
-00011cb0: 655f 756e 7772 6170 2e68 746d 6c3e 605f  e_unwrap.html>`_
-00011cc0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00011cd0: 2d20 656c 7365 3a20 604f 7065 6e43 565b  - else: `OpenCV[
-00011ce0: 325d 5f20 3c68 7474 7073 3a2f 2f64 6f63  2]_ <https://doc
-00011cf0: 732e 6f70 656e 6376 2e6f 7267 2f34 2e37  s.opencv.org/4.7
-00011d00: 2e30 2f64 662f 6433 612f 6772 6f75 705f  .0/df/d3a/group_
-00011d10: 5f70 6861 7365 5f5f 756e 7772 6170 7069  _phase__unwrappi
-00011d20: 6e67 2e68 746d 6c3e 605f 0d0a 0d0a 2020  ng.html>`_....  
-00011d30: 2020 2020 2020 5265 7475 726e 730d 0a20        Returns.. 
-00011d40: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0d0a         -------..
-00011d50: 2020 2020 2020 2020 756e 7772 6170 7065          unwrappe
-00011d60: 6420 3a20 6e70 2e6e 6461 7272 6179 0d0a  d : np.ndarray..
-00011d70: 2020 2020 2020 2020 2020 2020 556e 7772              Unwr
-00011d80: 6170 7065 6420 7068 6173 6520 6d61 7028  apped phase map(
-00011d90: 7329 2e0d 0a0d 0a20 2020 2020 2020 2052  s).....        R
-00011da0: 6566 6572 656e 6365 730d 0a20 2020 2020  eferences..     
-00011db0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0d 0a20     ----------.. 
-00011dc0: 2020 2020 2020 202e 2e20 5b31 5d20 6048         .. [1] `H
-00011dd0: 6572 72c3 a165 7a20 6574 2061 6c2e 2c0d  err..ez et al.,.
-00011de0: 0a20 2020 2020 2020 2022 4661 7374 2074  .        "Fast t
-00011df0: 776f 2d64 696d 656e 7369 6f6e 616c 2070  wo-dimensional p
-00011e00: 6861 7365 2d75 6e77 7261 7070 696e 6720  hase-unwrapping 
-00011e10: 616c 676f 7269 7468 6d20 6261 7365 6420  algorithm based 
-00011e20: 6f6e 2073 6f72 7469 6e67 2062 7920 7265  on sorting by re
-00011e30: 6c69 6162 696c 6974 7920 666f 6c6c 6f77  liability follow
-00011e40: 696e 6720 6120 6e6f 6e63 6f6e 7469 6e75  ing a noncontinu
-00011e50: 6f75 7320 7061 7468 222c 0d0a 2020 2020  ous path",..    
-00011e60: 2020 2020 4170 706c 6965 6420 4f70 7469      Applied Opti
-00011e70: 6373 2c0d 0a20 2020 2020 2020 2032 3030  cs,..        200
-00011e80: 322e 0d0a 2020 2020 2020 2020 3c68 7474  2...        <htt
-00011e90: 7073 3a2f 2f64 6f69 2e6f 7267 2f31 302e  ps://doi.org/10.
-00011ea0: 3133 3634 2f41 4f2e 3431 2e30 3037 3433  1364/AO.41.00743
-00011eb0: 373e 605f 0d0a 0d0a 2020 2020 2020 2020  7>`_....        
-00011ec0: 2e2e 205b 325d 2060 4c65 6920 6574 2061  .. [2] `Lei et a
-00011ed0: 6c2e 2c0d 0a20 2020 2020 2020 2022 4120  l.,..        "A 
-00011ee0: 6e6f 7665 6c20 616c 676f 7269 7468 6d20  novel algorithm 
-00011ef0: 6261 7365 6420 6f6e 2068 6973 746f 6772  based on histogr
-00011f00: 616d 2070 726f 6365 7373 696e 6720 6f66  am processing of
-00011f10: 2072 656c 6961 6269 6c69 7479 2066 6f72   reliability for
-00011f20: 2074 776f 2d64 696d 656e 7369 6f6e 616c   two-dimensional
-00011f30: 2070 6861 7365 2075 6e77 7261 7070 696e   phase unwrappin
-00011f40: 6722 2c0d 0a20 2020 2020 2020 204f 7074  g",..        Opt
-00011f50: 696b 202d 2049 6e74 6572 6e61 7469 6f6e  ik - Internation
-00011f60: 616c 204a 6f75 726e 616c 2066 6f72 204c  al Journal for L
-00011f70: 6967 6874 2061 6e64 2045 6c65 6374 726f  ight and Electro
-00011f80: 6e20 4f70 7469 6373 2c0d 0a20 2020 2020  n Optics,..     
-00011f90: 2020 2032 3031 352e 0d0a 2020 2020 2020     2015...      
-00011fa0: 2020 3c68 7474 7073 3a2f 2f64 6f69 2e6f    <https://doi.o
-00011fb0: 7267 2f31 302e 3130 3136 2f6a 2e69 6a6c  rg/10.1016/j.ijl
-00011fc0: 656f 2e32 3031 352e 3034 2e30 3730 3e60  eo.2015.04.070>`
-00011fd0: 5f0d 0a20 2020 2020 2020 2022 2222 0d0a  _..        """..
-00011fe0: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
-00011ff0: 7265 6665 7265 6e63 6573 0d0a 0d0a 2020  references....  
-00012000: 2020 2020 2020 542c 2059 2c20 582c 2043        T, Y, X, C
-00012010: 203d 2076 7368 6170 6528 7068 6929 2e73   = vshape(phi).s
-00012020: 6861 7065 0d0a 2020 2020 2020 2020 7068  hape..        ph
-00012030: 6920 3d20 7068 692e 7265 7368 6170 6528  i = phi.reshape(
-00012040: 2854 2c20 592c 2058 2c20 4329 290d 0a0d  (T, Y, X, C))...
-00012050: 0a20 2020 2020 2020 2069 6620 6675 6e63  .        if func
-00012060: 2069 6e20 2263 7632 223a 2020 2320 4f70   in "cv2":  # Op
-00012070: 656e 4356 2075 6e77 7261 7070 696e 670d  enCV unwrapping.
-00012080: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
-00012090: 6172 616d 7320 3d20 6376 322e 7068 6173  arams = cv2.phas
-000120a0: 655f 756e 7772 6170 7069 6e67 5f48 6973  e_unwrapping_His
-000120b0: 746f 6772 616d 5068 6173 6555 6e77 7261  togramPhaseUnwra
-000120c0: 7070 696e 675f 5061 7261 6d73 2829 0d0a  pping_Params()..
-000120d0: 2020 2020 2020 2020 2020 2020 7061 7261              para
-000120e0: 6d73 203d 2063 7632 2e70 6861 7365 5f75  ms = cv2.phase_u
-000120f0: 6e77 7261 7070 696e 672e 4869 7374 6f67  nwrapping.Histog
-00012100: 7261 6d50 6861 7365 556e 7772 6170 7069  ramPhaseUnwrappi
-00012110: 6e67 2e50 6172 616d 7328 290d 0a20 2020  ng.Params()..   
-00012120: 2020 2020 2020 2020 2070 6172 616d 732e           params.
-00012130: 6865 6967 6874 203d 2059 0d0a 2020 2020  height = Y..    
-00012140: 2020 2020 2020 2020 7061 7261 6d73 2e77          params.w
-00012150: 6964 7468 203d 2058 0d0a 2020 2020 2020  idth = X..      
-00012160: 2020 2020 2020 2320 756e 7772 6170 7069        # unwrappi
-00012170: 6e67 5f69 6e73 7461 6e63 6520 3d20 6376  ng_instance = cv
-00012180: 322e 7068 6173 655f 756e 7772 6170 7069  2.phase_unwrappi
-00012190: 6e67 2e48 6973 746f 6772 616d 5068 6173  ng.HistogramPhas
-000121a0: 6555 6e77 7261 7070 696e 675f 6372 6561  eUnwrapping_crea
-000121b0: 7465 2870 6172 616d 7329 0d0a 2020 2020  te(params)..    
-000121c0: 2020 2020 2020 2020 756e 7772 6170 7069          unwrappi
-000121d0: 6e67 5f69 6e73 7461 6e63 6520 3d20 6376  ng_instance = cv
-000121e0: 322e 7068 6173 655f 756e 7772 6170 7069  2.phase_unwrappi
-000121f0: 6e67 2e48 6973 746f 6772 616d 5068 6173  ng.HistogramPhas
-00012200: 6555 6e77 7261 7070 696e 672e 6372 6561  eUnwrapping.crea
-00012210: 7465 2870 6172 616d 7329 0d0a 0d0a 2020  te(params)....  
-00012220: 2020 2020 2020 7577 7220 3d20 6e70 2e65        uwr = np.e
-00012230: 6d70 7479 5f6c 696b 6528 7068 6929 0d0a  mpty_like(phi)..
-00012240: 2020 2020 2020 2020 666f 7220 7420 696e          for t in
-00012250: 2072 616e 6765 2854 293a 0d0a 2020 2020   range(T):..    
-00012260: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
-00012270: 2072 616e 6765 2843 293a 0d0a 2020 2020   range(C):..    
-00012280: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00012290: 756e 6320 696e 2022 6376 3222 3a20 2023  unc in "cv2":  #
-000122a0: 204f 7065 6e43 5620 616c 676f 7269 7468   OpenCV algorith
-000122b0: 6d20 6973 2075 7375 616c 6c79 2066 6173  m is usually fas
-000122c0: 7465 722c 2062 7574 2063 616e 2062 6520  ter, but can be 
-000122d0: 6d75 6368 2073 6c6f 7765 7220 696e 206e  much slower in n
-000122e0: 6f69 7379 2069 6d61 6765 730d 0a20 2020  oisy images..   
-000122f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012300: 2023 2064 7479 7065 206d 7573 7420 6265   # dtype must be
-00012310: 206e 702e 666c 6f61 7433 3220 2023 2074   np.float32  # t
-00012320: 6f64 6f3a 2074 6573 7420 7468 6973 0d0a  odo: test this..
-00012330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012340: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00012350: 6528 6d61 736b 2c20 6e70 2e6e 6461 7272  e(mask, np.ndarr
-00012360: 6179 2920 616e 6420 7673 6861 7065 286d  ay) and vshape(m
-00012370: 6173 6b29 2e73 6861 7065 203d 3d20 7068  ask).shape == ph
-00012380: 692e 7368 6170 653a 0d0a 2020 2020 2020  i.shape:..      
-00012390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123a0: 2020 6d61 736b 203d 2076 7368 6170 6528    mask = vshape(
-000123b0: 6d61 736b 290d 0a20 2020 2020 2020 2020  mask)..         
-000123c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000123d0: 6173 6b20 3d20 6e70 2e61 7374 7970 6528  ask = np.astype(
-000123e0: 6d61 736b 5b74 2c20 3a2c 203a 2c20 635d  mask[t, :, :, c]
-000123f0: 2c20 636f 7079 3d46 616c 7365 290d 0a20  , copy=False).. 
-00012400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012410: 2020 2020 2020 2075 7772 5b74 2c20 3a2c         uwr[t, :,
-00012420: 203a 2c20 635d 203d 2075 6e77 7261 7070   :, c] = unwrapp
-00012430: 696e 675f 696e 7374 616e 6365 2e75 6e77  ing_instance.unw
-00012440: 7261 7050 6861 7365 4d61 7028 7068 695b  rapPhaseMap(phi[
-00012450: 742c 203a 2c20 3a2c 2063 5d2c 206d 6173  t, :, :, c], mas
-00012460: 6b29 0d0a 2020 2020 2020 2020 2020 2020  k)..            
-00012470: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-00012480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012490: 2020 2020 2020 2075 7772 5b74 2c20 3a2c         uwr[t, :,
-000124a0: 203a 2c20 635d 203d 2075 6e77 7261 7070   :, c] = unwrapp
-000124b0: 696e 675f 696e 7374 616e 6365 2e75 6e77  ing_instance.unw
-000124c0: 7261 7050 6861 7365 4d61 7028 7068 695b  rapPhaseMap(phi[
-000124d0: 742c 203a 2c20 3a2c 2063 5d29 0d0a 0d0a  t, :, :, c])....
-000124e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124f0: 2020 2020 2320 2320 6474 7970 6520 6f66      # # dtype of
-00012500: 2070 6861 7365 6d75 7374 2062 6520 6e70   phasemust be np
-00012510: 2e75 696e 7438 2c20 6474 7970 6520 6f66  .uint8, dtype of
-00012520: 2073 6861 646f 775f 6d61 736b 206e 702e   shadow_mask np.
-00012530: 7569 6e74 3820 2023 2074 6f64 6f3a 2074  uint8  # todo: t
-00012540: 6573 7420 7468 6973 0d0a 2020 2020 2020  est this..      
-00012550: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00012560: 7265 675b 642c 203a 2c20 3a2c 2063 5d20  reg[d, :, :, c] 
-00012570: 3d20 756e 7772 6170 7069 6e67 5f69 6e73  = unwrapping_ins
-00012580: 7461 6e63 652e 756e 7772 6170 5068 6173  tance.unwrapPhas
-00012590: 654d 6170 2870 6869 5b64 2c20 3a2c 203a  eMap(phi[d, :, :
-000125a0: 2c20 635d 2c20 7368 6164 6f77 4d61 736b  , c], shadowMask
-000125b0: 3d73 6861 646f 775f 6d61 736b 290d 0a20  =shadow_mask).. 
-000125c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000125d0: 6c73 653a 2020 2320 5363 696b 6974 2d69  lse:  # Scikit-i
-000125e0: 6d61 6765 2061 6c67 6f72 6974 686d 2069  mage algorithm i
-000125f0: 7320 736c 6f77 6572 2062 7574 2064 656c  s slower but del
-00012600: 6976 6572 7320 6265 7474 6572 2072 6573  ivers better res
-00012610: 756c 7473 206f 6e20 6564 6765 730d 0a20  ults on edges.. 
-00012620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012630: 2020 2075 7772 5b74 2c20 3a2c 203a 2c20     uwr[t, :, :, 
-00012640: 635d 203d 2073 6b69 2e72 6573 746f 7261  c] = ski.restora
-00012650: 7469 6f6e 2e75 6e77 7261 705f 7068 6173  tion.unwrap_phas
-00012660: 6528 7068 695b 742c 203a 2c20 3a2c 2063  e(phi[t, :, :, c
-00012670: 5d29 0d0a 0d0a 2020 2020 2020 2020 7265  ])....        re
-00012680: 7475 726e 2075 7772 0d0a 0d0a 2020 2020  turn uwr....    
-00012690: 6465 6620 7265 6d61 7028 0d0a 2020 2020  def remap(..    
-000126a0: 2020 2020 7365 6c66 2c0d 0a20 2020 2020      self,..     
-000126b0: 2020 2078 693a 206e 702e 6e64 6172 7261     xi: np.ndarra
-000126c0: 792c 0d0a 2020 2020 2020 2020 423a 206e  y,..        B: n
-000126d0: 702e 6e64 6172 7261 7920 3d20 4e6f 6e65  p.ndarray = None
-000126e0: 2c0d 0a20 2020 2020 2020 2064 783a 2066  ,..        dx: f
-000126f0: 6c6f 6174 203d 2031 2c0d 0a20 2020 2020  loat = 1,..     
-00012700: 2020 2070 3a20 696e 7420 3d20 322c 0d0a     p: int = 2,..
-00012710: 2020 2020 2020 2020 6d6f 6465 3a20 7374          mode: st
-00012720: 7220 3d20 2266 6173 7422 2c0d 0a20 2020  r = "fast",..   
-00012730: 2029 202d 3e20 6e70 2e6e 6461 7272 6179   ) -> np.ndarray
-00012740: 3a0d 0a20 2020 2020 2020 2022 2222 536f  :..        """So
-00012750: 7572 6365 2061 6374 6976 6174 696f 6e20  urce activation 
-00012760: 6865 6174 6d61 702e 0d0a 0d0a 2020 2020  heatmap.....    
-00012770: 2020 2020 5468 6520 6465 636f 6465 6420      The decoded 
-00012780: 636f 6f72 6469 6e61 7465 7320 2868 6176  coordinates (hav
-00012790: 696e 6720 7375 622d 7069 7865 6c20 6163  ing sub-pixel ac
-000127a0: 6375 7261 6379 290d 0a20 2020 2020 2020  curacy)..       
-000127b0: 2061 7265 206d 6170 7065 6420 6672 6f6d   are mapped from
-000127c0: 2074 6865 2063 616d 6572 6120 6772 6964   the camera grid
-000127d0: 0d0a 2020 2020 2020 2020 746f 2069 6e74  ..        to int
-000127e0: 6567 6572 2070 6f73 6974 696f 6e73 206f  eger positions o
-000127f0: 6e20 7468 6520 7363 7265 656e 2067 7269  n the screen gri
-00012800: 640d 0a20 2020 2020 2020 2077 6974 6820  d..        with 
-00012810: 7765 6967 6874 7320 6672 6f6d 2074 6865  weights from the
-00012820: 206d 6f64 756c 6174 696f 6e2e 0d0a 0d0a   modulation.....
-00012830: 2020 2020 2020 2020 5468 6973 2079 6965          This yie
-00012840: 6c64 7320 7468 6520 736f 7572 6365 2061  lds the source a
-00012850: 6374 6976 6174 696f 6e20 6865 6174 6d61  ctivation heatma
-00012860: 703a 0d0a 2020 2020 2020 2020 6120 6772  p:..        a gr
-00012870: 6964 2072 6570 7265 7365 6e74 696e 6720  id representing 
-00012880: 7468 6520 7363 7265 656e 2028 6c69 6768  the screen (ligh
-00012890: 7420 736f 7572 6365 290d 0a20 2020 2020  t source)..     
-000128a0: 2020 2077 6974 6820 7468 6520 7069 7865     with the pixe
-000128b0: 6c20 7661 6c75 6573 2062 6569 6e67 2061  l values being a
-000128c0: 2072 656c 6174 6976 6520 6d65 6173 7572   relative measur
-000128d0: 650d 0a20 2020 2020 2020 206f 6620 686f  e..        of ho
-000128e0: 7720 6d75 6368 2061 2073 6372 6565 6e20  w much a screen 
-000128f0: 286c 6967 6874 2073 6f75 7263 6529 2070  (light source) p
-00012900: 6978 656c 2063 6f6e 7472 6962 7574 6564  ixel contributed
-00012910: 0d0a 2020 2020 2020 2020 746f 2074 6865  ..        to the
-00012920: 2065 7870 6f73 7572 6520 6f66 2074 6865   exposure of the
-00012930: 2063 616d 6572 6120 7365 6e73 6f72 2e0d   camera sensor..
-00012940: 0a0d 0a20 2020 2020 2020 2054 6865 2064  ...        The d
-00012950: 696d 656e 7369 6f6e 7320 6f66 2074 6865  imensions of the
-00012960: 2073 6372 6565 6e20 6172 6520 7461 6b65   screen are take
-00012970: 6e20 6672 6f6d 2074 6865 2060 4672 696e  n from the `Frin
-00012980: 6765 7360 2069 6e73 7461 6e63 652e 0d0a  ges` instance...
-00012990: 0d0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-000129a0: 7465 7273 0d0a 2020 2020 2020 2020 2d2d  ters..        --
-000129b0: 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020 2020  --------..      
-000129c0: 2020 7869 203a 206e 702e 6e64 6172 7261    xi : np.ndarra
-000129d0: 790d 0a20 2020 2020 2020 2020 2020 2052  y..            R
-000129e0: 6567 6973 7472 6174 696f 6e2c 2069 2e65  egistration, i.e
-000129f0: 2e20 7468 6520 6465 636f 6465 6420 7363  . the decoded sc
-00012a00: 7265 656e 2063 6f6f 7264 696e 6174 6573  reen coordinates
-00012a10: 2061 7320 7365 656e 2062 7920 7468 6520   as seen by the 
-00012a20: 6361 6d65 7261 2e0d 0a20 2020 2020 2020  camera...       
-00012a30: 2020 2020 2049 7420 6973 2072 6573 6861       It is resha
-00012a40: 7065 6420 746f 2076 6964 656f 7368 6170  ped to videoshap
-00012a50: 6520 2866 7261 6d65 7320 6054 602c 2068  e (frames `T`, h
-00012a60: 6569 6768 7420 6059 602c 2077 6964 7468  eight `Y`, width
-00012a70: 2060 5860 2c20 636f 6c6f 7220 6368 616e   `X`, color chan
-00012a80: 6e65 6c73 2060 4360 2920 6265 666f 7265  nels `C`) before
-00012a90: 2070 726f 6365 7373 696e 672e 0d0a 0d0a   processing.....
-00012aa0: 2020 2020 2020 2020 4220 3a20 6e70 2e6e          B : np.n
-00012ab0: 6461 7272 6179 2c20 6f70 7469 6f6e 616c  darray, optional
-00012ac0: 0d0a 2020 2020 2020 2020 2020 2020 4d6f  ..            Mo
-00012ad0: 6475 6c61 7469 6f6e 2e20 5573 6564 2066  dulation. Used f
-00012ae0: 6f72 2077 6569 6768 7469 6e67 2e0d 0a20  or weighting... 
-00012af0: 2020 2020 2020 2020 2020 2049 7420 6973             It is
-00012b00: 2072 6573 6861 7065 6420 746f 2076 6964   reshaped to vid
-00012b10: 656f 7368 6170 6520 2866 7261 6d65 7320  eoshape (frames 
-00012b20: 6054 602c 2068 6569 6768 7420 6059 602c  `T`, height `Y`,
-00012b30: 2077 6964 7468 2060 5860 2c20 636f 6c6f   width `X`, colo
-00012b40: 7220 6368 616e 6e65 6c73 2060 4360 2920  r channels `C`) 
-00012b50: 6265 666f 7265 2070 726f 6365 7373 696e  before processin
-00012b60: 672e 0d0a 2020 2020 2020 2020 2020 2020  g...            
-00012b70: 4966 2060 4260 2069 7320 6e6f 7420 6769  If `B` is not gi
-00012b80: 7665 6e2c 2065 7175 616c 2077 6569 6768  ven, equal weigh
-00012b90: 7473 2061 7265 2075 7365 642e 0d0a 0d0a  ts are used.....
-00012ba0: 2020 2020 2020 2020 6478 203a 2066 6c6f          dx : flo
-00012bb0: 6174 2c20 6f70 7469 6f6e 616c 0d0a 2020  at, optional..  
-00012bc0: 2020 2020 2020 2020 2020 4d61 676e 6966            Magnif
-00012bd0: 6963 6174 696f 6e3a 2053 697a 6520 6f66  ication: Size of
-00012be0: 206f 6e65 2063 616d 6572 6120 7069 7865   one camera pixe
-00012bf0: 6c2c 2070 726f 6a65 6374 6564 206f 6e74  l, projected ont
-00012c00: 6f20 7468 6520 7363 7265 656e 2c20 696e  o the screen, in
-00012c10: 2075 6e69 7473 206f 6620 7363 7265 656e   units of screen
-00012c20: 2070 6978 656c 732e 0d0a 2020 2020 2020   pixels...      
-00012c30: 2020 2020 2020 4465 6661 756c 7420 6973        Default is
-00012c40: 206f 6e65 2e0d 0a0d 0a20 2020 2020 2020   one.....       
-00012c50: 2070 203a 2069 6e74 2c20 6f70 7469 6f6e   p : int, option
-00012c60: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-00012c70: 506f 7765 7220 7061 7261 6d65 7465 722e  Power parameter.
-00012c80: 0d0a 2020 2020 2020 2020 2020 2020 4465  ..            De
-00012c90: 6661 756c 7420 6973 2074 776f 2e0d 0a0d  fault is two....
-00012ca0: 0a20 2020 2020 2020 206d 6f64 6520 3a20  .        mode : 
-00012cb0: 7374 722c 206f 7074 696f 6e61 6c0d 0a20  str, optional.. 
-00012cc0: 2020 2020 2020 2020 2020 2042 7920 6465             By de
-00012cd0: 6661 756c 742c 2066 6173 7420 7265 6d61  fault, fast rema
-00012ce0: 7070 696e 6720 6973 2061 7070 6c69 6564  pping is applied
-00012cf0: 2e0d 0a20 2020 2020 2020 2020 2020 2045  ...            E
-00012d00: 6c73 652c 2069 6e76 6572 7365 2064 6973  lse, inverse dis
-00012d10: 7461 6e63 6520 7765 6967 6874 6564 2072  tance weighted r
-00012d20: 656d 6170 7069 6e67 2069 7320 6170 706c  emapping is appl
-00012d30: 6965 642c 0d0a 2020 2020 2020 2020 2020  ied,..          
-00012d40: 2020 7768 6963 6820 6973 206d 6f72 6520    which is more 
-00012d50: 7072 6563 6973 6520 6275 7420 616c 736f  precise but also
-00012d60: 206d 6f72 6520 7469 6d65 2d63 6f6e 7375   more time-consu
-00012d70: 6d69 6e67 2e0d 0a0d 0a20 2020 2020 2020  ming.....       
-00012d80: 2052 6574 7572 6e73 0d0a 2020 2020 2020   Returns..      
-00012d90: 2020 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020    -------..     
-00012da0: 2020 2073 7263 203a 206e 702e 6e64 6172     src : np.ndar
-00012db0: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-00012dc0: 2053 6f75 7263 6520 6163 7469 7661 7469   Source activati
-00012dd0: 6f6e 2068 6561 746d 6170 2e0d 0a0d 0a20  on heatmap..... 
-00012de0: 2020 2020 2020 2045 7861 6d70 6c65 730d         Examples.
-00012df0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00012e00: 2d0d 0a20 2020 2020 2020 203e 3e3e 2069  -..        >>> i
-00012e10: 6d70 6f72 7420 6672 696e 6765 7320 6173  mport fringes as
-00012e20: 2066 726e 670d 0a20 2020 2020 2020 203e   frng..        >
-00012e30: 3e3e 2066 203d 2066 726e 672e 4672 696e  >> f = frng.Frin
-00012e40: 6765 7328 290d 0a20 2020 2020 2020 203e  ges()..        >
-00012e50: 3e3e 2049 203d 2066 2e65 6e63 6f64 6528  >> I = f.encode(
-00012e60: 290d 0a0d 0a20 2020 2020 2020 203e 3e3e  )....        >>>
-00012e70: 2041 2c20 422c 2078 203d 2066 2e64 6563   A, B, x = f.dec
-00012e80: 6f64 6528 4929 0d0a 0d0a 2020 2020 2020  ode(I)....      
-00012e90: 2020 3e3e 3e20 7372 6320 3d20 662e 7265    >>> src = f.re
-00012ea0: 6d61 7028 782c 2042 290d 0a20 2020 2020  map(x, B)..     
-00012eb0: 2020 2022 2222 0d0a 0d0a 2020 2020 2020     """....      
-00012ec0: 2020 7430 203d 2074 696d 652e 7065 7266    t0 = time.perf
-00012ed0: 5f63 6f75 6e74 6572 2829 0d0a 0d0a 2020  _counter()....  
-00012ee0: 2020 2020 2020 542c 2059 2c20 582c 2043        T, Y, X, C
-00012ef0: 203d 2076 7368 6170 6528 7869 292e 7368   = vshape(xi).sh
-00012f00: 6170 650d 0a0d 0a20 2020 2020 2020 2023  ape....        #
-00012f10: 2074 7269 6d20 420d 0a20 2020 2020 2020   trim B..       
-00012f20: 2069 6620 6973 696e 7374 616e 6365 2842   if isinstance(B
-00012f30: 2c20 6e70 2e6e 6461 7272 6179 293a 0d0a  , np.ndarray):..
-00012f40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00012f50: 7274 2078 692e 7368 6170 655b 313a 5d20  rt xi.shape[1:] 
-00012f60: 3d3d 2042 2e73 6861 7065 5b31 3a5d 2c20  == B.shape[1:], 
-00012f70: 2227 7869 2720 616e 6420 2742 2720 6861  "'xi' and 'B' ha
-00012f80: 7665 2064 6966 6665 7265 6e74 2077 6964  ve different wid
-00012f90: 7468 2c20 6865 6967 6874 206f 7220 6e75  th, height or nu
-00012fa0: 6d62 6572 206f 6620 636f 6c6f 7220 6368  mber of color ch
-00012fb0: 616e 6e65 6c73 220d 0a20 2020 2020 2020  annels"..       
-00012fc0: 2020 2020 2042 203d 2042 2e72 6573 6861       B = B.resha
-00012fd0: 7065 2828 2d31 2c20 592c 2058 2c20 4329  pe((-1, Y, X, C)
-00012fe0: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00012ff0: 2042 203d 206e 702e 6d61 7828 422c 2061   B = np.max(B, a
-00013000: 7869 733d 3029 0d0a 2020 2020 2020 2020  xis=0)..        
-00013010: 2020 2020 4220 3d20 6e70 2e6d 6561 6e28      B = np.mean(
-00013020: 422c 2061 7869 733d 3029 0d0a 0d0a 2020  B, axis=0)....  
-00013030: 2020 2020 2020 2320 7472 696d 2058 690d        # trim Xi.
-00013040: 0a20 2020 2020 2020 2078 6920 3d20 7869  .        xi = xi
-00013050: 2e72 6573 6861 7065 2828 2d31 2c20 592c  .reshape((-1, Y,
-00013060: 2058 2c20 4329 290d 0a20 2020 2020 2020   X, C))..       
-00013070: 2023 206e 702e 6d69 6e69 6d75 6d28 7869   # np.minimum(xi
-00013080: 2c20 7365 6c66 2e52 5b3a 2c20 4e6f 6e65  , self.R[:, None
-00013090: 2c20 4e6f 6e65 2c20 4e6f 6e65 5d20 2d20  , None, None] - 
-000130a0: 312c 206f 7574 3d78 6929 2020 2320 6369  1, out=xi)  # ci
-000130b0: 7263 756d 7665 6e74 7320 6173 7365 7274  rcumvents assert
-000130c0: 696f 6e20 696e 206e 6578 7420 6c69 6e65  ion in next line
-000130d0: 0d0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-000130e0: 2061 6c6c 280d 0a20 2020 2020 2020 2020   all(..         
-000130f0: 2020 206e 702e 616c 6c28 6e70 2e72 6f75     np.all(np.rou
-00013100: 6e64 286e 702e 6d61 7828 7869 5b64 5d29  nd(np.max(xi[d])
-00013110: 2920 3c3d 2073 656c 662e 525b 645d 202d  ) <= self.R[d] -
-00013120: 2031 2066 6f72 2064 2069 6e20 7261 6e67   1 for d in rang
-00013130: 6528 7365 6c66 2e44 2929 0d0a 2020 2020  e(self.D))..    
-00013140: 2020 2020 292c 2066 2243 6f6f 7264 696e      ), f"Coordin
-00013150: 6174 6573 2063 6f6e 7461 696e 2076 616c  ates contain val
-00013160: 7565 7320 3e20 7b73 656c 662e 5220 2d20  ues > {self.R - 
-00013170: 317d 3b20 6465 636f 6469 6e67 206d 6967  1}; decoding mig
-00013180: 6874 2062 6520 6572 726f 6e65 6f75 732e  ht be erroneous.
-00013190: 220d 0a20 2020 2020 2020 2069 6620 5420  "..        if T 
-000131a0: 3d3d 2031 3a0d 0a20 2020 2020 2020 2020  == 1:..         
-000131b0: 2020 2069 6620 7365 6c66 2e61 7869 7320     if self.axis 
-000131c0: 3d3d 2030 3a0d 0a20 2020 2020 2020 2020  == 0:..         
-000131d0: 2020 2020 2020 2023 2078 6920 3d20 6e70         # xi = np
-000131e0: 2e76 7374 6163 6b28 2878 692c 206e 702e  .vstack((xi, np.
-000131f0: 7a65 726f 735f 6c69 6b65 2878 6929 2929  zeros_like(xi)))
-00013200: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00013210: 2020 7869 203d 206e 702e 636f 6e63 6174    xi = np.concat
-00013220: 656e 6174 6528 2878 692c 206e 702e 7a65  enate((xi, np.ze
-00013230: 726f 735f 6c69 6b65 2878 6929 292c 2061  ros_like(xi)), a
-00013240: 7869 733d 3029 0d0a 2020 2020 2020 2020  xis=0)..        
-00013250: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-00013260: 2020 2020 2020 2020 2020 2023 2078 6920             # xi 
-00013270: 3d20 6e70 2e76 7374 6163 6b28 286e 702e  = np.vstack((np.
-00013280: 7a65 726f 735f 6c69 6b65 2878 6929 2c20  zeros_like(xi), 
-00013290: 7869 2929 0d0a 2020 2020 2020 2020 2020  xi))..          
-000132a0: 2020 2020 2020 7869 203d 206e 702e 636f        xi = np.co
-000132b0: 6e63 6174 656e 6174 6528 286e 702e 7a65  ncatenate((np.ze
-000132c0: 726f 735f 6c69 6b65 2878 6929 2c20 7869  ros_like(xi), xi
-000132d0: 292c 2061 7869 733d 3029 0d0a 0d0a 2020  ), axis=0)....  
-000132e0: 2020 2020 2020 6966 206d 6f64 6520 3d3d        if mode ==
-000132f0: 2022 6661 7374 223a 2020 2320 746f 646f   "fast":  # todo
-00013300: 3a20 7573 6520 7365 6c66 2e6d 6f64 650d  : use self.mode.
-00013310: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013320: 6e6f 7420 6973 696e 7374 616e 6365 2842  not isinstance(B
-00013330: 2c20 6e70 2e6e 6461 7272 6179 293a 0d0a  , np.ndarray):..
-00013340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013350: 4220 3d20 6e70 2e6f 6e65 7328 2859 2c20  B = np.ones((Y, 
-00013360: 582c 2043 292c 206e 702e 7569 6e74 3829  X, C), np.uint8)
-00013370: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00013380: 7372 6320 3d20 6e70 2e7a 6572 6f73 2828  src = np.zeros((
-00013390: 7365 6c66 2e59 2c20 7365 6c66 2e58 2c20  self.Y, self.X, 
-000133a0: 4329 2c20 6e70 2e66 6c6f 6174 3332 290d  C), np.float32).
-000133b0: 0a0d 0a20 2020 2020 2020 2020 2020 2069  ...            i
-000133c0: 6620 4661 6c73 653a 0d0a 2020 2020 2020  f False:..      
-000133d0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000133e0: 662e 696e 6465 7869 6e67 203d 3d20 2278  f.indexing == "x
-000133f0: 7922 3a0d 0a20 2020 2020 2020 2020 2020  y":..           
-00013400: 2020 2020 2020 2020 2078 6920 3d20 7869           xi = xi
-00013410: 2e73 7761 7061 7865 7328 312c 2032 2920  .swapaxes(1, 2) 
-00013420: 2023 2072 6574 7572 6e73 2061 2076 6965   # returns a vie
-00013430: 770d 0a20 2020 2020 2020 2020 2020 2020  w..             
-00013440: 2020 2069 6478 203d 2028 7869 202b 2030     idx = (xi + 0
-00013450: 2e35 292e 6173 7479 7065 2869 6e74 2c20  .5).astype(int, 
-00013460: 636f 7079 3d46 616c 7365 290d 0a0d 0a20  copy=False).... 
-00013470: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013480: 6f72 2063 2069 6e20 7261 6e67 6528 4329  or c in range(C)
-00013490: 3a20 2023 206c 6f6f 7069 6e67 2074 6872  :  # looping thr
-000134a0: 6f75 6768 2063 6f6c 6f72 2063 6861 6e6e  ough color chann
-000134b0: 656c 7320 7265 6475 6365 7320 6d65 6d6f  els reduces memo
-000134c0: 7279 2063 6f6e 7375 6d70 7469 6f6e 0d0a  ry consumption..
-000134d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134e0: 2020 2020 7372 635b 6964 785b 315d 2e72      src[idx[1].r
-000134f0: 6176 656c 2829 2c20 6964 785b 305d 2e72  avel(), idx[0].r
-00013500: 6176 656c 2829 2c20 635d 202b 3d20 425b  avel(), c] += B[
-00013510: 2e2e 2e2c 2063 5d2e 7261 7665 6c28 290d  ..., c].ravel().
-00013520: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00013530: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00013540: 2020 2020 7372 6320 3d20 5f72 656d 6170      src = _remap
-00013550: 2873 7263 2c20 7869 2c20 4229 0d0a 2020  (src, xi, B)..  
-00013560: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00013570: 2020 2020 2020 2020 2078 6920 3d20 7869           xi = xi
-00013580: 2e72 6573 6861 7065 282d 312c 2059 202a  .reshape(-1, Y *
-00013590: 2058 2c20 4329 2e73 7761 7061 7865 7328   X, C).swapaxes(
-000135a0: 302c 2031 2920 2023 206e 2064 6174 6120  0, 1)  # n data 
-000135b0: 706f 696e 7473 206f 6620 6469 6d65 6e73  points of dimens
-000135c0: 696f 6e20 6d0d 0a20 2020 2020 2020 2020  ion m..         
-000135d0: 2020 2069 6620 4220 6973 206e 6f74 204e     if B is not N
-000135e0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-000135f0: 2020 2020 2020 4220 3d20 422e 7265 7368        B = B.resh
-00013600: 6170 6528 5920 2a20 582c 2043 2920 2023  ape(Y * X, C)  #
-00013610: 206e 2064 6174 6120 706f 696e 7473 206f   n data points o
-00013620: 6620 6469 6d65 6e73 696f 6e20 6d0d 0a0d  f dimension m...
-00013630: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-00013640: 6170 7069 6e67 2061 7265 6120 6f66 2073  apping area of s
-00013650: 7175 6172 6520 7769 7468 2065 6467 6520  quare with edge 
-00013660: 6c65 6e67 7468 2027 6478 2720 746f 2061  length 'dx' to a
-00013670: 7265 6120 6f66 2063 6972 636c 6520 7769  rea of circle wi
-00013680: 7468 2072 6164 6975 7320 2752 270d 0a20  th radius 'R'.. 
-00013690: 2020 2020 2020 2020 2020 2023 2074 6f64             # tod
-000136a0: 6f3a 206d 6170 7069 6e67 2073 7175 6172  o: mapping squar
-000136b0: 6520 746f 2063 6972 636c 653f 0d0a 2020  e to circle?..  
-000136c0: 2020 2020 2020 2020 2020 2320 746f 646f            # todo
-000136d0: 3a20 6164 6420 746f 2064 783a 206d 6167  : add to dx: mag
-000136e0: 6e69 6669 6361 7469 6f6e 0d0a 2020 2020  nification..    
-000136f0: 2020 2020 2020 2020 6966 2064 7820 6973          if dx is
-00013700: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-00013710: 2020 2020 2020 2020 6478 203d 2073 656c          dx = sel
-00013720: 662e 6d61 676e 6966 6963 6174 696f 6e0d  f.magnification.
-00013730: 0a20 2020 2020 2020 2020 2020 2064 7820  .            dx 
-00013740: 2b3d 206e 702e 7371 7274 286e 702e 7072  += np.sqrt(np.pr
-00013750: 6f64 2873 656c 662e 7529 2920 2b20 7365  od(self.u)) + se
-00013760: 6c66 2e50 5346 2020 2320 6164 6420 756e  lf.PSF  # add un
-00013770: 6365 7274 6169 6e74 7920 616e 6420 5053  certainty and PS
-00013780: 460d 0a20 2020 2020 2020 2020 2020 2052  F..            R
-00013790: 203d 206e 702e 7371 7274 2864 782a 2a32   = np.sqrt(dx**2
-000137a0: 202f 206e 702e 7069 290d 0a0d 0a20 2020   / np.pi)....   
-000137b0: 2020 2020 2020 2020 2073 7263 203d 206e           src = n
-000137c0: 702e 656d 7074 7928 2873 656c 662e 592c  p.empty((self.Y,
-000137d0: 2073 656c 662e 582c 2043 292c 206e 702e   self.X, C), np.
-000137e0: 666c 6f61 7433 3229 0d0a 2020 2020 2020  float32)..      
-000137f0: 2020 2020 2020 666f 7220 6320 696e 2072        for c in r
-00013800: 616e 6765 2843 293a 0d0a 2020 2020 2020  ange(C):..      
-00013810: 2020 2020 2020 2020 2020 6b64 7472 6565            kdtree
-00013820: 203d 2073 702e 7370 6174 6961 6c2e 4b44   = sp.spatial.KD
-00013830: 5472 6565 2878 695b 3a2c 203a 2c20 635d  Tree(xi[:, :, c]
-00013840: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00013850: 2020 2066 6f72 2078 7320 696e 2072 616e     for xs in ran
-00013860: 6765 2873 656c 662e 5829 3a0d 0a20 2020  ge(self.X):..   
-00013870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013880: 2066 6f72 2079 7320 696e 2072 616e 6765   for ys in range
-00013890: 2873 656c 662e 5929 3a0d 0a20 2020 2020  (self.Y):..     
-000138a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138b0: 2020 206b 203d 206b 6474 7265 652e 7175     k = kdtree.qu
-000138c0: 6572 795f 6261 6c6c 5f70 6f69 6e74 280d  ery_ball_point(.
-000138d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000138e0: 2020 2020 2020 2020 2020 2020 2078 3d28               x=(
-000138f0: 7873 2c20 7973 292c 2072 3d52 2c20 703d  xs, ys), r=R, p=
-00013900: 322c 2072 6574 7572 6e5f 6c65 6e67 7468  2, return_length
-00013910: 3d54 7275 650d 0a20 2020 2020 2020 2020  =True..         
-00013920: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00013930: 2020 2320 2c20 776f 726b 6572 733d 2d31    # , workers=-1
-00013940: 2920 2023 2074 6f64 6f3a 2066 6173 7465  )  # todo: faste
-00013950: 7220 7769 7468 206d 6f72 6520 776f 726b  r with more work
-00013960: 6572 733f 0d0a 0d0a 2020 2020 2020 2020  ers?....        
-00013970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013980: 2320 6465 7465 726d 696e 6520 7661 6c75  # determine valu
-00013990: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
-000139a0: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
-000139b0: 3d3d 2030 3a0d 0a20 2020 2020 2020 2020  == 0:..         
-000139c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139d0: 2020 2076 203d 2030 0d0a 2020 2020 2020     v = 0..      
-000139e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139f0: 2020 656c 6966 206b 203d 3d20 313a 0d0a    elif k == 1:..
-00013a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a10: 2020 2020 2020 2020 2020 2020 6966 2042              if B
-00013a20: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-00013a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a40: 2020 2020 2020 2020 2020 2076 203d 2031             v = 1
-00013a50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00013a60: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00013a70: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00013a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a90: 2020 2020 2064 2c20 6920 3d20 6b64 7472       d, i = kdtr
-00013aa0: 6565 2e71 7565 7279 280d 0a20 2020 2020  ee.query(..     
-00013ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ac0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-00013ad0: 3d28 7873 2c20 7973 292c 206b 3d6b 2c20  =(xs, ys), k=k, 
-00013ae0: 703d 322c 2064 6973 7461 6e63 655f 7570  p=2, distance_up
-00013af0: 7065 725f 626f 756e 643d 520d 0a20 2020  per_bound=R..   
-00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b10: 2020 2020 2020 2020 2020 2020 2029 2020               )  
-00013b20: 2320 2c20 776f 726b 6572 733d 2d31 2920  # , workers=-1) 
-00013b30: 2023 2074 6f64 6f3a 2066 6173 7465 7220   # todo: faster 
-00013b40: 7769 7468 206d 6f72 6520 776f 726b 6572  with more worker
-00013b50: 733f 0d0a 2020 2020 2020 2020 2020 2020  s?..            
-00013b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b70: 2020 2020 7620 3d20 425b 692c 2063 5d0d      v = B[i, c].
-00013b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013b90: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
-00013ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013bb0: 2020 2020 2020 2020 2020 2020 642c 2069              d, i
-00013bc0: 203d 206b 6474 7265 652e 7175 6572 7928   = kdtree.query(
-00013bd0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00013be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013bf0: 2020 783d 2878 732c 2079 7329 2c20 6b3d    x=(xs, ys), k=
-00013c00: 6b2c 2070 3d32 2c20 6469 7374 616e 6365  k, p=2, distance
-00013c10: 5f75 7070 6572 5f62 6f75 6e64 3d52 0d0a  _upper_bound=R..
-00013c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c30: 2020 2020 2020 2020 2020 2020 2920 2023              )  #
-00013c40: 202c 2077 6f72 6b65 7273 3d2d 3129 2020   , workers=-1)  
-00013c50: 2320 746f 646f 3a20 6661 7374 6572 2077  # todo: faster w
-00013c60: 6974 6820 6d6f 7265 2077 6f72 6b65 7273  ith more workers
-00013c70: 3f0d 0a20 2020 2020 2020 2020 2020 2020  ?..             
-00013c80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00013c90: 2074 6f64 6f3a 2063 6972 6375 6c61 7220   todo: circular 
-00013ca0: 6469 7374 616e 6365 2066 726f 6d20 696e  distance from in
-00013cb0: 6469 6365 730d 0a0d 0a20 2020 2020 2020  dices....       
-00013cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cd0: 2020 2020 2023 2069 6e76 6572 7365 2064       # inverse d
-00013ce0: 6973 7461 6e63 6520 7765 6967 6874 696e  istance weightin
-00013cf0: 6720 7573 696e 6720 6d6f 6469 6669 6564  g using modified
-00013d00: 2053 6865 7061 7264 2773 206d 6574 686f   Shepard's metho
-00013d10: 643a 0d0a 2020 2020 2020 2020 2020 2020  d:..            
-00013d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d30: 2320 6874 7470 733a 2f2f 656e 2e77 696b  # https://en.wik
-00013d40: 6970 6564 6961 2e6f 7267 2f77 696b 692f  ipedia.org/wiki/
-00013d50: 496e 7665 7273 655f 6469 7374 616e 6365  Inverse_distance
-00013d60: 5f77 6569 6768 7469 6e67 0d0a 2020 2020  _weighting..    
-00013d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d80: 2020 2020 2020 2020 7720 3d20 3120 2f20          w = 1 / 
-00013d90: 2864 2a2a 7029 0d0a 0d0a 2020 2020 2020  (d**p)....      
-00013da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013db0: 2020 2020 2020 6966 2042 2069 7320 6e6f        if B is no
-00013dc0: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-00013dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013de0: 2020 2020 2020 2020 2077 202a 3d20 425b           w *= B[
-00013df0: 692c 2063 5d0d 0a20 2020 2020 2020 2020  i, c]..         
-00013e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e10: 2020 2020 2020 2077 202f 3d20 6e70 2e73         w /= np.s
-00013e20: 756d 2877 290d 0a20 2020 2020 2020 2020  um(w)..         
-00013e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e40: 2020 2020 2020 2023 2076 203d 206e 702e         # v = np.
-00013e50: 7375 6d28 425b 692c 2063 5d20 2a20 7729  sum(B[i, c] * w)
-00013e60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00013e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e80: 2020 7620 3d20 6e70 2e64 6f74 2842 5b69    v = np.dot(B[i
-00013e90: 2c20 635d 2c20 7729 0d0a 2020 2020 2020  , c], w)..      
-00013ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013eb0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00013ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ed0: 2020 2020 2020 2020 2020 2020 2077 202f               w /
-00013ee0: 3d20 6e70 2e73 756d 2877 290d 0a20 2020  = np.sum(w)..   
-00013ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f00: 2020 2020 2020 2020 2020 2020 2076 203d               v =
-00013f10: 206e 702e 7375 6d28 7729 0d0a 0d0a 2020   np.sum(w)....  
-00013f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f30: 2020 2020 2020 7372 635b 7973 2c20 7873        src[ys, xs
-00013f40: 2c20 635d 203d 2076 0d0a 0d0a 2020 2020  , c] = v....    
-00013f50: 2020 2020 6d78 203d 2073 7263 2e6d 6178      mx = src.max
-00013f60: 2829 0d0a 2020 2020 2020 2020 6966 206d  ()..        if m
-00013f70: 7820 3e20 3020 616e 6420 6d78 2021 3d20  x > 0 and mx != 
-00013f80: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
-00013f90: 7372 6320 2f3d 206d 780d 0a0d 0a20 2020  src /= mx....   
-00013fa0: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00013fb0: 2e69 6e66 6f28 6622 7b73 6928 7469 6d65  .info(f"{si(time
-00013fc0: 2e70 6572 665f 636f 756e 7465 7228 2920  .perf_counter() 
-00013fd0: 2d20 7430 297d 7322 290d 0a0d 0a20 2020  - t0)}s")....   
-00013fe0: 2020 2020 2072 6574 7572 6e20 7372 630d       return src.
-00013ff0: 0a0d 0a20 2020 2064 6566 205f 7369 6d75  ...    def _simu
-00014000: 6c61 7465 280d 0a20 2020 2020 2020 2073  late(..        s
-00014010: 656c 662c 0d0a 2020 2020 2020 2020 493a  elf,..        I:
-00014020: 206e 702e 6e64 6172 7261 792c 0d0a 2020   np.ndarray,..  
-00014030: 2020 2020 2020 6d61 676e 6966 6963 6174        magnificat
-00014040: 696f 6e3a 2066 6c6f 6174 203d 2031 2c0d  ion: float = 1,.
-00014050: 0a20 2020 2020 2020 2050 5346 3a20 666c  .        PSF: fl
-00014060: 6f61 7420 3d20 332c 0d0a 2020 2020 2020  oat = 3,..      
-00014070: 2020 7379 7374 656d 5f67 6169 6e3a 2066    system_gain: f
-00014080: 6c6f 6174 203d 2030 2e30 3338 2c0d 0a20  loat = 0.038,.. 
-00014090: 2020 2020 2020 2064 6172 6b5f 6375 7272         dark_curr
-000140a0: 656e 743a 2066 6c6f 6174 203d 2033 2e36  ent: float = 3.6
-000140b0: 3420 2f20 302e 3033 382c 2020 2320 5b65  4 / 0.038,  # [e
-000140c0: 6c65 6374 726f 6e73 5d20 2023 2073 6f6d  lectrons]  # som
-000140d0: 6520 6361 6d65 7261 7320 6665 6174 7572  e cameras featur
-000140e0: 6520 6120 6461 726b 2063 7572 7265 6e74  e a dark current
-000140f0: 2063 6f6d 7065 6e73 6174 696f 6e0d 0a20   compensation.. 
-00014100: 2020 2020 2020 2064 6172 6b5f 6e6f 6973         dark_nois
-00014110: 653a 2066 6c6f 6174 203d 2031 332e 372c  e: float = 13.7,
-00014120: 2020 2320 5b65 6c65 6374 726f 6e73 5d0d    # [electrons].
-00014130: 0a20 2020 2020 2020 2073 6565 643a 2069  .        seed: i
-00014140: 6e74 203d 2032 3638 3636 3434 3334 3433  nt = 26866443443
-00014150: 3135 3831 3531 3339 3236 3332 3731 3633  1581513926327163
-00014160: 3936 3036 3930 3133 3837 3139 2c20 2023  960690138719,  #
-00014170: 2073 6563 7265 7473 2e72 616e 6462 6974   secrets.randbit
-00014180: 7328 3132 3829 0d0a 2020 2020 2920 2d3e  s(128)..    ) ->
-00014190: 206e 702e 6e64 6172 7261 793a 0d0a 2020   np.ndarray:..  
-000141a0: 2020 2020 2020 2222 2253 696d 756c 6174        """Simulat
-000141b0: 6520 7468 6520 6163 7175 6973 6974 696f  e the acquisitio
-000141c0: 6e2c 2069 2e65 2e20 7468 6520 7472 616e  n, i.e. the tran
-000141d0: 736d 6973 7369 6f6e 2063 6861 6e6e 656c  smission channel
-000141e0: 2e0d 0a0d 0a20 2020 2020 2020 2054 6869  .....        Thi
-000141f0: 7320 696e 636c 7564 6573 2074 6865 206d  s includes the m
-00014200: 6f64 756c 6174 696f 6e20 7472 616e 7366  odulation transf
-00014210: 6572 2066 756e 6374 696f 6e20 2863 6f6d  er function (com
-00014220: 7075 7465 6420 6672 6f6d 2074 6865 2069  puted from the i
-00014230: 6d61 6769 6e67 2073 7973 7465 6d27 7320  maging system's 
-00014240: 706f 696e 7420 7370 7265 6164 2066 756e  point spread fun
-00014250: 6374 696f 6e29 0d0a 2020 2020 2020 2020  ction)..        
-00014260: 616e 6420 696e 7465 6e73 6974 7920 6e6f  and intensity no
-00014270: 6973 6520 6164 6465 6420 6279 2074 6865  ise added by the
-00014280: 2063 616d 6572 612e 0d0a 0d0a 2020 2020   camera.....    
-00014290: 2020 2020 5061 7261 6d65 7465 7273 0d0a      Parameters..
-000142a0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-000142b0: 2d2d 0d0a 2020 2020 2020 2020 4920 3a20  --..        I : 
-000142c0: 6e70 2e6e 6461 7272 6179 0d0a 2020 2020  np.ndarray..    
-000142d0: 2020 2020 2020 2020 4672 696e 6765 2070          Fringe p
-000142e0: 6174 7465 726e 2073 6571 7565 6e63 652e  attern sequence.
-000142f0: 0d0a 0d0a 2020 2020 2020 2020 5044 4620  ....        PDF 
-00014300: 3a20 666c 6f61 742c 206f 7074 696f 6e61  : float, optiona
-00014310: 6c0d 0a20 2020 2020 2020 2020 2020 2053  l..            S
-00014320: 7461 6e64 6172 6420 6465 7669 6174 696f  tandard deviatio
-00014330: 6e20 6f66 2074 6865 2050 6f69 6e74 2053  n of the Point S
-00014340: 7072 6561 6420 4675 6e63 7469 6f6e 2c20  pread Function, 
-00014350: 696e 2070 6978 656c 2075 6e69 7473 2e0d  in pixel units..
-00014360: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-00014370: 2064 6566 6175 6c74 2069 7320 332e 0d0a   default is 3...
-00014380: 0d0a 2020 2020 2020 2020 7379 7374 656d  ..        system
-00014390: 5f67 6169 6e20 3a20 666c 6f61 742c 206f  _gain : float, o
-000143a0: 7074 696f 6e61 6c0d 0a20 2020 2020 2020  ptional..       
-000143b0: 2020 2020 2053 7973 7465 6d20 6761 696e       System gain
-000143c0: 206f 6620 7468 6520 6469 6769 7461 6c20   of the digital 
-000143d0: 6361 6d65 7261 2e0d 0a20 2020 2020 2020  camera...       
-000143e0: 2020 2020 2054 6865 2064 6566 6175 6c74       The default
-000143f0: 2069 7320 302e 3033 382e 0d0a 0d0a 2020   is 0.038.....  
-00014400: 2020 2020 2020 6461 726b 5f63 7572 7265        dark_curre
-00014410: 6e74 203a 2066 6c6f 6174 2c20 6f70 7469  nt : float, opti
-00014420: 6f6e 616c 0d0a 2020 2020 2020 2020 2020  onal..          
-00014430: 2020 4461 726b 2063 7572 7265 6e74 206f    Dark current o
-00014440: 6620 7468 6520 6469 6769 7461 6c20 6361  f the digital ca
-00014450: 6d65 7261 2c20 696e 2075 6e69 7420 656c  mera, in unit el
-00014460: 6563 7472 6f6e 732e 0d0a 2020 2020 2020  ectrons...      
-00014470: 2020 2020 2020 5468 6520 6465 6661 756c        The defaul
-00014480: 7420 6973 207e 3130 302e 0d0a 0d0a 2020  t is ~100.....  
-00014490: 2020 2020 2020 6461 726b 5f6e 6f69 7365        dark_noise
-000144a0: 203a 2066 6c6f 6174 2c20 6f70 7469 6f6e   : float, option
-000144b0: 616c 0d0a 2020 2020 2020 2020 2020 2020  al..            
-000144c0: 4461 726b 206e 6f69 7365 206f 6620 7468  Dark noise of th
-000144d0: 6520 6469 6769 7461 6c20 6361 6d65 7261  e digital camera
-000144e0: 2c20 696e 2075 6e69 7473 2065 6c65 6374  , in units elect
-000144f0: 726f 6e73 2e0d 0a20 2020 2020 2020 2020  rons...         
-00014500: 2020 2054 6865 2064 6566 6175 6c74 2069     The default i
-00014510: 7320 3133 2e37 0d0a 0d0a 2020 2020 2020  s 13.7....      
-00014520: 2020 7365 6564 203a 2069 6e74 2c20 6f70    seed : int, op
-00014530: 7469 6f6e 616c 0d0a 2020 2020 2020 2020  tional..        
-00014540: 2020 2020 4120 7365 6564 2074 6f20 696e      A seed to in
-00014550: 6974 6961 6c69 7a65 2074 6865 2052 616e  itialize the Ran
-00014560: 646f 6d20 4e75 6d62 6572 2047 656e 6572  dom Number Gener
-00014570: 6174 6f72 2e0d 0a20 2020 2020 2020 2020  ator...         
-00014580: 2020 2049 7420 6d61 6b65 7320 7468 6520     It makes the 
-00014590: 7261 6e64 6f6d 206e 756d 6265 7273 2070  random numbers p
-000145a0: 7265 6469 6374 6162 6c65 2e0d 0a20 2020  redictable...   
-000145b0: 2020 2020 2020 2020 2053 6565 2060 5365           See `Se
-000145c0: 6564 696e 6720 616e 6420 456e 7472 6f70  eding and Entrop
-000145d0: 7920 3c68 7474 703a 2f2f 7777 772e 6578  y <http://www.ex
-000145e0: 616d 706c 652e 636f 6d3e 605f 2066 6f72  ample.com>`_ for
-000145f0: 206d 6f72 6520 696e 666f 726d 6174 696f   more informatio
-00014600: 6e20 6162 6f75 7420 7365 6564 696e 672e  n about seeding.
-00014610: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
-00014620: 726e 730d 0a20 2020 2020 2020 202d 2d2d  rns..        ---
-00014630: 2d2d 2d2d 0d0a 2020 2020 2020 2020 4920  ----..        I 
-00014640: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
-00014650: 2020 2020 2020 2020 2020 5369 6d75 6c61            Simula
-00014660: 7465 6420 6672 696e 6765 2070 6174 7465  ted fringe patte
-00014670: 726e 2073 6571 7565 6e63 652e 0d0a 2020  rn sequence...  
-00014680: 2020 2020 2020 2222 220d 0a0d 0a20 2020        """....   
-00014690: 2020 2020 2074 3020 3d20 7469 6d65 2e70       t0 = time.p
-000146a0: 6572 665f 636f 756e 7465 7228 290d 0a0d  erf_counter()...
-000146b0: 0a20 2020 2020 2020 2049 2e73 6861 7065  .        I.shape
-000146c0: 203d 2054 2c20 592c 2058 2c20 4320 3d20   = T, Y, X, C = 
-000146d0: 7673 6861 7065 2849 292e 7368 6170 650d  vshape(I).shape.
-000146e0: 0a20 2020 2020 2020 2049 203d 2049 2e61  .        I = I.a
-000146f0: 7374 7970 6528 666c 6f61 742c 2063 6f70  stype(float, cop
-00014700: 793d 4661 6c73 6529 0d0a 0d0a 2020 2020  y=False)....    
-00014710: 2020 2020 2320 2320 6d61 676e 6966 6963      # # magnific
-00014720: 6174 696f 6e0d 0a20 2020 2020 2020 2023  ation..        #
-00014730: 2069 6620 6d61 676e 6966 6963 6174 696f   if magnificatio
-00014740: 6e20 213d 2031 3a0d 0a20 2020 2020 2020  n != 1:..       
-00014750: 2023 2020 2020 2049 203d 2073 702e 6e64   #     I = sp.nd
-00014760: 696d 6167 652e 756e 6966 6f72 6d5f 6669  image.uniform_fi
-00014770: 6c74 6572 2849 2c20 7369 7a65 3d6d 6167  lter(I, size=mag
-00014780: 6e69 6669 6361 7469 6f6e 2c20 6d6f 6465  nification, mode
-00014790: 3d22 7265 666c 6563 7422 2c20 6178 6573  ="reflect", axes
-000147a0: 3d28 312c 2032 2929 0d0a 0d0a 2020 2020  =(1, 2))....    
-000147b0: 2020 2020 2320 5053 4620 2865 2e67 2e20      # PSF (e.g. 
-000147c0: 6465 666f 6375 7329 0d0a 2020 2020 2020  defocus)..      
-000147d0: 2020 6966 2050 5346 2021 3d20 303a 0d0a    if PSF != 0:..
-000147e0: 2020 2020 2020 2020 2020 2020 4920 3d20              I = 
-000147f0: 7370 2e6e 6469 6d61 6765 2e67 6175 7373  sp.ndimage.gauss
-00014800: 6961 6e5f 6669 6c74 6572 2849 2c20 7369  ian_filter(I, si
-00014810: 676d 613d 5053 462c 206f 7264 6572 3d30  gma=PSF, order=0
-00014820: 2c20 6d6f 6465 3d22 7265 666c 6563 7422  , mode="reflect"
-00014830: 2c20 6178 6573 3d28 312c 2032 2929 0d0a  , axes=(1, 2))..
-00014840: 0d0a 2020 2020 2020 2020 2320 7261 6e64  ..        # rand
-00014850: 6f6d 206e 756d 6265 7220 6765 6e65 7261  om number genera
-00014860: 746f 720d 0a20 2020 2020 2020 2072 6e67  tor..        rng
-00014870: 203d 206e 702e 7261 6e64 6f6d 2e64 6566   = np.random.def
-00014880: 6175 6c74 5f72 6e67 2873 6565 6429 0d0a  ault_rng(seed)..
-00014890: 0d0a 2020 2020 2020 2020 2320 7368 6f74  ..        # shot
-000148a0: 206e 6f69 7365 0d0a 2020 2020 2020 2020   noise..        
-000148b0: 7368 6f74 203d 2028 4920 2d20 726e 672e  shot = (I - rng.
-000148c0: 706f 6973 736f 6e28 4929 2920 2a20 6e70  poisson(I)) * np
-000148d0: 2e73 7172 7428 7379 7374 656d 5f67 6169  .sqrt(system_gai
-000148e0: 6e29 0d0a 0d0a 2020 2020 2020 2020 2320  n)....        # 
-000148f0: 6461 726b 206e 6f69 7365 0d0a 2020 2020  dark noise..    
-00014900: 2020 2020 6461 726b 5f63 7572 7265 6e74      dark_current
-00014910: 5f79 3020 3d20 6461 726b 5f63 7572 7265  _y0 = dark_curre
-00014920: 6e74 202a 2073 7973 7465 6d5f 6761 696e  nt * system_gain
-00014930: 0d0a 2020 2020 2020 2020 6461 726b 5f6e  ..        dark_n
-00014940: 6f69 7365 5f79 3020 3d20 6461 726b 5f6e  oise_y0 = dark_n
-00014950: 6f69 7365 202a 2073 7973 7465 6d5f 6761  oise * system_ga
-00014960: 696e 0d0a 2020 2020 2020 2020 6461 726b  in..        dark
-00014970: 203d 2072 6e67 2e6e 6f72 6d61 6c28 6461   = rng.normal(da
-00014980: 726b 5f63 7572 7265 6e74 5f79 302c 2064  rk_current_y0, d
-00014990: 6172 6b5f 6e6f 6973 655f 7930 2c20 492e  ark_noise_y0, I.
-000149a0: 7368 6170 6529 0d0a 0d0a 2020 2020 2020  shape)....      
-000149b0: 2020 2320 7370 6174 6961 6c20 6e6f 6e75    # spatial nonu
-000149c0: 6e69 666f 726d 6974 790d 0a20 2020 2020  niformity..     
-000149d0: 2020 2053 4e55 203d 2030 2020 2320 746f     SNU = 0  # to
-000149e0: 646f 3a20 7370 6174 6961 6c20 6e6f 6e75  do: spatial nonu
-000149f0: 6e69 666f 726d 6974 790d 0a0d 0a20 2020  niformity....   
-00014a00: 2020 2020 2023 2061 6464 206e 6f69 7365       # add noise
-00014a10: 0d0a 2020 2020 2020 2020 4920 3d20 4920  ..        I = I 
-00014a20: 2b20 7368 6f74 202b 2064 6172 6b20 2b20  + shot + dark + 
-00014a30: 534e 550d 0a0d 0a20 2020 2020 2020 2023  SNU....        #
-00014a40: 2063 6c69 7020 7661 6c75 6573 0d0a 2020   clip values..  
-00014a50: 2020 2020 2020 6e70 2e63 6c69 7028 492c        np.clip(I,
-00014a60: 2030 2c20 7365 6c66 2e49 6d61 782c 206f   0, self.Imax, o
-00014a70: 7574 3d49 290d 0a0d 0a20 2020 2020 2020  ut=I)....       
-00014a80: 2023 2071 7561 6e74 697a 6174 696f 6e20   # quantization 
-00014a90: 6e6f 6973 6520 6973 2061 6464 6564 2062  noise is added b
-00014aa0: 7920 636f 6e76 6572 7469 6e67 2074 6f20  y converting to 
-00014ab0: 696e 7465 6765 720d 0a20 2020 2020 2020  integer..       
-00014ac0: 2049 203d 2049 2e61 7374 7970 6528 7365   I = I.astype(se
-00014ad0: 6c66 2e64 7479 7065 2c20 636f 7079 3d46  lf.dtype, copy=F
-00014ae0: 616c 7365 290d 0a0d 0a20 2020 2020 2020  alse)....       
-00014af0: 2073 656c 662e 6c6f 6767 6572 2e69 6e66   self.logger.inf
-00014b00: 6f28 6622 7b73 6928 7469 6d65 2e70 6572  o(f"{si(time.per
-00014b10: 665f 636f 756e 7465 7228 2920 2d20 7430  f_counter() - t0
-00014b20: 297d 7322 290d 0a0d 0a20 2020 2020 2020  )}s")....       
-00014b30: 2072 6574 7572 6e20 490d 0a0d 0a20 2020   return I....   
-00014b40: 2064 6566 205f 7472 696d 2873 656c 662c   def _trim(self,
-00014b50: 2061 3a20 6e70 2e6e 6461 7272 6179 2920   a: np.ndarray) 
-00014b60: 2d3e 206e 702e 6e64 6172 7261 793a 0d0a  -> np.ndarray:..
-00014b70: 2020 2020 2020 2020 2222 2243 6861 6e67          """Chang
-00014b80: 6520 6061 602e 6e64 696d 2074 6f20 3220  e `a`.ndim to 2 
-00014b90: 616e 6420 6c69 6d69 7420 6061 602e 7368  and limit `a`.sh
-00014ba0: 6170 652e 2222 220d 0a0d 0a20 2020 2020  ape."""....     
-00014bb0: 2020 2069 6620 612e 6e64 696d 203d 3d20     if a.ndim == 
-00014bc0: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
-00014bd0: 6120 3d20 6e70 2e66 756c 6c28 2873 656c  a = np.full((sel
-00014be0: 662e 442c 2073 656c 662e 4b29 2c20 6129  f.D, self.K), a)
-00014bf0: 0d0a 2020 2020 2020 2020 656c 6966 2061  ..        elif a
-00014c00: 2e6e 6469 6d20 3d3d 2031 3a0d 0a20 2020  .ndim == 1:..   
-00014c10: 2020 2020 2020 2020 2061 203d 206e 702e           a = np.
-00014c20: 7673 7461 636b 285b 615b 3a20 7365 6c66  vstack([a[: self
-00014c30: 2e5f 4b6d 6178 5d20 666f 7220 6420 696e  ._Kmax] for d in
-00014c40: 2072 616e 6765 2873 656c 662e 4429 5d29   range(self.D)])
-00014c50: 0d0a 2020 2020 2020 2020 656c 6966 2061  ..        elif a
-00014c60: 2e6e 6469 6d20 3d3d 2032 3a0d 0a20 2020  .ndim == 2:..   
-00014c70: 2020 2020 2020 2020 2061 203d 2061 5b3a           a = a[:
-00014c80: 2073 656c 662e 5f44 6d61 782c 203a 2073   self._Dmax, : s
-00014c90: 656c 662e 5f4b 6d61 785d 0d0a 2020 2020  elf._Kmax]..    
-00014ca0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-00014cb0: 2020 2020 2020 2061 203d 2061 5b3a 2073         a = a[: s
-00014cc0: 656c 662e 5f44 6d61 782c 203a 2073 656c  elf._Dmax, : sel
-00014cd0: 662e 5f4b 6d61 782c 202e 2e2e 2c20 2d31  f._Kmax, ..., -1
-00014ce0: 5d0d 0a0d 0a20 2020 2020 2020 2072 6574  ]....        ret
-00014cf0: 7572 6e20 610d 0a0d 0a20 2020 2064 6566  urn a....    def
-00014d00: 2065 7272 6f72 7328 7365 6c66 2920 2d3e   errors(self) ->
-00014d10: 2074 7570 6c65 3a0d 0a20 2020 2020 2020   tuple:..       
-00014d20: 2022 2222 4572 726f 7220 6d65 7472 6963   """Error metric
-00014d30: 732e 0d0a 0d0a 2020 2020 2020 2020 5265  s.....        Re
-00014d40: 7475 726e 730d 0a20 2020 2020 2020 202d  turns..        -
-00014d50: 2d2d 2d2d 2d2d 0d0a 2020 2020 2020 2020  ------..        
-00014d60: 646d 6564 203a 206e 702e 6e64 6172 7261  dmed : np.ndarra
-00014d70: 790d 0a20 2020 2020 2020 2020 2020 204d  y..            M
-00014d80: 6564 6961 6e20 6f66 2061 6273 6f6c 7574  edian of absolut
-00014d90: 6520 6469 7374 616e 6365 2062 6574 7765  e distance betwe
-00014da0: 656e 2074 7275 6520 616e 6420 6465 636f  en true and deco
-00014db0: 6465 6420 636f 6f72 6469 6e61 7465 732e  ded coordinates.
-00014dc0: 0d0a 0d0a 2020 2020 2020 2020 6463 6d65  ....        dcme
-00014dd0: 6420 3a20 6e70 2e6e 6461 7272 6179 0d0a  d : np.ndarray..
-00014de0: 2020 2020 2020 2020 2020 2020 4d65 6469              Medi
-00014df0: 616e 206f 6620 6162 736f 6c75 7465 2063  an of absolute c
-00014e00: 6972 6375 6c61 7220 6469 7374 616e 6365  ircular distance
-00014e10: 2062 6574 7765 656e 2074 7275 6520 616e   between true an
-00014e20: 6420 6465 636f 6465 6420 636f 6f72 6469  d decoded coordi
-00014e30: 6e61 7465 732e 0d0a 0d0a 2020 2020 2020  nates.....      
-00014e40: 2020 6461 7667 203a 206e 702e 6e64 6172    davg : np.ndar
-00014e50: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-00014e60: 204d 6561 6e20 6f66 2061 6273 6f6c 7574   Mean of absolut
-00014e70: 6520 6469 7374 616e 6365 2062 6574 7765  e distance betwe
-00014e80: 656e 2074 7275 6520 616e 6420 6465 636f  en true and deco
-00014e90: 6465 6420 636f 6f72 6469 6e61 7465 732e  ded coordinates.
-00014ea0: 0d0a 0d0a 2020 2020 2020 2020 6463 6176  ....        dcav
-00014eb0: 6720 3a20 6e70 2e6e 6461 7272 6179 0d0a  g : np.ndarray..
-00014ec0: 2020 2020 2020 2020 2020 2020 4d65 616e              Mean
-00014ed0: 206f 6620 6162 736f 6c75 7465 2063 6972   of absolute cir
-00014ee0: 6375 6c61 7220 6469 7374 616e 6365 2062  cular distance b
-00014ef0: 6574 7765 656e 2074 7275 6520 616e 6420  etween true and 
-00014f00: 6465 636f 6465 6420 636f 6f72 6469 6e61  decoded coordina
-00014f10: 7465 732e 0d0a 0d0a 2020 2020 2020 2020  tes.....        
-00014f20: 646d 696e 203a 206e 702e 6e64 6172 7261  dmin : np.ndarra
-00014f30: 790d 0a20 2020 2020 2020 2020 2020 204d  y..            M
-00014f40: 696d 696d 756d 206f 6620 6162 736f 6c75  imimum of absolu
-00014f50: 7465 2064 6973 7461 6e63 6520 6265 7477  te distance betw
-00014f60: 6565 6e20 7472 7565 2061 6e64 2064 6563  een true and dec
-00014f70: 6f64 6564 2063 6f6f 7264 696e 6174 6573  oded coordinates
-00014f80: 2e0d 0a0d 0a20 2020 2020 2020 2064 636d  .....        dcm
-00014f90: 696e 203a 206e 702e 6e64 6172 7261 790d  in : np.ndarray.
-00014fa0: 0a20 2020 2020 2020 2020 2020 204d 696e  .            Min
-00014fb0: 696d 756d 206f 6620 6162 736f 6c75 7465  imum of absolute
-00014fc0: 2063 6972 6375 6c61 7220 6469 7374 616e   circular distan
-00014fd0: 6365 2062 6574 7765 656e 2074 7275 6520  ce between true 
-00014fe0: 616e 6420 6465 636f 6465 6420 636f 6f72  and decoded coor
-00014ff0: 6469 6e61 7465 732e 0d0a 0d0a 2020 2020  dinates.....    
-00015000: 2020 2020 646d 6178 203a 206e 702e 6e64      dmax : np.nd
-00015010: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
-00015020: 2020 204d 6178 696d 756d 206f 6620 6162     Maximum of ab
-00015030: 736f 6c75 7465 2064 6973 7461 6e63 6520  solute distance 
-00015040: 6265 7477 6565 6e20 7472 7565 2061 6e64  between true and
-00015050: 2064 6563 6f64 6564 2063 6f6f 7264 696e   decoded coordin
-00015060: 6174 6573 2e0d 0a0d 0a20 2020 2020 2020  ates.....       
-00015070: 2064 636d 6178 203a 206e 702e 6e64 6172   dcmax : np.ndar
-00015080: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-00015090: 204d 6178 696d 756d 206f 6620 6162 736f   Maximum of abso
-000150a0: 6c75 7465 2063 6972 6375 6c61 7220 6469  lute circular di
-000150b0: 7374 616e 6365 2062 6574 7765 656e 2074  stance between t
-000150c0: 7275 6520 616e 6420 6465 636f 6465 6420  rue and decoded 
-000150d0: 636f 6f72 6469 6e61 7465 732e 0d0a 0d0a  coordinates.....
-000150e0: 2020 2020 2020 2020 7374 6420 3a20 6e70          std : np
-000150f0: 2e6e 6461 7272 6179 0d0a 2020 2020 2020  .ndarray..      
-00015100: 2020 2020 2020 5374 616e 6461 7264 2064        Standard d
-00015110: 6576 6961 7469 6f6e 206f 6620 6162 736f  eviation of abso
-00015120: 6c75 7465 2064 6973 7461 6e63 6520 6265  lute distance be
-00015130: 7477 6565 6e20 7472 7565 2061 6e64 2064  tween true and d
-00015140: 6563 6f64 6564 2063 6f6f 7264 696e 6174  ecoded coordinat
-00015150: 6573 2e0d 0a0d 0a20 2020 2020 2020 2073  es.....        s
-00015160: 7464 6320 3a20 6e70 2e6e 6461 7272 6179  tdc : np.ndarray
-00015170: 0d0a 2020 2020 2020 2020 2020 2020 5374  ..            St
-00015180: 616e 6461 7264 2064 6576 6961 7469 6f6e  andard deviation
-00015190: 206f 6620 6162 736f 6c75 7465 2064 6972   of absolute dir
-000151a0: 6375 6c61 7220 6469 7374 616e 6365 2062  cular distance b
-000151b0: 6574 7765 656e 2074 7275 6520 616e 6420  etween true and 
-000151c0: 6465 636f 6465 6420 636f 6f72 6469 6e61  decoded coordina
-000151d0: 7465 732e 0d0a 0d0a 2020 2020 2020 2020  tes.....        
-000151e0: 7361 7667 203a 206e 702e 6e64 6172 7261  savg : np.ndarra
-000151f0: 790d 0a20 2020 2020 2020 2020 2020 204d  y..            M
-00015200: 6561 6e20 6f66 2073 7563 6365 7373 2072  ean of success r
-00015210: 6174 6520 6f66 2070 6861 7365 2075 6e77  ate of phase unw
-00015220: 7261 7070 696e 672e 0d0a 0d0a 2020 2020  rapping.....    
-00015230: 2020 2020 736d 6564 203a 206e 702e 6e64      smed : np.nd
-00015240: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
-00015250: 2020 204d 6564 6961 6e20 6f66 2073 7563     Median of suc
-00015260: 6365 7373 2072 6174 6520 6f66 2070 6861  cess rate of pha
-00015270: 7365 2075 6e77 7261 7070 696e 672e 0d0a  se unwrapping...
-00015280: 0d0a 2020 2020 2020 2020 736d 696e 203a  ..        smin :
-00015290: 206e 702e 6e64 6172 7261 790d 0a20 2020   np.ndarray..   
-000152a0: 2020 2020 2020 2020 204d 696e 696d 756d           Minimum
-000152b0: 206f 6620 7375 6363 6573 7320 7261 7465   of success rate
-000152c0: 206f 6620 7068 6173 6520 756e 7772 6170   of phase unwrap
-000152d0: 7069 6e67 2e0d 0a0d 0a20 2020 2020 2020  ping.....       
-000152e0: 2073 6d61 7820 3a20 6e70 2e6e 6461 7272   smax : np.ndarr
-000152f0: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
-00015300: 4d61 7869 6d75 6d20 6f66 2073 7563 6365  Maximum of succe
-00015310: 7373 2072 6174 6520 6f66 2070 6861 7365  ss rate of phase
-00015320: 2075 6e77 7261 7070 696e 672e 0d0a 2020   unwrapping...  
-00015330: 2020 2020 2020 2222 220d 0a0d 0a20 2020        """....   
-00015340: 2020 2020 2064 6563 203d 2073 656c 662e       dec = self.
-00015350: 6465 636f 6465 2873 656c 662e 656e 636f  decode(self.enco
-00015360: 6465 2873 696d 756c 6174 653d 5472 7565  de(simulate=True
-00015370: 292c 2076 6572 626f 7365 3d54 7275 6529  ), verbose=True)
-00015380: 0d0a 0d0a 2020 2020 2020 2020 7820 3d20  ....        x = 
-00015390: 7365 6c66 2e63 6f6f 7264 696e 6174 6573  self.coordinates
-000153a0: 2829 0d0a 2020 2020 2020 2020 7865 7374  ()..        xest
-000153b0: 203d 2064 6563 2e72 6567 6973 7472 6174   = dec.registrat
-000153c0: 696f 6e0d 0a0d 0a20 2020 2020 2020 2064  ion....        d
-000153d0: 203d 2078 202d 2078 6573 740d 0a20 2020   = x - xest..   
-000153e0: 2020 2020 2073 7464 203d 206e 702e 7374       std = np.st
-000153f0: 6428 6429 0d0a 2020 2020 2020 2020 6461  d(d)..        da
-00015400: 6273 203d 206e 702e 6162 7328 6429 0d0a  bs = np.abs(d)..
-00015410: 2020 2020 2020 2020 646d 6564 203d 206e          dmed = n
-00015420: 702e 6d65 6469 616e 2864 6162 7329 0d0a  p.median(dabs)..
-00015430: 2020 2020 2020 2020 6461 7667 203d 206e          davg = n
-00015440: 702e 6d65 616e 2864 6162 7329 0d0a 2020  p.mean(dabs)..  
-00015450: 2020 2020 2020 646d 696e 203d 206e 702e        dmin = np.
-00015460: 6d69 6e28 6461 6273 290d 0a20 2020 2020  min(dabs)..     
-00015470: 2020 2064 6d61 7820 3d20 6e70 2e6d 6178     dmax = np.max
-00015480: 2864 6162 7329 0d0a 0d0a 2020 2020 2020  (dabs)....      
-00015490: 2020 6463 203d 2063 6972 6375 6c61 725f    dc = circular_
-000154a0: 6469 7374 616e 6365 2878 2c20 7865 7374  distance(x, xest
-000154b0: 2c20 7365 6c66 2e4c 290d 0a20 2020 2020  , self.L)..     
-000154c0: 2020 2073 7464 6320 3d20 6e70 2e73 7464     stdc = np.std
-000154d0: 2864 6329 0d0a 2020 2020 2020 2020 6463  (dc)..        dc
-000154e0: 6162 7320 3d20 6e70 2e61 6273 2864 6329  abs = np.abs(dc)
-000154f0: 0d0a 2020 2020 2020 2020 6463 6176 6720  ..        dcavg 
-00015500: 3d20 6e70 2e6d 6561 6e28 6463 6162 7329  = np.mean(dcabs)
-00015510: 0d0a 2020 2020 2020 2020 6463 6d65 6420  ..        dcmed 
-00015520: 3d20 6e70 2e6d 6564 6961 6e28 6463 6162  = np.median(dcab
-00015530: 7329 0d0a 2020 2020 2020 2020 6463 6d69  s)..        dcmi
-00015540: 6e20 3d20 6e70 2e6d 696e 2864 6361 6273  n = np.min(dcabs
-00015550: 290d 0a20 2020 2020 2020 2064 636d 6178  )..        dcmax
-00015560: 203d 206e 702e 6d61 7828 6463 6162 7329   = np.max(dcabs)
-00015570: 0d0a 0d0a 2020 2020 2020 2020 6b20 3d20  ....        k = 
-00015580: 7365 6c66 2e5f 6f72 6465 7273 2829 0d0a  self._orders()..
-00015590: 2020 2020 2020 2020 6b65 7374 203d 2064          kest = d
-000155a0: 6563 2e6f 7264 6572 730d 0a20 2020 2020  ec.orders..     
-000155b0: 2020 2043 203d 2028 6b20 3d3d 206b 6573     C = (k == kes
-000155c0: 7429 2e61 7374 7970 6528 6e70 2e75 696e  t).astype(np.uin
-000155d0: 7438 2c20 636f 7079 3d46 616c 7365 290d  t8, copy=False).
-000155e0: 0a20 2020 2020 2020 2073 6176 6720 3d20  .        savg = 
-000155f0: 6e70 2e6d 6561 6e28 4329 0d0a 2020 2020  np.mean(C)..    
-00015600: 2020 2020 736d 6564 203d 206e 702e 6d65      smed = np.me
-00015610: 6469 616e 2843 290d 0a20 2020 2020 2020  dian(C)..       
-00015620: 2073 6d69 6e20 3d20 6e70 2e6d 696e 2843   smin = np.min(C
-00015630: 290d 0a20 2020 2020 2020 2073 6d61 7820  )..        smax 
-00015640: 3d20 6e70 2e6d 6178 2843 290d 0a0d 0a20  = np.max(C).... 
-00015650: 2020 2020 2020 2065 7272 6f72 7320 3d20         errors = 
-00015660: 6e61 6d65 6474 7570 6c65 280d 0a20 2020  namedtuple(..   
-00015670: 2020 2020 2020 2020 2022 6572 726f 7273           "errors
-00015680: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
-00015690: 2264 6d65 6420 6463 6d65 6420 6461 7667  "dmed dcmed davg
-000156a0: 2064 6361 7667 2064 6d69 6e20 6463 6d69   dcavg dmin dcmi
-000156b0: 6e20 646d 6178 2064 636d 6178 2073 7464  n dmax dcmax std
-000156c0: 2073 7464 6320 7361 7667 2073 6d65 6420   stdc savg smed 
-000156d0: 736d 696e 2073 6d61 7822 2c0d 0a20 2020  smin smax",..   
-000156e0: 2020 2020 2029 2864 6d65 642c 2064 636d       )(dmed, dcm
-000156f0: 6564 2c20 6461 7667 2c20 6463 6176 672c  ed, davg, dcavg,
-00015700: 2064 6d69 6e2c 2064 636d 696e 2c20 646d   dmin, dcmin, dm
-00015710: 6178 2c20 6463 6d61 782c 2073 7464 2c20  ax, dcmax, std, 
-00015720: 7374 6463 2c20 7361 7667 2c20 736d 6564  stdc, savg, smed
-00015730: 2c20 736d 696e 2c20 736d 6178 290d 0a0d  , smin, smax)...
-00015740: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015750: 6572 726f 7273 0d0a 0d0a 2020 2020 6465  errors....    de
-00015760: 6620 4d54 4628 7365 6c66 2c20 763a 2066  f MTF(self, v: f
-00015770: 6c6f 6174 207c 206e 702e 6e64 6172 7261  loat | np.ndarra
-00015780: 7929 202d 3e20 6e70 2e6e 6461 7272 6179  y) -> np.ndarray
-00015790: 3a0d 0a20 2020 2020 2020 2022 2222 4d6f  :..        """Mo
-000157a0: 6475 6c61 7469 6f6e 2054 7261 6e73 6665  dulation Transfe
-000157b0: 7220 4675 6e63 7469 6f6e 2e0d 0a0d 0a20  r Function..... 
-000157c0: 2020 2020 2020 2052 6574 7572 6e73 2074         Returns t
-000157d0: 6865 2072 656c 6174 6976 6520 6d6f 6475  he relative modu
-000157e0: 6c61 7469 6f6e 2061 7420 7370 6174 6961  lation at spatia
-000157f0: 6c20 6672 6571 7565 6e63 6965 7320 6076  l frequencies `v
-00015800: 602e 0d0a 0d0a 2020 2020 2020 2020 5061  `.....        Pa
-00015810: 7261 6d65 7465 7273 0d0a 2020 2020 2020  rameters..      
-00015820: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020    ----------..  
-00015830: 2020 2020 2020 763a 206e 702e 6e64 6172        v: np.ndar
-00015840: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
-00015850: 2053 7061 7469 616c 2066 7265 7175 656e   Spatial frequen
-00015860: 6369 6573 2061 7420 7768 6963 6820 746f  cies at which to
-00015870: 2064 6574 6572 6d69 6e65 2074 6865 206e   determine the n
-00015880: 6f72 6d61 6c69 7a65 6420 6d6f 6475 6c61  ormalized modula
-00015890: 7469 6f6e 2e0d 0a0d 0a20 2020 2020 2020  tion.....       
-000158a0: 2052 6574 7572 6e73 0d0a 2020 2020 2020   Returns..      
-000158b0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020    ----------..  
-000158c0: 2020 2020 2020 4220 3a20 6e70 2e6e 6461        B : np.nda
-000158d0: 7272 6179 0d0a 2020 2020 2020 2020 2020  rray..          
-000158e0: 2020 5265 6c61 7469 7665 206d 6f64 756c    Relative modul
-000158f0: 6174 696f 6e2c 2069 6e20 7468 6520 7361  ation, in the sa
-00015900: 6d65 2073 6861 7065 2061 7320 6076 602e  me shape as `v`.
-00015910: 0d0a 0d0a 2020 2020 2020 2020 4e6f 7465  ....        Note
-00015920: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
-00015930: 0d0a 2020 2020 2020 2020 2d20 4966 2074  ..        - If t
-00015940: 6865 2061 7474 7269 6275 7465 2060 4276  he attribute `Bv
-00015950: 6020 6f66 2074 6865 2046 7269 6e67 6573  ` of the Fringes
-00015960: 2069 6e73 7461 6e63 6520 6973 206e 6f74   instance is not
-00015970: 204e 6f6e 652c 2074 6865 204d 5446 2069   None, the MTF i
-00015980: 7320 696e 7465 7270 6f6c 6174 6564 2066  s interpolated f
-00015990: 726f 6d20 7072 6576 696f 7573 206d 6561  rom previous mea
-000159a0: 7375 7265 6d65 6e74 732e 5c6e 0d0a 2020  surements.\n..  
-000159b0: 2020 2020 2020 2d20 456c 7365 2c20 6966        - Else, if
-000159c0: 2074 6865 2061 7474 7269 6275 7465 2060   the attribute `
-000159d0: 5053 4660 206f 6620 7468 6520 4672 696e  PSF` of the Frin
-000159e0: 6765 7320 696e 7374 616e 6365 2069 7320  ges instance is 
-000159f0: 6c61 7267 6572 2074 6861 6e20 7a65 726f  larger than zero
-00015a00: 2c20 7468 6520 4d54 4620 6973 2063 6f6d  , the MTF is com
-00015a10: 7075 7465 6420 6672 6f6d 2074 6865 206f  puted from the o
-00015a20: 7074 6963 616c 2074 7261 6e73 6665 7220  ptical transfer 
-00015a30: 6675 6e63 7469 6f6e 206f 6620 7468 6520  function of the 
-00015a40: 6f70 7469 6361 6c20 7379 7374 656d 2c20  optical system, 
-00015a50: 692e 652e 2061 7320 7468 6520 6d61 676e  i.e. as the magn
-00015a60: 6974 7564 6520 6f66 2074 6865 2046 6f75  itude of the Fou
-00015a70: 7269 6572 2d74 7261 6e73 666f 726d 6564  rier-transformed
-00015a80: 2027 506f 696e 7420 5370 7265 6164 2046   'Point Spread F
-00015a90: 756e 6374 696f 6e27 2028 5053 4629 2e5c  unction' (PSF).\
-00015aa0: 6e0d 0a20 2020 2020 2020 202d 2045 6c73  n..        - Els
-00015ab0: 652c 2069 7420 7265 7475 726e 7320 6f6e  e, it returns on
-00015ac0: 6573 2e0d 0a20 2020 2020 2020 2022 2222  es...        """
-00015ad0: 0d0a 0d0a 2020 2020 2020 2020 7620 3d20  ....        v = 
-00015ae0: 6e70 2e61 7272 6179 2876 2c20 666c 6f61  np.array(v, floa
-00015af0: 742c 2063 6f70 793d 4661 6c73 652c 206e  t, copy=False, n
-00015b00: 646d 696e 3d31 290d 0a0d 0a20 2020 2020  dmin=1)....     
-00015b10: 2020 2069 6620 7365 6c66 2e42 7620 6973     if self.Bv is
-00015b20: 206e 6f74 204e 6f6e 653a 2020 2320 696e   not None:  # in
-00015b30: 7465 7270 6f6c 6174 6520 6672 6f6d 206d  terpolate from m
-00015b40: 6561 7375 7265 6d65 6e74 0d0a 2020 2020  easurement..    
-00015b50: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
-00015b60: 7465 7374 3a20 756e 6971 7565 202b 204c  test: unique + L
-00015b70: 5554 0d0a 2020 2020 2020 2020 2020 2020  UT..            
-00015b80: 765f 203d 2076 2e72 6176 656c 2829 0d0a  v_ = v.ravel()..
-00015b90: 2020 2020 2020 2020 2020 2020 7675 203d              vu =
-00015ba0: 206e 702e 756e 6971 7565 2876 290d 0a20   np.unique(v).. 
-00015bb0: 2020 2020 2020 2020 2020 204d 5446 203d             MTF =
-00015bc0: 2073 702e 696e 7465 7270 6f6c 6174 652e   sp.interpolate.
-00015bd0: 696e 7465 7270 3164 280d 0a20 2020 2020  interp1d(..     
-00015be0: 2020 2020 2020 2020 2020 2076 5f2c 2073             v_, s
-00015bf0: 656c 662e 4276 2c20 6b69 6e64 3d22 6375  elf.Bv, kind="cu
-00015c00: 6269 6322 2c20 6669 6c6c 5f76 616c 7565  bic", fill_value
-00015c10: 3d22 6578 7472 6170 6f6c 6174 6522 0d0a  ="extrapolate"..
-00015c20: 2020 2020 2020 2020 2020 2020 2920 2023              )  #
-00015c30: 2074 6f64 6f3a 202e 2e2e 616e 6420 6578   todo: ...and ex
-00015c40: 7472 6170 6f6c 6174 6564 2061 7420 706f  trapolated at po
-00015c50: 696e 7473 206f 7574 7369 6465 2074 6865  ints outside the
-00015c60: 2064 6174 6120 7261 6e67 653f 0d0a 2020   data range?..  
-00015c70: 2020 2020 2020 2020 2020 4220 3d20 4d54            B = MT
-00015c80: 4628 7675 292e 636c 6970 2830 2c20 3129  F(vu).clip(0, 1)
-00015c90: 2e72 6573 6861 7065 2876 2e73 6861 7065  .reshape(v.shape
-00015ca0: 2920 2023 2069 6e74 6572 706f 6c61 7465  )  # interpolate
-00015cb0: 2066 726f 6d20 6d65 6173 7572 6564 206d   from measured m
-00015cc0: 6f64 756c 6174 696f 6e20 7661 6c75 6573  odulation values
-00015cd0: 0d0a 2020 2020 2020 2020 2020 2020 6964  ..            id
-00015ce0: 7820 3d20 6e70 2e61 7267 7768 6572 6528  x = np.argwhere(
-00015cf0: 7620 3d3d 2076 7529 0d0a 2020 2020 2020  v == vu)..      
-00015d00: 2020 2020 2020 4220 3d20 425b 6964 785d        B = B[idx]
-00015d10: 2e72 6573 6861 7065 2876 2e73 6861 7065  .reshape(v.shape
-00015d20: 290d 0a20 2020 2020 2020 2065 6c69 6620  )..        elif 
-00015d30: 7365 6c66 2e50 5346 203e 2030 3a20 2023  self.PSF > 0:  #
-00015d40: 2064 6574 6572 6d69 6e65 2066 726f 6d20   determine from 
-00015d50: 5053 460d 0a20 2020 2020 2020 2020 2020  PSF..           
-00015d60: 2042 203d 2073 656c 662e 4220 2a20 6e70   B = self.B * np
-00015d70: 2e65 7870 282d 3220 2a20 286e 702e 7069  .exp(-2 * (np.pi
-00015d80: 202a 2073 656c 662e 5053 4620 2a20 7629   * self.PSF * v)
-00015d90: 202a 2a20 3229 2020 2320 746f 646f 3a20   ** 2)  # todo: 
-00015da0: 6669 780d 0a20 2020 2020 2020 2020 2020  fix..           
-00015db0: 2023 2074 6f64 6f3a 2077 6861 7420 6973   # todo: what is
-00015dc0: 2073 6d61 6c6c 6572 3a20 646c 206f 7220   smaller: dl or 
-00015dd0: 6c76 3f0d 0a20 2020 2020 2020 2020 2020  lv?..           
-00015de0: 2042 203d 2031 202d 2076 202f 2028 7365   B = 1 - v / (se
-00015df0: 6c66 2e4c 202f 2028 7365 6c66 2e6c 6d69  lf.L / (self.lmi
-00015e00: 6e20 2d20 3129 2920 2023 2061 7070 726f  n - 1))  # appro
-00015e10: 7869 6d61 7469 6f6e 206f 6620 5b42 6f74  ximation of [Bot
-00015e20: 6865 3230 3038 5d0d 0a20 2020 2020 2020  he2008]..       
-00015e30: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-00015e40: 2020 2020 4220 3d20 6e70 2e6f 6e65 7328      B = np.ones(
-00015e50: 762e 7368 6170 6529 0d0a 0d0a 2020 2020  v.shape)....    
-00015e60: 2020 2020 7265 7475 726e 2042 0d0a 0d0a      return B....
-00015e70: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
-00015e80: 2020 2064 6566 2054 2873 656c 6629 202d     def T(self) -
-00015e90: 3e20 696e 743a 0d0a 2020 2020 2020 2020  > int:..        
-00015ea0: 2222 224e 756d 6265 7220 6f66 2066 7261  """Number of fra
-00015eb0: 6d65 732e 2222 220d 0a0d 0a20 2020 2020  mes."""....     
-00015ec0: 2020 2054 203d 2073 656c 662e 4820 2a20     T = self.H * 
-00015ed0: 6e70 2e73 756d 2873 656c 662e 5f4e 290d  np.sum(self._N).
-00015ee0: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
-00015ef0: 6c66 2e46 444d 3a20 2023 2074 6f64 6f3a  lf.FDM:  # todo:
-00015f00: 2066 7261 6374 696f 6e61 6c20 7065 7269   fractional peri
-00015f10: 6f64 730d 0a20 2020 2020 2020 2020 2020  ods..           
-00015f20: 2054 202f 3d20 7365 6c66 2e44 202a 2073   T /= self.D * s
-00015f30: 656c 662e 4b0d 0a0d 0a20 2020 2020 2020  elf.K....       
-00015f40: 2069 6620 7365 6c66 2e53 444d 3a0d 0a20   if self.SDM:.. 
-00015f50: 2020 2020 2020 2020 2020 2054 202f 3d20             T /= 
-00015f60: 7365 6c66 2e44 0d0a 0d0a 2020 2020 2020  self.D....      
-00015f70: 2020 6966 2073 656c 662e 5744 4d3a 0d0a    if self.WDM:..
-00015f80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00015f90: 702e 616c 6c28 7365 6c66 2e4e 203d 3d20  p.all(self.N == 
-00015fa0: 3329 3a20 2023 2057 444d 2061 6c6f 6e67  3):  # WDM along
-00015fb0: 2073 6869 6674 730d 0a20 2020 2020 2020   shifts..       
-00015fc0: 2020 2020 2020 2020 2054 202f 3d20 330d           T /= 3.
-00015fd0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-00015fe0: 6c69 6620 7365 6c66 2e4b 203e 2073 656c  lif self.K > sel
-00015ff0: 662e 443a 2020 2320 5744 4d20 616c 6f6e  f.D:  # WDM alon
-00016000: 6720 7365 7473 2074 6f64 6f0d 0a20 2020  g sets todo..   
-00016010: 2020 2020 2020 2020 2023 2020 2020 2061           #     a
-00016020: 203d 206e 702e 7375 6d28 7365 6c66 2e5f   = np.sum(self._
-00016030: 4e2c 2061 7869 733d 3129 0d0a 2020 2020  N, axis=1)..    
-00016040: 2020 2020 2020 2020 2320 2020 2020 6220          #     b 
-00016050: 3d20 6e70 2e6d 6178 2861 290d 0a20 2020  = np.max(a)..   
-00016060: 2020 2020 2020 2020 2023 2020 2020 2063           #     c
-00016070: 203d 206e 702e 6365 696c 2862 202f 2033   = np.ceil(b / 3
-00016080: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00016090: 2020 2020 2064 203d 2069 6e74 2863 290d       d = int(c).
-000160a0: 0a20 2020 2020 2020 2020 2020 2023 0d0a  .            #..
-000160b0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000160c0: 2020 6132 203d 206e 702e 7375 6d28 7365    a2 = np.sum(se
-000160d0: 6c66 2e5f 4e2c 2061 7869 733d 3029 0d0a  lf._N, axis=0)..
-000160e0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000160f0: 2020 6232 203d 206e 702e 6d61 7828 6132    b2 = np.max(a2
-00016100: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00016110: 2020 2020 2063 3220 3d20 6e70 2e63 6569       c2 = np.cei
-00016120: 6c28 6232 202f 2032 290d 0a20 2020 2020  l(b2 / 2)..     
-00016130: 2020 2020 2020 2023 2020 2020 2064 3220         #     d2 
-00016140: 3d20 696e 7428 6332 290d 0a20 2020 2020  = int(c2)..     
-00016150: 2020 2020 2020 2023 0d0a 2020 2020 2020         #..      
-00016160: 2020 2020 2020 2320 2020 2020 6966 2064        #     if d
-00016170: 203c 2064 323a 0d0a 2020 2020 2020 2020   < d2:..        
-00016180: 2020 2020 2320 2020 2020 2020 2020 5420      #         T 
-00016190: 3d20 696e 7428 6e70 2e63 6569 6c28 6e70  = int(np.ceil(np
-000161a0: 2e6d 6178 286e 702e 7375 6d28 7365 6c66  .max(np.sum(self
-000161b0: 2e5f 4e2c 2061 7869 733d 3129 2920 2f20  ._N, axis=1)) / 
-000161c0: 3329 290d 0a20 2020 2020 2020 2020 2020  3))..           
-000161d0: 2023 2020 2020 2065 6c73 653a 2020 2320   #     else:  # 
-000161e0: 7573 6520 7265 6420 616e 6420 626c 7565  use red and blue
-000161f0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00016200: 2020 2020 2020 2020 5420 3d20 696e 7428          T = int(
-00016210: 6e70 2e63 6569 6c28 6e70 2e6d 6178 286e  np.ceil(np.max(n
-00016220: 702e 7375 6d28 7365 6c66 2e5f 4e2c 2061  p.sum(self._N, a
-00016230: 7869 733d 3029 2920 2f20 3229 290d 0a20  xis=0)) / 2)).. 
-00016240: 2020 2020 2020 2020 2020 2023 2065 6c73             # els
-00016250: 653a 2020 2320 5744 4d20 616c 6f6e 6720  e:  # WDM along 
-00016260: 6469 7265 6374 696f 6e73 2c20 7573 6520  directions, use 
-00016270: 7265 6420 616e 6420 626c 7565 2074 6f64  red and blue tod
-00016280: 6f0d 0a20 2020 2020 2020 2020 2020 2023  o..            #
-00016290: 2020 2020 2061 203d 206e 702e 7375 6d28       a = np.sum(
-000162a0: 7365 6c66 2e5f 4e2c 2061 7869 733d 3029  self._N, axis=0)
-000162b0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000162c0: 2020 2020 6220 3d20 6e70 2e6d 6178 2861      b = np.max(a
-000162d0: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
-000162e0: 2020 2020 2063 203d 206e 702e 6365 696c       c = np.ceil
-000162f0: 2862 202f 2032 290d 0a20 2020 2020 2020  (b / 2)..       
-00016300: 2020 2020 2023 2020 2020 2064 203d 2069       #     d = i
-00016310: 6e74 2863 290d 0a20 2020 2020 2020 2020  nt(c)..         
-00016320: 2020 2023 2020 2020 2054 203d 2069 6e74     #     T = int
-00016330: 286e 702e 6365 696c 286e 702e 6d61 7828  (np.ceil(np.max(
-00016340: 6e70 2e73 756d 2873 656c 662e 5f4e 2c20  np.sum(self._N, 
-00016350: 6178 6973 3d31 2929 202f 2032 2929 0d0a  axis=1)) / 2))..
-00016360: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00016370: 2069 6e74 2854 2920 2023 2075 7365 2069   int(T)  # use i
-00016380: 6e74 2829 2074 6f20 656e 7375 7265 2074  nt() to ensure t
-00016390: 7970 6520 6973 2022 696e 7422 2069 6e73  ype is "int" ins
-000163a0: 7465 6164 206f 6620 226e 756d 7079 2e63  tead of "numpy.c
-000163b0: 6f72 652e 6d75 6c74 6961 7272 6179 2e73  ore.multiarray.s
-000163c0: 6361 6c61 7222 2020 2320 746f 646f 3a20  calar"  # todo: 
-000163d0: 6e65 6365 7373 6172 793f 0d0a 0d0a 2020  necessary?....  
-000163e0: 2020 4054 2e73 6574 7465 720d 0a20 2020    @T.setter..   
-000163f0: 2064 6566 2054 2873 656c 662c 2054 3a20   def T(self, T: 
-00016400: 696e 7429 3a0d 0a20 2020 2020 2020 2023  int):..        #
-00016410: 2061 7474 656e 7469 6f6e 3a20 7061 7261   attention: para
-00016420: 6d73 206d 6179 2063 6861 6e67 6520 6576  ms may change ev
-00016430: 656e 2069 6620 546e 6577 203d 3d20 546f  en if Tnew == To
-00016440: 6c64 0d0a 0d0a 2020 2020 2020 2020 5f54  ld....        _T
-00016450: 203d 2069 6e74 286d 696e 286d 6178 2831   = int(min(max(1
-00016460: 2c20 5429 2c20 7365 6c66 2e5f 546d 6178  , T), self._Tmax
-00016470: 2929 0d0a 0d0a 2020 2020 2020 2020 6966  ))....        if
-00016480: 205f 5420 3d3d 2031 3a20 2023 2057 444d   _T == 1:  # WDM
-00016490: 202b 2053 444d 2074 6f64 6f3a 2046 544d   + SDM todo: FTM
-000164a0: 3f0d 0a20 2020 2020 2020 2020 2020 2069  ?..            i
-000164b0: 6620 7365 6c66 2e67 7269 6420 6e6f 7420  f self.grid not 
-000164c0: 696e 2073 656c 662e 5f67 7269 6473 5b3a  in self._grids[:
-000164d0: 325d 3a0d 0a20 2020 2020 2020 2020 2020  2]:..           
-000164e0: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-000164f0: 2e65 7272 6f72 2866 2243 6f75 6c64 6e27  .error(f"Couldn'
-00016500: 7420 7365 7420 2754 203d 2031 273a 2067  t set 'T = 1': g
-00016510: 7269 6420 6e6f 7420 696e 207b 7365 6c66  rid not in {self
-00016520: 2e5f 6772 6964 735b 3a32 5d7d 272e 2229  ._grids[:2]}'.")
-00016530: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016540: 2020 7265 7475 726e 0d0a 0d0a 2020 2020    return....    
-00016550: 2020 2020 2020 2020 7365 6c66 2e48 203d          self.H =
-00016560: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
-00016570: 7365 6c66 2e4b 203d 2031 0d0a 0d0a 2020  self.K = 1....  
-00016580: 2020 2020 2020 2020 2020 7365 6c66 2e46            self.F
-00016590: 444d 203d 2046 616c 7365 2020 2320 7265  DM = False  # re
-000165a0: 7365 7420 4644 4d20 6265 666f 7265 2073  set FDM before s
-000165b0: 6574 7469 6e67 204e 0d0a 2020 2020 2020  etting N..      
-000165c0: 2020 2020 2020 7365 6c66 2e4e 203d 2033        self.N = 3
-000165d0: 2020 2320 7365 7420 4e20 6265 666f 7265    # set N before
-000165e0: 2057 444d 0d0a 2020 2020 2020 2020 2020   WDM..          
-000165f0: 2020 7365 6c66 2e57 444d 203d 2054 7275    self.WDM = Tru
-00016600: 650d 0a0d 0a20 2020 2020 2020 2020 2020  e....           
-00016610: 2069 6620 7365 6c66 2e44 203d 3d20 323a   if self.D == 2:
-00016620: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016630: 2020 7365 6c66 2e53 444d 203d 2054 7275    self.SDM = Tru
-00016640: 650d 0a20 2020 2020 2020 2065 6c69 6620  e..        elif 
-00016650: 5f54 203d 3d20 323a 2020 2320 5744 4d0d  _T == 2:  # WDM.
-00016660: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00016670: 662e 4820 3d20 310d 0a20 2020 2020 2020  f.H = 1..       
-00016680: 2020 2020 2073 656c 662e 4420 3d20 320d       self.D = 2.
-00016690: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000166a0: 662e 4b20 3d20 310d 0a0d 0a20 2020 2020  f.K = 1....     
-000166b0: 2020 2020 2020 2073 656c 662e 4644 4d20         self.FDM 
-000166c0: 3d20 4661 6c73 6520 2023 2072 6573 6574  = False  # reset
-000166d0: 2046 444d 2062 6566 6f72 6520 7365 7474   FDM before sett
-000166e0: 696e 6720 4e0d 0a20 2020 2020 2020 2020  ing N..         
-000166f0: 2020 2073 656c 662e 5344 4d20 3d20 4661     self.SDM = Fa
-00016700: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
-00016710: 2073 656c 662e 4e20 3d20 3320 2023 2073   self.N = 3  # s
-00016720: 6574 204e 2062 6566 6f72 6520 5744 4d0d  et N before WDM.
-00016730: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00016740: 662e 5744 4d20 3d20 5472 7565 0d0a 2020  f.WDM = True..  
-00016750: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00016760: 2020 2020 2020 2020 2023 2061 7320 6c6f           # as lo
-00016770: 6e67 2061 7320 656e 6f75 6768 2073 6869  ng as enough shi
-00016780: 6674 7320 6172 6520 7468 6572 6520 746f  fts are there to
-00016790: 2063 6f6d 7065 6e73 6174 6520 666f 7220   compensate for 
-000167a0: 6e6f 6e6c 696e 6561 7269 7469 6573 2c0d  nonlinearities,.
-000167b0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-000167c0: 7420 646f 6573 6e27 7420 6d61 7474 6572  t doesn't matter
-000167d0: 2069 6620 7765 2075 7365 206d 6f72 6520   if we use more 
-000167e0: 7368 6966 7473 206f 7220 6d6f 7265 2073  shifts or more s
-000167f0: 6574 730d 0a0d 0a20 2020 2020 2020 2020  ets....         
-00016800: 2020 2023 2073 6574 2062 6f75 6e64 6172     # set boundar
-00016810: 6965 730d 0a20 2020 2020 2020 2020 2020  ies..           
-00016820: 204e 6d69 6e20 3d20 3320 2023 206d 696e   Nmin = 3  # min
-00016830: 696d 756d 206e 756d 6265 7220 6f66 2070  imum number of p
-00016840: 6861 7365 2073 6869 6674 7320 666f 7220  hase shifts for 
-00016850: 6669 7273 7420 7365 7420 746f 2064 6520  first set to de 
-00016860: 6465 6d6f 6475 6c61 7465 642f 6465 636f  demodulated/deco
-00016870: 6465 640d 0a20 2020 2020 2020 2020 2020  ded..           
-00016880: 204e 3132 203d 2046 616c 7365 0d0a 2020   N12 = False..  
-00016890: 2020 2020 2020 2020 2020 2320 746f 646f            # todo
-000168a0: 3a20 4e31 3220 3d20 4e6d 696e 203d 3d20  : N12 = Nmin == 
-000168b0: 3320 2023 2061 6c6c 6f77 204e 2074 6f20  3  # allow N to 
-000168c0: 6265 2069 6e20 5b31 2c20 325d 2069 6620  be in [1, 2] if 
-000168d0: 4b20 3e3d 2032 0d0a 2020 2020 2020 2020  K >= 2..        
-000168e0: 2020 2020 2320 746f 646f 3a20 4e31 3220      # todo: N12 
-000168f0: 3d20 3120 696e 2073 656c 662e 4e20 6f72  = 1 in self.N or
-00016900: 2032 2069 6e20 7365 6c66 2e4e 0d0a 2020   2 in self.N..  
-00016910: 2020 2020 2020 2020 2020 4e67 6f6f 6420            Ngood 
-00016920: 3d20 3420 2023 206d 696e 696d 756d 206e  = 4  # minimum n
-00016930: 756d 6265 7220 6f66 2070 6861 7365 2073  umber of phase s
-00016940: 6869 6674 7320 746f 206f 6274 6169 6e20  hifts to obtain 
-00016950: 676f 6f64 2072 6573 756c 7473 2069 2e65  good results i.e
-00016960: 2e20 7265 6c69 6162 6c65 2072 6573 756c  . reliable resul
-00016970: 7473 2069 6e20 7072 6163 7469 6365 0d0a  ts in practice..
-00016980: 2020 2020 2020 2020 2020 2020 4b6d 6178              Kmax
-00016990: 203d 2073 656c 662e 4b20 2023 2032 2020   = self.K  # 2  
-000169a0: 2320 3320 2023 2074 6f64 6f3a 2077 6869  # 3  # todo: whi
-000169b0: 6368 2069 7320 6265 7474 6572 3a20 3220  ch is better: 2 
-000169c0: 6f72 2033 3f0d 0a20 2020 2020 2020 2020  or 3?..         
-000169d0: 2020 2073 656c 662e 4644 4d20 3d20 4661     self.FDM = Fa
-000169e0: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
-000169f0: 2073 656c 662e 5344 4d20 3d20 4661 6c73   self.SDM = Fals
-00016a00: 650d 0a20 2020 2020 2020 2020 2020 2073  e..            s
-00016a10: 656c 662e 5744 4d20 3d20 4661 6c73 650d  elf.WDM = False.
-00016a20: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-00016a30: 6f64 6f3a 2054 203d 3d20 3420 2d3e 206e  odo: T == 4 -> n
-00016a40: 6f20 6d6f 640d 0a20 2020 2020 2020 2020  o mod..         
-00016a50: 2020 2023 2020 5420 3d3d 2035 202d 3e20     #  T == 5 -> 
-00016a60: 4644 4d20 6966 205f 5420 3e3d 204e 6d69  FDM if _T >= Nmi
-00016a70: 6e3f 0d0a 0d0a 2020 2020 2020 2020 2020  n?....          
-00016a80: 2020 2320 7472 7920 4420 3d3d 2032 2020    # try D == 2  
-00016a90: 2320 746f 646f 3a20 6d75 780d 0a20 2020  # todo: mux..   
-00016aa0: 2020 2020 2020 2020 2069 6620 5f54 203c           if _T <
-00016ab0: 2032 202a 204e 6d69 6e3a 0d0a 2020 2020   2 * Nmin:..    
-00016ac0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00016ad0: 2e44 203d 2031 0d0a 2020 2020 2020 2020  .D = 1..        
-00016ae0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-00016af0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016b00: 4420 3d20 320d 0a0d 0a20 2020 2020 2020  D = 2....       
-00016b10: 2020 2020 2023 2074 7279 2074 6f20 6b65       # try to ke
-00016b20: 6570 2068 7565 730d 0a20 2020 2020 2020  ep hues..       
-00016b30: 2020 2020 2069 6620 5f54 203c 2073 656c       if _T < sel
-00016b40: 662e 4820 2a20 7365 6c66 2e44 202a 204e  f.H * self.D * N
-00016b50: 6d69 6e3a 0d0a 2020 2020 2020 2020 2020  min:..          
-00016b60: 2020 2020 2020 7365 6c66 2e48 203d 205f        self.H = _
-00016b70: 5420 2f2f 2028 7365 6c66 2e44 202a 204e  T // (self.D * N
-00016b80: 6d69 6e29 0d0a 0d0a 2020 2020 2020 2020  min)....        
-00016b90: 2020 2020 7768 696c 6520 5f54 2025 2073      while _T % s
-00016ba0: 656c 662e 4820 213d 2030 3a0d 0a20 2020  elf.H != 0:..   
-00016bb0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00016bc0: 662e 4820 2d3d 2031 0d0a 0d0a 2020 2020  f.H -= 1....    
-00016bd0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00016be0: 4820 3e20 313a 0d0a 2020 2020 2020 2020  H > 1:..        
-00016bf0: 2020 2020 2020 2020 5f54 202f 2f3d 2073          _T //= s
-00016c00: 656c 662e 480d 0a0d 0a20 2020 2020 2020  elf.H....       
-00016c10: 2020 2020 2023 2074 7279 204b 203d 204b       # try K = K
-00016c20: 6d61 780d 0a20 2020 2020 2020 2020 2020  max..           
-00016c30: 2069 6620 4e31 323a 0d0a 2020 2020 2020   if N12:..      
-00016c40: 2020 2020 2020 2020 2020 4b20 3d20 5f54            K = _T
-00016c50: 202f 2f20 7365 6c66 2e44 202d 2028 4e6d   // self.D - (Nm
-00016c60: 696e 202d 2031 2920 2023 204e 6d69 6e20  in - 1)  # Nmin 
-00016c70: 2d20 3120 3d20 323b 2069 2e65 2e20 3220  - 1 = 2; i.e. 2 
-00016c80: 6d6f 7265 2066 6f72 2066 6972 7374 2073  more for first s
-00016c90: 6574 0d0a 2020 2020 2020 2020 2020 2020  et..            
-00016ca0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00016cb0: 2020 2020 2020 204b 203d 205f 5420 2f2f         K = _T //
-00016cc0: 2028 7365 6c66 2e44 202a 204e 6d69 6e29   (self.D * Nmin)
-00016cd0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00016ce0: 6c66 2e4b 203d 206d 696e 284b 2c20 4b6d  lf.K = min(K, Km
-00016cf0: 6178 290d 0a0d 0a20 2020 2020 2020 2020  ax)....         
-00016d00: 2020 2023 2065 6e73 7572 6520 554d 5220     # ensure UMR 
-00016d10: 3e3d 2052 0d0a 2020 2020 2020 2020 2020  >= R..          
-00016d20: 2020 6966 2073 656c 662e 5f61 6d62 6967    if self._ambig
-00016d30: 756f 7573 3a0d 0a20 2020 2020 2020 2020  uous:..         
-00016d40: 2020 2020 2020 2069 6d69 6e20 3d20 6e70         imin = np
-00016d50: 2e61 7267 6d69 6e28 7365 6c66 2e5f 762c  .argmin(self._v,
-00016d60: 2061 7869 733d 3029 0d0a 2020 2020 2020   axis=0)..      
-00016d70: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00016d80: 765b 696d 696e 5d20 3d20 310d 0a0d 0a20  v[imin] = 1.... 
-00016d90: 2020 2020 2020 2020 2020 2023 2074 7279             # try
-00016da0: 204e 203e 3d20 4e67 6f6f 6420 3e3d 204e   N >= Ngood >= N
-00016db0: 6d69 6e0d 0a20 2020 2020 2020 2020 2020  min..           
-00016dc0: 204e 203d 206e 702e 656d 7074 7928 5b73   N = np.empty([s
-00016dd0: 656c 662e 442c 2073 656c 662e 4b5d 2c20  elf.D, self.K], 
-00016de0: 696e 7429 0d0a 2020 2020 2020 2020 2020  int)..          
-00016df0: 2020 4e61 7667 203d 205f 5420 2f2f 2028    Navg = _T // (
-00016e00: 7365 6c66 2e44 202a 2073 656c 662e 4b29  self.D * self.K)
-00016e10: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00016e20: 204e 6176 6720 3c20 4e6d 696e 3a20 2023   Navg < Nmin:  #
-00016e30: 2075 7365 204e 3132 0d0a 2020 2020 2020   use N12..      
-00016e40: 2020 2020 2020 2020 2020 4e5b 3a2c 2030            N[:, 0
-00016e50: 5d20 3d20 4e6d 696e 0d0a 2020 2020 2020  ] = Nmin..      
-00016e60: 2020 2020 2020 2020 2020 4e62 6173 6520            Nbase 
-00016e70: 3d20 285f 5420 2d20 7365 6c66 2e44 202a  = (_T - self.D *
-00016e80: 204e 6d69 6e29 202f 2f20 2873 656c 662e   Nmin) // (self.
-00016e90: 4420 2a20 2873 656c 662e 4b20 2d20 3129  D * (self.K - 1)
-00016ea0: 2920 2023 2061 7474 656e 7469 6f6e 3a20  )  # attention: 
-00016eb0: 6966 204b 203d 3d20 3120 2d3e 2044 203d  if K == 1 -> D =
-00016ec0: 3d20 310d 0a20 2020 2020 2020 2020 2020  = 1..           
-00016ed0: 2020 2020 204e 5b3a 2c20 313a 5d20 3d20       N[:, 1:] = 
-00016ee0: 4e62 6173 650d 0a20 2020 2020 2020 2020  Nbase..         
-00016ef0: 2020 2020 2020 2064 5420 3d20 5f54 202d         dT = _T -
-00016f00: 206e 702e 7375 6d28 4e29 0d0a 2020 2020   np.sum(N)..    
-00016f10: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00016f20: 5420 213d 2030 3a0d 0a20 2020 2020 2020  T != 0:..       
-00016f30: 2020 2020 2020 2020 2020 2020 206b 203d               k =
-00016f40: 2069 6e74 2864 5420 2f2f 2073 656c 662e   int(dT // self.
-00016f50: 4429 0d0a 2020 2020 2020 2020 2020 2020  D)..            
-00016f60: 2020 2020 2020 2020 4e5b 3a2c 2031 203a          N[:, 1 :
-00016f70: 206b 202b 2031 5d20 2b3d 2031 0d0a 2020   k + 1] += 1..  
-00016f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f90: 2020 6966 2064 5420 2520 7365 6c66 2e44    if dT % self.D
-00016fa0: 2021 3d20 303a 0d0a 2020 2020 2020 2020   != 0:..        
-00016fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fc0: 4e5b 302c 206b 202b 2031 5d20 2b3d 2031  N[0, k + 1] += 1
-00016fd0: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-00016fe0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00016ff0: 2020 2020 204e 5b2e 2e2e 5d20 3d20 4e61       N[...] = Na
-00017000: 7667 0d0a 2020 2020 2020 2020 2020 2020  vg..            
-00017010: 2020 2020 6454 203d 205f 5420 2d20 6e70      dT = _T - np
-00017020: 2e73 756d 284e 290d 0a20 2020 2020 2020  .sum(N)..       
-00017030: 2020 2020 2020 2020 2069 6620 6454 2021           if dT !
-00017040: 3d20 303a 0d0a 2020 2020 2020 2020 2020  = 0:..          
-00017050: 2020 2020 2020 2020 2020 6b20 3d20 696e            k = in
-00017060: 7428 6454 202f 2f20 7365 6c66 2e44 290d  t(dT // self.D).
-00017070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017080: 2020 2020 204e 5b3a 2c20 3a6b 5d20 2b3d       N[:, :k] +=
-00017090: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
-000170a0: 2020 2020 2020 2020 6966 2064 5420 2520          if dT % 
-000170b0: 7365 6c66 2e44 2021 3d20 303a 0d0a 2020  self.D != 0:..  
-000170c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170d0: 2020 2020 2020 6420 3d20 6454 2025 2073        d = dT % s
-000170e0: 656c 662e 440d 0a20 2020 2020 2020 2020  elf.D..         
-000170f0: 2020 2020 2020 2020 2020 2020 2020 204e                 N
-00017100: 5b3a 642c 206b 5d20 2b3d 2031 0d0a 2020  [:d, k] += 1..  
-00017110: 2020 2020 2020 2020 2020 7365 6c66 2e4e            self.N
-00017120: 203d 204e 0d0a 0d0a 2020 2020 4070 726f   = N....    @pro
-00017130: 7065 7274 790d 0a20 2020 2064 6566 2059  perty..    def Y
-00017140: 2873 656c 6629 202d 3e20 696e 743a 0d0a  (self) -> int:..
-00017150: 2020 2020 2020 2020 2222 2248 6569 6768          """Heigh
-00017160: 7420 6f66 2066 7269 6e67 6520 7061 7474  t of fringe patt
-00017170: 6572 6e73 2e0d 0a20 2020 2020 2020 205b  erns...        [
-00017180: 595d 203d 2070 782e 2222 220d 0a20 2020  Y] = px."""..   
-00017190: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000171a0: 2e5f 590d 0a0d 0a20 2020 2040 592e 7365  ._Y....    @Y.se
-000171b0: 7474 6572 0d0a 2020 2020 6465 6620 5928  tter..    def Y(
-000171c0: 7365 6c66 2c20 593a 2069 6e74 293a 0d0a  self, Y: int):..
-000171d0: 2020 2020 2020 2020 5f59 203d 2069 6e74          _Y = int
-000171e0: 286d 696e 286d 6178 2831 2c20 5929 2c20  (min(max(1, Y), 
-000171f0: 7365 6c66 2e5f 596d 6178 2c20 7365 6c66  self._Ymax, self
-00017200: 2e5f 506d 6178 202f 2073 656c 662e 5829  ._Pmax / self.X)
-00017210: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
-00017220: 7365 6c66 2e5f 5920 213d 205f 593a 0d0a  self._Y != _Y:..
-00017230: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017240: 2e5f 5920 3d20 5f59 0d0a 2020 2020 2020  ._Y = _Y..      
-00017250: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-00017260: 722e 6465 6275 6728 6622 7b73 656c 662e  r.debug(f"{self.
-00017270: 5f59 203d 207d 2229 0d0a 2020 2020 2020  _Y = }")..      
-00017280: 2020 2020 2020 7365 6c66 2e5f 554d 5220        self._UMR 
-00017290: 3d20 4e6f 6e65 0d0a 0d0a 2020 2020 2020  = None....      
-000172a0: 2020 2020 2020 6966 2073 656c 662e 5f58        if self._X
-000172b0: 203d 3d20 7365 6c66 2e5f 5920 3d3d 2031   == self._Y == 1
-000172c0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000172d0: 2020 2073 656c 662e 4420 3d20 310d 0a20     self.D = 1.. 
-000172e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000172f0: 656c 662e 6178 6973 203d 2030 0d0a 2020  elf.axis = 0..  
-00017300: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
-00017310: 656c 662e 5f58 203d 3d20 313a 0d0a 2020  elf._X == 1:..  
-00017320: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00017330: 6c66 2e44 203d 2031 0d0a 2020 2020 2020  lf.D = 1..      
-00017340: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00017350: 7869 7320 3d20 310d 0a20 2020 2020 2020  xis = 1..       
-00017360: 2020 2020 2065 6c69 6620 7365 6c66 2e5f       elif self._
-00017370: 5920 3d3d 2031 3a0d 0a20 2020 2020 2020  Y == 1:..       
-00017380: 2020 2020 2020 2020 2073 656c 662e 4420           self.D 
-00017390: 3d20 310d 0a20 2020 2020 2020 2020 2020  = 1..           
-000173a0: 2020 2020 2073 656c 662e 6178 6973 203d       self.axis =
-000173b0: 2030 0d0a 0d0a 2020 2020 4070 726f 7065   0....    @prope
-000173c0: 7274 790d 0a20 2020 2064 6566 2058 2873  rty..    def X(s
-000173d0: 656c 663a 2069 6e74 2920 2d3e 2069 6e74  elf: int) -> int
-000173e0: 3a0d 0a20 2020 2020 2020 2022 2222 5769  :..        """Wi
-000173f0: 6474 6820 6f66 2066 7269 6e67 6520 7061  dth of fringe pa
-00017400: 7474 6572 6e73 2e0d 0a20 2020 2020 2020  tterns...       
-00017410: 205b 585d 203d 2070 782e 2222 220d 0a20   [X] = px.""".. 
-00017420: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00017430: 6c66 2e5f 580d 0a0d 0a20 2020 2040 582e  lf._X....    @X.
-00017440: 7365 7474 6572 0d0a 2020 2020 6465 6620  setter..    def 
-00017450: 5828 7365 6c66 2c20 583a 2069 6e74 293a  X(self, X: int):
-00017460: 0d0a 2020 2020 2020 2020 5f58 203d 2069  ..        _X = i
-00017470: 6e74 286d 696e 286d 6178 2831 2c20 5829  nt(min(max(1, X)
-00017480: 2c20 7365 6c66 2e5f 586d 6178 2c20 7365  , self._Xmax, se
-00017490: 6c66 2e5f 506d 6178 202f 2073 656c 662e  lf._Pmax / self.
-000174a0: 5929 290d 0a0d 0a20 2020 2020 2020 2069  Y))....        i
-000174b0: 6620 7365 6c66 2e5f 5820 213d 205f 583a  f self._X != _X:
-000174c0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-000174d0: 6c66 2e5f 5820 3d20 5f58 0d0a 2020 2020  lf._X = _X..    
-000174e0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000174f0: 6765 722e 6465 6275 6728 6622 7b73 656c  ger.debug(f"{sel
-00017500: 662e 5f58 203d 207d 2229 0d0a 2020 2020  f._X = }")..    
-00017510: 2020 2020 2020 2020 7365 6c66 2e5f 554d          self._UM
-00017520: 5220 3d20 4e6f 6e65 0d0a 0d0a 2020 2020  R = None....    
-00017530: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00017540: 5f58 203d 3d20 7365 6c66 2e5f 5920 3d3d  _X == self._Y ==
-00017550: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
-00017560: 2020 2020 2073 656c 662e 4420 3d20 310d       self.D = 1.
-00017570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017580: 2073 656c 662e 6178 6973 203d 2030 0d0a   self.axis = 0..
-00017590: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-000175a0: 2073 656c 662e 5f58 203d 3d20 313a 0d0a   self._X == 1:..
-000175b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175c0: 7365 6c66 2e44 203d 2031 0d0a 2020 2020  self.D = 1..    
-000175d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000175e0: 2e61 7869 7320 3d20 310d 0a20 2020 2020  .axis = 1..     
-000175f0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-00017600: 2e5f 5920 3d3d 2031 3a0d 0a20 2020 2020  ._Y == 1:..     
-00017610: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017620: 4420 3d20 310d 0a20 2020 2020 2020 2020  D = 1..         
-00017630: 2020 2020 2020 2073 656c 662e 6178 6973         self.axis
-00017640: 203d 2030 0d0a 0d0a 2020 2020 4070 726f   = 0....    @pro
-00017650: 7065 7274 790d 0a20 2020 2064 6566 2043  perty..    def C
-00017660: 2873 656c 6629 202d 3e20 696e 743a 0d0a  (self) -> int:..
-00017670: 2020 2020 2020 2020 2222 224e 756d 6265          """Numbe
-00017680: 7220 6f66 2063 6f6c 6f72 2063 6861 6e6e  r of color chann
-00017690: 656c 732e 2222 220d 0a20 2020 2020 2020  els."""..       
-000176a0: 2072 6574 7572 6e20 3320 6966 2073 656c   return 3 if sel
-000176b0: 662e 5744 4d20 6f72 206e 6f74 2073 656c  f.WDM or not sel
-000176c0: 662e 5f6d 6f6e 6f63 6872 6f6d 6520 656c  f._monochrome el
-000176d0: 7365 2031 0d0a 0d0a 2020 2020 4070 726f  se 1....    @pro
-000176e0: 7065 7274 790d 0a20 2020 2064 6566 2052  perty..    def R
-000176f0: 2873 656c 6629 202d 3e20 6e70 2e6e 6461  (self) -> np.nda
-00017700: 7272 6179 3a0d 0a20 2020 2020 2020 2022  rray:..        "
-00017710: 2222 4c65 6e67 7468 7320 6f66 2066 7269  ""Lengths of fri
-00017720: 6e67 6520 7061 7474 6572 6e73 2066 6f72  nge patterns for
-00017730: 2065 6163 6820 6469 7265 6374 696f 6e2e   each direction.
-00017740: 0d0a 2020 2020 2020 2020 5b52 5d20 3d20  ..        [R] = 
-00017750: 7078 2e22 2222 0d0a 0d0a 2020 2020 2020  px."""....      
-00017760: 2020 5220 3d20 6e70 2e61 7272 6179 285b    R = np.array([
-00017770: 7365 6c66 2e58 2c20 7365 6c66 2e59 5d29  self.X, self.Y])
-00017780: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
-00017790: 656c 662e 696e 6465 7869 6e67 203d 3d20  elf.indexing == 
-000177a0: 2269 6a22 3a0d 0a20 2020 2020 2020 2020  "ij":..         
-000177b0: 2020 2052 203d 2052 5b3a 3a2d 315d 0d0a     R = R[::-1]..
-000177c0: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-000177d0: 662e 4420 3d3d 2031 3a0d 0a20 2020 2020  f.D == 1:..     
-000177e0: 2020 2020 2020 2052 203d 206e 702e 6174         R = np.at
-000177f0: 6c65 6173 745f 3164 2852 5b73 656c 662e  least_1d(R[self.
-00017800: 6178 6973 5d29 0d0a 0d0a 2020 2020 2020  axis])....      
-00017810: 2020 7265 7475 726e 2052 0d0a 0d0a 2020    return R....  
-00017820: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-00017830: 2064 6566 2061 6c70 6861 2873 656c 6629   def alpha(self)
-00017840: 202d 3e20 666c 6f61 743a 0d0a 2020 2020   -> float:..    
-00017850: 2020 2020 2222 2246 6163 746f 7220 666f      """Factor fo
-00017860: 7220 6578 7465 6e64 696e 6720 7468 6520  r extending the 
-00017870: 636f 6469 6e67 2072 616e 6765 2060 4c60  coding range `L`
-00017880: 2e22 2222 0d0a 2020 2020 2020 2020 7265  ."""..        re
-00017890: 7475 726e 2073 656c 662e 5f61 6c70 6861  turn self._alpha
-000178a0: 0d0a 0d0a 2020 2020 4061 6c70 6861 2e73  ....    @alpha.s
-000178b0: 6574 7465 720d 0a20 2020 2064 6566 2061  etter..    def a
-000178c0: 6c70 6861 2873 656c 662c 2061 6c70 6861  lpha(self, alpha
-000178d0: 3a20 666c 6f61 7429 3a0d 0a20 2020 2020  : float):..     
-000178e0: 2020 205f 616c 7068 6120 3d20 666c 6f61     _alpha = floa
-000178f0: 7428 6d69 6e28 6d61 7828 312c 2061 6c70  t(min(max(1, alp
-00017900: 6861 292c 2073 656c 662e 5f61 6c70 6861  ha), self._alpha
-00017910: 6d61 7829 290d 0a0d 0a20 2020 2020 2020  max))....       
-00017920: 2069 6620 7365 6c66 2e5f 616c 7068 6120   if self._alpha 
-00017930: 213d 205f 616c 7068 613a 0d0a 2020 2020  != _alpha:..    
-00017940: 2020 2020 2020 2020 7365 6c66 2e5f 616c          self._al
-00017950: 7068 6120 3d20 5f61 6c70 6861 0d0a 2020  pha = _alpha..  
-00017960: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-00017970: 6f67 6765 722e 6465 6275 6728 6622 7b73  ogger.debug(f"{s
-00017980: 656c 662e 5f61 6c70 6861 203d 207d 2229  elf._alpha = }")
-00017990: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-000179a0: 6c66 2e5f 554d 5220 3d20 4e6f 6e65 0d0a  lf._UMR = None..
-000179b0: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
-000179c0: 0a20 2020 2064 6566 204c 2873 656c 6629  .    def L(self)
-000179d0: 202d 3e20 696e 7420 7c20 666c 6f61 743a   -> int | float:
-000179e0: 0d0a 2020 2020 2020 2020 2222 224c 656e  ..        """Len
-000179f0: 6774 6820 746f 2062 6520 656e 636f 6465  gth to be encode
-00017a00: 642e 0d0a 2020 2020 2020 2020 5b4c 5d20  d...        [L] 
-00017a10: 3d20 7078 2e22 2222 0d0a 0d0a 2020 2020  = px."""....    
-00017a20: 2020 2020 7265 7475 726e 2066 6c6f 6174      return float
-00017a30: 2873 656c 662e 522e 6d61 7828 2920 2a20  (self.R.max() * 
-00017a40: 7365 6c66 2e61 6c70 6861 290d 0a0d 0a20  self.alpha).... 
-00017a50: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-00017a60: 2020 6465 6620 6772 6964 2873 656c 6629    def grid(self)
-00017a70: 202d 3e20 7374 723a 0d0a 2020 2020 2020   -> str:..      
-00017a80: 2020 2222 2243 6f6f 7264 696e 6174 6520    """Coordinate 
-00017a90: 7379 7374 656d 206f 6620 7468 6520 6672  system of the fr
-00017aa0: 696e 6765 2070 6174 7465 726e 732e 0d0a  inge patterns...
-00017ab0: 0d0a 2020 2020 2020 2020 5468 6520 666f  ..        The fo
-00017ac0: 6c6c 6f77 696e 6720 7661 6c75 6573 2063  llowing values c
-00017ad0: 616e 2062 6520 7365 743a 5c6e 0d0a 2020  an be set:\n..  
-00017ae0: 2020 2020 2020 2769 6d61 6765 273a 2020        'image':  
-00017af0: 2020 2054 6865 2074 6f70 206c 6566 7420     The top left 
-00017b00: 636f 726e 6572 2070 6978 656c 206f 6620  corner pixel of 
-00017b10: 7468 6520 6772 6964 2069 7320 7468 6520  the grid is the 
-00017b20: 6f72 6967 696e 2061 6e64 2070 6f73 6974  origin and posit
-00017b30: 6976 6520 6469 7265 6374 696f 6e73 2061  ive directions a
-00017b40: 7265 2072 6967 6874 2d20 7265 7370 2e20  re right- resp. 
-00017b50: 646f 776e 7761 7264 732e 5c6e 0d0a 2020  downwards.\n..  
-00017b60: 2020 2020 2020 2743 6172 7465 7369 616e        'Cartesian
-00017b70: 273a 2054 6865 2063 656e 7465 7220 6f66  ': The center of
-00017b80: 2067 7269 6420 6973 2074 6865 206f 7269   grid is the ori
-00017b90: 6769 6e20 616e 6420 706f 7369 7469 7665  gin and positive
-00017ba0: 2064 6972 6563 7469 6f6e 7320 6172 6520   directions are 
-00017bb0: 7269 6768 742d 2072 6573 702e 2075 7077  right- resp. upw
-00017bc0: 6172 6473 2e5c 6e0d 0a20 2020 2020 2020  ards.\n..       
-00017bd0: 2027 706f 6c61 7227 3a20 2020 2020 5468   'polar':     Th
-00017be0: 6520 6365 6e74 6572 206f 6620 6772 6964  e center of grid
-00017bf0: 2069 7320 7468 6520 6f72 6967 696e 2061   is the origin a
-00017c00: 6e64 2070 6f73 6974 6976 6520 6469 7265  nd positive dire
-00017c10: 6374 696f 6e73 2061 7265 2063 6c6f 636b  ctions are clock
-00017c20: 7769 7365 2072 6573 702e 206f 7574 7761  wise resp. outwa
-00017c30: 7264 732e 5c6e 0d0a 2020 2020 2020 2020  rds.\n..        
-00017c40: 276c 6f67 2d70 6f6c 6172 273a 2054 6865  'log-polar': The
-00017c50: 2063 656e 7465 7220 6f66 2067 7269 6420   center of grid 
-00017c60: 6973 2074 6865 206f 7269 6769 6e20 616e  is the origin an
-00017c70: 6420 706f 7369 7469 7665 2064 6972 6563  d positive direc
-00017c80: 7469 6f6e 7320 6172 6520 636c 6f63 6b77  tions are clockw
-00017c90: 6973 6520 7265 7370 2e20 6f75 7477 6172  ise resp. outwar
-00017ca0: 6473 2e0d 0a20 2020 2020 2020 2022 2222  ds...        """
-00017cb0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00017cc0: 2073 656c 662e 5f67 7269 640d 0a0d 0a20   self._grid.... 
-00017cd0: 2020 2040 6772 6964 2e73 6574 7465 720d     @grid.setter.
-00017ce0: 0a20 2020 2064 6566 2067 7269 6428 7365  .    def grid(se
-00017cf0: 6c66 2c20 6772 6964 3a20 7374 7229 3a0d  lf, grid: str):.
-00017d00: 0a20 2020 2020 2020 205f 6772 6964 203d  .        _grid =
-00017d10: 2073 7472 2867 7269 6429 0d0a 0d0a 2020   str(grid)....  
-00017d20: 2020 2020 2020 6966 2028 7365 6c66 2e53        if (self.S
-00017d30: 444d 206f 7220 7365 6c66 2e75 7772 203d  DM or self.uwr =
-00017d40: 3d20 2246 544d 2229 2061 6e64 2073 656c  = "FTM") and sel
-00017d50: 662e 6772 6964 206e 6f74 2069 6e20 7365  f.grid not in se
-00017d60: 6c66 2e5f 6772 6964 735b 3a32 5d3a 0d0a  lf._grids[:2]:..
-00017d70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017d80: 2e6c 6f67 6765 722e 6572 726f 7228 6622  .logger.error(f"
-00017d90: 436f 756c 646e 2774 2073 6574 2027 6772  Couldn't set 'gr
-00017da0: 6964 273a 2067 7269 6420 6e6f 7420 696e  id': grid not in
-00017db0: 207b 7365 6c66 2e5f 6772 6964 735b 3a32   {self._grids[:2
-00017dc0: 5d7d 272e 2229 0d0a 2020 2020 2020 2020  ]}'.")..        
-00017dd0: 2020 2020 7265 7475 726e 0d0a 0d0a 2020      return....  
-00017de0: 2020 2020 2020 6966 2073 656c 662e 5f67        if self._g
-00017df0: 7269 6420 213d 205f 6772 6964 2061 6e64  rid != _grid and
-00017e00: 205f 6772 6964 2069 6e20 7365 6c66 2e5f   _grid in self._
-00017e10: 6772 6964 733a 0d0a 2020 2020 2020 2020  grids:..        
-00017e20: 2020 2020 7365 6c66 2e5f 6772 6964 203d      self._grid =
-00017e30: 205f 6772 6964 0d0a 2020 2020 2020 2020   _grid..        
-00017e40: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-00017e50: 6465 6275 6728 6622 7b73 656c 662e 5f67  debug(f"{self._g
-00017e60: 7269 6420 3d20 7d22 290d 0a20 2020 2020  rid = }")..     
-00017e70: 2020 2020 2020 2073 656c 662e 5344 4d20         self.SDM 
-00017e80: 3d20 7365 6c66 2e53 444d 0d0a 0d0a 2020  = self.SDM....  
-00017e90: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-00017ea0: 2064 6566 2061 6e67 6c65 2873 656c 6629   def angle(self)
-00017eb0: 202d 3e20 666c 6f61 743a 0d0a 2020 2020   -> float:..    
-00017ec0: 2020 2020 2222 2241 6e67 6c65 206f 6620      """Angle of 
-00017ed0: 7468 6520 636f 6f72 6469 6e61 7465 2073  the coordinate s
-00017ee0: 7973 7465 6d27 7320 7072 696e 6369 7061  ystem's principa
-00017ef0: 6c20 6178 6973 2e22 2222 0d0a 2020 2020  l axis."""..    
-00017f00: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00017f10: 5f61 6e67 6c65 0d0a 0d0a 2020 2020 4061  _angle....    @a
-00017f20: 6e67 6c65 2e73 6574 7465 720d 0a20 2020  ngle.setter..   
-00017f30: 2064 6566 2061 6e67 6c65 2873 656c 662c   def angle(self,
-00017f40: 2061 6e67 6c65 3a20 666c 6f61 7429 3a0d   angle: float):.
-00017f50: 0a20 2020 2020 2020 205f 616e 676c 6520  .        _angle 
-00017f60: 3d20 666c 6f61 7428 6e70 2e72 656d 6169  = float(np.remai
-00017f70: 6e64 6572 2861 6e67 6c65 2c20 3336 3029  nder(angle, 360)
-00017f80: 2920 2023 2074 6f64 6f3a 202b 2d20 3435  )  # todo: +- 45
-00017f90: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
-00017fa0: 656c 662e 5f61 6e67 6c65 2021 3d20 5f61  elf._angle != _a
-00017fb0: 6e67 6c65 3a0d 0a20 2020 2020 2020 2020  ngle:..         
-00017fc0: 2020 2073 656c 662e 5f61 6e67 6c65 203d     self._angle =
-00017fd0: 205f 616e 676c 650d 0a20 2020 2020 2020   _angle..       
-00017fe0: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00017ff0: 2e64 6562 7567 2866 227b 7365 6c66 2e5f  .debug(f"{self._
-00018000: 616e 676c 6520 3d20 7d22 290d 0a0d 0a20  angle = }").... 
-00018010: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-00018020: 2020 6465 6620 4428 7365 6c66 2920 2d3e    def D(self) ->
-00018030: 2069 6e74 3a0d 0a20 2020 2020 2020 2022   int:..        "
-00018040: 2222 4e75 6d62 6572 206f 6620 6469 7265  ""Number of dire
-00018050: 6374 696f 6e73 2e22 2222 0d0a 2020 2020  ctions."""..    
-00018060: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00018070: 5f44 0d0a 0d0a 2020 2020 4044 2e73 6574  _D....    @D.set
-00018080: 7465 720d 0a20 2020 2064 6566 2044 2873  ter..    def D(s
-00018090: 656c 662c 2044 3a20 696e 7429 3a0d 0a20  elf, D: int):.. 
-000180a0: 2020 2020 2020 205f 4420 3d20 696e 7428         _D = int(
-000180b0: 6d69 6e28 6d61 7828 312c 2044 292c 2073  min(max(1, D), s
-000180c0: 656c 662e 5f44 6d61 7829 290d 0a0d 0a20  elf._Dmax)).... 
-000180d0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-000180e0: 4420 3e20 5f44 3a0d 0a20 2020 2020 2020  D > _D:..       
-000180f0: 2020 2020 2073 656c 662e 5f44 203d 205f       self._D = _
-00018100: 440d 0a20 2020 2020 2020 2020 2020 2073  D..            s
-00018110: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-00018120: 2866 227b 7365 6c66 2e5f 4420 3d20 7d22  (f"{self._D = }"
-00018130: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
-00018140: 2073 656c 662e 4e20 3d20 7365 6c66 2e5f   self.N = self._
-00018150: 4e5b 3a20 7365 6c66 2e44 2c20 3a5d 0d0a  N[: self.D, :]..
-00018160: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018170: 2e76 203d 2073 656c 662e 5f76 5b3a 2073  .v = self._v[: s
-00018180: 656c 662e 442c 203a 5d0d 0a20 2020 2020  elf.D, :]..     
-00018190: 2020 2020 2020 2073 656c 662e 6620 3d20         self.f = 
-000181a0: 7365 6c66 2e5f 665b 3a20 7365 6c66 2e44  self._f[: self.D
-000181b0: 2c20 3a5d 0d0a 0d0a 2020 2020 2020 2020  , :]....        
-000181c0: 2020 2020 6966 2073 656c 662e 5f44 203d      if self._D =
-000181d0: 3d20 7365 6c66 2e5f 4b20 3d3d 2031 3a0d  = self._K == 1:.
-000181e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000181f0: 2073 656c 662e 4644 4d20 3d20 4661 6c73   self.FDM = Fals
-00018200: 650d 0a0d 0a20 2020 2020 2020 2020 2020  e....           
-00018210: 2073 656c 662e 5344 4d20 3d20 4661 6c73   self.SDM = Fals
-00018220: 650d 0a20 2020 2020 2020 2065 6c69 6620  e..        elif 
-00018230: 7365 6c66 2e5f 4420 3c20 5f44 3a0d 0a20  self._D < _D:.. 
-00018240: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00018250: 5f44 203d 205f 440d 0a20 2020 2020 2020  _D = _D..       
-00018260: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00018270: 2e64 6562 7567 2866 227b 7365 6c66 2e5f  .debug(f"{self._
-00018280: 4420 3d20 7d22 290d 0a0d 0a20 2020 2020  D = }")....     
-00018290: 2020 2020 2020 2073 656c 662e 4e20 3d20         self.N = 
-000182a0: 6e70 2e61 7070 656e 6428 7365 6c66 2e5f  np.append(self._
-000182b0: 4e2c 206e 702e 7469 6c65 2873 656c 662e  N, np.tile(self.
-000182c0: 5f4e 5b2d 312c 203a 5d2c 2028 5f44 202d  _N[-1, :], (_D -
-000182d0: 2073 656c 662e 5f4e 2e73 6861 7065 5b30   self._N.shape[0
-000182e0: 5d2c 2031 2929 2c20 6178 6973 3d30 290d  ], 1)), axis=0).
-000182f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00018300: 662e 7620 3d20 6e70 2e61 7070 656e 6428  f.v = np.append(
-00018310: 7365 6c66 2e5f 762c 206e 702e 7469 6c65  self._v, np.tile
-00018320: 2873 656c 662e 5f76 5b2d 312c 203a 5d2c  (self._v[-1, :],
-00018330: 2028 5f44 202d 2073 656c 662e 5f76 2e73   (_D - self._v.s
-00018340: 6861 7065 5b30 5d2c 2031 2929 2c20 6178  hape[0], 1)), ax
-00018350: 6973 3d30 290d 0a20 2020 2020 2020 2020  is=0)..         
-00018360: 2020 2073 656c 662e 6620 3d20 6e70 2e61     self.f = np.a
-00018370: 7070 656e 6428 7365 6c66 2e5f 662c 206e  ppend(self._f, n
-00018380: 702e 7469 6c65 2873 656c 662e 5f66 5b2d  p.tile(self._f[-
-00018390: 312c 203a 5d2c 2028 5f44 202d 2073 656c  1, :], (_D - sel
-000183a0: 662e 5f66 2e73 6861 7065 5b30 5d2c 2031  f._f.shape[0], 1
-000183b0: 2929 2c20 6178 6973 3d30 290d 0a0d 0a20  )), axis=0).... 
-000183c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000183d0: 4220 3d20 7365 6c66 2e42 0d0a 0d0a 2020  B = self.B....  
-000183e0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-000183f0: 2064 6566 2061 7869 7328 7365 6c66 2920   def axis(self) 
-00018400: 2d3e 2069 6e74 3a0d 0a20 2020 2020 2020  -> int:..       
-00018410: 2022 2222 4178 6973 2061 6c6f 6e67 2077   """Axis along w
-00018420: 6869 6368 2074 6f20 7368 6966 7420 6966  hich to shift if
-00018430: 206e 756d 6265 7220 6f66 2064 6972 6563   number of direc
-00018440: 7469 6f6e 7320 6571 7561 6c73 206f 6e65  tions equals one
-00018450: 2e0d 0a0d 0a20 2020 2020 2020 2045 6974  .....        Eit
-00018460: 6865 7220 6030 6020 6f72 2060 3160 2e22  her `0` or `1`."
-00018470: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
-00018480: 726e 2073 656c 662e 5f61 7869 730d 0a0d  rn self._axis...
-00018490: 0a20 2020 2040 6178 6973 2e73 6574 7465  .    @axis.sette
-000184a0: 720d 0a20 2020 2064 6566 2061 7869 7328  r..    def axis(
-000184b0: 7365 6c66 2c20 6178 6973 3a20 696e 7429  self, axis: int)
-000184c0: 3a0d 0a20 2020 2020 2020 205f 6178 6973  :..        _axis
-000184d0: 203d 2069 6e74 286d 696e 286d 6178 2830   = int(min(max(0
-000184e0: 2c20 6178 6973 292c 2031 2929 0d0a 0d0a  , axis), 1))....
-000184f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00018500: 5f61 7869 7320 213d 205f 6178 6973 3a0d  _axis != _axis:.
-00018510: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00018520: 662e 5f61 7869 7320 3d20 5f61 7869 730d  f._axis = _axis.
-00018530: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00018540: 662e 6c6f 6767 6572 2e64 6562 7567 2866  f.logger.debug(f
-00018550: 227b 7365 6c66 2e5f 6178 6973 203d 207d  "{self._axis = }
-00018560: 2229 0d0a 0d0a 2020 2020 4070 726f 7065  ")....    @prope
-00018570: 7274 790d 0a20 2020 2064 6566 205f 4d28  rty..    def _M(
-00018580: 7365 6c66 2920 2d3e 206e 702e 6e64 6172  self) -> np.ndar
-00018590: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
-000185a0: 224e 756d 6265 7220 6f66 2061 7665 7261  "Number of avera
-000185b0: 6765 6420 696e 7465 6e73 6974 7920 7361  ged intensity sa
-000185c0: 6d70 6c65 732e 2222 220d 0a20 2020 2020  mples."""..     
-000185d0: 2020 204d 203d 206e 702e 7375 6d28 7365     M = np.sum(se
-000185e0: 6c66 2e68 2c20 6178 6973 3d30 2920 2f20  lf.h, axis=0) / 
-000185f0: 3235 350d 0a20 2020 2020 2020 2072 6574  255..        ret
-00018600: 7572 6e20 6e70 2e61 746c 6561 7374 5f31  urn np.atleast_1
-00018610: 6428 4d5b 305d 2920 6966 2073 656c 662e  d(M[0]) if self.
-00018620: 5f6d 6f6e 6f63 6872 6f6d 6520 656c 7365  _monochrome else
-00018630: 204d 0d0a 0d0a 2020 2020 4070 726f 7065   M....    @prope
-00018640: 7274 790d 0a20 2020 2064 6566 204d 2873  rty..    def M(s
-00018650: 656c 6629 202d 3e20 666c 6f61 7420 7c20  elf) -> float | 
-00018660: 6e70 2e6e 6461 7272 6179 3a0d 0a20 2020  np.ndarray:..   
-00018670: 2020 2020 2022 2222 4e75 6d62 6572 206f       """Number o
-00018680: 6620 6176 6572 6167 6564 2069 6e74 656e  f averaged inten
-00018690: 7369 7479 2073 616d 706c 6573 2e22 2222  sity samples."""
-000186a0: 0d0a 2020 2020 2020 2020 4d20 3d20 6d61  ..        M = ma
-000186b0: 7828 3120 2f20 3235 352c 206e 702e 7269  x(1 / 255, np.ri
-000186c0: 6e74 286e 702e 6d65 616e 2873 656c 662e  nt(np.mean(self.
-000186d0: 5f4d 2929 2920 2023 2074 6f64 6f0d 0a20  _M)))  # todo.. 
-000186e0: 2020 2020 2020 2072 6574 7572 6e20 666c         return fl
-000186f0: 6f61 7428 4d29 2020 2320 636f 6e76 6572  oat(M)  # conver
-00018700: 7420 4e75 6d70 7920 666c 6f61 7436 3420  t Numpy float64 
-00018710: 746f 2050 7974 686f 6e20 666c 6f61 740d  to Python float.
-00018720: 0a0d 0a20 2020 2040 4d2e 7365 7474 6572  ...    @M.setter
-00018730: 0d0a 2020 2020 6465 6620 4d28 7365 6c66  ..    def M(self
-00018740: 2c20 4d3a 2066 6c6f 6174 293a 0d0a 2020  , M: float):..  
-00018750: 2020 2020 2020 5f4d 203d 206d 696e 286d        _M = min(m
-00018760: 6178 2831 202f 2032 3535 2c20 4d29 2c20  ax(1 / 255, M), 
-00018770: 7365 6c66 2e5f 4d6d 6178 290d 0a0d 0a20  self._Mmax).... 
-00018780: 2020 2020 2020 2069 6620 6e70 2e61 6e79         if np.any
-00018790: 2873 656c 662e 4d20 213d 205f 4d29 3a0d  (self.M != _M):.
-000187a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000187b0: 5f4d 203c 2031 3a20 2023 2066 7261 6374  _M < 1:  # fract
-000187c0: 696f 6e61 6c20 7061 7274 206f 6e6c 790d  ional part only.
-000187d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000187e0: 2068 203d 206e 702e 6172 7261 7928 5b5b   h = np.array([[
-000187f0: 696e 7428 3235 3520 2a20 5f4d 2025 2032  int(255 * _M % 2
-00018800: 3535 2920 666f 7220 6320 696e 2072 616e  55) for c in ran
-00018810: 6765 2833 295d 5d2c 206e 702e 7569 6e74  ge(3)]], np.uint
-00018820: 3829 0d0a 2020 2020 2020 2020 2020 2020  8)..            
-00018830: 656c 6966 205f 4d20 2520 3120 3d3d 2030  elif _M % 1 == 0
-00018840: 3a20 2023 2069 6e74 6567 6572 2070 6172  :  # integer par
-00018850: 7420 6f6e 6c79 0d0a 2020 2020 2020 2020  t only..        
-00018860: 2020 2020 2020 2020 6820 3d20 6e70 2e61          h = np.a
-00018870: 7272 6179 285b 5b32 3535 2c20 3235 352c  rray([[255, 255,
-00018880: 2032 3535 5d5d 202a 2069 6e74 285f 4d29   255]] * int(_M)
-00018890: 2c20 6e70 2e75 696e 7438 290d 0a20 2020  , np.uint8)..   
-000188a0: 2020 2020 2020 2020 2065 6c73 653a 2020           else:  
-000188b0: 2320 696e 7465 6765 7220 616e 6420 6672  # integer and fr
-000188c0: 6163 7469 6f6e 616c 2070 6172 740d 0a20  actional part.. 
-000188d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-000188e0: 5f69 6e74 203d 206e 702e 6172 7261 7928  _int = np.array(
-000188f0: 5b5b 3235 352c 2032 3535 2c20 3235 355d  [[255, 255, 255]
-00018900: 5d20 2a20 696e 7428 5f4d 292c 206e 702e  ] * int(_M), np.
-00018910: 7569 6e74 3829 0d0a 2020 2020 2020 2020  uint8)..        
-00018920: 2020 2020 2020 2020 685f 6672 6163 7420          h_fract 
-00018930: 3d20 6e70 2e61 7272 6179 285b 5b69 6e74  = np.array([[int
-00018940: 2832 3535 202a 205f 4d20 2520 3235 3529  (255 * _M % 255)
-00018950: 2066 6f72 2063 2069 6e20 7261 6e67 6528   for c in range(
-00018960: 3329 5d5d 2c20 6e70 2e75 696e 7438 290d  3)]], np.uint8).
-00018970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018980: 2068 203d 206e 702e 636f 6e63 6174 656e   h = np.concaten
-00018990: 6174 6528 2868 5f69 6e74 2c20 685f 6672  ate((h_int, h_fr
-000189a0: 6163 7429 290d 0a0d 0a20 2020 2020 2020  act))....       
-000189b0: 2020 2020 2073 656c 662e 6820 3d20 680d       self.h = h.
-000189c0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
-000189d0: 0d0a 2020 2020 6465 6620 4828 7365 6c66  ..    def H(self
-000189e0: 2920 2d3e 2069 6e74 3a0d 0a20 2020 2020  ) -> int:..     
-000189f0: 2020 2022 2222 4e75 6d62 6572 206f 6620     """Number of 
-00018a00: 6875 6573 2e22 2222 0d0a 2020 2020 2020  hues."""..      
-00018a10: 2020 7265 7475 726e 2073 656c 662e 682e    return self.h.
-00018a20: 7368 6170 655b 305d 0d0a 0d0a 2020 2020  shape[0]....    
-00018a30: 4048 2e73 6574 7465 720d 0a20 2020 2064  @H.setter..    d
-00018a40: 6566 2048 2873 656c 662c 2048 3a20 696e  ef H(self, H: in
-00018a50: 7429 3a0d 0a20 2020 2020 2020 205f 4820  t):..        _H 
-00018a60: 3d20 696e 7428 6d69 6e28 6d61 7828 312c  = int(min(max(1,
-00018a70: 2048 292c 2073 656c 662e 5f48 6d61 7829   H), self._Hmax)
-00018a80: 290d 0a0d 0a20 2020 2020 2020 2023 2069  )....        # i
-00018a90: 6620 7365 6c66 2e57 444d 3a0d 0a20 2020  f self.WDM:..   
-00018aa0: 2020 2020 2023 2020 2020 2073 656c 662e       #     self.
-00018ab0: 6c6f 6767 6572 2e65 7272 6f72 2822 436f  logger.error("Co
-00018ac0: 756c 646e 2774 2073 6574 2027 4827 3a20  uldn't set 'H': 
-00018ad0: 5744 4d20 6973 2061 6374 6976 652e 2229  WDM is active.")
-00018ae0: 0d0a 2020 2020 2020 2020 2320 2020 2020  ..        #     
-00018af0: 7265 7475 726e 0d0a 0d0a 2020 2020 2020  return....      
-00018b00: 2020 6966 2073 656c 662e 4820 213d 205f    if self.H != _
-00018b10: 483a 0d0a 2020 2020 2020 2020 2020 2020  H:..            
-00018b20: 6966 2073 656c 662e 5744 4d3a 0d0a 2020  if self.WDM:..  
-00018b30: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00018b40: 6c66 2e68 203d 2022 7722 202a 205f 480d  lf.h = "w" * _H.
-00018b50: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00018b60: 6620 5f48 203d 3d20 313a 0d0a 2020 2020  f _H == 1:..    
-00018b70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018b80: 2e68 203d 2022 7722 0d0a 2020 2020 2020  .h = "w"..      
-00018b90: 2020 2020 2020 656c 6966 205f 4820 3d3d        elif _H ==
-00018ba0: 2032 3a0d 0a20 2020 2020 2020 2020 2020   2:..           
-00018bb0: 2020 2020 2073 656c 662e 6820 3d20 2272       self.h = "r
-00018bc0: 6222 2020 2320 746f 646f 0d0a 2020 2020  b"  # todo..    
-00018bd0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-00018be0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00018bf0: 203d 2022 7267 6222 202a 2028 5f48 202f   = "rgb" * (_H /
-00018c00: 2f20 3320 2b20 3129 0d0a 2020 2020 2020  / 3 + 1)..      
-00018c10: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-00018c20: 203d 2068 5b3a 5f48 5d0d 0a0d 0a20 2020   = h[:_H]....   
-00018c30: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
-00018c40: 6465 6620 6828 7365 6c66 2920 2d3e 206e  def h(self) -> n
-00018c50: 702e 6e64 6172 7261 793a 0d0a 2020 2020  p.ndarray:..    
-00018c60: 2020 2020 2222 2248 7565 7320 692e 652e      """Hues i.e.
-00018c70: 2063 6f6c 6f72 7320 6f66 2066 7269 6e67   colors of fring
-00018c80: 6520 7061 7474 6572 6e73 2e0d 0a0d 0a20  e patterns..... 
-00018c90: 2020 2020 2020 2050 6f73 7369 626c 6520         Possible 
-00018ca0: 7661 6c75 6573 2061 7265 2061 6e79 2073  values are any s
-00018cb0: 6571 7565 6e63 6520 6f66 2052 4742 2063  equence of RGB c
-00018cc0: 6f6c 6f72 2074 7269 706c 6573 2077 6974  olor triples wit
-00018cd0: 6869 6e20 7468 6520 696e 7465 7276 616c  hin the interval
-00018ce0: 205b 302c 2032 3535 5d2e 0d0a 2020 2020   [0, 255]...    
-00018cf0: 2020 2020 486f 7765 7665 722c 2062 6c61      However, bla
-00018d00: 636b 2028 302c 2030 2c20 3029 2069 7320  ck (0, 0, 0) is 
-00018d10: 6e6f 7420 616c 6c6f 7765 642e 0d0a 0d0a  not allowed.....
-00018d20: 2020 2020 2020 2020 5468 6520 6875 6520          The hue 
-00018d30: 7661 6c75 6573 2063 616e 2061 6c73 6f20  values can also 
-00018d40: 6265 2073 6574 2062 7920 6173 7369 676e  be set by assign
-00018d50: 696e 6720 616e 7920 636f 6d62 696e 6174  ing any combinat
-00018d60: 696f 6e20 6f66 2074 6865 2066 6f6c 6c6f  ion of the follo
-00018d70: 7769 6e67 2063 6861 7261 6374 6572 7320  wing characters 
-00018d80: 6173 2061 2073 7472 696e 673a 5c6e 0d0a  as a string:\n..
-00018d90: 2020 2020 2020 2020 2d20 2772 273a 2072          - 'r': r
-00018da0: 6564 205c 6e0d 0a20 2020 2020 2020 202d  ed \n..        -
-00018db0: 2027 6727 3a20 6772 6565 6e5c 6e0d 0a20   'g': green\n.. 
-00018dc0: 2020 2020 2020 202d 2027 6227 3a20 626c         - 'b': bl
-00018dd0: 7565 5c6e 0d0a 2020 2020 2020 2020 2d20  ue\n..        - 
-00018de0: 2763 273a 2063 7961 6e5c 6e0d 0a20 2020  'c': cyan\n..   
-00018df0: 2020 2020 202d 2027 6d27 3a20 6d61 6765       - 'm': mage
-00018e00: 6e74 615c 6e0d 0a20 2020 2020 2020 202d  nta\n..        -
-00018e10: 2027 7927 3a20 7965 6c6c 6f77 5c6e 0d0a   'y': yellow\n..
-00018e20: 2020 2020 2020 2020 2d20 2777 273a 2077          - 'w': w
-00018e30: 6869 7465 5c6e 0d0a 0d0a 2020 2020 2020  hite\n....      
-00018e40: 2020 4265 666f 7265 2064 6563 6f64 696e    Before decodin
-00018e50: 672c 2072 6570 6561 7469 6e67 2068 7565  g, repeating hue
-00018e60: 7320 7769 6c6c 2062 6520 6675 7365 6420  s will be fused 
-00018e70: 6279 2061 7665 7261 6769 6e67 2e22 2222  by averaging."""
-00018e80: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00018e90: 2073 656c 662e 5f68 0d0a 0d0a 2020 2020   self._h....    
-00018ea0: 4068 2e73 6574 7465 720d 0a20 2020 2064  @h.setter..    d
-00018eb0: 6566 2068 2873 656c 662c 2068 3a20 696e  ef h(self, h: in
-00018ec0: 7420 7c20 7475 706c 655b 696e 745d 207c  t | tuple[int] |
-00018ed0: 206c 6973 745b 696e 745d 207c 206e 702e   list[int] | np.
-00018ee0: 6e64 6172 7261 7920 7c20 7374 7229 3a0d  ndarray | str):.
-00018ef0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00018f00: 7374 616e 6365 2868 2c20 7374 7229 3a0d  stance(h, str):.
-00018f10: 0a20 2020 2020 2020 2020 2020 204c 5554  .            LUT
-00018f20: 203d 207b 0d0a 2020 2020 2020 2020 2020   = {..          
-00018f30: 2020 2020 2020 2272 223a 205b 3235 352c        "r": [255,
-00018f40: 2030 2c20 305d 2c0d 0a20 2020 2020 2020   0, 0],..       
-00018f50: 2020 2020 2020 2020 2022 6722 3a20 5b30           "g": [0
-00018f60: 2c20 3235 352c 2030 5d2c 0d0a 2020 2020  , 255, 0],..    
-00018f70: 2020 2020 2020 2020 2020 2020 2262 223a              "b":
-00018f80: 205b 302c 2030 2c20 3235 355d 2c0d 0a20   [0, 0, 255],.. 
-00018f90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018fa0: 6322 3a20 5b30 2c20 3235 352c 2032 3535  c": [0, 255, 255
-00018fb0: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
-00018fc0: 2020 2020 226d 223a 205b 3235 352c 2030      "m": [255, 0
-00018fd0: 2c20 3235 355d 2c0d 0a20 2020 2020 2020  , 255],..       
-00018fe0: 2020 2020 2020 2020 2022 7922 3a20 5b32           "y": [2
-00018ff0: 3535 2c20 3235 352c 2030 5d2c 0d0a 2020  55, 255, 0],..  
-00019000: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-00019010: 223a 205b 3235 352c 2032 3535 2c20 3235  ": [255, 255, 25
-00019020: 355d 2c0d 0a20 2020 2020 2020 2020 2020  5],..           
-00019030: 207d 0d0a 2020 2020 2020 2020 2020 2020   }..            
-00019040: 6966 2073 6574 2868 2e6c 6f77 6572 2829  if set(h.lower()
-00019050: 292e 696e 7465 7273 6563 7469 6f6e 284c  ).intersection(L
-00019060: 5554 2e6b 6579 7328 2929 3a0d 0a20 2020  UT.keys()):..   
-00019070: 2020 2020 2020 2020 2020 2020 2068 203d               h =
-00019080: 205b 4c55 545b 635d 2066 6f72 2063 2069   [LUT[c] for c i
-00019090: 6e20 682e 6c6f 7765 7228 295d 0d0a 2020  n h.lower()]..  
-000190a0: 2020 2020 2020 2020 2020 656c 6966 2068            elif h
-000190b0: 203d 3d20 2264 6566 6175 6c74 223a 0d0a   == "default":..
-000190c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190d0: 6820 3d20 7365 6c66 2e64 6566 6175 6c74  h = self.default
-000190e0: 735b 2268 225d 0d0a 2020 2020 2020 2020  s["h"]..        
-000190f0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-00019100: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00019110: 6e0d 0a0d 0a20 2020 2020 2020 2023 206d  n....        # m
-00019120: 616b 6520 6172 7261 792c 2063 6c69 7020  ake array, clip 
-00019130: 6669 7273 7420 616e 6420 7468 656e 2063  first and then c
-00019140: 6173 7420 746f 2064 7479 7065 2074 6f20  ast to dtype to 
-00019150: 6176 6f69 6420 696e 7465 6765 7220 756e  avoid integer un
-00019160: 6465 722d 2f6f 7665 7266 6c6f 770d 0a20  der-/overflow.. 
-00019170: 2020 2020 2020 205f 6820 3d20 6e70 2e61         _h = np.a
-00019180: 7272 6179 2868 292e 636c 6970 2830 2c20  rray(h).clip(0, 
-00019190: 3235 3529 2e61 7374 7970 6528 2275 696e  255).astype("uin
-000191a0: 7438 222c 2063 6f70 793d 4661 6c73 6529  t8", copy=False)
-000191b0: 0d0a 0d0a 2020 2020 2020 2020 6966 206e  ....        if n
-000191c0: 6f74 205f 682e 7369 7a65 3a20 2023 2065  ot _h.size:  # e
-000191d0: 6d70 7479 2061 7272 6179 0d0a 2020 2020  mpty array..    
-000191e0: 2020 2020 2020 2020 7265 7475 726e 0d0a          return..
-000191f0: 0d0a 2020 2020 2020 2020 2320 7472 696d  ..        # trim
-00019200: 3a20 6368 616e 6765 2073 6861 7065 2074  : change shape t
-00019210: 6f20 2848 2c20 3329 206f 7220 6c69 6d69  o (H, 3) or limi
-00019220: 7420 7368 6170 650d 0a20 2020 2020 2020  t shape..       
-00019230: 2069 6620 5f68 2e6e 6469 6d20 3d3d 2030   if _h.ndim == 0
-00019240: 3a0d 0a20 2020 2020 2020 2020 2020 205f  :..            _
-00019250: 6820 3d20 6e70 2e66 756c 6c28 2873 656c  h = np.full((sel
-00019260: 662e 482c 2033 292c 205f 6829 0d0a 2020  f.H, 3), _h)..  
-00019270: 2020 2020 2020 656c 6966 205f 682e 7368        elif _h.sh
-00019280: 6170 655b 6d69 6e28 5f68 2e6e 6469 6d20  ape[min(_h.ndim 
-00019290: 2d20 312c 2031 295d 203c 2033 3a0d 0a20  - 1, 1)] < 3:.. 
-000192a0: 2020 2020 2020 2020 2020 205f 6820 3d20             _h = 
-000192b0: 6e70 2e66 756c 6c28 2873 656c 662e 482c  np.full((self.H,
-000192c0: 2033 292c 205f 685b 6d69 6e28 5f68 2e6e   3), _h[min(_h.n
-000192d0: 6469 6d20 2d20 312c 2031 295d 290d 0a20  dim - 1, 1)]).. 
-000192e0: 2020 2020 2020 2065 6c69 6620 5f68 2e6e         elif _h.n
-000192f0: 6469 6d20 3d3d 2031 3a0d 0a20 2020 2020  dim == 1:..     
-00019300: 2020 2020 2020 205f 6820 3d20 6e70 2e76         _h = np.v
-00019310: 7374 6163 6b28 5b5f 685b 3a33 5d20 666f  stack([_h[:3] fo
-00019320: 7220 6820 696e 2072 616e 6765 2873 656c  r h in range(sel
-00019330: 662e 4829 5d29 0d0a 2020 2020 2020 2020  f.H)])..        
-00019340: 656c 6966 205f 682e 6e64 696d 203d 3d20  elif _h.ndim == 
-00019350: 323a 0d0a 2020 2020 2020 2020 2020 2020  2:..            
-00019360: 5f68 203d 205f 685b 3a20 7365 6c66 2e5f  _h = _h[: self._
-00019370: 486d 6178 2c20 3a33 5d0d 0a20 2020 2020  Hmax, :3]..     
-00019380: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-00019390: 2020 2020 2020 5f68 203d 205f 685b 3a20        _h = _h[: 
-000193a0: 7365 6c66 2e5f 486d 6178 2c20 3a33 2c20  self._Hmax, :3, 
-000193b0: 2e2e 2e2c 202d 315d 0d0a 0d0a 2020 2020  ..., -1]....    
-000193c0: 2020 2020 6966 205f 682e 7368 6170 655b      if _h.shape[
-000193d0: 315d 203d 3d20 323a 2020 2320 432d 6178  1] == 2:  # C-ax
-000193e0: 6973 206d 7573 7420 6571 7561 6c20 330d  is must equal 3.
-000193f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00019400: 662e 6c6f 6767 6572 2e65 7272 6f72 2822  f.logger.error("
-00019410: 436f 756c 646e 2774 2073 6574 2027 6827  Couldn't set 'h'
-00019420: 3a20 4f6e 6c79 2032 2069 6e73 7465 6164  : Only 2 instead
-00019430: 206f 6620 3320 636f 6c6f 7220 6368 616e   of 3 color chan
-00019440: 6e65 6c73 2070 726f 7669 6465 642e 2229  nels provided.")
-00019450: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00019460: 7475 726e 0d0a 0d0a 2020 2020 2020 2020  turn....        
-00019470: 6966 206e 702e 616e 7928 6e70 2e6d 6178  if np.any(np.max
-00019480: 285f 682c 2061 7869 733d 3129 203d 3d20  (_h, axis=1) == 
-00019490: 3029 3a0d 0a20 2020 2020 2020 2020 2020  0):..           
-000194a0: 2073 656c 662e 6c6f 6767 6572 2e65 7272   self.logger.err
-000194b0: 6f72 2822 4469 646e 2774 2073 6574 2027  or("Didn't set '
-000194c0: 6827 3a20 426c 6163 6b20 636f 6c6f 7220  h': Black color 
-000194d0: 6973 206e 6f74 2061 6c6c 6f77 6564 2e22  is not allowed."
-000194e0: 290d 0a20 2020 2020 2020 2020 2020 2072  )..            r
-000194f0: 6574 7572 6e0d 0a0d 0a20 2020 2020 2020  eturn....       
-00019500: 2069 6620 7365 6c66 2e57 444d 2061 6e64   if self.WDM and
-00019510: 206e 6f74 2073 656c 662e 5f6d 6f6e 6f63   not self._monoc
-00019520: 6872 6f6d 653a 0d0a 2020 2020 2020 2020  hrome:..        
-00019530: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-00019540: 6572 726f 7228 2243 6f75 6c64 6e27 7420  error("Couldn't 
-00019550: 7365 7420 2768 273a 2027 5744 4d27 2069  set 'h': 'WDM' i
-00019560: 7320 6163 7469 7665 2c20 6275 7420 6e6f  s active, but no
-00019570: 7420 616c 6c20 6875 6573 2061 7265 206d  t all hues are m
-00019580: 6f6e 6f63 6872 6f6d 6174 6963 2e22 290d  onochromatic.").
-00019590: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000195a0: 7572 6e0d 0a0d 0a20 2020 2020 2020 2069  urn....        i
-000195b0: 6620 6e6f 7420 6e70 2e61 7272 6179 5f65  f not np.array_e
-000195c0: 7175 616c 2873 656c 662e 5f68 2c20 5f68  qual(self._h, _h
-000195d0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-000195e0: 486f 6c64 203d 2073 656c 662e 480d 0a20  Hold = self.H.. 
-000195f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019600: 5f68 203d 205f 680d 0a20 2020 2020 2020  _h = _h..       
-00019610: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00019620: 2e64 6562 7567 2866 2273 656c 662e 5f68  .debug(f"self._h
-00019630: 203d 207b 7374 7228 7365 6c66 2e5f 6829   = {str(self._h)
-00019640: 2e72 6570 6c61 6365 2863 6872 2831 3029  .replace(chr(10)
-00019650: 2c20 272c 2729 7d22 290d 0a20 2020 2020  , ',')}")..     
-00019660: 2020 2020 2020 2069 6620 486f 6c64 2021         if Hold !
-00019670: 3d20 5f68 2e73 6861 7065 5b30 5d3a 0d0a  = _h.shape[0]:..
-00019680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019690: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-000196a0: 6728 6622 7365 6c66 2e48 203d 207b 5f68  g(f"self.H = {_h
-000196b0: 2e73 6861 7065 5b30 5d7d 2229 2020 2320  .shape[0]}")  # 
-000196c0: 636f 6d70 7574 6564 2075 706f 6e20 6361  computed upon ca
-000196d0: 6c6c 0d0a 2020 2020 2020 2020 2020 2020  ll..            
-000196e0: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-000196f0: 6728 6622 7b73 656c 662e 4d20 3d20 7d22  g(f"{self.M = }"
-00019700: 2920 2023 2063 6f6d 7075 7465 6420 7570  )  # computed up
-00019710: 6f6e 2063 616c 6c0d 0a0d 0a20 2020 2040  on call....    @
-00019720: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
-00019730: 6620 5444 4d28 7365 6c66 2920 2d3e 2062  f TDM(self) -> b
-00019740: 6f6f 6c3a 0d0a 2020 2020 2020 2020 2222  ool:..        ""
-00019750: 2254 656d 706f 7261 6c20 6469 7669 7369  "Temporal divisi
-00019760: 6f6e 206d 756c 7469 706c 6578 696e 672e  on multiplexing.
-00019770: 2222 220d 0a20 2020 2020 2020 2072 6574  """..        ret
-00019780: 7572 6e20 7365 6c66 2e54 203e 2031 0d0a  urn self.T > 1..
-00019790: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
-000197a0: 0a20 2020 2064 6566 2053 444d 2873 656c  .    def SDM(sel
-000197b0: 6629 202d 3e20 626f 6f6c 3a0d 0a20 2020  f) -> bool:..   
-000197c0: 2020 2020 2022 2222 5370 6174 6961 6c20       """Spatial 
-000197d0: 6469 7669 7369 6f6e 206d 756c 7469 706c  division multipl
-000197e0: 6578 696e 672e 0d0a 0d0a 2020 2020 2020  exing.....      
-000197f0: 2020 5468 6520 6469 7265 6374 696f 6e73    The directions
-00019800: 2044 2061 7265 206d 756c 7469 706c 6578   D are multiplex
-00019810: 6564 2c20 7265 7375 6c74 696e 6720 696e  ed, resulting in
-00019820: 2061 2063 726f 7373 6564 2066 7269 6e67   a crossed fring
-00019830: 6520 7061 7474 6572 6e2e 0d0a 2020 2020  e pattern...    
-00019840: 2020 2020 5468 6520 616d 706c 6974 7564      The amplitud
-00019850: 6520 4220 6973 2068 616c 7665 642e 0d0a  e B is halved...
-00019860: 2020 2020 2020 2020 4974 2063 616e 206f          It can o
-00019870: 6e6c 7920 6265 2061 6374 6976 6174 6564  nly be activated
-00019880: 2069 6620 7765 2068 6176 6520 7477 6f20   if we have two 
-00019890: 6469 7265 6374 696f 6e73 2c20 692e 652e  directions, i.e.
-000198a0: 2044 20e2 89a1 2032 2e0d 0a20 2020 2020   D ... 2...     
-000198b0: 2020 2054 6865 206e 756d 6265 7220 6f66     The number of
-000198c0: 2066 7261 6d65 7320 5420 6973 2072 6564   frames T is red
-000198d0: 7563 6564 2062 7920 7468 6520 6661 6374  uced by the fact
-000198e0: 6f72 2032 2e22 2222 0d0a 2020 2020 2020  or 2."""..      
-000198f0: 2020 7265 7475 726e 2073 656c 662e 5f53    return self._S
-00019900: 444d 0d0a 0d0a 2020 2020 4053 444d 2e73  DM....    @SDM.s
-00019910: 6574 7465 720d 0a20 2020 2064 6566 2053  etter..    def S
-00019920: 444d 2873 656c 662c 2053 444d 3a20 626f  DM(self, SDM: bo
-00019930: 6f6c 293a 0d0a 2020 2020 2020 2020 5f53  ol):..        _S
-00019940: 444d 203d 2062 6f6f 6c28 5344 4d29 0d0a  DM = bool(SDM)..
-00019950: 0d0a 2020 2020 2020 2020 6966 205f 5344  ..        if _SD
-00019960: 4d3a 0d0a 2020 2020 2020 2020 2020 2020  M:..            
-00019970: 6966 2073 656c 662e 4420 213d 2032 3a0d  if self.D != 2:.
-00019980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019990: 205f 5344 4d20 3d20 4661 6c73 650d 0a20   _SDM = False.. 
-000199a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000199b0: 656c 662e 6c6f 6767 6572 2e65 7272 6f72  elf.logger.error
-000199c0: 2822 4469 646e 2774 2073 6574 2027 5344  ("Didn't set 'SD
-000199d0: 4d27 3a20 506f 696e 746c 6573 7320 6173  M': Pointless as
-000199e0: 206f 6e6c 7920 6f6e 6520 6469 6d65 6e73   only one dimens
-000199f0: 696f 6e20 6578 6973 742e 2229 0d0a 0d0a  ion exist.")....
-00019a00: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00019a10: 656c 662e 6772 6964 206e 6f74 2069 6e20  elf.grid not in 
-00019a20: 7365 6c66 2e5f 6772 6964 735b 3a32 5d3a  self._grids[:2]:
-00019a30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00019a40: 2020 5f53 444d 203d 2046 616c 7365 0d0a    _SDM = False..
-00019a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a60: 7365 6c66 2e6c 6f67 6765 722e 6572 726f  self.logger.erro
-00019a70: 7228 6622 436f 756c 646e 2774 2073 6574  r(f"Couldn't set
-00019a80: 2027 5344 4d27 3a20 6772 6964 206e 6f74   'SDM': grid not
-00019a90: 2069 6e20 7b73 656c 662e 5f67 7269 6473   in {self._grids
-00019aa0: 5b3a 325d 7d27 2e22 290d 0a0d 0a20 2020  [:2]}'.")....   
-00019ab0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00019ac0: 2e46 444d 3a0d 0a20 2020 2020 2020 2020  .FDM:..         
-00019ad0: 2020 2020 2020 205f 5344 4d20 3d20 4661         _SDM = Fa
-00019ae0: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
-00019af0: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00019b00: 2e65 7272 6f72 2822 436f 756c 646e 2774  .error("Couldn't
-00019b10: 2073 6574 2027 5344 4d27 3a20 4644 4d20   set 'SDM': FDM 
-00019b20: 6973 2061 6374 6976 652e 2229 0d0a 0d0a  is active.")....
-00019b30: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00019b40: 5f53 444d 2021 3d20 5f53 444d 3a0d 0a20  _SDM != _SDM:.. 
-00019b50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019b60: 5f53 444d 203d 205f 5344 4d0d 0a20 2020  _SDM = _SDM..   
-00019b70: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00019b80: 6767 6572 2e64 6562 7567 2866 227b 7365  gger.debug(f"{se
-00019b90: 6c66 2e5f 5344 4d20 3d20 7d22 290d 0a20  lf._SDM = }").. 
-00019ba0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019bb0: 6c6f 6767 6572 2e64 6562 7567 2866 227b  logger.debug(f"{
-00019bc0: 7365 6c66 2e54 203d 207d 2229 2020 2320  self.T = }")  # 
-00019bd0: 636f 6d70 7574 6564 2075 706f 6e20 6361  computed upon ca
-00019be0: 6c6c 0d0a 0d0a 2020 2020 2020 2020 2020  ll....          
-00019bf0: 2020 6966 2073 656c 662e 5344 4d3a 0d0a    if self.SDM:..
-00019c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c10: 7365 6c66 2e42 202f 3d20 7365 6c66 2e44  self.B /= self.D
-00019c20: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-00019c30: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00019c40: 2020 2020 2073 656c 662e 4220 2a3d 2073       self.B *= s
-00019c50: 656c 662e 440d 0a0d 0a20 2020 2040 7072  elf.D....    @pr
-00019c60: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-00019c70: 5744 4d28 7365 6c66 2920 2d3e 2062 6f6f  WDM(self) -> boo
-00019c80: 6c3a 0d0a 2020 2020 2020 2020 2222 2257  l:..        """W
-00019c90: 6176 656c 656e 6774 6820 6469 7669 7369  avelength divisi
-00019ca0: 6f6e 206d 756c 7469 706c 6578 696e 672e  on multiplexing.
-00019cb0: 0d0a 0d0a 2020 2020 2020 2020 5468 6520  ....        The 
-00019cc0: 7368 6966 7473 2061 7265 206d 756c 7469  shifts are multi
-00019cd0: 706c 6578 6564 2069 6e74 6f20 7468 6520  plexed into the 
-00019ce0: 636f 6c6f 7220 6368 616e 6e65 6c2c 2072  color channel, r
-00019cf0: 6573 756c 7469 6e67 2069 6e20 616e 2052  esulting in an R
-00019d00: 4742 2066 7269 6e67 6520 7061 7474 6572  GB fringe patter
-00019d10: 6e2e 0d0a 2020 2020 2020 2020 4974 2063  n...        It c
-00019d20: 616e 206f 6e6c 7920 6265 2061 6374 6976  an only be activ
-00019d30: 6174 6564 2069 6620 616c 6c20 7368 6966  ated if all shif
-00019d40: 7473 2065 7175 616c 2033 2c20 692e 652e  ts equal 3, i.e.
-00019d50: 204e 20e2 89a1 2033 2e0d 0a20 2020 2020   N ... 3...     
-00019d60: 2020 2054 6865 206e 756d 6265 7220 6f66     The number of
-00019d70: 2066 7261 6d65 7320 5420 6973 2072 6564   frames T is red
-00019d80: 7563 6564 2062 7920 7468 6520 6661 6374  uced by the fact
-00019d90: 6f72 2033 2e22 2222 0d0a 2020 2020 2020  or 3."""..      
-00019da0: 2020 7265 7475 726e 2073 656c 662e 5f57    return self._W
-00019db0: 444d 0d0a 0d0a 2020 2020 4057 444d 2e73  DM....    @WDM.s
-00019dc0: 6574 7465 720d 0a20 2020 2064 6566 2057  etter..    def W
-00019dd0: 444d 2873 656c 662c 2057 444d 3a20 626f  DM(self, WDM: bo
-00019de0: 6f6c 293a 0d0a 2020 2020 2020 2020 5f57  ol):..        _W
-00019df0: 444d 203d 2062 6f6f 6c28 5744 4d29 0d0a  DM = bool(WDM)..
-00019e00: 0d0a 2020 2020 2020 2020 6966 205f 5744  ..        if _WD
-00019e10: 4d3a 0d0a 2020 2020 2020 2020 2020 2020  M:..            
-00019e20: 6966 206e 6f74 206e 702e 616c 6c28 7365  if not np.all(se
-00019e30: 6c66 2e4e 203d 3d20 3329 3a0d 0a20 2020  lf.N == 3):..   
-00019e40: 2020 2020 2020 2020 2020 2020 205f 5744               _WD
-00019e50: 4d20 3d20 4661 6c73 650d 0a20 2020 2020  M = False..     
-00019e60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019e70: 6c6f 6767 6572 2e65 7272 6f72 2822 436f  logger.error("Co
-00019e80: 756c 646e 2774 2073 6574 2027 5744 4d27  uldn't set 'WDM'
-00019e90: 3a20 4174 206c 6561 7374 206f 6e65 2053  : At least one S
-00019ea0: 6869 6674 2021 3d20 332e 2229 0d0a 0d0a  hift != 3.")....
-00019eb0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00019ec0: 6f74 2073 656c 662e 5f6d 6f6e 6f63 6872  ot self._monochr
-00019ed0: 6f6d 653a 0d0a 2020 2020 2020 2020 2020  ome:..          
-00019ee0: 2020 2020 2020 5f57 444d 203d 2046 616c        _WDM = Fal
-00019ef0: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
-00019f00: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-00019f10: 6572 726f 7228 2243 6f75 6c64 6e27 7420  error("Couldn't 
-00019f20: 7365 7420 2757 444d 273a 204e 6f74 2061  set 'WDM': Not a
-00019f30: 6c6c 2068 7565 7320 6172 6520 6d6f 6e6f  ll hues are mono
-00019f40: 6368 726f 6d61 7469 632e 2229 0d0a 0d0a  chromatic.")....
-00019f50: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00019f60: 656c 662e 4644 4d3a 2020 2320 746f 646f  elf.FDM:  # todo
-00019f70: 3a20 7265 6d6f 7665 2074 6869 732c 2061  : remove this, a
-00019f80: 6c72 6561 6479 2063 6f76 6572 6564 2062  lready covered b
-00019f90: 7920 4e0d 0a20 2020 2020 2020 2020 2020  y N..           
-00019fa0: 2020 2020 205f 5744 4d20 3d20 4661 6c73       _WDM = Fals
-00019fb0: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
-00019fc0: 2020 2073 656c 662e 6c6f 6767 6572 2e65     self.logger.e
-00019fd0: 7272 6f72 2822 436f 756c 646e 2774 2073  rror("Couldn't s
-00019fe0: 6574 2027 5744 4d27 3a20 4644 4d20 6973  et 'WDM': FDM is
-00019ff0: 2061 6374 6976 652e 2229 0d0a 0d0a 2020   active.")....  
-0001a000: 2020 2020 2020 6966 2073 656c 662e 5f57        if self._W
-0001a010: 444d 2021 3d20 5f57 444d 3a0d 0a20 2020  DM != _WDM:..   
-0001a020: 2020 2020 2020 2020 2073 656c 662e 5f57           self._W
-0001a030: 444d 203d 205f 5744 4d0d 0a20 2020 2020  DM = _WDM..     
-0001a040: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-0001a050: 6572 2e64 6562 7567 2866 227b 7365 6c66  er.debug(f"{self
-0001a060: 2e5f 5744 4d20 3d20 7d22 290d 0a20 2020  ._WDM = }")..   
-0001a070: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0001a080: 6767 6572 2e64 6562 7567 2866 227b 7365  gger.debug(f"{se
-0001a090: 6c66 2e54 203d 207d 2229 2020 2320 636f  lf.T = }")  # co
-0001a0a0: 6d70 7574 6564 2075 706f 6e20 6361 6c6c  mputed upon call
-0001a0b0: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-0001a0c0: 790d 0a20 2020 2064 6566 2046 444d 2873  y..    def FDM(s
-0001a0d0: 656c 6629 202d 3e20 626f 6f6c 3a0d 0a20  elf) -> bool:.. 
-0001a0e0: 2020 2020 2020 2022 2222 4672 6571 7565         """Freque
-0001a0f0: 6e63 7920 6469 7669 7369 6f6e 206d 756c  ncy division mul
-0001a100: 7469 706c 6578 696e 672e 0d0a 0d0a 2020  tiplexing.....  
-0001a110: 2020 2020 2020 5468 6520 6469 7265 6374        The direct
-0001a120: 696f 6e73 2044 2061 6e64 2074 6865 2073  ions D and the s
-0001a130: 6574 7320 4b20 6172 6520 6d75 6c74 6970  ets K are multip
-0001a140: 6c65 7865 642c 2072 6573 756c 7469 6e67  lexed, resulting
-0001a150: 2069 6e20 6120 6372 6f73 7365 6420 6672   in a crossed fr
-0001a160: 696e 6765 2070 6174 7465 726e 2069 6620  inge pattern if 
-0001a170: 4420 e289 a120 322e 0d0a 2020 2020 2020  D ... 2...      
-0001a180: 2020 4974 2063 616e 206f 6e6c 7920 6265    It can only be
-0001a190: 2061 6374 6976 6174 6564 2069 6620 4420   activated if D 
-0001a1a0: e288 a820 4b20 3e20 3120 692e 652e 2044  ... K > 1 i.e. D
-0001a1b0: 202a 204b 203e 2031 2e0d 0a20 2020 2020   * K > 1...     
-0001a1c0: 2020 2054 6865 2061 6d70 6c69 7475 6465     The amplitude
-0001a1d0: 2042 2069 7320 7265 6475 6365 6420 6279   B is reduced by
-0001a1e0: 2074 6865 2066 6163 746f 7220 4420 2a20   the factor D * 
-0001a1f0: 4b2e 0d0a 2020 2020 2020 2020 5573 7561  K...        Usua
-0001a200: 6c6c 7920 6620 6571 7561 6c73 2031 2061  lly f equals 1 a
-0001a210: 6e64 2069 7320 6573 7365 6e74 6961 6c6c  nd is essentiall
-0001a220: 7920 6f6e 6c79 2063 6861 6e67 6564 2069  y only changed i
-0001a230: 6620 6672 6571 7565 6e63 7920 6469 7669  f frequency divi
-0001a240: 7369 6f6e 206d 756c 7469 706c 6578 696e  sion multiplexin
-0001a250: 6720 2846 444d 2920 6973 2061 6374 6976  g (FDM) is activ
-0001a260: 6174 6564 3a0d 0a20 2020 2020 2020 2045  ated:..        E
-0001a270: 6163 6820 7365 7420 7065 7220 6469 7265  ach set per dire
-0001a280: 6374 696f 6e20 7265 6365 6976 6573 2061  ction receives a
-0001a290: 6e20 696e 6469 7669 6475 616c 2074 656d  n individual tem
-0001a2a0: 706f 7261 6c20 6672 6571 7565 6e63 7920  poral frequency 
-0001a2b0: 662c 2077 6869 6368 2069 7320 7573 6564  f, which is used
-0001a2c0: 2069 6e20 7465 6d70 6f72 616c 2064 656d   in temporal dem
-0001a2d0: 6f64 756c 6174 696f 6e20 746f 2064 6973  odulation to dis
-0001a2e0: 7469 6e67 7569 7368 2074 6865 2069 6e64  tinguish the ind
-0001a2f0: 6976 6964 7561 6c20 7365 7473 2e0d 0a20  ividual sets... 
-0001a300: 2020 2020 2020 2041 206d 696e 696d 616c         A minimal
-0001a310: 206e 756d 6265 7220 6f66 2073 6869 6674   number of shift
-0001a320: 7320 5f4e 6d69 6e20 e289 a520 e28c 8820  s _Nmin ... ... 
-0001a330: 3220 2a20 5f66 6d61 7820 2b20 3120 e28c  2 * _fmax + 1 ..
-0001a340: 8920 6973 2072 6571 7569 7265 6420 746f  . is required to
-0001a350: 2073 6174 6973 6679 2074 6865 2073 616d   satisfy the sam
-0001a360: 706c 696e 6720 7468 656f 7265 6d20 616e  pling theorem an
-0001a370: 6420 4e20 6973 2075 7064 6174 6564 2061  d N is updated a
-0001a380: 7574 6f6d 6174 6963 616c 6c79 2069 6620  utomatically if 
-0001a390: 6e65 6365 7373 6172 792e 0d0a 2020 2020  necessary...    
-0001a3a0: 2020 2020 4966 206f 6e65 2077 616e 7473      If one wants
-0001a3b0: 2061 2073 7461 7469 6320 7061 7474 6572   a static patter
-0001a3c0: 6e2c 2069 2e65 2e20 6f6e 6520 7468 6174  n, i.e. one that
-0001a3d0: 2072 656d 6169 6e73 2063 6f6e 6772 7565   remains congrue
-0001a3e0: 6e74 2077 6865 6e20 7368 6966 7465 642c  nt when shifted,
-0001a3f0: 2073 6574 2073 7461 7469 6320 746f 2054   set static to T
-0001a400: 7275 652e 0d0a 2020 2020 2020 2020 2222  rue...        ""
-0001a410: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-0001a420: 6e20 7365 6c66 2e5f 4644 4d0d 0a0d 0a20  n self._FDM.... 
-0001a430: 2020 2040 4644 4d2e 7365 7474 6572 0d0a     @FDM.setter..
-0001a440: 2020 2020 6465 6620 4644 4d28 7365 6c66      def FDM(self
-0001a450: 2c20 4644 4d3a 2062 6f6f 6c29 3a0d 0a20  , FDM: bool):.. 
-0001a460: 2020 2020 2020 205f 4644 4d20 3d20 626f         _FDM = bo
-0001a470: 6f6c 2846 444d 290d 0a0d 0a20 2020 2020  ol(FDM)....     
-0001a480: 2020 2069 6620 5f46 444d 3a0d 0a20 2020     if _FDM:..   
-0001a490: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0001a4a0: 2e44 203d 3d20 7365 6c66 2e4b 203d 3d20  .D == self.K == 
-0001a4b0: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
-0001a4c0: 2020 2020 5f46 444d 203d 2046 616c 7365      _FDM = False
-0001a4d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001a4e0: 2020 7365 6c66 2e6c 6f67 6765 722e 6572    self.logger.er
-0001a4f0: 726f 7228 2244 6964 6e27 7420 7365 7420  ror("Didn't set 
-0001a500: 2746 444d 273a 2044 696d 656e 7369 6f6e  'FDM': Dimension
-0001a510: 7320 2a20 5365 7473 203d 2031 2c20 736f  s * Sets = 1, so
-0001a520: 206e 6f74 6869 6e67 2074 6f20 6d75 6c74   nothing to mult
-0001a530: 6970 6c65 782e 2229 0d0a 0d0a 2020 2020  iplex.")....    
-0001a540: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001a550: 5344 4d3a 0d0a 2020 2020 2020 2020 2020  SDM:..          
-0001a560: 2020 2020 2020 5f46 444d 203d 2046 616c        _FDM = Fal
-0001a570: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
-0001a580: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-0001a590: 6572 726f 7228 2243 6f75 6c64 6e27 7420  error("Couldn't 
-0001a5a0: 7365 7420 2746 444d 273a 2053 444d 2069  set 'FDM': SDM i
-0001a5b0: 7320 6163 7469 7665 2e22 290d 0a0d 0a20  s active.").... 
-0001a5c0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0001a5d0: 6c66 2e57 444d 3a20 2023 2074 6f64 6f3a  lf.WDM:  # todo:
-0001a5e0: 2072 656d 6f76 652c 2061 6c72 6561 6479   remove, already
-0001a5f0: 2063 6f76 6572 6564 2062 7920 4e0d 0a20   covered by N.. 
-0001a600: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0001a610: 4644 4d20 3d20 4661 6c73 650d 0a20 2020  FDM = False..   
-0001a620: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001a630: 662e 6c6f 6767 6572 2e65 7272 6f72 2822  f.logger.error("
-0001a640: 436f 756c 646e 2774 2073 6574 2027 4644  Couldn't set 'FD
-0001a650: 4d27 3a20 5744 4d20 6973 2061 6374 6976  M': WDM is activ
-0001a660: 652e 2229 0d0a 0d0a 2020 2020 2020 2020  e.")....        
-0001a670: 6966 2073 656c 662e 5f46 444d 2021 3d20  if self._FDM != 
-0001a680: 5f46 444d 3a0d 0a20 2020 2020 2020 2020  _FDM:..         
-0001a690: 2020 2073 656c 662e 5f46 444d 203d 205f     self._FDM = _
-0001a6a0: 4644 4d0d 0a20 2020 2020 2020 2020 2020  FDM..           
-0001a6b0: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
-0001a6c0: 7567 2866 227b 7365 6c66 2e5f 4644 4d20  ug(f"{self._FDM 
-0001a6d0: 3d20 7d22 290d 0a20 2020 2020 2020 2020  = }")..         
-0001a6e0: 2020 2023 2073 656c 662e 4b20 3d20 7365     # self.K = se
-0001a6f0: 6c66 2e5f 4b0d 0a20 2020 2020 2020 2020  lf._K..         
-0001a700: 2020 2073 656c 662e 4e20 3d20 7365 6c66     self.N = self
-0001a710: 2e5f 4e0d 0a20 2020 2020 2020 2020 2020  ._N..           
-0001a720: 2073 656c 662e 7620 3d20 7365 6c66 2e5f   self.v = self._
-0001a730: 760d 0a20 2020 2020 2020 2020 2020 2069  v..            i
-0001a740: 6620 7365 6c66 2e46 444d 3a0d 0a20 2020  f self.FDM:..   
-0001a750: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001a760: 662e 6620 3d20 7365 6c66 2e5f 660d 0a20  f.f = self._f.. 
-0001a770: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001a780: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001a790: 2020 7365 6c66 2e66 203d 206e 702e 6f6e    self.f = np.on
-0001a7a0: 6573 2828 7365 6c66 2e44 2c20 7365 6c66  es((self.D, self
-0001a7b0: 2e4b 2929 0d0a 0d0a 2020 2020 2020 2020  .K))....        
-0001a7c0: 2020 2020 2320 6b65 6570 206d 6178 696d      # keep maxim
-0001a7d0: 756d 2070 6f73 7369 626c 6520 7669 7369  um possible visi
-0001a7e0: 6269 6c69 7479 2063 6f6e 7374 616e 740d  bility constant.
-0001a7f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001a800: 7365 6c66 2e46 444d 3a0d 0a20 2020 2020  self.FDM:..     
-0001a810: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001a820: 4220 2f3d 2073 656c 662e 4420 2a20 7365  B /= self.D * se
-0001a830: 6c66 2e4b 0d0a 2020 2020 2020 2020 2020  lf.K..          
-0001a840: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-0001a850: 2020 2020 2020 2020 2073 656c 662e 4220           self.B 
-0001a860: 2a3d 2073 656c 662e 4420 2a20 7365 6c66  *= self.D * self
-0001a870: 2e4b 0d0a 0d0a 2020 2020 4070 726f 7065  .K....    @prope
-0001a880: 7274 790d 0a20 2020 2064 6566 2073 7461  rty..    def sta
-0001a890: 7469 6328 7365 6c66 2920 2d3e 2062 6f6f  tic(self) -> boo
-0001a8a0: 6c3a 0d0a 2020 2020 2020 2020 2222 2246  l:..        """F
-0001a8b0: 6c61 6720 666f 7220 6372 6561 7469 6e67  lag for creating
-0001a8c0: 2073 7461 7469 6320 6672 696e 6765 7320   static fringes 
-0001a8d0: 2873 6f20 7468 6579 2072 656d 6169 6e20  (so they remain 
-0001a8e0: 636f 6e67 7275 656e 7420 7768 656e 2073  congruent when s
-0001a8f0: 6869 6674 6564 292e 2222 220d 0a20 2020  hifted)."""..   
-0001a900: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001a910: 2e5f 7374 6174 6963 0d0a 0d0a 2020 2020  ._static....    
-0001a920: 4073 7461 7469 632e 7365 7474 6572 0d0a  @static.setter..
-0001a930: 2020 2020 6465 6620 7374 6174 6963 2873      def static(s
-0001a940: 656c 662c 2073 7461 7469 633a 2062 6f6f  elf, static: boo
-0001a950: 6c29 3a0d 0a20 2020 2020 2020 205f 7374  l):..        _st
-0001a960: 6174 6963 203d 2062 6f6f 6c28 7374 6174  atic = bool(stat
-0001a970: 6963 290d 0a0d 0a20 2020 2020 2020 2069  ic)....        i
-0001a980: 6620 7365 6c66 2e5f 7374 6174 6963 2021  f self._static !
-0001a990: 3d20 5f73 7461 7469 633a 0d0a 2020 2020  = _static:..    
-0001a9a0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-0001a9b0: 6174 6963 203d 205f 7374 6174 6963 0d0a  atic = _static..
-0001a9c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001a9d0: 2e6c 6f67 6765 722e 6465 6275 6728 6622  .logger.debug(f"
-0001a9e0: 7b73 656c 662e 5f73 7461 7469 6320 3d20  {self._static = 
-0001a9f0: 7d22 290d 0a20 2020 2020 2020 2020 2020  }")..           
-0001aa00: 2073 656c 662e 7620 3d20 7365 6c66 2e5f   self.v = self._
-0001aa10: 760d 0a20 2020 2020 2020 2020 2020 2073  v..            s
-0001aa20: 656c 662e 6620 3d20 7365 6c66 2e5f 660d  elf.f = self._f.
-0001aa30: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
-0001aa40: 0d0a 2020 2020 6465 6620 4b28 7365 6c66  ..    def K(self
-0001aa50: 2920 2d3e 2069 6e74 3a0d 0a20 2020 2020  ) -> int:..     
-0001aa60: 2020 2022 2222 4e75 6d62 6572 206f 6620     """Number of 
-0001aa70: 7365 7473 2028 6e75 6d62 6572 206f 6620  sets (number of 
-0001aa80: 6672 696e 6765 2070 6174 7465 726e 7320  fringe patterns 
-0001aa90: 7769 7468 2064 6966 6665 7265 6e74 2073  with different s
-0001aaa0: 7061 7469 616c 2066 7265 7175 656e 6369  patial frequenci
-0001aab0: 6573 292e 2222 220d 0a20 2020 2020 2020  es)."""..       
-0001aac0: 2072 6574 7572 6e20 7365 6c66 2e5f 4b0d   return self._K.
-0001aad0: 0a0d 0a20 2020 2040 4b2e 7365 7474 6572  ...    @K.setter
-0001aae0: 0d0a 2020 2020 6465 6620 4b28 7365 6c66  ..    def K(self
-0001aaf0: 2c20 4b3a 2069 6e74 293a 0d0a 2020 2020  , K: int):..    
-0001ab00: 2020 2020 2320 746f 646f 3a20 6469 6666      # todo: diff
-0001ab10: 6572 656e 7420 4b20 666f 7220 6561 6368  erent K for each
-0001ab20: 2044 3a20 7573 6520 6172 7261 7920 6f66   D: use array of
-0001ab30: 2061 7272 6179 730d 0a20 2020 2020 2020   arrays..       
-0001ab40: 2023 2061 203d 206e 702e 6f6e 6573 2832   # a = np.ones(2
-0001ab50: 290d 0a20 2020 2020 2020 2023 2062 203d  )..        # b =
-0001ab60: 206e 702e 6f6e 6573 2835 290d 0a20 2020   np.ones(5)..   
-0001ab70: 2020 2020 2023 2063 203d 206e 702e 6172       # c = np.ar
-0001ab80: 7261 7928 5b61 2c20 625d 290d 0a0d 0a20  ray([a, b]).... 
-0001ab90: 2020 2020 2020 204b 6d61 7820 3d20 2873         Kmax = (s
-0001aba0: 656c 662e 5f4e 6d61 7820 2d20 3129 202f  elf._Nmax - 1) /
-0001abb0: 2032 202f 2073 656c 662e 4420 6966 2073   2 / self.D if s
-0001abc0: 656c 662e 4644 4d20 656c 7365 2073 656c  elf.FDM else sel
-0001abd0: 662e 5f4b 6d61 7820 2023 2074 6f64 6f3a  f._Kmax  # todo:
-0001abe0: 2063 6865 636b 2069 6620 6e65 6365 7373   check if necess
-0001abf0: 6172 790d 0a20 2020 2020 2020 205f 4b20  ary..        _K 
-0001ac00: 3d20 696e 7428 6d69 6e28 6d61 7828 312c  = int(min(max(1,
-0001ac10: 204b 292c 204b 6d61 7829 290d 0a0d 0a20   K), Kmax)).... 
-0001ac20: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0001ac30: 4b20 3e20 5f4b 3a20 2023 2072 656d 6f76  K > _K:  # remov
-0001ac40: 6520 656c 656d 656e 7473 0d0a 2020 2020  e elements..    
-0001ac50: 2020 2020 2020 2020 7365 6c66 2e5f 4b20          self._K 
-0001ac60: 3d20 5f4b 0d0a 2020 2020 2020 2020 2020  = _K..          
-0001ac70: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-0001ac80: 6275 6728 6622 7b73 656c 662e 5f4b 203d  bug(f"{self._K =
-0001ac90: 207d 2229 0d0a 0d0a 2020 2020 2020 2020   }")....        
-0001aca0: 2020 2020 7365 6c66 2e4e 203d 2073 656c      self.N = sel
-0001acb0: 662e 5f4e 5b3a 2c20 3a20 7365 6c66 2e4b  f._N[:, : self.K
-0001acc0: 5d0d 0a20 2020 2020 2020 2020 2020 2073  ]..            s
-0001acd0: 656c 662e 7620 3d20 7365 6c66 2e5f 765b  elf.v = self._v[
-0001ace0: 3a2c 203a 2073 656c 662e 4b5d 0d0a 2020  :, : self.K]..  
-0001acf0: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-0001ad00: 203d 2073 656c 662e 5f66 5b3a 2c20 3a20   = self._f[:, : 
-0001ad10: 7365 6c66 2e4b 5d0d 0a0d 0a20 2020 2020  self.K]....     
-0001ad20: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0001ad30: 4420 3d3d 2073 656c 662e 5f4b 203d 3d20  D == self._K == 
-0001ad40: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
-0001ad50: 2020 2020 7365 6c66 2e46 444d 203d 2046      self.FDM = F
-0001ad60: 616c 7365 0d0a 2020 2020 2020 2020 656c  alse..        el
-0001ad70: 6966 2073 656c 662e 5f4b 203c 205f 4b3a  if self._K < _K:
-0001ad80: 2020 2320 6164 6420 656c 656d 656e 7473    # add elements
-0001ad90: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0001ada0: 6c66 2e5f 4b20 3d20 5f4b 0d0a 2020 2020  lf._K = _K..    
-0001adb0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001adc0: 6765 722e 6465 6275 6728 6622 7b73 656c  ger.debug(f"{sel
-0001add0: 662e 5f4b 203d 207d 2229 0d0a 0d0a 2020  f._K = }")....  
-0001ade0: 2020 2020 2020 2020 2020 7365 6c66 2e4e            self.N
-0001adf0: 203d 206e 702e 6170 7065 6e64 280d 0a20   = np.append(.. 
-0001ae00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001ae10: 656c 662e 5f4e 2c20 6e70 2e74 696c 6528  elf._N, np.tile(
-0001ae20: 7365 6c66 2e5f 4e5b 302c 2030 5d2c 2028  self._N[0, 0], (
-0001ae30: 7365 6c66 2e44 2c20 5f4b 202d 2073 656c  self.D, _K - sel
-0001ae40: 662e 5f4e 2e73 6861 7065 5b31 5d29 292c  f._N.shape[1])),
-0001ae50: 2061 7869 733d 310d 0a20 2020 2020 2020   axis=1..       
-0001ae60: 2020 2020 2029 2020 2320 646f 6e27 7420       )  # don't 
-0001ae70: 6170 7065 6e64 204e 2066 726f 6d20 6465  append N from de
-0001ae80: 6661 756c 7473 2c20 7468 6973 206d 6967  faults, this mig
-0001ae90: 6874 2062 6520 696e 2063 6f6e 666c 6963  ht be in conflic
-0001aea0: 7420 7769 7468 2057 444d 210d 0a20 2020  t with WDM!..   
-0001aeb0: 2020 2020 2020 2020 2076 203d 2073 656c           v = sel
-0001aec0: 662e 4c20 2a2a 2028 3120 2f20 6e70 2e61  f.L ** (1 / np.a
-0001aed0: 7261 6e67 6528 7365 6c66 2e5f 762e 7368  range(self._v.sh
-0001aee0: 6170 655b 315d 202b 2031 2c20 5f4b 202b  ape[1] + 1, _K +
-0001aef0: 2031 2929 0d0a 2020 2020 2020 2020 2020   1))..          
-0001af00: 2020 7365 6c66 2e76 203d 206e 702e 6170    self.v = np.ap
-0001af10: 7065 6e64 2873 656c 662e 5f76 2c20 6e70  pend(self._v, np
-0001af20: 2e74 696c 6528 762c 2028 7365 6c66 2e44  .tile(v, (self.D
-0001af30: 2c20 3129 292c 2061 7869 733d 3129 0d0a  , 1)), axis=1)..
-0001af40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001af50: 2e66 203d 206e 702e 6170 7065 6e64 280d  .f = np.append(.
-0001af60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001af70: 2073 656c 662e 5f66 2c0d 0a20 2020 2020   self._f,..     
-0001af80: 2020 2020 2020 2020 2020 206e 702e 7469             np.ti
-0001af90: 6c65 2873 656c 662e 6465 6661 756c 7473  le(self.defaults
-0001afa0: 5b22 6622 5d5b 302c 2030 5d2c 2028 7365  ["f"][0, 0], (se
-0001afb0: 6c66 2e44 2c20 5f4b 202d 2073 656c 662e  lf.D, _K - self.
-0001afc0: 5f66 2e73 6861 7065 5b31 5d29 292c 0d0a  _f.shape[1])),..
-0001afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001afe0: 6178 6973 3d31 2c0d 0a20 2020 2020 2020  axis=1,..       
-0001aff0: 2020 2020 2029 0d0a 0d0a 2020 2020 2020       )....      
-0001b000: 2020 2020 2020 7365 6c66 2e42 203d 2073        self.B = s
-0001b010: 656c 662e 420d 0a0d 0a20 2020 2040 7072  elf.B....    @pr
-0001b020: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-0001b030: 5f4e 6d69 6e28 7365 6c66 2920 2d3e 2069  _Nmin(self) -> i
-0001b040: 6e74 3a0d 0a20 2020 2020 2020 2022 2222  nt:..        """
-0001b050: 4d69 6e69 6d75 6d20 6e75 6d62 6572 206f  Minimum number o
-0001b060: 6620 7368 6966 7473 2074 6f20 2875 6e69  f shifts to (uni
-0001b070: 666f 726d 6c79 2920 7361 6d70 6c65 2074  formly) sample t
-0001b080: 656d 706f 7261 6c20 6672 6571 7565 6e63  emporal frequenc
-0001b090: 6965 732e 0d0a 0d0a 2020 2020 2020 2020  ies.....        
-0001b0a0: 5065 7220 6469 7265 6374 696f 6e20 6174  Per direction at
-0001b0b0: 206c 6561 7374 206f 6e65 2073 6574 2077   least one set w
-0001b0c0: 6974 6820 4e20 e289 a520 3320 6973 206e  ith N ... 3 is n
-0001b0d0: 6563 6573 7361 7279 0d0a 2020 2020 2020  ecessary..      
-0001b0e0: 2020 746f 2073 6f6c 7665 2066 6f72 2074    to solve for t
-0001b0f0: 6865 2074 6872 6565 2075 6e6b 6e6f 776e  he three unknown
-0001b100: 7320 6272 6967 6874 6e65 7373 2041 2c20  s brightness A, 
-0001b110: 6d6f 6475 6c61 7469 6f6e 2042 2061 6e64  modulation B and
-0001b120: 2063 6f6f 7264 696e 6174 6520 7869 2e22   coordinate xi."
-0001b130: 2222 0d0a 2020 2020 2020 2020 6966 2073  ""..        if s
-0001b140: 656c 662e 4644 4d3a 0d0a 2020 2020 2020  elf.FDM:..      
-0001b150: 2020 2020 2020 4e6d 696e 203d 2069 6e74        Nmin = int
-0001b160: 286e 702e 6365 696c 2832 202a 2073 656c  (np.ceil(2 * sel
-0001b170: 662e 662e 6d61 7828 2920 2b20 3129 2920  f.f.max() + 1)) 
-0001b180: 2023 2073 616d 706c 696e 6720 7468 656f   # sampling theo
-0001b190: 7265 6d0d 0a20 2020 2020 2020 2020 2020  rem..           
-0001b1a0: 2023 2074 6f64 6f3a 2032 202a 2044 202a   # todo: 2 * D *
-0001b1b0: 204b 202b 2031 202d 3e20 6672 6163 7469   K + 1 -> fracti
-0001b1c0: 6f6e 616c 2070 6572 696f 6473 2069 6620  onal periods if 
-0001b1d0: 7374 6174 6963 0d0a 2020 2020 2020 2020  static..        
-0001b1e0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-0001b1f0: 2020 204e 6d69 6e20 3d20 3320 2023 2074     Nmin = 3  # t
-0001b200: 6f64 6f3a 2031 202d 3e20 7573 6520 6f6c  odo: 1 -> use ol
-0001b210: 6420 6465 636f 6465 720d 0a20 2020 2020  d decoder..     
-0001b220: 2020 2072 6574 7572 6e20 4e6d 696e 0d0a     return Nmin..
-0001b230: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
-0001b240: 0a20 2020 2064 6566 204e 2873 656c 6629  .    def N(self)
-0001b250: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
-0001b260: 0a20 2020 2020 2020 2022 2222 4e75 6d62  .        """Numb
-0001b270: 6572 206f 6620 7068 6173 6520 7368 6966  er of phase shif
-0001b280: 7473 2e22 2222 0d0a 2020 2020 2020 2020  ts."""..        
-0001b290: 6966 2073 656c 662e 4420 3d3d 2031 206f  if self.D == 1 o
-0001b2a0: 7220 6c65 6e28 6e70 2e75 6e69 7175 6528  r len(np.unique(
-0001b2b0: 7365 6c66 2e5f 4e2c 2061 7869 733d 3029  self._N, axis=0)
-0001b2c0: 2920 3d3d 2031 3a20 2023 2073 6574 7320  ) == 1:  # sets 
-0001b2d0: 696e 2064 6972 6563 7469 6f6e 7320 6172  in directions ar
-0001b2e0: 6520 6964 656e 7469 6361 6c0d 0a20 2020  e identical..   
-0001b2f0: 2020 2020 2020 2020 204e 203d 2073 656c           N = sel
-0001b300: 662e 5f4e 5b30 5d20 2023 2031 440d 0a20  f._N[0]  # 1D.. 
-0001b310: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-0001b320: 2020 2020 2020 2020 2020 4e20 3d20 7365            N = se
-0001b330: 6c66 2e5f 4e20 2023 2032 440d 0a20 2020  lf._N  # 2D..   
-0001b340: 2020 2020 2072 6574 7572 6e20 4e0d 0a0d       return N...
-0001b350: 0a20 2020 2040 4e2e 7365 7474 6572 0d0a  .    @N.setter..
-0001b360: 2020 2020 6465 6620 4e28 7365 6c66 2c20      def N(self, 
-0001b370: 4e3a 2069 6e74 207c 2074 7570 6c65 5b69  N: int | tuple[i
-0001b380: 6e74 5d20 7c20 6c69 7374 5b69 6e74 5d20  nt] | list[int] 
-0001b390: 7c20 6e70 2e6e 6461 7272 6179 293a 0d0a  | np.ndarray):..
-0001b3a0: 2020 2020 2020 2020 5f4e 203d 206e 702e          _N = np.
-0001b3b0: 6172 7261 7928 4e2c 2069 6e74 292e 636c  array(N, int).cl
-0001b3c0: 6970 2873 656c 662e 5f4e 6d69 6e2c 2073  ip(self._Nmin, s
-0001b3d0: 656c 662e 5f4e 6d61 7829 2020 2320 6d61  elf._Nmax)  # ma
-0001b3e0: 6b65 2061 7272 6179 2c20 6361 7374 2074  ke array, cast t
-0001b3f0: 6f20 6474 7970 652c 2063 6c69 700d 0a0d  o dtype, clip...
-0001b400: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001b410: 5f4e 2e73 697a 653a 2020 2320 656d 7074  _N.size:  # empt
-0001b420: 7920 6172 7261 790d 0a20 2020 2020 2020  y array..       
-0001b430: 2020 2020 2072 6574 7572 6e0d 0a0d 0a20       return.... 
-0001b440: 2020 2020 2020 205f 4e20 3d20 7365 6c66         _N = self
-0001b450: 2e5f 7472 696d 285f 4e29 0d0a 0d0a 2020  ._trim(_N)....  
-0001b460: 2020 2020 2020 6966 206e 702e 616c 6c28        if np.all(
-0001b470: 5f4e 203d 3d20 3129 2061 6e64 205f 4e2e  _N == 1) and _N.
-0001b480: 7368 6170 655b 315d 203d 3d20 313a 2020  shape[1] == 1:  
-0001b490: 2320 616e 790d 0a20 2020 2020 2020 2020  # any..         
-0001b4a0: 2020 2070 6173 7320 2023 2046 544d 0d0a     pass  # FTM..
-0001b4b0: 2020 2020 2020 2020 656c 6966 206e 702e          elif np.
-0001b4c0: 616e 7928 5f4e 203c 3d20 3229 3a0d 0a20  any(_N <= 2):.. 
-0001b4d0: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-0001b4e0: 2069 6e20 7261 6e67 6528 7365 6c66 2e44   in range(self.D
-0001b4f0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-0001b500: 2020 2020 6966 206e 6f74 2061 6e79 285f      if not any(_
-0001b510: 4e5b 645d 203e 3d20 3329 3a0d 0a20 2020  N[d] >= 3):..   
-0001b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b530: 2069 203d 206e 702e 6172 676d 6178 285f   i = np.argmax(_
-0001b540: 4e5b 645d 2920 2023 206e 702e 6172 676d  N[d])  # np.argm
-0001b550: 696e 285f 4e5b 645d 290d 0a20 2020 2020  in(_N[d])..     
-0001b560: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0001b570: 4e5b 642c 2069 5d20 3d20 330d 0a0d 0a20  N[d, i] = 3.... 
-0001b580: 2020 2020 2020 2069 6620 7365 6c66 2e57         if self.W
-0001b590: 444d 2061 6e64 206e 6f74 206e 702e 616c  DM and not np.al
-0001b5a0: 6c28 5f4e 203d 3d20 3329 3a0d 0a20 2020  l(_N == 3):..   
-0001b5b0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0001b5c0: 6767 6572 2e65 7272 6f72 2822 436f 756c  gger.error("Coul
-0001b5d0: 646e 2774 2073 6574 2027 4e27 3a20 4174  dn't set 'N': At
-0001b5e0: 206c 6561 7374 206f 6e65 2053 6869 6674   least one Shift
-0001b5f0: 2021 3d20 332e 2229 0d0a 2020 2020 2020   != 3.")..      
-0001b600: 2020 2020 2020 7265 7475 726e 0d0a 0d0a        return....
-0001b610: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001b620: 4644 4d20 616e 6420 6e6f 7420 6e70 2e61  FDM and not np.a
-0001b630: 6c6c 285f 4e20 3d3d 205f 4e5b 302c 2030  ll(_N == _N[0, 0
-0001b640: 5d29 3a0d 0a20 2020 2020 2020 2020 2020  ]):..           
-0001b650: 2023 205f 4e20 3d20 6e70 2e74 696c 6528   # _N = np.tile(
-0001b660: 7365 6c66 2e5f 4e6d 696e 2c20 5f4e 2e73  self._Nmin, _N.s
-0001b670: 6861 7065 290d 0a20 2020 2020 2020 2020  hape)..         
-0001b680: 2020 205f 4e20 3d20 6e70 2e74 696c 6528     _N = np.tile(
-0001b690: 5f4e 5b30 2c20 305d 2c20 5f4e 2e73 6861  _N[0, 0], _N.sha
-0001b6a0: 7065 290d 0a0d 0a20 2020 2020 2020 2069  pe)....        i
-0001b6b0: 6620 6e6f 7420 6e70 2e61 7272 6179 5f65  f not np.array_e
-0001b6c0: 7175 616c 2873 656c 662e 5f4e 2c20 5f4e  qual(self._N, _N
-0001b6d0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-0001b6e0: 7365 6c66 2e5f 4e20 3d20 5f4e 0d0a 2020  self._N = _N..  
-0001b6f0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0001b700: 6f67 6765 722e 6465 6275 6728 6622 7365  ogger.debug(f"se
-0001b710: 6c66 2e5f 4e20 3d20 7b73 7472 2873 656c  lf._N = {str(sel
-0001b720: 662e 5f4e 292e 7265 706c 6163 6528 6368  f._N).replace(ch
-0001b730: 7228 3130 292c 2027 2c27 297d 2229 0d0a  r(10), ',')}")..
-0001b740: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001b750: 2e5f 554d 5220 3d20 4e6f 6e65 0d0a 2020  ._UMR = None..  
-0001b760: 2020 2020 2020 2020 2020 7365 6c66 2e44            self.D
-0001b770: 2c20 7365 6c66 2e4b 203d 2073 656c 662e  , self.K = self.
-0001b780: 5f4e 2e73 6861 7065 0d0a 2020 2020 2020  _N.shape..      
-0001b790: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-0001b7a0: 722e 6465 6275 6728 6622 7b73 656c 662e  r.debug(f"{self.
-0001b7b0: 5420 3d20 7d22 290d 0a0d 0a20 2020 2040  T = }")....    @
-0001b7c0: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
-0001b7d0: 6620 6c6d 696e 2873 656c 6629 202d 3e20  f lmin(self) -> 
-0001b7e0: 666c 6f61 743a 0d0a 2020 2020 2020 2020  float:..        
-0001b7f0: 2222 224d 696e 696d 756d 2072 6573 6f6c  """Minimum resol
-0001b800: 7661 626c 6520 7761 7665 6c65 6e67 7468  vable wavelength
-0001b810: 2e0d 0a20 2020 2020 2020 205b 6c6d 696e  ...        [lmin
-0001b820: 5d20 3d20 7078 2e22 2222 0d0a 2020 2020  ] = px."""..    
-0001b830: 2020 2020 666d 6178 203d 2028 0d0a 2020      fmax = (..  
-0001b840: 2020 2020 2020 2020 2020 6d69 6e28 2873            min((s
-0001b850: 656c 662e 5f4e 6d69 6e20 2d20 3129 202f  elf._Nmin - 1) /
-0001b860: 2032 2c20 7365 6c66 2e4c 202f 2073 656c   2, self.L / sel
-0001b870: 662e 5f6c 6d69 6e29 2069 6620 7365 6c66  f._lmin) if self
-0001b880: 2e46 444d 2061 6e64 2073 656c 662e 7374  .FDM and self.st
-0001b890: 6174 6963 2065 6c73 6520 2873 656c 662e  atic else (self.
-0001b8a0: 5f4e 6d69 6e20 2d20 3129 202f 2032 0d0a  _Nmin - 1) / 2..
-0001b8b0: 2020 2020 2020 2020 2920 2023 2064 6f6e          )  # don
-0001b8c0: 2774 2075 7365 2073 656c 662e 5f66 6d61  't use self._fma
-0001b8d0: 782c 2065 6c73 6520 6369 7263 756c 6172  x, else circular
-0001b8e0: 206c 6f6f 700d 0a20 2020 2020 2020 2072   loop..        r
-0001b8f0: 6574 7572 6e20 6d69 6e28 7365 6c66 2e5f  eturn min(self._
-0001b900: 6c6d 696e 2c20 7365 6c66 2e4c 202f 2066  lmin, self.L / f
-0001b910: 6d61 7829 2069 6620 7365 6c66 2e46 444d  max) if self.FDM
-0001b920: 2061 6e64 2073 656c 662e 7374 6174 6963   and self.static
-0001b930: 2065 6c73 6520 7365 6c66 2e5f 6c6d 696e   else self._lmin
-0001b940: 0d0a 0d0a 2020 2020 406c 6d69 6e2e 7365  ....    @lmin.se
-0001b950: 7474 6572 0d0a 2020 2020 6465 6620 6c6d  tter..    def lm
-0001b960: 696e 2873 656c 662c 206c 6d69 6e3a 2066  in(self, lmin: f
-0001b970: 6c6f 6174 293a 0d0a 2020 2020 2020 2020  loat):..        
-0001b980: 5f6c 6d69 6e20 3d20 666c 6f61 7428 6d61  _lmin = float(ma
-0001b990: 7828 7365 6c66 2e5f 6c6d 696e 6d69 6e2c  x(self._lminmin,
-0001b9a0: 206c 6d69 6e29 290d 0a0d 0a20 2020 2020   lmin))....     
-0001b9b0: 2020 2069 6620 7365 6c66 2e5f 6c6d 696e     if self._lmin
-0001b9c0: 2021 3d20 5f6c 6d69 6e3a 0d0a 2020 2020   != _lmin:..    
-0001b9d0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6d          self._lm
-0001b9e0: 696e 203d 205f 6c6d 696e 0d0a 2020 2020  in = _lmin..    
-0001b9f0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001ba00: 6765 722e 6465 6275 6728 6622 7b73 656c  ger.debug(f"{sel
-0001ba10: 662e 5f6c 6d69 6e20 3d20 7d22 290d 0a20  f._lmin = }").. 
-0001ba20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001ba30: 6c6f 6767 6572 2e64 6562 7567 2866 227b  logger.debug(f"{
-0001ba40: 7365 6c66 2e76 6d61 7820 3d20 7d22 2920  self.vmax = }") 
-0001ba50: 2023 2063 6f6d 7075 7465 6420 7570 6f6e   # computed upon
-0001ba60: 2063 616c 6c0d 0a20 2020 2020 2020 2020   call..         
-0001ba70: 2020 2073 656c 662e 6c20 3d20 7365 6c66     self.l = self
-0001ba80: 2e6c 2020 2320 6c20 7472 6967 6765 7273  .l  # l triggers
-0001ba90: 2076 0d0a 0d0a 2020 2020 4070 726f 7065   v....    @prope
-0001baa0: 7274 790d 0a20 2020 2064 6566 206c 6f70  rty..    def lop
-0001bab0: 7428 7365 6c66 2920 2d3e 2066 6c6f 6174  t(self) -> float
-0001bac0: 3a0d 0a20 2020 2020 2020 2022 2222 4f70  :..        """Op
-0001bad0: 7469 6d61 6c20 7761 7665 6c65 6e67 7468  timal wavelength
-0001bae0: 2066 6f72 206d 696e 696d 616c 2064 6563   for minimal dec
-0001baf0: 6f64 696e 6720 756e 6365 7274 6169 6e74  oding uncertaint
-0001bb00: 792e 0d0a 2020 2020 2020 2020 5b6c 6f70  y...        [lop
-0001bb10: 745d 203d 2070 782e 2222 220d 0a20 2020  t] = px."""..   
-0001bb20: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001bb30: 2e4c 202f 2073 656c 662e 766f 7074 0d0a  .L / self.vopt..
-0001bb40: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
-0001bb50: 0a20 2020 2064 6566 206c 2873 656c 6629  .    def l(self)
-0001bb60: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
-0001bb70: 0a20 2020 2020 2020 2022 2222 5761 7665  .        """Wave
-0001bb80: 6c65 6e67 7468 7320 6f66 2066 7269 6e67  lengths of fring
-0001bb90: 6520 7065 7269 6f64 732e 0d0a 2020 2020  e periods...    
-0001bba0: 2020 2020 5b6c 5d20 3d20 7078 2e0d 0a0d      [l] = px....
-0001bbb0: 0a20 2020 2020 2020 2057 6865 6e20 4c20  .        When L 
-0001bbc0: 6368 616e 6765 732c 2076 2069 7320 6b65  changes, v is ke
-0001bbd0: 7074 2063 6f6e 7374 616e 7420 616e 6420  pt constant and 
-0001bbe0: 6f6e 6c79 206c 2069 7320 6368 616e 6765  only l is change
-0001bbf0: 642e 2222 220d 0a20 2020 2020 2020 2072  d."""..        r
-0001bc00: 6574 7572 6e20 7365 6c66 2e4c 202f 2073  eturn self.L / s
-0001bc10: 656c 662e 760d 0a0d 0a20 2020 2040 6c2e  elf.v....    @l.
-0001bc20: 7365 7474 6572 0d0a 2020 2020 6465 6620  setter..    def 
-0001bc30: 6c28 7365 6c66 2c20 6c3a 2069 6e74 207c  l(self, l: int |
-0001bc40: 2066 6c6f 6174 207c 2074 7570 6c65 5b69   float | tuple[i
-0001bc50: 6e74 207c 2066 6c6f 6174 5d20 7c20 6c69  nt | float] | li
-0001bc60: 7374 5b69 6e74 207c 2066 6c6f 6174 5d20  st[int | float] 
-0001bc70: 7c20 6e70 2e6e 6461 7272 6179 207c 2073  | np.ndarray | s
-0001bc80: 7472 293a 0d0a 2020 2020 2020 2020 6966  tr):..        if
-0001bc90: 2069 7369 6e73 7461 6e63 6528 6c2c 2073   isinstance(l, s
-0001bca0: 7472 293a 0d0a 2020 2020 2020 2020 2020  tr):..          
-0001bcb0: 2020 6966 2022 2c22 2069 6e20 6c3a 0d0a    if "," in l:..
-0001bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bcd0: 6c20 3d20 6e70 2e66 726f 6d73 7472 696e  l = np.fromstrin
-0001bce0: 6728 6c2c 2073 6570 3d22 2c22 2920 2023  g(l, sep=",")  #
-0001bcf0: 2074 6f64 6f3a 204e 2c20 762c 2066 0d0a   todo: N, v, f..
-0001bd00: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0001bd10: 206c 203d 3d20 226f 7074 696d 616c 223a   l == "optimal":
-0001bd20: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001bd30: 2020 6c6d 696e 203d 2069 6e74 286e 702e    lmin = int(np.
-0001bd40: 6365 696c 2873 656c 662e 6c6d 696e 2929  ceil(self.lmin))
-0001bd50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001bd60: 2020 6c6d 6178 203d 2069 6e74 280d 0a20    lmax = int(.. 
-0001bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd80: 2020 206e 702e 6365 696c 280d 0a20 2020     np.ceil(..   
-0001bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bda0: 2020 2020 206d 6178 280d 0a20 2020 2020       max(..     
-0001bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bdc0: 2020 2020 2020 2073 656c 662e 4c20 2f20         self.L / 
-0001bdd0: 6c6d 696e 2c20 2023 2074 6f64 6f3a 206f  lmin,  # todo: o
-0001bde0: 6e6c 7920 6966 2042 2064 6966 6665 7220  nly if B differ 
-0001bdf0: 736c 6967 6874 6c79 0d0a 2020 2020 2020  slightly..      
+0000f7d0: 2020 2020 2020 2020 2020 2020 2031 202f               1 /
+0000f7e0: 206e 702e 7375 6d28 3120 2f20 7578 692a   np.sum(1 / uxi*
+0000f7f0: 2a32 290d 0a20 2020 2020 2020 2020 2020  *2)..           
+0000f800: 2020 2020 2020 2020 2020 2020 2029 2020               )  
+0000f810: 2320 676c 6f62 616c 2070 6861 7365 2075  # global phase u
+0000f820: 6e63 6572 7461 696e 7479 2028 6279 2069  ncertainty (by i
+0000f830: 6e76 6572 7365 2076 6172 6961 6e63 6520  nverse variance 
+0000f840: 7765 6967 6874 696e 6720 6f66 2075 7869  weighting of uxi
+0000f850: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000f860: 2020 2020 2020 2020 2020 206d 6173 6b20             mask 
+0000f870: 3d20 6e70 2e61 7374 7970 6528 7578 203c  = np.astype(ux <
+0000f880: 2030 2e35 2c20 636f 7079 3d46 616c 7365   0.5, copy=False
+0000f890: 2920 2023 2074 6f64 6f3a 2077 6869 6368  )  # todo: which
+0000f8a0: 206c 696d 6974 3f0d 0a0d 0a20 2020 2020   limit?....     
+0000f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f8c0: 2020 2072 6567 5b64 2c20 3a2c 203a 2c20     reg[d, :, :, 
+0000f8d0: 635d 203d 2075 6e77 7261 7070 696e 675f  c] = unwrapping_
+0000f8e0: 696e 7374 616e 6365 2e75 6e77 7261 7050  instance.unwrapP
+0000f8f0: 6861 7365 4d61 7028 7068 695b 642c 203a  haseMap(phi[d, :
+0000f900: 2c20 3a2c 2063 5d2c 206d 6173 6b29 2020  , :, c], mask)  
+0000f910: 2320 746f 646f 3a20 7465 7374 2074 6869  # todo: test thi
+0000f920: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
+0000f930: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f950: 2020 2020 2020 7265 675b 642c 203a 2c20        reg[d, :, 
+0000f960: 3a2c 2063 5d20 3d20 756e 7772 6170 7069  :, c] = unwrappi
+0000f970: 6e67 5f69 6e73 7461 6e63 652e 756e 7772  ng_instance.unwr
+0000f980: 6170 5068 6173 654d 6170 2870 6869 5b64  apPhaseMap(phi[d
+0000f990: 2c20 3a2c 203a 2c20 635d 290d 0a0d 0a20  , :, :, c]).... 
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9b0: 2020 2069 6620 7365 6c66 2e76 6572 626f     if self.verbo
+0000f9c0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+0000f9d0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0000f9e0: 5b64 2c20 3a2c 203a 2c20 635d 203d 2075  [d, :, :, c] = u
+0000f9f0: 6e77 7261 7070 696e 675f 696e 7374 616e  nwrapping_instan
+0000fa00: 6365 2e67 6574 496e 7665 7273 6552 656c  ce.getInverseRel
+0000fa10: 6961 6269 6c69 7479 4d61 7028 2920 2023  iabilityMap()  #
+0000fa20: 2074 6f64 6f3a 2074 6573 7420 7468 6973   todo: test this
+0000fa30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000fa40: 2020 2020 2020 2020 2020 2320 746f 646f            # todo
+0000fa50: 3a20 7265 7320 7673 2e20 7265 6c0d 0a20  : res vs. rel.. 
+0000fa60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000fa70: 6c73 653a 2020 2320 5363 696b 6974 2d69  lse:  # Scikit-i
+0000fa80: 6d61 6765 2061 6c67 6f72 6974 686d 2069  mage algorithm i
+0000fa90: 7320 736c 6f77 6572 2062 7574 2064 656c  s slower but del
+0000faa0: 6976 6572 7320 6265 7474 6572 2072 6573  ivers better res
+0000fab0: 756c 7473 206f 6e20 6564 6765 730d 0a20  ults on edges.. 
+0000fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fad0: 2020 2072 6567 5b64 2c20 3a2c 203a 2c20     reg[d, :, :, 
+0000fae0: 635d 203d 2073 6b69 2e72 6573 746f 7261  c] = ski.restora
+0000faf0: 7469 6f6e 2e75 6e77 7261 705f 7068 6173  tion.unwrap_phas
+0000fb00: 6528 7068 695b 642c 203a 2c20 3a2c 2063  e(phi[d, :, :, c
+0000fb10: 5d29 0d0a 0d0a 2020 2020 2020 2020 2020  ])....          
+0000fb20: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0000fb30: 662e 7665 7262 6f73 653a 0d0a 2020 2020  f.verbose:..    
+0000fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb50: 2020 2020 7265 735b 642c 203a 2c20 3a2c      res[d, :, :,
+0000fb60: 2063 5d20 3d20 6e70 2e6e 616e 0d0a 0d0a   c] = np.nan....
+0000fb70: 2020 2020 2020 2020 2020 2020 7265 676d              regm
+0000fb80: 696e 203d 206e 702e 6d69 6e28 7265 675b  in = np.min(reg[
+0000fb90: 645d 290d 0a20 2020 2020 2020 2020 2020  d])..           
+0000fba0: 2069 6620 7265 676d 696e 203c 2030 3a0d   if regmin < 0:.
+0000fbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fbc0: 2072 6567 5b64 5d20 2d3d 2072 6567 6d69   reg[d] -= regmi
+0000fbd0: 6e0d 0a0d 0a20 2020 2020 2020 2072 6567  n....        reg
+0000fbe0: 202a 3d20 7365 6c66 2e5f 6c5b 3a2c 2030   *= self._l[:, 0
+0000fbf0: 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f  , None, None, No
+0000fc00: 6e65 5d20 2f20 2832 202a 206e 702e 7069  ne] / (2 * np.pi
+0000fc10: 290d 0a0d 0a20 2020 2020 2020 206c 6f67  )....        log
+0000fc20: 6769 6e67 2e64 6562 7567 2866 227b 3130  ging.debug(f"{10
+0000fc30: 3030 202a 2028 7469 6d65 2e70 6572 665f  00 * (time.perf_
+0000fc40: 636f 756e 7465 7228 2920 2d20 7430 297d  counter() - t0)}
+0000fc50: 6d73 2229 0d0a 0d0a 2020 2020 2020 2020  ms")....        
+0000fc60: 7265 7475 726e 2072 6567 2020 2320 746f  return reg  # to
+0000fc70: 646f 3a20 7265 7320 6966 2076 6572 626f  do: res if verbo
+0000fc80: 7365 0d0a 0d0a 2020 2020 2320 4073 7461  se....    # @sta
+0000fc90: 7469 636d 6574 686f 640d 0a20 2020 2023  ticmethod..    #
+0000fca0: 2064 6566 2075 6e77 7261 7028 7068 693a   def unwrap(phi:
+0000fcb0: 206e 702e 6e64 6172 7261 792c 206d 6173   np.ndarray, mas
+0000fcc0: 6b3a 206e 702e 6e64 6172 7261 7920 3d20  k: np.ndarray = 
+0000fcd0: 4e6f 6e65 2c20 6675 6e63 3a20 7374 7220  None, func: str 
+0000fce0: 3d20 2273 6b69 2229 202d 3e20 6e70 2e61  = "ski") -> np.a
+0000fcf0: 7272 6179 3a0d 0a20 2020 2023 2020 2020  rray:..    #    
+0000fd00: 2022 2222 556e 7772 6170 2070 6861 7365   """Unwrap phase
+0000fd10: 206d 6170 7320 7370 6163 6961 6c6c 792e   maps spacially.
+0000fd20: 0d0a 2020 2020 230d 0a20 2020 2023 2020  ..    #..    #  
+0000fd30: 2020 2050 6172 616d 6574 6572 730d 0a20     Parameters.. 
+0000fd40: 2020 2023 2020 2020 202d 2d2d 2d2d 2d2d     #     -------
+0000fd50: 2d2d 2d0d 0a20 2020 2023 2020 2020 2070  ---..    #     p
+0000fd60: 6869 203a 206e 702e 6e64 6172 7261 790d  hi : np.ndarray.
+0000fd70: 0a20 2020 2023 2020 2020 2020 2020 2050  .    #         P
+0000fd80: 6861 7365 206d 6170 7320 746f 2075 6e77  hase maps to unw
+0000fd90: 7261 7020 7370 6174 6961 6c6c 792c 2073  rap spatially, s
+0000fda0: 7461 636b 6564 2061 6c6f 6e67 2074 6865  tacked along the
+0000fdb0: 2066 6972 7374 2064 696d 656e 7369 6f6e   first dimension
+0000fdc0: 2e0d 0a20 2020 2023 2020 2020 2020 2020  ...    #        
+0000fdd0: 2049 7420 6973 2072 6573 6861 7065 6420   It is reshaped 
+0000fde0: 746f 2076 6964 656f 7368 6170 6520 2866  to videoshape (f
+0000fdf0: 7261 6d65 7320 6054 602c 2068 6569 6768  rames `T`, heigh
+0000fe00: 7420 6059 602c 2077 6964 7468 2060 5860  t `Y`, width `X`
+0000fe10: 2c20 636f 6c6f 7220 6368 616e 6e65 6c73  , color channels
+0000fe20: 2060 4360 2920 6265 666f 7265 2070 726f   `C`) before pro
+0000fe30: 6365 7373 696e 672e 0d0a 2020 2020 2320  cessing...    # 
+0000fe40: 2020 2020 2020 2020 5468 6520 6672 616d          The fram
+0000fe50: 6573 2028 6669 7273 7420 6469 6d65 6e73  es (first dimens
+0000fe60: 696f 6e29 2061 7320 7765 6c6c 2074 6865  ion) as well the
+0000fe70: 2063 6f6c 6f72 2063 6861 6e6e 656c 7320   color channels 
+0000fe80: 286c 6173 7420 6469 6d65 6e73 696f 6e29  (last dimension)
+0000fe90: 0d0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
+0000fea0: 6172 6520 756e 7772 6170 7065 6420 7365  are unwrapped se
+0000feb0: 7061 7261 7465 6c79 2e0d 0a20 2020 2023  parately...    #
+0000fec0: 0d0a 2020 2020 2320 2020 2020 6d61 736b  ..    #     mask
+0000fed0: 203a 206e 702e 6e64 6172 7261 792c 206f   : np.ndarray, o
+0000fee0: 7074 696f 6e61 6c0d 0a20 2020 2023 2020  ptional..    #  
+0000fef0: 2020 2020 2020 204d 6173 6b20 696d 6167         Mask imag
+0000ff00: 6520 7769 7468 2064 7479 7065 2027 6e70  e with dtype 'np
+0000ff10: 2e75 696e 7438 2720 7573 6564 2077 6865  .uint8' used whe
+0000ff20: 6e20 736f 6d65 2070 6978 656c 7320 646f  n some pixels do
+0000ff30: 206e 6f74 2068 6f6c 6420 616e 7920 7068   not hold any ph
+0000ff40: 6173 6520 696e 666f 726d 6174 696f 6e2e  ase information.
+0000ff50: 0d0a 2020 2020 230d 0a20 2020 2023 2020  ..    #..    #  
+0000ff60: 2020 2066 756e 6320 3a20 7374 722c 206f     func : str, o
+0000ff70: 7074 696f 6e61 6c0d 0a20 2020 2023 2020  ptional..    #  
+0000ff80: 2020 2020 2020 2055 6e77 7261 7070 696e         Unwrappin
+0000ff90: 6720 6675 6e63 7469 6f6e 2074 6f20 7573  g function to us
+0000ffa0: 652e 2054 6865 2064 6566 6175 6c74 2069  e. The default i
+0000ffb0: 7320 2773 6b69 272e 0d0a 2020 2020 230d  s 'ski'...    #.
+0000ffc0: 0a20 2020 2023 2020 2020 2020 2020 202d  .    #         -
+0000ffd0: 2027 736b 6927 3a20 6053 6369 6b69 742d   'ski': `Scikit-
+0000ffe0: 696d 6167 6520 3c68 7474 7073 3a2f 2f73  image <https://s
+0000fff0: 6369 6b69 742d 696d 6167 652e 6f72 672f  cikit-image.org/
+00010000: 646f 6373 2f73 7461 626c 652f 6175 746f  docs/stable/auto
+00010010: 5f65 7861 6d70 6c65 732f 6669 6c74 6572  _examples/filter
+00010020: 732f 706c 6f74 5f70 6861 7365 5f75 6e77  s/plot_phase_unw
+00010030: 7261 702e 6874 6d6c 3e60 5f20 5b31 5d5f  rap.html>`_ [1]_
+00010040: 0d0a 2020 2020 230d 0a20 2020 2023 2020  ..    #..    #  
+00010050: 2020 2020 2020 202d 2065 6c73 653a 2060         - else: `
+00010060: 4f70 656e 4356 203c 6874 7470 733a 2f2f  OpenCV <https://
+00010070: 646f 6373 2e6f 7065 6e63 762e 6f72 672f  docs.opencv.org/
+00010080: 342e 372e 302f 6466 2f64 3361 2f67 726f  4.7.0/df/d3a/gro
+00010090: 7570 5f5f 7068 6173 655f 5f75 6e77 7261  up__phase__unwra
+000100a0: 7070 696e 672e 6874 6d6c 3e60 5f20 5b32  pping.html>`_ [2
+000100b0: 5d5f 0d0a 2020 2020 230d 0a20 2020 2023  ]_..    #..    #
+000100c0: 2020 2020 2052 6574 7572 6e73 0d0a 2020       Returns..  
+000100d0: 2020 2320 2020 2020 2d2d 2d2d 2d2d 2d0d    #     -------.
+000100e0: 0a20 2020 2023 2020 2020 2075 6e77 7261  .    #     unwra
+000100f0: 7070 6564 203a 206e 702e 6e64 6172 7261  pped : np.ndarra
+00010100: 790d 0a20 2020 2023 2020 2020 2020 2020  y..    #        
+00010110: 2055 6e77 7261 7070 6564 2070 6861 7365   Unwrapped phase
+00010120: 206d 6170 732e 0d0a 2020 2020 230d 0a20   maps...    #.. 
+00010130: 2020 2023 2020 2020 2052 6566 6572 656e     #     Referen
+00010140: 6365 730d 0a20 2020 2023 2020 2020 202d  ces..    #     -
+00010150: 2d2d 2d2d 2d2d 2d2d 2d0d 0a20 2020 2023  ---------..    #
+00010160: 2020 2020 202e 2e20 5b31 5d20 6048 6572       .. [1] `Her
+00010170: 72c3 a165 7a20 6574 2061 6c2e 2c0d 0a20  r..ez et al.,.. 
+00010180: 2020 2023 2020 2020 2022 4661 7374 2074     #     "Fast t
+00010190: 776f 2d64 696d 656e 7369 6f6e 616c 2070  wo-dimensional p
+000101a0: 6861 7365 2d75 6e77 7261 7070 696e 6720  hase-unwrapping 
+000101b0: 616c 676f 7269 7468 6d20 6261 7365 6420  algorithm based 
+000101c0: 6f6e 2073 6f72 7469 6e67 2062 7920 7265  on sorting by re
+000101d0: 6c69 6162 696c 6974 7920 666f 6c6c 6f77  liability follow
+000101e0: 696e 6720 6120 6e6f 6e63 6f6e 7469 6e75  ing a noncontinu
+000101f0: 6f75 7320 7061 7468 222c 0d0a 2020 2020  ous path",..    
+00010200: 2320 2020 2020 4170 706c 6965 6420 4f70  #     Applied Op
+00010210: 7469 6373 2c0d 0a20 2020 2023 2020 2020  tics,..    #    
+00010220: 2032 3030 322e 0d0a 2020 2020 2320 2020   2002...    #   
+00010230: 2020 3c68 7474 7073 3a2f 2f64 6f69 2e6f    <https://doi.o
+00010240: 7267 2f31 302e 3133 3634 2f41 4f2e 3431  rg/10.1364/AO.41
+00010250: 2e30 3037 3433 373e 605f 0d0a 2020 2020  .007437>`_..    
+00010260: 230d 0a20 2020 2023 2020 2020 202e 2e20  #..    #     .. 
+00010270: 5b32 5d20 604c 6569 2065 7420 616c 2e2c  [2] `Lei et al.,
+00010280: 0d0a 2020 2020 2320 2020 2020 2241 206e  ..    #     "A n
+00010290: 6f76 656c 2061 6c67 6f72 6974 686d 2062  ovel algorithm b
+000102a0: 6173 6564 206f 6e20 6869 7374 6f67 7261  ased on histogra
+000102b0: 6d20 7072 6f63 6573 7369 6e67 206f 6620  m processing of 
+000102c0: 7265 6c69 6162 696c 6974 7920 666f 7220  reliability for 
+000102d0: 7477 6f2d 6469 6d65 6e73 696f 6e61 6c20  two-dimensional 
+000102e0: 7068 6173 6520 756e 7772 6170 7069 6e67  phase unwrapping
+000102f0: 222c 0d0a 2020 2020 2320 2020 2020 4f70  ",..    #     Op
+00010300: 7469 6b20 2d20 496e 7465 726e 6174 696f  tik - Internatio
+00010310: 6e61 6c20 4a6f 7572 6e61 6c20 666f 7220  nal Journal for 
+00010320: 4c69 6768 7420 616e 6420 456c 6563 7472  Light and Electr
+00010330: 6f6e 204f 7074 6963 732c 0d0a 2020 2020  on Optics,..    
+00010340: 2320 2020 2020 3230 3135 2e0d 0a20 2020  #     2015...   
+00010350: 2023 2020 2020 203c 6874 7470 733a 2f2f   #     <https://
+00010360: 646f 692e 6f72 672f 3130 2e31 3031 362f  doi.org/10.1016/
+00010370: 6a2e 696a 6c65 6f2e 3230 3135 2e30 342e  j.ijleo.2015.04.
+00010380: 3037 303e 605f 0d0a 2020 2020 2320 2020  070>`_..    #   
+00010390: 2020 2222 220d 0a20 2020 2023 0d0a 2020    """..    #..  
+000103a0: 2020 2320 2020 2020 2320 746f 646f 3a20    #     # todo: 
+000103b0: 636f 756e 7465 7220 2b20 6c6f 670d 0a20  counter + log.. 
+000103c0: 2020 2023 0d0a 2020 2020 2320 2020 2020     #..    #     
+000103d0: 542c 2059 2c20 582c 2043 203d 2076 7368  T, Y, X, C = vsh
+000103e0: 6170 6528 7068 6929 2e73 6861 7065 0d0a  ape(phi).shape..
+000103f0: 2020 2020 2320 2020 2020 7068 6920 3d20      #     phi = 
+00010400: 7068 692e 7265 7368 6170 6528 2854 2c20  phi.reshape((T, 
+00010410: 592c 2058 2c20 4329 290d 0a20 2020 2023  Y, X, C))..    #
+00010420: 0d0a 2020 2020 2320 2020 2020 6966 2066  ..    #     if f
+00010430: 756e 6320 696e 2022 6376 3222 3a20 2023  unc in "cv2":  #
+00010440: 204f 7065 6e43 5620 756e 7772 6170 7069   OpenCV unwrappi
+00010450: 6e67 0d0a 2020 2020 2320 2020 2020 2020  ng..    #       
+00010460: 2020 2320 7061 7261 6d73 203d 2063 7632    # params = cv2
+00010470: 2e70 6861 7365 5f75 6e77 7261 7070 696e  .phase_unwrappin
+00010480: 675f 4869 7374 6f67 7261 6d50 6861 7365  g_HistogramPhase
+00010490: 556e 7772 6170 7069 6e67 5f50 6172 616d  Unwrapping_Param
+000104a0: 7328 290d 0a20 2020 2023 2020 2020 2020  s()..    #      
+000104b0: 2020 2070 6172 616d 7320 3d20 6376 322e     params = cv2.
+000104c0: 7068 6173 655f 756e 7772 6170 7069 6e67  phase_unwrapping
+000104d0: 2e48 6973 746f 6772 616d 5068 6173 6555  .HistogramPhaseU
+000104e0: 6e77 7261 7070 696e 672e 5061 7261 6d73  nwrapping.Params
+000104f0: 2829 0d0a 2020 2020 2320 2020 2020 2020  ()..    #       
+00010500: 2020 7061 7261 6d73 2e68 6569 6768 7420    params.height 
+00010510: 3d20 590d 0a20 2020 2023 2020 2020 2020  = Y..    #      
+00010520: 2020 2070 6172 616d 732e 7769 6474 6820     params.width 
+00010530: 3d20 580d 0a20 2020 2023 2020 2020 2020  = X..    #      
+00010540: 2020 2023 2075 6e77 7261 7070 696e 675f     # unwrapping_
+00010550: 696e 7374 616e 6365 203d 2063 7632 2e70  instance = cv2.p
+00010560: 6861 7365 5f75 6e77 7261 7070 696e 672e  hase_unwrapping.
+00010570: 4869 7374 6f67 7261 6d50 6861 7365 556e  HistogramPhaseUn
+00010580: 7772 6170 7069 6e67 5f63 7265 6174 6528  wrapping_create(
+00010590: 7061 7261 6d73 290d 0a20 2020 2023 2020  params)..    #  
+000105a0: 2020 2020 2020 2075 6e77 7261 7070 696e         unwrappin
+000105b0: 675f 696e 7374 616e 6365 203d 2063 7632  g_instance = cv2
+000105c0: 2e70 6861 7365 5f75 6e77 7261 7070 696e  .phase_unwrappin
+000105d0: 672e 4869 7374 6f67 7261 6d50 6861 7365  g.HistogramPhase
+000105e0: 556e 7772 6170 7069 6e67 2e63 7265 6174  Unwrapping.creat
+000105f0: 6528 7061 7261 6d73 290d 0a20 2020 2023  e(params)..    #
+00010600: 0d0a 2020 2020 2320 2020 2020 7577 7220  ..    #     uwr 
+00010610: 3d20 6e70 2e65 6d70 7479 5f6c 696b 6528  = np.empty_like(
+00010620: 7068 6929 0d0a 2020 2020 230d 0a20 2020  phi)..    #..   
+00010630: 2023 2020 2020 2066 6f72 2074 2069 6e20   #     for t in 
+00010640: 7261 6e67 6528 5429 3a0d 0a20 2020 2023  range(T):..    #
+00010650: 2020 2020 2020 2020 2066 6f72 2063 2069           for c i
+00010660: 6e20 7261 6e67 6528 4329 3a0d 0a20 2020  n range(C):..   
+00010670: 2023 2020 2020 2020 2020 2020 2020 2069   #             i
+00010680: 6620 6675 6e63 2069 6e20 2263 7632 223a  f func in "cv2":
+00010690: 2020 2320 4f70 656e 4356 2061 6c67 6f72    # OpenCV algor
+000106a0: 6974 686d 2069 7320 7573 7561 6c6c 7920  ithm is usually 
+000106b0: 6661 7374 6572 2c20 6275 7420 6361 6e20  faster, but can 
+000106c0: 6265 206d 7563 6820 736c 6f77 6572 2069  be much slower i
+000106d0: 6e20 6e6f 6973 7920 696d 6167 6573 0d0a  n noisy images..
+000106e0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+000106f0: 2020 2020 2020 2320 6474 7970 6520 6d75        # dtype mu
+00010700: 7374 2062 6520 6e70 2e66 6c6f 6174 3332  st be np.float32
+00010710: 2020 2320 746f 646f 3a20 7465 7374 2074    # todo: test t
+00010720: 6869 730d 0a20 2020 2023 2020 2020 2020  his..    #      
+00010730: 2020 2020 2020 2020 2020 2069 6620 4661             if Fa
+00010740: 6c73 653a 2020 2320 6973 696e 7374 616e  lse:  # isinstan
+00010750: 6365 286d 6173 6b2c 206e 702e 6e64 6172  ce(mask, np.ndar
+00010760: 7261 7929 2061 6e64 2076 7368 6170 6528  ray) and vshape(
+00010770: 6d61 736b 292e 7368 6170 6520 3d3d 2070  mask).shape == p
+00010780: 6869 2e73 6861 7065 3a0d 0a20 2020 2023  hi.shape:..    #
+00010790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107a0: 2020 2020 2023 2074 6f64 6f3a 2075 6e77       # todo: unw
+000107b0: 7261 7020 7769 7468 206d 6173 6b0d 0a20  rap with mask.. 
+000107c0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+000107d0: 2020 2020 2020 2020 206d 6173 6b20 3d20           mask = 
+000107e0: 7673 6861 7065 286d 6173 6b29 0d0a 2020  vshape(mask)..  
+000107f0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00010800: 2020 2020 2020 2020 6d61 736b 203d 206e          mask = n
+00010810: 702e 6173 7479 7065 286d 6173 6b5b 742c  p.astype(mask[t,
+00010820: 203a 2c20 3a2c 2063 5d2c 2063 6f70 793d   :, :, c], copy=
+00010830: 4661 6c73 6529 0d0a 2020 2020 2320 2020  False)..    #   
+00010840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010850: 2020 7577 725b 742c 203a 2c20 3a2c 2063    uwr[t, :, :, c
+00010860: 5d20 3d20 756e 7772 6170 7069 6e67 5f69  ] = unwrapping_i
+00010870: 6e73 7461 6e63 652e 756e 7772 6170 5068  nstance.unwrapPh
+00010880: 6173 654d 6170 2870 6869 5b74 2c20 3a2c  aseMap(phi[t, :,
+00010890: 203a 2c20 635d 2c20 6d61 736b 290d 0a20   :, c], mask).. 
+000108a0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+000108b0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+000108c0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+000108d0: 2020 2020 2020 7577 725b 742c 203a 2c20        uwr[t, :, 
+000108e0: 3a2c 2063 5d20 3d20 756e 7772 6170 7069  :, c] = unwrappi
+000108f0: 6e67 5f69 6e73 7461 6e63 652e 756e 7772  ng_instance.unwr
+00010900: 6170 5068 6173 654d 6170 2870 6869 5b74  apPhaseMap(phi[t
+00010910: 2c20 3a2c 203a 2c20 635d 290d 0a20 2020  , :, :, c])..   
+00010920: 2023 0d0a 2020 2020 2320 2020 2020 2020   #..    #       
+00010930: 2020 2020 2020 2020 2020 2320 2320 6474            # # dt
+00010940: 7970 6520 6f66 2070 6861 7365 206d 7573  ype of phase mus
+00010950: 7420 6265 206e 702e 7569 6e74 382c 2064  t be np.uint8, d
+00010960: 7479 7065 206f 6620 7368 6164 6f77 5f6d  type of shadow_m
+00010970: 6173 6b20 6e70 2e75 696e 7438 2020 2320  ask np.uint8  # 
+00010980: 746f 646f 3a20 7465 7374 2074 6869 730d  todo: test this.
+00010990: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
+000109a0: 2020 2020 2020 2023 2072 6567 5b64 2c20         # reg[d, 
+000109b0: 3a2c 203a 2c20 635d 203d 2075 6e77 7261  :, :, c] = unwra
+000109c0: 7070 696e 675f 696e 7374 616e 6365 2e75  pping_instance.u
+000109d0: 6e77 7261 7050 6861 7365 4d61 7028 7068  nwrapPhaseMap(ph
+000109e0: 695b 642c 203a 2c20 3a2c 2063 5d2c 2073  i[d, :, :, c], s
+000109f0: 6861 646f 774d 6173 6b3d 7368 6164 6f77  hadowMask=shadow
+00010a00: 5f6d 6173 6b29 0d0a 2020 2020 2320 2020  _mask)..    #   
+00010a10: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
+00010a20: 2023 2053 6369 6b69 742d 696d 6167 6520   # Scikit-image 
+00010a30: 616c 676f 7269 7468 6d20 6973 2073 6c6f  algorithm is slo
+00010a40: 7765 7220 6275 7420 6465 6c69 7665 7273  wer but delivers
+00010a50: 2062 6574 7465 7220 7265 7375 6c74 7320   better results 
+00010a60: 6f6e 2065 6467 6573 0d0a 2020 2020 2320  on edges..    # 
+00010a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a80: 7577 725b 742c 203a 2c20 3a2c 2063 5d20  uwr[t, :, :, c] 
+00010a90: 3d20 736b 692e 7265 7374 6f72 6174 696f  = ski.restoratio
+00010aa0: 6e2e 756e 7772 6170 5f70 6861 7365 2870  n.unwrap_phase(p
+00010ab0: 6869 5b74 2c20 3a2c 203a 2c20 635d 290d  hi[t, :, :, c]).
+00010ac0: 0a20 2020 2023 0d0a 2020 2020 2320 2020  .    #..    #   
+00010ad0: 2020 7265 7475 726e 2075 7772 0d0a 0d0a    return uwr....
+00010ae0: 2020 2020 6465 6620 736f 7572 6365 280d      def source(.
+00010af0: 0a20 2020 2020 2020 2073 656c 662c 0d0a  .        self,..
+00010b00: 2020 2020 2020 2020 7869 3a20 6e70 2e6e          xi: np.n
+00010b10: 6461 7272 6179 2c0d 0a20 2020 2020 2020  darray,..       
+00010b20: 2042 3a20 6e70 2e6e 6461 7272 6179 203d   B: np.ndarray =
+00010b30: 204e 6f6e 652c 0d0a 2020 2020 2020 2020   None,..        
+00010b40: 753a 206e 702e 6e64 6172 7261 7920 7c20  u: np.ndarray | 
+00010b50: 666c 6f61 7420 3d20 302c 0d0a 2020 2020  float = 0,..    
+00010b60: 2020 2020 6478 3a20 666c 6f61 7420 3d20      dx: float = 
+00010b70: 312c 0d0a 2020 2020 2020 2020 6d6f 6465  1,..        mode
+00010b80: 3a20 7374 7220 3d20 2266 6173 7422 2c0d  : str = "fast",.
+00010b90: 0a20 2020 2029 202d 3e20 6e70 2e6e 6461  .    ) -> np.nda
+00010ba0: 7272 6179 3a0d 0a20 2020 2020 2020 2022  rray:..        "
+00010bb0: 2222 536f 7572 6365 2061 6374 6976 6174  ""Source activat
+00010bc0: 696f 6e20 6865 6174 6d61 702e 0d0a 0d0a  ion heatmap.....
+00010bd0: 2020 2020 2020 2020 5468 6520 6465 636f          The deco
+00010be0: 6465 6420 636f 6f72 6469 6e61 7465 7320  ded coordinates 
+00010bf0: 2868 6176 696e 6720 7375 622d 7069 7865  (having sub-pixe
+00010c00: 6c20 6163 6375 7261 6379 290d 0a20 2020  l accuracy)..   
+00010c10: 2020 2020 2061 7265 206d 6170 7065 6420       are mapped 
+00010c20: 6672 6f6d 2074 6865 2063 616d 6572 6120  from the camera 
+00010c30: 6772 6964 0d0a 2020 2020 2020 2020 746f  grid..        to
+00010c40: 2069 6e74 6567 6572 2070 6f73 6974 696f   integer positio
+00010c50: 6e73 206f 6e20 7468 6520 7363 7265 656e  ns on the screen
+00010c60: 2067 7269 640d 0a20 2020 2020 2020 2077   grid..        w
+00010c70: 6974 6820 7765 6967 6874 7320 6672 6f6d  ith weights from
+00010c80: 2074 6865 206d 6f64 756c 6174 696f 6e2e   the modulation.
+00010c90: 0d0a 0d0a 2020 2020 2020 2020 5468 6973  ....        This
+00010ca0: 2079 6965 6c64 7320 7468 6520 736f 7572   yields the sour
+00010cb0: 6365 2061 6374 6976 6174 696f 6e20 6865  ce activation he
+00010cc0: 6174 6d61 703a 0d0a 2020 2020 2020 2020  atmap:..        
+00010cd0: 6120 6772 6964 2072 6570 7265 7365 6e74  a grid represent
+00010ce0: 696e 6720 7468 6520 7363 7265 656e 2028  ing the screen (
+00010cf0: 6c69 6768 7420 736f 7572 6365 290d 0a20  light source).. 
+00010d00: 2020 2020 2020 2077 6974 6820 7468 6520         with the 
+00010d10: 7069 7865 6c20 7661 6c75 6573 2062 6569  pixel values bei
+00010d20: 6e67 2061 2072 656c 6174 6976 6520 6d65  ng a relative me
+00010d30: 6173 7572 650d 0a20 2020 2020 2020 206f  asure..        o
+00010d40: 6620 686f 7720 6d75 6368 2061 2073 6372  f how much a scr
+00010d50: 6565 6e20 286c 6967 6874 2073 6f75 7263  een (light sourc
+00010d60: 6529 2070 6978 656c 2063 6f6e 7472 6962  e) pixel contrib
+00010d70: 7574 6564 0d0a 2020 2020 2020 2020 746f  uted..        to
+00010d80: 2074 6865 2065 7870 6f73 7572 6520 6f66   the exposure of
+00010d90: 2074 6865 2063 616d 6572 6120 7365 6e73   the camera sens
+00010da0: 6f72 2e0d 0a0d 0a20 2020 2020 2020 2054  or.....        T
+00010db0: 6865 2064 696d 656e 7369 6f6e 7320 6f66  he dimensions of
+00010dc0: 2074 6865 2073 6372 6565 6e20 6172 6520   the screen are 
+00010dd0: 7461 6b65 6e20 6672 6f6d 2074 6865 2060  taken from the `
+00010de0: 4672 696e 6765 7360 2069 6e73 7461 6e63  Fringes` instanc
+00010df0: 652e 0d0a 0d0a 2020 2020 2020 2020 5061  e.....        Pa
+00010e00: 7261 6d65 7465 7273 0d0a 2020 2020 2020  rameters..      
+00010e10: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020    ----------..  
+00010e20: 2020 2020 2020 7869 203a 206e 702e 6e64        xi : np.nd
+00010e30: 6172 7261 790d 0a20 2020 2020 2020 2020  array..         
+00010e40: 2020 2052 6567 6973 7472 6174 696f 6e2c     Registration,
+00010e50: 2069 2e65 2e20 7468 6520 6465 636f 6465   i.e. the decode
+00010e60: 6420 7363 7265 656e 2063 6f6f 7264 696e  d screen coordin
+00010e70: 6174 6573 2061 7320 7365 656e 2062 7920  ates as seen by 
+00010e80: 7468 6520 6361 6d65 7261 2e0d 0a20 2020  the camera...   
+00010e90: 2020 2020 2020 2020 2049 7420 6973 2072           It is r
+00010ea0: 6573 6861 7065 6420 746f 2076 6964 656f  eshaped to video
+00010eb0: 7368 6170 6520 2866 7261 6d65 7320 6054  shape (frames `T
+00010ec0: 602c 2068 6569 6768 7420 6059 602c 2077  `, height `Y`, w
+00010ed0: 6964 7468 2060 5860 2c20 636f 6c6f 7220  idth `X`, color 
+00010ee0: 6368 616e 6e65 6c73 2060 4360 2920 6265  channels `C`) be
+00010ef0: 666f 7265 2070 726f 6365 7373 696e 672e  fore processing.
+00010f00: 0d0a 0d0a 2020 2020 2020 2020 4220 3a20  ....        B : 
+00010f10: 6e70 2e6e 6461 7272 6179 2c20 6f70 7469  np.ndarray, opti
+00010f20: 6f6e 616c 0d0a 2020 2020 2020 2020 2020  onal..          
+00010f30: 2020 4d6f 6475 6c61 7469 6f6e 2e20 5573    Modulation. Us
+00010f40: 6564 2066 6f72 2077 6569 6768 7469 6e67  ed for weighting
+00010f50: 2e0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
+00010f60: 7420 6973 2072 6573 6861 7065 6420 746f  t is reshaped to
+00010f70: 2076 6964 656f 7368 6170 6520 2866 7261   videoshape (fra
+00010f80: 6d65 7320 6054 602c 2068 6569 6768 7420  mes `T`, height 
+00010f90: 6059 602c 2077 6964 7468 2060 5860 2c20  `Y`, width `X`, 
+00010fa0: 636f 6c6f 7220 6368 616e 6e65 6c73 2060  color channels `
+00010fb0: 4360 2920 6265 666f 7265 2070 726f 6365  C`) before proce
+00010fc0: 7373 696e 672e 0d0a 2020 2020 2020 2020  ssing...        
+00010fd0: 2020 2020 4966 2060 4260 2069 7320 616e      If `B` is an
+00010fe0: 2061 7272 6179 2c20 6974 206d 7573 7420   array, it must 
+00010ff0: 6861 7665 2074 6865 2073 616d 6520 6865  have the same he
+00011000: 6967 6874 2060 5960 2c20 7769 6474 6820  ight `Y`, width 
+00011010: 6058 6020 616e 6420 636f 6c6f 7220 6368  `X` and color ch
+00011020: 616e 6e65 6c73 2060 4360 2061 7320 6078  annels `C` as `x
+00011030: 6960 2e0d 0a20 2020 2020 2020 2020 2020  i`...           
+00011040: 2049 6620 6042 6020 6973 206e 6f74 2067   If `B` is not g
+00011050: 6976 656e 2c20 6571 7561 6c20 7765 6967  iven, equal weig
+00011060: 6874 7320 6172 6520 7573 6564 2e0d 0a0d  hts are used....
+00011070: 0a20 2020 2020 2020 2075 203a 206e 702e  .        u : np.
+00011080: 6e64 6172 7261 7920 7c20 666c 6f61 742c  ndarray | float,
+00011090: 206f 7074 696f 6e61 6c0d 0a20 2020 2020   optional..     
+000110a0: 2020 2020 2020 2055 6e63 6572 7461 696e         Uncertain
+000110b0: 7479 2e0d 0a20 2020 2020 2020 2020 2020  ty...           
+000110c0: 2049 7420 6973 2072 6573 6861 7065 6420   It is reshaped 
+000110d0: 746f 2076 6964 656f 7368 6170 6520 2866  to videoshape (f
+000110e0: 7261 6d65 7320 6054 602c 2068 6569 6768  rames `T`, heigh
+000110f0: 7420 6059 602c 2077 6964 7468 2060 5860  t `Y`, width `X`
+00011100: 2c20 636f 6c6f 7220 6368 616e 6e65 6c73  , color channels
+00011110: 2060 4360 2920 6265 666f 7265 2070 726f   `C`) before pro
+00011120: 6365 7373 696e 672e 0d0a 2020 2020 2020  cessing...      
+00011130: 2020 2020 2020 4966 2060 7560 2069 7320        If `u` is 
+00011140: 616e 2061 7272 6179 2c20 6974 206d 7573  an array, it mus
+00011150: 7420 6861 7665 2074 6865 2073 616d 6520  t have the same 
+00011160: 6865 6967 6874 2060 5960 2c20 7769 6474  height `Y`, widt
+00011170: 6820 6058 6020 616e 6420 636f 6c6f 7220  h `X` and color 
+00011180: 6368 616e 6e65 6c73 2060 4360 2061 7320  channels `C` as 
+00011190: 6078 6960 2e0d 0a20 2020 2020 2020 2020  `xi`...         
+000111a0: 2020 2044 6566 6175 6c74 2069 7320 7a65     Default is ze
+000111b0: 726f 2e0d 0a0d 0a20 2020 2020 2020 2064  ro.....        d
+000111c0: 7820 3a20 666c 6f61 742c 206f 7074 696f  x : float, optio
+000111d0: 6e61 6c0d 0a20 2020 2020 2020 2020 2020  nal..           
+000111e0: 2053 697a 6520 6f66 206f 6e65 2063 616d   Size of one cam
+000111f0: 6572 6120 7069 7865 6c2c 2070 726f 6a65  era pixel, proje
+00011200: 6374 6564 206f 6e74 6f20 7468 6520 7363  cted onto the sc
+00011210: 7265 656e 2c20 696e 2075 6e69 7473 206f  reen, in units o
+00011220: 6620 7363 7265 656e 2070 6978 656c 732e  f screen pixels.
+00011230: 0d0a 2020 2020 2020 2020 2020 2020 4465  ..            De
+00011240: 6661 756c 7420 6973 206f 6e65 2e0d 0a0d  fault is one....
+00011250: 0a20 2020 2020 2020 206d 6f64 6520 3a20  .        mode : 
+00011260: 7374 722c 206f 7074 696f 6e61 6c0d 0a20  str, optional.. 
+00011270: 2020 2020 2020 2020 2020 2042 7920 6465             By de
+00011280: 6661 756c 742c 2066 6173 7420 7265 6d61  fault, fast rema
+00011290: 7070 696e 6720 6973 2061 7070 6c69 6564  pping is applied
+000112a0: 2e0d 0a20 2020 2020 2020 2020 2020 2045  ...            E
+000112b0: 6c73 652c 2069 6e76 6572 7365 2064 6973  lse, inverse dis
+000112c0: 7461 6e63 6520 7765 6967 6874 6564 2072  tance weighted r
+000112d0: 656d 6170 7069 6e67 2069 7320 6170 706c  emapping is appl
+000112e0: 6965 642c 0d0a 2020 2020 2020 2020 2020  ied,..          
+000112f0: 2020 7768 6963 6820 6973 206d 6f72 6520    which is more 
+00011300: 7072 6563 6973 6520 6275 7420 616c 736f  precise but also
+00011310: 206d 6f72 6520 7469 6d65 2d63 6f6e 7375   more time-consu
+00011320: 6d69 6e67 2e0d 0a0d 0a20 2020 2020 2020  ming.....       
+00011330: 2052 6574 7572 6e73 0d0a 2020 2020 2020   Returns..      
+00011340: 2020 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020    -------..     
+00011350: 2020 2073 7263 203a 206e 702e 6e64 6172     src : np.ndar
+00011360: 7261 790d 0a20 2020 2020 2020 2020 2020  ray..           
+00011370: 2053 6f75 7263 6520 6163 7469 7661 7469   Source activati
+00011380: 6f6e 2068 6561 746d 6170 2e0d 0a0d 0a20  on heatmap..... 
+00011390: 2020 2020 2020 204e 6f74 6573 0d0a 2020         Notes..  
+000113a0: 2020 2020 2020 2d2d 2d2d 2d0d 0a20 2020        -----..   
+000113b0: 2020 2020 2049 6e20 6661 6374 2c20 7468       In fact, th
+000113c0: 6973 2069 7320 7468 6520 696e 7665 7273  is is the invers
+000113d0: 6520 6675 6e63 7469 6f6e 206f 6620 4f70  e function of Op
+000113e0: 656e 4356 e280 9973 2072 656d 6170 2829  enCV...s remap()
+000113f0: 205b 335d 5f2e 0d0a 0d0a 2020 2020 2020   [3]_.....      
+00011400: 2020 5265 6665 7265 6e63 6573 0d0a 2020    References..  
+00011410: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
+00011420: 0d0a 2020 2020 2020 2020 2e2e 205b 335d  ..        .. [3]
+00011430: 2060 4f70 656e 4356 2c0d 0a20 2020 2020   `OpenCV,..     
+00011440: 2020 2020 2020 2020 2020 2272 656d 6170            "remap
+00011450: 2829 222c 0d0a 2020 2020 2020 2020 2020  ()",..          
+00011460: 2020 2020 204f 7065 6e43 562c 0d0a 2020       OpenCV,..  
+00011470: 2020 2020 2020 2020 2020 2020 2032 3032               202
+00011480: 342e 0d0a 2020 2020 2020 2020 2020 2020  4...            
+00011490: 2020 203c 6874 7470 733a 2f2f 646f 6373     <https://docs
+000114a0: 2e6f 7065 6e63 762e 6f72 672f 342e 392e  .opencv.org/4.9.
+000114b0: 302f 6461 2f64 3534 2f67 726f 7570 5f5f  0/da/d54/group__
+000114c0: 696d 6770 726f 635f 5f74 7261 6e73 666f  imgproc__transfo
+000114d0: 726d 2e68 746d 6c23 6761 6237 3565 6633  rm.html#gab75ef3
+000114e0: 3163 6535 6364 6662 3563 3434 6236 6461  1ce5cdfb5c44b6da
+000114f0: 3566 3362 3930 3865 6134 3e60 5f0d 0a0d  5f3b908ea4>`_...
+00011500: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
+00011510: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
+00011520: 2d2d 2d0d 0a20 2020 2020 2020 203e 3e3e  ---..        >>>
+00011530: 2069 6d70 6f72 7420 6672 696e 6765 7320   import fringes 
+00011540: 6173 2066 726e 670d 0a20 2020 2020 2020  as frng..       
+00011550: 203e 3e3e 2066 203d 2066 726e 672e 4672   >>> f = frng.Fr
+00011560: 696e 6765 7328 290d 0a20 2020 2020 2020  inges()..       
+00011570: 203e 3e3e 2049 203d 2066 2e65 6e63 6f64   >>> I = f.encod
+00011580: 6528 290d 0a0d 0a20 2020 2020 2020 203e  e()....        >
+00011590: 3e3e 2041 2c20 422c 2078 203d 2066 2e64  >> A, B, x = f.d
+000115a0: 6563 6f64 6528 4929 0d0a 0d0a 2020 2020  ecode(I)....    
+000115b0: 2020 2020 3e3e 3e20 7372 6320 3d20 662e      >>> src = f.
+000115c0: 7265 6d61 7028 782c 2042 290d 0a20 2020  remap(x, B)..   
+000115d0: 2020 2020 2022 2222 0d0a 2020 2020 2020       """..      
+000115e0: 2020 2320 4220 3d20 3d20 6376 322e 7265    # B = = cv2.re
+000115f0: 6d61 7028 7372 632c 2078 695b 305d 2c20  map(src, xi[0], 
+00011600: 7869 5b31 5d2c 2063 7632 2e49 4e54 4552  xi[1], cv2.INTER
+00011610: 5f4c 494e 4541 5229 2020 2320 7468 6973  _LINEAR)  # this
+00011620: 2069 7320 7468 6520 696e 7665 7273 6520   is the inverse 
+00011630: 6675 6e63 7469 6f6e 206f 6620 7768 6174  function of what
+00011640: 2077 6520 7761 6e74 0d0a 0d0a 2020 2020   we want....    
+00011650: 2020 2020 7430 203d 2074 696d 652e 7065      t0 = time.pe
+00011660: 7266 5f63 6f75 6e74 6572 2829 0d0a 0d0a  rf_counter()....
+00011670: 2020 2020 2020 2020 542c 2059 2c20 582c          T, Y, X,
+00011680: 2043 203d 2076 7368 6170 6528 7869 292e   C = vshape(xi).
+00011690: 7368 6170 650d 0a0d 0a20 2020 2020 2020  shape....       
+000116a0: 2023 2074 7269 6d20 5869 0d0a 2020 2020   # trim Xi..    
+000116b0: 2020 2020 7869 203d 2078 692e 7265 7368      xi = xi.resh
+000116c0: 6170 6528 282d 312c 2059 2c20 582c 2043  ape((-1, Y, X, C
+000116d0: 2929 0d0a 2020 2020 2020 2020 6966 2073  ))..        if s
+000116e0: 656c 662e 4420 3d3d 2031 3a0d 0a20 2020  elf.D == 1:..   
+000116f0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00011700: 2e61 7869 7320 3d3d 2030 3a0d 0a20 2020  .axis == 0:..   
+00011710: 2020 2020 2020 2020 2020 2020 2023 2078               # x
+00011720: 6920 3d20 6e70 2e76 7374 6163 6b28 2878  i = np.vstack((x
+00011730: 692c 206e 702e 7a65 726f 735f 6c69 6b65  i, np.zeros_like
+00011740: 2878 6929 2929 0d0a 2020 2020 2020 2020  (xi)))..        
+00011750: 2020 2020 2020 2020 7869 203d 206e 702e          xi = np.
+00011760: 636f 6e63 6174 656e 6174 6528 2878 692c  concatenate((xi,
+00011770: 206e 702e 7a65 726f 735f 6c69 6b65 2878   np.zeros_like(x
+00011780: 6929 292c 2061 7869 733d 3029 0d0a 2020  i)), axis=0)..  
+00011790: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
+000117a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000117b0: 2023 2078 6920 3d20 6e70 2e76 7374 6163   # xi = np.vstac
+000117c0: 6b28 286e 702e 7a65 726f 735f 6c69 6b65  k((np.zeros_like
+000117d0: 2878 6929 2c20 7869 2929 0d0a 2020 2020  (xi), xi))..    
+000117e0: 2020 2020 2020 2020 2020 2020 7869 203d              xi =
+000117f0: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
+00011800: 286e 702e 7a65 726f 735f 6c69 6b65 2878  (np.zeros_like(x
+00011810: 6929 2c20 7869 292c 2061 7869 733d 3029  i), xi), axis=0)
+00011820: 0d0a 2020 2020 2020 2020 656c 6966 2073  ..        elif s
+00011830: 656c 662e 696e 6465 7869 6e67 203d 3d20  elf.indexing == 
+00011840: 2269 6a22 3a0d 0a20 2020 2020 2020 2020  "ij":..         
+00011850: 2020 2078 6920 3d20 7869 5b3a 3a2d 315d     xi = xi[::-1]
+00011860: 2020 2320 7265 7475 726e 7320 6120 7669    # returns a vi
+00011870: 6577 0d0a 2020 2020 2020 2020 2020 2020  ew..            
+00011880: 2320 4220 646f 6573 206e 6f74 206e 6565  # B does not nee
+00011890: 6420 746f 2062 6520 6368 616e 6765 6420  d to be changed 
+000118a0: 6265 6361 7573 6520 7468 6572 6520 6973  because there is
+000118b0: 206f 6e6c 7920 6f6e 6520 6675 7365 6420   only one fused 
+000118c0: 7661 6c75 6520 666f 7220 6561 6368 2028  value for each (
+000118d0: 782c 2079 292d 636f 6f72 6469 6e61 7465  x, y)-coordinate
+000118e0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000118f0: 7520 646f 6573 206e 6f74 206e 6565 6420  u does not need 
+00011900: 746f 2062 6520 6368 616e 6765 6420 6265  to be changed be
+00011910: 6361 7573 6520 7468 6572 6520 6973 206f  cause there is o
+00011920: 6e6c 7920 6f6e 6520 7661 6c75 6520 666f  nly one value fo
+00011930: 7220 6561 6368 2028 782c 2079 292d 636f  r each (x, y)-co
+00011940: 6f72 6469 6e61 7465 0d0a 2020 2020 2020  ordinate..      
+00011950: 2020 7661 6c69 6420 3d20 2878 695b 305d    valid = (xi[0]
+00011960: 203c 3d20 7365 6c66 2e58 2920 2a20 2878   <= self.X) * (x
+00011970: 695b 315d 203c 3d20 7365 6c66 2e59 290d  i[1] <= self.Y).
+00011980: 0a0d 0a20 2020 2020 2020 2023 2074 7269  ...        # tri
+00011990: 6d20 420d 0a20 2020 2020 2020 2069 6620  m B..        if 
+000119a0: 6973 696e 7374 616e 6365 2842 2c20 6e70  isinstance(B, np
+000119b0: 2e6e 6461 7272 6179 293a 0d0a 2020 2020  .ndarray):..    
+000119c0: 2020 2020 2020 2020 6173 7365 7274 2078          assert x
+000119d0: 692e 7368 6170 655b 313a 5d20 3d3d 2042  i.shape[1:] == B
+000119e0: 2e73 6861 7065 5b31 3a5d 2c20 2227 7869  .shape[1:], "'xi
+000119f0: 2720 616e 6420 2742 2720 6861 7665 2064  ' and 'B' have d
+00011a00: 6966 6665 7265 6e74 2077 6964 7468 2c20  ifferent width, 
+00011a10: 6865 6967 6874 206f 7220 6e75 6d62 6572  height or number
+00011a20: 206f 6620 636f 6c6f 7220 6368 616e 6e65   of color channe
+00011a30: 6c73 220d 0a20 2020 2020 2020 2020 2020  ls"..           
+00011a40: 2042 203d 2042 2e72 6573 6861 7065 2828   B = B.reshape((
+00011a50: 2d31 2c20 592c 2058 2c20 4329 290d 0a20  -1, Y, X, C)).. 
+00011a60: 2020 2020 2020 2020 2020 2023 2042 203d             # B =
+00011a70: 206e 702e 6d61 7828 422c 2061 7869 733d   np.max(B, axis=
+00011a80: 3029 0d0a 2020 2020 2020 2020 2020 2020  0)..            
+00011a90: 4220 3d20 6e70 2e6d 6561 6e28 422c 2061  B = np.mean(B, a
+00011aa0: 7869 733d 3029 0d0a 2020 2020 2020 2020  xis=0)..        
+00011ab0: 2020 2020 2320 746f 646f 3a20 7265 6d61      # todo: rema
+00011ac0: 7020 666f 7220 6561 6368 2042 3f0d 0a0d  p for each B?...
+00011ad0: 0a20 2020 2020 2020 2069 6620 6d6f 6465  .        if mode
+00011ae0: 203d 3d20 2266 6173 7422 3a0d 0a20 2020   == "fast":..   
+00011af0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00011b00: 6973 696e 7374 616e 6365 2842 2c20 6e70  isinstance(B, np
+00011b10: 2e6e 6461 7272 6179 293a 0d0a 2020 2020  .ndarray):..    
+00011b20: 2020 2020 2020 2020 2020 2020 4220 3d20              B = 
+00011b30: 6e70 2e6f 6e65 7328 2859 2c20 582c 2043  np.ones((Y, X, C
+00011b40: 292c 206e 702e 7569 6e74 3829 0d0a 0d0a  ), np.uint8)....
+00011b50: 2020 2020 2020 2020 2020 2020 2320 7472              # tr
+00011b60: 696d 2075 0d0a 2020 2020 2020 2020 2020  im u..          
+00011b70: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00011b80: 752c 206e 702e 6e64 6172 7261 7929 3a0d  u, np.ndarray):.
+00011b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011ba0: 2061 7373 6572 7420 280d 0a20 2020 2020   assert (..     
+00011bb0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+00011bc0: 692e 7368 6170 655b 313a 5d20 3d3d 2075  i.shape[1:] == u
+00011bd0: 2e73 6861 7065 5b31 3a5d 0d0a 2020 2020  .shape[1:]..    
+00011be0: 2020 2020 2020 2020 2020 2020 292c 2022              ), "
+00011bf0: 2778 6927 2061 6e64 2027 7527 2068 6176  'xi' and 'u' hav
+00011c00: 6520 6469 6666 6572 656e 7420 7769 6474  e different widt
+00011c10: 682c 2068 6569 6768 7420 6f72 206e 756d  h, height or num
+00011c20: 6265 7220 6f66 2063 6f6c 6f72 2063 6861  ber of color cha
+00011c30: 6e6e 656c 7322 0d0a 2020 2020 2020 2020  nnels"..        
+00011c40: 2020 2020 2020 2020 7520 3d20 752e 7265          u = u.re
+00011c50: 7368 6170 6528 282d 312c 2059 2c20 582c  shape((-1, Y, X,
+00011c60: 2043 2929 0d0a 2020 2020 2020 2020 2020   C))..          
+00011c70: 2020 2020 2020 7520 3d20 6e70 2e6d 6178        u = np.max
+00011c80: 696d 756d 2875 2c20 7365 6c66 2e75 290d  imum(u, self.u).
+00011c90: 0a0d 0a20 2020 2020 2020 2020 2020 2073  ...            s
+00011ca0: 7263 203d 206e 702e 7a65 726f 7328 2873  rc = np.zeros((s
+00011cb0: 656c 662e 592c 2073 656c 662e 582c 2043  elf.Y, self.X, C
+00011cc0: 292c 206e 702e 666c 6f61 7433 3229 0d0a  ), np.float32)..
+00011cd0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00011ce0: 7869 203d 2078 695b 3a3a 2d31 5d20 2023  xi = xi[::-1]  #
+00011cf0: 2072 6574 7572 6e73 2061 2076 6965 770d   returns a view.
+00011d00: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+00011d10: 6478 203d 206e 702e 7269 6e74 2878 6929  dx = np.rint(xi)
+00011d20: 2e61 7374 7970 6528 696e 742c 2063 6f70  .astype(int, cop
+00011d30: 793d 4661 6c73 6529 0d0a 2020 2020 2020  y=False)..      
+00011d40: 2020 2020 2020 2320 666f 7220 6320 696e        # for c in
+00011d50: 2072 616e 6765 2843 293a 2020 2320 6c6f   range(C):  # lo
+00011d60: 6f70 696e 6720 7468 726f 7567 6820 636f  oping through co
+00011d70: 6c6f 7220 6368 616e 6e65 6c73 2072 6564  lor channels red
+00011d80: 7563 6573 206d 656d 6f72 7920 636f 6e73  uces memory cons
+00011d90: 756d 7074 696f 6e0d 0a20 2020 2020 2020  umption..       
+00011da0: 2020 2020 2023 2020 2020 2073 7263 5b69       #     src[i
+00011db0: 6478 5b31 5d2e 7261 7665 6c28 292c 2069  dx[1].ravel(), i
+00011dc0: 6478 5b30 5d2e 7261 7665 6c28 292c 2063  dx[0].ravel(), c
+00011dd0: 5d20 2b3d 2042 5b2e 2e2e 2c20 635d 2e72  ] += B[..., c].r
+00011de0: 6176 656c 2829 2020 2320 7261 7665 6c28  avel()  # ravel(
+00011df0: 2920 7265 7475 726e 7320 6120 7669 6577  ) returns a view
+00011e00: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00011e10: 746f 646f 3a20 6164 7661 6e63 6564 2069  todo: advanced i
+00011e20: 6e64 6578 696e 6720 7769 7468 206e 616e  ndexing with nan
+00011e30: 3f0d 0a20 2020 2020 2020 2020 2020 2042  ?..            B
+00011e40: 5b7e 7661 6c69 645d 203d 2030 0d0a 2020  [~valid] = 0..  
+00011e50: 2020 2020 2020 2020 2020 7372 6320 3d20            src = 
+00011e60: 5f72 656d 6170 2873 7263 2c20 7869 2c20  _remap(src, xi, 
+00011e70: 4229 2020 2320 746f 646f 3a20 6966 2075  B)  # todo: if u
+00011e80: 2069 7320 6172 7261 7920 2d3e 2061 6c73   is array -> als
+00011e90: 6f20 696e 6372 656d 656e 7420 7265 6769  o increment regi
+00011ea0: 6f6e 2061 726f 756e 6420 7269 6e74 2070  on around rint p
+00011eb0: 6978 656c 0d0a 0d0a 2020 2020 2020 2020  ixel....        
+00011ec0: 2020 2020 2320 626c 7572 7269 6e67 2064      # blurring d
+00011ed0: 7565 2074 6f20 756e 6365 7274 6169 6e74  ue to uncertaint
+00011ee0: 7920 616e 6420 5053 460d 0a20 2020 2020  y and PSF..     
+00011ef0: 2020 2020 2020 2075 203d 2073 656c 662e         u = self.
+00011f00: 7520 6966 2073 656c 662e 696e 6465 7869  u if self.indexi
+00011f10: 6e67 203d 3d20 2269 6a22 2065 6c73 6520  ng == "ij" else 
+00011f20: 7365 6c66 2e75 5b3a 3a2d 315d 2020 2320  self.u[::-1]  # 
+00011f30: 746f 646f 3a20 4420 3d20 312c 2069 2e65  todo: D = 1, i.e
+00011f40: 2e20 7368 6170 6520 6f66 2073 6967 6d61  . shape of sigma
+00011f50: 2065 7175 616c 2074 6f20 6178 6573 3f0d   equal to axes?.
+00011f60: 0a20 2020 2020 2020 2020 2020 2073 6967  .            sig
+00011f70: 6d61 203d 206e 702e 7371 7274 2875 2a2a  ma = np.sqrt(u**
+00011f80: 3220 2b20 7365 6c66 2e50 5346 2a2a 3229  2 + self.PSF**2)
+00011f90: 0d0a 2020 2020 2020 2020 2020 2020 7372  ..            sr
+00011fa0: 6320 3d20 7370 2e6e 6469 6d61 6765 2e67  c = sp.ndimage.g
+00011fb0: 6175 7373 6961 6e5f 6669 6c74 6572 2873  aussian_filter(s
+00011fc0: 7263 2c20 7369 676d 612c 206d 6f64 653d  rc, sigma, mode=
+00011fd0: 226e 6561 7265 7374 222c 2061 7865 733d  "nearest", axes=
+00011fe0: 2830 2c20 3129 290d 0a0d 0a20 2020 2020  (0, 1))....     
+00011ff0: 2020 2020 2020 2023 2062 6c75 7272 696e         # blurrin
+00012000: 6720 6475 6520 746f 2070 6978 656c 2073  g due to pixel s
+00012010: 697a 650d 0a20 2020 2020 2020 2020 2020  ize..           
+00012020: 2064 7820 3d20 330d 0a20 2020 2020 2020   dx = 3..       
+00012030: 2020 2020 2064 785f 203d 2069 6e74 2864       dx_ = int(d
+00012040: 7820 2b20 302e 3529 0d0a 2020 2020 2020  x + 0.5)..      
+00012050: 2020 2020 2020 6966 2064 7820 3e20 313a        if dx > 1:
+00012060: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00012070: 2020 7372 6320 3d20 7370 2e6e 6469 6d61    src = sp.ndima
+00012080: 6765 2e75 6e69 666f 726d 5f66 696c 7465  ge.uniform_filte
+00012090: 7228 7372 632c 2073 697a 653d 6478 5f2c  r(src, size=dx_,
+000120a0: 206d 6f64 653d 2272 6566 6c65 6374 222c   mode="reflect",
+000120b0: 2061 7865 733d 2830 2c20 3129 290d 0a20   axes=(0, 1)).. 
+000120c0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+000120d0: 2020 2020 2020 2020 2020 7869 203d 2078            xi = x
+000120e0: 695b 3a2c 2076 616c 6964 5d2e 7265 7368  i[:, valid].resh
+000120f0: 6170 6528 322c 202d 312c 2043 292e 7377  ape(2, -1, C).sw
+00012100: 6170 6178 6573 2830 2c20 3129 2020 2320  apaxes(0, 1)  # 
+00012110: 6e20 6461 7461 2070 6f69 6e74 7320 6f66  n data points of
+00012120: 2064 696d 656e 7369 6f6e 206d 0d0a 2020   dimension m..  
+00012130: 2020 2020 2020 2020 2020 6966 2042 2069            if B i
+00012140: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
+00012150: 2020 2020 2020 2020 2020 2020 2042 203d               B =
+00012160: 2042 5b76 616c 6964 5d2e 7265 7368 6170   B[valid].reshap
+00012170: 6528 2d31 2c20 4329 2020 2320 6e20 6461  e(-1, C)  # n da
+00012180: 7461 2070 6f69 6e74 7320 6f66 2064 696d  ta points of dim
+00012190: 656e 7369 6f6e 206d 0d0a 0d0a 2020 2020  ension m....    
+000121a0: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
+000121b0: 7573 6520 5520 6966 2067 6976 656e 2061  use U if given a
+000121c0: 7320 616e 2061 7272 6179 2028 6275 7420  s an array (but 
+000121d0: 686f 773f 290d 0a0d 0a20 2020 2020 2020  how?)....       
+000121e0: 2020 2020 2075 203d 206e 702e 7072 6f64       u = np.prod
+000121f0: 2873 656c 662e 752c 2061 7869 733d 3029  (self.u, axis=0)
+00012200: 202a 2a20 280d 0a20 2020 2020 2020 2020   ** (..         
+00012210: 2020 2020 2020 2031 202f 2073 656c 662e         1 / self.
+00012220: 440d 0a20 2020 2020 2020 2020 2020 2029  D..            )
+00012230: 2020 2320 6765 6f6d 6574 7269 6320 6d65    # geometric me
+00012240: 616e 2061 7665 7261 6765 7320 7468 6520  an averages the 
+00012250: 7365 6d69 2d61 7865 7320 6f66 2074 6865  semi-axes of the
+00012260: 2075 6e63 6572 7461 696e 7479 2065 6c6c   uncertainty ell
+00012270: 6970 7365 730d 0a20 2020 2020 2020 2020  ipses..         
+00012280: 2020 2073 6967 6d61 203d 206e 702e 7371     sigma = np.sq
+00012290: 7274 2875 2a2a 3220 2b20 7365 6c66 2e50  rt(u**2 + self.P
+000122a0: 5346 2a2a 3229 0d0a 2020 2020 2020 2020  SF**2)..        
+000122b0: 2020 2020 6472 203d 2064 7820 2f20 6e70      dr = dx / np
+000122c0: 2e73 7172 7428 6e70 2e70 6929 2020 2320  .sqrt(np.pi)  # 
+000122d0: 6d61 7070 696e 6720 7261 6469 7573 206f  mapping radius o
+000122e0: 6620 7371 6172 6520 283d 6478 2f32 2920  f sqare (=dx/2) 
+000122f0: 746f 2072 6164 6975 7320 6f66 2063 6972  to radius of cir
+00012300: 636c 6520 2864 7229 2077 6974 6820 7361  cle (dr) with sa
+00012310: 6d65 2061 7265 610d 0a20 2020 2020 2020  me area..       
+00012320: 2020 2020 2061 203d 2033 2020 2320 6e75       a = 3  # nu
+00012330: 6d62 6572 206f 6620 7374 616e 6461 7264  mber of standard
+00012340: 2064 6576 6961 7469 6f6e 730d 0a20 2020   deviations..   
+00012350: 2020 2020 2020 2020 2052 203d 2064 7220           R = dr 
+00012360: 2b20 6120 2a20 7369 676d 610d 0a0d 0a20  + a * sigma.... 
+00012370: 2020 2020 2020 2020 2020 2073 7263 203d             src =
+00012380: 206e 702e 656d 7074 7928 2873 656c 662e   np.empty((self.
+00012390: 592c 2073 656c 662e 582c 2043 292c 206e  Y, self.X, C), n
+000123a0: 702e 666c 6f61 7433 3229 0d0a 2020 2020  p.float32)..    
+000123b0: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
+000123c0: 2072 616e 6765 2843 293a 0d0a 2020 2020   range(C):..    
+000123d0: 2020 2020 2020 2020 2020 2020 6b64 7472              kdtr
+000123e0: 6565 203d 2073 702e 7370 6174 6961 6c2e  ee = sp.spatial.
+000123f0: 4b44 5472 6565 2878 695b 3a2c 203a 2c20  KDTree(xi[:, :, 
+00012400: 635d 290d 0a20 2020 2020 2020 2020 2020  c])..           
+00012410: 2020 2020 2066 6f72 2078 7320 696e 2072       for xs in r
+00012420: 616e 6765 2873 656c 662e 5829 3a0d 0a20  ange(self.X):.. 
+00012430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012440: 2020 2066 6f72 2079 7320 696e 2072 616e     for ys in ran
+00012450: 6765 2873 656c 662e 5929 3a0d 0a20 2020  ge(self.Y):..   
+00012460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012470: 2020 2020 2069 203d 206b 6474 7265 652e       i = kdtree.
+00012480: 7175 6572 795f 6261 6c6c 5f70 6f69 6e74  query_ball_point
+00012490: 2878 3d28 7873 2c20 7973 292c 2072 3d52  (x=(xs, ys), r=R
+000124a0: 2c20 703d 3229 2020 2320 2c20 776f 726b  , p=2)  # , work
+000124b0: 6572 733d 2d31 2920 2023 206c 6973 7420  ers=-1)  # list 
+000124c0: 6f66 2069 6e64 6963 6573 0d0a 0d0a 2020  of indices....  
+000124d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124e0: 2020 2020 2020 6966 206e 6f74 2069 3a20        if not i: 
+000124f0: 2023 2065 6d70 7479 206c 6973 742c 2069   # empty list, i
+00012500: 2e65 2e20 6e6f 2070 6f69 6e74 7320 666f  .e. no points fo
+00012510: 756e 6420 7769 7468 696e 2064 6973 7461  und within dista
+00012520: 6e63 6520 520d 0a20 2020 2020 2020 2020  nce R..         
+00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012540: 2020 2076 203d 2030 0d0a 2020 2020 2020     v = 0..      
+00012550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012560: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012580: 2020 2020 2078 7220 3d20 7869 5b69 2c20       xr = xi[i, 
+00012590: 302c 2063 5d20 2023 2072 6574 7572 6e73  0, c]  # returns
+000125a0: 2061 2076 6965 770d 0a20 2020 2020 2020   a view..       
+000125b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125c0: 2020 2020 2079 7220 3d20 7869 5b69 2c20       yr = xi[i, 
+000125d0: 312c 2063 5d20 2023 2072 6574 7572 6e73  1, c]  # returns
+000125e0: 2061 2076 6965 770d 0a20 2020 2020 2020   a view..       
+000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012600: 2020 2020 2064 203d 206e 702e 7371 7274       d = np.sqrt
+00012610: 2828 7873 202d 2078 7229 202a 2a20 3220  ((xs - xr) ** 2 
+00012620: 2b20 2879 7320 2d20 7972 2920 2a2a 2032  + (ys - yr) ** 2
+00012630: 2920 2023 2064 6973 7461 6e63 650d 0a0d  )  # distance...
+00012640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012650: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+00012660: 6e76 6572 7365 2064 6973 7461 6e63 6520  nverse distance 
+00012670: 7765 6967 6874 696e 6720 7573 696e 6720  weighting using 
+00012680: 6d6f 6469 6669 6564 2053 6865 7061 7264  modified Shepard
+00012690: 2773 206d 6574 686f 643a 0d0a 2020 2020  's method:..    
+000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126b0: 2020 2020 2020 2020 2320 6874 7470 733a          # https:
+000126c0: 2f2f 656e 2e77 696b 6970 6564 6961 2e6f  //en.wikipedia.o
+000126d0: 7267 2f77 696b 692f 496e 7665 7273 655f  rg/wiki/Inverse_
+000126e0: 6469 7374 616e 6365 5f77 6569 6768 7469  distance_weighti
+000126f0: 6e67 0d0a 2020 2020 2020 2020 2020 2020  ng..            
+00012700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012710: 7720 3d20 3120 2f20 2864 2a2a 3229 0d0a  w = 1 / (d**2)..
+00012720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012730: 2020 2020 2020 2020 2020 2020 775b 6420              w[d 
+00012740: 3d3d 2030 5d20 3d20 310d 0a20 2020 2020  == 0] = 1..     
+00012750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012760: 2020 2020 2020 2023 2077 5b64 203e 2052         # w[d > R
+00012770: 5d20 3d20 300d 0a20 2020 2020 2020 2020  ] = 0..         
+00012780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012790: 2020 2077 202f 3d20 6e70 2e73 756d 2877     w /= np.sum(w
+000127a0: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
+000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127c0: 2023 2074 6f64 6f3a 2075 7365 2050 5346   # todo: use PSF
+000127d0: 2061 7320 7765 6967 6874 730d 0a20 2020   as weights..   
+000127e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127f0: 2020 2020 2020 2020 2023 2073 756d 202f           # sum /
+00012800: 2061 7667 202f 206d 6178 206f 6620 7661   avg / max of va
+00012810: 6c73 2077 6974 6869 6e20 520d 0a0d 0a20  ls within R.... 
+00012820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012830: 2020 2020 2020 2020 2020 2069 6620 4220             if B 
+00012840: 6973 206e 6f74 204e 6f6e 653a 0d0a 2020  is not None:..  
+00012850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012860: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00012870: 7620 3d20 6e70 2e73 756d 2842 5b69 2c20  v = np.sum(B[i, 
+00012880: 635d 202a 2077 290d 0a20 2020 2020 2020  c] * w)..       
+00012890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128a0: 2020 2020 2020 2020 2076 203d 206e 702e           v = np.
+000128b0: 646f 7428 425b 692c 2063 5d2c 2077 290d  dot(B[i, c], w).
+000128c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000128d0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000128e0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+000128f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012900: 2020 2020 7620 3d20 6e70 2e73 756d 2877      v = np.sum(w
+00012910: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
+00012920: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00012930: 5b79 732c 2078 732c 2063 5d20 3d20 760d  [ys, xs, c] = v.
+00012940: 0a0d 0a20 2020 2020 2020 206d 7820 3d20  ...        mx = 
+00012950: 7372 632e 6d61 7828 290d 0a20 2020 2020  src.max()..     
+00012960: 2020 2069 6620 6d78 203e 2030 2061 6e64     if mx > 0 and
+00012970: 206d 7820 213d 2031 3a0d 0a20 2020 2020   mx != 1:..     
+00012980: 2020 2020 2020 2073 7263 202f 3d20 6d78         src /= mx
+00012990: 0d0a 0d0a 2020 2020 2020 2020 6c6f 6767  ....        logg
+000129a0: 696e 672e 696e 666f 2866 227b 3130 3030  ing.info(f"{1000
+000129b0: 202a 2028 7469 6d65 2e70 6572 665f 636f   * (time.perf_co
+000129c0: 756e 7465 7228 2920 2d20 7430 297d 6d73  unter() - t0)}ms
+000129d0: 2229 0d0a 0d0a 2020 2020 2020 2020 7265  ")....        re
+000129e0: 7475 726e 2073 7263 0d0a 0d0a 2020 2020  turn src....    
+000129f0: 6465 6620 6272 6967 6874 6669 656c 645f  def brightfield_
+00012a00: 696e 7665 7273 6528 7365 6c66 2c20 7372  inverse(self, sr
+00012a10: 633a 206e 702e 6e64 6172 7261 792c 2074  c: np.ndarray, t
+00012a20: 3a20 666c 6f61 7420 3d20 302e 312c 206b  : float = 0.1, k
+00012a30: 3a20 696e 7420 3d20 3329 202d 3e20 6e70  : int = 3) -> np
+00012a40: 2e6e 6461 7272 6179 3a0d 0a20 2020 2020  .ndarray:..     
+00012a50: 2020 2022 2222 496e 7665 7273 6520 6272     """Inverse br
+00012a60: 6967 6874 2d66 6965 6c64 0d0a 0d0a 2020  ight-field....  
+00012a70: 2020 2020 2020 7769 7468 2072 6164 696f        with radio
+00012a80: 6d61 7472 6963 2063 6f6d 7065 6e73 6174  matric compensat
+00012a90: 696f 6e0d 0a20 2020 2020 2020 2061 7373  ion..        ass
+00012aa0: 756d 696e 6720 6120 6c69 6e65 6172 2072  uming a linear r
+00012ab0: 6573 706f 6e73 6520 6675 6e63 7469 6f6e  esponse function
+00012ac0: 2066 6f72 2064 6973 706c 6179 2f70 726f   for display/pro
+00012ad0: 6a65 6374 6f72 2061 6e64 2063 616d 6572  jector and camer
+00012ae0: 612e 0d0a 0d0a 2020 2020 2020 2020 5061  a.....        Pa
+00012af0: 7261 6d65 7465 7273 0d0a 2020 2020 2020  rameters..      
+00012b00: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020    ----------..  
+00012b10: 2020 2020 2020 7372 6320 3a20 6e70 2e6e        src : np.n
+00012b20: 6461 7272 6179 0d0a 2020 2020 2020 2020  darray..        
+00012b30: 2020 2020 536f 7572 6365 2061 6374 6976      Source activ
+00012b40: 6174 696f 6e20 6865 6174 6d61 702e 0d0a  ation heatmap...
+00012b50: 0d0a 2020 2020 2020 2020 7420 3a20 666c  ..        t : fl
+00012b60: 6f61 740d 0a20 2020 2020 2020 2020 2020  oat..           
+00012b70: 2054 6872 6573 686f 6c64 2077 6974 6869   Threshold withi
+00012b80: 6e20 5b30 2c20 315d 2e0d 0a0d 0a20 2020  n [0, 1].....   
+00012b90: 2020 2020 206b 203a 2069 6e74 0d0a 2020       k : int..  
+00012ba0: 2020 2020 2020 2020 2020 4564 6765 2065            Edge e
+00012bb0: 6e67 7468 206f 6620 6d6f 7270 686f 6c6f  ngth of morpholo
+00012bc0: 6769 6361 6c20 6f70 6572 6174 6f72 2e0d  gical operator..
+00012bd0: 0a0d 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00012be0: 6e73 0d0a 2020 2020 2020 2020 2d2d 2d2d  ns..        ----
+00012bf0: 2d2d 2d0d 0a20 2020 2020 2020 2062 6669  ---..        bfi
+00012c00: 203a 2049 6e76 6572 7365 2062 7269 6768   : Inverse brigh
+00012c10: 742d 6669 656c 642e 0d0a 2020 2020 2020  t-field...      
+00012c20: 2020 2222 220d 0a0d 0a20 2020 2020 2020    """....       
+00012c30: 2074 203d 206e 702e 636c 6970 2874 2c20   t = np.clip(t, 
+00012c40: 302c 2031 290d 0a20 2020 2020 2020 2074  0, 1)..        t
+00012c50: 203d 2030 2e32 0d0a 2020 2020 2020 2020   = 0.2..        
+00012c60: 7372 635b 7372 6320 3c20 745d 203d 206e  src[src < t] = n
+00012c70: 702e 6e61 6e20 2023 2030 0d0a 0d0a 2020  p.nan  # 0....  
+00012c80: 2020 2020 2020 2320 7261 6469 6f6d 6574        # radiomet
+00012c90: 7269 6320 636f 6d70 656e 7361 7469 6f6e  ric compensation
+00012ca0: 0d0a 2020 2020 2020 2020 6266 6920 3d20  ..        bfi = 
+00012cb0: 3120 2f20 7372 6320 2023 2020 2d20 310d  1 / src  #  - 1.
+00012cc0: 0a20 2020 2020 2020 2062 6669 202f 3d20  .        bfi /= 
+00012cd0: 6e70 2e6e 616e 6d61 7828 6266 6929 0d0a  np.nanmax(bfi)..
+00012ce0: 2020 2020 2020 2020 6266 6920 2a3d 2073          bfi *= s
+00012cf0: 656c 662e 496d 6178 0d0a 2020 2020 2020  elf.Imax..      
+00012d00: 2020 6266 695b 6266 6920 3d3d 206e 702e    bfi[bfi == np.
+00012d10: 6e61 6e5d 203d 2030 0d0a 2020 2020 2020  nan] = 0..      
+00012d20: 2020 6266 6920 3d20 6266 692e 6173 7479    bfi = bfi.asty
+00012d30: 7065 2873 656c 662e 6474 7970 652c 2063  pe(self.dtype, c
+00012d40: 6f70 793d 4661 6c73 6529 0d0a 0d0a 2020  opy=False)....  
+00012d50: 2020 2020 2020 2320 626c 7572 7269 6e67        # blurring
+00012d60: 2064 7565 2074 6f20 756e 6365 7274 6169   due to uncertai
+00012d70: 6e74 7920 616e 6420 5053 460d 0a20 2020  nty and PSF..   
+00012d80: 2020 2020 2023 2075 203d 2073 656c 662e       # u = self.
+00012d90: 7520 6966 2073 656c 662e 696e 6465 7869  u if self.indexi
+00012da0: 6e67 203d 3d20 2269 6a22 2065 6c73 6520  ng == "ij" else 
+00012db0: 7365 6c66 2e75 5b3a 3a2d 315d 2020 2320  self.u[::-1]  # 
+00012dc0: 746f 646f 3a20 4420 3d20 312c 2069 2e65  todo: D = 1, i.e
+00012dd0: 2e20 7368 6170 6520 6f66 2073 6967 6d61  . shape of sigma
+00012de0: 2065 7175 616c 2074 6f20 6178 6573 3f0d   equal to axes?.
+00012df0: 0a20 2020 2020 2020 2023 2073 6967 6d61  .        # sigma
+00012e00: 203d 206e 702e 7371 7274 2875 202a 2a20   = np.sqrt(u ** 
+00012e10: 3220 2b20 7365 6c66 2e50 5346 202a 2a20  2 + self.PSF ** 
+00012e20: 3229 0d0a 2020 2020 2020 2020 2320 6120  2)..        # a 
+00012e30: 3d20 330d 0a20 2020 2020 2020 2023 206b  = 3..        # k
+00012e40: 203d 2031 202b 2064 7820 2b20 3220 2a20   = 1 + dx + 2 * 
+00012e50: 6120 2a20 7369 676d 6120 2023 2032 3a20  a * sigma  # 2: 
+00012e60: 626f 7468 2073 6964 6573 0d0a 2020 2020  both sides..    
+00012e70: 2020 2020 2320 6b20 3d20 6e70 2e63 6569      # k = np.cei
+00012e80: 6c28 6b29 2e61 7374 7970 6528 696e 7429  l(k).astype(int)
+00012e90: 0d0a 2020 2020 2020 2020 6b65 726e 656c  ..        kernel
+00012ea0: 203d 2063 7632 2e67 6574 5374 7275 6374   = cv2.getStruct
+00012eb0: 7572 696e 6745 6c65 6d65 6e74 2863 7632  uringElement(cv2
+00012ec0: 2e4d 4f52 5048 5f45 4c4c 4950 5345 2c20  .MORPH_ELLIPSE, 
+00012ed0: 286b 2c20 6b29 290d 0a20 2020 2020 2020  (k, k))..       
+00012ee0: 2054 2c20 592c 2058 2c20 4320 3d20 7673   T, Y, X, C = vs
+00012ef0: 6861 7065 2862 6669 292e 7368 6170 650d  hape(bfi).shape.
+00012f00: 0a20 2020 2020 2020 2066 6f72 2074 2069  .        for t i
+00012f10: 6e20 7261 6e67 6528 5429 3a0d 0a20 2020  n range(T):..   
+00012f20: 2020 2020 2020 2020 2066 6f72 2063 2069           for c i
+00012f30: 6e20 7261 6e67 6528 4329 3a0d 0a20 2020  n range(C):..   
+00012f40: 2020 2020 2020 2020 2020 2020 2062 6669               bfi
+00012f50: 5b74 2c20 3a2c 203a 2c20 635d 203d 2063  [t, :, :, c] = c
+00012f60: 7632 2e64 696c 6174 6528 6266 695b 742c  v2.dilate(bfi[t,
+00012f70: 203a 2c20 3a2c 2063 5d2c 206b 6572 6e65   :, :, c], kerne
+00012f80: 6c29 0d0a 0d0a 2020 2020 2020 2020 7265  l)....        re
+00012f90: 7475 726e 2062 6669 2020 2320 746f 646f  turn bfi  # todo
+00012fa0: 3a20 6272 6967 6874 6669 656c 645f 696e  : brightfield_in
+00012fb0: 7665 7273 650d 0a0d 0a20 2020 2064 6566  verse....    def
+00012fc0: 2062 7269 6768 7466 6965 6c64 2873 656c   brightfield(sel
+00012fd0: 662c 2073 7263 3a20 6e70 2e6e 6461 7272  f, src: np.ndarr
+00012fe0: 6179 2c20 743a 2066 6c6f 6174 203d 2030  ay, t: float = 0
+00012ff0: 2e31 2c20 6b3a 2069 6e74 203d 2033 2920  .1, k: int = 3) 
+00013000: 2d3e 206e 702e 6e64 6172 7261 793a 0d0a  -> np.ndarray:..
+00013010: 2020 2020 2020 2020 2222 2242 7269 6768          """Brigh
+00013020: 742d 6669 656c 642e 0d0a 0d0a 2020 2020  t-field.....    
+00013030: 2020 2020 5061 7261 6d65 7465 7273 0d0a      Parameters..
+00013040: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00013050: 2d2d 0d0a 2020 2020 2020 2020 7372 6320  --..        src 
+00013060: 3a20 6e70 2e6e 6461 7272 6179 0d0a 2020  : np.ndarray..  
+00013070: 2020 2020 2020 2020 2020 536f 7572 6365            Source
+00013080: 2061 6374 6976 6174 696f 6e20 6865 6174   activation heat
+00013090: 6d61 702e 0d0a 0d0a 2020 2020 2020 2020  map.....        
+000130a0: 7420 3a20 666c 6f61 740d 0a20 2020 2020  t : float..     
+000130b0: 2020 2020 2020 2054 6872 6573 686f 6c64         Threshold
+000130c0: 2077 6974 6869 6e20 5b30 2c20 315d 2e0d   within [0, 1]..
+000130d0: 0a0d 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+000130e0: 6e73 0d0a 2020 2020 2020 2020 2d2d 2d2d  ns..        ----
+000130f0: 2d2d 2d0d 0a20 2020 2020 2020 2062 6620  ---..        bf 
+00013100: 3a20 4272 6967 6874 2d66 6965 6c64 2e0d  : Bright-field..
+00013110: 0a20 2020 2020 2020 2022 2222 0d0a 0d0a  .        """....
+00013120: 2020 2020 2020 2020 7420 3d20 6e70 2e63          t = np.c
+00013130: 6c69 7028 742c 2030 2c20 3129 0d0a 2020  lip(t, 0, 1)..  
+00013140: 2020 2020 2020 6266 203d 2028 7372 6320        bf = (src 
+00013150: 3e20 7429 2e61 7374 7970 6528 7365 6c66  > t).astype(self
+00013160: 2e64 7479 7065 2c20 636f 7079 3d46 616c  .dtype, copy=Fal
+00013170: 7365 2920 2a20 7365 6c66 2e49 6d61 780d  se) * self.Imax.
+00013180: 0a0d 0a20 2020 2020 2020 2069 6620 6b3a  ...        if k:
+00013190: 0d0a 2020 2020 2020 2020 2020 2020 6b65  ..            ke
+000131a0: 726e 656c 203d 2063 7632 2e67 6574 5374  rnel = cv2.getSt
+000131b0: 7275 6374 7572 696e 6745 6c65 6d65 6e74  ructuringElement
+000131c0: 2863 7632 2e4d 4f52 5048 5f45 4c4c 4950  (cv2.MORPH_ELLIP
+000131d0: 5345 2c20 286b 2c20 6b29 290d 0a0d 0a20  SE, (k, k)).... 
+000131e0: 2020 2020 2020 2020 2020 2054 2c20 592c             T, Y,
+000131f0: 2058 2c20 4320 3d20 7673 6861 7065 2862   X, C = vshape(b
+00013200: 6629 2e73 6861 7065 0d0a 2020 2020 2020  f).shape..      
+00013210: 2020 2020 2020 666f 7220 7420 696e 2072        for t in r
+00013220: 616e 6765 2854 293a 0d0a 2020 2020 2020  ange(T):..      
+00013230: 2020 2020 2020 2020 2020 666f 7220 6320            for c 
+00013240: 696e 2072 616e 6765 2843 293a 0d0a 2020  in range(C):..  
+00013250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013260: 2020 6266 5b74 2c20 3a2c 203a 2c20 635d    bf[t, :, :, c]
+00013270: 203d 2063 7632 2e64 696c 6174 6528 6266   = cv2.dilate(bf
+00013280: 5b74 2c20 3a2c 203a 2c20 635d 2c20 6b65  [t, :, :, c], ke
+00013290: 726e 656c 290d 0a0d 0a20 2020 2020 2020  rnel)....       
+000132a0: 2072 6574 7572 6e20 6266 0d0a 0d0a 2020   return bf....  
+000132b0: 2020 6465 6620 6461 726b 6669 656c 6428    def darkfield(
+000132c0: 7365 6c66 2c20 7372 633a 206e 702e 6e64  self, src: np.nd
+000132d0: 6172 7261 792c 2074 3a20 666c 6f61 7420  array, t: float 
+000132e0: 3d20 302e 312c 206b 3a20 696e 7420 3d20  = 0.1, k: int = 
+000132f0: 3329 202d 3e20 6e70 2e6e 6461 7272 6179  3) -> np.ndarray
+00013300: 3a0d 0a20 2020 2020 2020 2022 2222 4461  :..        """Da
+00013310: 726b 2d66 6965 6c64 2e0d 0a0d 0a20 2020  rk-field.....   
+00013320: 2020 2020 2050 6172 616d 6574 6572 730d       Parameters.
+00013330: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00013340: 2d2d 2d0d 0a20 2020 2020 2020 2073 7263  ---..        src
+00013350: 203a 206e 702e 6e64 6172 7261 790d 0a20   : np.ndarray.. 
+00013360: 2020 2020 2020 2020 2020 2053 6f75 7263             Sourc
+00013370: 6520 6163 7469 7661 7469 6f6e 2068 6561  e activation hea
+00013380: 746d 6170 2e0d 0a0d 0a20 2020 2020 2020  tmap.....       
+00013390: 2074 203a 2066 6c6f 6174 0d0a 2020 2020   t : float..    
+000133a0: 2020 2020 2020 2020 5468 7265 7368 6f6c          Threshol
+000133b0: 6420 7769 7468 696e 205b 302c 2031 5d2e  d within [0, 1].
+000133c0: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
+000133d0: 726e 730d 0a20 2020 2020 2020 202d 2d2d  rns..        ---
+000133e0: 2d2d 2d2d 0d0a 2020 2020 2020 2020 6466  ----..        df
+000133f0: 203a 2044 6172 6b2d 6669 656c 642e 0d0a   : Dark-field...
+00013400: 2020 2020 2020 2020 2222 220d 0a0d 0a20          """.... 
+00013410: 2020 2020 2020 2074 203d 206e 702e 636c         t = np.cl
+00013420: 6970 2874 2c20 302c 2031 290d 0a20 2020  ip(t, 0, 1)..   
+00013430: 2020 2020 2064 6620 3d20 2873 7263 203c       df = (src <
+00013440: 3d20 7429 2e61 7374 7970 6528 7365 6c66  = t).astype(self
+00013450: 2e64 7479 7065 2c20 636f 7079 3d46 616c  .dtype, copy=Fal
+00013460: 7365 2920 2a20 7365 6c66 2e49 6d61 780d  se) * self.Imax.
+00013470: 0a0d 0a20 2020 2020 2020 2069 6620 6b3a  ...        if k:
+00013480: 0d0a 2020 2020 2020 2020 2020 2020 6b65  ..            ke
+00013490: 726e 656c 203d 2063 7632 2e67 6574 5374  rnel = cv2.getSt
+000134a0: 7275 6374 7572 696e 6745 6c65 6d65 6e74  ructuringElement
+000134b0: 2863 7632 2e4d 4f52 5048 5f45 4c4c 4950  (cv2.MORPH_ELLIP
+000134c0: 5345 2c20 286b 2c20 6b29 290d 0a0d 0a20  SE, (k, k)).... 
+000134d0: 2020 2020 2020 2020 2020 2054 2c20 592c             T, Y,
+000134e0: 2058 2c20 4320 3d20 7673 6861 7065 2864   X, C = vshape(d
+000134f0: 6629 2e73 6861 7065 0d0a 2020 2020 2020  f).shape..      
+00013500: 2020 2020 2020 666f 7220 7420 696e 2072        for t in r
+00013510: 616e 6765 2854 293a 0d0a 2020 2020 2020  ange(T):..      
+00013520: 2020 2020 2020 2020 2020 666f 7220 6320            for c 
+00013530: 696e 2072 616e 6765 2843 293a 0d0a 2020  in range(C):..  
+00013540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013550: 2020 6466 5b74 2c20 3a2c 203a 2c20 635d    df[t, :, :, c]
+00013560: 203d 2063 7632 2e64 696c 6174 6528 6466   = cv2.dilate(df
+00013570: 5b74 2c20 3a2c 203a 2c20 635d 2c20 6b65  [t, :, :, c], ke
+00013580: 726e 656c 290d 0a0d 0a20 2020 2020 2020  rnel)....       
+00013590: 2072 6574 7572 6e20 6466 0d0a 0d0a 2020   return df....  
+000135a0: 2020 6465 6620 5f73 696d 756c 6174 6528    def _simulate(
+000135b0: 0d0a 2020 2020 2020 2020 7365 6c66 2c0d  ..        self,.
+000135c0: 0a20 2020 2020 2020 2049 3a20 6e70 2e6e  .        I: np.n
+000135d0: 6461 7272 6179 2c0d 0a20 2020 2020 2020  darray,..       
+000135e0: 2050 5346 3a20 666c 6f61 7420 3d20 352c   PSF: float = 5,
+000135f0: 0d0a 2020 2020 2020 2020 7379 7374 656d  ..        system
+00013600: 5f67 6169 6e3a 2066 6c6f 6174 203d 2030  _gain: float = 0
+00013610: 2e30 3338 2c0d 0a20 2020 2020 2020 2064  .038,..        d
+00013620: 6172 6b5f 6375 7272 656e 743a 2066 6c6f  ark_current: flo
+00013630: 6174 203d 2033 2e36 3420 2f20 302e 3033  at = 3.64 / 0.03
+00013640: 382c 2020 2320 5b65 6c65 6374 726f 6e73  8,  # [electrons
+00013650: 5d20 2023 2073 6f6d 6520 6361 6d65 7261  ]  # some camera
+00013660: 7320 6665 6174 7572 6520 6120 6461 726b  s feature a dark
+00013670: 2063 7572 7265 6e74 2063 6f6d 7065 6e73   current compens
+00013680: 6174 696f 6e0d 0a20 2020 2020 2020 2064  ation..        d
+00013690: 6172 6b5f 6e6f 6973 653a 2066 6c6f 6174  ark_noise: float
+000136a0: 203d 2031 332e 372c 2020 2320 5b65 6c65   = 13.7,  # [ele
+000136b0: 6374 726f 6e73 5d0d 0a20 2020 2020 2020  ctrons]..       
+000136c0: 2073 6565 643a 2069 6e74 203d 2032 3638   seed: int = 268
+000136d0: 3636 3434 3334 3433 3135 3831 3531 3339  6644344315815139
+000136e0: 3236 3332 3731 3633 3936 3036 3930 3133  2632716396069013
+000136f0: 3837 3139 2c20 2023 2073 6563 7265 7473  8719,  # secrets
+00013700: 2e72 616e 6462 6974 7328 3132 3829 0d0a  .randbits(128)..
+00013710: 2020 2020 2920 2d3e 206e 702e 6e64 6172      ) -> np.ndar
+00013720: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
+00013730: 2253 696d 756c 6174 6520 7468 6520 6163  "Simulate the ac
+00013740: 7175 6973 6974 696f 6e2c 2069 2e65 2e20  quisition, i.e. 
+00013750: 7468 6520 7472 616e 736d 6973 7369 6f6e  the transmission
+00013760: 2063 6861 6e6e 656c 2e0d 0a0d 0a20 2020   channel.....   
+00013770: 2020 2020 2054 6869 7320 696e 636c 7564       This includ
+00013780: 6573 2074 6865 206d 6f64 756c 6174 696f  es the modulatio
+00013790: 6e20 7472 616e 7366 6572 2066 756e 6374  n transfer funct
+000137a0: 696f 6e20 2863 6f6d 7075 7465 6420 6672  ion (computed fr
+000137b0: 6f6d 2074 6865 2069 6d61 6769 6e67 2073  om the imaging s
+000137c0: 7973 7465 6d27 7320 706f 696e 7420 7370  ystem's point sp
+000137d0: 7265 6164 2066 756e 6374 696f 6e29 0d0a  read function)..
+000137e0: 2020 2020 2020 2020 616e 6420 696e 7465          and inte
+000137f0: 6e73 6974 7920 6e6f 6973 6520 6164 6465  nsity noise adde
+00013800: 6420 6279 2074 6865 2063 616d 6572 612e  d by the camera.
+00013810: 0d0a 0d0a 2020 2020 2020 2020 5061 7261  ....        Para
+00013820: 6d65 7465 7273 0d0a 2020 2020 2020 2020  meters..        
+00013830: 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020  ----------..    
+00013840: 2020 2020 4920 3a20 6e70 2e6e 6461 7272      I : np.ndarr
+00013850: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
+00013860: 4672 696e 6765 2070 6174 7465 726e 2073  Fringe pattern s
+00013870: 6571 7565 6e63 652e 0d0a 0d0a 2020 2020  equence.....    
+00013880: 2020 2020 5053 4620 3a20 666c 6f61 742c      PSF : float,
+00013890: 206f 7074 696f 6e61 6c0d 0a20 2020 2020   optional..     
+000138a0: 2020 2020 2020 2053 7461 6e64 6172 6420         Standard 
+000138b0: 6465 7669 6174 696f 6e20 6f66 2074 6865  deviation of the
+000138c0: 2050 6f69 6e74 2053 7072 6561 6420 4675   Point Spread Fu
+000138d0: 6e63 7469 6f6e 2c20 696e 2070 6978 656c  nction, in pixel
+000138e0: 2075 6e69 7473 2e0d 0a20 2020 2020 2020   units...       
+000138f0: 2020 2020 2054 6865 2064 6566 6175 6c74       The default
+00013900: 2069 7320 332e 0d0a 0d0a 2020 2020 2020   is 3.....      
+00013910: 2020 7379 7374 656d 5f67 6169 6e20 3a20    system_gain : 
+00013920: 666c 6f61 742c 206f 7074 696f 6e61 6c0d  float, optional.
+00013930: 0a20 2020 2020 2020 2020 2020 2053 7973  .            Sys
+00013940: 7465 6d20 6761 696e 206f 6620 7468 6520  tem gain of the 
+00013950: 6469 6769 7461 6c20 6361 6d65 7261 2e0d  digital camera..
+00013960: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00013970: 2064 6566 6175 6c74 2069 7320 302e 3033   default is 0.03
+00013980: 382e 0d0a 0d0a 2020 2020 2020 2020 6461  8.....        da
+00013990: 726b 5f63 7572 7265 6e74 203a 2066 6c6f  rk_current : flo
+000139a0: 6174 2c20 6f70 7469 6f6e 616c 0d0a 2020  at, optional..  
+000139b0: 2020 2020 2020 2020 2020 4461 726b 2063            Dark c
+000139c0: 7572 7265 6e74 206f 6620 7468 6520 6469  urrent of the di
+000139d0: 6769 7461 6c20 6361 6d65 7261 2c20 696e  gital camera, in
+000139e0: 2075 6e69 7420 656c 6563 7472 6f6e 732e   unit electrons.
+000139f0: 0d0a 2020 2020 2020 2020 2020 2020 5468  ..            Th
+00013a00: 6520 6465 6661 756c 7420 6973 207e 3130  e default is ~10
+00013a10: 302e 0d0a 0d0a 2020 2020 2020 2020 6461  0.....        da
+00013a20: 726b 5f6e 6f69 7365 203a 2066 6c6f 6174  rk_noise : float
+00013a30: 2c20 6f70 7469 6f6e 616c 0d0a 2020 2020  , optional..    
+00013a40: 2020 2020 2020 2020 4461 726b 206e 6f69          Dark noi
+00013a50: 7365 206f 6620 7468 6520 6469 6769 7461  se of the digita
+00013a60: 6c20 6361 6d65 7261 2c20 696e 2075 6e69  l camera, in uni
+00013a70: 7473 2065 6c65 6374 726f 6e73 2e0d 0a20  ts electrons... 
+00013a80: 2020 2020 2020 2020 2020 2054 6865 2064             The d
+00013a90: 6566 6175 6c74 2069 7320 3133 2e37 2e0d  efault is 13.7..
+00013aa0: 0a0d 0a20 2020 2020 2020 2073 6565 6420  ...        seed 
+00013ab0: 3a20 696e 742c 206f 7074 696f 6e61 6c0d  : int, optional.
+00013ac0: 0a20 2020 2020 2020 2020 2020 2041 2073  .            A s
+00013ad0: 6565 6420 746f 2069 6e69 7469 616c 697a  eed to initializ
+00013ae0: 6520 7468 6520 5261 6e64 6f6d 204e 756d  e the Random Num
+00013af0: 6265 7220 4765 6e65 7261 746f 722e 0d0a  ber Generator...
+00013b00: 2020 2020 2020 2020 2020 2020 4974 206d              It m
+00013b10: 616b 6573 2074 6865 2072 616e 646f 6d20  akes the random 
+00013b20: 6e75 6d62 6572 7320 7072 6564 6963 7461  numbers predicta
+00013b30: 626c 652e 0d0a 2020 2020 2020 2020 2020  ble...          
+00013b40: 2020 5365 6520 6053 6565 6469 6e67 2061    See `Seeding a
+00013b50: 6e64 2045 6e74 726f 7079 203c 6874 7470  nd Entropy <http
+00013b60: 733a 2f2f 6e75 6d70 792e 6f72 672f 646f  s://numpy.org/do
+00013b70: 632f 7374 6162 6c65 2f72 6566 6572 656e  c/stable/referen
+00013b80: 6365 2f72 616e 646f 6d2f 6269 745f 6765  ce/random/bit_ge
+00013b90: 6e65 7261 746f 7273 2f69 6e64 6578 2e68  nerators/index.h
+00013ba0: 746d 6c23 7365 6564 696e 672d 616e 642d  tml#seeding-and-
+00013bb0: 656e 7472 6f70 793e 605f 2066 6f72 206d  entropy>`_ for m
+00013bc0: 6f72 6520 696e 666f 726d 6174 696f 6e20  ore information 
+00013bd0: 6162 6f75 7420 7365 6564 696e 672e 0d0a  about seeding...
+00013be0: 0d0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00013bf0: 730d 0a20 2020 2020 2020 202d 2d2d 2d2d  s..        -----
+00013c00: 2d2d 0d0a 2020 2020 2020 2020 4920 3a20  --..        I : 
+00013c10: 6e70 2e6e 6461 7272 6179 0d0a 2020 2020  np.ndarray..    
+00013c20: 2020 2020 2020 2020 5369 6d75 6c61 7465          Simulate
+00013c30: 6420 6672 696e 6765 2070 6174 7465 726e  d fringe pattern
+00013c40: 2073 6571 7565 6e63 652e 0d0a 2020 2020   sequence...    
+00013c50: 2020 2020 2222 220d 0a0d 0a20 2020 2020      """....     
+00013c60: 2020 2074 3020 3d20 7469 6d65 2e70 6572     t0 = time.per
+00013c70: 665f 636f 756e 7465 7228 290d 0a0d 0a20  f_counter().... 
+00013c80: 2020 2020 2020 2049 2e73 6861 7065 203d         I.shape =
+00013c90: 2076 7368 6170 6528 4929 2e73 6861 7065   vshape(I).shape
+00013ca0: 0d0a 2020 2020 2020 2020 4920 3d20 492e  ..        I = I.
+00013cb0: 6173 7479 7065 2866 6c6f 6174 2c20 636f  astype(float, co
+00013cc0: 7079 3d46 616c 7365 290d 0a0d 0a20 2020  py=False)....   
+00013cd0: 2020 2020 2023 2023 206d 6167 6e69 6669       # # magnifi
+00013ce0: 6361 7469 6f6e 0d0a 2020 2020 2020 2020  cation..        
+00013cf0: 2320 6966 206d 6167 6e69 6669 6361 7469  # if magnificati
+00013d00: 6f6e 2021 3d20 313a 2020 2320 6174 7465  on != 1:  # atte
+00013d10: 6e74 696f 6e3a 206d 6167 6e69 6669 6361  ntion: magnifica
+00013d20: 7469 6f6e 206d 7573 7420 6265 2061 6e20  tion must be an 
+00013d30: 696e 7465 6765 720d 0a20 2020 2020 2020  integer..       
+00013d40: 2023 2020 2020 2049 203d 2073 702e 6e64   #     I = sp.nd
+00013d50: 696d 6167 652e 756e 6966 6f72 6d5f 6669  image.uniform_fi
+00013d60: 6c74 6572 2849 2c20 7369 7a65 3d6d 6167  lter(I, size=mag
+00013d70: 6e69 6669 6361 7469 6f6e 2c20 6d6f 6465  nification, mode
+00013d80: 3d22 7265 666c 6563 7422 2c20 6178 6573  ="reflect", axes
+00013d90: 3d28 312c 2032 2929 0d0a 0d0a 2020 2020  =(1, 2))....    
+00013da0: 2020 2020 2320 5053 4620 2865 2e67 2e20      # PSF (e.g. 
+00013db0: 6465 666f 6375 7329 0d0a 2020 2020 2020  defocus)..      
+00013dc0: 2020 6966 2050 5346 2021 3d20 303a 0d0a    if PSF != 0:..
+00013dd0: 2020 2020 2020 2020 2020 2020 4920 3d20              I = 
+00013de0: 7370 2e6e 6469 6d61 6765 2e67 6175 7373  sp.ndimage.gauss
+00013df0: 6961 6e5f 6669 6c74 6572 2849 2c20 7369  ian_filter(I, si
+00013e00: 676d 613d 5053 462c 206f 7264 6572 3d30  gma=PSF, order=0
+00013e10: 2c20 6d6f 6465 3d22 7265 666c 6563 7422  , mode="reflect"
+00013e20: 2c20 6178 6573 3d28 312c 2032 2929 0d0a  , axes=(1, 2))..
+00013e30: 0d0a 2020 2020 2020 2020 6966 2073 7973  ..        if sys
+00013e40: 7465 6d5f 6761 696e 203e 2030 3a0d 0a20  tem_gain > 0:.. 
+00013e50: 2020 2020 2020 2020 2020 2023 2072 616e             # ran
+00013e60: 646f 6d20 6e75 6d62 6572 2067 656e 6572  dom number gener
+00013e70: 6174 6f72 0d0a 2020 2020 2020 2020 2020  ator..          
+00013e80: 2020 726e 6720 3d20 6e70 2e72 616e 646f    rng = np.rando
+00013e90: 6d2e 6465 6661 756c 745f 726e 6728 7365  m.default_rng(se
+00013ea0: 6564 290d 0a0d 0a20 2020 2020 2020 2020  ed)....         
+00013eb0: 2020 2023 2061 6464 2073 686f 7420 6e6f     # add shot no
+00013ec0: 6973 650d 0a20 2020 2020 2020 2020 2020  ise..           
+00013ed0: 2073 686f 7420 3d20 2849 202d 2072 6e67   shot = (I - rng
+00013ee0: 2e70 6f69 7373 6f6e 2849 2929 202a 206e  .poisson(I)) * n
+00013ef0: 702e 7371 7274 2873 7973 7465 6d5f 6761  p.sqrt(system_ga
+00013f00: 696e 290d 0a20 2020 2020 2020 2020 2020  in)..           
+00013f10: 2049 202b 3d20 7368 6f74 0d0a 2020 2020   I += shot..    
+00013f20: 2020 2020 2020 2020 2320 735f 203d 206e          # s_ = n
+00013f30: 702e 7374 6428 7368 6f74 290d 0a0d 0a20  p.std(shot).... 
+00013f40: 2020 2020 2020 2020 2020 2069 6620 6461             if da
+00013f50: 726b 5f63 7572 7265 6e74 203e 2030 206f  rk_current > 0 o
+00013f60: 7220 6461 726b 5f6e 6f69 7365 203e 2030  r dark_noise > 0
+00013f70: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00013f80: 2020 2023 2061 6464 2064 6172 6b20 7369     # add dark si
+00013f90: 676e 616c 2061 6e64 2064 6172 6b20 6e6f  gnal and dark no
+00013fa0: 6973 650d 0a20 2020 2020 2020 2020 2020  ise..           
+00013fb0: 2020 2020 2064 6172 6b5f 6375 7272 656e       dark_curren
+00013fc0: 745f 7930 203d 2064 6172 6b5f 6375 7272  t_y0 = dark_curr
+00013fd0: 656e 7420 2a20 7379 7374 656d 5f67 6169  ent * system_gai
+00013fe0: 6e0d 0a20 2020 2020 2020 2020 2020 2020  n..             
+00013ff0: 2020 2064 6172 6b5f 6e6f 6973 655f 7930     dark_noise_y0
+00014000: 203d 2064 6172 6b5f 6e6f 6973 6520 2a20   = dark_noise * 
+00014010: 7379 7374 656d 5f67 6169 6e0d 0a20 2020  system_gain..   
+00014020: 2020 2020 2020 2020 2020 2020 2064 6172               dar
+00014030: 6b20 3d20 726e 672e 6e6f 726d 616c 2864  k = rng.normal(d
+00014040: 6172 6b5f 6375 7272 656e 745f 7930 2c20  ark_current_y0, 
+00014050: 6461 726b 5f6e 6f69 7365 5f79 302c 2049  dark_noise_y0, I
+00014060: 2e73 6861 7065 290d 0a20 2020 2020 2020  .shape)..       
+00014070: 2020 2020 2020 2020 2049 202b 3d20 6461           I += da
+00014080: 726b 0d0a 2020 2020 2020 2020 2020 2020  rk..            
+00014090: 2020 2020 2320 645f 203d 206e 702e 7374      # d_ = np.st
+000140a0: 6428 6461 726b 290d 0a0d 0a20 2020 2020  d(dark)....     
+000140b0: 2020 2023 2061 6464 2073 7061 7469 616c     # add spatial
+000140c0: 206e 6f6e 756e 6966 6f72 6d69 7479 0d0a   nonuniformity..
+000140d0: 2020 2020 2020 2020 534e 5520 3d20 3020          SNU = 0 
+000140e0: 2023 2074 6f64 6f3a 2073 7061 7469 616c   # todo: spatial
+000140f0: 206e 6f6e 756e 6966 6f72 6d69 7479 0d0a   nonuniformity..
+00014100: 2020 2020 2020 2020 4920 2b3d 2053 4e55          I += SNU
+00014110: 0d0a 0d0a 2020 2020 2020 2020 2320 636c  ....        # cl
+00014120: 6970 2076 616c 7565 730d 0a20 2020 2020  ip values..     
+00014130: 2020 206e 702e 636c 6970 2849 2c20 302c     np.clip(I, 0,
+00014140: 2073 656c 662e 496d 6178 2c20 6f75 743d   self.Imax, out=
+00014150: 4929 0d0a 0d0a 2020 2020 2020 2020 2320  I)....        # 
+00014160: 7175 616e 7469 7a61 7469 6f6e 206e 6f69  quantization noi
+00014170: 7365 2069 7320 6164 6465 6420 6279 2063  se is added by c
+00014180: 6f6e 7665 7274 696e 6720 746f 2069 6e74  onverting to int
+00014190: 6567 6572 0d0a 2020 2020 2020 2020 4920  eger..        I 
+000141a0: 3d20 492e 6173 7479 7065 2873 656c 662e  = I.astype(self.
+000141b0: 6474 7970 652c 2063 6f70 793d 4661 6c73  dtype, copy=Fals
+000141c0: 6529 0d0a 0d0a 2020 2020 2020 2020 6c6f  e)....        lo
+000141d0: 6767 696e 672e 696e 666f 2866 227b 3130  gging.info(f"{10
+000141e0: 3030 202a 2028 7469 6d65 2e70 6572 665f  00 * (time.perf_
+000141f0: 636f 756e 7465 7228 2920 2d20 7430 297d  counter() - t0)}
+00014200: 6d73 2229 0d0a 0d0a 2020 2020 2020 2020  ms")....        
+00014210: 7265 7475 726e 2049 0d0a 0d0a 2020 2020  return I....    
+00014220: 6465 6620 5f74 7269 6d28 7365 6c66 2c20  def _trim(self, 
+00014230: 613a 206e 702e 6e64 6172 7261 7929 202d  a: np.ndarray) -
+00014240: 3e20 6e70 2e6e 6461 7272 6179 3a0d 0a20  > np.ndarray:.. 
+00014250: 2020 2020 2020 2022 2222 4368 616e 6765         """Change
+00014260: 2060 6160 2e6e 6469 6d20 746f 2032 2061   `a`.ndim to 2 a
+00014270: 6e64 206c 696d 6974 2060 6160 2e73 6861  nd limit `a`.sha
+00014280: 7065 2e22 2222 0d0a 0d0a 2020 2020 2020  pe."""....      
+00014290: 2020 6966 2061 2e6e 6469 6d20 3d3d 2030    if a.ndim == 0
+000142a0: 3a0d 0a20 2020 2020 2020 2020 2020 2061  :..            a
+000142b0: 203d 206e 702e 6675 6c6c 2828 7365 6c66   = np.full((self
+000142c0: 2e44 2c20 7365 6c66 2e4b 292c 2061 290d  .D, self.K), a).
+000142d0: 0a20 2020 2020 2020 2065 6c69 6620 612e  .        elif a.
+000142e0: 6e64 696d 203d 3d20 313a 0d0a 2020 2020  ndim == 1:..    
+000142f0: 2020 2020 2020 2020 6120 3d20 6e70 2e76          a = np.v
+00014300: 7374 6163 6b28 5b61 5b3a 2073 656c 662e  stack([a[: self.
+00014310: 5f4b 6d61 785d 2066 6f72 2064 2069 6e20  _Kmax] for d in 
+00014320: 7261 6e67 6528 7365 6c66 2e44 295d 290d  range(self.D)]).
+00014330: 0a20 2020 2020 2020 2065 6c69 6620 612e  .        elif a.
+00014340: 6e64 696d 203d 3d20 323a 0d0a 2020 2020  ndim == 2:..    
+00014350: 2020 2020 2020 2020 6120 3d20 615b 3a20          a = a[: 
+00014360: 7365 6c66 2e5f 446d 6178 2c20 3a20 7365  self._Dmax, : se
+00014370: 6c66 2e5f 4b6d 6178 5d0d 0a20 2020 2020  lf._Kmax]..     
+00014380: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00014390: 2020 2020 2020 6120 3d20 615b 3a20 7365        a = a[: se
+000143a0: 6c66 2e5f 446d 6178 2c20 3a20 7365 6c66  lf._Dmax, : self
+000143b0: 2e5f 4b6d 6178 2c20 2e2e 2e2c 202d 315d  ._Kmax, ..., -1]
+000143c0: 0d0a 0d0a 2020 2020 2020 2020 7265 7475  ....        retu
+000143d0: 726e 2061 0d0a 0d0a 2020 2020 6465 6620  rn a....    def 
+000143e0: 4d54 4628 7365 6c66 2c20 763a 2066 6c6f  MTF(self, v: flo
+000143f0: 6174 207c 206e 702e 6e64 6172 7261 7929  at | np.ndarray)
+00014400: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
+00014410: 0a20 2020 2020 2020 2022 2222 4d6f 6475  .        """Modu
+00014420: 6c61 7469 6f6e 2054 7261 6e73 6665 7220  lation Transfer 
+00014430: 4675 6e63 7469 6f6e 2e0d 0a0d 0a20 2020  Function.....   
+00014440: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
+00014450: 2072 656c 6174 6976 6520 6d6f 6475 6c61   relative modula
+00014460: 7469 6f6e 2061 7420 7370 6174 6961 6c20  tion at spatial 
+00014470: 6672 6571 7565 6e63 6965 7320 6076 602e  frequencies `v`.
+00014480: 0d0a 0d0a 2020 2020 2020 2020 5061 7261  ....        Para
+00014490: 6d65 7465 7273 0d0a 2020 2020 2020 2020  meters..        
+000144a0: 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020  ----------..    
+000144b0: 2020 2020 763a 206e 702e 6e64 6172 7261      v: np.ndarra
+000144c0: 790d 0a20 2020 2020 2020 2020 2020 2053  y..            S
+000144d0: 7061 7469 616c 2066 7265 7175 656e 6369  patial frequenci
+000144e0: 6573 2061 7420 7768 6963 6820 746f 2064  es at which to d
+000144f0: 6574 6572 6d69 6e65 2074 6865 206e 6f72  etermine the nor
+00014500: 6d61 6c69 7a65 6420 6d6f 6475 6c61 7469  malized modulati
+00014510: 6f6e 2e0d 0a0d 0a20 2020 2020 2020 2052  on.....        R
+00014520: 6574 7572 6e73 0d0a 2020 2020 2020 2020  eturns..        
+00014530: 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a 2020 2020  ----------..    
+00014540: 2020 2020 4220 3a20 6e70 2e6e 6461 7272      B : np.ndarr
+00014550: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
+00014560: 5265 6c61 7469 7665 206d 6f64 756c 6174  Relative modulat
+00014570: 696f 6e2c 2069 6e20 7468 6520 7361 6d65  ion, in the same
+00014580: 2073 6861 7065 2061 7320 6076 602e 0d0a   shape as `v`...
+00014590: 0d0a 2020 2020 2020 2020 4e6f 7465 730d  ..        Notes.
+000145a0: 0a20 2020 2020 2020 202d 2d2d 2d2d 0d0a  .        -----..
+000145b0: 2020 2020 2020 2020 2d20 4966 2074 6865          - If the
+000145c0: 2061 7474 7269 6275 7465 2060 4276 6020   attribute `Bv` 
+000145d0: 6f66 2074 6865 2046 7269 6e67 6573 2069  of the Fringes i
+000145e0: 6e73 7461 6e63 6520 6973 206e 6f74 204e  nstance is not N
+000145f0: 6f6e 652c 2074 6865 204d 5446 2069 7320  one, the MTF is 
+00014600: 696e 7465 7270 6f6c 6174 6564 2066 726f  interpolated fro
+00014610: 6d20 7072 6576 696f 7573 206d 6561 7375  m previous measu
+00014620: 7265 6d65 6e74 732e 5c6e 0d0a 2020 2020  rements.\n..    
+00014630: 2020 2020 2d20 456c 7365 2c20 6966 2074      - Else, if t
+00014640: 6865 2061 7474 7269 6275 7465 2060 5053  he attribute `PS
+00014650: 4660 206f 6620 7468 6520 4672 696e 6765  F` of the Fringe
+00014660: 7320 696e 7374 616e 6365 2069 7320 6c61  s instance is la
+00014670: 7267 6572 2074 6861 6e20 7a65 726f 2c20  rger than zero, 
+00014680: 7468 6520 4d54 4620 6973 2063 6f6d 7075  the MTF is compu
+00014690: 7465 6420 6672 6f6d 2074 6865 206f 7074  ted from the opt
+000146a0: 6963 616c 2074 7261 6e73 6665 7220 6675  ical transfer fu
+000146b0: 6e63 7469 6f6e 206f 6620 7468 6520 6f70  nction of the op
+000146c0: 7469 6361 6c20 7379 7374 656d 2c20 692e  tical system, i.
+000146d0: 652e 2061 7320 7468 6520 6d61 676e 6974  e. as the magnit
+000146e0: 7564 6520 6f66 2074 6865 2046 6f75 7269  ude of the Fouri
+000146f0: 6572 2d74 7261 6e73 666f 726d 6564 2027  er-transformed '
+00014700: 506f 696e 7420 5370 7265 6164 2046 756e  Point Spread Fun
+00014710: 6374 696f 6e27 2028 5053 4629 2e5c 6e0d  ction' (PSF).\n.
+00014720: 0a20 2020 2020 2020 202d 2045 6c73 652c  .        - Else,
+00014730: 2069 7420 7265 7475 726e 7320 6f6e 6573   it returns ones
+00014740: 2e0d 0a20 2020 2020 2020 2022 2222 0d0a  ...        """..
+00014750: 0d0a 2020 2020 2020 2020 7620 3d20 6e70  ..        v = np
+00014760: 2e61 7272 6179 2876 2c20 666c 6f61 742c  .array(v, float,
+00014770: 2063 6f70 793d 4661 6c73 652c 206e 646d   copy=False, ndm
+00014780: 696e 3d31 290d 0a0d 0a20 2020 2020 2020  in=1)....       
+00014790: 2069 6620 7365 6c66 2e42 7620 6973 206e   if self.Bv is n
+000147a0: 6f74 204e 6f6e 653a 2020 2320 696e 7465  ot None:  # inte
+000147b0: 7270 6f6c 6174 6520 6672 6f6d 206d 6561  rpolate from mea
+000147c0: 7375 7265 6d65 6e74 0d0a 2020 2020 2020  surement..      
+000147d0: 2020 2020 2020 2320 746f 646f 3a20 7465        # todo: te
+000147e0: 7374 3a20 756e 6971 7565 202b 204c 5554  st: unique + LUT
+000147f0: 0d0a 2020 2020 2020 2020 2020 2020 765f  ..            v_
+00014800: 203d 2076 2e72 6176 656c 2829 0d0a 2020   = v.ravel()..  
+00014810: 2020 2020 2020 2020 2020 7675 203d 206e            vu = n
+00014820: 702e 756e 6971 7565 2876 290d 0a20 2020  p.unique(v)..   
+00014830: 2020 2020 2020 2020 204d 5446 203d 2073           MTF = s
+00014840: 702e 696e 7465 7270 6f6c 6174 652e 696e  p.interpolate.in
+00014850: 7465 7270 3164 280d 0a20 2020 2020 2020  terp1d(..       
+00014860: 2020 2020 2020 2020 2076 5f2c 2073 656c           v_, sel
+00014870: 662e 4276 2c20 6b69 6e64 3d22 6375 6269  f.Bv, kind="cubi
+00014880: 6322 2c20 6669 6c6c 5f76 616c 7565 3d22  c", fill_value="
+00014890: 6578 7472 6170 6f6c 6174 6522 0d0a 2020  extrapolate"..  
+000148a0: 2020 2020 2020 2020 2020 2920 2023 2074            )  # t
+000148b0: 6f64 6f3a 202e 2e2e 616e 6420 6578 7472  odo: ...and extr
+000148c0: 6170 6f6c 6174 6564 2061 7420 706f 696e  apolated at poin
+000148d0: 7473 206f 7574 7369 6465 2074 6865 2064  ts outside the d
+000148e0: 6174 6120 7261 6e67 653f 0d0a 2020 2020  ata range?..    
+000148f0: 2020 2020 2020 2020 4220 3d20 4d54 4628          B = MTF(
+00014900: 7675 292e 636c 6970 2830 2c20 3129 2e72  vu).clip(0, 1).r
+00014910: 6573 6861 7065 2876 2e73 6861 7065 2920  eshape(v.shape) 
+00014920: 2023 2069 6e74 6572 706f 6c61 7465 2066   # interpolate f
+00014930: 726f 6d20 6d65 6173 7572 6564 206d 6f64  rom measured mod
+00014940: 756c 6174 696f 6e20 7661 6c75 6573 0d0a  ulation values..
+00014950: 2020 2020 2020 2020 2020 2020 6964 7820              idx 
+00014960: 3d20 6e70 2e61 7267 7768 6572 6528 7620  = np.argwhere(v 
+00014970: 3d3d 2076 7529 0d0a 2020 2020 2020 2020  == vu)..        
+00014980: 2020 2020 4220 3d20 425b 6964 785d 2e72      B = B[idx].r
+00014990: 6573 6861 7065 2876 2e73 6861 7065 290d  eshape(v.shape).
+000149a0: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+000149b0: 6c66 2e50 5346 203e 2030 3a20 2023 2064  lf.PSF > 0:  # d
+000149c0: 6574 6572 6d69 6e65 204d 5446 2066 726f  etermine MTF fro
+000149d0: 6d20 5053 460d 0a20 2020 2020 2020 2020  m PSF..         
+000149e0: 2020 2042 203d 2073 656c 662e 4220 2a20     B = self.B * 
+000149f0: 6e70 2e65 7870 282d 3220 2a20 286e 702e  np.exp(-2 * (np.
+00014a00: 7069 202a 2073 656c 662e 5053 4620 2a20  pi * self.PSF * 
+00014a10: 7629 202a 2a20 3229 2020 2320 746f 646f  v) ** 2)  # todo
+00014a20: 3a20 6669 780d 0a20 2020 2020 2020 2020  : fix..         
+00014a30: 2020 2023 2074 6f64 6f3a 2077 6861 7420     # todo: what 
+00014a40: 6973 2073 6d61 6c6c 6572 3a20 646c 206f  is smaller: dl o
+00014a50: 7220 6c76 3f0d 0a20 2020 2020 2020 2020  r lv?..         
+00014a60: 2020 2042 203d 2031 202d 2076 202f 2028     B = 1 - v / (
+00014a70: 7365 6c66 2e4c 202f 2028 7365 6c66 2e6c  self.L / (self.l
+00014a80: 6d69 6e20 2d20 3129 2920 2023 2061 7070  min - 1))  # app
+00014a90: 726f 7869 6d61 7469 6f6e 206f 6620 5b42  roximation of [B
+00014aa0: 6f74 6865 3230 3038 5d0d 0a20 2020 2020  othe2008]..     
+00014ab0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00014ac0: 2020 2020 2020 4220 3d20 6e70 2e6f 6e65        B = np.one
+00014ad0: 7328 762e 7368 6170 6529 0d0a 0d0a 2020  s(v.shape)....  
+00014ae0: 2020 2020 2020 7265 7475 726e 2042 0d0a        return B..
+00014af0: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
+00014b00: 0a20 2020 2064 6566 2054 2873 656c 6629  .    def T(self)
+00014b10: 202d 3e20 696e 743a 0d0a 2020 2020 2020   -> int:..      
+00014b20: 2020 2222 224e 756d 6265 7220 6f66 2066    """Number of f
+00014b30: 7261 6d65 732e 2222 220d 0a0d 0a20 2020  rames."""....   
+00014b40: 2020 2020 2054 203d 2073 656c 662e 4820       T = self.H 
+00014b50: 2a20 6e70 2e73 756d 2873 656c 662e 5f4e  * np.sum(self._N
+00014b60: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
+00014b70: 7365 6c66 2e46 444d 3a20 2023 2074 6f64  self.FDM:  # tod
+00014b80: 6f3a 2066 7261 6374 696f 6e61 6c20 7065  o: fractional pe
+00014b90: 7269 6f64 730d 0a20 2020 2020 2020 2020  riods..         
+00014ba0: 2020 2054 202f 3d20 7365 6c66 2e44 202a     T /= self.D *
+00014bb0: 2073 656c 662e 4b0d 0a0d 0a20 2020 2020   self.K....     
+00014bc0: 2020 2069 6620 7365 6c66 2e53 444d 3a0d     if self.SDM:.
+00014bd0: 0a20 2020 2020 2020 2020 2020 2054 202f  .            T /
+00014be0: 3d20 7365 6c66 2e44 0d0a 0d0a 2020 2020  = self.D....    
+00014bf0: 2020 2020 6966 2073 656c 662e 5744 4d3a      if self.WDM:
+00014c00: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00014c10: 206e 702e 616c 6c28 7365 6c66 2e4e 203d   np.all(self.N =
+00014c20: 3d20 3329 3a20 2023 2057 444d 2061 6c6f  = 3):  # WDM alo
+00014c30: 6e67 2073 6869 6674 730d 0a20 2020 2020  ng shifts..     
+00014c40: 2020 2020 2020 2020 2020 2054 202f 3d20             T /= 
+00014c50: 330d 0a20 2020 2020 2020 2020 2020 2023  3..            #
+00014c60: 2065 6c69 6620 7365 6c66 2e4b 203e 2073   elif self.K > s
+00014c70: 656c 662e 443a 2020 2320 5744 4d20 616c  elf.D:  # WDM al
+00014c80: 6f6e 6720 7365 7473 2074 6f64 6f0d 0a20  ong sets todo.. 
+00014c90: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00014ca0: 2061 203d 206e 702e 7375 6d28 7365 6c66   a = np.sum(self
+00014cb0: 2e5f 4e2c 2061 7869 733d 3129 0d0a 2020  ._N, axis=1)..  
+00014cc0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00014cd0: 6220 3d20 6e70 2e6d 6178 2861 290d 0a20  b = np.max(a).. 
+00014ce0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00014cf0: 2063 203d 206e 702e 6365 696c 2862 202f   c = np.ceil(b /
+00014d00: 2033 290d 0a20 2020 2020 2020 2020 2020   3)..           
+00014d10: 2023 2020 2020 2064 203d 2069 6e74 2863   #     d = int(c
+00014d20: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00014d30: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00014d40: 2020 2020 6132 203d 206e 702e 7375 6d28      a2 = np.sum(
+00014d50: 7365 6c66 2e5f 4e2c 2061 7869 733d 3029  self._N, axis=0)
+00014d60: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00014d70: 2020 2020 6232 203d 206e 702e 6d61 7828      b2 = np.max(
+00014d80: 6132 290d 0a20 2020 2020 2020 2020 2020  a2)..           
+00014d90: 2023 2020 2020 2063 3220 3d20 6e70 2e63   #     c2 = np.c
+00014da0: 6569 6c28 6232 202f 2032 290d 0a20 2020  eil(b2 / 2)..   
+00014db0: 2020 2020 2020 2020 2023 2020 2020 2064           #     d
+00014dc0: 3220 3d20 696e 7428 6332 290d 0a20 2020  2 = int(c2)..   
+00014dd0: 2020 2020 2020 2020 2023 0d0a 2020 2020           #..    
+00014de0: 2020 2020 2020 2020 2320 2020 2020 6966          #     if
+00014df0: 2064 203c 2064 323a 0d0a 2020 2020 2020   d < d2:..      
+00014e00: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00014e10: 5420 3d20 696e 7428 6e70 2e63 6569 6c28  T = int(np.ceil(
+00014e20: 6e70 2e6d 6178 286e 702e 7375 6d28 7365  np.max(np.sum(se
+00014e30: 6c66 2e5f 4e2c 2061 7869 733d 3129 2920  lf._N, axis=1)) 
+00014e40: 2f20 3329 290d 0a20 2020 2020 2020 2020  / 3))..         
+00014e50: 2020 2023 2020 2020 2065 6c73 653a 2020     #     else:  
+00014e60: 2320 7573 6520 7265 6420 616e 6420 626c  # use red and bl
+00014e70: 7565 0d0a 2020 2020 2020 2020 2020 2020  ue..            
+00014e80: 2320 2020 2020 2020 2020 5420 3d20 696e  #         T = in
+00014e90: 7428 6e70 2e63 6569 6c28 6e70 2e6d 6178  t(np.ceil(np.max
+00014ea0: 286e 702e 7375 6d28 7365 6c66 2e5f 4e2c  (np.sum(self._N,
+00014eb0: 2061 7869 733d 3029 2920 2f20 3229 290d   axis=0)) / 2)).
+00014ec0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+00014ed0: 6c73 653a 2020 2320 5744 4d20 616c 6f6e  lse:  # WDM alon
+00014ee0: 6720 6469 7265 6374 696f 6e73 2c20 7573  g directions, us
+00014ef0: 6520 7265 6420 616e 6420 626c 7565 2074  e red and blue t
+00014f00: 6f64 6f0d 0a20 2020 2020 2020 2020 2020  odo..           
+00014f10: 2023 2020 2020 2061 203d 206e 702e 7375   #     a = np.su
+00014f20: 6d28 7365 6c66 2e5f 4e2c 2061 7869 733d  m(self._N, axis=
+00014f30: 3029 0d0a 2020 2020 2020 2020 2020 2020  0)..            
+00014f40: 2320 2020 2020 6220 3d20 6e70 2e6d 6178  #     b = np.max
+00014f50: 2861 290d 0a20 2020 2020 2020 2020 2020  (a)..           
+00014f60: 2023 2020 2020 2063 203d 206e 702e 6365   #     c = np.ce
+00014f70: 696c 2862 202f 2032 290d 0a20 2020 2020  il(b / 2)..     
+00014f80: 2020 2020 2020 2023 2020 2020 2064 203d         #     d =
+00014f90: 2069 6e74 2863 290d 0a20 2020 2020 2020   int(c)..       
+00014fa0: 2020 2020 2023 2020 2020 2054 203d 2069       #     T = i
+00014fb0: 6e74 286e 702e 6365 696c 286e 702e 6d61  nt(np.ceil(np.ma
+00014fc0: 7828 6e70 2e73 756d 2873 656c 662e 5f4e  x(np.sum(self._N
+00014fd0: 2c20 6178 6973 3d31 2929 202f 2032 2929  , axis=1)) / 2))
+00014fe0: 0d0a 0d0a 2020 2020 2020 2020 7265 7475  ....        retu
+00014ff0: 726e 2069 6e74 2854 2920 2023 2075 7365  rn int(T)  # use
+00015000: 2069 6e74 2829 2074 6f20 656e 7375 7265   int() to ensure
+00015010: 2074 7970 6520 6973 2022 696e 7422 2069   type is "int" i
+00015020: 6e73 7465 6164 206f 6620 226e 756d 7079  nstead of "numpy
+00015030: 2e63 6f72 652e 6d75 6c74 6961 7272 6179  .core.multiarray
+00015040: 2e73 6361 6c61 7222 2020 2320 746f 646f  .scalar"  # todo
+00015050: 3a20 6e65 6365 7373 6172 793f 0d0a 0d0a  : necessary?....
+00015060: 2020 2020 4054 2e73 6574 7465 720d 0a20      @T.setter.. 
+00015070: 2020 2064 6566 2054 2873 656c 662c 2054     def T(self, T
+00015080: 3a20 696e 7429 3a0d 0a20 2020 2020 2020  : int):..       
+00015090: 2023 2061 7474 656e 7469 6f6e 3a20 7061   # attention: pa
+000150a0: 7261 6d73 206d 6179 2063 6861 6e67 6520  rams may change 
+000150b0: 6576 656e 2069 6620 546e 6577 203d 3d20  even if Tnew == 
+000150c0: 546f 6c64 0d0a 0d0a 2020 2020 2020 2020  Told....        
+000150d0: 5f54 203d 2069 6e74 286d 696e 286d 6178  _T = int(min(max
+000150e0: 2831 2c20 5429 2c20 7365 6c66 2e5f 546d  (1, T), self._Tm
+000150f0: 6178 2929 0d0a 0d0a 2020 2020 2020 2020  ax))....        
+00015100: 6966 205f 5420 3d3d 2031 3a20 2023 2057  if _T == 1:  # W
+00015110: 444d 202b 2053 444d 2074 6f64 6f3a 2046  DM + SDM todo: F
+00015120: 544d 3f0d 0a20 2020 2020 2020 2020 2020  TM?..           
+00015130: 2069 6620 7365 6c66 2e67 7269 6420 6e6f   if self.grid no
+00015140: 7420 696e 2073 656c 662e 5f67 7269 6473  t in self._grids
+00015150: 5b3a 325d 3a0d 0a20 2020 2020 2020 2020  [:2]:..         
+00015160: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
+00015170: 7272 6f72 2866 2243 6f75 6c64 6e27 7420  rror(f"Couldn't 
+00015180: 7365 7420 2754 203d 2031 273a 2067 7269  set 'T = 1': gri
+00015190: 6420 6e6f 7420 696e 207b 7365 6c66 2e5f  d not in {self._
+000151a0: 6772 6964 735b 3a32 5d7d 272e 2229 0d0a  grids[:2]}'.")..
+000151b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000151c0: 7265 7475 726e 0d0a 0d0a 2020 2020 2020  return....      
+000151d0: 2020 2020 2020 7365 6c66 2e48 203d 2031        self.H = 1
+000151e0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000151f0: 6c66 2e4b 203d 2031 0d0a 0d0a 2020 2020  lf.K = 1....    
+00015200: 2020 2020 2020 2020 7365 6c66 2e46 444d          self.FDM
+00015210: 203d 2046 616c 7365 2020 2320 7265 7365   = False  # rese
+00015220: 7420 4644 4d20 6265 666f 7265 2073 6574  t FDM before set
+00015230: 7469 6e67 204e 0d0a 2020 2020 2020 2020  ting N..        
+00015240: 2020 2020 7365 6c66 2e4e 203d 2033 2020      self.N = 3  
+00015250: 2320 7365 7420 4e20 6265 666f 7265 2057  # set N before W
+00015260: 444d 0d0a 2020 2020 2020 2020 2020 2020  DM..            
+00015270: 7365 6c66 2e57 444d 203d 2054 7275 650d  self.WDM = True.
+00015280: 0a0d 0a20 2020 2020 2020 2020 2020 2069  ...            i
+00015290: 6620 7365 6c66 2e44 203d 3d20 323a 0d0a  f self.D == 2:..
+000152a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152b0: 7365 6c66 2e53 444d 203d 2054 7275 650d  self.SDM = True.
+000152c0: 0a20 2020 2020 2020 2065 6c69 6620 5f54  .        elif _T
+000152d0: 203d 3d20 323a 2020 2320 5744 4d0d 0a20   == 2:  # WDM.. 
+000152e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000152f0: 4820 3d20 310d 0a20 2020 2020 2020 2020  H = 1..         
+00015300: 2020 2073 656c 662e 4420 3d20 320d 0a20     self.D = 2.. 
+00015310: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00015320: 4b20 3d20 310d 0a0d 0a20 2020 2020 2020  K = 1....       
+00015330: 2020 2020 2073 656c 662e 4644 4d20 3d20       self.FDM = 
+00015340: 4661 6c73 6520 2023 2072 6573 6574 2046  False  # reset F
+00015350: 444d 2062 6566 6f72 6520 7365 7474 696e  DM before settin
+00015360: 6720 4e0d 0a20 2020 2020 2020 2020 2020  g N..           
+00015370: 2073 656c 662e 5344 4d20 3d20 4661 6c73   self.SDM = Fals
+00015380: 650d 0a20 2020 2020 2020 2020 2020 2073  e..            s
+00015390: 656c 662e 4e20 3d20 3320 2023 2073 6574  elf.N = 3  # set
+000153a0: 204e 2062 6566 6f72 6520 5744 4d0d 0a20   N before WDM.. 
+000153b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000153c0: 5744 4d20 3d20 5472 7565 0d0a 2020 2020  WDM = True..    
+000153d0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+000153e0: 2020 2020 2020 2023 2061 7320 6c6f 6e67         # as long
+000153f0: 2061 7320 656e 6f75 6768 2073 6869 6674   as enough shift
+00015400: 7320 6172 6520 7468 6572 6520 746f 2063  s are there to c
+00015410: 6f6d 7065 6e73 6174 6520 666f 7220 6e6f  ompensate for no
+00015420: 6e6c 696e 6561 7269 7469 6573 2c0d 0a20  nlinearities,.. 
+00015430: 2020 2020 2020 2020 2020 2023 2069 7420             # it 
+00015440: 646f 6573 6e27 7420 6d61 7474 6572 2069  doesn't matter i
+00015450: 6620 7765 2075 7365 206d 6f72 6520 7368  f we use more sh
+00015460: 6966 7473 206f 7220 6d6f 7265 2073 6574  ifts or more set
+00015470: 730d 0a0d 0a20 2020 2020 2020 2020 2020  s....           
+00015480: 2023 2073 6574 2062 6f75 6e64 6172 6965   # set boundarie
+00015490: 730d 0a20 2020 2020 2020 2020 2020 204e  s..            N
+000154a0: 6d69 6e20 3d20 3320 2023 206d 696e 696d  min = 3  # minim
+000154b0: 756d 206e 756d 6265 7220 6f66 2070 6861  um number of pha
+000154c0: 7365 2073 6869 6674 7320 666f 7220 6669  se shifts for fi
+000154d0: 7273 7420 7365 7420 746f 2064 6520 6465  rst set to de de
+000154e0: 6d6f 6475 6c61 7465 642f 6465 636f 6465  modulated/decode
+000154f0: 640d 0a20 2020 2020 2020 2020 2020 204e  d..            N
+00015500: 3132 203d 2046 616c 7365 0d0a 2020 2020  12 = False..    
+00015510: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
+00015520: 4e31 3220 3d20 4e6d 696e 203d 3d20 3320  N12 = Nmin == 3 
+00015530: 2023 2061 6c6c 6f77 204e 2074 6f20 6265   # allow N to be
+00015540: 2069 6e20 5b31 2c20 325d 2069 6620 4b20   in [1, 2] if K 
+00015550: 3e3d 2032 0d0a 2020 2020 2020 2020 2020  >= 2..          
+00015560: 2020 2320 746f 646f 3a20 4e31 3220 3d20    # todo: N12 = 
+00015570: 3120 696e 2073 656c 662e 4e20 6f72 2032  1 in self.N or 2
+00015580: 2069 6e20 7365 6c66 2e4e 0d0a 2020 2020   in self.N..    
+00015590: 2020 2020 2020 2020 4e67 6f6f 6420 3d20          Ngood = 
+000155a0: 3420 2023 206d 696e 696d 756d 206e 756d  4  # minimum num
+000155b0: 6265 7220 6f66 2070 6861 7365 2073 6869  ber of phase shi
+000155c0: 6674 7320 746f 206f 6274 6169 6e20 676f  fts to obtain go
+000155d0: 6f64 2072 6573 756c 7473 2069 2e65 2e20  od results i.e. 
+000155e0: 7265 6c69 6162 6c65 2072 6573 756c 7473  reliable results
+000155f0: 2069 6e20 7072 6163 7469 6365 0d0a 2020   in practice..  
+00015600: 2020 2020 2020 2020 2020 4b6d 6178 203d            Kmax =
+00015610: 2073 656c 662e 4b20 2023 2032 2020 2320   self.K  # 2  # 
+00015620: 3320 2023 2074 6f64 6f3a 2077 6869 6368  3  # todo: which
+00015630: 2069 7320 6265 7474 6572 3a20 3220 6f72   is better: 2 or
+00015640: 2033 3f0d 0a20 2020 2020 2020 2020 2020   3?..           
+00015650: 2073 656c 662e 4644 4d20 3d20 4661 6c73   self.FDM = Fals
+00015660: 650d 0a20 2020 2020 2020 2020 2020 2073  e..            s
+00015670: 656c 662e 5344 4d20 3d20 4661 6c73 650d  elf.SDM = False.
+00015680: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00015690: 662e 5744 4d20 3d20 4661 6c73 650d 0a20  f.WDM = False.. 
+000156a0: 2020 2020 2020 2020 2020 2023 2074 6f64             # tod
+000156b0: 6f3a 2054 203d 3d20 3420 2d3e 206e 6f20  o: T == 4 -> no 
+000156c0: 6d6f 640d 0a20 2020 2020 2020 2020 2020  mod..           
+000156d0: 2023 2020 5420 3d3d 2035 202d 3e20 4644   #  T == 5 -> FD
+000156e0: 4d20 6966 205f 5420 3e3d 204e 6d69 6e3f  M if _T >= Nmin?
+000156f0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00015700: 2320 7472 7920 4420 3d3d 2032 2020 2320  # try D == 2  # 
+00015710: 746f 646f 3a20 6d75 780d 0a20 2020 2020  todo: mux..     
+00015720: 2020 2020 2020 2069 6620 5f54 203c 2032         if _T < 2
+00015730: 202a 204e 6d69 6e3a 0d0a 2020 2020 2020   * Nmin:..      
+00015740: 2020 2020 2020 2020 2020 7365 6c66 2e44            self.D
+00015750: 203d 2031 0d0a 2020 2020 2020 2020 2020   = 1..          
+00015760: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00015770: 2020 2020 2020 2020 2073 656c 662e 4420           self.D 
+00015780: 3d20 320d 0a0d 0a20 2020 2020 2020 2020  = 2....         
+00015790: 2020 2023 2074 7279 2074 6f20 6b65 6570     # try to keep
+000157a0: 2068 7565 730d 0a20 2020 2020 2020 2020   hues..         
+000157b0: 2020 2069 6620 5f54 203c 2073 656c 662e     if _T < self.
+000157c0: 4820 2a20 7365 6c66 2e44 202a 204e 6d69  H * self.D * Nmi
+000157d0: 6e3a 0d0a 2020 2020 2020 2020 2020 2020  n:..            
+000157e0: 2020 2020 7365 6c66 2e48 203d 205f 5420      self.H = _T 
+000157f0: 2f2f 2028 7365 6c66 2e44 202a 204e 6d69  // (self.D * Nmi
+00015800: 6e29 0d0a 0d0a 2020 2020 2020 2020 2020  n)....          
+00015810: 2020 7768 696c 6520 5f54 2025 2073 656c    while _T % sel
+00015820: 662e 4820 213d 2030 3a0d 0a20 2020 2020  f.H != 0:..     
+00015830: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00015840: 4820 2d3d 2031 0d0a 0d0a 2020 2020 2020  H -= 1....      
+00015850: 2020 2020 2020 6966 2073 656c 662e 4820        if self.H 
+00015860: 3e20 313a 0d0a 2020 2020 2020 2020 2020  > 1:..          
+00015870: 2020 2020 2020 5f54 202f 2f3d 2073 656c        _T //= sel
+00015880: 662e 480d 0a0d 0a20 2020 2020 2020 2020  f.H....         
+00015890: 2020 2023 2074 7279 204b 203d 204b 6d61     # try K = Kma
+000158a0: 780d 0a20 2020 2020 2020 2020 2020 2069  x..            i
+000158b0: 6620 4e31 323a 0d0a 2020 2020 2020 2020  f N12:..        
+000158c0: 2020 2020 2020 2020 4b20 3d20 5f54 202f          K = _T /
+000158d0: 2f20 7365 6c66 2e44 202d 2028 4e6d 696e  / self.D - (Nmin
+000158e0: 202d 2031 2920 2023 204e 6d69 6e20 2d20   - 1)  # Nmin - 
+000158f0: 3120 3d20 323b 2069 2e65 2e20 3220 6d6f  1 = 2; i.e. 2 mo
+00015900: 7265 2066 6f72 2066 6972 7374 2073 6574  re for first set
+00015910: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00015920: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00015930: 2020 2020 204b 203d 205f 5420 2f2f 2028       K = _T // (
+00015940: 7365 6c66 2e44 202a 204e 6d69 6e29 0d0a  self.D * Nmin)..
+00015950: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015960: 2e4b 203d 206d 696e 284b 2c20 4b6d 6178  .K = min(K, Kmax
+00015970: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
+00015980: 2023 2065 6e73 7572 6520 554d 5220 3e3d   # ensure UMR >=
+00015990: 2052 0d0a 2020 2020 2020 2020 2020 2020   R..            
+000159a0: 6966 2073 656c 662e 5f61 6d62 6967 756f  if self._ambiguo
+000159b0: 7573 3a0d 0a20 2020 2020 2020 2020 2020  us:..           
+000159c0: 2020 2020 2069 6d69 6e20 3d20 6e70 2e61       imin = np.a
+000159d0: 7267 6d69 6e28 7365 6c66 2e5f 762c 2061  rgmin(self._v, a
+000159e0: 7869 733d 3029 0d0a 2020 2020 2020 2020  xis=0)..        
+000159f0: 2020 2020 2020 2020 7365 6c66 2e5f 765b          self._v[
+00015a00: 696d 696e 5d20 3d20 310d 0a0d 0a20 2020  imin] = 1....   
+00015a10: 2020 2020 2020 2020 2023 2074 7279 204e           # try N
+00015a20: 203e 3d20 4e67 6f6f 6420 3e3d 204e 6d69   >= Ngood >= Nmi
+00015a30: 6e0d 0a20 2020 2020 2020 2020 2020 204e  n..            N
+00015a40: 203d 206e 702e 656d 7074 7928 5b73 656c   = np.empty([sel
+00015a50: 662e 442c 2073 656c 662e 4b5d 2c20 696e  f.D, self.K], in
+00015a60: 7429 0d0a 2020 2020 2020 2020 2020 2020  t)..            
+00015a70: 4e61 7667 203d 205f 5420 2f2f 2028 7365  Navg = _T // (se
+00015a80: 6c66 2e44 202a 2073 656c 662e 4b29 0d0a  lf.D * self.K)..
+00015a90: 2020 2020 2020 2020 2020 2020 6966 204e              if N
+00015aa0: 6176 6720 3c20 4e6d 696e 3a20 2023 2075  avg < Nmin:  # u
+00015ab0: 7365 204e 3132 0d0a 2020 2020 2020 2020  se N12..        
+00015ac0: 2020 2020 2020 2020 4e5b 3a2c 2030 5d20          N[:, 0] 
+00015ad0: 3d20 4e6d 696e 0d0a 2020 2020 2020 2020  = Nmin..        
+00015ae0: 2020 2020 2020 2020 4e62 6173 6520 3d20          Nbase = 
+00015af0: 285f 5420 2d20 7365 6c66 2e44 202a 204e  (_T - self.D * N
+00015b00: 6d69 6e29 202f 2f20 2873 656c 662e 4420  min) // (self.D 
+00015b10: 2a20 2873 656c 662e 4b20 2d20 3129 2920  * (self.K - 1)) 
+00015b20: 2023 2061 7474 656e 7469 6f6e 3a20 6966   # attention: if
+00015b30: 204b 203d 3d20 3120 2d3e 2044 203d 3d20   K == 1 -> D == 
+00015b40: 310d 0a20 2020 2020 2020 2020 2020 2020  1..             
+00015b50: 2020 204e 5b3a 2c20 313a 5d20 3d20 4e62     N[:, 1:] = Nb
+00015b60: 6173 650d 0a20 2020 2020 2020 2020 2020  ase..           
+00015b70: 2020 2020 2064 5420 3d20 5f54 202d 206e       dT = _T - n
+00015b80: 702e 7375 6d28 4e29 0d0a 2020 2020 2020  p.sum(N)..      
+00015b90: 2020 2020 2020 2020 2020 6966 2064 5420            if dT 
+00015ba0: 213d 2030 3a0d 0a20 2020 2020 2020 2020  != 0:..         
+00015bb0: 2020 2020 2020 2020 2020 206b 203d 2069             k = i
+00015bc0: 6e74 2864 5420 2f2f 2073 656c 662e 4429  nt(dT // self.D)
+00015bd0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015be0: 2020 2020 2020 4e5b 3a2c 2031 203a 206b        N[:, 1 : k
+00015bf0: 202b 2031 5d20 2b3d 2031 0d0a 2020 2020   + 1] += 1..    
+00015c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c10: 6966 2064 5420 2520 7365 6c66 2e44 2021  if dT % self.D !
+00015c20: 3d20 303a 0d0a 2020 2020 2020 2020 2020  = 0:..          
+00015c30: 2020 2020 2020 2020 2020 2020 2020 4e5b                N[
+00015c40: 302c 206b 202b 2031 5d20 2b3d 2031 0d0a  0, k + 1] += 1..
+00015c50: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00015c60: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00015c70: 2020 204e 5b2e 2e2e 5d20 3d20 4e61 7667     N[...] = Navg
+00015c80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015c90: 2020 6454 203d 205f 5420 2d20 6e70 2e73    dT = _T - np.s
+00015ca0: 756d 284e 290d 0a20 2020 2020 2020 2020  um(N)..         
+00015cb0: 2020 2020 2020 2069 6620 6454 2021 3d20         if dT != 
+00015cc0: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
+00015cd0: 2020 2020 2020 2020 6b20 3d20 696e 7428          k = int(
+00015ce0: 6454 202f 2f20 7365 6c66 2e44 290d 0a20  dT // self.D).. 
+00015cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d00: 2020 204e 5b3a 2c20 3a6b 5d20 2b3d 2031     N[:, :k] += 1
+00015d10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015d20: 2020 2020 2020 6966 2064 5420 2520 7365        if dT % se
+00015d30: 6c66 2e44 2021 3d20 303a 0d0a 2020 2020  lf.D != 0:..    
+00015d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d50: 2020 2020 6420 3d20 6454 2025 2073 656c      d = dT % sel
+00015d60: 662e 440d 0a20 2020 2020 2020 2020 2020  f.D..           
+00015d70: 2020 2020 2020 2020 2020 2020 204e 5b3a               N[:
+00015d80: 642c 206b 5d20 2b3d 2031 0d0a 2020 2020  d, k] += 1..    
+00015d90: 2020 2020 2020 2020 7365 6c66 2e4e 203d          self.N =
+00015da0: 204e 0d0a 0d0a 2020 2020 4070 726f 7065   N....    @prope
+00015db0: 7274 790d 0a20 2020 2064 6566 2059 2873  rty..    def Y(s
+00015dc0: 656c 6629 202d 3e20 696e 743a 0d0a 2020  elf) -> int:..  
+00015dd0: 2020 2020 2020 2222 2248 6569 6768 7420        """Height 
+00015de0: 6f66 2066 7269 6e67 6520 7061 7474 6572  of fringe patter
+00015df0: 6e73 2e0d 0a20 2020 2020 2020 205b 595d  ns...        [Y]
+00015e00: 203d 2070 782e 2222 220d 0a20 2020 2020   = px."""..     
+00015e10: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00015e20: 590d 0a0d 0a20 2020 2040 592e 7365 7474  Y....    @Y.sett
+00015e30: 6572 0d0a 2020 2020 6465 6620 5928 7365  er..    def Y(se
+00015e40: 6c66 2c20 593a 2069 6e74 293a 0d0a 2020  lf, Y: int):..  
+00015e50: 2020 2020 2020 5f59 203d 2069 6e74 286d        _Y = int(m
+00015e60: 696e 286d 6178 2831 2c20 5929 2c20 7365  in(max(1, Y), se
+00015e70: 6c66 2e5f 596d 6178 2c20 7365 6c66 2e5f  lf._Ymax, self._
+00015e80: 506d 6178 202f 2073 656c 662e 5829 290d  Pmax / self.X)).
+00015e90: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
+00015ea0: 6c66 2e5f 5920 213d 205f 593a 0d0a 2020  lf._Y != _Y:..  
+00015eb0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00015ec0: 5920 3d20 5f59 0d0a 2020 2020 2020 2020  Y = _Y..        
+00015ed0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+00015ee0: 6728 6622 7b73 656c 662e 5f59 203d 207d  g(f"{self._Y = }
+00015ef0: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+00015f00: 7365 6c66 2e5f 554d 5220 3d20 4e6f 6e65  self._UMR = None
+00015f10: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00015f20: 6966 2073 656c 662e 5f58 203d 3d20 7365  if self._X == se
+00015f30: 6c66 2e5f 5920 3d3d 2031 3a0d 0a20 2020  lf._Y == 1:..   
+00015f40: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00015f50: 662e 4420 3d20 310d 0a20 2020 2020 2020  f.D = 1..       
+00015f60: 2020 2020 2020 2020 2073 656c 662e 6178           self.ax
+00015f70: 6973 203d 2030 0d0a 2020 2020 2020 2020  is = 0..        
+00015f80: 2020 2020 656c 6966 2073 656c 662e 5f58      elif self._X
+00015f90: 203d 3d20 313a 0d0a 2020 2020 2020 2020   == 1:..        
+00015fa0: 2020 2020 2020 2020 7365 6c66 2e44 203d          self.D =
+00015fb0: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
+00015fc0: 2020 2020 7365 6c66 2e61 7869 7320 3d20      self.axis = 
+00015fd0: 310d 0a20 2020 2020 2020 2020 2020 2065  1..            e
+00015fe0: 6c69 6620 7365 6c66 2e5f 5920 3d3d 2031  lif self._Y == 1
+00015ff0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00016000: 2020 2073 656c 662e 4420 3d20 310d 0a20     self.D = 1.. 
+00016010: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016020: 656c 662e 6178 6973 203d 2030 0d0a 0d0a  elf.axis = 0....
+00016030: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+00016040: 2020 2064 6566 2058 2873 656c 663a 2069     def X(self: i
+00016050: 6e74 2920 2d3e 2069 6e74 3a0d 0a20 2020  nt) -> int:..   
+00016060: 2020 2020 2022 2222 5769 6474 6820 6f66       """Width of
+00016070: 2066 7269 6e67 6520 7061 7474 6572 6e73   fringe patterns
+00016080: 2e0d 0a20 2020 2020 2020 205b 585d 203d  ...        [X] =
+00016090: 2070 782e 2222 220d 0a20 2020 2020 2020   px."""..       
+000160a0: 2072 6574 7572 6e20 7365 6c66 2e5f 580d   return self._X.
+000160b0: 0a0d 0a20 2020 2040 582e 7365 7474 6572  ...    @X.setter
+000160c0: 0d0a 2020 2020 6465 6620 5828 7365 6c66  ..    def X(self
+000160d0: 2c20 583a 2069 6e74 293a 0d0a 2020 2020  , X: int):..    
+000160e0: 2020 2020 5f58 203d 2069 6e74 286d 696e      _X = int(min
+000160f0: 286d 6178 2831 2c20 5829 2c20 7365 6c66  (max(1, X), self
+00016100: 2e5f 586d 6178 2c20 7365 6c66 2e5f 506d  ._Xmax, self._Pm
+00016110: 6178 202f 2073 656c 662e 5929 290d 0a0d  ax / self.Y))...
+00016120: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00016130: 2e5f 5820 213d 205f 583a 0d0a 2020 2020  ._X != _X:..    
+00016140: 2020 2020 2020 2020 7365 6c66 2e5f 5820          self._X 
+00016150: 3d20 5f58 0d0a 2020 2020 2020 2020 2020  = _X..          
+00016160: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+00016170: 6622 7b73 656c 662e 5f58 203d 207d 2229  f"{self._X = }")
+00016180: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00016190: 6c66 2e5f 554d 5220 3d20 4e6f 6e65 0d0a  lf._UMR = None..
+000161a0: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000161b0: 2073 656c 662e 5f58 203d 3d20 7365 6c66   self._X == self
+000161c0: 2e5f 5920 3d3d 2031 3a0d 0a20 2020 2020  ._Y == 1:..     
+000161d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000161e0: 4420 3d20 310d 0a20 2020 2020 2020 2020  D = 1..         
+000161f0: 2020 2020 2020 2073 656c 662e 6178 6973         self.axis
+00016200: 203d 2030 0d0a 2020 2020 2020 2020 2020   = 0..          
+00016210: 2020 656c 6966 2073 656c 662e 5f58 203d    elif self._X =
+00016220: 3d20 313a 0d0a 2020 2020 2020 2020 2020  = 1:..          
+00016230: 2020 2020 2020 7365 6c66 2e44 203d 2031        self.D = 1
+00016240: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00016250: 2020 7365 6c66 2e61 7869 7320 3d20 310d    self.axis = 1.
+00016260: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00016270: 6620 7365 6c66 2e5f 5920 3d3d 2031 3a0d  f self._Y == 1:.
+00016280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016290: 2073 656c 662e 4420 3d20 310d 0a20 2020   self.D = 1..   
+000162a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000162b0: 662e 6178 6973 203d 2030 0d0a 0d0a 2020  f.axis = 0....  
+000162c0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+000162d0: 2064 6566 2043 2873 656c 6629 202d 3e20   def C(self) -> 
+000162e0: 696e 743a 0d0a 2020 2020 2020 2020 2222  int:..        ""
+000162f0: 224e 756d 6265 7220 6f66 2063 6f6c 6f72  "Number of color
+00016300: 2063 6861 6e6e 656c 732e 2222 220d 0a20   channels.""".. 
+00016310: 2020 2020 2020 2072 6574 7572 6e20 3320         return 3 
+00016320: 6966 2073 656c 662e 5744 4d20 6f72 206e  if self.WDM or n
+00016330: 6f74 2073 656c 662e 5f6d 6f6e 6f63 6872  ot self._monochr
+00016340: 6f6d 6520 656c 7365 2031 0d0a 0d0a 2020  ome else 1....  
+00016350: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00016360: 2064 6566 2052 2873 656c 6629 202d 3e20   def R(self) -> 
+00016370: 6e70 2e6e 6461 7272 6179 3a0d 0a20 2020  np.ndarray:..   
+00016380: 2020 2020 2022 2222 4c65 6e67 7468 7320       """Lengths 
+00016390: 6f66 2066 7269 6e67 6520 7061 7474 6572  of fringe patter
+000163a0: 6e73 2066 6f72 2065 6163 6820 6469 7265  ns for each dire
+000163b0: 6374 696f 6e2e 0d0a 2020 2020 2020 2020  ction...        
+000163c0: 5b52 5d20 3d20 7078 2e22 2222 0d0a 0d0a  [R] = px."""....
+000163d0: 2020 2020 2020 2020 5220 3d20 6e70 2e61          R = np.a
+000163e0: 7272 6179 285b 7365 6c66 2e58 2c20 7365  rray([self.X, se
+000163f0: 6c66 2e59 5d29 0d0a 0d0a 2020 2020 2020  lf.Y])....      
+00016400: 2020 6966 2073 656c 662e 696e 6465 7869    if self.indexi
+00016410: 6e67 203d 3d20 2269 6a22 3a0d 0a20 2020  ng == "ij":..   
+00016420: 2020 2020 2020 2020 2052 203d 2052 5b3a           R = R[:
+00016430: 3a2d 315d 0d0a 0d0a 2020 2020 2020 2020  :-1]....        
+00016440: 6966 2073 656c 662e 4420 3d3d 2031 3a0d  if self.D == 1:.
+00016450: 0a20 2020 2020 2020 2020 2020 2052 203d  .            R =
+00016460: 206e 702e 6174 6c65 6173 745f 3164 2852   np.atleast_1d(R
+00016470: 5b73 656c 662e 6178 6973 5d29 0d0a 0d0a  [self.axis])....
+00016480: 2020 2020 2020 2020 7265 7475 726e 2052          return R
+00016490: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+000164a0: 790d 0a20 2020 2064 6566 2061 6c70 6861  y..    def alpha
+000164b0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+000164c0: 0d0a 2020 2020 2020 2020 2222 2246 6163  ..        """Fac
+000164d0: 746f 7220 666f 7220 6578 7465 6e64 696e  tor for extendin
+000164e0: 6720 7468 6520 636f 6469 6e67 2072 616e  g the coding ran
+000164f0: 6765 2060 4c60 2e22 2222 0d0a 2020 2020  ge `L`."""..    
+00016500: 2020 2020 2320 616c 7068 6120 3d20 666c      # alpha = fl
+00016510: 6f61 7428 3120 2b20 3220 2a20 7830 202f  oat(1 + 2 * x0 /
+00016520: 206e 702e 6d61 7828 7365 6c66 2e52 2929   np.max(self.R))
+00016530: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00016540: 2073 656c 662e 5f61 6c70 6861 0d0a 0d0a   self._alpha....
+00016550: 2020 2020 4061 6c70 6861 2e73 6574 7465      @alpha.sette
+00016560: 720d 0a20 2020 2064 6566 2061 6c70 6861  r..    def alpha
+00016570: 2873 656c 662c 2061 6c70 6861 3a20 666c  (self, alpha: fl
+00016580: 6f61 7429 3a0d 0a20 2020 2020 2020 205f  oat):..        _
+00016590: 616c 7068 6120 3d20 666c 6f61 7428 6d69  alpha = float(mi
+000165a0: 6e28 6d61 7828 312c 2061 6c70 6861 292c  n(max(1, alpha),
+000165b0: 2073 656c 662e 5f61 6c70 6861 6d61 7829   self._alphamax)
+000165c0: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
+000165d0: 7365 6c66 2e5f 616c 7068 6120 213d 205f  self._alpha != _
+000165e0: 616c 7068 613a 0d0a 2020 2020 2020 2020  alpha:..        
+000165f0: 2020 2020 7365 6c66 2e5f 616c 7068 6120      self._alpha 
+00016600: 3d20 5f61 6c70 6861 0d0a 2020 2020 2020  = _alpha..      
+00016610: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00016620: 6275 6728 6622 7b73 656c 662e 5f61 6c70  bug(f"{self._alp
+00016630: 6861 203d 207d 2229 0d0a 2020 2020 2020  ha = }")..      
+00016640: 2020 2020 2020 7365 6c66 2e5f 554d 5220        self._UMR 
+00016650: 3d20 4e6f 6e65 0d0a 0d0a 2020 2020 4070  = None....    @p
+00016660: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
+00016670: 2078 3028 7365 6c66 2920 2d3e 2066 6c6f   x0(self) -> flo
+00016680: 6174 3a0d 0a20 2020 2020 2020 2022 2222  at:..        """
+00016690: 436f 6f72 6469 6e61 7465 206f 6666 7365  Coordinate offse
+000166a0: 742e 2222 220d 0a20 2020 2020 2020 2023  t."""..        #
+000166b0: 2074 6f64 6f3a 2078 302e 7365 7474 6572   todo: x0.setter
+000166c0: 202d 3e20 7570 6461 7465 2061 6c70 6861   -> update alpha
+000166d0: 0d0a 2020 2020 2020 2020 2320 2078 306d  ..        #  x0m
+000166e0: 6178 203d 206e 702e 6d69 6e28 7365 6c66  ax = np.min(self
+000166f0: 2e6c 290d 0a20 2020 2020 2020 2072 6574  .l)..        ret
+00016700: 7572 6e20 666c 6f61 7428 6e70 2e6d 6178  urn float(np.max
+00016710: 2873 656c 662e 5229 202a 2028 7365 6c66  (self.R) * (self
+00016720: 2e61 6c70 6861 202d 2031 2920 2f20 3229  .alpha - 1) / 2)
+00016730: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+00016740: 790d 0a20 2020 2064 6566 204c 2873 656c  y..    def L(sel
+00016750: 6629 202d 3e20 666c 6f61 743a 0d0a 2020  f) -> float:..  
+00016760: 2020 2020 2020 2222 2243 6f64 696e 6720        """Coding 
+00016770: 7261 6e67 652e 0d0a 2020 2020 2020 2020  range...        
+00016780: 5b4c 5d20 3d20 7078 2e22 2222 0d0a 2020  [L] = px."""..  
+00016790: 2020 2020 2020 7265 7475 726e 2066 6c6f        return flo
+000167a0: 6174 286e 702e 6d61 7828 7365 6c66 2e52  at(np.max(self.R
+000167b0: 2920 2a20 7365 6c66 2e61 6c70 6861 290d  ) * self.alpha).
+000167c0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+000167d0: 0d0a 2020 2020 6465 6620 6772 6964 2873  ..    def grid(s
+000167e0: 656c 6629 202d 3e20 7374 723a 0d0a 2020  elf) -> str:..  
+000167f0: 2020 2020 2020 2222 2243 6f6f 7264 696e        """Coordin
+00016800: 6174 6520 7379 7374 656d 206f 6620 7468  ate system of th
+00016810: 6520 6672 696e 6765 2070 6174 7465 726e  e fringe pattern
+00016820: 732e 0d0a 0d0a 2020 2020 2020 2020 5468  s.....        Th
+00016830: 6520 666f 6c6c 6f77 696e 6720 7661 6c75  e following valu
+00016840: 6573 2063 616e 2062 6520 7365 743a 5c6e  es can be set:\n
+00016850: 0d0a 2020 2020 2020 2020 2769 6d61 6765  ..        'image
+00016860: 273a 2020 2020 2054 6865 2074 6f70 206c  ':     The top l
+00016870: 6566 7420 636f 726e 6572 2070 6978 656c  eft corner pixel
+00016880: 206f 6620 7468 6520 6772 6964 2069 7320   of the grid is 
+00016890: 7468 6520 6f72 6967 696e 2061 6e64 2070  the origin and p
+000168a0: 6f73 6974 6976 6520 6469 7265 6374 696f  ositive directio
+000168b0: 6e73 2061 7265 2072 6967 6874 2d20 7265  ns are right- re
+000168c0: 7370 2e20 646f 776e 7761 7264 732e 5c6e  sp. downwards.\n
+000168d0: 0d0a 2020 2020 2020 2020 2743 6172 7465  ..        'Carte
+000168e0: 7369 616e 273a 2054 6865 2063 656e 7465  sian': The cente
+000168f0: 7220 6f66 2067 7269 6420 6973 2074 6865  r of grid is the
+00016900: 206f 7269 6769 6e20 616e 6420 706f 7369   origin and posi
+00016910: 7469 7665 2064 6972 6563 7469 6f6e 7320  tive directions 
+00016920: 6172 6520 7269 6768 742d 2072 6573 702e  are right- resp.
+00016930: 2075 7077 6172 6473 2e5c 6e0d 0a20 2020   upwards.\n..   
+00016940: 2020 2020 2027 706f 6c61 7227 3a20 2020       'polar':   
+00016950: 2020 5468 6520 6365 6e74 6572 206f 6620    The center of 
+00016960: 6772 6964 2069 7320 7468 6520 6f72 6967  grid is the orig
+00016970: 696e 2061 6e64 2070 6f73 6974 6976 6520  in and positive 
+00016980: 6469 7265 6374 696f 6e73 2061 7265 2063  directions are c
+00016990: 6c6f 636b 7769 7365 2072 6573 702e 206f  lockwise resp. o
+000169a0: 7574 7761 7264 732e 5c6e 0d0a 2020 2020  utwards.\n..    
+000169b0: 2020 2020 276c 6f67 2d70 6f6c 6172 273a      'log-polar':
+000169c0: 2054 6865 2063 656e 7465 7220 6f66 2067   The center of g
+000169d0: 7269 6420 6973 2074 6865 206f 7269 6769  rid is the origi
+000169e0: 6e20 616e 6420 706f 7369 7469 7665 2064  n and positive d
+000169f0: 6972 6563 7469 6f6e 7320 6172 6520 636c  irections are cl
+00016a00: 6f63 6b77 6973 6520 7265 7370 2e20 6f75  ockwise resp. ou
+00016a10: 7477 6172 6473 2e0d 0a20 2020 2020 2020  twards...       
+00016a20: 2022 2222 0d0a 2020 2020 2020 2020 7265   """..        re
+00016a30: 7475 726e 2073 656c 662e 5f67 7269 640d  turn self._grid.
+00016a40: 0a0d 0a20 2020 2040 6772 6964 2e73 6574  ...    @grid.set
+00016a50: 7465 720d 0a20 2020 2064 6566 2067 7269  ter..    def gri
+00016a60: 6428 7365 6c66 2c20 6772 6964 3a20 7374  d(self, grid: st
+00016a70: 7229 3a0d 0a20 2020 2020 2020 205f 6772  r):..        _gr
+00016a80: 6964 203d 2073 7472 2867 7269 6429 0d0a  id = str(grid)..
+00016a90: 0d0a 2020 2020 2020 2020 6966 2028 7365  ..        if (se
+00016aa0: 6c66 2e53 444d 206f 7220 7365 6c66 2e75  lf.SDM or self.u
+00016ab0: 7772 203d 3d20 2246 544d 2229 2061 6e64  wr == "FTM") and
+00016ac0: 2073 656c 662e 6772 6964 206e 6f74 2069   self.grid not i
+00016ad0: 6e20 7365 6c66 2e5f 6772 6964 735b 3a32  n self._grids[:2
+00016ae0: 5d3a 0d0a 2020 2020 2020 2020 2020 2020  ]:..            
+00016af0: 6c6f 6767 696e 672e 6572 726f 7228 6622  logging.error(f"
+00016b00: 436f 756c 646e 2774 2073 6574 2027 6772  Couldn't set 'gr
+00016b10: 6964 273a 2067 7269 6420 6e6f 7420 696e  id': grid not in
+00016b20: 207b 7365 6c66 2e5f 6772 6964 735b 3a32   {self._grids[:2
+00016b30: 5d7d 272e 2229 0d0a 2020 2020 2020 2020  ]}'.")..        
+00016b40: 2020 2020 7265 7475 726e 0d0a 0d0a 2020      return....  
+00016b50: 2020 2020 2020 6966 2073 656c 662e 5f67        if self._g
+00016b60: 7269 6420 213d 205f 6772 6964 2061 6e64  rid != _grid and
+00016b70: 205f 6772 6964 2069 6e20 7365 6c66 2e5f   _grid in self._
+00016b80: 6772 6964 733a 0d0a 2020 2020 2020 2020  grids:..        
+00016b90: 2020 2020 7365 6c66 2e5f 6772 6964 203d      self._grid =
+00016ba0: 205f 6772 6964 0d0a 2020 2020 2020 2020   _grid..        
+00016bb0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+00016bc0: 6728 6622 7b73 656c 662e 5f67 7269 6420  g(f"{self._grid 
+00016bd0: 3d20 7d22 290d 0a20 2020 2020 2020 2020  = }")..         
+00016be0: 2020 2073 656c 662e 5344 4d20 3d20 7365     self.SDM = se
+00016bf0: 6c66 2e53 444d 0d0a 0d0a 2020 2020 4070  lf.SDM....    @p
+00016c00: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
+00016c10: 2061 6e67 6c65 2873 656c 6629 202d 3e20   angle(self) -> 
+00016c20: 666c 6f61 743a 0d0a 2020 2020 2020 2020  float:..        
+00016c30: 2222 2241 6e67 6c65 206f 6620 7468 6520  """Angle of the 
+00016c40: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
+00016c50: 6d27 7320 7072 696e 6369 7061 6c20 6178  m's principal ax
+00016c60: 6973 2e22 2222 0d0a 2020 2020 2020 2020  is."""..        
+00016c70: 7265 7475 726e 2073 656c 662e 5f61 6e67  return self._ang
+00016c80: 6c65 0d0a 0d0a 2020 2020 4061 6e67 6c65  le....    @angle
+00016c90: 2e73 6574 7465 720d 0a20 2020 2064 6566  .setter..    def
+00016ca0: 2061 6e67 6c65 2873 656c 662c 2061 6e67   angle(self, ang
+00016cb0: 6c65 3a20 666c 6f61 7429 3a0d 0a20 2020  le: float):..   
+00016cc0: 2020 2020 205f 616e 676c 6520 3d20 666c       _angle = fl
+00016cd0: 6f61 7428 6e70 2e72 656d 6169 6e64 6572  oat(np.remainder
+00016ce0: 2861 6e67 6c65 2c20 3336 3029 2920 2023  (angle, 360))  #
+00016cf0: 2074 6f64 6f3a 202b 2d20 3435 0d0a 0d0a   todo: +- 45....
+00016d00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00016d10: 5f61 6e67 6c65 2021 3d20 5f61 6e67 6c65  _angle != _angle
+00016d20: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
+00016d30: 656c 662e 5f61 6e67 6c65 203d 205f 616e  elf._angle = _an
+00016d40: 676c 650d 0a20 2020 2020 2020 2020 2020  gle..           
+00016d50: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+00016d60: 227b 7365 6c66 2e5f 616e 676c 6520 3d20  "{self._angle = 
+00016d70: 7d22 290d 0a0d 0a20 2020 2040 7072 6f70  }")....    @prop
+00016d80: 6572 7479 0d0a 2020 2020 6465 6620 4428  erty..    def D(
+00016d90: 7365 6c66 2920 2d3e 2069 6e74 3a0d 0a20  self) -> int:.. 
+00016da0: 2020 2020 2020 2022 2222 4e75 6d62 6572         """Number
+00016db0: 206f 6620 6469 7265 6374 696f 6e73 2e22   of directions."
+00016dc0: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
+00016dd0: 726e 2073 656c 662e 5f44 0d0a 0d0a 2020  rn self._D....  
+00016de0: 2020 4044 2e73 6574 7465 720d 0a20 2020    @D.setter..   
+00016df0: 2064 6566 2044 2873 656c 662c 2044 3a20   def D(self, D: 
+00016e00: 696e 7429 3a0d 0a20 2020 2020 2020 205f  int):..        _
+00016e10: 4420 3d20 696e 7428 6d69 6e28 6d61 7828  D = int(min(max(
+00016e20: 312c 2044 292c 2073 656c 662e 5f44 6d61  1, D), self._Dma
+00016e30: 7829 290d 0a0d 0a20 2020 2020 2020 2069  x))....        i
+00016e40: 6620 7365 6c66 2e5f 4420 3e20 5f44 3a0d  f self._D > _D:.
+00016e50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00016e60: 662e 5f44 203d 205f 440d 0a20 2020 2020  f._D = _D..     
+00016e70: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00016e80: 6562 7567 2866 227b 7365 6c66 2e5f 4420  ebug(f"{self._D 
+00016e90: 3d20 7d22 290d 0a0d 0a20 2020 2020 2020  = }")....       
+00016ea0: 2020 2020 2073 656c 662e 4e20 3d20 7365       self.N = se
+00016eb0: 6c66 2e5f 4e5b 3a20 7365 6c66 2e44 2c20  lf._N[: self.D, 
+00016ec0: 3a5d 0d0a 2020 2020 2020 2020 2020 2020  :]..            
+00016ed0: 7365 6c66 2e76 203d 2073 656c 662e 5f76  self.v = self._v
+00016ee0: 5b3a 2073 656c 662e 442c 203a 5d0d 0a20  [: self.D, :].. 
+00016ef0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016f00: 6620 3d20 7365 6c66 2e5f 665b 3a20 7365  f = self._f[: se
+00016f10: 6c66 2e44 2c20 3a5d 0d0a 0d0a 2020 2020  lf.D, :]....    
+00016f20: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00016f30: 5f44 203d 3d20 7365 6c66 2e5f 4b20 3d3d  _D == self._K ==
+00016f40: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
+00016f50: 2020 2020 2073 656c 662e 4644 4d20 3d20       self.FDM = 
+00016f60: 4661 6c73 650d 0a0d 0a20 2020 2020 2020  False....       
+00016f70: 2020 2020 2073 656c 662e 5344 4d20 3d20       self.SDM = 
+00016f80: 4661 6c73 650d 0a20 2020 2020 2020 2065  False..        e
+00016f90: 6c69 6620 7365 6c66 2e5f 4420 3c20 5f44  lif self._D < _D
+00016fa0: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
+00016fb0: 656c 662e 5f44 203d 205f 440d 0a20 2020  elf._D = _D..   
+00016fc0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+00016fd0: 2e64 6562 7567 2866 227b 7365 6c66 2e5f  .debug(f"{self._
+00016fe0: 4420 3d20 7d22 290d 0a0d 0a20 2020 2020  D = }")....     
+00016ff0: 2020 2020 2020 2073 656c 662e 4e20 3d20         self.N = 
+00017000: 6e70 2e61 7070 656e 6428 7365 6c66 2e5f  np.append(self._
+00017010: 4e2c 206e 702e 7469 6c65 2873 656c 662e  N, np.tile(self.
+00017020: 5f4e 5b2d 312c 203a 5d2c 2028 5f44 202d  _N[-1, :], (_D -
+00017030: 2073 656c 662e 5f4e 2e73 6861 7065 5b30   self._N.shape[0
+00017040: 5d2c 2031 2929 2c20 6178 6973 3d30 290d  ], 1)), axis=0).
+00017050: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00017060: 662e 7620 3d20 6e70 2e61 7070 656e 6428  f.v = np.append(
+00017070: 7365 6c66 2e5f 762c 206e 702e 7469 6c65  self._v, np.tile
+00017080: 2873 656c 662e 5f76 5b2d 312c 203a 5d2c  (self._v[-1, :],
+00017090: 2028 5f44 202d 2073 656c 662e 5f76 2e73   (_D - self._v.s
+000170a0: 6861 7065 5b30 5d2c 2031 2929 2c20 6178  hape[0], 1)), ax
+000170b0: 6973 3d30 290d 0a20 2020 2020 2020 2020  is=0)..         
+000170c0: 2020 2073 656c 662e 6620 3d20 6e70 2e61     self.f = np.a
+000170d0: 7070 656e 6428 7365 6c66 2e5f 662c 206e  ppend(self._f, n
+000170e0: 702e 7469 6c65 2873 656c 662e 5f66 5b2d  p.tile(self._f[-
+000170f0: 312c 203a 5d2c 2028 5f44 202d 2073 656c  1, :], (_D - sel
+00017100: 662e 5f66 2e73 6861 7065 5b30 5d2c 2031  f._f.shape[0], 1
+00017110: 2929 2c20 6178 6973 3d30 290d 0a0d 0a20  )), axis=0).... 
+00017120: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017130: 4220 3d20 7365 6c66 2e42 0d0a 0d0a 2020  B = self.B....  
+00017140: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00017150: 2064 6566 2061 7869 7328 7365 6c66 2920   def axis(self) 
+00017160: 2d3e 2069 6e74 3a0d 0a20 2020 2020 2020  -> int:..       
+00017170: 2022 2222 4178 6973 2061 6c6f 6e67 2077   """Axis along w
+00017180: 6869 6368 2074 6f20 7368 6966 7420 6966  hich to shift if
+00017190: 206e 756d 6265 7220 6f66 2064 6972 6563   number of direc
+000171a0: 7469 6f6e 7320 6571 7561 6c73 206f 6e65  tions equals one
+000171b0: 2e0d 0a0d 0a20 2020 2020 2020 2045 6974  .....        Eit
+000171c0: 6865 7220 6030 6020 6f72 2060 3160 2e22  her `0` or `1`."
+000171d0: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
+000171e0: 726e 2073 656c 662e 5f61 7869 730d 0a0d  rn self._axis...
+000171f0: 0a20 2020 2040 6178 6973 2e73 6574 7465  .    @axis.sette
+00017200: 720d 0a20 2020 2064 6566 2061 7869 7328  r..    def axis(
+00017210: 7365 6c66 2c20 6178 6973 3a20 696e 7429  self, axis: int)
+00017220: 3a0d 0a20 2020 2020 2020 205f 6178 6973  :..        _axis
+00017230: 203d 2069 6e74 286d 696e 286d 6178 2830   = int(min(max(0
+00017240: 2c20 6178 6973 292c 2031 2929 0d0a 0d0a  , axis), 1))....
+00017250: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00017260: 5f61 7869 7320 213d 205f 6178 6973 3a0d  _axis != _axis:.
+00017270: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00017280: 662e 5f61 7869 7320 3d20 5f61 7869 730d  f._axis = _axis.
+00017290: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000172a0: 6769 6e67 2e64 6562 7567 2866 227b 7365  ging.debug(f"{se
+000172b0: 6c66 2e5f 6178 6973 203d 207d 2229 0d0a  lf._axis = }")..
+000172c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000172d0: 2e5f 554d 5220 3d20 4e6f 6e65 0d0a 0d0a  ._UMR = None....
+000172e0: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+000172f0: 2020 2064 6566 205f 4d28 7365 6c66 2920     def _M(self) 
+00017300: 2d3e 206e 702e 6e64 6172 7261 793a 0d0a  -> np.ndarray:..
+00017310: 2020 2020 2020 2020 2222 224e 756d 6265          """Numbe
+00017320: 7220 6f66 2061 7665 7261 6765 6420 696e  r of averaged in
+00017330: 7465 6e73 6974 7920 7361 6d70 6c65 732e  tensity samples.
+00017340: 2222 220d 0a20 2020 2020 2020 204d 203d  """..        M =
+00017350: 206e 702e 7375 6d28 7365 6c66 2e68 2c20   np.sum(self.h, 
+00017360: 6178 6973 3d30 2920 2f20 3235 350d 0a20  axis=0) / 255.. 
+00017370: 2020 2020 2020 2072 6574 7572 6e20 6e70         return np
+00017380: 2e61 746c 6561 7374 5f31 6428 4d5b 305d  .atleast_1d(M[0]
+00017390: 2920 6966 2073 656c 662e 5f6d 6f6e 6f63  ) if self._monoc
+000173a0: 6872 6f6d 6520 656c 7365 204d 0d0a 0d0a  hrome else M....
+000173b0: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+000173c0: 2020 2064 6566 204d 2873 656c 6629 202d     def M(self) -
+000173d0: 3e20 666c 6f61 743a 2020 2320 746f 646f  > float:  # todo
+000173e0: 3a20 2d3e 206e 702e 6e64 6172 7261 793a  : -> np.ndarray:
+000173f0: 0d0a 2020 2020 2020 2020 2222 224e 756d  ..        """Num
+00017400: 6265 7220 6f66 2061 7665 7261 6765 6420  ber of averaged 
+00017410: 696e 7465 6e73 6974 7920 7361 6d70 6c65  intensity sample
+00017420: 732e 2222 220d 0a20 2020 2020 2020 204d  s."""..        M
+00017430: 203d 206d 6178 2831 202f 2032 3535 2c20   = max(1 / 255, 
+00017440: 6e70 2e72 696e 7428 6e70 2e6d 6561 6e28  np.rint(np.mean(
+00017450: 7365 6c66 2e5f 4d29 2929 2020 2320 746f  self._M)))  # to
+00017460: 646f 0d0a 2020 2020 2020 2020 7265 7475  do..        retu
+00017470: 726e 2066 6c6f 6174 284d 2920 2023 2063  rn float(M)  # c
+00017480: 6f6e 7665 7274 204e 756d 7079 2066 6c6f  onvert Numpy flo
+00017490: 6174 3634 2074 6f20 5079 7468 6f6e 2066  at64 to Python f
+000174a0: 6c6f 6174 0d0a 0d0a 2020 2020 404d 2e73  loat....    @M.s
+000174b0: 6574 7465 720d 0a20 2020 2064 6566 204d  etter..    def M
+000174c0: 2873 656c 662c 204d 3a20 666c 6f61 7429  (self, M: float)
+000174d0: 3a0d 0a20 2020 2020 2020 205f 4d20 3d20  :..        _M = 
+000174e0: 6d69 6e28 6d61 7828 3120 2f20 3235 352c  min(max(1 / 255,
+000174f0: 204d 292c 2073 656c 662e 5f4d 6d61 7829   M), self._Mmax)
+00017500: 0d0a 0d0a 2020 2020 2020 2020 6966 206e  ....        if n
+00017510: 702e 616e 7928 7365 6c66 2e4d 2021 3d20  p.any(self.M != 
+00017520: 5f4d 293a 0d0a 2020 2020 2020 2020 2020  _M):..          
+00017530: 2020 6966 205f 4d20 3c20 313a 2020 2320    if _M < 1:  # 
+00017540: 6672 6163 7469 6f6e 616c 2070 6172 7420  fractional part 
+00017550: 6f6e 6c79 0d0a 2020 2020 2020 2020 2020  only..          
+00017560: 2020 2020 2020 6820 3d20 6e70 2e61 7272        h = np.arr
+00017570: 6179 285b 5b69 6e74 2832 3535 202a 205f  ay([[int(255 * _
+00017580: 4d20 2520 3235 3529 2066 6f72 2063 2069  M % 255) for c i
+00017590: 6e20 7261 6e67 6528 3329 5d5d 2c20 6e70  n range(3)]], np
+000175a0: 2e75 696e 7438 290d 0a20 2020 2020 2020  .uint8)..       
+000175b0: 2020 2020 2065 6c69 6620 5f4d 2025 2031       elif _M % 1
+000175c0: 203d 3d20 303a 2020 2320 696e 7465 6765   == 0:  # intege
+000175d0: 7220 7061 7274 206f 6e6c 790d 0a20 2020  r part only..   
+000175e0: 2020 2020 2020 2020 2020 2020 2068 203d               h =
+000175f0: 206e 702e 6172 7261 7928 5b5b 3235 352c   np.array([[255,
+00017600: 2032 3535 2c20 3235 355d 5d20 2a20 696e   255, 255]] * in
+00017610: 7428 5f4d 292c 206e 702e 7569 6e74 3829  t(_M), np.uint8)
+00017620: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00017630: 7365 3a20 2023 2069 6e74 6567 6572 2061  se:  # integer a
+00017640: 6e64 2066 7261 6374 696f 6e61 6c20 7061  nd fractional pa
+00017650: 7274 0d0a 2020 2020 2020 2020 2020 2020  rt..            
+00017660: 2020 2020 685f 696e 7420 3d20 6e70 2e61      h_int = np.a
+00017670: 7272 6179 285b 5b32 3535 2c20 3235 352c  rray([[255, 255,
+00017680: 2032 3535 5d5d 202a 2069 6e74 285f 4d29   255]] * int(_M)
+00017690: 2c20 6e70 2e75 696e 7438 290d 0a20 2020  , np.uint8)..   
+000176a0: 2020 2020 2020 2020 2020 2020 2068 5f66               h_f
+000176b0: 7261 6374 203d 206e 702e 6172 7261 7928  ract = np.array(
+000176c0: 5b5b 696e 7428 3235 3520 2a20 5f4d 2025  [[int(255 * _M %
+000176d0: 2032 3535 2920 666f 7220 6320 696e 2072   255) for c in r
+000176e0: 616e 6765 2833 295d 5d2c 206e 702e 7569  ange(3)]], np.ui
+000176f0: 6e74 3829 0d0a 2020 2020 2020 2020 2020  nt8)..          
+00017700: 2020 2020 2020 6820 3d20 6e70 2e63 6f6e        h = np.con
+00017710: 6361 7465 6e61 7465 2828 685f 696e 742c  catenate((h_int,
+00017720: 2068 5f66 7261 6374 2929 0d0a 0d0a 2020   h_fract))....  
+00017730: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+00017740: 203d 2068 0d0a 0d0a 2020 2020 4070 726f   = h....    @pro
+00017750: 7065 7274 790d 0a20 2020 2064 6566 2048  perty..    def H
+00017760: 2873 656c 6629 202d 3e20 696e 743a 0d0a  (self) -> int:..
+00017770: 2020 2020 2020 2020 2222 224e 756d 6265          """Numbe
+00017780: 7220 6f66 2068 7565 732e 2222 220d 0a20  r of hues.""".. 
+00017790: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000177a0: 6c66 2e68 2e73 6861 7065 5b30 5d0d 0a0d  lf.h.shape[0]...
+000177b0: 0a20 2020 2040 482e 7365 7474 6572 0d0a  .    @H.setter..
+000177c0: 2020 2020 6465 6620 4828 7365 6c66 2c20      def H(self, 
+000177d0: 483a 2069 6e74 293a 0d0a 2020 2020 2020  H: int):..      
+000177e0: 2020 5f48 203d 2069 6e74 286d 696e 286d    _H = int(min(m
+000177f0: 6178 2831 2c20 4829 2c20 7365 6c66 2e5f  ax(1, H), self._
+00017800: 486d 6178 2929 0d0a 0d0a 2020 2020 2020  Hmax))....      
+00017810: 2020 2320 6966 2073 656c 662e 5744 4d3a    # if self.WDM:
+00017820: 0d0a 2020 2020 2020 2020 2320 2020 2020  ..        #     
+00017830: 6c6f 6767 696e 672e 6572 726f 7228 2243  logging.error("C
+00017840: 6f75 6c64 6e27 7420 7365 7420 2748 273a  ouldn't set 'H':
+00017850: 2057 444d 2069 7320 6163 7469 7665 2e22   WDM is active."
+00017860: 290d 0a20 2020 2020 2020 2023 2020 2020  )..        #    
+00017870: 2072 6574 7572 6e0d 0a0d 0a20 2020 2020   return....     
+00017880: 2020 2069 6620 7365 6c66 2e48 2021 3d20     if self.H != 
+00017890: 5f48 3a0d 0a20 2020 2020 2020 2020 2020  _H:..           
+000178a0: 2069 6620 7365 6c66 2e57 444d 3a0d 0a20   if self.WDM:.. 
+000178b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000178c0: 656c 662e 6820 3d20 2277 2220 2a20 5f48  elf.h = "w" * _H
+000178d0: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+000178e0: 6966 205f 4820 3d3d 2031 3a0d 0a20 2020  if _H == 1:..   
+000178f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00017900: 662e 6820 3d20 2277 220d 0a20 2020 2020  f.h = "w"..     
+00017910: 2020 2020 2020 2065 6c69 6620 5f48 203d         elif _H =
+00017920: 3d20 323a 0d0a 2020 2020 2020 2020 2020  = 2:..          
+00017930: 2020 2020 2020 7365 6c66 2e68 203d 2022        self.h = "
+00017940: 7262 2220 2023 2074 6f64 6f0d 0a20 2020  rb"  # todo..   
+00017950: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00017960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017970: 6820 3d20 2272 6762 2220 2a20 285f 4820  h = "rgb" * (_H 
+00017980: 2f2f 2033 202b 2031 290d 0a20 2020 2020  // 3 + 1)..     
+00017990: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000179a0: 6820 3d20 685b 3a5f 485d 0d0a 0d0a 2020  h = h[:_H]....  
+000179b0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+000179c0: 2064 6566 2068 2873 656c 6629 202d 3e20   def h(self) -> 
+000179d0: 6e70 2e6e 6461 7272 6179 3a0d 0a20 2020  np.ndarray:..   
+000179e0: 2020 2020 2022 2222 4875 6573 2069 2e65       """Hues i.e
+000179f0: 2e20 636f 6c6f 7273 206f 6620 6672 696e  . colors of frin
+00017a00: 6765 2070 6174 7465 726e 732e 0d0a 0d0a  ge patterns.....
+00017a10: 2020 2020 2020 2020 506f 7373 6962 6c65          Possible
+00017a20: 2076 616c 7565 7320 6172 6520 616e 7920   values are any 
+00017a30: 7365 7175 656e 6365 206f 6620 5247 4220  sequence of RGB 
+00017a40: 636f 6c6f 7220 7472 6970 6c65 7320 7769  color triples wi
+00017a50: 7468 696e 2074 6865 2069 6e74 6572 7661  thin the interva
+00017a60: 6c20 5b30 2c20 3235 355d 2e0d 0a20 2020  l [0, 255]...   
+00017a70: 2020 2020 2048 6f77 6576 6572 2c20 626c       However, bl
+00017a80: 6163 6b20 2830 2c20 302c 2030 2920 6973  ack (0, 0, 0) is
+00017a90: 206e 6f74 2061 6c6c 6f77 6564 2e0d 0a0d   not allowed....
+00017aa0: 0a20 2020 2020 2020 2054 6865 2068 7565  .        The hue
+00017ab0: 2076 616c 7565 7320 6361 6e20 616c 736f   values can also
+00017ac0: 2062 6520 7365 7420 6279 2061 7373 6967   be set by assig
+00017ad0: 6e69 6e67 2061 6e79 2063 6f6d 6269 6e61  ning any combina
+00017ae0: 7469 6f6e 206f 6620 7468 6520 666f 6c6c  tion of the foll
+00017af0: 6f77 696e 6720 6368 6172 6163 7465 7273  owing characters
+00017b00: 2061 7320 6120 7374 7269 6e67 3a5c 6e0d   as a string:\n.
+00017b10: 0a20 2020 2020 2020 202d 2027 7227 3a20  .        - 'r': 
+00017b20: 7265 6420 5c6e 0d0a 2020 2020 2020 2020  red \n..        
+00017b30: 2d20 2767 273a 2067 7265 656e 5c6e 0d0a  - 'g': green\n..
+00017b40: 2020 2020 2020 2020 2d20 2762 273a 2062          - 'b': b
+00017b50: 6c75 655c 6e0d 0a20 2020 2020 2020 202d  lue\n..        -
+00017b60: 2027 6327 3a20 6379 616e 5c6e 0d0a 2020   'c': cyan\n..  
+00017b70: 2020 2020 2020 2d20 276d 273a 206d 6167        - 'm': mag
+00017b80: 656e 7461 5c6e 0d0a 2020 2020 2020 2020  enta\n..        
+00017b90: 2d20 2779 273a 2079 656c 6c6f 775c 6e0d  - 'y': yellow\n.
+00017ba0: 0a20 2020 2020 2020 202d 2027 7727 3a20  .        - 'w': 
+00017bb0: 7768 6974 655c 6e0d 0a0d 0a20 2020 2020  white\n....     
+00017bc0: 2020 2042 6566 6f72 6520 6465 636f 6469     Before decodi
+00017bd0: 6e67 2c20 7265 7065 6174 696e 6720 6875  ng, repeating hu
+00017be0: 6573 2077 696c 6c20 6265 2066 7573 6564  es will be fused
+00017bf0: 2062 7920 6176 6572 6167 696e 672e 2222   by averaging.""
+00017c00: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+00017c10: 6e20 7365 6c66 2e5f 680d 0a0d 0a20 2020  n self._h....   
+00017c20: 2040 682e 7365 7474 6572 0d0a 2020 2020   @h.setter..    
+00017c30: 6465 6620 6828 7365 6c66 2c20 683a 2069  def h(self, h: i
+00017c40: 6e74 207c 2074 7570 6c65 5b69 6e74 5d20  nt | tuple[int] 
+00017c50: 7c20 6c69 7374 5b69 6e74 5d20 7c20 6e70  | list[int] | np
+00017c60: 2e6e 6461 7272 6179 207c 2073 7472 293a  .ndarray | str):
+00017c70: 0d0a 2020 2020 2020 2020 6966 2069 7369  ..        if isi
+00017c80: 6e73 7461 6e63 6528 682c 2073 7472 293a  nstance(h, str):
+00017c90: 0d0a 2020 2020 2020 2020 2020 2020 4c55  ..            LU
+00017ca0: 5420 3d20 7b0d 0a20 2020 2020 2020 2020  T = {..         
+00017cb0: 2020 2020 2020 2022 7222 3a20 5b32 3535         "r": [255
+00017cc0: 2c20 302c 2030 5d2c 0d0a 2020 2020 2020  , 0, 0],..      
+00017cd0: 2020 2020 2020 2020 2020 2267 223a 205b            "g": [
+00017ce0: 302c 2032 3535 2c20 305d 2c0d 0a20 2020  0, 255, 0],..   
+00017cf0: 2020 2020 2020 2020 2020 2020 2022 6222               "b"
+00017d00: 3a20 5b30 2c20 302c 2032 3535 5d2c 0d0a  : [0, 0, 255],..
+00017d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d20: 2263 223a 205b 302c 2032 3535 2c20 3235  "c": [0, 255, 25
+00017d30: 355d 2c0d 0a20 2020 2020 2020 2020 2020  5],..           
+00017d40: 2020 2020 2022 6d22 3a20 5b32 3535 2c20       "m": [255, 
+00017d50: 302c 2032 3535 5d2c 0d0a 2020 2020 2020  0, 255],..      
+00017d60: 2020 2020 2020 2020 2020 2279 223a 205b            "y": [
+00017d70: 3235 352c 2032 3535 2c20 305d 2c0d 0a20  255, 255, 0],.. 
+00017d80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00017d90: 7722 3a20 5b32 3535 2c20 3235 352c 2032  w": [255, 255, 2
+00017da0: 3535 5d2c 0d0a 2020 2020 2020 2020 2020  55],..          
+00017db0: 2020 7d0d 0a20 2020 2020 2020 2020 2020    }..           
+00017dc0: 2069 6620 7365 7428 682e 6c6f 7765 7228   if set(h.lower(
+00017dd0: 2929 2e69 6e74 6572 7365 6374 696f 6e28  )).intersection(
+00017de0: 4c55 542e 6b65 7973 2829 293a 0d0a 2020  LUT.keys()):..  
+00017df0: 2020 2020 2020 2020 2020 2020 2020 6820                h 
+00017e00: 3d20 5b4c 5554 5b63 5d20 666f 7220 6320  = [LUT[c] for c 
+00017e10: 696e 2068 2e6c 6f77 6572 2829 5d0d 0a20  in h.lower()].. 
+00017e20: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00017e30: 6820 3d3d 2022 6465 6661 756c 7422 3a0d  h == "default":.
+00017e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017e50: 2068 203d 2073 656c 662e 6465 6661 756c   h = self.defaul
+00017e60: 7473 5b22 6822 5d0d 0a20 2020 2020 2020  ts["h"]..       
+00017e70: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00017e80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00017e90: 726e 0d0a 0d0a 2020 2020 2020 2020 2320  rn....        # 
+00017ea0: 6d61 6b65 2061 7272 6179 2c20 636c 6970  make array, clip
+00017eb0: 2066 6972 7374 2061 6e64 2074 6865 6e20   first and then 
+00017ec0: 6361 7374 2074 6f20 6474 7970 6520 746f  cast to dtype to
+00017ed0: 2061 766f 6964 2069 6e74 6567 6572 2075   avoid integer u
+00017ee0: 6e64 6572 2d2f 6f76 6572 666c 6f77 0d0a  nder-/overflow..
+00017ef0: 2020 2020 2020 2020 5f68 203d 206e 702e          _h = np.
+00017f00: 6172 7261 7928 6829 2e63 6c69 7028 302c  array(h).clip(0,
+00017f10: 2032 3535 292e 6173 7479 7065 2822 7569   255).astype("ui
+00017f20: 6e74 3822 2c20 636f 7079 3d46 616c 7365  nt8", copy=False
+00017f30: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
+00017f40: 6e6f 7420 5f68 2e73 697a 653a 2020 2320  not _h.size:  # 
+00017f50: 656d 7074 7920 6172 7261 790d 0a20 2020  empty array..   
+00017f60: 2020 2020 2020 2020 2072 6574 7572 6e0d           return.
+00017f70: 0a0d 0a20 2020 2020 2020 2023 2074 7269  ...        # tri
+00017f80: 6d3a 2063 6861 6e67 6520 7368 6170 6520  m: change shape 
+00017f90: 746f 2028 482c 2033 2920 6f72 206c 696d  to (H, 3) or lim
+00017fa0: 6974 2073 6861 7065 0d0a 2020 2020 2020  it shape..      
+00017fb0: 2020 6966 205f 682e 6e64 696d 203d 3d20    if _h.ndim == 
+00017fc0: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
+00017fd0: 5f68 203d 206e 702e 6675 6c6c 2828 7365  _h = np.full((se
+00017fe0: 6c66 2e48 2c20 3329 2c20 5f68 290d 0a20  lf.H, 3), _h).. 
+00017ff0: 2020 2020 2020 2065 6c69 6620 5f68 2e73         elif _h.s
+00018000: 6861 7065 5b6d 696e 285f 682e 6e64 696d  hape[min(_h.ndim
+00018010: 202d 2031 2c20 3129 5d20 3c20 333a 0d0a   - 1, 1)] < 3:..
+00018020: 2020 2020 2020 2020 2020 2020 5f68 203d              _h =
+00018030: 206e 702e 6675 6c6c 2828 7365 6c66 2e48   np.full((self.H
+00018040: 2c20 3329 2c20 5f68 5b6d 696e 285f 682e  , 3), _h[min(_h.
+00018050: 6e64 696d 202d 2031 2c20 3129 5d29 0d0a  ndim - 1, 1)])..
+00018060: 2020 2020 2020 2020 656c 6966 205f 682e          elif _h.
+00018070: 6e64 696d 203d 3d20 313a 0d0a 2020 2020  ndim == 1:..    
+00018080: 2020 2020 2020 2020 5f68 203d 206e 702e          _h = np.
+00018090: 7673 7461 636b 285b 5f68 5b3a 335d 2066  vstack([_h[:3] f
+000180a0: 6f72 2068 2069 6e20 7261 6e67 6528 7365  or h in range(se
+000180b0: 6c66 2e48 295d 290d 0a20 2020 2020 2020  lf.H)])..       
+000180c0: 2065 6c69 6620 5f68 2e6e 6469 6d20 3d3d   elif _h.ndim ==
+000180d0: 2032 3a0d 0a20 2020 2020 2020 2020 2020   2:..           
+000180e0: 205f 6820 3d20 5f68 5b3a 2073 656c 662e   _h = _h[: self.
+000180f0: 5f48 6d61 782c 203a 335d 0d0a 2020 2020  _Hmax, :3]..    
+00018100: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+00018110: 2020 2020 2020 205f 6820 3d20 5f68 5b3a         _h = _h[:
+00018120: 2073 656c 662e 5f48 6d61 782c 203a 332c   self._Hmax, :3,
+00018130: 202e 2e2e 2c20 2d31 5d0d 0a0d 0a20 2020   ..., -1]....   
+00018140: 2020 2020 2069 6620 5f68 2e73 6861 7065       if _h.shape
+00018150: 5b31 5d20 3d3d 2032 3a20 2023 2043 2d61  [1] == 2:  # C-a
+00018160: 7869 7320 6d75 7374 2065 7175 616c 2033  xis must equal 3
+00018170: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+00018180: 6767 696e 672e 6572 726f 7228 2243 6f75  gging.error("Cou
+00018190: 6c64 6e27 7420 7365 7420 2768 273a 204f  ldn't set 'h': O
+000181a0: 6e6c 7920 3220 696e 7374 6561 6420 6f66  nly 2 instead of
+000181b0: 2033 2063 6f6c 6f72 2063 6861 6e6e 656c   3 color channel
+000181c0: 7320 7072 6f76 6964 6564 2e22 290d 0a20  s provided.").. 
+000181d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000181e0: 6e0d 0a0d 0a20 2020 2020 2020 2069 6620  n....        if 
+000181f0: 6e70 2e61 6e79 286e 702e 6d61 7828 5f68  np.any(np.max(_h
+00018200: 2c20 6178 6973 3d31 2920 3d3d 2030 293a  , axis=1) == 0):
+00018210: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+00018220: 6767 696e 672e 6572 726f 7228 2244 6964  gging.error("Did
+00018230: 6e27 7420 7365 7420 2768 273a 2042 6c61  n't set 'h': Bla
+00018240: 636b 2063 6f6c 6f72 2069 7320 6e6f 7420  ck color is not 
+00018250: 616c 6c6f 7765 642e 2229 0d0a 2020 2020  allowed.")..    
+00018260: 2020 2020 2020 2020 7265 7475 726e 0d0a          return..
+00018270: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00018280: 662e 5744 4d20 616e 6420 6e6f 7420 7365  f.WDM and not se
+00018290: 6c66 2e5f 6d6f 6e6f 6368 726f 6d65 3a0d  lf._monochrome:.
+000182a0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000182b0: 6769 6e67 2e65 7272 6f72 2822 436f 756c  ging.error("Coul
+000182c0: 646e 2774 2073 6574 2027 6827 3a20 2757  dn't set 'h': 'W
+000182d0: 444d 2720 6973 2061 6374 6976 652c 2062  DM' is active, b
+000182e0: 7574 206e 6f74 2061 6c6c 2068 7565 7320  ut not all hues 
+000182f0: 6172 6520 6d6f 6e6f 6368 726f 6d61 7469  are monochromati
+00018300: 632e 2229 0d0a 2020 2020 2020 2020 2020  c.")..          
+00018310: 2020 7265 7475 726e 0d0a 0d0a 2020 2020    return....    
+00018320: 2020 2020 6966 206e 6f74 206e 702e 6172      if not np.ar
+00018330: 7261 795f 6571 7561 6c28 7365 6c66 2e5f  ray_equal(self._
+00018340: 682c 205f 6829 3a0d 0a20 2020 2020 2020  h, _h):..       
+00018350: 2020 2020 2048 6f6c 6420 3d20 7365 6c66       Hold = self
+00018360: 2e48 0d0a 2020 2020 2020 2020 2020 2020  .H..            
+00018370: 7365 6c66 2e5f 6820 3d20 5f68 0d0a 2020  self._h = _h..  
+00018380: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+00018390: 672e 6465 6275 6728 6622 7365 6c66 2e5f  g.debug(f"self._
+000183a0: 6820 3d20 7b73 7472 2873 656c 662e 5f68  h = {str(self._h
+000183b0: 292e 7265 706c 6163 6528 6368 7228 3130  ).replace(chr(10
+000183c0: 292c 2027 2c27 297d 2229 0d0a 2020 2020  ), ',')}")..    
+000183d0: 2020 2020 2020 2020 6966 2048 6f6c 6420          if Hold 
+000183e0: 213d 205f 682e 7368 6170 655b 305d 3a0d  != _h.shape[0]:.
+000183f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018400: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+00018410: 2273 656c 662e 4820 3d20 7b5f 682e 7368  "self.H = {_h.sh
+00018420: 6170 655b 305d 7d22 2920 2023 2063 6f6d  ape[0]}")  # com
+00018430: 7075 7465 6420 7570 6f6e 2063 616c 6c0d  puted upon call.
+00018440: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00018450: 6769 6e67 2e64 6562 7567 2866 227b 7365  ging.debug(f"{se
+00018460: 6c66 2e4d 203d 207d 2229 2020 2320 636f  lf.M = }")  # co
+00018470: 6d70 7574 6564 2075 706f 6e20 6361 6c6c  mputed upon call
+00018480: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+00018490: 790d 0a20 2020 2064 6566 2054 444d 2873  y..    def TDM(s
+000184a0: 656c 6629 202d 3e20 626f 6f6c 3a0d 0a20  elf) -> bool:.. 
+000184b0: 2020 2020 2020 2022 2222 5465 6d70 6f72         """Tempor
+000184c0: 616c 2064 6976 6973 696f 6e20 6d75 6c74  al division mult
+000184d0: 6970 6c65 7869 6e67 2e22 2222 0d0a 2020  iplexing."""..  
+000184e0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000184f0: 662e 5420 3e20 310d 0a0d 0a20 2020 2040  f.T > 1....    @
+00018500: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
+00018510: 6620 5344 4d28 7365 6c66 2920 2d3e 2062  f SDM(self) -> b
+00018520: 6f6f 6c3a 0d0a 2020 2020 2020 2020 2222  ool:..        ""
+00018530: 2253 7061 7469 616c 2064 6976 6973 696f  "Spatial divisio
+00018540: 6e20 6d75 6c74 6970 6c65 7869 6e67 2e0d  n multiplexing..
+00018550: 0a0d 0a20 2020 2020 2020 2054 6865 2064  ...        The d
+00018560: 6972 6563 7469 6f6e 7320 4420 6172 6520  irections D are 
+00018570: 6d75 6c74 6970 6c65 7865 642c 2072 6573  multiplexed, res
+00018580: 756c 7469 6e67 2069 6e20 6120 6372 6f73  ulting in a cros
+00018590: 7365 6420 6672 696e 6765 2070 6174 7465  sed fringe patte
+000185a0: 726e 2e0d 0a20 2020 2020 2020 2054 6865  rn...        The
+000185b0: 2061 6d70 6c69 7475 6465 2042 2069 7320   amplitude B is 
+000185c0: 6861 6c76 6564 2e0d 0a20 2020 2020 2020  halved...       
+000185d0: 2049 7420 6361 6e20 6f6e 6c79 2062 6520   It can only be 
+000185e0: 6163 7469 7661 7465 6420 6966 2077 6520  activated if we 
+000185f0: 6861 7665 2074 776f 2064 6972 6563 7469  have two directi
+00018600: 6f6e 732c 2069 2e65 2e20 4420 e289 a120  ons, i.e. D ... 
+00018610: 322e 0d0a 2020 2020 2020 2020 5468 6520  2...        The 
+00018620: 6e75 6d62 6572 206f 6620 6672 616d 6573  number of frames
+00018630: 2054 2069 7320 7265 6475 6365 6420 6279   T is reduced by
+00018640: 2074 6865 2066 6163 746f 7220 322e 2222   the factor 2.""
+00018650: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+00018660: 6e20 7365 6c66 2e5f 5344 4d0d 0a0d 0a20  n self._SDM.... 
+00018670: 2020 2040 5344 4d2e 7365 7474 6572 0d0a     @SDM.setter..
+00018680: 2020 2020 6465 6620 5344 4d28 7365 6c66      def SDM(self
+00018690: 2c20 5344 4d3a 2062 6f6f 6c29 3a0d 0a20  , SDM: bool):.. 
+000186a0: 2020 2020 2020 205f 5344 4d20 3d20 626f         _SDM = bo
+000186b0: 6f6c 2853 444d 290d 0a0d 0a20 2020 2020  ol(SDM)....     
+000186c0: 2020 2069 6620 5f53 444d 3a0d 0a20 2020     if _SDM:..   
+000186d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000186e0: 2e44 2021 3d20 323a 0d0a 2020 2020 2020  .D != 2:..      
+000186f0: 2020 2020 2020 2020 2020 5f53 444d 203d            _SDM =
+00018700: 2046 616c 7365 0d0a 2020 2020 2020 2020   False..        
+00018710: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00018720: 6572 726f 7228 2244 6964 6e27 7420 7365  error("Didn't se
+00018730: 7420 2753 444d 273a 2050 6f69 6e74 6c65  t 'SDM': Pointle
+00018740: 7373 2061 7320 6f6e 6c79 206f 6e65 2064  ss as only one d
+00018750: 696d 656e 7369 6f6e 2065 7869 7374 2e22  imension exist."
+00018760: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
+00018770: 2069 6620 7365 6c66 2e67 7269 6420 6e6f   if self.grid no
+00018780: 7420 696e 2073 656c 662e 5f67 7269 6473  t in self._grids
+00018790: 5b3a 325d 3a0d 0a20 2020 2020 2020 2020  [:2]:..         
+000187a0: 2020 2020 2020 205f 5344 4d20 3d20 4661         _SDM = Fa
+000187b0: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
+000187c0: 2020 2020 206c 6f67 6769 6e67 2e65 7272       logging.err
+000187d0: 6f72 2866 2243 6f75 6c64 6e27 7420 7365  or(f"Couldn't se
+000187e0: 7420 2753 444d 273a 2067 7269 6420 6e6f  t 'SDM': grid no
+000187f0: 7420 696e 207b 7365 6c66 2e5f 6772 6964  t in {self._grid
+00018800: 735b 3a32 5d7d 272e 2229 0d0a 0d0a 2020  s[:2]}'.")....  
+00018810: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00018820: 662e 4644 4d3a 0d0a 2020 2020 2020 2020  f.FDM:..        
+00018830: 2020 2020 2020 2020 5f53 444d 203d 2046          _SDM = F
+00018840: 616c 7365 0d0a 2020 2020 2020 2020 2020  alse..          
+00018850: 2020 2020 2020 6c6f 6767 696e 672e 6572        logging.er
+00018860: 726f 7228 2243 6f75 6c64 6e27 7420 7365  ror("Couldn't se
+00018870: 7420 2753 444d 273a 2046 444d 2069 7320  t 'SDM': FDM is 
+00018880: 6163 7469 7665 2e22 290d 0a0d 0a20 2020  active.")....   
+00018890: 2020 2020 2069 6620 7365 6c66 2e5f 5344       if self._SD
+000188a0: 4d20 213d 205f 5344 4d3a 0d0a 2020 2020  M != _SDM:..    
+000188b0: 2020 2020 2020 2020 7365 6c66 2e5f 5344          self._SD
+000188c0: 4d20 3d20 5f53 444d 0d0a 2020 2020 2020  M = _SDM..      
+000188d0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+000188e0: 6275 6728 6622 7b73 656c 662e 5f53 444d  bug(f"{self._SDM
+000188f0: 203d 207d 2229 0d0a 2020 2020 2020 2020   = }")..        
+00018900: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+00018910: 6728 6622 7b73 656c 662e 5420 3d20 7d22  g(f"{self.T = }"
+00018920: 2920 2023 2063 6f6d 7075 7465 6420 7570  )  # computed up
+00018930: 6f6e 2063 616c 6c0d 0a0d 0a20 2020 2020  on call....     
+00018940: 2020 2020 2020 2069 6620 7365 6c66 2e53         if self.S
+00018950: 444d 3a0d 0a20 2020 2020 2020 2020 2020  DM:..           
+00018960: 2020 2020 2073 656c 662e 4220 2f3d 2073       self.B /= s
+00018970: 656c 662e 440d 0a20 2020 2020 2020 2020  elf.D..         
+00018980: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00018990: 2020 2020 2020 2020 2020 7365 6c66 2e42            self.B
+000189a0: 202a 3d20 7365 6c66 2e44 0d0a 0d0a 2020   *= self.D....  
+000189b0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+000189c0: 2064 6566 2057 444d 2873 656c 6629 202d   def WDM(self) -
+000189d0: 3e20 626f 6f6c 3a0d 0a20 2020 2020 2020  > bool:..       
+000189e0: 2022 2222 5761 7665 6c65 6e67 7468 2064   """Wavelength d
+000189f0: 6976 6973 696f 6e20 6d75 6c74 6970 6c65  ivision multiple
+00018a00: 7869 6e67 2e0d 0a0d 0a20 2020 2020 2020  xing.....       
+00018a10: 2054 6865 2073 6869 6674 7320 6172 6520   The shifts are 
+00018a20: 6d75 6c74 6970 6c65 7865 6420 696e 746f  multiplexed into
+00018a30: 2074 6865 2063 6f6c 6f72 2063 6861 6e6e   the color chann
+00018a40: 656c 2c20 7265 7375 6c74 696e 6720 696e  el, resulting in
+00018a50: 2061 6e20 5247 4220 6672 696e 6765 2070   an RGB fringe p
+00018a60: 6174 7465 726e 2e0d 0a20 2020 2020 2020  attern...       
+00018a70: 2049 7420 6361 6e20 6f6e 6c79 2062 6520   It can only be 
+00018a80: 6163 7469 7661 7465 6420 6966 2061 6c6c  activated if all
+00018a90: 2073 6869 6674 7320 6571 7561 6c20 332c   shifts equal 3,
+00018aa0: 2069 2e65 2e20 4e20 e289 a120 332e 0d0a   i.e. N ... 3...
+00018ab0: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
+00018ac0: 6572 206f 6620 6672 616d 6573 2054 2069  er of frames T i
+00018ad0: 7320 7265 6475 6365 6420 6279 2074 6865  s reduced by the
+00018ae0: 2066 6163 746f 7220 332e 2222 220d 0a20   factor 3.""".. 
+00018af0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00018b00: 6c66 2e5f 5744 4d0d 0a0d 0a20 2020 2040  lf._WDM....    @
+00018b10: 5744 4d2e 7365 7474 6572 0d0a 2020 2020  WDM.setter..    
+00018b20: 6465 6620 5744 4d28 7365 6c66 2c20 5744  def WDM(self, WD
+00018b30: 4d3a 2062 6f6f 6c29 3a0d 0a20 2020 2020  M: bool):..     
+00018b40: 2020 205f 5744 4d20 3d20 626f 6f6c 2857     _WDM = bool(W
+00018b50: 444d 290d 0a0d 0a20 2020 2020 2020 2069  DM)....        i
+00018b60: 6620 5f57 444d 3a0d 0a20 2020 2020 2020  f _WDM:..       
+00018b70: 2020 2020 2069 6620 6e6f 7420 6e70 2e61       if not np.a
+00018b80: 6c6c 2873 656c 662e 4e20 3d3d 2033 293a  ll(self.N == 3):
+00018b90: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018ba0: 2020 5f57 444d 203d 2046 616c 7365 0d0a    _WDM = False..
+00018bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bc0: 6c6f 6767 696e 672e 6572 726f 7228 2243  logging.error("C
+00018bd0: 6f75 6c64 6e27 7420 7365 7420 2757 444d  ouldn't set 'WDM
+00018be0: 273a 2041 7420 6c65 6173 7420 6f6e 6520  ': At least one 
+00018bf0: 5368 6966 7420 213d 2033 2e22 290d 0a0d  Shift != 3.")...
+00018c00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00018c10: 6e6f 7420 7365 6c66 2e5f 6d6f 6e6f 6368  not self._monoch
+00018c20: 726f 6d65 3a0d 0a20 2020 2020 2020 2020  rome:..         
+00018c30: 2020 2020 2020 205f 5744 4d20 3d20 4661         _WDM = Fa
+00018c40: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
+00018c50: 2020 2020 206c 6f67 6769 6e67 2e65 7272       logging.err
+00018c60: 6f72 2822 436f 756c 646e 2774 2073 6574  or("Couldn't set
+00018c70: 2027 5744 4d27 3a20 4e6f 7420 616c 6c20   'WDM': Not all 
+00018c80: 6875 6573 2061 7265 206d 6f6e 6f63 6872  hues are monochr
+00018c90: 6f6d 6174 6963 2e22 290d 0a0d 0a20 2020  omatic.")....   
+00018ca0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00018cb0: 2e46 444d 3a20 2023 2074 6f64 6f3a 2072  .FDM:  # todo: r
+00018cc0: 656d 6f76 6520 7468 6973 2c20 616c 7265  emove this, alre
+00018cd0: 6164 7920 636f 7665 7265 6420 6279 204e  ady covered by N
+00018ce0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018cf0: 2020 5f57 444d 203d 2046 616c 7365 0d0a    _WDM = False..
+00018d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d10: 6c6f 6767 696e 672e 6572 726f 7228 2243  logging.error("C
+00018d20: 6f75 6c64 6e27 7420 7365 7420 2757 444d  ouldn't set 'WDM
+00018d30: 273a 2046 444d 2069 7320 6163 7469 7665  ': FDM is active
+00018d40: 2e22 290d 0a0d 0a20 2020 2020 2020 2069  .")....        i
+00018d50: 6620 7365 6c66 2e5f 5744 4d20 213d 205f  f self._WDM != _
+00018d60: 5744 4d3a 0d0a 2020 2020 2020 2020 2020  WDM:..          
+00018d70: 2020 7365 6c66 2e5f 5744 4d20 3d20 5f57    self._WDM = _W
+00018d80: 444d 0d0a 2020 2020 2020 2020 2020 2020  DM..            
+00018d90: 6c6f 6767 696e 672e 6465 6275 6728 6622  logging.debug(f"
+00018da0: 7b73 656c 662e 5f57 444d 203d 207d 2229  {self._WDM = }")
+00018db0: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+00018dc0: 6767 696e 672e 6465 6275 6728 6622 7b73  gging.debug(f"{s
+00018dd0: 656c 662e 5420 3d20 7d22 2920 2023 2063  elf.T = }")  # c
+00018de0: 6f6d 7075 7465 6420 7570 6f6e 2063 616c  omputed upon cal
+00018df0: 6c0d 0a0d 0a20 2020 2040 7072 6f70 6572  l....    @proper
+00018e00: 7479 0d0a 2020 2020 6465 6620 4644 4d28  ty..    def FDM(
+00018e10: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0d0a  self) -> bool:..
+00018e20: 2020 2020 2020 2020 2222 2246 7265 7175          """Frequ
+00018e30: 656e 6379 2064 6976 6973 696f 6e20 6d75  ency division mu
+00018e40: 6c74 6970 6c65 7869 6e67 2e0d 0a0d 0a20  ltiplexing..... 
+00018e50: 2020 2020 2020 2054 6865 2064 6972 6563         The direc
+00018e60: 7469 6f6e 7320 4420 616e 6420 7468 6520  tions D and the 
+00018e70: 7365 7473 204b 2061 7265 206d 756c 7469  sets K are multi
+00018e80: 706c 6578 6564 2c20 7265 7375 6c74 696e  plexed, resultin
+00018e90: 6720 696e 2061 2063 726f 7373 6564 2066  g in a crossed f
+00018ea0: 7269 6e67 6520 7061 7474 6572 6e20 6966  ringe pattern if
+00018eb0: 2044 20e2 89a1 2032 2e0d 0a20 2020 2020   D ... 2...     
+00018ec0: 2020 2049 7420 6361 6e20 6f6e 6c79 2062     It can only b
+00018ed0: 6520 6163 7469 7661 7465 6420 6966 2044  e activated if D
+00018ee0: 20e2 88a8 204b 203e 2031 2069 2e65 2e20   ... K > 1 i.e. 
+00018ef0: 4420 2a20 4b20 3e20 312e 0d0a 2020 2020  D * K > 1...    
+00018f00: 2020 2020 5468 6520 616d 706c 6974 7564      The amplitud
+00018f10: 6520 4220 6973 2072 6564 7563 6564 2062  e B is reduced b
+00018f20: 7920 7468 6520 6661 6374 6f72 2044 202a  y the factor D *
+00018f30: 204b 2e0d 0a20 2020 2020 2020 2055 7375   K...        Usu
+00018f40: 616c 6c79 2066 2065 7175 616c 7320 3120  ally f equals 1 
+00018f50: 616e 6420 6973 2065 7373 656e 7469 616c  and is essential
+00018f60: 6c79 206f 6e6c 7920 6368 616e 6765 6420  ly only changed 
+00018f70: 6966 2066 7265 7175 656e 6379 2064 6976  if frequency div
+00018f80: 6973 696f 6e20 6d75 6c74 6970 6c65 7869  ision multiplexi
+00018f90: 6e67 2028 4644 4d29 2069 7320 6163 7469  ng (FDM) is acti
+00018fa0: 7661 7465 643a 0d0a 2020 2020 2020 2020  vated:..        
+00018fb0: 4561 6368 2073 6574 2070 6572 2064 6972  Each set per dir
+00018fc0: 6563 7469 6f6e 2072 6563 6569 7665 7320  ection receives 
+00018fd0: 616e 2069 6e64 6976 6964 7561 6c20 7465  an individual te
+00018fe0: 6d70 6f72 616c 2066 7265 7175 656e 6379  mporal frequency
+00018ff0: 2066 2c0d 0a20 2020 2020 2020 2077 6869   f,..        whi
+00019000: 6368 2069 7320 7573 6564 2069 6e20 7465  ch is used in te
+00019010: 6d70 6f72 616c 2064 656d 6f64 756c 6174  mporal demodulat
+00019020: 696f 6e20 746f 2064 6973 7469 6e67 7569  ion to distingui
+00019030: 7368 2074 6865 2069 6e64 6976 6964 7561  sh the individua
+00019040: 6c20 7365 7473 2e0d 0a20 2020 2020 2020  l sets...       
+00019050: 2041 206d 696e 696d 616c 206e 756d 6265   A minimal numbe
+00019060: 7220 6f66 2073 6869 6674 7320 4e6d 696e  r of shifts Nmin
+00019070: 20e2 89a5 20e2 8c88 2032 202a 2066 6d61   ... ... 2 * fma
+00019080: 7820 2b20 3120 e28c 8920 6973 2072 6571  x + 1 ... is req
+00019090: 7569 7265 640d 0a20 2020 2020 2020 2074  uired..        t
+000190a0: 6f20 7361 7469 7366 7920 7468 6520 7361  o satisfy the sa
+000190b0: 6d70 6c69 6e67 2074 6865 6f72 656d 2061  mpling theorem a
+000190c0: 6e64 204e 2069 7320 7570 6461 7465 6420  nd N is updated 
+000190d0: 6175 746f 6d61 7469 6361 6c6c 7920 6966  automatically if
+000190e0: 206e 6563 6573 7361 7279 2e0d 0a20 2020   necessary...   
+000190f0: 2020 2020 2049 6620 6f6e 6520 7761 6e74       If one want
+00019100: 7320 6120 7374 6174 6963 2070 6174 7465  s a static patte
+00019110: 726e 2c20 692e 652e 206f 6e65 2074 6861  rn, i.e. one tha
+00019120: 7420 7265 6d61 696e 7320 636f 6e67 7275  t remains congru
+00019130: 656e 7420 7768 656e 2073 6869 6674 6564  ent when shifted
+00019140: 2c20 7365 7420 7374 6174 6963 2074 6f20  , set static to 
+00019150: 5472 7565 2e0d 0a20 2020 2020 2020 2022  True...        "
+00019160: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
+00019170: 726e 2073 656c 662e 5f46 444d 0d0a 0d0a  rn self._FDM....
+00019180: 2020 2020 4046 444d 2e73 6574 7465 720d      @FDM.setter.
+00019190: 0a20 2020 2064 6566 2046 444d 2873 656c  .    def FDM(sel
+000191a0: 662c 2046 444d 3a20 626f 6f6c 293a 0d0a  f, FDM: bool):..
+000191b0: 2020 2020 2020 2020 5f46 444d 203d 2062          _FDM = b
+000191c0: 6f6f 6c28 4644 4d29 0d0a 0d0a 2020 2020  ool(FDM)....    
+000191d0: 2020 2020 6966 205f 4644 4d3a 0d0a 2020      if _FDM:..  
+000191e0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000191f0: 662e 4420 3d3d 2073 656c 662e 4b20 3d3d  f.D == self.K ==
+00019200: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
+00019210: 2020 2020 205f 4644 4d20 3d20 4661 6c73       _FDM = Fals
+00019220: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
+00019230: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
+00019240: 2822 4469 646e 2774 2073 6574 2027 4644  ("Didn't set 'FD
+00019250: 4d27 3a20 4469 6d65 6e73 696f 6e73 202a  M': Dimensions *
+00019260: 2053 6574 7320 3d20 312c 2073 6f20 6e6f   Sets = 1, so no
+00019270: 7468 696e 6720 746f 206d 756c 7469 706c  thing to multipl
+00019280: 6578 2e22 290d 0a0d 0a20 2020 2020 2020  ex.")....       
+00019290: 2020 2020 2069 6620 7365 6c66 2e53 444d       if self.SDM
+000192a0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000192b0: 2020 205f 4644 4d20 3d20 4661 6c73 650d     _FDM = False.
+000192c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000192d0: 206c 6f67 6769 6e67 2e65 7272 6f72 2822   logging.error("
+000192e0: 436f 756c 646e 2774 2073 6574 2027 4644  Couldn't set 'FD
+000192f0: 4d27 3a20 5344 4d20 6973 2061 6374 6976  M': SDM is activ
+00019300: 652e 2229 0d0a 0d0a 2020 2020 2020 2020  e.")....        
+00019310: 2020 2020 6966 2073 656c 662e 5744 4d3a      if self.WDM:
+00019320: 2020 2320 746f 646f 3a20 7265 6d6f 7665    # todo: remove
+00019330: 2c20 616c 7265 6164 7920 636f 7665 7265  , already covere
+00019340: 6420 6279 204e 0d0a 2020 2020 2020 2020  d by N..        
+00019350: 2020 2020 2020 2020 5f46 444d 203d 2046          _FDM = F
+00019360: 616c 7365 0d0a 2020 2020 2020 2020 2020  alse..          
+00019370: 2020 2020 2020 6c6f 6767 696e 672e 6572        logging.er
+00019380: 726f 7228 2243 6f75 6c64 6e27 7420 7365  ror("Couldn't se
+00019390: 7420 2746 444d 273a 2057 444d 2069 7320  t 'FDM': WDM is 
+000193a0: 6163 7469 7665 2e22 290d 0a0d 0a20 2020  active.")....   
+000193b0: 2020 2020 2069 6620 7365 6c66 2e5f 4644       if self._FD
+000193c0: 4d20 213d 205f 4644 4d3a 0d0a 2020 2020  M != _FDM:..    
+000193d0: 2020 2020 2020 2020 7365 6c66 2e5f 4644          self._FD
+000193e0: 4d20 3d20 5f46 444d 0d0a 2020 2020 2020  M = _FDM..      
+000193f0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00019400: 6275 6728 6622 7b73 656c 662e 5f46 444d  bug(f"{self._FDM
+00019410: 203d 207d 2229 0d0a 2020 2020 2020 2020   = }")..        
+00019420: 2020 2020 2320 7365 6c66 2e4b 203d 2073      # self.K = s
+00019430: 656c 662e 5f4b 0d0a 2020 2020 2020 2020  elf._K..        
+00019440: 2020 2020 7365 6c66 2e4e 203d 2073 656c      self.N = sel
+00019450: 662e 5f4e 0d0a 2020 2020 2020 2020 2020  f._N..          
+00019460: 2020 7365 6c66 2e76 203d 2073 656c 662e    self.v = self.
+00019470: 5f76 0d0a 2020 2020 2020 2020 2020 2020  _v..            
+00019480: 6966 2073 656c 662e 4644 4d3a 0d0a 2020  if self.FDM:..  
+00019490: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000194a0: 6c66 2e66 203d 2073 656c 662e 5f66 0d0a  lf.f = self._f..
+000194b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000194c0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000194d0: 2020 2073 656c 662e 6620 3d20 6e70 2e6f     self.f = np.o
+000194e0: 6e65 7328 2873 656c 662e 442c 2073 656c  nes((self.D, sel
+000194f0: 662e 4b29 290d 0a0d 0a20 2020 2020 2020  f.K))....       
+00019500: 2020 2020 2023 206b 6565 7020 6d61 7869       # keep maxi
+00019510: 6d75 6d20 706f 7373 6962 6c65 2076 6973  mum possible vis
+00019520: 6962 696c 6974 7920 636f 6e73 7461 6e74  ibility constant
+00019530: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00019540: 2073 656c 662e 4644 4d3a 0d0a 2020 2020   self.FDM:..    
+00019550: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019560: 2e42 202f 3d20 7365 6c66 2e44 202a 2073  .B /= self.D * s
+00019570: 656c 662e 4b0d 0a20 2020 2020 2020 2020  elf.K..         
+00019580: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00019590: 2020 2020 2020 2020 2020 7365 6c66 2e42            self.B
+000195a0: 202a 3d20 7365 6c66 2e44 202a 2073 656c   *= self.D * sel
+000195b0: 662e 4b0d 0a0d 0a20 2020 2040 7072 6f70  f.K....    @prop
+000195c0: 6572 7479 0d0a 2020 2020 6465 6620 7374  erty..    def st
+000195d0: 6174 6963 2873 656c 6629 202d 3e20 626f  atic(self) -> bo
+000195e0: 6f6c 3a0d 0a20 2020 2020 2020 2022 2222  ol:..        """
+000195f0: 466c 6167 2066 6f72 2063 7265 6174 696e  Flag for creatin
+00019600: 6720 7374 6174 6963 2066 7269 6e67 6573  g static fringes
+00019610: 2028 736f 2074 6865 7920 7265 6d61 696e   (so they remain
+00019620: 2063 6f6e 6772 7565 6e74 2077 6865 6e20   congruent when 
+00019630: 7368 6966 7465 6429 2e22 2222 0d0a 2020  shifted)."""..  
+00019640: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00019650: 662e 5f73 7461 7469 630d 0a0d 0a20 2020  f._static....   
+00019660: 2040 7374 6174 6963 2e73 6574 7465 720d   @static.setter.
+00019670: 0a20 2020 2064 6566 2073 7461 7469 6328  .    def static(
+00019680: 7365 6c66 2c20 7374 6174 6963 3a20 626f  self, static: bo
+00019690: 6f6c 293a 0d0a 2020 2020 2020 2020 5f73  ol):..        _s
+000196a0: 7461 7469 6320 3d20 626f 6f6c 2873 7461  tatic = bool(sta
+000196b0: 7469 6329 0d0a 0d0a 2020 2020 2020 2020  tic)....        
+000196c0: 6966 2073 656c 662e 5f73 7461 7469 6320  if self._static 
+000196d0: 213d 205f 7374 6174 6963 3a0d 0a20 2020  != _static:..   
+000196e0: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+000196f0: 7461 7469 6320 3d20 5f73 7461 7469 630d  tatic = _static.
+00019700: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00019710: 6769 6e67 2e64 6562 7567 2866 227b 7365  ging.debug(f"{se
+00019720: 6c66 2e5f 7374 6174 6963 203d 207d 2229  lf._static = }")
+00019730: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00019740: 6c66 2e76 203d 2073 656c 662e 5f76 0d0a  lf.v = self._v..
+00019750: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019760: 2e66 203d 2073 656c 662e 5f66 0d0a 0d0a  .f = self._f....
+00019770: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+00019780: 2020 2064 6566 204b 2873 656c 6629 202d     def K(self) -
+00019790: 3e20 696e 743a 0d0a 2020 2020 2020 2020  > int:..        
+000197a0: 2222 224e 756d 6265 7220 6f66 2073 6574  """Number of set
+000197b0: 7320 286e 756d 6265 7220 6f66 2066 7269  s (number of fri
+000197c0: 6e67 6520 7061 7474 6572 6e73 2077 6974  nge patterns wit
+000197d0: 6820 6469 6666 6572 656e 7420 7370 6174  h different spat
+000197e0: 6961 6c20 6672 6571 7565 6e63 6965 7329  ial frequencies)
+000197f0: 2e22 2222 0d0a 2020 2020 2020 2020 7265  ."""..        re
+00019800: 7475 726e 2073 656c 662e 5f4b 0d0a 0d0a  turn self._K....
+00019810: 2020 2020 404b 2e73 6574 7465 720d 0a20      @K.setter.. 
+00019820: 2020 2064 6566 204b 2873 656c 662c 204b     def K(self, K
+00019830: 3a20 696e 7429 3a0d 0a20 2020 2020 2020  : int):..       
+00019840: 2023 2074 6f64 6f3a 2064 6966 6665 7265   # todo: differe
+00019850: 6e74 204b 2066 6f72 2065 6163 6820 443a  nt K for each D:
+00019860: 2075 7365 2061 7272 6179 206f 6620 6172   use array of ar
+00019870: 7261 7973 0d0a 2020 2020 2020 2020 2320  rays..        # 
+00019880: 6120 3d20 6e70 2e6f 6e65 7328 3229 0d0a  a = np.ones(2)..
+00019890: 2020 2020 2020 2020 2320 6220 3d20 6e70          # b = np
+000198a0: 2e6f 6e65 7328 3529 0d0a 2020 2020 2020  .ones(5)..      
+000198b0: 2020 2320 6320 3d20 6e70 2e61 7272 6179    # c = np.array
+000198c0: 285b 612c 2062 5d29 0d0a 0d0a 2020 2020  ([a, b])....    
+000198d0: 2020 2020 4b6d 6178 203d 2028 7365 6c66      Kmax = (self
+000198e0: 2e5f 4e6d 6178 202d 2031 2920 2f20 3220  ._Nmax - 1) / 2 
+000198f0: 2f20 7365 6c66 2e44 2069 6620 7365 6c66  / self.D if self
+00019900: 2e46 444d 2065 6c73 6520 7365 6c66 2e5f  .FDM else self._
+00019910: 4b6d 6178 2020 2320 746f 646f 3a20 6368  Kmax  # todo: ch
+00019920: 6563 6b20 6966 206e 6563 6573 7361 7279  eck if necessary
+00019930: 0d0a 2020 2020 2020 2020 5f4b 203d 2069  ..        _K = i
+00019940: 6e74 286d 696e 286d 6178 2831 2c20 4b29  nt(min(max(1, K)
+00019950: 2c20 4b6d 6178 2929 0d0a 0d0a 2020 2020  , Kmax))....    
+00019960: 2020 2020 6966 2073 656c 662e 5f4b 203e      if self._K >
+00019970: 205f 4b3a 2020 2320 7265 6d6f 7665 2065   _K:  # remove e
+00019980: 6c65 6d65 6e74 730d 0a20 2020 2020 2020  lements..       
+00019990: 2020 2020 2073 656c 662e 5f4b 203d 205f       self._K = _
+000199a0: 4b0d 0a20 2020 2020 2020 2020 2020 206c  K..            l
+000199b0: 6f67 6769 6e67 2e64 6562 7567 2866 227b  ogging.debug(f"{
+000199c0: 7365 6c66 2e5f 4b20 3d20 7d22 290d 0a0d  self._K = }")...
+000199d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000199e0: 662e 4e20 3d20 7365 6c66 2e5f 4e5b 3a2c  f.N = self._N[:,
+000199f0: 203a 2073 656c 662e 4b5d 0d0a 2020 2020   : self.K]..    
+00019a00: 2020 2020 2020 2020 7365 6c66 2e76 203d          self.v =
+00019a10: 2073 656c 662e 5f76 5b3a 2c20 3a20 7365   self._v[:, : se
+00019a20: 6c66 2e4b 5d0d 0a20 2020 2020 2020 2020  lf.K]..         
+00019a30: 2020 2073 656c 662e 6620 3d20 7365 6c66     self.f = self
+00019a40: 2e5f 665b 3a2c 203a 2073 656c 662e 4b5d  ._f[:, : self.K]
+00019a50: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00019a60: 6966 2073 656c 662e 5f44 203d 3d20 7365  if self._D == se
+00019a70: 6c66 2e5f 4b20 3d3d 2031 3a0d 0a20 2020  lf._K == 1:..   
+00019a80: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00019a90: 662e 4644 4d20 3d20 4661 6c73 650d 0a20  f.FDM = False.. 
+00019aa0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00019ab0: 2e5f 4b20 3c20 5f4b 3a20 2023 2061 6464  ._K < _K:  # add
+00019ac0: 2065 6c65 6d65 6e74 730d 0a20 2020 2020   elements..     
+00019ad0: 2020 2020 2020 2073 656c 662e 5f4b 203d         self._K =
+00019ae0: 205f 4b0d 0a20 2020 2020 2020 2020 2020   _K..           
+00019af0: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+00019b00: 227b 7365 6c66 2e5f 4b20 3d20 7d22 290d  "{self._K = }").
+00019b10: 0a0d 0a20 2020 2020 2020 2020 2020 2073  ...            s
+00019b20: 656c 662e 4e20 3d20 6e70 2e61 7070 656e  elf.N = np.appen
+00019b30: 6428 0d0a 2020 2020 2020 2020 2020 2020  d(..            
+00019b40: 2020 2020 7365 6c66 2e5f 4e2c 206e 702e      self._N, np.
+00019b50: 7469 6c65 2873 656c 662e 5f4e 5b30 2c20  tile(self._N[0, 
+00019b60: 305d 2c20 2873 656c 662e 442c 205f 4b20  0], (self.D, _K 
+00019b70: 2d20 7365 6c66 2e5f 4e2e 7368 6170 655b  - self._N.shape[
+00019b80: 315d 2929 2c20 6178 6973 3d31 0d0a 2020  1])), axis=1..  
+00019b90: 2020 2020 2020 2020 2020 2920 2023 2064            )  # d
+00019ba0: 6f6e 2774 2061 7070 656e 6420 4e20 6672  on't append N fr
+00019bb0: 6f6d 2064 6566 6175 6c74 732c 2074 6869  om defaults, thi
+00019bc0: 7320 6d69 6768 7420 6265 2069 6e20 636f  s might be in co
+00019bd0: 6e66 6c69 6374 2077 6974 6820 5744 4d21  nflict with WDM!
+00019be0: 0d0a 2020 2020 2020 2020 2020 2020 7620  ..            v 
+00019bf0: 3d20 7365 6c66 2e4c 202a 2a20 2831 202f  = self.L ** (1 /
+00019c00: 206e 702e 6172 616e 6765 2873 656c 662e   np.arange(self.
+00019c10: 5f76 2e73 6861 7065 5b31 5d20 2b20 312c  _v.shape[1] + 1,
+00019c20: 205f 4b20 2b20 3129 290d 0a20 2020 2020   _K + 1))..     
+00019c30: 2020 2020 2020 2073 656c 662e 7620 3d20         self.v = 
+00019c40: 6e70 2e61 7070 656e 6428 7365 6c66 2e5f  np.append(self._
+00019c50: 762c 206e 702e 7469 6c65 2876 2c20 2873  v, np.tile(v, (s
+00019c60: 656c 662e 442c 2031 2929 2c20 6178 6973  elf.D, 1)), axis
+00019c70: 3d31 290d 0a20 2020 2020 2020 2020 2020  =1)..           
+00019c80: 2073 656c 662e 6620 3d20 6e70 2e61 7070   self.f = np.app
+00019c90: 656e 6428 0d0a 2020 2020 2020 2020 2020  end(..          
+00019ca0: 2020 2020 2020 7365 6c66 2e5f 662c 0d0a        self._f,..
+00019cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cc0: 6e70 2e74 696c 6528 7365 6c66 2e64 6566  np.tile(self.def
+00019cd0: 6175 6c74 735b 2266 225d 5b30 2c20 305d  aults["f"][0, 0]
+00019ce0: 2c20 2873 656c 662e 442c 205f 4b20 2d20  , (self.D, _K - 
+00019cf0: 7365 6c66 2e5f 662e 7368 6170 655b 315d  self._f.shape[1]
+00019d00: 2929 2c0d 0a20 2020 2020 2020 2020 2020  )),..           
+00019d10: 2020 2020 2061 7869 733d 312c 0d0a 2020       axis=1,..  
+00019d20: 2020 2020 2020 2020 2020 290d 0a0d 0a20            ).... 
+00019d30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019d40: 4220 3d20 7365 6c66 2e42 0d0a 0d0a 2020  B = self.B....  
+00019d50: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00019d60: 2064 6566 205f 4e6d 696e 2873 656c 6629   def _Nmin(self)
+00019d70: 202d 3e20 696e 743a 0d0a 2020 2020 2020   -> int:..      
+00019d80: 2020 2222 224d 696e 696d 756d 206e 756d    """Minimum num
+00019d90: 6265 7220 6f66 2073 6869 6674 7320 746f  ber of shifts to
+00019da0: 2028 756e 6966 6f72 6d6c 7929 2073 616d   (uniformly) sam
+00019db0: 706c 6520 7465 6d70 6f72 616c 2066 7265  ple temporal fre
+00019dc0: 7175 656e 6369 6573 2e0d 0a0d 0a20 2020  quencies.....   
+00019dd0: 2020 2020 2050 6572 2064 6972 6563 7469       Per directi
+00019de0: 6f6e 2061 7420 6c65 6173 7420 6f6e 6520  on at least one 
+00019df0: 7365 7420 7769 7468 204e 20e2 89a5 2033  set with N ... 3
+00019e00: 2069 7320 6e65 6365 7373 6172 790d 0a20   is necessary.. 
+00019e10: 2020 2020 2020 2074 6f20 736f 6c76 6520         to solve 
+00019e20: 666f 7220 7468 6520 7468 7265 6520 756e  for the three un
+00019e30: 6b6e 6f77 6e73 2062 7269 6768 746e 6573  knowns brightnes
+00019e40: 7320 412c 206d 6f64 756c 6174 696f 6e20  s A, modulation 
+00019e50: 4220 616e 6420 636f 6f72 6469 6e61 7465  B and coordinate
+00019e60: 2078 692e 2222 220d 0a20 2020 2020 2020   xi."""..       
+00019e70: 2069 6620 7365 6c66 2e46 444d 3a0d 0a20   if self.FDM:.. 
+00019e80: 2020 2020 2020 2020 2020 204e 6d69 6e20             Nmin 
+00019e90: 3d20 696e 7428 6e70 2e63 6569 6c28 3220  = int(np.ceil(2 
+00019ea0: 2a20 7365 6c66 2e66 2e6d 6178 2829 202b  * self.f.max() +
+00019eb0: 2031 2929 2020 2320 7361 6d70 6c69 6e67   1))  # sampling
+00019ec0: 2074 6865 6f72 656d 0d0a 2020 2020 2020   theorem..      
+00019ed0: 2020 2020 2020 2320 746f 646f 3a20 3220        # todo: 2 
+00019ee0: 2a20 4420 2a20 4b20 2b20 3120 2d3e 2066  * D * K + 1 -> f
+00019ef0: 7261 6374 696f 6e61 6c20 7065 7269 6f64  ractional period
+00019f00: 7320 6966 2073 7461 7469 630d 0a20 2020  s if static..   
+00019f10: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00019f20: 2020 2020 2020 2020 4e6d 696e 203d 2033          Nmin = 3
+00019f30: 2020 2320 746f 646f 3a20 3120 2d3e 2075    # todo: 1 -> u
+00019f40: 7365 206f 6c64 2064 6563 6f64 6572 0d0a  se old decoder..
+00019f50: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00019f60: 6d69 6e0d 0a0d 0a20 2020 2040 7072 6f70  min....    @prop
+00019f70: 6572 7479 0d0a 2020 2020 6465 6620 4e28  erty..    def N(
+00019f80: 7365 6c66 2920 2d3e 206e 702e 6e64 6172  self) -> np.ndar
+00019f90: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
+00019fa0: 224e 756d 6265 7220 6f66 2070 6861 7365  "Number of phase
+00019fb0: 2073 6869 6674 732e 2222 220d 0a20 2020   shifts."""..   
+00019fc0: 2020 2020 2069 6620 7365 6c66 2e44 203d       if self.D =
+00019fd0: 3d20 3120 6f72 206c 656e 286e 702e 756e  = 1 or len(np.un
+00019fe0: 6971 7565 2873 656c 662e 5f4e 2c20 6178  ique(self._N, ax
+00019ff0: 6973 3d30 2929 203d 3d20 313a 2020 2320  is=0)) == 1:  # 
+0001a000: 7365 7473 2069 6e20 6469 7265 6374 696f  sets in directio
+0001a010: 6e73 2061 7265 2069 6465 6e74 6963 616c  ns are identical
+0001a020: 0d0a 2020 2020 2020 2020 2020 2020 4e20  ..            N 
+0001a030: 3d20 7365 6c66 2e5f 4e5b 305d 2020 2320  = self._N[0]  # 
+0001a040: 3144 0d0a 2020 2020 2020 2020 656c 7365  1D..        else
+0001a050: 3a0d 0a20 2020 2020 2020 2020 2020 204e  :..            N
+0001a060: 203d 2073 656c 662e 5f4e 2020 2320 3244   = self._N  # 2D
+0001a070: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001a080: 204e 0d0a 0d0a 2020 2020 404e 2e73 6574   N....    @N.set
+0001a090: 7465 720d 0a20 2020 2064 6566 204e 2873  ter..    def N(s
+0001a0a0: 656c 662c 204e 3a20 696e 7420 7c20 7475  elf, N: int | tu
+0001a0b0: 706c 655b 696e 745d 207c 206c 6973 745b  ple[int] | list[
+0001a0c0: 696e 745d 207c 206e 702e 6e64 6172 7261  int] | np.ndarra
+0001a0d0: 7929 3a0d 0a20 2020 2020 2020 205f 4e20  y):..        _N 
+0001a0e0: 3d20 6e70 2e61 7272 6179 284e 2c20 696e  = np.array(N, in
+0001a0f0: 7429 2e63 6c69 7028 7365 6c66 2e5f 4e6d  t).clip(self._Nm
+0001a100: 696e 2c20 7365 6c66 2e5f 4e6d 6178 2920  in, self._Nmax) 
+0001a110: 2023 206d 616b 6520 6172 7261 792c 2063   # make array, c
+0001a120: 6173 7420 746f 2064 7479 7065 2c20 636c  ast to dtype, cl
+0001a130: 6970 0d0a 0d0a 2020 2020 2020 2020 6966  ip....        if
+0001a140: 206e 6f74 205f 4e2e 7369 7a65 3a20 2023   not _N.size:  #
+0001a150: 2065 6d70 7479 2061 7272 6179 0d0a 2020   empty array..  
+0001a160: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001a170: 0d0a 0d0a 2020 2020 2020 2020 5f4e 203d  ....        _N =
+0001a180: 2073 656c 662e 5f74 7269 6d28 5f4e 290d   self._trim(_N).
+0001a190: 0a0d 0a20 2020 2020 2020 2069 6620 6e70  ...        if np
+0001a1a0: 2e61 6c6c 285f 4e20 3d3d 2031 2920 616e  .all(_N == 1) an
+0001a1b0: 6420 5f4e 2e73 6861 7065 5b31 5d20 3d3d  d _N.shape[1] ==
+0001a1c0: 2031 3a20 2023 2061 6e79 0d0a 2020 2020   1:  # any..    
+0001a1d0: 2020 2020 2020 2020 7061 7373 2020 2320          pass  # 
+0001a1e0: 4654 4d0d 0a20 2020 2020 2020 2065 6c69  FTM..        eli
+0001a1f0: 6620 6e70 2e61 6e79 285f 4e20 3c3d 2032  f np.any(_N <= 2
+0001a200: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+0001a210: 666f 7220 6420 696e 2072 616e 6765 2873  for d in range(s
+0001a220: 656c 662e 4429 3a0d 0a20 2020 2020 2020  elf.D):..       
+0001a230: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001a240: 616e 7928 5f4e 5b64 5d20 3e3d 2033 293a  any(_N[d] >= 3):
+0001a250: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001a260: 2020 2020 2020 6920 3d20 6e70 2e61 7267        i = np.arg
+0001a270: 6d61 7828 5f4e 5b64 5d29 2020 2320 6e70  max(_N[d])  # np
+0001a280: 2e61 7267 6d69 6e28 5f4e 5b64 5d29 0d0a  .argmin(_N[d])..
+0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2a0: 2020 2020 5f4e 5b64 2c20 695d 203d 2033      _N[d, i] = 3
+0001a2b0: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
+0001a2c0: 656c 662e 5744 4d20 616e 6420 6e6f 7420  elf.WDM and not 
+0001a2d0: 6e70 2e61 6c6c 285f 4e20 3d3d 2033 293a  np.all(_N == 3):
+0001a2e0: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+0001a2f0: 6767 696e 672e 6572 726f 7228 2243 6f75  gging.error("Cou
+0001a300: 6c64 6e27 7420 7365 7420 274e 273a 2041  ldn't set 'N': A
+0001a310: 7420 6c65 6173 7420 6f6e 6520 5368 6966  t least one Shif
+0001a320: 7420 213d 2033 2e22 290d 0a20 2020 2020  t != 3.")..     
+0001a330: 2020 2020 2020 2072 6574 7572 6e0d 0a0d         return...
+0001a340: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001a350: 2e46 444d 2061 6e64 206e 6f74 206e 702e  .FDM and not np.
+0001a360: 616c 6c28 5f4e 203d 3d20 5f4e 5b30 2c20  all(_N == _N[0, 
+0001a370: 305d 293a 0d0a 2020 2020 2020 2020 2020  0]):..          
+0001a380: 2020 2320 5f4e 203d 206e 702e 7469 6c65    # _N = np.tile
+0001a390: 2873 656c 662e 5f4e 6d69 6e2c 205f 4e2e  (self._Nmin, _N.
+0001a3a0: 7368 6170 6529 0d0a 2020 2020 2020 2020  shape)..        
+0001a3b0: 2020 2020 5f4e 203d 206e 702e 7469 6c65      _N = np.tile
+0001a3c0: 285f 4e5b 302c 2030 5d2c 205f 4e2e 7368  (_N[0, 0], _N.sh
+0001a3d0: 6170 6529 0d0a 0d0a 2020 2020 2020 2020  ape)....        
+0001a3e0: 6966 206e 6f74 206e 702e 6172 7261 795f  if not np.array_
+0001a3f0: 6571 7561 6c28 7365 6c66 2e5f 4e2c 205f  equal(self._N, _
+0001a400: 4e29 3a0d 0a20 2020 2020 2020 2020 2020  N):..           
+0001a410: 2073 656c 662e 5f4e 203d 205f 4e0d 0a20   self._N = _N.. 
+0001a420: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0001a430: 6e67 2e64 6562 7567 2866 2273 656c 662e  ng.debug(f"self.
+0001a440: 5f4e 203d 207b 7374 7228 7365 6c66 2e5f  _N = {str(self._
+0001a450: 4e29 2e72 6570 6c61 6365 2863 6872 2831  N).replace(chr(1
+0001a460: 3029 2c20 272c 2729 7d22 290d 0a20 2020  0), ',')}")..   
+0001a470: 2020 2020 2020 2020 2073 656c 662e 5f55           self._U
+0001a480: 4d52 203d 204e 6f6e 650d 0a20 2020 2020  MR = None..     
+0001a490: 2020 2020 2020 2073 656c 662e 442c 2073         self.D, s
+0001a4a0: 656c 662e 4b20 3d20 7365 6c66 2e5f 4e2e  elf.K = self._N.
+0001a4b0: 7368 6170 650d 0a20 2020 2020 2020 2020  shape..         
+0001a4c0: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+0001a4d0: 2866 227b 7365 6c66 2e54 203d 207d 2229  (f"{self.T = }")
+0001a4e0: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+0001a4f0: 790d 0a20 2020 2064 6566 206c 6d69 6e28  y..    def lmin(
+0001a500: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0d  self) -> float:.
+0001a510: 0a20 2020 2020 2020 2022 2222 4d69 6e69  .        """Mini
+0001a520: 6d75 6d20 7265 736f 6c76 6162 6c65 2077  mum resolvable w
+0001a530: 6176 656c 656e 6774 682e 0d0a 2020 2020  avelength...    
+0001a540: 2020 2020 5b6c 6d69 6e5d 203d 2070 782e      [lmin] = px.
+0001a550: 2222 220d 0a0d 0a20 2020 2020 2020 2023  """....        #
+0001a560: 2064 6f6e 2774 2075 7365 2073 656c 662e   don't use self.
+0001a570: 5f66 6d61 782c 2065 6c73 6520 6369 7263  _fmax, else circ
+0001a580: 756c 6172 206c 6f6f 700d 0a20 2020 2020  ular loop..     
+0001a590: 2020 2069 6620 7365 6c66 2e46 444d 2061     if self.FDM a
+0001a5a0: 6e64 2073 656c 662e 7374 6174 6963 3a0d  nd self.static:.
+0001a5b0: 0a20 2020 2020 2020 2020 2020 2066 6d61  .            fma
+0001a5c0: 7820 3d20 6d69 6e28 2873 656c 662e 5f4e  x = min((self._N
+0001a5d0: 6d69 6e20 2d20 3129 202f 2032 2c20 7365  min - 1) / 2, se
+0001a5e0: 6c66 2e4c 202f 2073 656c 662e 5f6c 6d69  lf.L / self._lmi
+0001a5f0: 6e29 0d0a 2020 2020 2020 2020 656c 7365  n)..        else
+0001a600: 3a0d 0a20 2020 2020 2020 2020 2020 2066  :..            f
+0001a610: 6d61 7820 3d20 2873 656c 662e 5f4e 6d69  max = (self._Nmi
+0001a620: 6e20 2d20 3129 202f 2032 0d0a 2020 2020  n - 1) / 2..    
+0001a630: 2020 2020 7265 7475 726e 206d 696e 2873      return min(s
+0001a640: 656c 662e 5f6c 6d69 6e2c 2073 656c 662e  elf._lmin, self.
+0001a650: 4c20 2f20 666d 6178 2920 6966 2073 656c  L / fmax) if sel
+0001a660: 662e 4644 4d20 616e 6420 7365 6c66 2e73  f.FDM and self.s
+0001a670: 7461 7469 6320 656c 7365 2073 656c 662e  tatic else self.
+0001a680: 5f6c 6d69 6e0d 0a0d 0a20 2020 2040 6c6d  _lmin....    @lm
+0001a690: 696e 2e73 6574 7465 720d 0a20 2020 2064  in.setter..    d
+0001a6a0: 6566 206c 6d69 6e28 7365 6c66 2c20 6c6d  ef lmin(self, lm
+0001a6b0: 696e 3a20 666c 6f61 7429 3a0d 0a20 2020  in: float):..   
+0001a6c0: 2020 2020 205f 6c6d 696e 203d 2066 6c6f       _lmin = flo
+0001a6d0: 6174 286d 6178 2873 656c 662e 5f6c 6d69  at(max(self._lmi
+0001a6e0: 6e6d 696e 2c20 6c6d 696e 2929 0d0a 0d0a  nmin, lmin))....
+0001a6f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001a700: 5f6c 6d69 6e20 213d 205f 6c6d 696e 3a0d  _lmin != _lmin:.
+0001a710: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001a720: 662e 5f6c 6d69 6e20 3d20 5f6c 6d69 6e0d  f._lmin = _lmin.
+0001a730: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001a740: 6769 6e67 2e64 6562 7567 2866 227b 7365  ging.debug(f"{se
+0001a750: 6c66 2e5f 6c6d 696e 203d 207d 2229 0d0a  lf._lmin = }")..
+0001a760: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001a770: 696e 672e 6465 6275 6728 6622 7b73 656c  ing.debug(f"{sel
+0001a780: 662e 766d 6178 203d 207d 2229 2020 2320  f.vmax = }")  # 
+0001a790: 636f 6d70 7574 6564 2075 706f 6e20 6361  computed upon ca
+0001a7a0: 6c6c 0d0a 2020 2020 2020 2020 2020 2020  ll..            
+0001a7b0: 7365 6c66 2e6c 203d 2073 656c 662e 6c20  self.l = self.l 
+0001a7c0: 2023 206c 2074 7269 6767 6572 7320 760d   # l triggers v.
+0001a7d0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+0001a7e0: 0d0a 2020 2020 6465 6620 6c6f 7074 2873  ..    def lopt(s
+0001a7f0: 656c 6629 202d 3e20 666c 6f61 743a 0d0a  elf) -> float:..
+0001a800: 2020 2020 2020 2020 2222 224f 7074 696d          """Optim
+0001a810: 616c 2077 6176 656c 656e 6774 6820 666f  al wavelength fo
+0001a820: 7220 6d69 6e69 6d61 6c20 6465 636f 6469  r minimal decodi
+0001a830: 6e67 2075 6e63 6572 7461 696e 7479 2e0d  ng uncertainty..
+0001a840: 0a20 2020 2020 2020 205b 6c6f 7074 5d20  .        [lopt] 
+0001a850: 3d20 7078 2e22 2222 0d0a 2020 2020 2020  = px."""..      
+0001a860: 2020 7265 7475 726e 2073 656c 662e 4c20    return self.L 
+0001a870: 2f20 7365 6c66 2e76 6f70 740d 0a0d 0a20  / self.vopt.... 
+0001a880: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
+0001a890: 2020 6465 6620 6c28 7365 6c66 2920 2d3e    def l(self) ->
+0001a8a0: 206e 702e 6e64 6172 7261 793a 0d0a 2020   np.ndarray:..  
+0001a8b0: 2020 2020 2020 2222 2257 6176 656c 656e        """Wavelen
+0001a8c0: 6774 6873 206f 6620 6672 696e 6765 2070  gths of fringe p
+0001a8d0: 6572 696f 6473 2e0d 0a20 2020 2020 2020  eriods...       
+0001a8e0: 205b 6c5d 203d 2070 782e 0d0a 0d0a 2020   [l] = px.....  
+0001a8f0: 2020 2020 2020 5768 656e 204c 2063 6861        When L cha
+0001a900: 6e67 6573 2c20 7620 6973 206b 6570 7420  nges, v is kept 
+0001a910: 636f 6e73 7461 6e74 2061 6e64 206f 6e6c  constant and onl
+0001a920: 7920 6c20 6973 2063 6861 6e67 6564 2e22  y l is changed."
+0001a930: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
+0001a940: 726e 2073 656c 662e 4c20 2f20 7365 6c66  rn self.L / self
+0001a950: 2e76 0d0a 0d0a 2020 2020 406c 2e73 6574  .v....    @l.set
+0001a960: 7465 720d 0a20 2020 2064 6566 206c 2873  ter..    def l(s
+0001a970: 656c 662c 206c 3a20 696e 7420 7c20 666c  elf, l: int | fl
+0001a980: 6f61 7420 7c20 7475 706c 655b 696e 7420  oat | tuple[int 
+0001a990: 7c20 666c 6f61 745d 207c 206c 6973 745b  | float] | list[
+0001a9a0: 696e 7420 7c20 666c 6f61 745d 207c 206e  int | float] | n
+0001a9b0: 702e 6e64 6172 7261 7920 7c20 7374 7229  p.ndarray | str)
+0001a9c0: 3a0d 0a20 2020 2020 2020 2069 6620 6973  :..        if is
+0001a9d0: 696e 7374 616e 6365 286c 2c20 7374 7229  instance(l, str)
+0001a9e0: 3a0d 0a20 2020 2020 2020 2020 2020 2069  :..            i
+0001a9f0: 6620 222c 2220 696e 206c 3a0d 0a20 2020  f "," in l:..   
+0001aa00: 2020 2020 2020 2020 2020 2020 206c 203d               l =
+0001aa10: 206e 702e 6672 6f6d 7374 7269 6e67 286c   np.fromstring(l
+0001aa20: 2c20 7365 703d 222c 2229 2020 2320 746f  , sep=",")  # to
+0001aa30: 646f 3a20 4e2c 2076 2c20 660d 0a20 2020  do: N, v, f..   
+0001aa40: 2020 2020 2020 2020 2065 6c69 6620 6c20           elif l 
+0001aa50: 3d3d 2022 6f70 7469 6d61 6c22 3a0d 0a20  == "optimal":.. 
+0001aa60: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001aa70: 6d69 6e20 3d20 696e 7428 6e70 2e63 6569  min = int(np.cei
+0001aa80: 6c28 7365 6c66 2e6c 6d69 6e29 290d 0a20  l(self.lmin)).. 
+0001aa90: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001aaa0: 6d61 7820 3d20 696e 7428 0d0a 2020 2020  max = int(..    
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aac0: 6e70 2e63 6569 6c28 0d0a 2020 2020 2020  np.ceil(..      
+0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aae0: 2020 6d61 7828 0d0a 2020 2020 2020 2020    max(..        
+0001aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab00: 2020 2020 7365 6c66 2e4c 202f 206c 6d69      self.L / lmi
+0001ab10: 6e2c 2020 2320 746f 646f 3a20 6f6e 6c79  n,  # todo: only
+0001ab20: 2069 6620 4220 6469 6666 6572 2073 6c69   if B differ sli
+0001ab30: 6768 746c 790d 0a20 2020 2020 2020 2020  ghtly..         
+0001ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab50: 2020 2073 656c 662e 6c6d 696e 2c0d 0a20     self.lmin,.. 
+0001ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab70: 2020 2020 2020 2020 2020 206d 696e 2873             min(s
+0001ab80: 656c 662e 6c6f 7074 2c20 7365 6c66 2e4c  elf.lopt, self.L
+0001ab90: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abb0: 6e70 2e73 7172 7428 7365 6c66 2e4c 292c  np.sqrt(self.L),
+0001abc0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001abd0: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abf0: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
+0001ac00: 2020 2020 290d 0a0d 0a20 2020 2020 2020      )....       
+0001ac10: 2020 2020 2020 2020 2069 6620 6c6d 696e           if lmin
+0001ac20: 203d 3d20 6c6d 6178 2061 6e64 206c 6d61   == lmax and lma
+0001ac30: 7820 3c20 7365 6c66 2e4c 3a0d 0a20 2020  x < self.L:..   
+0001ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac50: 206c 6d61 7820 2b3d 2031 0d0a 0d0a 2020   lmax += 1....  
+0001ac60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001ac70: 206c 6d61 7820 3c20 7365 6c66 2e4c 2061   lmax < self.L a
+0001ac80: 6e64 206e 6f74 2073 796d 7079 2e69 7370  nd not sympy.isp
+0001ac90: 7269 6d65 286c 6d61 7829 3a0d 0a20 2020  rime(lmax):..   
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acb0: 206c 6d61 7820 3d20 7379 6d70 792e 6e74   lmax = sympy.nt
+0001acc0: 6865 6f72 792e 6765 6e65 7261 7465 2e6e  heory.generate.n
+0001acd0: 6578 7470 7269 6d65 286c 6d61 782c 2031  extprime(lmax, 1
+0001ace0: 2920 2023 2065 6e73 7572 6573 206c 636d  )  # ensures lcm
+0001acf0: 2861 2c20 6c6d 6178 2920 3e3d 204c 2066  (a, lmax) >= L f
+0001ad00: 6f72 2061 6c6c 2061 203e 3d20 6c6d 696e  or all a >= lmin
+0001ad10: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+0001ad20: 2020 2020 6e20 3d20 6c6d 6178 202d 206c      n = lmax - l
+0001ad30: 6d69 6e20 2b20 310d 0a0d 0a20 2020 2020  min + 1....     
+0001ad40: 2020 2020 2020 2020 2020 206c 5f20 3d20             l_ = 
+0001ad50: 6e70 2e61 7272 6179 285b 6c6d 696e 5d29  np.array([lmin])
+0001ad60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001ad70: 2020 6c5f 6d61 7820 3d20 6c6d 696e 202b    l_max = lmin +
+0001ad80: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
+0001ad90: 2020 2020 6c63 6d20 3d20 6c5f 0d0a 2020      lcm = l_..  
+0001ada0: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+0001adb0: 696c 6520 6c63 6d20 3c20 7365 6c66 2e4c  ile lcm < self.L
+0001adc0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0001add0: 2020 2020 2020 206c 636d 5f6e 6577 203d         lcm_new =
+0001ade0: 206e 702e 6c63 6d28 6c63 6d2c 206c 5f6d   np.lcm(lcm, l_m
+0001adf0: 6178 290d 0a20 2020 2020 2020 2020 2020  ax)..           
+0001ae00: 2020 2020 2020 2020 2069 6620 6c63 6d5f           if lcm_
+0001ae10: 6e65 7720 3e20 6c63 6d3a 0d0a 2020 2020  new > lcm:..    
+0001ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae30: 2020 2020 6c5f 203d 206e 702e 6170 7065      l_ = np.appe
+0001ae40: 6e64 286c 5f2c 206c 5f6d 6178 290d 0a20  nd(l_, l_max).. 
+0001ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae60: 2020 2020 2020 206c 636d 203d 206c 636d         lcm = lcm
+0001ae70: 5f6e 6577 0d0a 2020 2020 2020 2020 2020  _new..          
+0001ae80: 2020 2020 2020 2020 2020 6c5f 6d61 7820            l_max 
+0001ae90: 2b3d 2031 0d0a 2020 2020 2020 2020 2020  += 1..          
+0001aea0: 2020 2020 2020 4b20 3d20 6d69 6e28 6c65        K = min(le
+0001aeb0: 6e28 6c5f 292c 2073 656c 662e 4b29 0d0a  n(l_), self.K)..
+0001aec0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001aed0: 2020 4320 3d20 7370 2e73 7065 6369 616c    C = sp.special
+0001aee0: 2e63 6f6d 6228 6e2c 204b 2c20 6578 6163  .comb(n, K, exac
+0001aef0: 743d 5472 7565 2c20 7265 7065 7469 7469  t=True, repetiti
+0001af00: 6f6e 3d54 7275 6529 2020 2320 6e75 6d62  on=True)  # numb
+0001af10: 6572 206f 6620 756e 6971 7565 2063 6f6d  er of unique com
+0001af20: 6269 6e61 7469 6f6e 730d 0a20 2020 2020  binations..     
+0001af30: 2020 2020 2020 2020 2020 2063 6f6d 626f             combo
+0001af40: 7320 3d20 6974 2e63 6f6d 6269 6e61 7469  s = it.combinati
+0001af50: 6f6e 735f 7769 7468 5f72 6570 6c61 6365  ons_with_replace
+0001af60: 6d65 6e74 2872 616e 6765 286c 6d69 6e2c  ment(range(lmin,
+0001af70: 206c 6d61 7820 2b20 3129 2c20 4b29 0d0a   lmax + 1), K)..
+0001af80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001af90: 2020 2320 4220 3d20 696e 7428 6e70 2e63    # B = int(np.c
+0001afa0: 6569 6c28 6e70 2e6c 6f67 3228 6c6d 6178  eil(np.log2(lmax
+0001afb0: 202d 2031 2920 2f20 3829 2920 2a20 3820   - 1) / 8)) * 8 
+0001afc0: 2023 206e 756d 6265 7220 6f66 2062 6974   # number of bit
+0001afd0: 7320 7265 7175 6972 6564 2074 6f20 7374  s required to st
+0001afe0: 6f72 6520 696e 7465 6765 7273 2075 7020  ore integers up 
+0001aff0: 746f 206c 6d61 780d 0a20 2020 2020 2020  to lmax..       
+0001b000: 2020 2020 2020 2020 2023 2063 6f6d 626f           # combo
+0001b010: 7320 3d20 6e70 2e66 726f 6d69 7465 7228  s = np.fromiter(
+0001b020: 636f 6d62 6f73 2c20 6e70 2e64 7479 7065  combos, np.dtype
+0001b030: 2828 6622 7569 6e74 7b42 7d22 2c20 4b29  ((f"uint{B}", K)
+0001b040: 292c 2043 290d 0a0d 0a20 2020 2020 2020  ), C)....       
+0001b050: 2020 2020 2020 2020 206b 726f 6f74 203d           kroot =
+0001b060: 2073 656c 662e 4c20 2a2a 2028 3120 2f20   self.L ** (1 / 
+0001b070: 4b29 0d0a 2020 2020 2020 2020 2020 2020  K)..            
+0001b080: 2020 2020 6966 2073 656c 662e 6c6d 696e      if self.lmin
+0001b090: 203c 3d20 6b72 6f6f 743a 0d0a 2020 2020   <= kroot:..    
+0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0b0: 6c63 6f6d 626f 7320 3d20 6e70 2e61 7272  lcombos = np.arr
+0001b0c0: 6179 280d 0a20 2020 2020 2020 2020 2020  ay(..           
+0001b0d0: 2020 2020 2020 2020 2020 2020 205b 6c20               [l 
+0001b0e0: 666f 7220 6c20 696e 2063 6f6d 626f 7320  for l in combos 
+0001b0f0: 6966 206e 702e 616e 7928 6e70 2e61 7272  if np.any(np.arr
+0001b100: 6179 285b 6c5d 2920 3e20 6b72 6f6f 7429  ay([l]) > kroot)
+0001b110: 2061 6e64 206e 702e 6c63 6d2e 7265 6475   and np.lcm.redu
+0001b120: 6365 286c 2920 3e3d 2073 656c 662e 4c5d  ce(l) >= self.L]
+0001b130: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001b140: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+0001b150: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+0001b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b170: 2020 2020 6c63 6f6d 626f 7320 3d20 6e70      lcombos = np
+0001b180: 2e61 7272 6179 285b 6c20 666f 7220 6c20  .array([l for l 
+0001b190: 696e 2063 6f6d 626f 7320 6966 206e 702e  in combos if np.
+0001b1a0: 6c63 6d2e 7265 6475 6365 286c 2920 3e3d  lcm.reduce(l) >=
+0001b1b0: 2073 656c 662e 4c5d 290d 0a0d 0a20 2020   self.L])....   
+0001b1c0: 2020 2020 2020 2020 2020 2020 2023 206c               # l
+0001b1d0: 636f 6d62 6f73 203d 2066 696c 7465 7228  combos = filter(
+0001b1e0: 6c63 6f6d 626f 732c 204b 2c20 7365 6c66  lcombos, K, self
+0001b1f0: 2e4c 2c20 6c6d 696e 290d 0a0d 0a20 2020  .L, lmin)....   
+0001b200: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+0001b210: 6478 203d 206e 702e 6172 676d 6178 286e  dx = np.argmax(n
+0001b220: 702e 7375 6d28 3120 2f20 6c63 6f6d 626f  p.sum(1 / lcombo
+0001b230: 732a 2a32 2c20 6178 6973 3d31 2929 0d0a  s**2, axis=1))..
+0001b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b250: 2320 6c20 3d20 6c63 6f6d 626f 735b 6964  # l = lcombos[id
+0001b260: 785d 0d0a 0d0a 2020 2020 2020 2020 2020  x]....          
+0001b270: 2020 2020 2020 7620 3d20 7365 6c66 2e4c        v = self.L
+0001b280: 202f 206c 636f 6d62 6f73 0d0a 2020 2020   / lcombos..    
+0001b290: 2020 2020 2020 2020 2020 2020 4220 3d20              B = 
+0001b2a0: 7365 6c66 2e4d 5446 2876 290d 0a20 2020  self.MTF(v)..   
+0001b2b0: 2020 2020 2020 2020 2020 2020 2076 6172               var
+0001b2c0: 203d 2031 202f 2073 656c 662e 4d20 2f20   = 1 / self.M / 
+0001b2d0: 7365 6c66 2e4e 202a 206c 636f 6d62 6f73  self.N * lcombos
+0001b2e0: 2a2a 3220 2f20 422a 2a32 2020 2320 746f  **2 / B**2  # to
+0001b2f0: 646f 3a20 442c 204d 0d0a 2020 2020 2020  do: D, M..      
+0001b300: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
+0001b310: 6e70 2e61 7267 6d61 7828 6e70 2e73 756d  np.argmax(np.sum
+0001b320: 2831 202f 2076 6172 2c20 6178 6973 3d31  (1 / var, axis=1
+0001b330: 2929 0d0a 0d0a 2020 2020 2020 2020 2020  ))....          
+0001b340: 2020 2020 2020 6c20 3d20 6c63 6f6d 626f        l = lcombo
+0001b350: 735b 6964 785d 0d0a 0d0a 2020 2020 2020  s[idx]....      
+0001b360: 2020 2020 2020 2020 2020 6966 204b 203c            if K <
+0001b370: 2073 656c 662e 4b3a 0d0a 2020 2020 2020   self.K:..      
+0001b380: 2020 2020 2020 2020 2020 2020 2020 6c20                l 
+0001b390: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
+0001b3a0: 2828 6e70 2e66 756c 6c28 7365 6c66 2e4b  ((np.full(self.K
+0001b3b0: 202d 204b 2c20 6c6d 696e 292c 206c 2929   - K, lmin), l))
+0001b3c0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+0001b3d0: 2020 2020 2320 7768 696c 6520 6c6d 6178      # while lmax
+0001b3e0: 203c 2073 656c 662e 4c20 616e 6420 6e70   < self.L and np
+0001b3f0: 2e67 6364 286c 6d69 6e2c 206c 6d61 7829  .gcd(lmin, lmax)
+0001b400: 2021 3d20 313a 0d0a 2020 2020 2020 2020   != 1:..        
+0001b410: 2020 2020 2020 2020 2320 2020 2020 6c6d          #     lm
+0001b420: 6178 202b 3d20 3120 2023 206d 6178 696d  ax += 1  # maxim
+0001b430: 756d 206e 756d 6265 7220 6f66 2069 7465  um number of ite
+0001b440: 7261 7469 6f6e 733f 203d 206d 696e 286e  rations? = min(n
+0001b450: 6578 7420 7072 696d 6520 6166 7465 7220  ext prime after 
+0001b460: 6c6d 6178 202d 206c 6d61 782c 206d 6178  lmax - lmax, max
+0001b470: 2830 2c20 4c20 2d20 6c6d 6178 2c20 2929  (0, L - lmax, ))
+0001b480: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001b490: 2020 2320 6c20 3d20 6e70 2e61 7272 6179    # l = np.array
+0001b4a0: 285b 6c6d 696e 5d20 2a20 2873 656c 662e  ([lmin] * (self.
+0001b4b0: 4b20 2d20 3129 202b 205b 6c6d 6178 5d29  K - 1) + [lmax])
+0001b4c0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+0001b4d0: 2020 2020 2320 766d 6178 203d 2069 6e74      # vmax = int
+0001b4e0: 286d 6178 2831 2069 6620 7365 6c66 2e4b  (max(1 if self.K
+0001b4f0: 203d 3d20 3120 656c 7365 2032 2c20 7365   == 1 else 2, se
+0001b500: 6c66 2e76 6d61 7829 2920 2023 2074 6f64  lf.vmax))  # tod
+0001b510: 6f3a 2072 6970 706c 6573 2066 726f 6d20  o: ripples from 
+0001b520: 696e 7428 290d 0a20 2020 2020 2020 2020  int()..         
+0001b530: 2020 2020 2020 2023 2076 203d 206e 702e         # v = np.
+0001b540: 6172 7261 7928 5b76 6d61 785d 202a 2028  array([vmax] * (
+0001b550: 7365 6c66 2e4b 202d 2031 2920 2b20 5b76  self.K - 1) + [v
+0001b560: 6d61 7820 2d20 315d 2920 2023 2074 776f  max - 1])  # two
+0001b570: 2063 6f6e 7365 6375 7469 7665 206e 756d   consecutive num
+0001b580: 6265 7273 2061 7265 2061 6c77 6179 7320  bers are always 
+0001b590: 636f 7072 696d 650d 0a20 2020 2020 2020  coprime..       
+0001b5a0: 2020 2020 2020 2020 2023 206c 7620 3d20           # lv = 
+0001b5b0: 7365 6c66 2e4c 202f 2076 0d0a 2020 2020  self.L / v..    
+0001b5c0: 2020 2020 2020 2020 2020 2020 2320 6c76              # lv
+0001b5d0: 203d 206e 702e 6d61 7869 6d75 6d28 7365   = np.maximum(se
+0001b5e0: 6c66 2e5f 6c6d 696e 2c20 6e70 2e6d 696e  lf._lmin, np.min
+0001b5f0: 696d 756d 286c 762c 2073 656c 662e 4c29  imum(lv, self.L)
+0001b600: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001b610: 2020 2023 0d0a 2020 2020 2020 2020 2020     #..          
+0001b620: 2020 2020 2020 2320 6964 7820 3d20 6e70        # idx = np
+0001b630: 2e61 7267 6d61 7828 286e 702e 7375 6d28  .argmax((np.sum(
+0001b640: 3120 2f20 286c 202a 2a20 3229 2c20 6178  1 / (l ** 2), ax
+0001b650: 6973 3d30 292c 206e 702e 7375 6d28 3120  is=0), np.sum(1 
+0001b660: 2f20 286c 7620 2a2a 2032 292c 2061 7869  / (lv ** 2), axi
+0001b670: 733d 3029 2929 0d0a 2020 2020 2020 2020  s=0)))..        
+0001b680: 2020 2020 2020 2020 2320 6c20 3d20 6c20          # l = l 
+0001b690: 6966 2069 6478 203d 3d20 3020 656c 7365  if idx == 0 else
+0001b6a0: 206c 760d 0a20 2020 2020 2020 2020 2020   lv..           
+0001b6b0: 2020 2020 2023 2070 7269 6e74 2822 6c22       # print("l"
+0001b6c0: 2069 6620 6964 7820 3d3d 2030 2065 6c73   if idx == 0 els
+0001b6d0: 6520 2276 2229 0d0a 2020 2020 2020 2020  e "v")..        
+0001b6e0: 2020 2020 656c 6966 206c 203d 3d20 2263      elif l == "c
+0001b6f0: 6c6f 7365 223a 0d0a 2020 2020 2020 2020  lose":..        
+0001b700: 2020 2020 2020 2020 6c6d 696e 203d 2069          lmin = i
+0001b710: 6e74 286d 6178 286e 702e 6365 696c 2873  nt(max(np.ceil(s
+0001b720: 656c 662e 6c6d 696e 292c 2073 656c 662e  elf.lmin), self.
+0001b730: 4c20 2a2a 2028 3120 2f20 7365 6c66 2e4b  L ** (1 / self.K
+0001b740: 2920 2d20 7365 6c66 2e4b 2929 0d0a 2020  ) - self.K))..  
+0001b750: 2020 2020 2020 2020 2020 2020 2020 6c20                l 
+0001b760: 3d20 6c6d 696e 202b 206e 702e 6172 616e  = lmin + np.aran
+0001b770: 6765 2873 656c 662e 4b29 0d0a 2020 2020  ge(self.K)..    
+0001b780: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+0001b790: 6520 6e70 2e6c 636d 2e72 6564 7563 6528  e np.lcm.reduce(
+0001b7a0: 6c29 203c 2073 656c 662e 4c3a 0d0a 2020  l) < self.L:..  
+0001b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b7c0: 2020 6c20 2b3d 2031 0d0a 2020 2020 2020    l += 1..      
+0001b7d0: 2020 2020 2020 656c 6966 206c 203d 3d20        elif l == 
+0001b7e0: 2273 6d61 6c6c 223a 0d0a 2020 2020 2020  "small":..      
+0001b7f0: 2020 2020 2020 2020 2020 6c6d 696e 203d            lmin =
+0001b800: 2069 6e74 286e 702e 6365 696c 2873 656c   int(np.ceil(sel
+0001b810: 662e 6c6d 696e 2929 0d0a 2020 2020 2020  f.lmin))..      
+0001b820: 2020 2020 2020 2020 2020 6c6d 6178 203d            lmax =
+0001b830: 2069 6e74 286e 702e 6365 696c 2873 656c   int(np.ceil(sel
+0001b840: 662e 4c20 2a2a 2028 3120 2f20 7365 6c66  f.L ** (1 / self
+0001b850: 2e4b 2929 2920 2023 2077 6176 656c 656e  .K)))  # wavelen
+0001b860: 6774 6873 2061 7265 2061 726f 756e 6420  gths are around 
+0001b870: 6b74 6820 726f 6f74 206f 6620 7365 6c66  kth root of self
+0001b880: 2e4c 0d0a 0d0a 2020 2020 2020 2020 2020  .L....          
+0001b890: 2020 2020 2020 6966 2073 656c 662e 4b20        if self.K 
+0001b8a0: 3e3d 2032 3a0d 0a20 2020 2020 2020 2020  >= 2:..         
+0001b8b0: 2020 2020 2020 2020 2020 206c 6d61 7820             lmax 
+0001b8c0: 2b3d 2031 0d0a 0d0a 2020 2020 2020 2020  += 1....        
+0001b8d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001b8e0: 656c 662e 4b20 3e3d 2033 3a0d 0a20 2020  elf.K >= 3:..   
+0001b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b900: 2020 2020 206c 6d61 7820 2b3d 2031 0d0a       lmax += 1..
+0001b910: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001b920: 2020 2020 2020 2020 2020 6966 206c 6d61            if lma
+0001b930: 7820 2520 3220 3d3d 2030 3a20 2023 206b  x % 2 == 0:  # k
+0001b940: 7468 2072 6f6f 7420 7761 7320 6576 656e  th root was even
+0001b950: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001b960: 2020 2020 2020 2020 2020 2020 2020 6c6d                lm
+0001b970: 6178 202b 3d20 310d 0a0d 0a20 2020 2020  ax += 1....     
+0001b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b990: 2020 2069 6620 7365 6c66 2e4b 203e 2033     if self.K > 3
+0001b9a0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0001b9b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b9c0: 7468 203d 2073 656c 662e 4b20 2d20 330d  th = self.K - 3.
+0001b9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b9e0: 2020 2020 2020 2020 2020 2020 206c 6d61               lma
+0001b9f0: 7820 3d20 7379 6d70 792e 6e74 6865 6f72  x = sympy.ntheor
+0001ba00: 792e 6765 6e65 7261 7465 2e6e 6578 7470  y.generate.nextp
+0001ba10: 7269 6d65 286c 6d61 782c 2069 7468 290d  rime(lmax, ith).
+0001ba20: 0a0d 0a20 2020 2020 2020 2020 2020 2020  ...             
+0001ba30: 2020 2069 6620 6c6d 696e 203e 206c 6d61     if lmin > lma
+0001ba40: 7820 6f72 206c 6d61 7820 2d20 6c6d 696e  x or lmax - lmin
+0001ba50: 202b 2031 203c 3d20 7365 6c66 2e4b 3a0d   + 1 <= self.K:.
+0001ba60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ba70: 2020 2020 206c 203d 206c 6d69 6e20 2b20       l = lmin + 
+0001ba80: 6e70 2e61 7261 6e67 6528 7365 6c66 2e4b  np.arange(self.K
+0001ba90: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001baa0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+0001bab0: 2020 2020 2020 2020 2020 2020 2020 6c6d                lm
+0001bac0: 6178 203d 206d 6178 280d 0a20 2020 2020  ax = max(..     
+0001bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bae0: 2020 206c 6d69 6e2c 206d 696e 286c 6d61     lmin, min(lma
+0001baf0: 782c 2069 6e74 286e 702e 6365 696c 2873  x, int(np.ceil(s
+0001bb00: 656c 662e 4c29 2929 0d0a 2020 2020 2020  elf.L)))..      
+0001bb10: 2020 2020 2020 2020 2020 2020 2020 2920                ) 
+0001bb20: 2023 206d 6178 2069 6e20 6f75 7465 7220   # max in outer 
+0001bb30: 636f 6e64 6974 696f 6e20 656e 7375 7265  condition ensure
+0001bb40: 7320 6c6d 6178 203e 3d20 6c6d 696e 2065  s lmax >= lmin e
+0001bb50: 7665 6e20 6966 204c 203c 206c 6d69 6e0d  ven if L < lmin.
+0001bb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bb70: 2020 2020 2069 6620 6c6d 696e 203d 3d20       if lmin == 
+0001bb80: 6c6d 6178 2061 6e64 206c 6d61 7820 3c20  lmax and lmax < 
+0001bb90: 7365 6c66 2e4c 3a0d 0a20 2020 2020 2020  self.L:..       
+0001bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbb0: 206c 6d61 7820 2b3d 2031 2020 2320 656e   lmax += 1  # en
+0001bbc0: 7375 7265 7320 6c6d 696e 2061 6e64 206c  sures lmin and l
+0001bbd0: 6d61 7820 6469 6666 6572 2073 6f20 7468  max differ so th
+0001bbe0: 6174 206c 636d 286c 2920 3e3d 204c 0d0a  at lcm(l) >= L..
+0001bbf0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001bc00: 2020 2020 2020 6e20 3d20 6c6d 6178 202d        n = lmax -
+0001bc10: 206c 6d69 6e20 2b20 310d 0a20 2020 2020   lmin + 1..     
+0001bc20: 2020 2020 2020 2020 2020 2020 2020 204b                 K
+0001bc30: 203d 206d 696e 2873 656c 662e 4b2c 206e   = min(self.K, n
+0001bc40: 2920 2023 2065 6e73 7572 6573 204b 203c  )  # ensures K <
+0001bc50: 3d20 6e0d 0a20 2020 2020 2020 2020 2020  = n..           
+0001bc60: 2020 2020 2020 2020 2043 203d 2073 702e           C = sp.
+0001bc70: 7370 6563 6961 6c2e 636f 6d62 286e 2c20  special.comb(n, 
+0001bc80: 4b2c 2065 7861 6374 3d54 7275 652c 2072  K, exact=True, r
+0001bc90: 6570 6574 6974 696f 6e3d 4661 6c73 6529  epetition=False)
+0001bca0: 2020 2320 6e75 6d62 6572 206f 6620 756e    # number of un
+0001bcb0: 6971 7565 2063 6f6d 6269 6e61 7469 6f6e  ique combination
+0001bcc0: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
+0001bcd0: 2020 2020 2020 2063 6f6d 626f 7320 3d20         combos = 
+0001bce0: 6e70 2e61 7272 6179 280d 0a20 2020 2020  np.array(..     
+0001bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd00: 2020 205b 0d0a 2020 2020 2020 2020 2020     [..          
+0001bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd20: 2020 630d 0a20 2020 2020 2020 2020 2020    c..           
+0001bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd40: 2066 6f72 2063 2069 6e20 6974 2e63 6f6d   for c in it.com
+0001bd50: 6269 6e61 7469 6f6e 7328 7261 6e67 6528  binations(range(
+0001bd60: 6c6d 696e 2c20 6c6d 6178 202b 2031 292c  lmin, lmax + 1),
+0001bd70: 204b 290d 0a20 2020 2020 2020 2020 2020   K)..           
+0001bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd90: 2069 6620 6e70 2e61 6e79 286e 702e 6172   if np.any(np.ar
+0001bda0: 7261 7928 5b63 5d29 203e 2073 656c 662e  ray([c]) > self.
+0001bdb0: 4c20 2a2a 2028 3120 2f20 7365 6c66 2e4b  L ** (1 / self.K
+0001bdc0: 2929 2061 6e64 206e 702e 6c63 6d2e 7265  )) and np.lcm.re
+0001bdd0: 6475 6365 2863 2920 3e3d 2073 656c 662e  duce(c) >= self.
+0001bde0: 4c0d 0a20 2020 2020 2020 2020 2020 2020  L..             
+0001bdf0: 2020 2020 2020 2020 2020 205d 0d0a 2020             ]..  
 0001be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be10: 2020 2020 2020 7365 6c66 2e6c 6d69 6e2c        self.lmin,
-0001be20: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001be30: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-0001be40: 6e28 7365 6c66 2e6c 6f70 742c 2073 656c  n(self.lopt, sel
-0001be50: 662e 4c29 2c0d 0a20 2020 2020 2020 2020  f.L),..         
-0001be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be70: 2020 206e 702e 7371 7274 2873 656c 662e     np.sqrt(self.
-0001be80: 4c29 2c0d 0a20 2020 2020 2020 2020 2020  L),..           
-0001be90: 2020 2020 2020 2020 2020 2020 2029 0d0a               )..
-0001bea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001beb0: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-0001bec0: 2020 2020 2020 2029 0d0a 0d0a 2020 2020         )....    
-0001bed0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0001bee0: 6d69 6e20 3d3d 206c 6d61 7820 616e 6420  min == lmax and 
-0001bef0: 6c6d 6178 203c 2073 656c 662e 4c3a 0d0a  lmax < self.L:..
-0001bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf10: 2020 2020 6c6d 6178 202b 3d20 310d 0a0d      lmax += 1...
-0001bf20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bf30: 2069 6620 6c6d 6178 203c 2073 656c 662e   if lmax < self.
-0001bf40: 4c20 616e 6420 6e6f 7420 7379 6d70 792e  L and not sympy.
-0001bf50: 6973 7072 696d 6528 6c6d 6178 293a 0d0a  isprime(lmax):..
-0001bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf70: 2020 2020 6c6d 6178 203d 2073 796d 7079      lmax = sympy
-0001bf80: 2e6e 7468 656f 7279 2e67 656e 6572 6174  .ntheory.generat
-0001bf90: 652e 6e65 7874 7072 696d 6528 6c6d 6178  e.nextprime(lmax
-0001bfa0: 2c20 3129 2020 2320 656e 7375 7265 7320  , 1)  # ensures 
-0001bfb0: 6c63 6d28 612c 206c 6d61 7829 203e 3d20  lcm(a, lmax) >= 
-0001bfc0: 4c20 666f 7220 616c 6c20 6120 3e3d 206c  L for all a >= l
-0001bfd0: 6d69 6e0d 0a0d 0a20 2020 2020 2020 2020  min....         
-0001bfe0: 2020 2020 2020 206e 203d 206c 6d61 7820         n = lmax 
-0001bff0: 2d20 6c6d 696e 202b 2031 0d0a 0d0a 2020  - lmin + 1....  
-0001c000: 2020 2020 2020 2020 2020 2020 2020 6c5f                l_
-0001c010: 203d 206e 702e 6172 7261 7928 5b6c 6d69   = np.array([lmi
-0001c020: 6e5d 290d 0a20 2020 2020 2020 2020 2020  n])..           
-0001c030: 2020 2020 206c 5f6d 6178 203d 206c 6d69       l_max = lmi
-0001c040: 6e20 2b20 310d 0a20 2020 2020 2020 2020  n + 1..         
-0001c050: 2020 2020 2020 206c 636d 203d 206c 5f0d         lcm = l_.
-0001c060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c070: 2077 6869 6c65 206c 636d 203c 2073 656c   while lcm < sel
-0001c080: 662e 4c3a 0d0a 2020 2020 2020 2020 2020  f.L:..          
-0001c090: 2020 2020 2020 2020 2020 6c63 6d5f 6e65            lcm_ne
-0001c0a0: 7720 3d20 6e70 2e6c 636d 286c 636d 2c20  w = np.lcm(lcm, 
-0001c0b0: 6c5f 6d61 7829 0d0a 2020 2020 2020 2020  l_max)..        
-0001c0c0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0001c0d0: 636d 5f6e 6577 203e 206c 636d 3a0d 0a20  cm_new > lcm:.. 
-0001c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c0f0: 2020 2020 2020 206c 5f20 3d20 6e70 2e61         l_ = np.a
-0001c100: 7070 656e 6428 6c5f 2c20 6c5f 6d61 7829  ppend(l_, l_max)
-0001c110: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001c120: 2020 2020 2020 2020 2020 6c63 6d20 3d20            lcm = 
-0001c130: 6c63 6d5f 6e65 770d 0a20 2020 2020 2020  lcm_new..       
-0001c140: 2020 2020 2020 2020 2020 2020 206c 5f6d               l_m
-0001c150: 6178 202b 3d20 310d 0a20 2020 2020 2020  ax += 1..       
-0001c160: 2020 2020 2020 2020 204b 203d 206d 696e           K = min
-0001c170: 286c 656e 286c 5f29 2c20 7365 6c66 2e4b  (len(l_), self.K
-0001c180: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
-0001c190: 2020 2020 2043 203d 2073 702e 7370 6563       C = sp.spec
-0001c1a0: 6961 6c2e 636f 6d62 286e 2c20 4b2c 2065  ial.comb(n, K, e
-0001c1b0: 7861 6374 3d54 7275 652c 2072 6570 6574  xact=True, repet
-0001c1c0: 6974 696f 6e3d 5472 7565 2920 2023 206e  ition=True)  # n
-0001c1d0: 756d 6265 7220 6f66 2075 6e69 7175 6520  umber of unique 
-0001c1e0: 636f 6d62 696e 6174 696f 6e73 0d0a 2020  combinations..  
-0001c1f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001c200: 6d62 6f73 203d 2069 742e 636f 6d62 696e  mbos = it.combin
-0001c210: 6174 696f 6e73 5f77 6974 685f 7265 706c  ations_with_repl
-0001c220: 6163 656d 656e 7428 7261 6e67 6528 6c6d  acement(range(lm
-0001c230: 696e 2c20 6c6d 6178 202b 2031 292c 204b  in, lmax + 1), K
-0001c240: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
-0001c250: 2020 2020 2023 2042 203d 2069 6e74 286e       # B = int(n
-0001c260: 702e 6365 696c 286e 702e 6c6f 6732 286c  p.ceil(np.log2(l
-0001c270: 6d61 7820 2d20 3129 202f 2038 2929 202a  max - 1) / 8)) *
-0001c280: 2038 2020 2320 6e75 6d62 6572 206f 6620   8  # number of 
-0001c290: 6269 7473 2072 6571 7569 7265 6420 746f  bits required to
-0001c2a0: 2073 746f 7265 2069 6e74 6567 6572 7320   store integers 
-0001c2b0: 7570 2074 6f20 6c6d 6178 0d0a 2020 2020  up to lmax..    
-0001c2c0: 2020 2020 2020 2020 2020 2020 2320 636f              # co
-0001c2d0: 6d62 6f73 203d 206e 702e 6672 6f6d 6974  mbos = np.fromit
-0001c2e0: 6572 2863 6f6d 626f 732c 206e 702e 6474  er(combos, np.dt
-0001c2f0: 7970 6528 2866 2275 696e 747b 427d 222c  ype((f"uint{B}",
-0001c300: 204b 2929 2c20 4329 0d0a 0d0a 2020 2020   K)), C)....    
-0001c310: 2020 2020 2020 2020 2020 2020 6b72 6f6f              kroo
-0001c320: 7420 3d20 7365 6c66 2e4c 202a 2a20 2831  t = self.L ** (1
-0001c330: 202f 204b 290d 0a20 2020 2020 2020 2020   / K)..         
-0001c340: 2020 2020 2020 2069 6620 7365 6c66 2e6c         if self.l
-0001c350: 6d69 6e20 3c3d 206b 726f 6f74 3a0d 0a20  min <= kroot:.. 
-0001c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c370: 2020 206c 636f 6d62 6f73 203d 206e 702e     lcombos = np.
-0001c380: 6172 7261 7928 0d0a 2020 2020 2020 2020  array(..        
-0001c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3a0: 5b6c 2066 6f72 206c 2069 6e20 636f 6d62  [l for l in comb
-0001c3b0: 6f73 2069 6620 6e70 2e61 6e79 286e 702e  os if np.any(np.
-0001c3c0: 6172 7261 7928 5b6c 5d29 203e 206b 726f  array([l]) > kro
-0001c3d0: 6f74 2920 616e 6420 6e70 2e6c 636d 2e72  ot) and np.lcm.r
-0001c3e0: 6564 7563 6528 6c29 203e 3d20 7365 6c66  educe(l) >= self
-0001c3f0: 2e4c 5d0d 0a20 2020 2020 2020 2020 2020  .L]..           
-0001c400: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
-0001c410: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001c420: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-0001c430: 2020 2020 2020 206c 636f 6d62 6f73 203d         lcombos =
-0001c440: 206e 702e 6172 7261 7928 5b6c 2066 6f72   np.array([l for
-0001c450: 206c 2069 6e20 636f 6d62 6f73 2069 6620   l in combos if 
-0001c460: 6e70 2e6c 636d 2e72 6564 7563 6528 6c29  np.lcm.reduce(l)
-0001c470: 203e 3d20 7365 6c66 2e4c 5d29 0d0a 0d0a   >= self.L])....
-0001c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c490: 2320 6c63 6f6d 626f 7320 3d20 6669 6c74  # lcombos = filt
-0001c4a0: 6572 286c 636f 6d62 6f73 2c20 4b2c 2073  er(lcombos, K, s
-0001c4b0: 656c 662e 4c2c 206c 6d69 6e29 0d0a 0d0a  elf.L, lmin)....
-0001c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c4d0: 2320 6964 7820 3d20 6e70 2e61 7267 6d61  # idx = np.argma
-0001c4e0: 7828 6e70 2e73 756d 2831 202f 206c 636f  x(np.sum(1 / lco
-0001c4f0: 6d62 6f73 2a2a 322c 2061 7869 733d 3129  mbos**2, axis=1)
-0001c500: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-0001c510: 2020 2023 206c 203d 206c 636f 6d62 6f73     # l = lcombos
-0001c520: 5b69 6478 5d0d 0a0d 0a20 2020 2020 2020  [idx]....       
-0001c530: 2020 2020 2020 2020 2076 203d 2073 656c           v = sel
-0001c540: 662e 4c20 2f20 6c63 6f6d 626f 730d 0a20  f.L / lcombos.. 
-0001c550: 2020 2020 2020 2020 2020 2020 2020 2042                 B
-0001c560: 203d 2073 656c 662e 4d54 4628 7629 0d0a   = self.MTF(v)..
-0001c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c580: 7661 7220 3d20 3120 2f20 7365 6c66 2e4d  var = 1 / self.M
-0001c590: 202f 2073 656c 662e 4e20 2a20 6c63 6f6d   / self.N * lcom
-0001c5a0: 626f 732a 2a32 202f 2042 2a2a 3220 2023  bos**2 / B**2  #
-0001c5b0: 2074 6f64 6f3a 2044 2c20 4d0d 0a20 2020   todo: D, M..   
-0001c5c0: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-0001c5d0: 203d 206e 702e 6172 676d 6178 286e 702e   = np.argmax(np.
-0001c5e0: 7375 6d28 3120 2f20 7661 722c 2061 7869  sum(1 / var, axi
-0001c5f0: 733d 3129 290d 0a0d 0a20 2020 2020 2020  s=1))....       
-0001c600: 2020 2020 2020 2020 206c 203d 206c 636f           l = lco
-0001c610: 6d62 6f73 5b69 6478 5d0d 0a0d 0a20 2020  mbos[idx]....   
-0001c620: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001c630: 4b20 3c20 7365 6c66 2e4b 3a0d 0a20 2020  K < self.K:..   
-0001c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c650: 206c 203d 206e 702e 636f 6e63 6174 656e   l = np.concaten
-0001c660: 6174 6528 286e 702e 6675 6c6c 2873 656c  ate((np.full(sel
-0001c670: 662e 4b20 2d20 4b2c 206c 6d69 6e29 2c20  f.K - K, lmin), 
-0001c680: 6c29 290d 0a0d 0a20 2020 2020 2020 2020  l))....         
-0001c690: 2020 2020 2020 2023 2077 6869 6c65 206c         # while l
-0001c6a0: 6d61 7820 3c20 7365 6c66 2e4c 2061 6e64  max < self.L and
-0001c6b0: 206e 702e 6763 6428 6c6d 696e 2c20 6c6d   np.gcd(lmin, lm
-0001c6c0: 6178 2920 213d 2031 3a0d 0a20 2020 2020  ax) != 1:..     
-0001c6d0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0001c6e0: 206c 6d61 7820 2b3d 2031 2020 2320 6d61   lmax += 1  # ma
-0001c6f0: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
-0001c700: 6974 6572 6174 696f 6e73 3f20 3d20 6d69  iterations? = mi
-0001c710: 6e28 6e65 7874 2070 7269 6d65 2061 6674  n(next prime aft
-0001c720: 6572 206c 6d61 7820 2d20 6c6d 6178 2c20  er lmax - lmax, 
-0001c730: 6d61 7828 302c 204c 202d 206c 6d61 782c  max(0, L - lmax,
-0001c740: 2029 290d 0a20 2020 2020 2020 2020 2020   ))..           
-0001c750: 2020 2020 2023 206c 203d 206e 702e 6172       # l = np.ar
-0001c760: 7261 7928 5b6c 6d69 6e5d 202a 2028 7365  ray([lmin] * (se
-0001c770: 6c66 2e4b 202d 2031 2920 2b20 5b6c 6d61  lf.K - 1) + [lma
-0001c780: 785d 290d 0a0d 0a20 2020 2020 2020 2020  x])....         
-0001c790: 2020 2020 2020 2023 2076 6d61 7820 3d20         # vmax = 
-0001c7a0: 696e 7428 6d61 7828 3120 6966 2073 656c  int(max(1 if sel
-0001c7b0: 662e 4b20 3d3d 2031 2065 6c73 6520 322c  f.K == 1 else 2,
-0001c7c0: 2073 656c 662e 766d 6178 2929 2020 2320   self.vmax))  # 
-0001c7d0: 746f 646f 3a20 7269 7070 6c65 7320 6672  todo: ripples fr
-0001c7e0: 6f6d 2069 6e74 2829 0d0a 2020 2020 2020  om int()..      
-0001c7f0: 2020 2020 2020 2020 2020 2320 7620 3d20            # v = 
-0001c800: 6e70 2e61 7272 6179 285b 766d 6178 5d20  np.array([vmax] 
-0001c810: 2a20 2873 656c 662e 4b20 2d20 3129 202b  * (self.K - 1) +
-0001c820: 205b 766d 6178 202d 2031 5d29 2020 2320   [vmax - 1])  # 
-0001c830: 7477 6f20 636f 6e73 6563 7574 6976 6520  two consecutive 
-0001c840: 6e75 6d62 6572 7320 6172 6520 616c 7761  numbers are alwa
-0001c850: 7973 2063 6f70 7269 6d65 0d0a 2020 2020  ys coprime..    
-0001c860: 2020 2020 2020 2020 2020 2020 2320 6c76              # lv
-0001c870: 203d 2073 656c 662e 4c20 2f20 760d 0a20   = self.L / v.. 
-0001c880: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001c890: 206c 7620 3d20 6e70 2e6d 6178 696d 756d   lv = np.maximum
-0001c8a0: 2873 656c 662e 5f6c 6d69 6e2c 206e 702e  (self._lmin, np.
-0001c8b0: 6d69 6e69 6d75 6d28 6c76 2c20 7365 6c66  minimum(lv, self
-0001c8c0: 2e4c 2929 0d0a 2020 2020 2020 2020 2020  .L))..          
-0001c8d0: 2020 2020 2020 230d 0a20 2020 2020 2020        #..       
-0001c8e0: 2020 2020 2020 2020 2023 2069 6478 203d           # idx =
-0001c8f0: 206e 702e 6172 676d 6178 2828 6e70 2e73   np.argmax((np.s
-0001c900: 756d 2831 202f 2028 6c20 2a2a 2032 292c  um(1 / (l ** 2),
-0001c910: 2061 7869 733d 3029 2c20 6e70 2e73 756d   axis=0), np.sum
-0001c920: 2831 202f 2028 6c76 202a 2a20 3229 2c20  (1 / (lv ** 2), 
-0001c930: 6178 6973 3d30 2929 290d 0a20 2020 2020  axis=0)))..     
-0001c940: 2020 2020 2020 2020 2020 2023 206c 203d             # l =
-0001c950: 206c 2069 6620 6964 7820 3d3d 2030 2065   l if idx == 0 e
-0001c960: 6c73 6520 6c76 0d0a 2020 2020 2020 2020  lse lv..        
-0001c970: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-0001c980: 226c 2220 6966 2069 6478 203d 3d20 3020  "l" if idx == 0 
-0001c990: 656c 7365 2022 7622 290d 0a20 2020 2020  else "v")..     
-0001c9a0: 2020 2020 2020 2065 6c69 6620 6c20 3d3d         elif l ==
-0001c9b0: 2022 636c 6f73 6522 3a0d 0a20 2020 2020   "close":..     
-0001c9c0: 2020 2020 2020 2020 2020 206c 6d69 6e20             lmin 
-0001c9d0: 3d20 696e 7428 6d61 7828 6e70 2e63 6569  = int(max(np.cei
-0001c9e0: 6c28 7365 6c66 2e6c 6d69 6e29 2c20 7365  l(self.lmin), se
-0001c9f0: 6c66 2e4c 202a 2a20 2831 202f 2073 656c  lf.L ** (1 / sel
-0001ca00: 662e 4b29 202d 2073 656c 662e 4b29 290d  f.K) - self.K)).
-0001ca10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ca20: 206c 203d 206c 6d69 6e20 2b20 6e70 2e61   l = lmin + np.a
-0001ca30: 7261 6e67 6528 7365 6c66 2e4b 290d 0a20  range(self.K).. 
-0001ca40: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001ca50: 6869 6c65 206e 702e 6c63 6d2e 7265 6475  hile np.lcm.redu
-0001ca60: 6365 286c 2920 3c20 7365 6c66 2e4c 3a0d  ce(l) < self.L:.
-0001ca70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ca80: 2020 2020 206c 202b 3d20 310d 0a20 2020       l += 1..   
-0001ca90: 2020 2020 2020 2020 2065 6c69 6620 6c20           elif l 
-0001caa0: 3d3d 2022 736d 616c 6c22 3a0d 0a20 2020  == "small":..   
-0001cab0: 2020 2020 2020 2020 2020 2020 206c 6d69               lmi
-0001cac0: 6e20 3d20 696e 7428 6e70 2e63 6569 6c28  n = int(np.ceil(
-0001cad0: 7365 6c66 2e6c 6d69 6e29 290d 0a20 2020  self.lmin))..   
-0001cae0: 2020 2020 2020 2020 2020 2020 206c 6d61               lma
-0001caf0: 7820 3d20 696e 7428 6e70 2e63 6569 6c28  x = int(np.ceil(
-0001cb00: 7365 6c66 2e4c 202a 2a20 2831 202f 2073  self.L ** (1 / s
-0001cb10: 656c 662e 4b29 2929 2020 2320 7761 7665  elf.K)))  # wave
-0001cb20: 6c65 6e67 7468 7320 6172 6520 6172 6f75  lengths are arou
-0001cb30: 6e64 206b 7468 2072 6f6f 7420 6f66 2073  nd kth root of s
-0001cb40: 656c 662e 4c0d 0a0d 0a20 2020 2020 2020  elf.L....       
-0001cb50: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0001cb60: 2e4b 203e 3d20 323a 0d0a 2020 2020 2020  .K >= 2:..      
-0001cb70: 2020 2020 2020 2020 2020 2020 2020 6c6d                lm
-0001cb80: 6178 202b 3d20 310d 0a0d 0a20 2020 2020  ax += 1....     
-0001cb90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001cba0: 6620 7365 6c66 2e4b 203e 3d20 333a 0d0a  f self.K >= 3:..
-0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbc0: 2020 2020 2020 2020 6c6d 6178 202b 3d20          lmax += 
-0001cbd0: 310d 0a0d 0a20 2020 2020 2020 2020 2020  1....           
-0001cbe0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001cbf0: 6c6d 6178 2025 2032 203d 3d20 303a 2020  lmax % 2 == 0:  
-0001cc00: 2320 6b74 6820 726f 6f74 2077 6173 2065  # kth root was e
-0001cc10: 7665 6e0d 0a20 2020 2020 2020 2020 2020  ven..           
-0001cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc30: 206c 6d61 7820 2b3d 2031 0d0a 0d0a 2020   lmax += 1....  
-0001cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc50: 2020 2020 2020 6966 2073 656c 662e 4b20        if self.K 
-0001cc60: 3e20 333a 0d0a 2020 2020 2020 2020 2020  > 3:..          
-0001cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc80: 2020 6974 6820 3d20 7365 6c66 2e4b 202d    ith = self.K -
-0001cc90: 2033 0d0a 2020 2020 2020 2020 2020 2020   3..            
+0001be10: 2020 290d 0a0d 0a20 2020 2020 2020 2020    )....         
+0001be20: 2020 2020 2020 2020 2020 2069 6478 203d             idx =
+0001be30: 206e 702e 6172 676d 6178 286e 702e 7375   np.argmax(np.su
+0001be40: 6d28 3120 2f20 636f 6d62 6f73 2a2a 322c  m(1 / combos**2,
+0001be50: 2061 7869 733d 3129 290d 0a20 2020 2020   axis=1))..     
+0001be60: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001be70: 203d 2063 6f6d 626f 735b 6964 785d 0d0a   = combos[idx]..
+0001be80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001be90: 2020 6966 204b 203c 2073 656c 662e 4b3a    if K < self.K:
+0001bea0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001beb0: 2020 2020 2020 6c20 3d20 6e70 2e63 6f6e        l = np.con
+0001bec0: 6361 7465 6e61 7465 2828 6c2c 206e 702e  catenate((l, np.
+0001bed0: 6172 616e 6765 286c 2e6d 6178 2829 202b  arange(l.max() +
+0001bee0: 2031 2c20 6c2e 6d61 7828 2920 2b20 3120   1, l.max() + 1 
+0001bef0: 2b20 7365 6c66 2e4b 202d 204b 2929 290d  + self.K - K))).
+0001bf00: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0001bf10: 6620 6c20 3d3d 2022 6578 706f 6e65 6e74  f l == "exponent
+0001bf20: 6961 6c22 3a0d 0a20 2020 2020 2020 2020  ial":..         
+0001bf30: 2020 2020 2020 206c 203d 206e 702e 636f         l = np.co
+0001bf40: 6e63 6174 656e 6174 6528 285b 6e70 2e69  ncatenate(([np.i
+0001bf50: 6e66 5d2c 206e 702e 6765 6f6d 7370 6163  nf], np.geomspac
+0001bf60: 6528 7365 6c66 2e4c 2c20 7365 6c66 2e6c  e(self.L, self.l
+0001bf70: 6d69 6e2c 2073 656c 662e 4b20 2d20 3129  min, self.K - 1)
+0001bf80: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
+0001bf90: 656c 6966 206c 203d 3d20 226c 696e 6561  elif l == "linea
+0001bfa0: 7222 3a0d 0a20 2020 2020 2020 2020 2020  r":..           
+0001bfb0: 2020 2020 206c 203d 206e 702e 636f 6e63       l = np.conc
+0001bfc0: 6174 656e 6174 6528 285b 6e70 2e69 6e66  atenate(([np.inf
+0001bfd0: 5d2c 206e 702e 6c69 6e73 7061 6365 2873  ], np.linspace(s
+0001bfe0: 656c 662e 4c2c 2073 656c 662e 6c6d 696e  elf.L, self.lmin
+0001bff0: 2c20 7365 6c66 2e4b 202d 2031 2929 290d  , self.K - 1))).
+0001c000: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001c010: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0001c020: 2020 2020 7265 7475 726e 0d0a 0d0a 2020      return....  
+0001c030: 2020 2020 2020 7365 6c66 2e5f 554d 5220        self._UMR 
+0001c040: 3d20 4e6f 6e65 2020 2320 746f 2062 6520  = None  # to be 
+0001c050: 7361 6665 0d0a 2020 2020 2020 2020 5f6c  safe..        _l
+0001c060: 203d 206e 702e 6172 7261 7928 6c2c 2066   = np.array(l, f
+0001c070: 6c6f 6174 290d 0a20 2020 2020 2020 2073  loat)..        s
+0001c080: 656c 662e 7620 3d20 7365 6c66 2e4c 202f  elf.v = self.L /
+0001c090: 206e 702e 6172 7261 7928 6c2c 2066 6c6f   np.array(l, flo
+0001c0a0: 6174 290d 0a0d 0a20 2020 2040 7072 6f70  at)....    @prop
+0001c0b0: 6572 7479 0d0a 2020 2020 6465 6620 5f6c  erty..    def _l
+0001c0c0: 2873 656c 6629 202d 3e20 6e70 2e6e 6461  (self) -> np.nda
+0001c0d0: 7272 6179 3a20 2023 206b 6570 7420 666f  rray:  # kept fo
+0001c0e0: 7220 6261 636b 7761 7264 7320 636f 6d70  r backwards comp
+0001c0f0: 6174 6962 696c 6974 7920 7769 7468 2066  atibility with f
+0001c100: 7269 6e67 6573 2d47 5549 0d0a 2020 2020  ringes-GUI..    
+0001c110: 2020 2020 2222 2257 6176 656c 656e 6774      """Wavelengt
+0001c120: 6873 206f 6620 6672 696e 6765 2070 6572  hs of fringe per
+0001c130: 696f 6473 2e0d 0a20 2020 2020 2020 205b  iods...        [
+0001c140: 6c5d 203d 2070 782e 0d0a 0d0a 2020 2020  l] = px.....    
+0001c150: 2020 2020 5768 656e 204c 2063 6861 6e67      When L chang
+0001c160: 6573 2c20 7620 6973 206b 6570 7420 636f  es, v is kept co
+0001c170: 6e73 7461 6e74 2061 6e64 206f 6e6c 7920  nstant and only 
+0001c180: 6c20 6973 2063 6861 6e67 6564 2e22 2222  l is changed."""
+0001c190: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001c1a0: 2073 656c 662e 4c20 2f20 7365 6c66 2e5f   self.L / self._
+0001c1b0: 760d 0a0d 0a20 2020 2040 7072 6f70 6572  v....    @proper
+0001c1c0: 7479 0d0a 2020 2020 6465 6620 766d 6178  ty..    def vmax
+0001c1d0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+0001c1e0: 0d0a 2020 2020 2020 2020 2222 224d 6178  ..        """Max
+0001c1f0: 696d 756d 2072 6573 6f6c 7661 626c 6520  imum resolvable 
+0001c200: 7370 6174 6961 6c20 6672 6571 7565 6e63  spatial frequenc
+0001c210: 792e 2222 220d 0a20 2020 2020 2020 2072  y."""..        r
+0001c220: 6574 7572 6e20 7365 6c66 2e4c 202f 2073  eturn self.L / s
+0001c230: 656c 662e 6c6d 696e 0d0a 0d0a 2020 2020  elf.lmin....    
+0001c240: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+0001c250: 6566 2076 6f70 7428 7365 6c66 2920 2d3e  ef vopt(self) ->
+0001c260: 2066 6c6f 6174 3a0d 0a20 2020 2020 2020   float:..       
+0001c270: 2022 2222 4f70 7469 6d61 6c20 7370 6174   """Optimal spat
+0001c280: 6961 6c20 6672 6571 7565 6e63 7920 666f  ial frequency fo
+0001c290: 7220 6d69 6e69 6d61 6c20 6465 636f 6469  r minimal decodi
+0001c2a0: 6e67 2075 6e63 6572 7461 696e 7479 2e22  ng uncertainty."
+0001c2b0: 2222 0d0a 0d0a 2020 2020 2020 2020 6966  ""....        if
+0001c2c0: 2073 656c 662e 4276 2069 7320 6e6f 7420   self.Bv is not 
+0001c2d0: 4e6f 6e65 3a20 2023 2069 6e74 6572 706f  None:  # interpo
+0001c2e0: 6c61 7465 2066 726f 6d20 6d65 6173 7572  late from measur
+0001c2f0: 656d 656e 740d 0a20 2020 2020 2020 2020  ement..         
+0001c300: 2020 2076 203d 206e 702e 6172 616e 6765     v = np.arange
+0001c310: 2831 2c20 7365 6c66 2e76 6d61 7820 2b20  (1, self.vmax + 
+0001c320: 3129 0d0a 2020 2020 2020 2020 2020 2020  1)..            
+0001c330: 4220 3d20 7365 6c66 2e4d 5446 2876 290d  B = self.MTF(v).
+0001c340: 0a20 2020 2020 2020 2020 2020 204e 203d  .            N =
+0001c350: 2073 656c 662e 5f4e 2e72 6176 656c 2829   self._N.ravel()
+0001c360: 5b6e 702e 6172 6770 6172 7469 7469 6f6e  [np.argpartition
+0001c370: 2873 656c 662e 5f4e 2e72 6176 656c 2829  (self._N.ravel()
+0001c380: 2c20 696e 7428 7365 6c66 2e5f 4e2e 7369  , int(self._N.si
+0001c390: 7a65 202f 2f20 3229 295b 696e 7428 7365  ze // 2))[int(se
+0001c3a0: 6c66 2e5f 4e2e 7369 7a65 202f 2f20 3229  lf._N.size // 2)
+0001c3b0: 5d5d 0d0a 2020 2020 2020 2020 2020 2020  ]]..            
+0001c3c0: 7661 7220 3d20 3120 2f20 7365 6c66 2e4d  var = 1 / self.M
+0001c3d0: 202f 204e 202f 2028 762a 2a32 2920 2f20   / N / (v**2) / 
+0001c3e0: 422a 2a32 2020 2320 746f 646f 3a20 442c  B**2  # todo: D,
+0001c3f0: 204d 0d0a 2020 2020 2020 2020 2020 2020   M..            
+0001c400: 6964 7820 3d20 6e70 2e61 7267 6d61 7828  idx = np.argmax(
+0001c410: 6e70 2e73 756d 2831 202f 2076 6172 2c20  np.sum(1 / var, 
+0001c420: 6178 6973 3d31 2929 0d0a 2020 2020 2020  axis=1))..      
+0001c430: 2020 2020 2020 766f 7074 203d 2076 5b69        vopt = v[i
+0001c440: 6478 5d0d 0a20 2020 2020 2020 2065 6c69  dx]..        eli
+0001c450: 6620 7365 6c66 2e50 5346 203e 2030 3a20  f self.PSF > 0: 
+0001c460: 2023 2064 6574 6572 6d69 6e65 2066 726f   # determine fro
+0001c470: 6d20 5053 460d 0a20 2020 2020 2020 2020  m PSF..         
+0001c480: 2020 2076 6f70 745f 203d 2031 202f 2028     vopt_ = 1 / (
+0001c490: 3220 2a20 6e70 2e70 6920 2a20 7365 6c66  2 * np.pi * self
+0001c4a0: 2e50 5346 2920 2023 2074 6f64 6f0d 0a20  .PSF)  # todo.. 
+0001c4b0: 2020 2020 2020 2020 2020 206c 6f70 7420             lopt 
+0001c4c0: 3d20 3120 2f20 766f 7074 5f0d 0a20 2020  = 1 / vopt_..   
+0001c4d0: 2020 2020 2020 2020 2076 6f70 7420 3d20           vopt = 
+0001c4e0: 7365 6c66 2e4c 202f 206c 6f70 740d 0a20  self.L / lopt.. 
+0001c4f0: 2020 2020 2020 2020 2020 2076 6f70 7420             vopt 
+0001c500: 3d20 7365 6c66 2e76 6d61 7820 2f20 3220  = self.vmax / 2 
+0001c510: 2023 2061 7070 726f 7869 6d61 7469 6f6e   # approximation
+0001c520: 205b 426f 7468 6532 3030 385d 0d0a 2020   [Bothe2008]..  
+0001c530: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+0001c540: 2020 2020 2020 2020 2076 6f70 7420 3d20           vopt = 
+0001c550: 696e 7428 7365 6c66 2e76 6d61 7829 0d0a  int(self.vmax)..
+0001c560: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001c570: 2076 6f70 740d 0a0d 0a20 2020 2040 7072   vopt....    @pr
+0001c580: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
+0001c590: 7628 7365 6c66 2920 2d3e 206e 702e 6e64  v(self) -> np.nd
+0001c5a0: 6172 7261 793a 0d0a 2020 2020 2020 2020  array:..        
+0001c5b0: 2222 2253 7061 7469 616c 2066 7265 7175  """Spatial frequ
+0001c5c0: 656e 6369 6573 2028 6e75 6d62 6572 206f  encies (number o
+0001c5d0: 6620 7065 7269 6f64 732f 6672 696e 6765  f periods/fringe
+0001c5e0: 7320 6163 726f 7373 206d 6178 696d 756d  s across maximum
+0001c5f0: 2063 6f64 696e 6720 6c65 6e67 7468 292e   coding length).
+0001c600: 2222 220d 0a20 2020 2020 2020 2069 6620  """..        if 
+0001c610: 7365 6c66 2e44 203d 3d20 3120 6f72 206c  self.D == 1 or l
+0001c620: 656e 286e 702e 756e 6971 7565 2873 656c  en(np.unique(sel
+0001c630: 662e 5f76 2c20 6178 6973 3d30 2929 203d  f._v, axis=0)) =
+0001c640: 3d20 313a 2020 2320 7365 7473 2069 6e20  = 1:  # sets in 
+0001c650: 6469 7265 6374 696f 6e73 2061 7265 2069  directions are i
+0001c660: 6465 6e74 6963 616c 0d0a 2020 2020 2020  dentical..      
+0001c670: 2020 2020 2020 7620 3d20 7365 6c66 2e5f        v = self._
+0001c680: 765b 305d 2020 2320 3144 0d0a 2020 2020  v[0]  # 1D..    
+0001c690: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+0001c6a0: 2020 2020 2020 2076 203d 2073 656c 662e         v = self.
+0001c6b0: 5f76 2020 2320 3244 0d0a 2020 2020 2020  _v  # 2D..      
+0001c6c0: 2020 7265 7475 726e 2076 0d0a 0d0a 2020    return v....  
+0001c6d0: 2020 4076 2e73 6574 7465 720d 0a20 2020    @v.setter..   
+0001c6e0: 2064 6566 2076 2873 656c 662c 2076 3a20   def v(self, v: 
+0001c6f0: 696e 7420 7c20 666c 6f61 7420 7c20 7475  int | float | tu
+0001c700: 706c 655b 696e 7420 7c20 666c 6f61 745d  ple[int | float]
+0001c710: 207c 206c 6973 745b 696e 7420 7c20 666c   | list[int | fl
+0001c720: 6f61 745d 207c 206e 702e 6e64 6172 7261  oat] | np.ndarra
+0001c730: 7920 7c20 7374 7229 3a0d 0a20 2020 2020  y | str):..     
+0001c740: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0001c750: 2876 2c20 7374 7229 3a0d 0a20 2020 2020  (v, str):..     
+0001c760: 2020 2020 2020 2069 6620 7620 3d3d 2022         if v == "
+0001c770: 6f70 7469 6d61 6c22 3a0d 0a20 2020 2020  optimal":..     
+0001c780: 2020 2020 2020 2020 2020 2023 207c 7b76             # |{v
+0001c790: 7d7c 203d 2032 0d0a 2020 2020 2020 2020  }| = 2..        
+0001c7a0: 2020 2020 2020 2020 766d 6178 203d 2069          vmax = i
+0001c7b0: 6e74 286d 6178 2831 2069 6620 7365 6c66  nt(max(1 if self
+0001c7c0: 2e4b 203d 3d20 3120 656c 7365 2032 2c20  .K == 1 else 2, 
+0001c7d0: 7365 6c66 2e76 6f70 7429 290d 0a20 2020  self.vopt))..   
+0001c7e0: 2020 2020 2020 2020 2020 2020 2076 203d               v =
+0001c7f0: 206e 702e 6172 7261 7928 5b76 6d61 785d   np.array([vmax]
+0001c800: 202a 2028 7365 6c66 2e4b 202d 2031 2920   * (self.K - 1) 
+0001c810: 2b20 5b76 6d61 7820 2d20 315d 2920 2023  + [vmax - 1])  #
+0001c820: 2074 776f 2063 6f6e 7365 6375 7469 7665   two consecutive
+0001c830: 206e 756d 6265 7273 2061 7265 2061 6c77   numbers are alw
+0001c840: 6179 7320 636f 7072 696d 650d 0a0d 0a20  ays coprime.... 
+0001c850: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001c860: 2023 2023 207c 7b76 7d7c 203d 204b 0d0a   # # |{v}| = K..
+0001c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c880: 2320 766d 6178 203d 2069 6e74 286d 6178  # vmax = int(max
+0001c890: 2873 656c 662e 4b2c 2073 656c 662e 766f  (self.K, self.vo
+0001c8a0: 7074 2929 0d0a 2020 2020 2020 2020 2020  pt))..          
+0001c8b0: 2020 2020 2020 2320 7620 3d20 766d 6178        # v = vmax
+0001c8c0: 202d 206e 702e 6172 616e 6765 2873 656c   - np.arange(sel
+0001c8d0: 662e 4b29 0d0a 2020 2020 2020 2020 2020  f.K)..          
+0001c8e0: 2020 656c 6966 2076 203d 3d20 2265 7870    elif v == "exp
+0001c8f0: 6f6e 656e 7469 616c 223a 0d0a 2020 2020  onential":..    
+0001c900: 2020 2020 2020 2020 2020 2020 2320 4b20              # K 
+0001c910: 3d20 696e 7428 6e70 2e63 6569 6c28 6e70  = int(np.ceil(np
+0001c920: 2e6c 6f67 3228 7365 6c66 2e76 6d61 7829  .log2(self.vmax)
+0001c930: 2929 202b 2031 2020 2320 2b20 313a 2032  )) + 1  # + 1: 2
+0001c940: 202a 2a20 3020 3d20 310d 0a20 2020 2020   ** 0 = 1..     
+0001c950: 2020 2020 2020 2020 2020 2076 203d 206e             v = n
+0001c960: 702e 636f 6e63 6174 656e 6174 6528 285b  p.concatenate(([
+0001c970: 305d 2c20 6e70 2e67 656f 6d73 7061 6365  0], np.geomspace
+0001c980: 2831 2c20 7365 6c66 2e76 6d61 782c 2073  (1, self.vmax, s
+0001c990: 656c 662e 4b20 2d20 3129 2929 0d0a 2020  elf.K - 1)))..  
+0001c9a0: 2020 2020 2020 2020 2020 656c 6966 2076            elif v
+0001c9b0: 203d 3d20 226c 696e 6561 7222 3a0d 0a20   == "linear":.. 
+0001c9c0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0001c9d0: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
+0001c9e0: 6528 285b 305d 2c20 6e70 2e6c 696e 7370  e(([0], np.linsp
+0001c9f0: 6163 6528 312c 2073 656c 662e 766d 6178  ace(1, self.vmax
+0001ca00: 2c20 7365 6c66 2e4b 202d 2031 2929 290d  , self.K - 1))).
+0001ca10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001ca20: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0001ca30: 2020 2020 7265 7475 726e 0d0a 0d0a 2020      return....  
+0001ca40: 2020 2020 2020 5f76 203d 206e 702e 6172        _v = np.ar
+0001ca50: 7261 7928 762c 2066 6c6f 6174 292e 636c  ray(v, float).cl
+0001ca60: 6970 2830 2c20 7365 6c66 2e76 6d61 7829  ip(0, self.vmax)
+0001ca70: 2020 2320 6d61 6b65 2061 7272 6179 2c20    # make array, 
+0001ca80: 6361 7374 2074 6f20 6474 7970 652c 2063  cast to dtype, c
+0001ca90: 6c69 700d 0a0d 0a20 2020 2020 2020 2069  lip....        i
+0001caa0: 6620 6e6f 7420 5f76 2e73 697a 653a 2020  f not _v.size:  
+0001cab0: 2320 656d 7074 7920 6172 7261 790d 0a20  # empty array.. 
+0001cac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001cad0: 6e0d 0a0d 0a20 2020 2020 2020 205f 7620  n....        _v 
+0001cae0: 3d20 7365 6c66 2e5f 7472 696d 285f 7629  = self._trim(_v)
+0001caf0: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
+0001cb00: 656c 662e 4644 4d3a 0d0a 2020 2020 2020  elf.FDM:..      
+0001cb10: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+0001cb20: 6174 6963 3a0d 0a20 2020 2020 2020 2020  atic:..         
+0001cb30: 2020 2020 2020 2069 6620 280d 0a20 2020         if (..   
+0001cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb50: 205f 762e 7369 7a65 2021 3d20 7365 6c66   _v.size != self
+0001cb60: 2e44 202a 2073 656c 662e 4b0d 0a20 2020  .D * self.K..   
+0001cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb80: 206f 7220 6e6f 7420 6e70 2e61 6c6c 285f   or not np.all(_
+0001cb90: 7620 2520 3120 3d3d 2030 290d 0a20 2020  v % 1 == 0)..   
+0001cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbb0: 206f 7220 6e6f 7420 6e70 2e6c 636d 2e72   or not np.lcm.r
+0001cbc0: 6564 7563 6528 5f76 2e61 7374 7970 6528  educe(_v.astype(
+0001cbd0: 696e 742c 2063 6f70 793d 4661 6c73 6529  int, copy=False)
+0001cbe0: 2e72 6176 656c 2829 2920 3d3d 206e 702e  .ravel()) == np.
+0001cbf0: 7072 6f64 285f 7629 2020 2320 746f 646f  prod(_v)  # todo
+0001cc00: 3a20 6571 7561 6c20 6767 7420 3d20 3120  : equal ggt = 1 
+0001cc10: 3f0d 0a20 2020 2020 2020 2020 2020 2020  ?..             
+0001cc20: 2020 2029 3a20 2023 2074 6f64 6f3a 2061     ):  # todo: a
+0001cc30: 6c6c 6f77 2063 6f70 7269 6d65 733f 210d  llow coprimes?!.
+0001cc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cc50: 2020 2020 206e 203d 206d 696e 2831 302c       n = min(10,
+0001cc60: 2073 656c 662e 766d 6178 202f 2f20 3229   self.vmax // 2)
+0001cc70: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001cc80: 2020 2020 2020 6974 6820 3d20 7365 6c66        ith = self
+0001cc90: 2e44 202a 2073 656c 662e 4b0d 0a20 2020  .D * self.K..   
 0001cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccb0: 6c6d 6178 203d 2073 796d 7079 2e6e 7468  lmax = sympy.nth
-0001ccc0: 656f 7279 2e67 656e 6572 6174 652e 6e65  eory.generate.ne
-0001ccd0: 7874 7072 696d 6528 6c6d 6178 2c20 6974  xtprime(lmax, it
-0001cce0: 6829 0d0a 0d0a 2020 2020 2020 2020 2020  h)....          
-0001ccf0: 2020 2020 2020 6966 206c 6d69 6e20 3e20        if lmin > 
-0001cd00: 6c6d 6178 206f 7220 6c6d 6178 202d 206c  lmax or lmax - l
-0001cd10: 6d69 6e20 2b20 3120 3c3d 2073 656c 662e  min + 1 <= self.
-0001cd20: 4b3a 0d0a 2020 2020 2020 2020 2020 2020  K:..            
-0001cd30: 2020 2020 2020 2020 6c20 3d20 6c6d 696e          l = lmin
-0001cd40: 202b 206e 702e 6172 616e 6765 2873 656c   + np.arange(sel
-0001cd50: 662e 4b29 0d0a 2020 2020 2020 2020 2020  f.K)..          
-0001cd60: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-0001cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd80: 206c 6d61 7820 3d20 6d61 7828 0d0a 2020   lmax = max(..  
-0001cd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cda0: 2020 2020 2020 6c6d 696e 2c20 6d69 6e28        lmin, min(
-0001cdb0: 6c6d 6178 2c20 696e 7428 6e70 2e63 6569  lmax, int(np.cei
-0001cdc0: 6c28 7365 6c66 2e4c 2929 290d 0a20 2020  l(self.L)))..   
-0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cde0: 2029 2020 2320 6d61 7820 696e 206f 7574   )  # max in out
-0001cdf0: 6572 2063 6f6e 6469 7469 6f6e 2065 6e73  er condition ens
-0001ce00: 7572 6573 206c 6d61 7820 3e3d 206c 6d69  ures lmax >= lmi
-0001ce10: 6e20 6576 656e 2069 6620 4c20 3c20 6c6d  n even if L < lm
-0001ce20: 696e 0d0a 2020 2020 2020 2020 2020 2020  in..            
-0001ce30: 2020 2020 2020 2020 6966 206c 6d69 6e20          if lmin 
-0001ce40: 3d3d 206c 6d61 7820 616e 6420 6c6d 6178  == lmax and lmax
-0001ce50: 203c 2073 656c 662e 4c3a 0d0a 2020 2020   < self.L:..    
-0001ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce70: 2020 2020 6c6d 6178 202b 3d20 3120 2023      lmax += 1  #
-0001ce80: 2065 6e73 7572 6573 206c 6d69 6e20 616e   ensures lmin an
-0001ce90: 6420 6c6d 6178 2064 6966 6665 7220 736f  d lmax differ so
-0001cea0: 2074 6861 7420 6c63 6d28 6c29 203e 3d20   that lcm(l) >= 
-0001ceb0: 4c0d 0a0d 0a20 2020 2020 2020 2020 2020  L....           
-0001cec0: 2020 2020 2020 2020 206e 203d 206c 6d61           n = lma
-0001ced0: 7820 2d20 6c6d 696e 202b 2031 0d0a 2020  x - lmin + 1..  
-0001cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cef0: 2020 4b20 3d20 6d69 6e28 7365 6c66 2e4b    K = min(self.K
-0001cf00: 2c20 6e29 2020 2320 656e 7375 7265 7320  , n)  # ensures 
-0001cf10: 4b20 3c3d 206e 0d0a 2020 2020 2020 2020  K <= n..        
-0001cf20: 2020 2020 2020 2020 2020 2020 4320 3d20              C = 
-0001cf30: 7370 2e73 7065 6369 616c 2e63 6f6d 6228  sp.special.comb(
-0001cf40: 6e2c 204b 2c20 6578 6163 743d 5472 7565  n, K, exact=True
-0001cf50: 2c20 7265 7065 7469 7469 6f6e 3d46 616c  , repetition=Fal
-0001cf60: 7365 2920 2023 206e 756d 6265 7220 6f66  se)  # number of
-0001cf70: 2075 6e69 7175 6520 636f 6d62 696e 6174   unique combinat
-0001cf80: 696f 6e73 0d0a 2020 2020 2020 2020 2020  ions..          
-0001cf90: 2020 2020 2020 2020 2020 636f 6d62 6f73            combos
-0001cfa0: 203d 206e 702e 6172 7261 7928 0d0a 2020   = np.array(..  
-0001cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfc0: 2020 2020 2020 5b0d 0a20 2020 2020 2020        [..       
-0001cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfe0: 2020 2020 2063 0d0a 2020 2020 2020 2020       c..        
-0001cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d000: 2020 2020 666f 7220 6320 696e 2069 742e      for c in it.
-0001d010: 636f 6d62 696e 6174 696f 6e73 2872 616e  combinations(ran
-0001d020: 6765 286c 6d69 6e2c 206c 6d61 7820 2b20  ge(lmin, lmax + 
-0001d030: 3129 2c20 4b29 0d0a 2020 2020 2020 2020  1), K)..        
-0001d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d050: 2020 2020 6966 206e 702e 616e 7928 6e70      if np.any(np
-0001d060: 2e61 7272 6179 285b 635d 2920 3e20 7365  .array([c]) > se
-0001d070: 6c66 2e4c 202a 2a20 2831 202f 2073 656c  lf.L ** (1 / sel
-0001d080: 662e 4b29 2920 616e 6420 6e70 2e6c 636d  f.K)) and np.lcm
-0001d090: 2e72 6564 7563 6528 6329 203e 3d20 7365  .reduce(c) >= se
-0001d0a0: 6c66 2e4c 0d0a 2020 2020 2020 2020 2020  lf.L..          
-0001d0b0: 2020 2020 2020 2020 2020 2020 2020 5d0d                ].
-0001d0c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d0d0: 2020 2020 2029 0d0a 0d0a 2020 2020 2020       )....      
-0001d0e0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-0001d0f0: 7820 3d20 6e70 2e61 7267 6d61 7828 6e70  x = np.argmax(np
-0001d100: 2e73 756d 2831 202f 2063 6f6d 626f 732a  .sum(1 / combos*
-0001d110: 2a32 2c20 6178 6973 3d31 2929 0d0a 2020  *2, axis=1))..  
-0001d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d130: 2020 6c20 3d20 636f 6d62 6f73 5b69 6478    l = combos[idx
-0001d140: 5d0d 0a0d 0a20 2020 2020 2020 2020 2020  ]....           
-0001d150: 2020 2020 2020 2020 2069 6620 6964 7820           if idx 
-0001d160: 213d 2030 3a0d 0a20 2020 2020 2020 2020  != 0:..         
-0001d170: 2020 2020 2020 2020 2020 2020 2020 2071                 q
-0001d180: 203d 2031 0d0a 0d0a 2020 2020 2020 2020   = 1....        
-0001d190: 2020 2020 2020 2020 6966 204b 203c 2073          if K < s
-0001d1a0: 656c 662e 4b3a 0d0a 2020 2020 2020 2020  elf.K:..        
-0001d1b0: 2020 2020 2020 2020 2020 2020 6c20 3d20              l = 
-0001d1c0: 6e70 2e63 6f6e 6361 7465 6e61 7465 2828  np.concatenate((
-0001d1d0: 6c2c 206e 702e 6172 616e 6765 286c 2e6d  l, np.arange(l.m
-0001d1e0: 6178 2829 202b 2031 2c20 6c2e 6d61 7828  ax() + 1, l.max(
-0001d1f0: 2920 2b20 3120 2b20 7365 6c66 2e4b 202d  ) + 1 + self.K -
-0001d200: 204b 2929 290d 0a20 2020 2020 2020 2020   K)))..         
-0001d210: 2020 2065 6c69 6620 6c20 3d3d 2022 6578     elif l == "ex
-0001d220: 706f 6e65 6e74 6961 6c22 3a0d 0a20 2020  ponential":..   
-0001d230: 2020 2020 2020 2020 2020 2020 206c 203d               l =
-0001d240: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
-0001d250: 285b 6e70 2e69 6e66 5d2c 206e 702e 6765  ([np.inf], np.ge
-0001d260: 6f6d 7370 6163 6528 7365 6c66 2e4c 2c20  omspace(self.L, 
-0001d270: 7365 6c66 2e6c 6d69 6e2c 2073 656c 662e  self.lmin, self.
-0001d280: 4b20 2d20 3129 2929 0d0a 2020 2020 2020  K - 1)))..      
-0001d290: 2020 2020 2020 656c 6966 206c 203d 3d20        elif l == 
-0001d2a0: 226c 696e 6561 7222 3a0d 0a20 2020 2020  "linear":..     
-0001d2b0: 2020 2020 2020 2020 2020 206c 203d 206e             l = n
-0001d2c0: 702e 636f 6e63 6174 656e 6174 6528 285b  p.concatenate(([
-0001d2d0: 6e70 2e69 6e66 5d2c 206e 702e 6c69 6e73  np.inf], np.lins
-0001d2e0: 7061 6365 2873 656c 662e 4c2c 2073 656c  pace(self.L, sel
-0001d2f0: 662e 6c6d 696e 2c20 7365 6c66 2e4b 202d  f.lmin, self.K -
-0001d300: 2031 2929 290d 0a20 2020 2020 2020 2020   1)))..         
-0001d310: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-0001d320: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001d330: 0d0a 0d0a 2020 2020 2020 2020 7365 6c66  ....        self
-0001d340: 2e5f 554d 5220 3d20 4e6f 6e65 2020 2320  ._UMR = None  # 
-0001d350: 746f 2062 6520 7361 6665 0d0a 2020 2020  to be safe..    
-0001d360: 2020 2020 7365 6c66 2e76 203d 2073 656c      self.v = sel
-0001d370: 662e 4c20 2f20 6e70 2e61 7272 6179 286c  f.L / np.array(l
-0001d380: 2c20 666c 6f61 7429 0d0a 0d0a 2020 2020  , float)....    
-0001d390: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
-0001d3a0: 6566 205f 6c28 7365 6c66 2920 2d3e 206e  ef _l(self) -> n
-0001d3b0: 702e 6e64 6172 7261 793a 2020 2320 6b65  p.ndarray:  # ke
-0001d3c0: 7074 2066 6f72 2062 6163 6b77 6172 6473  pt for backwards
-0001d3d0: 2063 6f6d 7061 7469 6269 6c69 7479 2077   compatibility w
-0001d3e0: 6974 6820 6672 696e 6765 732d 4755 490d  ith fringes-GUI.
-0001d3f0: 0a20 2020 2020 2020 2022 2222 5761 7665  .        """Wave
-0001d400: 6c65 6e67 7468 7320 6f66 2066 7269 6e67  lengths of fring
-0001d410: 6520 7065 7269 6f64 732e 0d0a 2020 2020  e periods...    
-0001d420: 2020 2020 5b6c 5d20 3d20 7078 2e0d 0a0d      [l] = px....
-0001d430: 0a20 2020 2020 2020 2057 6865 6e20 4c20  .        When L 
-0001d440: 6368 616e 6765 732c 2076 2069 7320 6b65  changes, v is ke
-0001d450: 7074 2063 6f6e 7374 616e 7420 616e 6420  pt constant and 
-0001d460: 6f6e 6c79 206c 2069 7320 6368 616e 6765  only l is change
-0001d470: 642e 2222 220d 0a20 2020 2020 2020 2072  d."""..        r
-0001d480: 6574 7572 6e20 7365 6c66 2e4c 202f 2073  eturn self.L / s
-0001d490: 656c 662e 5f76 0d0a 0d0a 2020 2020 4070  elf._v....    @p
-0001d4a0: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
-0001d4b0: 2076 6d61 7828 7365 6c66 2920 2d3e 2066   vmax(self) -> f
-0001d4c0: 6c6f 6174 3a0d 0a20 2020 2020 2020 2022  loat:..        "
-0001d4d0: 2222 4d61 7869 6d75 6d20 7265 736f 6c76  ""Maximum resolv
-0001d4e0: 6162 6c65 2073 7061 7469 616c 2066 7265  able spatial fre
-0001d4f0: 7175 656e 6379 2e22 2222 0d0a 2020 2020  quency."""..    
-0001d500: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0001d510: 4c20 2f20 7365 6c66 2e6c 6d69 6e0d 0a0d  L / self.lmin...
-0001d520: 0a20 2020 2040 7072 6f70 6572 7479 0d0a  .    @property..
-0001d530: 2020 2020 6465 6620 766f 7074 2873 656c      def vopt(sel
-0001d540: 6629 202d 3e20 666c 6f61 743a 0d0a 2020  f) -> float:..  
-0001d550: 2020 2020 2020 2222 224f 7074 696d 616c        """Optimal
-0001d560: 2073 7061 7469 616c 2066 7265 7175 656e   spatial frequen
-0001d570: 6379 2066 6f72 206d 696e 696d 616c 2064  cy for minimal d
-0001d580: 6563 6f64 696e 6720 756e 6365 7274 6169  ecoding uncertai
-0001d590: 6e74 792e 2222 220d 0a0d 0a20 2020 2020  nty."""....     
-0001d5a0: 2020 2069 6620 7365 6c66 2e42 7620 6973     if self.Bv is
-0001d5b0: 206e 6f74 204e 6f6e 653a 2020 2320 696e   not None:  # in
-0001d5c0: 7465 7270 6f6c 6174 6520 6672 6f6d 206d  terpolate from m
-0001d5d0: 6561 7375 7265 6d65 6e74 0d0a 2020 2020  easurement..    
-0001d5e0: 2020 2020 2020 2020 7620 3d20 6e70 2e61          v = np.a
-0001d5f0: 7261 6e67 6528 312c 2073 656c 662e 766d  range(1, self.vm
-0001d600: 6178 202b 2031 290d 0a20 2020 2020 2020  ax + 1)..       
-0001d610: 2020 2020 2042 203d 2073 656c 662e 4d54       B = self.MT
-0001d620: 4628 7629 0d0a 2020 2020 2020 2020 2020  F(v)..          
-0001d630: 2020 4e20 3d20 7365 6c66 2e5f 4e2e 7261    N = self._N.ra
-0001d640: 7665 6c28 295b 6e70 2e61 7267 7061 7274  vel()[np.argpart
-0001d650: 6974 696f 6e28 7365 6c66 2e5f 4e2e 7261  ition(self._N.ra
-0001d660: 7665 6c28 292c 2069 6e74 2873 656c 662e  vel(), int(self.
-0001d670: 5f4e 2e73 697a 6520 2f2f 2032 2929 5b69  _N.size // 2))[i
-0001d680: 6e74 2873 656c 662e 5f4e 2e73 697a 6520  nt(self._N.size 
-0001d690: 2f2f 2032 295d 5d0d 0a20 2020 2020 2020  // 2)]]..       
-0001d6a0: 2020 2020 2076 6172 203d 2031 202f 2073       var = 1 / s
-0001d6b0: 656c 662e 4d20 2f20 4e20 2f20 2876 2a2a  elf.M / N / (v**
-0001d6c0: 3229 202f 2042 2a2a 3220 2023 2074 6f64  2) / B**2  # tod
-0001d6d0: 6f3a 2044 2c20 4d0d 0a20 2020 2020 2020  o: D, M..       
-0001d6e0: 2020 2020 2069 6478 203d 206e 702e 6172       idx = np.ar
-0001d6f0: 676d 6178 286e 702e 7375 6d28 3120 2f20  gmax(np.sum(1 / 
-0001d700: 7661 722c 2061 7869 733d 3129 290d 0a20  var, axis=1)).. 
-0001d710: 2020 2020 2020 2020 2020 2076 6f70 7420             vopt 
-0001d720: 3d20 765b 6964 785d 0d0a 2020 2020 2020  = v[idx]..      
-0001d730: 2020 656c 6966 2073 656c 662e 5053 4620    elif self.PSF 
-0001d740: 3e20 303a 2020 2320 6465 7465 726d 696e  > 0:  # determin
-0001d750: 6520 6672 6f6d 2050 5346 0d0a 2020 2020  e from PSF..    
-0001d760: 2020 2020 2020 2020 766f 7074 5f20 3d20          vopt_ = 
-0001d770: 3120 2f20 2832 202a 206e 702e 7069 202a  1 / (2 * np.pi *
-0001d780: 2073 656c 662e 5053 4629 2020 2320 746f   self.PSF)  # to
-0001d790: 646f 0d0a 2020 2020 2020 2020 2020 2020  do..            
-0001d7a0: 6c6f 7074 203d 2031 202f 2076 6f70 745f  lopt = 1 / vopt_
-0001d7b0: 0d0a 2020 2020 2020 2020 2020 2020 766f  ..            vo
-0001d7c0: 7074 203d 2073 656c 662e 4c20 2f20 6c6f  pt = self.L / lo
-0001d7d0: 7074 0d0a 2020 2020 2020 2020 2020 2020  pt..            
-0001d7e0: 766f 7074 203d 2073 656c 662e 766d 6178  vopt = self.vmax
-0001d7f0: 202f 2032 2020 2320 6170 7072 6f78 696d   / 2  # approxim
-0001d800: 6174 696f 6e20 5b42 6f74 6865 3230 3038  ation [Bothe2008
-0001d810: 5d0d 0a20 2020 2020 2020 2065 6c73 653a  ]..        else:
-0001d820: 0d0a 2020 2020 2020 2020 2020 2020 766f  ..            vo
-0001d830: 7074 203d 2069 6e74 2873 656c 662e 766d  pt = int(self.vm
-0001d840: 6178 290d 0a0d 0a20 2020 2020 2020 2072  ax)....        r
-0001d850: 6574 7572 6e20 766f 7074 0d0a 0d0a 2020  eturn vopt....  
-0001d860: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-0001d870: 2064 6566 2076 2873 656c 6629 202d 3e20   def v(self) -> 
-0001d880: 6e70 2e6e 6461 7272 6179 3a0d 0a20 2020  np.ndarray:..   
-0001d890: 2020 2020 2022 2222 5370 6174 6961 6c20       """Spatial 
-0001d8a0: 6672 6571 7565 6e63 6965 7320 286e 756d  frequencies (num
-0001d8b0: 6265 7220 6f66 2070 6572 696f 6473 2f66  ber of periods/f
-0001d8c0: 7269 6e67 6573 2061 6372 6f73 7320 6d61  ringes across ma
-0001d8d0: 7869 6d75 6d20 636f 6469 6e67 206c 656e  ximum coding len
-0001d8e0: 6774 6829 2e22 2222 0d0a 2020 2020 2020  gth)."""..      
-0001d8f0: 2020 6966 2073 656c 662e 4420 3d3d 2031    if self.D == 1
-0001d900: 206f 7220 6c65 6e28 6e70 2e75 6e69 7175   or len(np.uniqu
-0001d910: 6528 7365 6c66 2e5f 762c 2061 7869 733d  e(self._v, axis=
-0001d920: 3029 2920 3d3d 2031 3a20 2023 2073 6574  0)) == 1:  # set
-0001d930: 7320 696e 2064 6972 6563 7469 6f6e 7320  s in directions 
-0001d940: 6172 6520 6964 656e 7469 6361 6c0d 0a20  are identical.. 
-0001d950: 2020 2020 2020 2020 2020 2076 203d 2073             v = s
-0001d960: 656c 662e 5f76 5b30 5d20 2023 2031 440d  elf._v[0]  # 1D.
-0001d970: 0a20 2020 2020 2020 2065 6c73 653a 0d0a  .        else:..
-0001d980: 2020 2020 2020 2020 2020 2020 7620 3d20              v = 
-0001d990: 7365 6c66 2e5f 7620 2023 2032 440d 0a20  self._v  # 2D.. 
-0001d9a0: 2020 2020 2020 2072 6574 7572 6e20 760d         return v.
-0001d9b0: 0a0d 0a20 2020 2040 762e 7365 7474 6572  ...    @v.setter
-0001d9c0: 0d0a 2020 2020 6465 6620 7628 7365 6c66  ..    def v(self
-0001d9d0: 2c20 763a 2069 6e74 207c 2066 6c6f 6174  , v: int | float
-0001d9e0: 207c 2074 7570 6c65 5b69 6e74 207c 2066   | tuple[int | f
-0001d9f0: 6c6f 6174 5d20 7c20 6c69 7374 5b69 6e74  loat] | list[int
-0001da00: 207c 2066 6c6f 6174 5d20 7c20 6e70 2e6e   | float] | np.n
-0001da10: 6461 7272 6179 207c 2073 7472 293a 0d0a  darray | str):..
-0001da20: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001da30: 7461 6e63 6528 762c 2073 7472 293a 0d0a  tance(v, str):..
-0001da40: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0001da50: 203d 3d20 226f 7074 696d 616c 223a 0d0a   == "optimal":..
-0001da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da70: 2320 7c7b 767d 7c20 3d20 320d 0a20 2020  # |{v}| = 2..   
-0001da80: 2020 2020 2020 2020 2020 2020 2076 6d61               vma
-0001da90: 7820 3d20 696e 7428 6d61 7828 3120 6966  x = int(max(1 if
-0001daa0: 2073 656c 662e 4b20 3d3d 2031 2065 6c73   self.K == 1 els
-0001dab0: 6520 322c 2073 656c 662e 766f 7074 2929  e 2, self.vopt))
-0001dac0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001dad0: 2020 7620 3d20 6e70 2e61 7272 6179 285b    v = np.array([
-0001dae0: 766d 6178 5d20 2a20 2873 656c 662e 4b20  vmax] * (self.K 
-0001daf0: 2d20 3129 202b 205b 766d 6178 202d 2031  - 1) + [vmax - 1
-0001db00: 5d29 2020 2320 7477 6f20 636f 6e73 6563  ])  # two consec
-0001db10: 7574 6976 6520 6e75 6d62 6572 7320 6172  utive numbers ar
-0001db20: 6520 616c 7761 7973 2063 6f70 7269 6d65  e always coprime
-0001db30: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-0001db40: 2020 2020 2320 2320 2320 7c7b 767d 7c20      # # # |{v}| 
-0001db50: 3d20 4b0d 0a20 2020 2020 2020 2020 2020  = K..           
-0001db60: 2020 2020 2023 2076 6d61 7820 3d20 696e       # vmax = in
-0001db70: 7428 6d61 7828 7365 6c66 2e4b 2c20 7365  t(max(self.K, se
-0001db80: 6c66 2e76 6f70 7429 290d 0a20 2020 2020  lf.vopt))..     
-0001db90: 2020 2020 2020 2020 2020 2023 2076 203d             # v =
-0001dba0: 2076 6d61 7820 2d20 6e70 2e61 7261 6e67   vmax - np.arang
-0001dbb0: 6528 7365 6c66 2e4b 290d 0a20 2020 2020  e(self.K)..     
-0001dbc0: 2020 2020 2020 2065 6c69 6620 7620 3d3d         elif v ==
-0001dbd0: 2022 6578 706f 6e65 6e74 6961 6c22 3a0d   "exponential":.
-0001dbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dbf0: 2023 204b 203d 2069 6e74 286e 702e 6365   # K = int(np.ce
-0001dc00: 696c 286e 702e 6c6f 6732 2873 656c 662e  il(np.log2(self.
-0001dc10: 766d 6178 2929 2920 2b20 3120 2023 202b  vmax))) + 1  # +
-0001dc20: 2031 3a20 3220 2a2a 2030 203d 2031 0d0a   1: 2 ** 0 = 1..
-0001dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc40: 7620 3d20 6e70 2e63 6f6e 6361 7465 6e61  v = np.concatena
-0001dc50: 7465 2828 5b30 5d2c 206e 702e 6765 6f6d  te(([0], np.geom
-0001dc60: 7370 6163 6528 312c 2073 656c 662e 766d  space(1, self.vm
-0001dc70: 6178 2c20 7365 6c66 2e4b 202d 2031 2929  ax, self.K - 1))
-0001dc80: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
-0001dc90: 6c69 6620 7620 3d3d 2022 6c69 6e65 6172  lif v == "linear
-0001dca0: 223a 0d0a 2020 2020 2020 2020 2020 2020  ":..            
-0001dcb0: 2020 2020 7620 3d20 6e70 2e63 6f6e 6361      v = np.conca
-0001dcc0: 7465 6e61 7465 2828 5b30 5d2c 206e 702e  tenate(([0], np.
-0001dcd0: 6c69 6e73 7061 6365 2831 2c20 7365 6c66  linspace(1, self
-0001dce0: 2e76 6d61 782c 2073 656c 662e 4b20 2d20  .vmax, self.K - 
-0001dcf0: 3129 2929 0d0a 2020 2020 2020 2020 2020  1)))..          
-0001dd00: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-0001dd10: 2020 2020 2020 2020 2072 6574 7572 6e0d           return.
-0001dd20: 0a0d 0a20 2020 2020 2020 205f 7620 3d20  ...        _v = 
-0001dd30: 6e70 2e61 7272 6179 2876 2c20 666c 6f61  np.array(v, floa
-0001dd40: 7429 2e63 6c69 7028 302c 2073 656c 662e  t).clip(0, self.
-0001dd50: 766d 6178 2920 2023 206d 616b 6520 6172  vmax)  # make ar
-0001dd60: 7261 792c 2063 6173 7420 746f 2064 7479  ray, cast to dty
-0001dd70: 7065 2c20 636c 6970 0d0a 0d0a 2020 2020  pe, clip....    
-0001dd80: 2020 2020 6966 206e 6f74 205f 762e 7369      if not _v.si
-0001dd90: 7a65 3a20 2023 2065 6d70 7479 2061 7272  ze:  # empty arr
-0001dda0: 6179 0d0a 2020 2020 2020 2020 2020 2020  ay..            
-0001ddb0: 7265 7475 726e 0d0a 0d0a 2020 2020 2020  return....      
-0001ddc0: 2020 5f76 203d 2073 656c 662e 5f74 7269    _v = self._tri
-0001ddd0: 6d28 5f76 290d 0a0d 0a20 2020 2020 2020  m(_v)....       
-0001dde0: 2069 6620 7365 6c66 2e46 444d 3a0d 0a20   if self.FDM:.. 
-0001ddf0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0001de00: 6c66 2e73 7461 7469 633a 0d0a 2020 2020  lf.static:..    
-0001de10: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0001de20: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001de30: 2020 2020 2020 5f76 2e73 697a 6520 213d        _v.size !=
-0001de40: 2073 656c 662e 4420 2a20 7365 6c66 2e4b   self.D * self.K
-0001de50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001de60: 2020 2020 2020 6f72 206e 6f74 206e 702e        or not np.
-0001de70: 616c 6c28 5f76 2025 2031 203d 3d20 3029  all(_v % 1 == 0)
-0001de80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001de90: 2020 2020 2020 6f72 206e 6f74 206e 702e        or not np.
-0001dea0: 6c63 6d2e 7265 6475 6365 285f 762e 6173  lcm.reduce(_v.as
-0001deb0: 7479 7065 2869 6e74 2c20 636f 7079 3d46  type(int, copy=F
-0001dec0: 616c 7365 292e 7261 7665 6c28 2929 203d  alse).ravel()) =
-0001ded0: 3d20 6e70 2e70 726f 6428 5f76 290d 0a20  = np.prod(_v).. 
-0001dee0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001def0: 3a20 2023 2074 6f64 6f3a 2061 6c6c 6f77  :  # todo: allow
-0001df00: 2063 6f70 7269 6d65 733f 210d 0a20 2020   coprimes?!..   
-0001df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df20: 206e 203d 206d 696e 2831 302c 2073 656c   n = min(10, sel
-0001df30: 662e 766d 6178 202f 2f20 3229 0d0a 2020  f.vmax // 2)..  
-0001df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df50: 2020 6974 6820 3d20 7365 6c66 2e44 202a    ith = self.D *
-0001df60: 2073 656c 662e 4b0d 0a20 2020 2020 2020   self.K..       
-0001df70: 2020 2020 2020 2020 2020 2020 2070 6d61               pma
-0001df80: 7820 3d20 7379 6d70 792e 6e74 6865 6f72  x = sympy.ntheor
-0001df90: 792e 6765 6e65 7261 7465 2e6e 6578 7470  y.generate.nextp
-0001dfa0: 7269 6d65 286e 2c20 6974 6820 2b20 3129  rime(n, ith + 1)
-0001dfb0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001dfc0: 2020 2020 2020 7020 3d20 6e70 2e61 7272        p = np.arr
-0001dfd0: 6179 286c 6973 7428 7379 6d70 792e 6e74  ay(list(sympy.nt
-0001dfe0: 6865 6f72 792e 6765 6e65 7261 7465 2e70  heory.generate.p
-0001dff0: 7269 6d65 7261 6e67 6528 6e2c 2070 6d61  rimerange(n, pma
-0001e000: 7820 2b20 3129 2929 5b3a 6974 685d 2020  x + 1)))[:ith]  
-0001e010: 2320 7072 696d 6573 0d0a 2020 2020 2020  # primes..      
-0001e020: 2020 2020 2020 2020 2020 2020 2020 7020                p 
-0001e030: 3d20 5b70 5b2d 6920 2f2f 2032 5d20 6966  = [p[-i // 2] if
-0001e040: 2069 2025 2032 2065 6c73 6520 705b 6920   i % 2 else p[i 
-0001e050: 2f2f 2032 5d20 666f 7220 6920 696e 2072  // 2] for i in r
-0001e060: 616e 6765 286c 656e 2870 2929 5d20 2023  ange(len(p))]  #
-0001e070: 2072 6573 6f72 7420 7072 696d 6573 0d0a   resort primes..
-0001e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e090: 2020 2020 5f76 203d 206e 702e 736f 7274      _v = np.sort
-0001e0a0: 286e 702e 6172 7261 7928 702c 2066 6c6f  (np.array(p, flo
-0001e0b0: 6174 292e 7265 7368 6170 6528 2873 656c  at).reshape((sel
-0001e0c0: 662e 442c 2073 656c 662e 4b29 292c 2061  f.D, self.K)), a
-0001e0d0: 7869 733d 3129 2020 2320 7265 736f 7274  xis=1)  # resort
-0001e0e0: 2070 7269 6d65 730d 0a20 2020 2020 2020   primes..       
-0001e0f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001e100: 662e 6c6f 6767 6572 2e77 6172 6e69 6e67  f.logger.warning
-0001e110: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-0001e120: 2020 2020 2020 2020 2020 2066 2250 6572             f"Per
-0001e130: 696f 6473 2077 6572 6520 6e6f 7420 636f  iods were not co
-0001e140: 7072 696d 652e 2022 2066 2243 6861 6e67  prime. " f"Chang
-0001e150: 696e 6720 7661 6c75 6573 2074 6f20 7b73  ing values to {s
-0001e160: 7472 285f 762e 726f 756e 6428 3329 292e  tr(_v.round(3)).
-0001e170: 7265 706c 6163 6528 6368 7228 3130 292c  replace(chr(10),
-0001e180: 2027 2c27 297d 2e22 0d0a 2020 2020 2020   ',')}."..      
-0001e190: 2020 2020 2020 2020 2020 2020 2020 290d                ).
-0001e1a0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-0001e1b0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-0001e1c0: 2020 2320 2020 2020 766d 6178 203d 2028    #     vmax = (
-0001e1d0: 7365 6c66 2e5f 4e6d 6178 202d 2031 2920  self._Nmax - 1) 
-0001e1e0: 2f20 3220 3e20 5f76 0d0a 2020 2020 2020  / 2 > _v..      
-0001e1f0: 2020 2020 2020 2320 2020 2020 5f76 203d        #     _v =
-0001e200: 206e 702e 6d69 6e69 6d75 6d28 5f76 2c20   np.minimum(_v, 
-0001e210: 766d 6178 290d 0a0d 0a20 2020 2020 2020  vmax)....       
-0001e220: 2069 6620 6e6f 7420 6e70 2e61 7272 6179   if not np.array
-0001e230: 5f65 7175 616c 2873 656c 662e 5f76 2c20  _equal(self._v, 
-0001e240: 5f76 293a 0d0a 2020 2020 2020 2020 2020  _v):..          
-0001e250: 2020 7365 6c66 2e5f 7620 3d20 5f76 0d0a    self._v = _v..
-0001e260: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001e270: 2e6c 6f67 6765 722e 6465 6275 6728 6622  .logger.debug(f"
-0001e280: 7365 6c66 2e76 203d 207b 7374 7228 7365  self.v = {str(se
-0001e290: 6c66 2e5f 762e 726f 756e 6428 3329 292e  lf._v.round(3)).
-0001e2a0: 7265 706c 6163 6528 6368 7228 3130 292c  replace(chr(10),
-0001e2b0: 2027 2c27 297d 2229 0d0a 2020 2020 2020   ',')}")..      
-0001e2c0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-0001e2d0: 722e 6465 6275 6728 6622 7365 6c66 2e6c  r.debug(f"self.l
-0001e2e0: 203d 207b 7374 7228 7365 6c66 2e5f 6c2e   = {str(self._l.
-0001e2f0: 726f 756e 6428 3329 292e 7265 706c 6163  round(3)).replac
-0001e300: 6528 6368 7228 3130 292c 2027 2c27 297d  e(chr(10), ',')}
-0001e310: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
-0001e320: 7365 6c66 2e5f 554d 5220 3d20 4e6f 6e65  self._UMR = None
-0001e330: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0001e340: 6c66 2e44 2c20 7365 6c66 2e4b 203d 2073  lf.D, self.K = s
-0001e350: 656c 662e 5f76 2e73 6861 7065 0d0a 2020  elf._v.shape..  
-0001e360: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-0001e370: 203d 2073 656c 662e 5f66 0d0a 2020 2020   = self._f..    
-0001e380: 2020 2020 2020 2020 554d 5220 3d20 7365          UMR = se
-0001e390: 6c66 2e55 4d52 0d0a 2020 2020 2020 2020  lf.UMR..        
-0001e3a0: 2020 2020 6120 3d20 310d 0a0d 0a20 2020      a = 1....   
-0001e3b0: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
-0001e3c0: 6465 6620 5f66 6d61 7828 7365 6c66 293a  def _fmax(self):
-0001e3d0: 0d0a 2020 2020 2020 2020 2222 224d 6178  ..        """Max
-0001e3e0: 696d 756d 2074 656d 706f 7261 6c20 6672  imum temporal fr
-0001e3f0: 6571 7565 6e63 7920 286d 6178 696d 756d  equency (maximum
-0001e400: 206e 756d 6265 7220 6f66 2070 6572 696f   number of perio
-0001e410: 6473 2074 6f20 7368 6966 7420 6f76 6572  ds to shift over
-0001e420: 292e 2222 220d 0a20 2020 2020 2020 2072  )."""..        r
-0001e430: 6574 7572 6e20 6d69 6e28 2873 656c 662e  eturn min((self.
-0001e440: 5f4e 6d69 6e20 2d20 3129 202f 2032 2c20  _Nmin - 1) / 2, 
-0001e450: 7365 6c66 2e76 6d61 7829 2069 6620 7365  self.vmax) if se
-0001e460: 6c66 2e46 444d 2061 6e64 2073 656c 662e  lf.FDM and self.
-0001e470: 7374 6174 6963 2065 6c73 6520 2873 656c  static else (sel
-0001e480: 662e 5f4e 6d69 6e20 2d20 3129 202f 2032  f._Nmin - 1) / 2
-0001e490: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-0001e4a0: 790d 0a20 2020 2064 6566 2066 2873 656c  y..    def f(sel
-0001e4b0: 6629 202d 3e20 6e70 2e6e 6461 7272 6179  f) -> np.ndarray
-0001e4c0: 3a0d 0a20 2020 2020 2020 2022 2222 5465  :..        """Te
-0001e4d0: 6d70 6f72 616c 2066 7265 7175 656e 6379  mporal frequency
-0001e4e0: 2028 6e75 6d62 6572 206f 6620 7065 7269   (number of peri
-0001e4f0: 6f64 7320 746f 2073 6869 6674 206f 7665  ods to shift ove
-0001e500: 7229 2e22 2222 0d0a 2020 2020 2020 2020  r)."""..        
-0001e510: 6966 2073 656c 662e 4420 3d3d 2031 206f  if self.D == 1 o
-0001e520: 7220 6c65 6e28 6e70 2e75 6e69 7175 6528  r len(np.unique(
-0001e530: 7365 6c66 2e5f 662c 2061 7869 733d 3029  self._f, axis=0)
-0001e540: 2920 3d3d 2031 3a20 2023 2073 6574 7320  ) == 1:  # sets 
-0001e550: 696e 2064 6972 6563 7469 6f6e 7320 6172  in directions ar
-0001e560: 6520 6964 656e 7469 6361 6c0d 0a20 2020  e identical..   
-0001e570: 2020 2020 2020 2020 2066 203d 2073 656c           f = sel
-0001e580: 662e 5f66 5b30 5d20 2023 2031 440d 0a20  f._f[0]  # 1D.. 
-0001e590: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-0001e5a0: 2020 2020 2020 2020 2020 6620 3d20 7365            f = se
-0001e5b0: 6c66 2e5f 6620 2023 2032 440d 0a20 2020  lf._f  # 2D..   
-0001e5c0: 2020 2020 2072 6574 7572 6e20 660d 0a0d       return f...
-0001e5d0: 0a20 2020 2040 662e 7365 7474 6572 0d0a  .    @f.setter..
-0001e5e0: 2020 2020 6465 6620 6628 7365 6c66 2c20      def f(self, 
-0001e5f0: 663a 2069 6e74 207c 2066 6c6f 6174 207c  f: int | float |
-0001e600: 2074 7570 6c65 5b69 6e74 207c 2066 6c6f   tuple[int | flo
-0001e610: 6174 5d20 7c20 6c69 7374 5b69 6e74 207c  at] | list[int |
-0001e620: 2066 6c6f 6174 5d20 7c20 6e70 2e6e 6461   float] | np.nda
-0001e630: 7272 6179 207c 2073 7472 293a 0d0a 2020  rray | str):..  
-0001e640: 2020 2020 2020 5f66 203d 206e 702e 6172        _f = np.ar
-0001e650: 7261 7928 662c 2066 6c6f 6174 292e 636c  ray(f, float).cl
-0001e660: 6970 282d 7365 6c66 2e5f 666d 6178 2c20  ip(-self._fmax, 
-0001e670: 7365 6c66 2e5f 666d 6178 2920 2023 206d  self._fmax)  # m
-0001e680: 616b 6520 6172 7261 792c 2063 6173 7420  ake array, cast 
-0001e690: 746f 2064 7479 7065 2c20 636c 6970 0d0a  to dtype, clip..
-0001e6a0: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0001e6b0: 205f 662e 7369 7a65 3a20 2023 2065 6d70   _f.size:  # emp
-0001e6c0: 7479 2061 7272 6179 0d0a 2020 2020 2020  ty array..      
-0001e6d0: 2020 2020 2020 7265 7475 726e 0d0a 0d0a        return....
-0001e6e0: 2020 2020 2020 2020 5f66 203d 2073 656c          _f = sel
-0001e6f0: 662e 5f74 7269 6d28 5f66 290d 0a0d 0a20  f._trim(_f).... 
-0001e700: 2020 2020 2020 2044 203d 206d 696e 285f         D = min(_
-0001e710: 662e 7368 6170 655b 305d 2c20 7365 6c66  f.shape[0], self
-0001e720: 2e5f 4e2e 7368 6170 655b 305d 290d 0a20  ._N.shape[0]).. 
-0001e730: 2020 2020 2020 204b 203d 206d 696e 285f         K = min(_
-0001e740: 662e 7368 6170 655b 315d 2c20 7365 6c66  f.shape[1], self
-0001e750: 2e5f 4e2e 7368 6170 655b 315d 290d 0a20  ._N.shape[1]).. 
-0001e760: 2020 2020 2020 2069 6620 6e70 2e61 6e79         if np.any
-0001e770: 285f 665b 3a44 2c20 3a4b 5d20 2520 7365  (_f[:D, :K] % se
-0001e780: 6c66 2e5f 4e5b 3a44 2c20 3a4b 5d20 3d3d  lf._N[:D, :K] ==
-0001e790: 2030 293a 0d0a 2020 2020 2020 2020 2020   0):..          
-0001e7a0: 2020 2320 5f66 203d 206e 702e 6f6e 6573    # _f = np.ones
-0001e7b0: 285f 662e 7368 6170 6529 0d0a 2020 2020  (_f.shape)..    
-0001e7c0: 2020 2020 2020 2020 5f66 5b3a 442c 203a          _f[:D, :
-0001e7d0: 4b5d 5b5f 665b 3a44 2c20 3a4b 5d20 2520  K][_f[:D, :K] % 
-0001e7e0: 7365 6c66 2e5f 4e5b 3a44 2c20 3a4b 5d20  self._N[:D, :K] 
-0001e7f0: 3d3d 2030 5d20 3d20 310d 0a0d 0a20 2020  == 0] = 1....   
-0001e800: 2020 2020 2069 6620 7365 6c66 2e46 444d       if self.FDM
-0001e810: 3a0d 0a20 2020 2020 2020 2020 2020 2069  :..            i
-0001e820: 6620 7365 6c66 2e73 7461 7469 633a 0d0a  f self.static:..
-0001e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e840: 5f66 203d 2073 656c 662e 5f76 2020 2320  _f = self._v  # 
-0001e850: 7065 7269 6f64 7320 746f 2073 6869 6674  periods to shift
-0001e860: 206f 7665 7220 3d20 6f6e 6520 6675 6c6c   over = one full
-0001e870: 2072 6576 6f6c 7574 696f 6e0d 0a20 2020   revolution..   
-0001e880: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
-0001e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8a0: 6966 2028 0d0a 2020 2020 2020 2020 2020  if (..          
-0001e8b0: 2020 2020 2020 2020 2020 5f66 2e73 6861            _f.sha
-0001e8c0: 7065 2021 3d20 2873 656c 662e 442c 2073  pe != (self.D, s
-0001e8d0: 656c 662e 4b29 0d0a 2020 2020 2020 2020  elf.K)..        
-0001e8e0: 2020 2020 2020 2020 2020 2020 6f72 206e              or n
-0001e8f0: 6f74 206e 702e 616c 6c28 6920 2520 3120  ot np.all(i % 1 
-0001e900: 3d3d 2030 2066 6f72 2069 2069 6e20 5f66  == 0 for i in _f
-0001e910: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-0001e920: 2020 2020 2020 206f 7220 6c65 6e28 6e70         or len(np
-0001e930: 2e75 6e69 7175 6528 6e70 2e61 6273 285f  .unique(np.abs(_
-0001e940: 6629 2929 203c 205f 662e 7369 7a65 0d0a  f))) < _f.size..
-0001e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e960: 293a 2020 2320 6173 7375 7265 205f 6620  ):  # assure _f 
-0001e970: 6172 6520 696e 7420 616e 6420 6162 736f  are int and abso
-0001e980: 6c75 7465 2076 616c 7565 7320 6f66 205f  lute values of _
-0001e990: 6620 6469 6666 6572 0d0a 2020 2020 2020  f differ..      
-0001e9a0: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
-0001e9b0: 203d 206e 702e 6172 616e 6765 2831 2c20   = np.arange(1, 
-0001e9c0: 7365 6c66 2e44 202a 2073 656c 662e 4b20  self.D * self.K 
-0001e9d0: 2b20 312c 2064 7479 7065 3d66 6c6f 6174  + 1, dtype=float
-0001e9e0: 292e 7265 7368 6170 6528 2873 656c 662e  ).reshape((self.
-0001e9f0: 442c 2073 656c 662e 4b29 290d 0a0d 0a20  D, self.K)).... 
-0001ea00: 2020 2020 2020 2069 6620 3020 6e6f 7420         if 0 not 
-0001ea10: 696e 205f 6620 616e 6420 6e6f 7420 6e70  in _f and not np
-0001ea20: 2e61 7272 6179 5f65 7175 616c 2873 656c  .array_equal(sel
-0001ea30: 662e 5f66 2c20 5f66 293a 0d0a 2020 2020  f._f, _f):..    
-0001ea40: 2020 2020 2020 2020 7365 6c66 2e5f 6620          self._f 
-0001ea50: 3d20 5f66 0d0a 2020 2020 2020 2020 2020  = _f..          
-0001ea60: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-0001ea70: 6275 6728 6622 7365 6c66 2e5f 6620 3d20  bug(f"self._f = 
-0001ea80: 7b73 7472 2828 7365 6c66 2e5f 6620 2a20  {str((self._f * 
-0001ea90: 282d 3120 6966 2073 656c 662e 7265 7665  (-1 if self.reve
-0001eaa0: 7273 6520 656c 7365 2031 2929 2e72 6f75  rse else 1)).rou
-0001eab0: 6e64 2833 2929 2e72 6570 6c61 6365 2863  nd(3)).replace(c
-0001eac0: 6872 2831 3029 2c20 272c 2729 7d22 290d  hr(10), ',')}").
-0001ead0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001eae0: 662e 442c 2073 656c 662e 4b20 3d20 7365  f.D, self.K = se
-0001eaf0: 6c66 2e5f 662e 7368 6170 650d 0a20 2020  lf._f.shape..   
-0001eb00: 2020 2020 2020 2020 2073 656c 662e 4e20           self.N 
-0001eb10: 3d20 7365 6c66 2e5f 4e20 2023 2074 6f64  = self._N  # tod
-0001eb20: 6f3a 2072 656d 6f76 6520 6966 2066 7261  o: remove if fra
-0001eb30: 6374 696f 6e61 6c20 7065 7269 6f64 7320  ctional periods 
-0001eb40: 6973 2069 6d70 6c65 6d65 6e74 6564 2c20  is implemented, 
-0001eb50: 6c6f 6720 7761 726e 696e 670d 0a0d 0a20  log warning.... 
-0001eb60: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-0001eb70: 2020 6465 6620 6f28 7365 6c66 2920 2d3e    def o(self) ->
-0001eb80: 2066 6c6f 6174 3a0d 0a20 2020 2020 2020   float:..       
-0001eb90: 2022 2222 5068 6173 6520 6f66 6673 6574   """Phase offset
-0001eba0: 2077 6974 6869 6e20 696e 7465 7276 616c   within interval
-0001ebb0: 2028 2d32 7069 2c20 2b32 7069 292e 0d0a   (-2pi, +2pi)...
-0001ebc0: 0d0a 2020 2020 2020 2020 4974 2063 616e  ..        It can
-0001ebd0: 2062 6520 7573 6564 2074 6f20 652e 672e   be used to e.g.
-0001ebe0: 206c 6574 2074 6865 2066 7269 6e67 6520   let the fringe 
-0001ebf0: 7061 7474 6572 6e73 2073 7461 7274 2028  patterns start (
-0001ec00: 6174 2074 6865 206f 7269 6769 6e29 2077  at the origin) w
-0001ec10: 6974 6820 6120 6772 6179 2076 616c 7565  ith a gray value
-0001ec20: 206f 6620 7a65 726f 2e0d 0a20 2020 2020   of zero...     
-0001ec30: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
-0001ec40: 7265 7475 726e 2073 656c 662e 5f6f 0d0a  return self._o..
-0001ec50: 0d0a 2020 2020 406f 2e73 6574 7465 720d  ..    @o.setter.
-0001ec60: 0a20 2020 2064 6566 206f 2873 656c 662c  .    def o(self,
-0001ec70: 206f 3a20 666c 6f61 7429 3a0d 0a20 2020   o: float):..   
-0001ec80: 2020 2020 205f 6f20 3d20 666c 6f61 7428       _o = float(
-0001ec90: 6e70 2e61 6273 286f 2920 2520 2832 202a  np.abs(o) % (2 *
-0001eca0: 206e 702e 7069 2920 2a20 6e70 2e73 6967   np.pi) * np.sig
-0001ecb0: 6e28 6f29 290d 0a0d 0a20 2020 2020 2020  n(o))....       
-0001ecc0: 2069 6620 7365 6c66 2e5f 6f20 213d 205f   if self._o != _
-0001ecd0: 6f3a 0d0a 2020 2020 2020 2020 2020 2020  o:..            
-0001ece0: 7365 6c66 2e5f 6f20 3d20 5f6f 0d0a 2020  self._o = _o..  
-0001ecf0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0001ed00: 6f67 6765 722e 6465 6275 6728 6622 7365  ogger.debug(f"se
-0001ed10: 6c66 2e5f 6f20 3d20 7b73 656c 662e 5f6f  lf._o = {self._o
-0001ed20: 202f 206e 702e 7069 7d20 5049 2229 0d0a   / np.pi} PI")..
-0001ed30: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
-0001ed40: 0a20 2020 2064 6566 2042 7628 7365 6c66  .    def Bv(self
-0001ed50: 2920 2d3e 206e 702e 6e64 6172 7261 793a  ) -> np.ndarray:
-0001ed60: 0d0a 2020 2020 2020 2020 2222 224d 6f64  ..        """Mod
-0001ed70: 756c 6174 696f 6e20 6174 2073 7061 7469  ulation at spati
-0001ed80: 616c 2066 7265 7175 656e 6369 6573 2060  al frequencies `
-0001ed90: 7660 2e0d 0a0d 0a20 2020 2020 2020 2054  v`.....        T
-0001eda0: 6865 206d 6f64 756c 6174 696f 6e20 7661  he modulation va
-0001edb0: 6c75 6573 2061 7265 2064 6574 6572 6d69  lues are determi
-0001edc0: 6e65 6420 6672 6f6d 2061 206d 6561 7375  ned from a measu
-0001edd0: 7265 6d65 6e74 2e22 2222 0d0a 2020 2020  rement."""..    
-0001ede0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0001edf0: 5f42 760d 0a0d 0a20 2020 2040 4276 2e73  _Bv....    @Bv.s
-0001ee00: 6574 7465 720d 0a20 2020 2064 6566 2042  etter..    def B
-0001ee10: 7628 7365 6c66 2c20 423a 206e 702e 6e64  v(self, B: np.nd
-0001ee20: 6172 7261 7929 3a0d 0a20 2020 2020 2020  array):..       
-0001ee30: 2069 6620 4220 6973 204e 6f6e 653a 0d0a   if B is None:..
-0001ee40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001ee50: 2e5f 4276 203d 204e 6f6e 650d 0a20 2020  ._Bv = None..   
-0001ee60: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0001ee70: 6767 6572 2e64 6562 7567 2866 2273 656c  gger.debug(f"sel
-0001ee80: 662e 4276 203d 207b 7365 6c66 2e5f 4276  f.Bv = {self._Bv
-0001ee90: 7d22 290d 0a20 2020 2020 2020 2020 2020  }")..           
-0001eea0: 2072 6574 7572 6e0d 0a0d 0a20 2020 2020   return....     
-0001eeb0: 2020 205f 4220 3d20 6e70 2e61 7272 6179     _B = np.array
-0001eec0: 286e 702e 6d61 7869 6d75 6d28 302c 2042  (np.maximum(0, B
-0001eed0: 292c 2066 6c6f 6174 290d 0a0d 0a20 2020  ), float)....   
-0001eee0: 2020 2020 205f 422e 7368 6170 6520 3d20       _B.shape = 
-0001eef0: 542c 2059 2c20 582c 2043 203d 2076 7368  T, Y, X, C = vsh
-0001ef00: 6170 6528 5f42 292e 7368 6170 650d 0a0d  ape(_B).shape...
-0001ef10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001ef20: 5420 3d3d 2073 656c 662e 4420 2a20 7365  T == self.D * se
-0001ef30: 6c66 2e4b 0d0a 0d0a 2020 2020 2020 2020  lf.K....        
-0001ef40: 5f42 203d 205f 422e 7265 7368 6170 6528  _B = _B.reshape(
-0001ef50: 7365 6c66 2e44 2c20 7365 6c66 2e4b 2c20  self.D, self.K, 
-0001ef60: 7365 6c66 2e59 2c20 7365 6c66 2e58 2c20  self.Y, self.X, 
-0001ef70: 7365 6c66 2e43 290d 0a0d 0a20 2020 2020  self.C)....     
-0001ef80: 2020 2023 2066 696c 7465 720d 0a20 2020     # filter..   
-0001ef90: 2020 2020 205f 4220 3d20 6e70 2e6e 616e       _B = np.nan
-0001efa0: 6d65 6469 616e 285f 422c 2061 7869 733d  median(_B, axis=
-0001efb0: 2d31 2920 2023 2066 696c 7465 7220 616c  -1)  # filter al
-0001efc0: 6f6e 6720 636f 6c6f 7220 6178 6973 0d0a  ong color axis..
-0001efd0: 2020 2020 2020 2020 2320 5f42 203d 206e          # _B = n
-0001efe0: 702e 6e61 6e6d 6564 6961 6e28 5f42 2c20  p.nanmedian(_B, 
-0001eff0: 6178 6973 3d28 322c 2033 2929 2020 2320  axis=(2, 3))  # 
-0001f000: 6669 6c74 6572 2061 6c6f 6e67 2073 7061  filter along spa
-0001f010: 7469 616c 2061 7865 730d 0a20 2020 2020  tial axes..     
-0001f020: 2020 205f 4220 3d20 6e70 2e6e 616e 7175     _B = np.nanqu
-0001f030: 616e 7469 6c65 285f 422c 2030 2e39 2c20  antile(_B, 0.9, 
-0001f040: 6178 6973 3d28 322c 2033 2929 2020 2320  axis=(2, 3))  # 
-0001f050: 6669 6c74 6572 2061 6c6f 6e67 2073 7061  filter along spa
-0001f060: 7469 616c 2061 7865 730d 0a0d 0a20 2020  tial axes....   
-0001f070: 2020 2020 2023 2020 6e6f 726d 616c 697a       #  normaliz
-0001f080: 6520 286f 6e6c 7920 7265 6c61 7469 7665  e (only relative
-0001f090: 2077 6569 6768 7473 2061 7265 2069 6d70   weights are imp
-0001f0a0: 6f72 7461 6e74 290d 0a20 2020 2020 2020  ortant)..       
-0001f0b0: 2042 6d61 7820 3d20 6e70 2e69 696e 666f   Bmax = np.iinfo
-0001f0c0: 285f 422e 6474 7970 6529 2e6d 6178 2069  (_B.dtype).max i
-0001f0d0: 6620 5f42 2e64 7479 7065 2e6b 696e 6420  f _B.dtype.kind 
-0001f0e0: 696e 2022 7569 2220 656c 7365 2031 0d0a  in "ui" else 1..
-0001f0f0: 2020 2020 2020 2020 5f42 202f 3d20 426d          _B /= Bm
-0001f100: 6178 0d0a 2020 2020 2020 2020 5f42 5b6e  ax..        _B[n
-0001f110: 702e 6973 6e61 6e28 5f42 295d 203d 2030  p.isnan(_B)] = 0
-0001f120: 0d0a 0d0a 2020 2020 2020 2020 5f42 7620  ....        _Bv 
-0001f130: 3d20 6e70 2e76 7374 6163 6b28 5f42 2c20  = np.vstack(_B, 
-0001f140: 7365 6c66 2e5f 7629 0d0a 0d0a 2020 2020  self._v)....    
-0001f150: 2020 2020 6966 206e 6f74 206e 702e 6172      if not np.ar
-0001f160: 7261 795f 6571 7561 6c28 7365 6c66 2e5f  ray_equal(self._
-0001f170: 4276 2c20 5f42 7629 3a0d 0a20 2020 2020  Bv, _Bv):..     
-0001f180: 2020 2020 2020 2073 656c 662e 5f42 7620         self._Bv 
-0001f190: 3d20 5f42 0d0a 2020 2020 2020 2020 2020  = _B..          
-0001f1a0: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-0001f1b0: 6275 6728 6622 7365 6c66 2e42 7620 3d20  bug(f"self.Bv = 
-0001f1c0: 7b73 7472 2873 656c 662e 4276 2e72 6f75  {str(self.Bv.rou
-0001f1d0: 6e64 2833 2929 2e72 6570 6c61 6365 2863  nd(3)).replace(c
-0001f1e0: 6872 2831 3029 2c20 272c 2729 7d22 290d  hr(10), ',')}").
-0001f1f0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
-0001f200: 0d0a 2020 2020 6465 6620 5f6d 6f6e 6f63  ..    def _monoc
-0001f210: 6872 6f6d 6528 7365 6c66 2920 2d3e 2062  hrome(self) -> b
-0001f220: 6f6f 6c3a 0d0a 2020 2020 2020 2020 2222  ool:..        ""
-0001f230: 2254 7275 6520 6966 2061 6c6c 2068 7565  "True if all hue
-0001f240: 7320 6172 6520 6d6f 6e6f 6368 726f 6d61  s are monochroma
-0001f250: 7469 632c 2069 2e65 2e20 5247 4220 7661  tic, i.e. RGB va
-0001f260: 6c75 6573 2061 7265 2069 6465 6e74 6963  lues are identic
-0001f270: 616c 2066 6f72 2065 6163 6820 6875 652e  al for each hue.
-0001f280: 2222 220d 0a20 2020 2020 2020 2072 6574  """..        ret
-0001f290: 7572 6e20 616c 6c28 6c65 6e28 7365 7428  urn all(len(set(
-0001f2a0: 6829 2920 3d3d 2031 2066 6f72 2068 2069  h)) == 1 for h i
-0001f2b0: 6e20 7365 6c66 2e68 290d 0a0d 0a20 2020  n self.h)....   
-0001f2c0: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
-0001f2d0: 6465 6620 5f61 6d62 6967 756f 7573 2873  def _ambiguous(s
-0001f2e0: 656c 6629 202d 3e20 626f 6f6c 3a0d 0a20  elf) -> bool:.. 
-0001f2f0: 2020 2020 2020 2022 2222 5472 7565 2069         """True i
-0001f300: 6620 756e 616d 6269 6775 6f75 7320 6d65  f unambiguous me
-0001f310: 6173 756d 656e 7420 7261 6e67 6520 6973  asument range is
-0001f320: 206c 6172 6765 7220 7468 616e 2074 6865   larger than the
-0001f330: 2073 6372 6565 6e20 6c65 6e67 7468 2e22   screen length."
-0001f340: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
-0001f350: 726e 2062 6f6f 6c28 6e70 2e61 6e79 2873  rn bool(np.any(s
-0001f360: 656c 662e 554d 5220 3c20 7365 6c66 2e52  elf.UMR < self.R
-0001f370: 202a 2073 656c 662e 616c 7068 6129 290d   * self.alpha)).
-0001f380: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
-0001f390: 0d0a 2020 2020 6465 6620 6d6f 6465 2873  ..    def mode(s
-0001f3a0: 656c 6629 202d 3e20 7374 723a 0d0a 2020  elf) -> str:..  
-0001f3b0: 2020 2020 2020 2222 224d 6f64 6520 666f        """Mode fo
-0001f3c0: 7220 656e 636f 6469 6e67 2061 6e64 2064  r encoding and d
-0001f3d0: 6563 6f64 696e 672e 0d0a 0d0a 2020 2020  ecoding.....    
-0001f3e0: 2020 2020 5468 6520 666f 6c6c 6f77 696e      The followin
-0001f3f0: 6720 7661 6c75 6573 2063 616e 2062 6520  g values can be 
-0001f400: 7365 743a 5c6e 0d0a 2020 2020 2020 2020  set:\n..        
-0001f410: 2d20 2766 6173 7427 5c6e 0d0a 2020 2020  - 'fast'\n..    
-0001f420: 2020 2020 2d20 2770 7265 6369 7365 270d      - 'precise'.
-0001f430: 0a20 2020 2020 2020 2022 2222 0d0a 2020  .        """..  
-0001f440: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001f450: 662e 5f6d 6f64 650d 0a0d 0a20 2020 2040  f._mode....    @
-0001f460: 6d6f 6465 2e73 6574 7465 720d 0a20 2020  mode.setter..   
-0001f470: 2064 6566 206d 6f64 6528 7365 6c66 2c20   def mode(self, 
-0001f480: 6d6f 6465 3a20 7374 7229 3a0d 0a20 2020  mode: str):..   
-0001f490: 2020 2020 205f 6d6f 6465 203d 2073 7472       _mode = str
-0001f4a0: 286d 6f64 6529 0d0a 0d0a 2020 2020 2020  (mode)....      
-0001f4b0: 2020 6966 2073 656c 662e 5f6d 6f64 6520    if self._mode 
-0001f4c0: 213d 205f 6d6f 6465 2061 6e64 205f 6d6f  != _mode and _mo
-0001f4d0: 6465 2069 6e20 7365 6c66 2e5f 6d6f 6465  de in self._mode
-0001f4e0: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-0001f4f0: 7365 6c66 2e5f 6d6f 6465 203d 205f 6d6f  self._mode = _mo
-0001f500: 6465 0d0a 2020 2020 2020 2020 2020 2020  de..            
-0001f510: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-0001f520: 6728 6622 7b73 656c 662e 5f6d 6f64 6520  g(f"{self._mode 
-0001f530: 3d20 7d22 290d 0a0d 0a20 2020 2040 7072  = }")....    @pr
-0001f540: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-0001f550: 696e 6465 7869 6e67 2873 656c 6629 202d  indexing(self) -
-0001f560: 3e20 7374 723a 0d0a 2020 2020 2020 2020  > str:..        
-0001f570: 2222 2249 6e64 6578 696e 6720 636f 6e76  """Indexing conv
-0001f580: 656e 7469 6f6e 2e0d 0a0d 0a20 2020 2020  ention.....     
-0001f590: 2020 2043 6172 7465 7369 616e 2069 6e64     Cartesian ind
-0001f5a0: 6578 696e 6720 6078 7960 2028 7468 6520  exing `xy` (the 
-0001f5b0: 6465 6661 756c 7429 2077 696c 6c20 696e  default) will in
-0001f5c0: 6465 7820 7468 6520 726f 7720 6669 7273  dex the row firs
-0001f5d0: 742c 0d0a 2020 2020 2020 2020 7768 696c  t,..        whil
-0001f5e0: 6520 6d61 7472 6978 2069 6e64 6578 696e  e matrix indexin
-0001f5f0: 6720 6069 6a60 2077 696c 6c20 696e 6465  g `ij` will inde
-0001f600: 7820 7468 6520 636f 6c75 6d20 6669 7273  x the colum firs
-0001f610: 742e 0d0a 2020 2020 2020 2020 2222 220d  t...        """.
-0001f620: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001f630: 7365 6c66 2e5f 696e 6465 7869 6e67 0d0a  self._indexing..
-0001f640: 0d0a 2020 2020 4069 6e64 6578 696e 672e  ..    @indexing.
-0001f650: 7365 7474 6572 0d0a 2020 2020 6465 6620  setter..    def 
-0001f660: 696e 6465 7869 6e67 2873 656c 662c 2069  indexing(self, i
-0001f670: 6e64 6578 696e 6729 3a0d 0a20 2020 2020  ndexing):..     
-0001f680: 2020 205f 696e 6465 7869 6e67 203d 2073     _indexing = s
-0001f690: 7472 2869 6e64 6578 696e 6729 0d0a 0d0a  tr(indexing)....
-0001f6a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001f6b0: 5f69 6e64 6578 696e 6720 213d 205f 696e  _indexing != _in
-0001f6c0: 6465 7869 6e67 2061 6e64 205f 696e 6465  dexing and _inde
-0001f6d0: 7869 6e67 2069 6e20 7365 6c66 2e5f 696e  xing in self._in
-0001f6e0: 6465 7869 6e67 733a 0d0a 2020 2020 2020  dexings:..      
-0001f6f0: 2020 2020 2020 7365 6c66 2e5f 696e 6465        self._inde
-0001f700: 7869 6e67 203d 205f 696e 6465 7869 6e67  xing = _indexing
-0001f710: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0001f720: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
-0001f730: 6622 7b73 656c 662e 5f69 6e64 6578 696e  f"{self._indexin
-0001f740: 6720 3d20 7d22 290d 0a0d 0a20 2020 2040  g = }")....    @
-0001f750: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
-0001f760: 6620 7265 7665 7273 6528 7365 6c66 2920  f reverse(self) 
-0001f770: 2d3e 2062 6f6f 6c3a 0d0a 2020 2020 2020  -> bool:..      
-0001f780: 2020 2222 2246 6c61 6720 666f 7220 7368    """Flag for sh
-0001f790: 6966 7469 6e67 2066 7269 6e67 6573 2069  ifting fringes i
-0001f7a0: 6e20 7265 7665 7273 6520 6469 7265 6374  n reverse direct
-0001f7b0: 696f 6e2e 2222 220d 0a20 2020 2020 2020  ion."""..       
-0001f7c0: 2072 6574 7572 6e20 7365 6c66 2e5f 7265   return self._re
-0001f7d0: 7665 7273 650d 0a0d 0a20 2020 2040 7265  verse....    @re
-0001f7e0: 7665 7273 652e 7365 7474 6572 0d0a 2020  verse.setter..  
-0001f7f0: 2020 6465 6620 7265 7665 7273 6528 7365    def reverse(se
-0001f800: 6c66 2c20 7265 7665 7273 653a 2062 6f6f  lf, reverse: boo
-0001f810: 6c29 3a0d 0a20 2020 2020 2020 205f 7265  l):..        _re
-0001f820: 7665 7273 6520 3d20 626f 6f6c 2872 6576  verse = bool(rev
-0001f830: 6572 7365 290d 0a0d 0a20 2020 2020 2020  erse)....       
-0001f840: 2069 6620 7365 6c66 2e5f 7265 7665 7273   if self._revers
-0001f850: 6520 213d 205f 7265 7665 7273 653a 0d0a  e != _reverse:..
-0001f860: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001f870: 2e5f 7265 7665 7273 6520 3d20 5f72 6576  ._reverse = _rev
-0001f880: 6572 7365 0d0a 2020 2020 2020 2020 2020  erse..          
-0001f890: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-0001f8a0: 6275 6728 6622 7b73 656c 662e 5f72 6576  bug(f"{self._rev
-0001f8b0: 6572 7365 203d 207d 2229 0d0a 2020 2020  erse = }")..    
-0001f8c0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001f8d0: 6765 722e 6465 6275 6728 6622 7365 6c66  ger.debug(f"self
-0001f8e0: 2e5f 6620 3d20 7b73 7472 2828 7365 6c66  ._f = {str((self
-0001f8f0: 2e5f 6620 2a20 282d 3120 6966 2073 656c  ._f * (-1 if sel
-0001f900: 662e 7265 7665 7273 6520 656c 7365 2031  f.reverse else 1
-0001f910: 2929 2e72 6f75 6e64 2833 2929 2e72 6570  )).round(3)).rep
-0001f920: 6c61 6365 2863 6872 2831 3029 2c20 272c  lace(chr(10), ',
-0001f930: 2729 7d22 290d 0a0d 0a20 2020 2040 7072  ')}")....    @pr
-0001f940: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-0001f950: 7665 7262 6f73 6528 7365 6c66 2920 2d3e  verbose(self) ->
-0001f960: 2062 6f6f 6c3a 0d0a 2020 2020 2020 2020   bool:..        
-0001f970: 2222 2246 6c61 6720 666f 7220 6164 6469  """Flag for addi
-0001f980: 7469 6f6e 616c 6c79 2072 6574 7572 6e69  tionally returni
-0001f990: 6e67 2069 6e74 6572 6d65 6469 6174 6520  ng intermediate 
-0001f9a0: 616e 6420 7665 7262 6f73 6520 7265 7375  and verbose resu
-0001f9b0: 6c74 733a 5c6e 0d0a 2020 2020 2020 2020  lts:\n..        
-0001f9c0: 2d20 7068 6173 6520 6d61 705c 6e0d 0a20  - phase map\n.. 
-0001f9d0: 2020 2020 2020 202d 2072 6573 6964 7561         - residua
-0001f9e0: 6c73 5c6e 0d0a 2020 2020 2020 2020 2d20  ls\n..        - 
-0001f9f0: 6672 696e 6765 206f 7264 6572 735c 6e0d  fringe orders\n.
-0001fa00: 0a20 2020 2020 2020 202d 2076 6973 6962  .        - visib
-0001fa10: 696c 6974 795c 6e0d 0a20 2020 2020 2020  ility\n..       
-0001fa20: 202d 2065 7870 6f73 7572 650d 0a20 2020   - exposure..   
-0001fa30: 2020 2020 2022 2222 0d0a 2020 2020 2020       """..      
-0001fa40: 2020 7265 7475 726e 2073 656c 662e 5f76    return self._v
-0001fa50: 6572 626f 7365 0d0a 0d0a 2020 2020 4076  erbose....    @v
-0001fa60: 6572 626f 7365 2e73 6574 7465 720d 0a20  erbose.setter.. 
-0001fa70: 2020 2064 6566 2076 6572 626f 7365 2873     def verbose(s
-0001fa80: 656c 662c 2076 6572 626f 7365 3a20 626f  elf, verbose: bo
-0001fa90: 6f6c 293a 0d0a 2020 2020 2020 2020 5f76  ol):..        _v
-0001faa0: 6572 626f 7365 203d 2062 6f6f 6c28 7665  erbose = bool(ve
-0001fab0: 7262 6f73 6529 0d0a 0d0a 2020 2020 2020  rbose)....      
-0001fac0: 2020 6966 2073 656c 662e 5f76 6572 626f    if self._verbo
-0001fad0: 7365 2021 3d20 5f76 6572 626f 7365 3a0d  se != _verbose:.
-0001fae0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001faf0: 662e 5f76 6572 626f 7365 203d 205f 7665  f._verbose = _ve
-0001fb00: 7262 6f73 650d 0a20 2020 2020 2020 2020  rbose..         
-0001fb10: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-0001fb20: 6562 7567 2866 227b 7365 6c66 2e5f 7665  ebug(f"{self._ve
-0001fb30: 7262 6f73 6520 3d20 7d22 290d 0a0d 0a20  rbose = }").... 
-0001fb40: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-0001fb50: 2020 6465 6620 7577 7228 7365 6c66 2920    def uwr(self) 
-0001fb60: 2d3e 2073 7472 3a0d 0a20 2020 2020 2020  -> str:..       
-0001fb70: 2022 2222 5068 6173 6520 756e 7772 6170   """Phase unwrap
-0001fb80: 7069 6e67 206d 6574 686f 642e 2222 220d  ping method.""".
-0001fb90: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
-0001fba0: 6c66 2e4b 203d 3d20 3120 616e 6420 6e70  lf.K == 1 and np
-0001fbb0: 2e61 6c6c 2873 656c 662e 5f4e 203d 3d20  .all(self._N == 
-0001fbc0: 3129 2061 6e64 2073 656c 662e 6772 6964  1) and self.grid
-0001fbd0: 2069 6e20 7365 6c66 2e5f 6772 6964 735b   in self._grids[
-0001fbe0: 3a32 5d3a 0d0a 2020 2020 2020 2020 2020  :2]:..          
-0001fbf0: 2020 2320 746f 646f 3a20 7620 3e3e 2031    # todo: v >> 1
-0001fc00: 2c20 692e 652e 206c 207e 2038 0d0a 2020  , i.e. l ~ 8..  
-0001fc10: 2020 2020 2020 2020 2020 7577 7220 3d20            uwr = 
-0001fc20: 2246 544d 2220 2023 2046 6f75 7269 6572  "FTM"  # Fourier
-0001fc30: 2d74 7261 6e73 666f 726d 206d 6574 686f  -transform metho
-0001fc40: 640d 0a20 2020 2020 2020 2065 6c69 6620  d..        elif 
-0001fc50: 7365 6c66 2e4b 203d 3d20 6e70 2e61 6c6c  self.K == np.all
-0001fc60: 2873 656c 662e 7620 3c3d 2031 293a 0d0a  (self.v <= 1):..
-0001fc70: 2020 2020 2020 2020 2020 2020 7577 7220              uwr 
-0001fc80: 3d20 226e 6f6e 6522 0d0a 2020 2020 2020  = "none"..      
-0001fc90: 2020 656c 6966 2073 656c 662e 5f61 6d62    elif self._amb
-0001fca0: 6967 756f 7573 3a0d 0a20 2020 2020 2020  iguous:..       
-0001fcb0: 2020 2020 2075 7772 203d 2022 7370 6174       uwr = "spat
-0001fcc0: 6961 6c22 0d0a 2020 2020 2020 2020 656c  ial"..        el
-0001fcd0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-0001fce0: 2075 7772 203d 2022 7465 6d70 6f72 616c   uwr = "temporal
-0001fcf0: 220d 0a0d 0a20 2020 2020 2020 2072 6574  "....        ret
-0001fd00: 7572 6e20 7577 720d 0a0d 0a20 2020 2040  urn uwr....    @
-0001fd10: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
-0001fd20: 6620 6761 6d6d 6128 7365 6c66 2920 2d3e  f gamma(self) ->
-0001fd30: 2066 6c6f 6174 3a0d 0a20 2020 2020 2020   float:..       
-0001fd40: 2022 2222 4761 6d6d 6120 636f 7272 6563   """Gamma correc
-0001fd50: 7469 6f6e 2066 6163 746f 7220 7573 6564  tion factor used
-0001fd60: 2074 6f20 636f 6d70 656e 7361 7465 206e   to compensate n
-0001fd70: 6f6e 6c69 6e65 6172 6974 6965 7320 6f66  onlinearities of
-0001fd80: 2074 6865 2064 6973 706c 6179 2072 6573   the display res
-0001fd90: 706f 6e73 6520 6375 7276 652e 2222 220d  ponse curve.""".
-0001fda0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001fdb0: 7365 6c66 2e5f 6761 6d6d 610d 0a0d 0a20  self._gamma.... 
-0001fdc0: 2020 2040 6761 6d6d 612e 7365 7474 6572     @gamma.setter
-0001fdd0: 0d0a 2020 2020 6465 6620 6761 6d6d 6128  ..    def gamma(
-0001fde0: 7365 6c66 2c20 6761 6d6d 613a 2066 6c6f  self, gamma: flo
-0001fdf0: 6174 293a 0d0a 2020 2020 2020 2020 5f67  at):..        _g
-0001fe00: 616d 6d61 203d 2066 6c6f 6174 286d 696e  amma = float(min
-0001fe10: 286d 6178 2830 2c20 6761 6d6d 6129 2c20  (max(0, gamma), 
-0001fe20: 7365 6c66 2e5f 6761 6d6d 616d 6178 2929  self._gammamax))
-0001fe30: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
-0001fe40: 656c 662e 5f67 616d 6d61 2021 3d20 5f67  elf._gamma != _g
-0001fe50: 616d 6d61 2061 6e64 205f 6761 6d6d 6120  amma and _gamma 
-0001fe60: 213d 2030 3a0d 0a20 2020 2020 2020 2020  != 0:..         
-0001fe70: 2020 2073 656c 662e 5f67 616d 6d61 203d     self._gamma =
-0001fe80: 205f 6761 6d6d 610d 0a20 2020 2020 2020   _gamma..       
-0001fe90: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-0001fea0: 2e64 6562 7567 2866 227b 7365 6c66 2e5f  .debug(f"{self._
-0001feb0: 6761 6d6d 6120 3d20 7d22 290d 0a0d 0a20  gamma = }").... 
-0001fec0: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-0001fed0: 2020 6465 6620 7368 6170 6528 7365 6c66    def shape(self
-0001fee0: 2920 2d3e 2074 7570 6c65 3a0d 0a20 2020  ) -> tuple:..   
-0001fef0: 2020 2020 2022 2222 5368 6170 6520 6f66       """Shape of
-0001ff00: 2066 7269 6e67 6520 7061 7474 6572 6e20   fringe pattern 
-0001ff10: 7365 7175 656e 6365 2069 6e20 7669 6465  sequence in vide
-0001ff20: 6f20 7368 6170 6520 2866 7261 6d65 732c  o shape (frames,
-0001ff30: 2068 6569 6768 742c 2077 6974 682c 2063   height, with, c
-0001ff40: 6f6c 6f72 2063 6861 6e6e 656c 7329 2e22  olor channels)."
-0001ff50: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
-0001ff60: 726e 2073 656c 662e 542c 2073 656c 662e  rn self.T, self.
-0001ff70: 592c 2073 656c 662e 582c 2073 656c 662e  Y, self.X, self.
-0001ff80: 430d 0a0d 0a20 2020 2040 7072 6f70 6572  C....    @proper
-0001ff90: 7479 0d0a 2020 2020 6465 6620 7369 7a65  ty..    def size
-0001ffa0: 2873 656c 6629 202d 3e20 6e70 2e75 696e  (self) -> np.uin
-0001ffb0: 7436 343a 0d0a 2020 2020 2020 2020 2222  t64:..        ""
-0001ffc0: 224e 756d 6265 7220 6f66 2070 6978 656c  "Number of pixel
-0001ffd0: 7320 6f66 2066 7269 6e67 6520 7061 7474  s of fringe patt
-0001ffe0: 6572 6e20 7365 7175 656e 6365 2028 6672  ern sequence (fr
-0001fff0: 616d 6573 202a 2068 6569 6768 7420 2a20  ames * height * 
-00020000: 7769 6474 6820 2a20 636f 6c6f 7220 6368  width * color ch
-00020010: 616e 6e65 6c73 292e 2222 220d 0a20 2020  annels)."""..   
-00020020: 2020 2020 2072 6574 7572 6e20 666c 6f61       return floa
-00020030: 7428 6e70 2e70 726f 6428 7365 6c66 2e73  t(np.prod(self.s
-00020040: 6861 7065 2c20 6474 7970 653d 6e70 2e75  hape, dtype=np.u
-00020050: 696e 7436 3429 2920 2023 2075 7369 6e67  int64))  # using
-00020060: 2075 696e 7436 3420 7072 6576 656e 7473   uint64 prevents
-00020070: 2069 6e74 6567 6572 206f 7665 7266 6c6f   integer overflo
-00020080: 770d 0a0d 0a20 2020 2040 7072 6f70 6572  w....    @proper
-00020090: 7479 0d0a 2020 2020 6465 6620 6e62 7974  ty..    def nbyt
-000200a0: 6573 2873 656c 6629 202d 3e20 696e 743a  es(self) -> int:
-000200b0: 0d0a 2020 2020 2020 2020 2222 2254 6f74  ..        """Tot
-000200c0: 616c 2062 7974 6573 2063 6f6e 7375 6d65  al bytes consume
-000200d0: 6420 6279 2066 7269 6e67 6520 7061 7474  d by fringe patt
-000200e0: 6572 6e20 7365 7175 656e 6365 2e0d 0a0d  ern sequence....
-000200f0: 0a20 2020 2020 2020 2044 6f65 7320 6e6f  .        Does no
-00020100: 7420 696e 636c 7564 6520 6d65 6d6f 7279  t include memory
-00020110: 2063 6f6e 7375 6d65 6420 6279 206e 6f6e   consumed by non
-00020120: 2d65 6c65 6d65 6e74 2061 7474 7269 6275  -element attribu
-00020130: 7465 7320 6f66 2074 6865 2061 7272 6179  tes of the array
-00020140: 206f 626a 6563 742e 0d0a 2020 2020 2020   object...      
-00020150: 2020 2222 220d 0a20 2020 2020 2020 2023    """..        #
-00020160: 2072 6574 7572 6e20 7365 6c66 2e73 697a   return self.siz
-00020170: 6520 2a20 7365 6c66 2e64 7479 7065 2e69  e * self.dtype.i
-00020180: 7465 6d73 697a 650d 0a20 2020 2020 2020  temsize..       
-00020190: 2072 6574 7572 6e20 7365 6c66 2e54 202a   return self.T *
-000201a0: 2073 656c 662e 5920 2a20 7365 6c66 2e58   self.Y * self.X
-000201b0: 202a 2073 656c 662e 4320 2a20 7365 6c66   * self.C * self
-000201c0: 2e64 7479 7065 2e69 7465 6d73 697a 650d  .dtype.itemsize.
-000201d0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
-000201e0: 0d0a 2020 2020 6465 6620 6474 7970 6528  ..    def dtype(
-000201f0: 7365 6c66 2920 2d3e 206e 702e 6474 7970  self) -> np.dtyp
-00020200: 653a 0d0a 2020 2020 2020 2020 2222 2244  e:..        """D
-00020210: 6174 6120 7479 7065 2e0d 0a0d 0a20 2020  ata type.....   
-00020220: 2020 2020 2054 6865 2066 6f6c 6c6f 7769       The followi
-00020230: 6e67 2076 616c 7565 7320 6361 6e20 6265  ng values can be
-00020240: 2073 6574 3a5c 6e0d 0a20 2020 2020 2020   set:\n..       
-00020250: 202d 2027 626f 6f6c 275c 6e0d 0a20 2020   - 'bool'\n..   
-00020260: 2020 2020 202d 2027 7569 6e74 3827 5c6e       - 'uint8'\n
-00020270: 0d0a 2020 2020 2020 2020 2d20 2775 696e  ..        - 'uin
-00020280: 7431 3627 5c6e 0d0a 2020 2020 2020 2020  t16'\n..        
-00020290: 2d20 2766 6c6f 6174 3332 275c 6e0d 0a20  - 'float32'\n.. 
-000202a0: 2020 2020 2020 202d 2027 666c 6f61 7436         - 'float6
-000202b0: 3427 5c6e 0d0a 2020 2020 2020 2020 2222  4'\n..        ""
-000202c0: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-000202d0: 6e20 6e70 2e64 7479 7065 2873 656c 662e  n np.dtype(self.
-000202e0: 5f64 7479 7065 2920 2023 2074 6869 7320  _dtype)  # this 
-000202f0: 6973 2061 2068 6f74 6669 7820 666f 7220  is a hotfix for 
-00020300: 7365 7474 696e 6720 5f64 7479 7065 2064  setting _dtype d
-00020310: 6972 6563 746c 7920 6173 2061 2073 7472  irectly as a str
-00020320: 2069 6e20 696e 6974 0d0a 0d0a 2020 2020   in init....    
-00020330: 4064 7479 7065 2e73 6574 7465 720d 0a20  @dtype.setter.. 
-00020340: 2020 2064 6566 2064 7479 7065 2873 656c     def dtype(sel
-00020350: 662c 2064 7479 7065 3a20 6e70 2e64 7479  f, dtype: np.dty
-00020360: 7065 207c 2073 7472 293a 0d0a 2020 2020  pe | str):..    
-00020370: 2020 2020 5f64 7479 7065 203d 206e 702e      _dtype = np.
-00020380: 6474 7970 6528 6474 7970 6529 0d0a 0d0a  dtype(dtype)....
-00020390: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000203a0: 5f64 7479 7065 2021 3d20 5f64 7479 7065  _dtype != _dtype
-000203b0: 2061 6e64 2073 7472 285f 6474 7970 6529   and str(_dtype)
-000203c0: 2069 6e20 7365 6c66 2e5f 6474 7970 6573   in self._dtypes
-000203d0: 3a0d 0a20 2020 2020 2020 2020 2020 2049  :..            I
-000203e0: 6d61 786f 6c64 203d 2073 656c 662e 496d  maxold = self.Im
-000203f0: 6178 0d0a 2020 2020 2020 2020 2020 2020  ax..            
-00020400: 7365 6c66 2e5f 6474 7970 6520 3d20 5f64  self._dtype = _d
-00020410: 7479 7065 0d0a 2020 2020 2020 2020 2020  type..          
-00020420: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-00020430: 6275 6728 6622 7b73 656c 662e 5f64 7479  bug(f"{self._dty
-00020440: 7065 203d 207d 2229 0d0a 2020 2020 2020  pe = }")..      
-00020450: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-00020460: 722e 6465 6275 6728 6622 7365 6c66 2e41  r.debug(f"self.A
-00020470: 203d 207b 7365 6c66 2e41 7d22 290d 0a20   = {self.A}").. 
-00020480: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00020490: 6c6f 6767 6572 2e64 6562 7567 2866 2273  logger.debug(f"s
-000204a0: 656c 662e 4220 3d20 7b73 656c 662e 427d  elf.B = {self.B}
-000204b0: 2229 0d0a 0d0a 2020 2020 4070 726f 7065  ")....    @prope
-000204c0: 7274 790d 0a20 2020 2064 6566 2049 6d61  rty..    def Ima
-000204d0: 7828 7365 6c66 2920 2d3e 2069 6e74 3a0d  x(self) -> int:.
-000204e0: 0a20 2020 2020 2020 2022 2222 4d61 7869  .        """Maxi
-000204f0: 6d75 6d20 6772 6179 2076 616c 7565 2e22  mum gray value."
-00020500: 2222 0d0a 2020 2020 2020 2020 7265 7475  ""..        retu
-00020510: 726e 206e 702e 6969 6e66 6f28 7365 6c66  rn np.iinfo(self
-00020520: 2e64 7479 7065 292e 6d61 7820 6966 2073  .dtype).max if s
-00020530: 656c 662e 6474 7970 652e 6b69 6e64 2069  elf.dtype.kind i
-00020540: 6e20 2275 6922 2065 6c73 6520 310d 0a0d  n "ui" else 1...
-00020550: 0a20 2020 2040 7072 6f70 6572 7479 0d0a  .    @property..
-00020560: 2020 2020 6465 6620 5f41 6d69 6e28 7365      def _Amin(se
-00020570: 6c66 293a 0d0a 2020 2020 2020 2020 2222  lf):..        ""
-00020580: 224d 696e 696d 756d 2062 6961 732e 2222  "Minimum bias.""
-00020590: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-000205a0: 6e20 7365 6c66 2e42 202f 2073 656c 662e  n self.B / self.
-000205b0: 5f56 6d61 780d 0a0d 0a20 2020 2040 7072  _Vmax....    @pr
-000205c0: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-000205d0: 5f41 6d61 7828 7365 6c66 293a 0d0a 2020  _Amax(self):..  
-000205e0: 2020 2020 2020 2222 224d 6178 696d 756d        """Maximum
-000205f0: 2062 6961 732e 2222 220d 0a20 2020 2020   bias."""..     
-00020600: 2020 2072 6574 7572 6e20 7365 6c66 2e49     return self.I
-00020610: 6d61 7820 2d20 7365 6c66 2e5f 416d 696e  max - self._Amin
-00020620: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-00020630: 790d 0a20 2020 2064 6566 2041 2873 656c  y..    def A(sel
-00020640: 6629 202d 3e20 666c 6f61 743a 0d0a 2020  f) -> float:..  
-00020650: 2020 2020 2020 2222 2242 6961 732e 2222        """Bias.""
-00020660: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-00020670: 6e20 7365 6c66 2e49 6d61 7820 2a20 7365  n self.Imax * se
-00020680: 6c66 2e62 6574 610d 0a0d 0a20 2020 2040  lf.beta....    @
-00020690: 412e 7365 7474 6572 0d0a 2020 2020 6465  A.setter..    de
-000206a0: 6620 4128 7365 6c66 2c20 413a 2066 6c6f  f A(self, A: flo
-000206b0: 6174 293a 0d0a 2020 2020 2020 2020 5f41  at):..        _A
-000206c0: 203d 2066 6c6f 6174 286d 696e 286d 6178   = float(min(max
-000206d0: 2873 656c 662e 5f41 6d69 6e2c 2041 292c  (self._Amin, A),
-000206e0: 2073 656c 662e 5f41 6d61 7829 290d 0a0d   self._Amax))...
-000206f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00020700: 2e41 2021 3d20 5f41 3a0d 0a20 2020 2020  .A != _A:..     
-00020710: 2020 2020 2020 2073 656c 662e 6265 7461         self.beta
-00020720: 203d 205f 4120 2f20 7365 6c66 2e49 6d61   = _A / self.Ima
-00020730: 780d 0a20 2020 2020 2020 2020 2020 2073  x..            s
-00020740: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-00020750: 2866 227b 7365 6c66 2e41 203d 207d 2229  (f"{self.A = }")
-00020760: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-00020770: 790d 0a20 2020 2064 6566 205f 426d 6178  y..    def _Bmax
-00020780: 2873 656c 6629 3a0d 0a20 2020 2020 2020  (self):..       
-00020790: 2022 2222 4d61 7869 6d75 6d20 616d 706c   """Maximum ampl
-000207a0: 6974 7564 652e 2222 220d 0a20 2020 2020  itude."""..     
-000207b0: 2020 2072 6574 7572 6e20 6d69 6e28 7365     return min(se
-000207c0: 6c66 2e41 2c20 7365 6c66 2e49 6d61 7820  lf.A, self.Imax 
-000207d0: 2d20 7365 6c66 2e41 2920 2a20 7365 6c66  - self.A) * self
-000207e0: 2e5f 566d 6178 0d0a 0d0a 2020 2020 4070  ._Vmax....    @p
-000207f0: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
-00020800: 2042 2873 656c 6629 202d 3e20 666c 6f61   B(self) -> floa
-00020810: 743a 0d0a 2020 2020 2020 2020 2222 2241  t:..        """A
-00020820: 6d70 6c69 7475 6465 2e22 2222 0d0a 2020  mplitude."""..  
-00020830: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00020840: 662e 4120 2a20 7365 6c66 2e56 0d0a 0d0a  f.A * self.V....
-00020850: 2020 2020 4042 2e73 6574 7465 720d 0a20      @B.setter.. 
-00020860: 2020 2064 6566 2042 2873 656c 662c 2042     def B(self, B
-00020870: 3a20 666c 6f61 7429 3a0d 0a20 2020 2020  : float):..     
-00020880: 2020 205f 4220 3d20 666c 6f61 7428 6d69     _B = float(mi
-00020890: 6e28 6d61 7828 302c 2042 292c 2073 656c  n(max(0, B), sel
-000208a0: 662e 5f42 6d61 7829 290d 0a0d 0a20 2020  f._Bmax))....   
-000208b0: 2020 2020 2069 6620 7365 6c66 2e42 2021       if self.B !
-000208c0: 3d20 5f42 3a20 2023 2061 6e64 205f 4220  = _B:  # and _B 
-000208d0: 213d 2030 3a0d 0a20 2020 2020 2020 2020  != 0:..         
-000208e0: 2020 2073 656c 662e 5620 3d20 5f42 202f     self.V = _B /
-000208f0: 2073 656c 662e 410d 0a20 2020 2020 2020   self.A..       
-00020900: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00020910: 2e64 6562 7567 2866 227b 7365 6c66 2e42  .debug(f"{self.B
-00020920: 203d 207d 2229 0d0a 0d0a 2020 2020 4070   = }")....    @p
-00020930: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
-00020940: 205f 6265 7461 6d61 7828 7365 6c66 293a   _betamax(self):
-00020950: 0d0a 2020 2020 2020 2020 2222 224d 6178  ..        """Max
-00020960: 696d 756d 2072 656c 6174 6976 6520 6269  imum relative bi
-00020970: 6173 2028 6578 706f 7375 7265 292e 2222  as (exposure).""
-00020980: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-00020990: 6e20 3120 2f20 2831 202b 2073 656c 662e  n 1 / (1 + self.
-000209a0: 5629 0d0a 0d0a 2020 2020 4070 726f 7065  V)....    @prope
-000209b0: 7274 790d 0a20 2020 2064 6566 2062 6574  rty..    def bet
-000209c0: 6128 7365 6c66 2920 2d3e 2066 6c6f 6174  a(self) -> float
-000209d0: 3a0d 0a20 2020 2020 2020 2022 2222 5265  :..        """Re
-000209e0: 6c61 7469 7665 2062 6961 7320 2865 7870  lative bias (exp
-000209f0: 6f73 7572 6529 2c20 692e 652e 2072 656c  osure), i.e. rel
-00020a00: 6174 6976 6520 6d65 616e 2069 6e74 656e  ative mean inten
-00020a10: 7369 7479 20e2 8888 205b 302c 2031 5d2e  sity ... [0, 1].
-00020a20: 2222 220d 0a20 2020 2020 2020 2072 6574  """..        ret
-00020a30: 7572 6e20 7365 6c66 2e5f 6265 7461 0d0a  urn self._beta..
-00020a40: 0d0a 2020 2020 4062 6574 612e 7365 7474  ..    @beta.sett
-00020a50: 6572 0d0a 2020 2020 6465 6620 6265 7461  er..    def beta
-00020a60: 2873 656c 662c 2062 6574 6129 202d 3e20  (self, beta) -> 
-00020a70: 666c 6f61 743a 0d0a 2020 2020 2020 2020  float:..        
-00020a80: 5f62 6574 6120 3d20 666c 6f61 7428 6d69  _beta = float(mi
-00020a90: 6e28 6d61 7828 302c 2062 6574 6129 2c20  n(max(0, beta), 
-00020aa0: 7365 6c66 2e5f 6265 7461 6d61 7829 290d  self._betamax)).
-00020ab0: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
-00020ac0: 6c66 2e5f 6265 7461 2021 3d20 5f62 6574  lf._beta != _bet
-00020ad0: 613a 0d0a 2020 2020 2020 2020 2020 2020  a:..            
-00020ae0: 7365 6c66 2e5f 6265 7461 203d 205f 6265  self._beta = _be
-00020af0: 7461 0d0a 2020 2020 2020 2020 2020 2020  ta..            
-00020b00: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-00020b10: 6728 6622 7b73 656c 662e 6265 7461 203d  g(f"{self.beta =
-00020b20: 207d 2229 0d0a 0d0a 2020 2020 4070 726f   }")....    @pro
-00020b30: 7065 7274 790d 0a20 2020 2064 6566 205f  perty..    def _
-00020b40: 566d 6178 2873 656c 6629 3a0d 0a20 2020  Vmax(self):..   
-00020b50: 2020 2020 2022 2222 4d61 7869 6d75 6d20       """Maximum 
-00020b60: 7669 7369 6269 6c69 7479 2e22 2222 0d0a  visibility."""..
-00020b70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00020b80: 4644 4d3a 0d0a 2020 2020 2020 2020 2020  FDM:..          
-00020b90: 2020 7265 7475 726e 2031 202f 2028 7365    return 1 / (se
-00020ba0: 6c66 2e44 202a 2073 656c 662e 4b29 0d0a  lf.D * self.K)..
-00020bb0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00020bc0: 662e 5344 4d3a 0d0a 2020 2020 2020 2020  f.SDM:..        
-00020bd0: 2020 2020 7265 7475 726e 2031 202f 2073      return 1 / s
-00020be0: 656c 662e 440d 0a20 2020 2020 2020 2065  elf.D..        e
-00020bf0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-00020c00: 2020 7265 7475 726e 2031 0d0a 0d0a 2020    return 1....  
-00020c10: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-00020c20: 2064 6566 2056 2873 656c 6629 202d 3e20   def V(self) -> 
-00020c30: 666c 6f61 743a 0d0a 2020 2020 2020 2020  float:..        
-00020c40: 2222 2246 7269 6e67 6520 7669 7369 6269  """Fringe visibi
-00020c50: 6c69 7479 2028 6672 696e 6765 2063 6f6e  lity (fringe con
-00020c60: 7472 6173 7429 20e2 8888 205b 302c 2031  trast) ... [0, 1
-00020c70: 5d2e 2222 220d 0a20 2020 2020 2020 2072  ]."""..        r
-00020c80: 6574 7572 6e20 7365 6c66 2e5f 560d 0a0d  eturn self._V...
-00020c90: 0a20 2020 2040 562e 7365 7474 6572 0d0a  .    @V.setter..
-00020ca0: 2020 2020 6465 6620 5628 7365 6c66 2c20      def V(self, 
-00020cb0: 563a 2066 6c6f 6174 293a 0d0a 2020 2020  V: float):..    
-00020cc0: 2020 2020 5f56 203d 2066 6c6f 6174 286d      _V = float(m
-00020cd0: 696e 286d 6178 2830 2c20 5629 2c20 7365  in(max(0, V), se
-00020ce0: 6c66 2e5f 566d 6178 2929 0d0a 0d0a 2020  lf._Vmax))....  
-00020cf0: 2020 2020 2020 6966 2073 656c 662e 5f56        if self._V
-00020d00: 2021 3d20 5f56 3a0d 0a20 2020 2020 2020   != _V:..       
-00020d10: 2020 2020 2073 656c 662e 5f56 203d 205f       self._V = _
-00020d20: 560d 0a20 2020 2020 2020 2020 2020 2073  V..            s
-00020d30: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-00020d40: 2866 227b 7365 6c66 2e56 203d 207d 2229  (f"{self.V = }")
-00020d50: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-00020d60: 790d 0a20 2020 2064 6566 2056 6d69 6e28  y..    def Vmin(
-00020d70: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0d  self) -> float:.
-00020d80: 0a20 2020 2020 2020 2022 2222 4d69 6e69  .        """Mini
-00020d90: 6d75 6d20 7669 7369 6269 6c69 7479 2066  mum visibility f
-00020da0: 6f72 206d 6561 7375 7265 6d65 6e74 2074  or measurement t
-00020db0: 6f20 6265 2076 616c 6964 2e22 2222 0d0a  o be valid."""..
-00020dc0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00020dd0: 656c 662e 5f56 6d69 6e0d 0a0d 0a20 2020  elf._Vmin....   
-00020de0: 2040 566d 696e 2e73 6574 7465 720d 0a20   @Vmin.setter.. 
-00020df0: 2020 2064 6566 2056 6d69 6e28 7365 6c66     def Vmin(self
-00020e00: 2c20 566d 696e 3a20 666c 6f61 7429 3a0d  , Vmin: float):.
-00020e10: 0a20 2020 2020 2020 205f 566d 696e 203d  .        _Vmin =
-00020e20: 2066 6c6f 6174 286d 696e 286d 6178 2830   float(min(max(0
-00020e30: 2c20 566d 696e 292c 2031 2929 0d0a 0d0a  , Vmin), 1))....
-00020e40: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00020e50: 5f56 6d69 6e20 213d 205f 566d 696e 3a0d  _Vmin != _Vmin:.
-00020e60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020e70: 662e 5f56 6d69 6e20 3d20 5f56 6d69 6e0d  f._Vmin = _Vmin.
-00020e80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020e90: 662e 6c6f 6767 6572 2e64 6562 7567 2866  f.logger.debug(f
-00020ea0: 227b 7365 6c66 2e5f 566d 696e 203d 207d  "{self._Vmin = }
-00020eb0: 2229 0d0a 0d0a 2020 2020 4070 726f 7065  ")....    @prope
-00020ec0: 7274 790d 0a20 2020 2064 6566 2075 6d61  rty..    def uma
-00020ed0: 7828 7365 6c66 2920 2d3e 2066 6c6f 6174  x(self) -> float
-00020ee0: 3a0d 0a20 2020 2020 2020 2022 2222 5374  :..        """St
-00020ef0: 616e 6461 7264 2064 6576 6961 7469 6f6e  andard deviation
-00020f00: 206f 6620 6d61 7869 6d75 6d20 756e 6365   of maximum unce
-00020f10: 7274 6169 6e74 7920 666f 7220 6d65 6173  rtainty for meas
-00020f20: 7572 656d 656e 7420 746f 2062 6520 7661  urement to be va
-00020f30: 6c69 642e 0d0a 2020 2020 2020 2020 5b75  lid...        [u
-00020f40: 6d61 785d 203d 2070 782e 2222 220d 0a20  max] = px.""".. 
-00020f50: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00020f60: 6c66 2e5f 756d 6178 0d0a 0d0a 2020 2020  lf._umax....    
-00020f70: 4075 6d61 782e 7365 7474 6572 0d0a 2020  @umax.setter..  
-00020f80: 2020 6465 6620 756d 6178 2873 656c 662c    def umax(self,
-00020f90: 2075 6d61 783a 2066 6c6f 6174 293a 0d0a   umax: float):..
-00020fa0: 2020 2020 2020 2020 5f75 6d61 7820 3d20          _umax = 
-00020fb0: 666c 6f61 7428 6d69 6e28 6d61 7828 302c  float(min(max(0,
-00020fc0: 2075 6d61 7829 2c20 7365 6c66 2e4c 2929   umax), self.L))
-00020fd0: 2020 2320 746f 646f 3a20 4c20 2f20 3220    # todo: L / 2 
-00020fe0: 6475 6520 746f 2063 6972 6375 6c61 7220  due to circular 
-00020ff0: 6469 7374 7269 6275 7469 6f6e 2020 2320  distribution  # 
-00021000: 746f 646f 3a20 522e 6d61 7828 2920 2f20  todo: R.max() / 
-00021010: 320d 0a0d 0a20 2020 2020 2020 2069 6620  2....        if 
-00021020: 7365 6c66 2e5f 756d 6178 2021 3d20 5f75  self._umax != _u
-00021030: 6d61 783a 0d0a 2020 2020 2020 2020 2020  max:..          
-00021040: 2020 7365 6c66 2e5f 756d 6178 203d 205f    self._umax = _
-00021050: 756d 6178 0d0a 2020 2020 2020 2020 2020  umax..          
-00021060: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-00021070: 6275 6728 6622 7b73 656c 662e 5f75 6d61  bug(f"{self._uma
-00021080: 7820 3d20 7d22 290d 0a0d 0a20 2020 2023  x = }")....    #
-00021090: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
-000210a0: 2320 6465 6620 7228 7365 6c66 2920 2d3e  # def r(self) ->
-000210b0: 2069 6e74 3a0d 0a20 2020 2023 2020 2020   int:..    #    
-000210c0: 2022 2222 4e75 6d62 6572 206f 6620 7175   """Number of qu
-000210d0: 616e 7469 7a61 7469 6f6e 2062 6974 732e  antization bits.
-000210e0: 2222 220d 0a20 2020 2023 2020 2020 2072  """..    #     r
-000210f0: 6574 7572 6e20 3120 6966 2073 656c 662e  eturn 1 if self.
-00021100: 6474 7970 652e 6b69 6e64 2069 6e20 2262  dtype.kind in "b
-00021110: 2220 656c 7365 206e 702e 6969 6e66 6f28  " else np.iinfo(
-00021120: 0d0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
-00021130: 7365 6c66 2e64 7479 7065 292e 6269 7473  self.dtype).bits
-00021140: 2069 6620 7365 6c66 2e64 7479 7065 2e6b   if self.dtype.k
-00021150: 696e 6420 696e 2022 7569 2220 656c 7365  ind in "ui" else
-00021160: 2031 3020 2a2a 206e 702e 6669 6e66 6f28   10 ** np.finfo(
-00021170: 7365 6c66 2e64 7479 7065 292e 7072 6563  self.dtype).prec
-00021180: 6973 696f 6e0d 0a0d 0a20 2020 2023 2040  ision....    # @
-00021190: 7072 6f70 6572 7479 0d0a 2020 2020 2320  property..    # 
-000211a0: 6465 6620 5128 7365 6c66 2920 2d3e 2066  def Q(self) -> f
-000211b0: 6c6f 6174 3a0d 0a20 2020 2023 2020 2020  loat:..    #    
-000211c0: 2022 2222 4e75 6d62 6572 206f 6620 7175   """Number of qu
-000211d0: 616e 7469 7a61 7469 6f6e 206c 6576 656c  antization level
-000211e0: 732e 2222 220d 0a20 2020 2023 2020 2020  s."""..    #    
-000211f0: 2072 6574 7572 6e20 3220 2a2a 2073 656c   return 2 ** sel
-00021200: 662e 720d 0a0d 0a20 2020 2040 7072 6f70  f.r....    @prop
-00021210: 6572 7479 0d0a 2020 2020 6465 6620 7128  erty..    def q(
-00021220: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0d  self) -> float:.
-00021230: 0a20 2020 2020 2020 2022 2222 5175 616e  .        """Quan
-00021240: 7469 7a61 7469 6f6e 2073 7465 7020 7369  tization step si
-00021250: 7a65 2e22 2222 0d0a 2020 2020 2020 2020  ze."""..        
-00021260: 7265 7475 726e 2031 2e30 2069 6620 7365  return 1.0 if se
-00021270: 6c66 2e64 7479 7065 2e6b 696e 6420 696e  lf.dtype.kind in
-00021280: 2022 7569 6222 2065 6c73 6520 6e70 2e66   "uib" else np.f
-00021290: 696e 666f 2873 656c 662e 6474 7970 6529  info(self.dtype)
-000212a0: 2e72 6573 6f6c 7574 696f 6e0d 0a0d 0a20  .resolution.... 
-000212b0: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-000212c0: 2020 6465 6620 7175 616e 7428 7365 6c66    def quant(self
-000212d0: 2920 2d3e 2066 6c6f 6174 3a0d 0a20 2020  ) -> float:..   
-000212e0: 2020 2020 2022 2222 5175 616e 7469 7a61       """Quantiza
-000212f0: 7469 6f6e 206e 6f69 7365 2028 7374 616e  tion noise (stan
-00021300: 6461 7264 2064 6576 6961 7469 6f6e 292e  dard deviation).
-00021310: 0d0a 2020 2020 2020 2020 5b71 7561 6e74  ..        [quant
-00021320: 5d20 3d20 444e 2e22 2222 0d0a 2020 2020  ] = DN."""..    
-00021330: 2020 2020 7265 7475 726e 2066 6c6f 6174      return float
-00021340: 2873 656c 662e 7120 2f20 6e70 2e73 7172  (self.q / np.sqr
-00021350: 7428 3132 2929 2020 2320 636f 6e76 6572  t(12))  # conver
-00021360: 7420 4e75 6d70 7920 666c 6f61 7436 3420  t Numpy float64 
-00021370: 746f 2050 7974 686f 6e20 666c 6f61 740d  to Python float.
-00021380: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
-00021390: 0d0a 2020 2020 6465 6620 6461 726b 2873  ..    def dark(s
-000213a0: 656c 6629 202d 3e20 666c 6f61 743a 0d0a  elf) -> float:..
-000213b0: 2020 2020 2020 2020 2222 2244 6172 6b20          """Dark 
-000213c0: 6e6f 6973 6520 6f66 2074 6865 2064 6967  noise of the dig
-000213d0: 6974 616c 2063 616d 6572 6120 2873 7461  ital camera (sta
-000213e0: 6e64 6172 6420 6465 7669 6174 696f 6e29  ndard deviation)
-000213f0: 2e0d 0a20 2020 2020 2020 205b 6461 726b  ...        [dark
-00021400: 5d20 3d20 656c 6563 7472 6f6e 732e 2222  ] = electrons.""
-00021410: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-00021420: 6e20 7365 6c66 2e5f 6461 726b 0d0a 0d0a  n self._dark....
-00021430: 2020 2020 4064 6172 6b2e 7365 7474 6572      @dark.setter
-00021440: 0d0a 2020 2020 6465 6620 6461 726b 2873  ..    def dark(s
-00021450: 656c 662c 2064 6172 6b3a 2066 6c6f 6174  elf, dark: float
-00021460: 293a 0d0a 2020 2020 2020 2020 5f64 6172  ):..        _dar
-00021470: 6b20 3d20 666c 6f61 7428 6d69 6e28 6d61  k = float(min(ma
-00021480: 7828 302c 2064 6172 6b29 2c20 6e70 2e73  x(0, dark), np.s
-00021490: 7172 7428 7365 6c66 2e49 6d61 7829 2929  qrt(self.Imax)))
-000214a0: 0d0a 0d0a 2020 2020 2020 2020 2320 5f64  ....        # _d
-000214b0: 6172 6b20 3d20 6d61 7828 5f64 6172 6b2c  ark = max(_dark,
-000214c0: 2030 2e34 3929 2020 2320 746f 646f 3a20   0.49)  # todo: 
-000214d0: 7465 6d70 6f72 616c 206e 6f69 7365 2069  temporal noise i
-000214e0: 7320 646f 6d69 6e61 7465 6420 6279 2071  s dominated by q
-000214f0: 7561 6e74 697a 6174 696f 6e20 6e6f 6973  uantization nois
-00021500: 6520 2d3e 0d0a 0d0a 2020 2020 2020 2020  e ->....        
-00021510: 5f64 6172 6b20 3d20 6d61 7828 302c 205f  _dark = max(0, _
-00021520: 6461 726b 202d 2073 656c 662e 7175 616e  dark - self.quan
-00021530: 7429 2020 2320 636f 7272 6563 7420 666f  t)  # correct fo
-00021540: 7220 7175 616e 7469 7a61 7469 6f6e 206e  r quantization n
-00021550: 6f69 7365 2063 6f6e 7461 696e 6564 2069  oise contained i
-00021560: 6e20 6461 726b 206e 6f69 7365 206d 6561  n dark noise mea
-00021570: 7375 7265 6d65 6e74 0d0a 0d0a 2020 2020  surement....    
-00021580: 2020 2020 6966 2073 656c 662e 5f64 6172      if self._dar
-00021590: 6b20 213d 205f 6461 726b 3a0d 0a20 2020  k != _dark:..   
-000215a0: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-000215b0: 6172 6b20 3d20 5f64 6172 6b0d 0a20 2020  ark = _dark..   
-000215c0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-000215d0: 6767 6572 2e64 6562 7567 2866 227b 7365  gger.debug(f"{se
-000215e0: 6c66 2e5f 6461 726b 203d 207d 2229 0d0a  lf._dark = }")..
-000215f0: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
-00021600: 0a20 2020 2064 6566 2073 686f 7428 7365  .    def shot(se
-00021610: 6c66 2920 2d3e 2066 6c6f 6174 3a0d 0a20  lf) -> float:.. 
-00021620: 2020 2020 2020 2022 2222 5368 6f74 206e         """Shot n
-00021630: 6f69 7365 206f 6620 6469 6769 7461 6c20  oise of digital 
-00021640: 6361 6d65 7261 2028 7374 616e 6461 7264  camera (standard
-00021650: 2064 6576 6961 7469 6f6e 292e 0d0a 2020   deviation)...  
-00021660: 2020 2020 2020 5b73 686f 745d 203d 2044        [shot] = D
-00021670: 4e2e 2222 220d 0a20 2020 2020 2020 2041  N."""..        A
-00021680: 203d 2073 656c 662e 4120 2a20 7365 6c66   = self.A * self
-00021690: 2e4d 5446 2830 290d 0a20 2020 2020 2020  .MTF(0)..       
-000216a0: 2072 6574 7572 6e20 6e70 2e73 7172 7428   return np.sqrt(
-000216b0: 7365 6c66 2e67 6169 6e20 2a20 6d61 7828  self.gain * max(
-000216c0: 302c 2041 202d 2073 656c 662e 7930 2929  0, A - self.y0))
-000216d0: 2069 6620 7365 6c66 2e67 6169 6e20 213d   if self.gain !=
-000216e0: 2030 2065 6c73 6520 3020 2023 2061 7665   0 else 0  # ave
-000216f0: 7261 6765 2069 6e74 656e 7369 7479 2069  rage intensity i
-00021700: 7320 6269 6173 0d0a 0d0a 2020 2020 4070  s bias....    @p
-00021710: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
-00021720: 2067 6169 6e28 7365 6c66 2920 2d3e 2066   gain(self) -> f
-00021730: 6c6f 6174 3a0d 0a20 2020 2020 2020 2022  loat:..        "
-00021740: 2222 4f76 6572 616c 6c20 7379 7374 656d  ""Overall system
-00021750: 2067 6169 6e20 6f66 2064 6967 6974 616c   gain of digital
-00021760: 2063 616d 6572 612e 0d0a 2020 2020 2020   camera...      
-00021770: 2020 5b67 6169 6e5d 203d 2044 4e20 2f20    [gain] = DN / 
-00021780: 656c 6563 7472 6f6e 732e 2222 220d 0a20  electrons.""".. 
-00021790: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000217a0: 6c66 2e5f 6761 696e 0d0a 0d0a 2020 2020  lf._gain....    
-000217b0: 4067 6169 6e2e 7365 7474 6572 0d0a 2020  @gain.setter..  
-000217c0: 2020 6465 6620 6761 696e 2873 656c 662c    def gain(self,
-000217d0: 2067 6169 6e3a 2066 6c6f 6174 293a 0d0a   gain: float):..
-000217e0: 2020 2020 2020 2020 5f67 6169 6e20 3d20          _gain = 
-000217f0: 6d69 6e28 6d61 7828 302c 2067 6169 6e29  min(max(0, gain)
-00021800: 2c20 3129 0d0a 0d0a 2020 2020 2020 2020  , 1)....        
-00021810: 6966 2073 656c 662e 5f67 6169 6e20 213d  if self._gain !=
-00021820: 205f 6761 696e 3a0d 0a20 2020 2020 2020   _gain:..       
-00021830: 2020 2020 2073 656c 662e 5f67 6169 6e20       self._gain 
-00021840: 3d20 5f67 6169 6e0d 0a20 2020 2020 2020  = _gain..       
-00021850: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00021860: 2e64 6562 7567 2866 227b 7365 6c66 2e5f  .debug(f"{self._
-00021870: 6761 696e 203d 207d 2229 0d0a 0d0a 2020  gain = }")....  
-00021880: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-00021890: 2064 6566 206d 6167 6e69 6669 6361 7469   def magnificati
-000218a0: 6f6e 2873 656c 6629 202d 3e20 666c 6f61  on(self) -> floa
-000218b0: 743a 0d0a 2020 2020 2020 2020 2222 224d  t:..        """M
-000218c0: 6167 6e69 6669 6361 7469 6f6e 206f 6620  agnification of 
-000218d0: 7468 6520 6f70 7469 6361 6c20 696d 6167  the optical imag
-000218e0: 696e 672e 0d0a 0d0a 2020 2020 2020 2020  ing.....        
-000218f0: 4361 6d65 7261 2070 6978 656c 7320 7065  Camera pixels pe
-00021900: 7220 7363 7265 656e 2070 6978 656c 2c20  r screen pixel, 
-00021910: 6c61 7465 7261 6c6c 792e 2222 220d 0a20  laterally.""".. 
-00021920: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00021930: 6c66 2e5f 6d61 676e 6966 6963 6174 696f  lf._magnificatio
-00021940: 6e0d 0a0d 0a20 2020 2040 6d61 676e 6966  n....    @magnif
-00021950: 6963 6174 696f 6e2e 7365 7474 6572 0d0a  ication.setter..
-00021960: 2020 2020 6465 6620 6d61 676e 6966 6963      def magnific
-00021970: 6174 696f 6e28 7365 6c66 2c20 6d61 676e  ation(self, magn
-00021980: 6966 6963 6174 696f 6e29 3a0d 0a20 2020  ification):..   
-00021990: 2020 2020 205f 6d61 676e 6966 6963 6174       _magnificat
-000219a0: 696f 6e20 3d20 666c 6f61 7428 6d61 7828  ion = float(max(
-000219b0: 302c 206d 6167 6e69 6669 6361 7469 6f6e  0, magnification
-000219c0: 2929 0d0a 0d0a 2020 2020 2020 2020 6966  ))....        if
-000219d0: 2073 656c 662e 5f6d 6167 6e69 6669 6361   self._magnifica
-000219e0: 7469 6f6e 2021 3d20 5f6d 6167 6e69 6669  tion != _magnifi
-000219f0: 6361 7469 6f6e 3a0d 0a20 2020 2020 2020  cation:..       
-00021a00: 2020 2020 2073 656c 662e 5f6d 6167 6e69       self._magni
-00021a10: 6669 6361 7469 6f6e 203d 205f 6d61 676e  fication = _magn
-00021a20: 6966 6963 6174 696f 6e0d 0a20 2020 2020  ification..     
-00021a30: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-00021a40: 6572 2e64 6562 7567 2866 227b 7365 6c66  er.debug(f"{self
-00021a50: 2e5f 6d61 676e 6966 6963 6174 696f 6e20  ._magnification 
-00021a60: 3d20 7d22 290d 0a0d 0a20 2020 2040 7072  = }")....    @pr
-00021a70: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-00021a80: 5053 4628 7365 6c66 2920 2d3e 2066 6c6f  PSF(self) -> flo
-00021a90: 6174 3a0d 0a20 2020 2020 2020 2022 2222  at:..        """
-00021aa0: 5374 616e 6461 7264 2064 6576 6961 7469  Standard deviati
-00021ab0: 6f6e 206f 6620 506f 696e 7420 5370 7265  on of Point Spre
-00021ac0: 6164 2046 756e 6374 696f 6e20 666f 7220  ad Function for 
-00021ad0: 6465 666f 6375 732e 0d0a 2020 2020 2020  defocus...      
-00021ae0: 2020 5b50 5346 5d20 3d20 7078 2e22 2222    [PSF] = px."""
-00021af0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00021b00: 2073 656c 662e 5f50 5346 0d0a 0d0a 2020   self._PSF....  
-00021b10: 2020 4050 5346 2e73 6574 7465 720d 0a20    @PSF.setter.. 
-00021b20: 2020 2064 6566 2050 5346 2873 656c 662c     def PSF(self,
-00021b30: 2050 5346 293a 0d0a 2020 2020 2020 2020   PSF):..        
-00021b40: 5f50 5346 203d 2066 6c6f 6174 286d 6178  _PSF = float(max
-00021b50: 2830 2c20 5053 4629 290d 0a0d 0a20 2020  (0, PSF))....   
-00021b60: 2020 2020 2069 6620 7365 6c66 2e5f 5053       if self._PS
-00021b70: 4620 213d 205f 5053 463a 0d0a 2020 2020  F != _PSF:..    
-00021b80: 2020 2020 2020 2020 7365 6c66 2e5f 5053          self._PS
-00021b90: 4620 3d20 5f50 5346 0d0a 2020 2020 2020  F = _PSF..      
-00021ba0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-00021bb0: 722e 6465 6275 6728 6622 7b73 656c 662e  r.debug(f"{self.
-00021bc0: 5f50 5346 203d 207d 2229 0d0a 0d0a 2020  _PSF = }")....  
-00021bd0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
-00021be0: 2064 6566 2079 3028 7365 6c66 2920 2d3e   def y0(self) ->
-00021bf0: 2066 6c6f 6174 3a0d 0a20 2020 2020 2020   float:..       
-00021c00: 2022 2222 4461 726b 2073 6967 6e61 6c2e   """Dark signal.
-00021c10: 0d0a 2020 2020 2020 2020 5b79 305d 203d  ..        [y0] =
-00021c20: 2044 4e22 2222 0d0a 2020 2020 2020 2020   DN"""..        
-00021c30: 7265 7475 726e 2073 656c 662e 5f79 300d  return self._y0.
-00021c40: 0a0d 0a20 2020 2040 7930 2e73 6574 7465  ...    @y0.sette
-00021c50: 720d 0a20 2020 2064 6566 2079 3028 7365  r..    def y0(se
-00021c60: 6c66 2c20 7930 3a20 696e 7420 7c20 666c  lf, y0: int | fl
-00021c70: 6f61 7429 3a0d 0a20 2020 2020 2020 205f  oat):..        _
-00021c80: 7930 203d 2066 6c6f 6174 286d 696e 286d  y0 = float(min(m
-00021c90: 6178 2830 2c20 7930 292c 2073 656c 662e  ax(0, y0), self.
-00021ca0: 496d 6178 2929 0d0a 0d0a 2020 2020 2020  Imax))....      
-00021cb0: 2020 6966 2073 656c 662e 5f79 3020 213d    if self._y0 !=
-00021cc0: 205f 7930 3a0d 0a20 2020 2020 2020 2020   _y0:..         
-00021cd0: 2020 2073 656c 662e 5f79 3020 3d20 5f79     self._y0 = _y
-00021ce0: 300d 0a20 2020 2020 2020 2020 2020 2073  0..            s
-00021cf0: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-00021d00: 2866 227b 7365 6c66 2e5f 7930 203d 207d  (f"{self._y0 = }
-00021d10: 2229 0d0a 0d0a 2020 2020 4070 726f 7065  ")....    @prope
-00021d20: 7274 790d 0a20 2020 2064 6566 2055 4d52  rty..    def UMR
-00021d30: 2873 656c 6629 202d 3e20 6e70 2e6e 6461  (self) -> np.nda
-00021d40: 7272 6179 3a0d 0a20 2020 2020 2020 2022  rray:..        "
-00021d50: 2222 556e 616d 6269 6775 6f75 7320 6d65  ""Unambiguous me
-00021d60: 6173 7572 656d 656e 7420 7261 6e67 652e  asurement range.
-00021d70: 0d0a 2020 2020 2020 2020 5b55 4d52 5d20  ..        [UMR] 
-00021d80: 3d20 7078 0d0a 0d0a 2020 2020 2020 2020  = px....        
-00021d90: 5468 6520 636f 6469 6e67 2069 7320 6f6e  The coding is on
-00021da0: 6c79 2075 6e69 7175 6520 7769 7468 696e  ly unique within
-00021db0: 2074 6865 2069 6e74 6572 7661 6c20 5b30   the interval [0
-00021dc0: 2c20 554d 5229 3b20 6166 7465 7220 7468  , UMR); after th
-00021dd0: 6174 2069 7420 7265 7065 6174 7320 6974  at it repeats it
-00021de0: 7365 6c66 2e0d 0a0d 0a20 2020 2020 2020  self.....       
-00021df0: 2054 6865 2055 4d52 2069 7320 6465 7269   The UMR is deri
-00021e00: 7665 6420 6672 6f6d 206c 2061 6e64 2076  ved from l and v
-00021e10: 3a5c 6e0d 0a20 2020 2020 2020 202d 2049  :\n..        - I
-00021e20: 6620 6c20 e288 8820 e284 952c 2055 4d52  f l ... ..., UMR
-00021e30: 203d 206c 636d 286c 2920 7769 7468 206c   = lcm(l) with l
-00021e40: 636d 2062 6569 6e67 2074 6865 206c 6561  cm being the lea
-00021e50: 7374 2063 6f6d 6d6f 6e20 6d75 6c74 6970  st common multip
-00021e60: 6c65 2e5c 6e0d 0a20 2020 2020 2020 202d  le.\n..        -
-00021e70: 2045 6c73 652c 2069 6620 7620 e288 8820   Else, if v ... 
-00021e80: e284 952c 2055 4d52 203d 204c 2f20 6763  ..., UMR = L/ gc
-00021e90: 6428 7629 2077 6974 6820 6763 6420 6265  d(v) with gcd be
-00021ea0: 696e 6720 7468 6520 6772 6561 7465 7374  ing the greatest
-00021eb0: 2063 6f6d 6d6f 6e20 6469 7669 736f 722e   common divisor.
-00021ec0: 5c6e 0d0a 2020 2020 2020 2020 2d20 456c  \n..        - El
-00021ed0: 7365 2c20 6966 206c 20e2 88a8 2076 20e2  se, if l ... v .
-00021ee0: 8888 20e2 849a 2c20 6c63 6d20 7265 7370  .. ..., lcm resp
-00021ef0: 2e20 6763 6420 6172 6520 6578 7465 6e64  . gcd are extend
-00021f00: 6564 2074 6f20 7261 7469 6f6e 616c 206e  ed to rational n
-00021f10: 756d 6265 7273 2e5c 6e0d 0a20 2020 2020  umbers.\n..     
-00021f20: 2020 202d 2045 6c73 652c 2069 6620 6c20     - Else, if l 
-00021f30: e288 a720 7620 e288 8820 e284 9d20 5c20  ... v ... ... \ 
-00021f40: e284 9a2c 206c 2061 6e64 2076 2061 7265  ..., l and v are
-00021f50: 2061 7070 726f 7869 6d61 7465 6420 6279   approximated by
-00021f60: 2072 6174 696f 6e61 6c20 6e75 6d62 6572   rational number
-00021f70: 7320 7769 7468 2061 2066 6978 6564 206c  s with a fixed l
-00021f80: 656e 6774 6820 6f66 2064 6563 696d 616c  ength of decimal
-00021f90: 2064 6967 6974 732e 0d0a 2020 2020 2020   digits...      
-00021fa0: 2020 2222 220d 0a0d 0a20 2020 2020 2020    """....       
-00021fb0: 2069 6620 7365 6c66 2e5f 554d 5220 6973   if self._UMR is
-00021fc0: 206e 6f74 204e 6f6e 653a 2020 2320 6361   not None:  # ca
-00021fd0: 6368 650d 0a20 2020 2020 2020 2020 2020  che..           
-00021fe0: 2072 6574 7572 6e20 7365 6c66 2e5f 554d   return self._UM
-00021ff0: 5220 2023 2074 6f64 6f3a 2072 6573 6574  R  # todo: reset
-00022000: 7469 6e67 2063 6163 6865 2064 6f65 736e  ting cache doesn
-00022010: 2774 2077 6f72 6b20 666f 7220 736f 6d65  't work for some
-00022020: 2072 6561 736f 6e73 2e2e 2e0d 0a0d 0a20   reasons....... 
-00022030: 2020 2020 2020 2023 2070 7265 6369 7369         # precisi
-00022040: 6f6e 203d 206e 702e 6669 6e66 6f28 2266  on = np.finfo("f
-00022050: 6c6f 6174 3634 2229 2e70 7265 6369 7369  loat64").precisi
-00022060: 6f6e 202d 2031 0d0a 2020 2020 2020 2020  on - 1..        
-00022070: 7072 6563 6973 696f 6e20 3d20 3130 0d0a  precision = 10..
-00022080: 0d0a 2020 2020 2020 2020 554d 5220 3d20  ..        UMR = 
-00022090: 6e70 2e65 6d70 7479 2873 656c 662e 4429  np.empty(self.D)
-000220a0: 0d0a 2020 2020 2020 2020 666f 7220 6420  ..        for d 
-000220b0: 696e 2072 616e 6765 2873 656c 662e 4429  in range(self.D)
-000220c0: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
-000220d0: 203d 2073 656c 662e 5f6c 5b64 5d20 2023   = self._l[d]  #
-000220e0: 202e 636f 7079 2829 0d0a 2020 2020 2020   .copy()..      
-000220f0: 2020 2020 2020 7620 3d20 7365 6c66 2e5f        v = self._
-00022100: 765b 645d 2e63 6f70 7928 290d 0a0d 0a20  v[d].copy().... 
-00022110: 2020 2020 2020 2020 2020 2069 6620 3120             if 1 
-00022120: 696e 2073 656c 662e 5f4e 5b64 5d3a 2020  in self._N[d]:  
-00022130: 2320 6865 7265 2c20 696e 2054 5055 2074  # here, in TPU t
-00022140: 7769 6365 2074 6865 2063 6f6d 6269 6e61  wice the combina
-00022150: 7469 6f6e 7320 6861 7665 2074 6f20 6265  tions have to be
-00022160: 2074 7269 6564 0d0a 2020 2020 2020 2020   tried..        
-00022170: 2020 2020 2020 2020 2320 746f 646f 3a20          # todo: 
-00022180: 7465 7374 2069 6620 7661 6c69 640d 0a20  test if valid.. 
-00022190: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000221a0: 5b73 656c 662e 5f4e 5b64 5d20 3d3d 2031  [self._N[d] == 1
-000221b0: 5d20 2f3d 2032 0d0a 2020 2020 2020 2020  ] /= 2..        
-000221c0: 2020 2020 2020 2020 765b 7365 6c66 2e5f          v[self._
-000221d0: 4e5b 645d 203d 3d20 315d 202a 3d20 320d  N[d] == 1] *= 2.
-000221e0: 0a0d 0a20 2020 2020 2020 2020 2020 2069  ...            i
-000221f0: 6620 3020 696e 2076 3a20 2023 2065 7175  f 0 in v:  # equ
-00022200: 6976 616c 656e 746c 793a 206e 702e 696e  ivalently: np.in
-00022210: 6620 696e 206c 0d0a 2020 2020 2020 2020  f in l..        
-00022220: 2020 2020 2020 2020 6c20 3d20 6c5b 7620          l = l[v 
-00022230: 213d 2030 5d0d 0a20 2020 2020 2020 2020  != 0]..         
-00022240: 2020 2020 2020 2076 203d 2076 5b76 2021         v = v[v !
-00022250: 3d20 305d 0d0a 0d0a 2020 2020 2020 2020  = 0]....        
-00022260: 2020 2020 6966 206c 656e 286c 2920 3d3d      if len(l) ==
-00022270: 2030 206f 7220 6c65 6e28 7629 203d 3d20   0 or len(v) == 
-00022280: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
-00022290: 2020 2020 554d 525b 645d 203d 2031 2020      UMR[d] = 1  
-000222a0: 2320 6f6e 6520 7369 6e63 6520 7765 2063  # one since we c
-000222b0: 616e 206f 6e6c 7920 636f 6e74 726f 6c20  an only control 
-000222c0: 6469 7363 7265 7465 2070 6978 656c 730d  discrete pixels.
-000222d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000222e0: 2062 7265 616b 0d0a 0d0a 2020 2020 2020   break....      
-000222f0: 2020 2020 2020 2320 746f 646f 3a20 6966        # todo: if
-00022300: 2061 6c6c 2869 2e69 735f 2066 6f72 2069   all(i.is_ for i
-00022310: 2069 6e20 290d 0a0d 0a20 2020 2020 2020   in )....       
-00022320: 2020 2020 2069 6620 616c 6c28 6920 2520       if all(i % 
-00022330: 3120 3d3d 2030 2066 6f72 2069 2069 6e20  1 == 0 for i in 
-00022340: 6c29 3a20 2023 2061 6c6c 206c 2061 7265  l):  # all l are
-00022350: 2069 6e74 6567 6572 730d 0a20 2020 2020   integers..     
-00022360: 2020 2020 2020 2020 2020 2055 4d52 5b64             UMR[d
-00022370: 5d20 3d20 6e70 2e6c 636d 2e72 6564 7563  ] = np.lcm.reduc
-00022380: 6528 5b69 6e74 2869 2920 666f 7220 6920  e([int(i) for i 
-00022390: 696e 206c 5d29 0d0a 2020 2020 2020 2020  in l])..        
-000223a0: 2020 2020 656c 6966 2061 6c6c 2869 2025      elif all(i %
-000223b0: 2031 203d 3d20 3020 666f 7220 6920 696e   1 == 0 for i in
-000223c0: 2076 293a 2020 2320 616c 6c20 7620 6172   v):  # all v ar
-000223d0: 6520 696e 7465 6765 7273 0d0a 2020 2020  e integers..    
-000223e0: 2020 2020 2020 2020 2020 2020 554d 525b              UMR[
-000223f0: 645d 203d 2073 656c 662e 4c20 2f20 6e70  d] = self.L / np
-00022400: 2e67 6364 2e72 6564 7563 6528 5b69 6e74  .gcd.reduce([int
-00022410: 2869 2920 666f 7220 6920 696e 2076 5d29  (i) for i in v])
-00022420: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-00022430: 6966 2061 6c6c 286e 702e 6973 636c 6f73  if all(np.isclos
-00022440: 6528 6c2c 206e 702e 7269 6e74 286c 292c  e(l, np.rint(l),
-00022450: 2072 746f 6c3d 302c 2061 746f 6c3d 3130   rtol=0, atol=10
-00022460: 2a2a 2d70 7265 6369 7369 6f6e 2929 3a0d  **-precision)):.
-00022470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022480: 2055 4d52 5b64 5d20 3d20 6e70 2e6c 636d   UMR[d] = np.lcm
-00022490: 2e72 6564 7563 6528 5b69 6e74 2869 2920  .reduce([int(i) 
-000224a0: 666f 7220 6920 696e 206e 702e 7269 6e74  for i in np.rint
-000224b0: 286c 295d 2920 2023 2061 6c6c 206c 2061  (l)])  # all l a
-000224c0: 7265 2061 7070 726f 7869 6d61 7465 6c79  re approximately
-000224d0: 2069 6e74 6567 6572 730d 0a20 2020 2020   integers..     
-000224e0: 2020 2020 2020 2065 6c69 6620 616c 6c28         elif all(
-000224f0: 6e70 2e69 7363 6c6f 7365 2876 2c20 6e70  np.isclose(v, np
-00022500: 2e72 696e 7428 7629 2c20 7274 6f6c 3d30  .rint(v), rtol=0
-00022510: 2c20 6174 6f6c 3d31 302a 2a2d 7072 6563  , atol=10**-prec
-00022520: 6973 696f 6e29 293a 0d0a 2020 2020 2020  ision)):..      
-00022530: 2020 2020 2020 2020 2020 554d 525b 645d            UMR[d]
-00022540: 203d 2073 656c 662e 4c20 2f20 6e70 2e67   = self.L / np.g
-00022550: 6364 2e72 6564 7563 6528 5b69 6e74 2869  cd.reduce([int(i
-00022560: 2920 666f 7220 6920 696e 206e 702e 7269  ) for i in np.ri
-00022570: 6e74 2876 295d 2920 2023 2061 6c6c 2076  nt(v)])  # all v
-00022580: 2061 7265 2061 7070 726f 7869 6d61 7465   are approximate
-00022590: 6c79 2069 6e74 6567 6572 730d 0a20 2020  ly integers..   
-000225a0: 2020 2020 2020 2020 2065 6c73 653a 2020           else:  
-000225b0: 2320 6c20 616e 6420 7620 626f 7468 2061  # l and v both a
-000225c0: 7265 206e 6f74 2069 6e74 6567 6572 732c  re not integers,
-000225d0: 206e 6f74 2065 7665 6e20 6170 7072 6f78   not even approx
-000225e0: 696d 6174 656c 790d 0a20 2020 2020 2020  imately..       
-000225f0: 2020 2020 2020 2020 206c 636f 7079 203d           lcopy =
-00022600: 206c 2e63 6f70 7928 290d 0a0d 0a20 2020   l.copy()....   
-00022610: 2020 2020 2020 2020 2020 2020 2023 206d               # m
-00022620: 7574 7561 6c20 6661 6374 6f72 6961 6c20  utual factorial 
-00022630: 7465 7374 2066 6f72 2069 6e74 6567 6572  test for integer
-00022640: 7320 692e 652e 206d 7574 7561 6c20 6469  s i.e. mutual di
-00022650: 7669 7369 6269 6c69 7479 2074 6573 740d  visibility test.
-00022660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022670: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00022680: 7365 6c66 2e4b 202d 2031 293a 0d0a 2020  self.K - 1):..  
-00022690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226a0: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
-000226b0: 2869 202b 2031 2c20 7365 6c66 2e4b 202d  (i + 1, self.K -
-000226c0: 2031 293a 0d0a 2020 2020 2020 2020 2020   1):..          
-000226d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000226e0: 206c 5b69 5d20 2520 6c5b 6a5d 203c 2031   l[i] % l[j] < 1
-000226f0: 302a 2a2d 7072 6563 6973 696f 6e3a 0d0a  0**-precision:..
-00022700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022710: 2020 2020 2020 2020 2020 2020 6c63 6f70              lcop
-00022720: 795b 6a5d 203d 2031 0d0a 2020 2020 2020  y[j] = 1..      
-00022730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022740: 2020 656c 6966 206c 5b6a 5d20 2520 6c5b    elif l[j] % l[
-00022750: 695d 203c 2031 302a 2a2d 7072 6563 6973  i] < 10**-precis
-00022760: 696f 6e3a 0d0a 2020 2020 2020 2020 2020  ion:..          
-00022770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022780: 2020 6c63 6f70 795b 695d 203d 2031 0d0a    lcopy[i] = 1..
-00022790: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000227a0: 2020 6c20 3d20 6c5b 6c63 6f70 7920 213d    l = l[lcopy !=
-000227b0: 2031 5d0d 0a0d 0a20 2020 2020 2020 2020   1]....         
-000227c0: 2020 2020 2020 2023 2065 7374 696d 6174         # estimat
-000227d0: 6520 7768 6574 6865 7220 656c 656d 656e  e whether elemen
-000227e0: 7473 2061 7265 2072 6174 696f 6e61 6c20  ts are rational 
-000227f0: 6f72 2069 7272 6174 696f 6e61 6c0d 0a20  or irrational.. 
-00022800: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00022810: 6563 696d 616c 7320 3d20 5b6c 656e 2873  ecimals = [len(s
-00022820: 7472 2869 2929 202d 206c 656e 2873 7472  tr(i)) - len(str
-00022830: 2869 6e74 2869 2929 2920 2d20 3120 666f  (int(i))) - 1 fo
-00022840: 7220 6920 696e 206c 5d20 2023 202d 313a  r i in l]  # -1:
-00022850: 2064 6f74 0d0a 2020 2020 2020 2020 2020   dot..          
-00022860: 2020 2020 2020 446c 203d 206d 6178 2864        Dl = max(d
-00022870: 6563 696d 616c 7329 0d0a 2020 2020 2020  ecimals)..      
-00022880: 2020 2020 2020 2020 2020 6465 6369 6d61            decima
-00022890: 6c73 203d 205b 6c65 6e28 7374 7228 6929  ls = [len(str(i)
-000228a0: 2920 2d20 6c65 6e28 7374 7228 696e 7428  ) - len(str(int(
-000228b0: 6929 2929 202d 2031 2066 6f72 2069 2069  i))) - 1 for i i
-000228c0: 6e20 765d 2020 2320 2d31 3a20 646f 740d  n v]  # -1: dot.
-000228d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000228e0: 2044 7620 3d20 6d61 7828 6465 6369 6d61   Dv = max(decima
-000228f0: 6c73 290d 0a0d 0a20 2020 2020 2020 2020  ls)....         
-00022900: 2020 2020 2020 2069 6620 6d69 6e28 446c         if min(Dl
-00022910: 2c20 4476 2920 3c20 7072 6563 6973 696f  , Dv) < precisio
-00022920: 6e3a 2020 2320 7261 7469 6f6e 616c 206e  n:  # rational n
-00022930: 756d 6265 7273 2077 6974 686f 7574 2069  umbers without i
-00022940: 6e74 6567 6572 7320 2869 2e65 2e20 6e6f  ntegers (i.e. no
-00022950: 7420 636f 7665 7265 6420 6279 2069 7363  t covered by isc
-00022960: 6c6f 7365 2861 746f 6c29 290d 0a20 2020  lose(atol))..   
-00022970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022980: 2023 2065 7874 656e 6420 6c63 6d2f 6763   # extend lcm/gc
-00022990: 6420 746f 2072 6174 696f 6e61 6c20 6e75  d to rational nu
-000229a0: 6d62 6572 730d 0a0d 0a20 2020 2020 2020  mbers....       
-000229b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000229c0: 446c 203c 3d20 4476 3a0d 0a20 2020 2020  Dl <= Dv:..     
-000229d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229e0: 2020 206c 7320 3d20 6c20 2a20 3130 2a2a     ls = l * 10**
-000229f0: 446c 2020 2320 7761 7665 6c65 6e67 7468  Dl  # wavelength
-00022a00: 7320 7363 616c 6564 0d0a 2020 2020 2020  s scaled..      
-00022a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a20: 2020 554d 525b 645d 203d 206e 702e 6c63    UMR[d] = np.lc
-00022a30: 6d2e 7265 6475 6365 285b 696e 7428 6929  m.reduce([int(i)
-00022a40: 2066 6f72 2069 2069 6e20 6c73 5d29 202f   for i in ls]) /
-00022a50: 2031 302a 2a44 6c0d 0a20 2020 2020 2020   10**Dl..       
-00022a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a70: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
-00022a80: 7567 2822 4578 7465 6e64 6564 206c 636d  ug("Extended lcm
-00022a90: 2074 6f20 7261 7469 6f6e 616c 206e 756d   to rational num
-00022aa0: 6265 7273 2e22 290d 0a20 2020 2020 2020  bers.")..       
-00022ab0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00022ac0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00022ad0: 2020 2020 2020 2020 2020 2020 7673 203d              vs =
-00022ae0: 2076 202a 2028 3130 2a2a 4476 2920 2023   v * (10**Dv)  #
-00022af0: 2077 6176 656c 656e 6774 6873 2073 6361   wavelengths sca
-00022b00: 6c65 640d 0a20 2020 2020 2020 2020 2020  led..           
-00022b10: 2020 2020 2020 2020 2020 2020 2055 4d52               UMR
-00022b20: 5b64 5d20 3d20 7365 6c66 2e4c 202f 206e  [d] = self.L / n
-00022b30: 702e 6763 642e 7265 6475 6365 285b 696e  p.gcd.reduce([in
-00022b40: 7428 6929 2066 6f72 2069 2069 6e20 7673  t(i) for i in vs
-00022b50: 5d29 202f 2028 3130 2a2a 4476 290d 0a20  ]) / (10**Dv).. 
-00022b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b70: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-00022b80: 6572 2e64 6562 7567 2822 4578 7465 6e64  er.debug("Extend
-00022b90: 6564 2067 6364 2074 6f20 7261 7469 6f6e  ed gcd to ration
-00022ba0: 616c 206e 756d 6265 7273 2e22 290d 0a20  al numbers.").. 
-00022bb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00022bc0: 6c73 653a 2020 2320 6972 7261 7469 6f6e  lse:  # irration
-00022bd0: 616c 206e 756d 6265 7273 206f 7220 7261  al numbers or ra
-00022be0: 7469 6f6e 616c 206e 756d 6265 7273 2077  tional numbers w
-00022bf0: 6974 6820 6d6f 7265 2064 6967 6974 7320  ith more digits 
-00022c00: 7468 616e 2022 7072 6563 6973 696f 6e22  than "precision"
-00022c10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00022c20: 2020 2020 2020 2320 726f 756e 6420 616e        # round an
-00022c30: 6420 6578 7465 6e64 206c 636d 2074 6f20  d extend lcm to 
-00022c40: 7261 7469 6f6e 616c 206e 756d 6265 7273  rational numbers
-00022c50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00022c60: 2020 2020 2020 6c73 203d 206e 702e 726f        ls = np.ro
-00022c70: 756e 6428 6c20 2a20 3130 2a2a 7072 6563  und(l * 10**prec
-00022c80: 6973 696f 6e2c 2064 6563 696d 616c 733d  ision, decimals=
-00022c90: 7072 6563 6973 696f 6e29 2e61 7374 7970  precision).astyp
-00022ca0: 6528 2275 696e 7436 3422 290d 0a20 2020  e("uint64")..   
-00022cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022cc0: 2055 4d52 5b64 5d20 3d20 6e70 2e6c 636d   UMR[d] = np.lcm
-00022cd0: 2e72 6564 7563 6528 6c73 2920 2f20 3130  .reduce(ls) / 10
-00022ce0: 2a2a 7072 6563 6973 696f 6e0d 0a0d 0a20  **precision.... 
-00022cf0: 2020 2020 2020 2023 2073 656c 662e 5f55         # self._U
-00022d00: 4d52 203d 2066 6c6f 6174 286e 702e 6d69  MR = float(np.mi
-00022d10: 6e28 554d 5229 2920 2023 2063 6173 7420  n(UMR))  # cast 
-00022d20: 7479 7065 2066 726d 2022 6e75 6d70 792e  type frm "numpy.
-00022d30: 636f 7265 2e6d 756c 7469 6172 7261 792e  core.multiarray.
-00022d40: 7363 616c 6172 2220 746f 2022 696e 7422  scalar" to "int"
-00022d50: 206f 7220 2266 6c6f 6174 220d 0a0d 0a20   or "float".... 
-00022d60: 2020 2020 2020 2073 656c 662e 5f55 4d52         self._UMR
-00022d70: 203d 2055 4d52 0d0a 2020 2020 2020 2020   = UMR..        
-00022d80: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-00022d90: 6728 6622 7365 6c66 2e55 4d52 203d 207b  g(f"self.UMR = {
-00022da0: 7374 7228 7365 6c66 2e5f 554d 5229 7d22  str(self._UMR)}"
-00022db0: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
-00022dc0: 7365 6c66 2e5f 616d 6269 6775 6f75 733a  self._ambiguous:
-00022dd0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00022de0: 6c66 2e6c 6f67 6765 722e 7761 726e 696e  lf.logger.warnin
-00022df0: 6728 0d0a 2020 2020 2020 2020 2020 2020  g(..            
-00022e00: 2020 2020 2255 4d52 203c 2052 2e20 556e      "UMR < R. Un
-00022e10: 7772 6170 7069 6e67 2077 696c 6c20 6e6f  wrapping will no
-00022e20: 7420 6265 2073 7061 7469 616c 6c79 2069  t be spatially i
-00022e30: 6e64 6570 656e 6465 6e74 2061 6e64 206f  ndependent and o
-00022e40: 6e6c 7920 7969 656c 6420 6120 7265 6c61  nly yield a rela
-00022e50: 7469 7665 2070 6861 7365 206d 6170 2e22  tive phase map."
-00022e60: 0d0a 2020 2020 2020 2020 2020 2020 290d  ..            ).
-00022e70: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
-00022e80: 6e20 7365 6c66 2e5f 554d 520d 0a0d 0a20  n self._UMR.... 
-00022e90: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-00022ea0: 2020 6465 6620 6574 6128 7365 6c66 2920    def eta(self) 
-00022eb0: 2d3e 2066 6c6f 6174 3a0d 0a20 2020 2020  -> float:..     
-00022ec0: 2020 2022 2222 436f 6469 6e67 2065 6666     """Coding eff
-00022ed0: 6963 6965 6e63 792e 2222 220d 0a20 2020  iciency."""..   
-00022ee0: 2020 2020 2065 7461 203d 2073 656c 662e       eta = self.
-00022ef0: 5220 2f20 7365 6c66 2e55 4d52 0d0a 2020  R / self.UMR..  
-00022f00: 2020 2020 2020 6574 615b 7365 6c66 2e55        eta[self.U
-00022f10: 4d52 203c 2073 656c 662e 525d 203d 2030  MR < self.R] = 0
-00022f20: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00022f30: 2065 7461 0d0a 0d0a 2020 2020 4070 726f   eta....    @pro
-00022f40: 7065 7274 790d 0a20 2020 2064 6566 2075  perty..    def u
-00022f50: 6928 7365 6c66 2920 2d3e 2066 6c6f 6174  i(self) -> float
-00022f60: 3a0d 0a20 2020 2020 2020 2022 2222 496e  :..        """In
-00022f70: 7465 6e73 6974 7920 6e6f 6973 652e 2222  tensity noise.""
-00022f80: 220d 0a20 2020 2020 2020 2071 7561 6e74  "..        quant
-00022f90: 203d 2030 2069 6620 7365 6c66 2e64 6172   = 0 if self.dar
-00022fa0: 6b20 3e20 3020 656c 7365 2073 656c 662e  k > 0 else self.
-00022fb0: 7175 616e 740d 0a20 2020 2020 2020 2075  quant..        u
-00022fc0: 6920 3d20 6e70 2e73 7172 7428 7365 6c66  i = np.sqrt(self
-00022fd0: 2e67 6169 6e2a 2a32 202a 2073 656c 662e  .gain**2 * self.
-00022fe0: 6461 726b 2a2a 3220 2b20 7175 616e 742a  dark**2 + quant*
-00022ff0: 2a32 202b 2073 656c 662e 7368 6f74 2a2a  *2 + self.shot**
-00023000: 3229 0d0a 2020 2020 2020 2020 7265 7475  2)..        retu
-00023010: 726e 2075 690d 0a0d 0a20 2020 2040 7072  rn ui....    @pr
-00023020: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-00023030: 7570 6928 7365 6c66 2920 2d3e 2066 6c6f  upi(self) -> flo
-00023040: 6174 3a0d 0a20 2020 2020 2020 2022 2222  at:..        """
-00023050: 5068 6173 6520 756e 6365 7274 6169 6e74  Phase uncertaint
-00023060: 792e 0d0a 2020 2020 2020 2020 5b75 7069  y...        [upi
-00023070: 5d20 3d20 7261 6422 2222 0d0a 2020 2020  ] = rad"""..    
-00023080: 2020 2020 4220 3d20 7365 6c66 2e42 202a      B = self.B *
-00023090: 2073 656c 662e 4d54 4628 7365 6c66 2e5f   self.MTF(self._
-000230a0: 7629 0d0a 2020 2020 2020 2020 534e 5220  v)..        SNR 
-000230b0: 3d20 4220 2f20 7365 6c66 2e75 690d 0a20  = B / self.ui.. 
-000230c0: 2020 2020 2020 2075 7069 203d 206e 702e         upi = np.
-000230d0: 7371 7274 2832 2920 2f20 6e70 2e73 7172  sqrt(2) / np.sqr
-000230e0: 7428 7365 6c66 2e4d 2920 2f20 6e70 2e73  t(self.M) / np.s
-000230f0: 7172 7428 7365 6c66 2e5f 4e29 202f 2053  qrt(self._N) / S
-00023100: 4e52 2020 2320 6c6f 6361 6c20 7068 6173  NR  # local phas
-00023110: 6520 756e 6365 7274 6169 6e74 6965 730d  e uncertainties.
-00023120: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00023130: 7570 690d 0a0d 0a20 2020 2040 7072 6f70  upi....    @prop
-00023140: 6572 7479 0d0a 2020 2020 6465 6620 7528  erty..    def u(
-00023150: 7365 6c66 2920 2d3e 206e 702e 6e64 6172  self) -> np.ndar
-00023160: 7261 793a 0d0a 2020 2020 2020 2020 2222  ray:..        ""
-00023170: 2255 6e63 6572 7461 696e 7479 206f 6620  "Uncertainty of 
-00023180: 6d65 6173 7572 656d 656e 7420 2873 7461  measurement (sta
-00023190: 6e64 6172 6420 6465 7669 6174 696f 6e29  ndard deviation)
-000231a0: 2e0d 0a20 2020 2020 2020 205b 755d 203d  ...        [u] =
-000231b0: 2070 782e 0d0a 0d0a 2020 2020 2020 2020   px.....        
-000231c0: 4974 2069 7320 6261 7365 6420 6f6e 2074  It is based on t
-000231d0: 6865 2070 6861 7365 206e 6f69 7365 206d  he phase noise m
-000231e0: 6f64 656c 0d0a 2020 2020 2020 2020 616e  odel..        an
-000231f0: 6420 7072 6f70 6167 6174 6564 2074 6872  d propagated thr
-00023200: 6f75 6768 2074 6865 2075 6e77 7261 7070  ough the unwrapp
-00023210: 696e 6720 7072 6f63 6573 7320 616e 6420  ing process and 
-00023220: 7468 6520 7068 6173 6520 6675 7369 6f6e  the phase fusion
-00023230: 2e22 2222 0d0a 0d0a 2020 2020 2020 2020  ."""....        
-00023240: 7570 696e 203d 2073 656c 662e 7570 6920  upin = self.upi 
-00023250: 2f20 2832 202a 206e 702e 7069 2920 2023  / (2 * np.pi)  #
-00023260: 206e 6f72 6d61 6c69 7a65 6420 6c6f 6361   normalized loca
-00023270: 6c20 7068 6173 6520 756e 6365 7274 6169  l phase uncertai
-00023280: 6e74 6965 730d 0a20 2020 2020 2020 2075  nties..        u
-00023290: 7869 203d 2075 7069 6e20 2a20 7365 6c66  xi = upin * self
-000232a0: 2e5f 6c20 2023 206c 6f63 616c 2070 6f73  ._l  # local pos
-000232b0: 6974 696f 6e61 6c20 756e 6365 7274 6169  itional uncertai
-000232c0: 6e74 6965 730d 0a20 2020 2020 2020 2075  nties..        u
-000232d0: 7820 3d20 6e70 2e73 7172 7428 3120 2f20  x = np.sqrt(1 / 
-000232e0: 6e70 2e73 756d 2831 202f 2075 7869 2a2a  np.sum(1 / uxi**
-000232f0: 322c 2061 7869 733d 3129 2920 2023 2067  2, axis=1))  # g
-00023300: 6c6f 6261 6c20 706f 7369 7469 6f6e 616c  lobal positional
-00023310: 2075 6e63 6572 7461 696e 7479 2028 6279   uncertainty (by
-00023320: 2069 6e76 6572 7365 2076 6172 6961 6e63   inverse varianc
-00023330: 6520 7765 6967 6874 696e 6729 0d0a 2020  e weighting)..  
-00023340: 2020 2020 2020 2320 746f 646f 3a20 6661        # todo: fa
-00023350: 6374 6f72 206f 7574 204c 203f 210d 0a20  ctor out L ?!.. 
-00023360: 2020 2020 2020 2072 6574 7572 6e20 7578         return ux
-00023370: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-00023380: 790d 0a20 2020 2064 6566 2053 4e52 2873  y..    def SNR(s
-00023390: 656c 6629 3a0d 0a20 2020 2020 2020 2022  elf):..        "
-000233a0: 2222 5369 676e 616c 2d74 6f2d 6e6f 6973  ""Signal-to-nois
-000233b0: 6520 7261 7469 6f20 6f66 2074 6865 2070  e ratio of the p
-000233c0: 6861 7365 2073 6869 6674 2063 6f64 696e  hase shift codin
-000233d0: 672e 0d0a 0d0a 2020 2020 2020 2020 4974  g.....        It
-000233e0: 2069 7320 6120 6d61 7375 7265 206f 6620   is a masure of 
-000233f0: 686f 7720 6d61 6e79 2070 6f69 6e74 7320  how many points 
-00023400: 6361 6e20 6265 2064 6973 7469 6e67 7569  can be distingui
-00023410: 7368 6564 2077 6974 6869 6e20 7468 6520  shed within the 
-00023420: 7363 7265 656e 206c 656e 6774 6820 5b30  screen length [0
-00023430: 2c20 5229 0d0a 2020 2020 2020 2020 2222  , R)..        ""
-00023440: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-00023450: 6e20 7365 6c66 2e52 202f 2073 656c 662e  n self.R / self.
-00023460: 750d 0a0d 0a20 2020 2040 7072 6f70 6572  u....    @proper
-00023470: 7479 0d0a 2020 2020 6465 6620 534e 5264  ty..    def SNRd
-00023480: 4228 7365 6c66 293a 0d0a 2020 2020 2020  B(self):..      
-00023490: 2020 2222 2253 6967 6e61 6c2d 746f 2d6e    """Signal-to-n
-000234a0: 6f69 7365 2072 6174 696f 2e0d 0a20 2020  oise ratio...   
-000234b0: 2020 2020 205b 534e 5264 425d 203d 2064       [SNRdB] = d
-000234c0: 422e 2222 220d 0a20 2020 2020 2020 2072  B."""..        r
-000234d0: 6574 7572 6e20 3230 202a 206e 702e 6c6f  eturn 20 * np.lo
-000234e0: 6731 3028 7365 6c66 2e53 4e52 290d 0a0d  g10(self.SNR)...
-000234f0: 0a20 2020 2040 7072 6f70 6572 7479 0d0a  .    @property..
-00023500: 2020 2020 6465 6620 4452 2873 656c 6629      def DR(self)
-00023510: 202d 3e20 666c 6f61 743a 0d0a 2020 2020   -> float:..    
-00023520: 2020 2020 2222 2244 796e 616d 6963 2072      """Dynamic r
-00023530: 616e 6765 206f 6620 7468 6520 7068 6173  ange of the phas
-00023540: 6520 7368 6966 7420 636f 6469 6e67 2e0d  e shift coding..
-00023550: 0a0d 0a20 2020 2020 2020 2049 7420 6973  ...        It is
-00023560: 2061 206d 6561 7375 7265 206f 6620 686f   a measure of ho
-00023570: 7720 6d61 6e79 2070 6f69 6e74 7320 6361  w many points ca
-00023580: 6e20 6265 2064 6973 7469 6e67 7569 7368  n be distinguish
-00023590: 6564 2077 6974 6869 6e20 7468 6520 756e  ed within the un
-000235a0: 616d 6269 6775 6f75 736d 6561 7375 7265  ambiguousmeasure
-000235b0: 6d65 6e74 2072 616e 6765 205b 302c 2055  ment range [0, U
-000235c0: 4d52 292e 0d0a 2020 2020 2020 2020 2222  MR)...        ""
-000235d0: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
-000235e0: 6e20 7365 6c66 2e55 4d52 202f 2073 656c  n self.UMR / sel
-000235f0: 662e 750d 0a0d 0a20 2020 2040 7072 6f70  f.u....    @prop
-00023600: 6572 7479 0d0a 2020 2020 6465 6620 4452  erty..    def DR
-00023610: 6442 2873 656c 6629 202d 3e20 666c 6f61  dB(self) -> floa
-00023620: 743a 0d0a 2020 2020 2020 2020 2222 2244  t:..        """D
-00023630: 796e 616d 6963 2072 616e 6765 2e20 5b44  ynamic range. [D
-00023640: 5264 425d 203d 2064 422e 2222 220d 0a20  RdB] = dB.""".. 
-00023650: 2020 2020 2020 2072 6574 7572 6e20 3230         return 20
-00023660: 202a 206e 702e 6c6f 6731 3028 7365 6c66   * np.log10(self
-00023670: 2e44 5229 0d0a 0d0a 2020 2020 4070 726f  .DR)....    @pro
-00023680: 7065 7274 790d 0a20 2020 2064 6566 2070  perty..    def p
-00023690: 6172 616d 7328 7365 6c66 2920 2d3e 2064  arams(self) -> d
-000236a0: 6963 743a 0d0a 2020 2020 2020 2020 2222  ict:..        ""
-000236b0: 2242 6173 6520 7061 7261 6d65 7465 7273  "Base parameters
-000236c0: 2072 6571 7569 7265 6420 666f 7220 656e   required for en
-000236d0: 2d20 2620 6465 636f 6469 6e67 2066 7269  - & decoding fri
-000236e0: 6e67 6520 7061 7474 6572 6e73 2e0d 0a0d  nge patterns....
-000236f0: 0a20 2020 2020 2020 2054 6869 7320 636f  .        This co
-00023700: 6e74 6169 6e73 2061 6c6c 2070 726f 7065  ntains all prope
-00023710: 7274 7920 6f62 6a65 6374 7320 6f66 2074  rty objects of t
-00023720: 6865 2063 6c61 7373 2077 6869 6368 2068  he class which h
-00023730: 6176 6520 6120 7365 7474 6572 206d 6574  ave a setter met
-00023740: 686f 642c 0d0a 2020 2020 2020 2020 692e  hod,..        i.
-00023750: 652e 2061 7265 2028 7573 7561 6c6c 7929  e. are (usually)
-00023760: 206e 6f74 2064 6572 6976 6564 2066 726f   not derived fro
-00023770: 6d20 6f74 6865 7273 2e0d 0a20 2020 2020  m others...     
-00023780: 2020 2022 2222 0d0a 0d0a 2020 2020 2020     """....      
-00023790: 2020 7061 7261 6d73 203d 207b 7d0d 0a20    params = {}.. 
-000237a0: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
-000237b0: 736f 7274 6564 2864 6972 2873 656c 6629  sorted(dir(self)
-000237c0: 293a 2020 2320 736f 7274 6564 2829 2065  ):  # sorted() e
-000237d0: 6e73 7572 6573 2073 6574 7469 6e67 2070  nsures setting p
-000237e0: 6172 616d 7320 696e 2074 6865 2072 6967  arams in the rig
-000237f0: 6874 206f 7264 6572 2069 6e20 7468 6520  ht order in the 
-00023800: 7365 7474 6572 206d 6574 686f 640d 0a20  setter method.. 
-00023810: 2020 2020 2020 2020 2020 2069 6620 7020             if p 
-00023820: 213d 2022 7061 7261 6d73 223a 0d0a 2020  != "params":..  
-00023830: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00023840: 2069 7369 6e73 7461 6e63 6528 6765 7461   isinstance(geta
-00023850: 7474 7228 7479 7065 2873 656c 6629 2c20  ttr(type(self), 
-00023860: 702c 204e 6f6e 6529 2c20 7072 6f70 6572  p, None), proper
-00023870: 7479 2920 616e 6420 6765 7461 7474 7228  ty) and getattr(
-00023880: 7479 7065 2873 656c 6629 2c20 702c 204e  type(self), p, N
-00023890: 6f6e 6529 2e66 7365 7420 6973 206e 6f74  one).fset is not
-000238a0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-000238b0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-000238c0: 7369 6e73 7461 6e63 6528 6765 7461 7474  sinstance(getatt
-000238d0: 7228 7365 6c66 2c20 702c 204e 6f6e 6529  r(self, p, None)
-000238e0: 2c20 6e70 2e6e 6461 7272 6179 293a 0d0a  , np.ndarray):..
-000238f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023900: 2020 2020 2020 2020 7061 7261 6d73 5b70          params[p
-00023910: 5d20 3d20 6765 7461 7474 7228 7365 6c66  ] = getattr(self
-00023920: 2c20 702c 204e 6f6e 6529 2e74 6f6c 6973  , p, None).tolis
-00023930: 7428 290d 0a20 2020 2020 2020 2020 2020  t()..           
-00023940: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00023950: 696e 7374 616e 6365 2867 6574 6174 7472  instance(getattr
-00023960: 2873 656c 662c 2070 2c20 4e6f 6e65 292c  (self, p, None),
-00023970: 206e 702e 6474 7970 6529 3a0d 0a20 2020   np.dtype):..   
-00023980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023990: 2020 2020 2070 6172 616d 735b 705d 203d       params[p] =
-000239a0: 2073 7472 2867 6574 6174 7472 2873 656c   str(getattr(sel
-000239b0: 662c 2070 2c20 4e6f 6e65 2929 0d0a 2020  f, p, None))..  
-000239c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239d0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-000239e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239f0: 2070 6172 616d 735b 705d 203d 2067 6574   params[p] = get
-00023a00: 6174 7472 2873 656c 662c 2070 2c20 4e6f  attr(self, p, No
-00023a10: 6e65 290d 0a20 2020 2020 2020 2072 6574  ne)..        ret
-00023a20: 7572 6e20 7061 7261 6d73 0d0a 0d0a 2020  urn params....  
-00023a30: 2020 4070 6172 616d 732e 7365 7474 6572    @params.setter
-00023a40: 0d0a 2020 2020 6465 6620 7061 7261 6d73  ..    def params
-00023a50: 2873 656c 662c 2070 6172 616d 733a 2064  (self, params: d
-00023a60: 6963 7420 3d20 7b7d 293a 0d0a 2020 2020  ict = {}):..    
-00023a70: 2020 2020 2320 6974 6572 6174 696e 6720      # iterating 
-00023a80: 7365 6c66 2e70 6172 616d 7320 656e 7375  self.params ensu
-00023a90: 7265 7320 7468 6174 206f 6e6c 7920 7072  res that only pr
-00023aa0: 6f70 6572 6965 7320 7769 7468 2061 2073  operies with a s
-00023ab0: 6574 7465 7220 6d65 7468 6f64 2061 7265  etter method are
-00023ac0: 2073 6574 0d0a 2020 2020 2020 2020 666f   set..        fo
-00023ad0: 7220 6b2c 2076 2069 6e20 7365 6c66 2e70  r k, v in self.p
-00023ae0: 6172 616d 732e 636f 7079 2829 2e69 7465  arams.copy().ite
-00023af0: 6d73 2829 3a0d 0a20 2020 2020 2020 2020  ms():..         
-00023b00: 2020 2069 6620 6b20 696e 2070 6172 616d     if k in param
-00023b10: 7320 616e 6420 6b20 213d 2022 5422 3a0d  s and k != "T":.
-00023b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023b30: 2073 6574 6174 7472 2873 656c 662c 206b   setattr(self, k
-00023b40: 2c20 7061 7261 6d73 5b6b 5d29 0d0a 0d0a  , params[k])....
-00023b50: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
-00023b60: 2069 6e20 7365 6c66 2e70 6172 616d 732e   in self.params.
-00023b70: 6974 656d 7328 293a 0d0a 2020 2020 2020  items():..      
-00023b80: 2020 2020 2020 6966 206b 2069 6e20 7061        if k in pa
-00023b90: 7261 6d73 3a0d 0a20 2020 2020 2020 2020  rams:..         
-00023ba0: 2020 2020 2020 2069 6620 6b20 696e 2022         if k in "
-00023bb0: 4e6c 7666 2220 616e 6420 6e70 2e61 7272  Nlvf" and np.arr
-00023bc0: 6179 2876 292e 6e64 696d 2021 3d20 6e70  ay(v).ndim != np
-00023bd0: 2e61 7272 6179 2870 6172 616d 735b 6b5d  .array(params[k]
-00023be0: 292e 6e64 696d 3a0d 0a20 2020 2020 2020  ).ndim:..       
-00023bf0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00023c00: 6e6f 7420 6e70 2e61 7272 6179 5f65 7175  not np.array_equ
-00023c10: 616c 2876 2c20 7061 7261 6d73 5b6b 5d5b  al(v, params[k][
-00023c20: 305d 293a 0d0a 2020 2020 2020 2020 2020  0]):..          
-00023c30: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00023c40: 6c66 2e6c 6f67 6765 722e 7761 726e 696e  lf.logger.warnin
-00023c50: 6728 0d0a 2020 2020 2020 2020 2020 2020  g(..            
-00023c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c70: 6622 277b 6b7d 2720 676f 7420 6f76 6572  f"'{k}' got over
-00023c80: 7772 6974 7465 6e20 6279 2069 6e74 6572  written by inter
-00023c90: 6465 7065 6e64 656e 6369 6573 2e20 4368  dependencies. Ch
-00023ca0: 6f6f 7365 2063 6f6e 7369 7374 656e 7420  oose consistent 
-00023cb0: 7061 7261 6d65 7465 7220 7365 742e 220d  parameter set.".
-00023cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023cd0: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
-00023ce0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00023cf0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00023d00: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
-00023d10: 2e61 7272 6179 5f65 7175 616c 2876 2c20  .array_equal(v, 
-00023d20: 7061 7261 6d73 5b6b 5d29 3a0d 0a20 2020  params[k]):..   
-00023d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d40: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-00023d50: 2e77 6172 6e69 6e67 280d 0a20 2020 2020  .warning(..     
-00023d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d70: 2020 2020 2020 2066 2227 7b6b 7d27 2067         f"'{k}' g
-00023d80: 6f74 206f 7665 7277 7269 7474 656e 2062  ot overwritten b
-00023d90: 7920 696e 7465 7264 6570 656e 6465 6e63  y interdependenc
-00023da0: 6965 732e 2043 686f 6f73 6520 636f 6e73  ies. Choose cons
-00023db0: 6973 7465 6e74 2070 6172 616d 6574 6572  istent parameter
-00023dc0: 2073 6574 2e22 0d0a 2020 2020 2020 2020   set."..        
-00023dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023de0: 290d 0a0d 0a20 2020 2074 7970 6573 203d  )....    types =
-00023df0: 2064 6963 7428 736f 7274 6564 285f 5f69   dict(sorted(__i
-00023e00: 6e69 745f 5f2e 5f5f 616e 6e6f 7461 7469  nit__.__annotati
-00023e10: 6f6e 735f 5f2e 6974 656d 7328 2929 290d  ons__.items())).
-00023e20: 0a20 2020 2022 2222 5479 7065 7320 6f66  .    """Types of
-00023e30: 2027 7061 7261 6d73 2720 7661 6c75 6573   'params' values
-00023e40: 2e22 2222 0d0a 0d0a 2020 2020 6465 6661  ."""....    defa
-00023e50: 756c 7473 203d 2064 6963 7428 736f 7274  ults = dict(sort
-00023e60: 6564 285f 5f69 6e69 745f 5f2e 5f5f 6b77  ed(__init__.__kw
-00023e70: 6465 6661 756c 7473 5f5f 2e69 7465 6d73  defaults__.items
-00023e80: 2829 2929 0d0a 2020 2020 2222 2244 6566  ()))..    """Def
-00023e90: 6175 6c74 2076 616c 7565 7320 666f 7220  ault values for 
-00023ea0: 6070 6172 616d 7360 2e22 2222 0d0a 0d0a  `params`."""....
-00023eb0: 2020 2020 676c 6f73 7361 7279 203d 207b      glossary = {
-00023ec0: 6b3a 2076 2e5f 5f64 6f63 5f5f 2066 6f72  k: v.__doc__ for
-00023ed0: 206b 2c20 7620 696e 2073 6f72 7465 6428   k, v in sorted(
-00023ee0: 7661 7273 2829 2e69 7465 6d73 2829 2920  vars().items()) 
-00023ef0: 6966 206e 6f74 206b 2e73 7461 7274 7377  if not k.startsw
-00023f00: 6974 6828 225f 2229 2061 6e64 2069 7369  ith("_") and isi
-00023f10: 6e73 7461 6e63 6528 762c 2070 726f 7065  nstance(v, prope
-00023f20: 7274 7929 7d0d 0a20 2020 2022 2222 476c  rty)}..    """Gl
-00023f30: 6f73 7361 7279 2e22 2222 0d0a 2020 2020  ossary."""..    
-00023f40: 2320 616e 6420 762e 5f5f 646f 635f 5f0d  # and v.__doc__.
-00023f50: 0a0d 0a20 2020 2023 2072 6573 7472 6963  ...    # restric
-00023f60: 7420 696e 7374 616e 6365 2061 7474 7269  t instance attri
-00023f70: 6275 7465 7320 746f 2074 6865 206f 6e65  butes to the one
-00023f80: 7320 6c69 7374 6564 2068 6572 650d 0a20  s listed here.. 
-00023f90: 2020 2023 2028 636f 6d6d 656e 6420 7468     # (commend th
-00023fa0: 6520 6e65 7874 206c 696e 6520 6f75 7420  e next line out 
-00023fb0: 746f 2070 7265 7665 6e74 2074 6869 7329  to prevent this)
-00023fc0: 0d0a 2020 2020 5f5f 736c 6f74 735f 5f20  ..    __slots__ 
-00023fd0: 3d20 7475 706c 6528 225f 2220 2b20 6b20  = tuple("_" + k 
-00023fe0: 666f 7220 6b20 696e 2064 6566 6175 6c74  for k in default
-00023ff0: 732e 6b65 7973 2829 2069 6620 6b20 6e6f  s.keys() if k no
-00024000: 7420 696e 2022 484d 546c 4142 2229 202b  t in "HMTlAB") +
-00024010: 2028 226c 6f67 6765 7222 2c20 225f 554d   ("logger", "_UM
-00024020: 5222 2c20 225f 7422 290d 0a0d 0a20 2020  R", "_t")....   
-00024030: 2023 2063 6f6e 7469 6e75 696e 6720 7468   # continuing th
-00024040: 6520 636c 6173 7320 646f 6373 7472 696e  e class docstrin
-00024050: 6720 666f 6c6c 6f77 696e 6720 7468 6520  g following the 
-00024060: 4e75 6d50 7920 7374 796c 6520 6775 6964  NumPy style guid
-00024070: 653a 0d0a 2020 2020 2320 6874 7470 733a  e:..    # https:
-00024080: 2f2f 6e75 6d70 7964 6f63 2e72 6561 6474  //numpydoc.readt
-00024090: 6865 646f 6373 2e69 6f2f 656e 2f6c 6174  hedocs.io/en/lat
-000240a0: 6573 742f 666f 726d 6174 2e68 746d 6c23  est/format.html#
-000240b0: 636c 6173 732d 646f 6373 7472 696e 670d  class-docstring.
-000240c0: 0a20 2020 205f 5f64 6f63 5f5f 202b 3d20  .    __doc__ += 
-000240d0: 225c 6e5c 6e50 6172 616d 6574 6572 735c  "\n\nParameters\
-000240e0: 6e2d 2d2d 2d2d 2d2d 2d2d 2d22 0d0a 2020  n----------"..  
-000240f0: 2020 5f5f 646f 635f 5f20 2b3d 2022 5c6e    __doc__ += "\n
-00024100: 2a61 7267 7320 3a20 6974 6572 6162 6c65  *args : iterable
-00024110: 5c6e 2020 2020 4e6f 6e2d 6b65 7977 6f72  \n    Non-keywor
-00024120: 6420 6172 6775 6d65 6e74 7320 6172 6520  d arguments are 
-00024130: 6578 706c 6963 6974 6c79 2064 6973 6361  explicitly disca
-00024140: 7264 6564 2e22 0d0a 2020 2020 5f5f 646f  rded."..    __do
-00024150: 635f 5f20 2b3d 2022 5c6e 2020 2020 4f6e  c__ += "\n    On
-00024160: 6c79 206b 6579 776f 7264 2061 7267 756d  ly keyword argum
-00024170: 656e 7473 2061 7265 2063 6f6e 7369 6465  ents are conside
-00024180: 7265 642e 220d 0a20 2020 2066 6f72 205f  red."..    for _
-00024190: 5f6b 2c20 5f5f 7620 696e 205f 5f69 6e69  _k, __v in __ini
-000241a0: 745f 5f2e 5f5f 6b77 6465 6661 756c 7473  t__.__kwdefaults
-000241b0: 5f5f 2e69 7465 6d73 2829 3a0d 0a20 2020  __.items():..   
-000241c0: 2020 2020 2023 2064 6f20 7468 6973 2069       # do this i
-000241d0: 6e20 666f 7220 6c6f 6f70 2069 6e73 7465  n for loop inste
-000241e0: 6164 206f 6620 6c69 7374 2063 6f6d 7072  ad of list compr
-000241f0: 6568 656e 7369 6f6e 2c0d 0a20 2020 2020  ehension,..     
-00024200: 2020 2023 2062 6563 6175 7365 2066 6f72     # because for
-00024210: 2074 6865 206c 6174 7465 722c 206e 616d   the latter, nam
-00024220: 6573 2069 6e20 636c 6173 7320 7363 6f70  es in class scop
-00024230: 6520 6172 6520 6e6f 7420 6163 6365 7373  e are not access
-00024240: 6962 6c65 0d0a 2020 2020 2020 2020 5f5f  ible..        __
-00024250: 646f 635f 5f20 2b3d 2066 225c 6e7b 5f5f  doc__ += f"\n{__
-00024260: 6b7d 203a 207b 7479 7065 735b 5f5f 6b5d  k} : {types[__k]
-00024270: 7d2c 2064 6566 6175 6c74 203d 207b 5f5f  }, default = {__
-00024280: 767d 5c6e 2020 2020 7b67 6c6f 7373 6172  v}\n    {glossar
-00024290: 795b 5f5f 6b5d 2e73 706c 6974 6c69 6e65  y[__k].splitline
-000242a0: 7328 295b 305d 7d22 0d0a 2020 2020 2320  s()[0]}"..    # 
-000242b0: 5f5f 646f 635f 5f20 2b3d 2022 5c6e 5c6e  __doc__ += "\n\n
-000242c0: 4174 7472 6962 7574 6573 5c6e 2d2d 2d2d  Attributes\n----
-000242d0: 2d2d 2d2d 2d2d 220d 0a20 2020 2023 2066  ------"..    # f
-000242e0: 6f72 205f 5f6b 2c20 5f5f 7620 696e 2073  or __k, __v in s
-000242f0: 6f72 7465 6428 7661 7273 2829 2e69 7465  orted(vars().ite
-00024300: 6d73 2829 293a 0d0a 2020 2020 2320 2020  ms()):..    #   
-00024310: 2020 2320 646f 2074 6869 7320 696e 2066    # do this in f
-00024320: 6f72 206c 6f6f 7020 696e 7374 6561 6420  or loop instead 
-00024330: 6f66 206c 6973 7420 636f 6d70 7265 6865  of list comprehe
-00024340: 6e73 696f 6e2c 0d0a 2020 2020 2320 2020  nsion,..    #   
-00024350: 2020 2320 6265 6361 7573 6520 666f 7220    # because for 
-00024360: 7468 6520 6c61 7474 6572 2c20 6e61 6d65  the latter, name
-00024370: 7320 696e 2063 6c61 7373 2073 636f 7065  s in class scope
-00024380: 2061 7265 206e 6f74 2061 6363 6573 7369   are not accessi
-00024390: 626c 650d 0a20 2020 2023 2020 2020 2069  ble..    #     i
-000243a0: 6620 5f5f 6b20 6e6f 7420 696e 2064 6566  f __k not in def
-000243b0: 6175 6c74 7320 616e 6420 6e6f 7420 5f5f  aults and not __
-000243c0: 6b2e 7374 6172 7473 7769 7468 2822 5f22  k.startswith("_"
-000243d0: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
-000243e0: 285f 5f76 2c20 7072 6f70 6572 7479 293a  (__v, property):
-000243f0: 0d0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
-00024400: 5f5f 646f 635f 5f20 2b3d 2066 225c 6e7b  __doc__ += f"\n{
-00024410: 5f5f 6b7d 203a 207b 7479 7065 285f 5f76  __k} : {type(__v
-00024420: 297d 220d 0a20 2020 2023 205f 5f64 6f63  )}"..    # __doc
-00024430: 5f5f 202b 3d20 225c 6e74 7970 6573 203a  __ += "\ntypes :
-00024440: 2064 6963 7422 0d0a 2020 2020 2320 5f5f   dict"..    # __
-00024450: 646f 635f 5f20 2b3d 2022 5c6e 6465 6661  doc__ += "\ndefa
-00024460: 756c 7473 203a 2064 6963 7422 0d0a 2020  ults : dict"..  
-00024470: 2020 2320 5f5f 646f 635f 5f20 2b3d 2022    # __doc__ += "
-00024480: 5c6e 676c 6f73 7361 7279 203a 2064 6963  \nglossary : dic
-00024490: 7422 0d0a 2020 2020 2320 5f5f 646f 635f  t"..    # __doc_
-000244a0: 5f20 2b3d 2066 225c 6e6c 6f67 6765 7220  _ += f"\nlogger 
-000244b0: 3a20 4c6f 6767 6572 2c20 6465 6661 756c  : Logger, defaul
-000244c0: 7420 3d20 6c6f 6767 696e 672e 6765 744c  t = logging.getL
-000244d0: 6f67 6765 7228 7b5f 5f71 7561 6c6e 616d  ogger({__qualnam
-000244e0: 655f 5f7d 2922 0d0a 2020 2020 2320 5f5f  e__})"..    # __
-000244f0: 646f 635f 5f20 2b3d 2022 5c6e 2020 2020  doc__ += "\n    
-00024500: 6874 7470 733a 2f2f 646f 6373 2e70 7974  https://docs.pyt
-00024510: 686f 6e2e 6f72 672f 332f 6c69 6272 6172  hon.org/3/librar
-00024520: 792f 6c6f 6767 696e 672e 6874 6d6c 236c  y/logging.html#l
-00024530: 6f67 6765 722d 6f62 6a65 6374 7322 0d0a  ogger-objects"..
-00024540: 2020 2020 2320 5f5f 646f 635f 5f20 2b3d      # __doc__ +=
-00024550: 2022 5c6e 5c6e 4d65 7468 6f64 735c 6e2d   "\n\nMethods\n-
-00024560: 2d2d 2d2d 2d2d 220d 0a20 2020 2023 205f  ------"..    # _
-00024570: 5f64 6f63 5f5f 202b 3d20 6622 5c6e 656e  _doc__ += f"\nen
-00024580: 636f 6465 5c6e 2020 2020 7b65 6e63 6f64  code\n    {encod
-00024590: 652e 5f5f 646f 635f 5f2e 7370 6c69 746c  e.__doc__.splitl
-000245a0: 696e 6573 2829 5b30 5d7d 220d 0a20 2020  ines()[0]}"..   
-000245b0: 2023 205f 5f64 6f63 5f5f 202b 3d20 6622   # __doc__ += f"
-000245c0: 5c6e 6465 636f 6465 5c6e 2020 2020 7b64  \ndecode\n    {d
-000245d0: 6563 6f64 652e 5f5f 646f 635f 5f2e 7370  ecode.__doc__.sp
-000245e0: 6c69 746c 696e 6573 2829 5b30 5d7d 220d  litlines()[0]}".
-000245f0: 0a20 2020 2064 656c 205f 5f6b 2c20 5f5f  .    del __k, __
-00024600: 760d 0a                                  v..
+0001ccb0: 2070 6d61 7820 3d20 7379 6d70 792e 6e74   pmax = sympy.nt
+0001ccc0: 6865 6f72 792e 6765 6e65 7261 7465 2e6e  heory.generate.n
+0001ccd0: 6578 7470 7269 6d65 286e 2c20 6974 6820  extprime(n, ith 
+0001cce0: 2b20 3129 0d0a 2020 2020 2020 2020 2020  + 1)..          
+0001ccf0: 2020 2020 2020 2020 2020 7020 3d20 6e70            p = np
+0001cd00: 2e61 7272 6179 286c 6973 7428 7379 6d70  .array(list(symp
+0001cd10: 792e 6e74 6865 6f72 792e 6765 6e65 7261  y.ntheory.genera
+0001cd20: 7465 2e70 7269 6d65 7261 6e67 6528 6e2c  te.primerange(n,
+0001cd30: 2070 6d61 7820 2b20 3129 2929 5b3a 6974   pmax + 1)))[:it
+0001cd40: 685d 2020 2320 7072 696d 6573 0d0a 2020  h]  # primes..  
+0001cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd60: 2020 7020 3d20 5b70 5b2d 6920 2f2f 2032    p = [p[-i // 2
+0001cd70: 5d20 6966 2069 2025 2032 2065 6c73 6520  ] if i % 2 else 
+0001cd80: 705b 6920 2f2f 2032 5d20 666f 7220 6920  p[i // 2] for i 
+0001cd90: 696e 2072 616e 6765 286c 656e 2870 2929  in range(len(p))
+0001cda0: 5d20 2023 2072 6573 6f72 7420 7072 696d  ]  # resort prim
+0001cdb0: 6573 0d0a 2020 2020 2020 2020 2020 2020  es..            
+0001cdc0: 2020 2020 2020 2020 5f76 203d 206e 702e          _v = np.
+0001cdd0: 736f 7274 286e 702e 6172 7261 7928 702c  sort(np.array(p,
+0001cde0: 2066 6c6f 6174 292e 7265 7368 6170 6528   float).reshape(
+0001cdf0: 2873 656c 662e 442c 2073 656c 662e 4b29  (self.D, self.K)
+0001ce00: 292c 2061 7869 733d 3129 2020 2320 7265  ), axis=1)  # re
+0001ce10: 736f 7274 2070 7269 6d65 730d 0a20 2020  sort primes..   
+0001ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce30: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
+0001ce40: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+0001ce50: 2020 2020 2020 2020 2020 2066 2250 6572             f"Per
+0001ce60: 696f 6473 2077 6572 6520 6e6f 7420 636f  iods were not co
+0001ce70: 7072 696d 652e 2022 2066 2243 6861 6e67  prime. " f"Chang
+0001ce80: 696e 6720 7661 6c75 6573 2074 6f20 7b73  ing values to {s
+0001ce90: 7472 285f 762e 726f 756e 6428 3329 292e  tr(_v.round(3)).
+0001cea0: 7265 706c 6163 6528 6368 7228 3130 292c  replace(chr(10),
+0001ceb0: 2027 2c27 297d 2e22 0d0a 2020 2020 2020   ',')}."..      
+0001cec0: 2020 2020 2020 2020 2020 2020 2020 290d                ).
+0001ced0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+0001cee0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+0001cef0: 2020 2320 2020 2020 766d 6178 203d 2028    #     vmax = (
+0001cf00: 7365 6c66 2e5f 4e6d 6178 202d 2031 2920  self._Nmax - 1) 
+0001cf10: 2f20 3220 3e20 5f76 0d0a 2020 2020 2020  / 2 > _v..      
+0001cf20: 2020 2020 2020 2320 2020 2020 5f76 203d        #     _v =
+0001cf30: 206e 702e 6d69 6e69 6d75 6d28 5f76 2c20   np.minimum(_v, 
+0001cf40: 766d 6178 290d 0a0d 0a20 2020 2020 2020  vmax)....       
+0001cf50: 2069 6620 6e6f 7420 6e70 2e61 7272 6179   if not np.array
+0001cf60: 5f65 7175 616c 2873 656c 662e 5f76 2c20  _equal(self._v, 
+0001cf70: 5f76 293a 0d0a 2020 2020 2020 2020 2020  _v):..          
+0001cf80: 2020 7365 6c66 2e5f 7620 3d20 5f76 0d0a    self._v = _v..
+0001cf90: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001cfa0: 696e 672e 6465 6275 6728 6622 7365 6c66  ing.debug(f"self
+0001cfb0: 2e76 203d 207b 7374 7228 7365 6c66 2e5f  .v = {str(self._
+0001cfc0: 762e 726f 756e 6428 3329 292e 7265 706c  v.round(3)).repl
+0001cfd0: 6163 6528 6368 7228 3130 292c 2027 2c27  ace(chr(10), ','
+0001cfe0: 297d 2229 0d0a 2020 2020 2020 2020 2020  )}")..          
+0001cff0: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+0001d000: 6622 7365 6c66 2e6c 203d 207b 7374 7228  f"self.l = {str(
+0001d010: 7365 6c66 2e5f 6c2e 726f 756e 6428 3329  self._l.round(3)
+0001d020: 292e 7265 706c 6163 6528 6368 7228 3130  ).replace(chr(10
+0001d030: 292c 2027 2c27 297d 2229 0d0a 2020 2020  ), ',')}")..    
+0001d040: 2020 2020 2020 2020 7365 6c66 2e5f 554d          self._UM
+0001d050: 5220 3d20 4e6f 6e65 0d0a 2020 2020 2020  R = None..      
+0001d060: 2020 2020 2020 7365 6c66 2e44 2c20 7365        self.D, se
+0001d070: 6c66 2e4b 203d 2073 656c 662e 5f76 2e73  lf.K = self._v.s
+0001d080: 6861 7065 0d0a 2020 2020 2020 2020 2020  hape..          
+0001d090: 2020 7365 6c66 2e66 203d 2073 656c 662e    self.f = self.
+0001d0a0: 5f66 0d0a 0d0a 2020 2020 4070 726f 7065  _f....    @prope
+0001d0b0: 7274 790d 0a20 2020 2064 6566 205f 666d  rty..    def _fm
+0001d0c0: 6178 2873 656c 6629 3a0d 0a20 2020 2020  ax(self):..     
+0001d0d0: 2020 2022 2222 4d61 7869 6d75 6d20 7465     """Maximum te
+0001d0e0: 6d70 6f72 616c 2066 7265 7175 656e 6379  mporal frequency
+0001d0f0: 2028 6d61 7869 6d75 6d20 6e75 6d62 6572   (maximum number
+0001d100: 206f 6620 7065 7269 6f64 7320 746f 2073   of periods to s
+0001d110: 6869 6674 206f 7665 7229 2e22 2222 0d0a  hift over)."""..
+0001d120: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+0001d130: 696e 2828 7365 6c66 2e5f 4e6d 696e 202d  in((self._Nmin -
+0001d140: 2031 2920 2f20 322c 2073 656c 662e 766d   1) / 2, self.vm
+0001d150: 6178 2920 6966 2073 656c 662e 4644 4d20  ax) if self.FDM 
+0001d160: 616e 6420 7365 6c66 2e73 7461 7469 6320  and self.static 
+0001d170: 656c 7365 2028 7365 6c66 2e5f 4e6d 696e  else (self._Nmin
+0001d180: 202d 2031 2920 2f20 320d 0a0d 0a20 2020   - 1) / 2....   
+0001d190: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
+0001d1a0: 6465 6620 6628 7365 6c66 2920 2d3e 206e  def f(self) -> n
+0001d1b0: 702e 6e64 6172 7261 793a 0d0a 2020 2020  p.ndarray:..    
+0001d1c0: 2020 2020 2222 2254 656d 706f 7261 6c20      """Temporal 
+0001d1d0: 6672 6571 7565 6e63 7920 286e 756d 6265  frequency (numbe
+0001d1e0: 7220 6f66 2070 6572 696f 6473 2074 6f20  r of periods to 
+0001d1f0: 7368 6966 7420 6f76 6572 292e 2222 220d  shift over).""".
+0001d200: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001d210: 2e44 203d 3d20 3120 6f72 206c 656e 286e  .D == 1 or len(n
+0001d220: 702e 756e 6971 7565 2873 656c 662e 5f66  p.unique(self._f
+0001d230: 2c20 6178 6973 3d30 2929 203d 3d20 313a  , axis=0)) == 1:
+0001d240: 2020 2320 7365 7473 2069 6e20 6469 7265    # sets in dire
+0001d250: 6374 696f 6e73 2061 7265 2069 6465 6e74  ctions are ident
+0001d260: 6963 616c 0d0a 2020 2020 2020 2020 2020  ical..          
+0001d270: 2020 6620 3d20 7365 6c66 2e5f 665b 305d    f = self._f[0]
+0001d280: 2020 2320 3144 0d0a 2020 2020 2020 2020    # 1D..        
+0001d290: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+0001d2a0: 2020 2066 203d 2073 656c 662e 5f66 2020     f = self._f  
+0001d2b0: 2320 3244 0d0a 2020 2020 2020 2020 7265  # 2D..        re
+0001d2c0: 7475 726e 2066 0d0a 0d0a 2020 2020 4066  turn f....    @f
+0001d2d0: 2e73 6574 7465 720d 0a20 2020 2064 6566  .setter..    def
+0001d2e0: 2066 2873 656c 662c 2066 3a20 696e 7420   f(self, f: int 
+0001d2f0: 7c20 666c 6f61 7420 7c20 7475 706c 655b  | float | tuple[
+0001d300: 696e 7420 7c20 666c 6f61 745d 207c 206c  int | float] | l
+0001d310: 6973 745b 696e 7420 7c20 666c 6f61 745d  ist[int | float]
+0001d320: 207c 206e 702e 6e64 6172 7261 7920 7c20   | np.ndarray | 
+0001d330: 7374 7229 3a0d 0a20 2020 2020 2020 205f  str):..        _
+0001d340: 6620 3d20 6e70 2e61 7272 6179 2866 2c20  f = np.array(f, 
+0001d350: 666c 6f61 7429 2e63 6c69 7028 2d73 656c  float).clip(-sel
+0001d360: 662e 5f66 6d61 782c 2073 656c 662e 5f66  f._fmax, self._f
+0001d370: 6d61 7829 2020 2320 6d61 6b65 2061 7272  max)  # make arr
+0001d380: 6179 2c20 6361 7374 2074 6f20 6474 7970  ay, cast to dtyp
+0001d390: 652c 2063 6c69 700d 0a0d 0a20 2020 2020  e, clip....     
+0001d3a0: 2020 2069 6620 6e6f 7420 5f66 2e73 697a     if not _f.siz
+0001d3b0: 653a 2020 2320 656d 7074 7920 6172 7261  e:  # empty arra
+0001d3c0: 790d 0a20 2020 2020 2020 2020 2020 2072  y..            r
+0001d3d0: 6574 7572 6e0d 0a0d 0a20 2020 2020 2020  eturn....       
+0001d3e0: 205f 6620 3d20 7365 6c66 2e5f 7472 696d   _f = self._trim
+0001d3f0: 285f 6629 0d0a 0d0a 2020 2020 2020 2020  (_f)....        
+0001d400: 4420 3d20 6d69 6e28 5f66 2e73 6861 7065  D = min(_f.shape
+0001d410: 5b30 5d2c 2073 656c 662e 5f4e 2e73 6861  [0], self._N.sha
+0001d420: 7065 5b30 5d29 0d0a 2020 2020 2020 2020  pe[0])..        
+0001d430: 4b20 3d20 6d69 6e28 5f66 2e73 6861 7065  K = min(_f.shape
+0001d440: 5b31 5d2c 2073 656c 662e 5f4e 2e73 6861  [1], self._N.sha
+0001d450: 7065 5b31 5d29 0d0a 2020 2020 2020 2020  pe[1])..        
+0001d460: 6966 206e 702e 616e 7928 5f66 5b3a 442c  if np.any(_f[:D,
+0001d470: 203a 4b5d 2025 2073 656c 662e 5f4e 5b3a   :K] % self._N[:
+0001d480: 442c 203a 4b5d 203d 3d20 3029 3a0d 0a20  D, :K] == 0):.. 
+0001d490: 2020 2020 2020 2020 2020 2023 205f 6620             # _f 
+0001d4a0: 3d20 6e70 2e6f 6e65 7328 5f66 2e73 6861  = np.ones(_f.sha
+0001d4b0: 7065 290d 0a20 2020 2020 2020 2020 2020  pe)..           
+0001d4c0: 205f 665b 3a44 2c20 3a4b 5d5b 5f66 5b3a   _f[:D, :K][_f[:
+0001d4d0: 442c 203a 4b5d 2025 2073 656c 662e 5f4e  D, :K] % self._N
+0001d4e0: 5b3a 442c 203a 4b5d 203d 3d20 305d 203d  [:D, :K] == 0] =
+0001d4f0: 2031 0d0a 0d0a 2020 2020 2020 2020 6966   1....        if
+0001d500: 2073 656c 662e 4644 4d3a 0d0a 2020 2020   self.FDM:..    
+0001d510: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001d520: 7374 6174 6963 3a0d 0a20 2020 2020 2020  static:..       
+0001d530: 2020 2020 2020 2020 205f 6620 3d20 7365           _f = se
+0001d540: 6c66 2e5f 7620 2023 2070 6572 696f 6473  lf._v  # periods
+0001d550: 2074 6f20 7368 6966 7420 6f76 6572 203d   to shift over =
+0001d560: 206f 6e65 2066 756c 6c20 7265 766f 6c75   one full revolu
+0001d570: 7469 6f6e 0d0a 2020 2020 2020 2020 2020  tion..          
+0001d580: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+0001d590: 2020 2020 2020 2020 2069 6620 280d 0a20           if (.. 
+0001d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5b0: 2020 205f 662e 7368 6170 6520 213d 2028     _f.shape != (
+0001d5c0: 7365 6c66 2e44 2c20 7365 6c66 2e4b 290d  self.D, self.K).
+0001d5d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d5e0: 2020 2020 206f 7220 6e6f 7420 6e70 2e61       or not np.a
+0001d5f0: 6c6c 2869 2025 2031 203d 3d20 3020 666f  ll(i % 1 == 0 fo
+0001d600: 7220 6920 696e 205f 6629 0d0a 2020 2020  r i in _f)..    
+0001d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d620: 6f72 206c 656e 286e 702e 756e 6971 7565  or len(np.unique
+0001d630: 286e 702e 6162 7328 5f66 2929 2920 3c20  (np.abs(_f))) < 
+0001d640: 5f66 2e73 697a 650d 0a20 2020 2020 2020  _f.size..       
+0001d650: 2020 2020 2020 2020 2029 3a20 2023 2061           ):  # a
+0001d660: 7373 7572 6520 5f66 2061 7265 2069 6e74  ssure _f are int
+0001d670: 2061 6e64 2061 6273 6f6c 7574 6520 7661   and absolute va
+0001d680: 6c75 6573 206f 6620 5f66 2064 6966 6665  lues of _f diffe
+0001d690: 720d 0a20 2020 2020 2020 2020 2020 2020  r..             
+0001d6a0: 2020 2020 2020 205f 6620 3d20 6e70 2e61         _f = np.a
+0001d6b0: 7261 6e67 6528 312c 2073 656c 662e 4420  range(1, self.D 
+0001d6c0: 2a20 7365 6c66 2e4b 202b 2031 2c20 6474  * self.K + 1, dt
+0001d6d0: 7970 653d 666c 6f61 7429 2e72 6573 6861  ype=float).resha
+0001d6e0: 7065 2828 7365 6c66 2e44 2c20 7365 6c66  pe((self.D, self
+0001d6f0: 2e4b 2929 0d0a 0d0a 2020 2020 2020 2020  .K))....        
+0001d700: 6966 2030 206e 6f74 2069 6e20 5f66 2061  if 0 not in _f a
+0001d710: 6e64 206e 6f74 206e 702e 6172 7261 795f  nd not np.array_
+0001d720: 6571 7561 6c28 7365 6c66 2e5f 662c 205f  equal(self._f, _
+0001d730: 6629 3a0d 0a20 2020 2020 2020 2020 2020  f):..           
+0001d740: 2073 656c 662e 5f66 203d 205f 660d 0a20   self._f = _f.. 
+0001d750: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0001d760: 6e67 2e64 6562 7567 2866 2273 656c 662e  ng.debug(f"self.
+0001d770: 5f66 203d 207b 7374 7228 2873 656c 662e  _f = {str((self.
+0001d780: 5f66 202a 2028 2d31 2069 6620 7365 6c66  _f * (-1 if self
+0001d790: 2e72 6576 6572 7365 2065 6c73 6520 3129  .reverse else 1)
+0001d7a0: 292e 726f 756e 6428 3329 292e 7265 706c  ).round(3)).repl
+0001d7b0: 6163 6528 6368 7228 3130 292c 2027 2c27  ace(chr(10), ','
+0001d7c0: 297d 2229 0d0a 2020 2020 2020 2020 2020  )}")..          
+0001d7d0: 2020 7365 6c66 2e44 2c20 7365 6c66 2e4b    self.D, self.K
+0001d7e0: 203d 2073 656c 662e 5f66 2e73 6861 7065   = self._f.shape
+0001d7f0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0001d800: 6c66 2e4e 203d 2073 656c 662e 5f4e 2020  lf.N = self._N  
+0001d810: 2320 746f 646f 3a20 7265 6d6f 7665 2069  # todo: remove i
+0001d820: 6620 6672 6163 7469 6f6e 616c 2070 6572  f fractional per
+0001d830: 696f 6473 2069 7320 696d 706c 656d 656e  iods is implemen
+0001d840: 7465 642c 206c 6f67 2077 6172 6e69 6e67  ted, log warning
+0001d850: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+0001d860: 790d 0a20 2020 2064 6566 2070 3028 7365  y..    def p0(se
+0001d870: 6c66 2920 2d3e 2066 6c6f 6174 3a0d 0a20  lf) -> float:.. 
+0001d880: 2020 2020 2020 2022 2222 5068 6173 6520         """Phase 
+0001d890: 6f66 6673 6574 2077 6974 6869 6e20 696e  offset within in
+0001d8a0: 7465 7276 616c 2028 2d32 7069 2c20 2b32  terval (-2pi, +2
+0001d8b0: 7069 292e 0d0a 0d0a 2020 2020 2020 2020  pi).....        
+0001d8c0: 4974 2063 616e 2062 6520 7573 6564 2074  It can be used t
+0001d8d0: 6f20 652e 672e 206c 6574 2074 6865 2066  o e.g. let the f
+0001d8e0: 7269 6e67 6520 7061 7474 6572 6e73 2073  ringe patterns s
+0001d8f0: 7461 7274 2028 6174 2074 6865 206f 7269  tart (at the ori
+0001d900: 6769 6e29 2077 6974 6820 6120 6772 6179  gin) with a gray
+0001d910: 2076 616c 7565 206f 6620 7a65 726f 2e0d   value of zero..
+0001d920: 0a20 2020 2020 2020 2022 2222 0d0a 2020  .        """..  
+0001d930: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001d940: 662e 5f70 300d 0a0d 0a20 2020 2040 7030  f._p0....    @p0
+0001d950: 2e73 6574 7465 720d 0a20 2020 2064 6566  .setter..    def
+0001d960: 2070 3028 7365 6c66 2c20 7030 3a20 666c   p0(self, p0: fl
+0001d970: 6f61 7429 3a0d 0a20 2020 2020 2020 205f  oat):..        _
+0001d980: 7030 203d 2066 6c6f 6174 286e 702e 6162  p0 = float(np.ab
+0001d990: 7328 7030 2920 2520 2832 202a 206e 702e  s(p0) % (2 * np.
+0001d9a0: 7069 2920 2a20 6e70 2e73 6967 6e28 7030  pi) * np.sign(p0
+0001d9b0: 2929 0d0a 0d0a 2020 2020 2020 2020 6966  ))....        if
+0001d9c0: 2073 656c 662e 5f70 3020 213d 205f 7030   self._p0 != _p0
+0001d9d0: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
+0001d9e0: 656c 662e 5f70 3020 3d20 5f70 300d 0a20  elf._p0 = _p0.. 
+0001d9f0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0001da00: 6e67 2e64 6562 7567 2866 2273 656c 662e  ng.debug(f"self.
+0001da10: 5f70 3020 3d20 7b73 656c 662e 5f70 3020  _p0 = {self._p0 
+0001da20: 2f20 6e70 2e70 697d 2050 4922 290d 0a0d  / np.pi} PI")...
+0001da30: 0a20 2020 2040 7072 6f70 6572 7479 0d0a  .    @property..
+0001da40: 2020 2020 6465 6620 4276 2873 656c 6629      def Bv(self)
+0001da50: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
+0001da60: 0a20 2020 2020 2020 2022 2222 4d6f 6475  .        """Modu
+0001da70: 6c61 7469 6f6e 2061 7420 7370 6174 6961  lation at spatia
+0001da80: 6c20 6672 6571 7565 6e63 6965 7320 6076  l frequencies `v
+0001da90: 602e 0d0a 0d0a 2020 2020 2020 2020 5468  `.....        Th
+0001daa0: 6520 6d6f 6475 6c61 7469 6f6e 2076 616c  e modulation val
+0001dab0: 7565 7320 6172 6520 6465 7465 726d 696e  ues are determin
+0001dac0: 6564 2066 726f 6d20 6120 6d65 6173 7572  ed from a measur
+0001dad0: 656d 656e 742e 2222 220d 0a20 2020 2020  ement."""..     
+0001dae0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0001daf0: 4276 0d0a 0d0a 2020 2020 4042 762e 7365  Bv....    @Bv.se
+0001db00: 7474 6572 0d0a 2020 2020 6465 6620 4276  tter..    def Bv
+0001db10: 2873 656c 662c 2042 3a20 6e70 2e6e 6461  (self, B: np.nda
+0001db20: 7272 6179 293a 0d0a 2020 2020 2020 2020  rray):..        
+0001db30: 6966 2042 2069 7320 4e6f 6e65 3a0d 0a20  if B is None:.. 
+0001db40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001db50: 5f42 7620 3d20 4e6f 6e65 0d0a 2020 2020  _Bv = None..    
+0001db60: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0001db70: 6465 6275 6728 6622 7365 6c66 2e42 7620  debug(f"self.Bv 
+0001db80: 3d20 7b73 656c 662e 5f42 767d 2229 0d0a  = {self._Bv}")..
+0001db90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001dba0: 726e 0d0a 0d0a 2020 2020 2020 2020 5f42  rn....        _B
+0001dbb0: 203d 206e 702e 6172 7261 7928 6e70 2e6d   = np.array(np.m
+0001dbc0: 6178 696d 756d 2830 2c20 4229 2c20 666c  aximum(0, B), fl
+0001dbd0: 6f61 7429 0d0a 0d0a 2020 2020 2020 2020  oat)....        
+0001dbe0: 5f42 2e73 6861 7065 203d 2054 2c20 592c  _B.shape = T, Y,
+0001dbf0: 2058 2c20 4320 3d20 7673 6861 7065 285f   X, C = vshape(_
+0001dc00: 4229 2e73 6861 7065 0d0a 0d0a 2020 2020  B).shape....    
+0001dc10: 2020 2020 6173 7365 7274 2054 203d 3d20      assert T == 
+0001dc20: 7365 6c66 2e44 202a 2073 656c 662e 4b0d  self.D * self.K.
+0001dc30: 0a0d 0a20 2020 2020 2020 205f 4220 3d20  ...        _B = 
+0001dc40: 5f42 2e72 6573 6861 7065 2873 656c 662e  _B.reshape(self.
+0001dc50: 442c 2073 656c 662e 4b2c 2073 656c 662e  D, self.K, self.
+0001dc60: 592c 2073 656c 662e 582c 2073 656c 662e  Y, self.X, self.
+0001dc70: 4329 0d0a 0d0a 2020 2020 2020 2020 2320  C)....        # 
+0001dc80: 6669 6c74 6572 0d0a 2020 2020 2020 2020  filter..        
+0001dc90: 5f42 203d 206e 702e 6e61 6e6d 6564 6961  _B = np.nanmedia
+0001dca0: 6e28 5f42 2c20 6178 6973 3d2d 3129 2020  n(_B, axis=-1)  
+0001dcb0: 2320 6669 6c74 6572 2061 6c6f 6e67 2063  # filter along c
+0001dcc0: 6f6c 6f72 2061 7869 730d 0a20 2020 2020  olor axis..     
+0001dcd0: 2020 2023 205f 4220 3d20 6e70 2e6e 616e     # _B = np.nan
+0001dce0: 6d65 6469 616e 285f 422c 2061 7869 733d  median(_B, axis=
+0001dcf0: 2832 2c20 3329 2920 2023 2066 696c 7465  (2, 3))  # filte
+0001dd00: 7220 616c 6f6e 6720 7370 6174 6961 6c20  r along spatial 
+0001dd10: 6178 6573 0d0a 2020 2020 2020 2020 5f42  axes..        _B
+0001dd20: 203d 206e 702e 6e61 6e71 7561 6e74 696c   = np.nanquantil
+0001dd30: 6528 5f42 2c20 302e 392c 2061 7869 733d  e(_B, 0.9, axis=
+0001dd40: 2832 2c20 3329 2920 2023 2066 696c 7465  (2, 3))  # filte
+0001dd50: 7220 616c 6f6e 6720 7370 6174 6961 6c20  r along spatial 
+0001dd60: 6178 6573 0d0a 0d0a 2020 2020 2020 2020  axes....        
+0001dd70: 2320 206e 6f72 6d61 6c69 7a65 2028 6f6e  #  normalize (on
+0001dd80: 6c79 2072 656c 6174 6976 6520 7765 6967  ly relative weig
+0001dd90: 6874 7320 6172 6520 696d 706f 7274 616e  hts are importan
+0001dda0: 7429 0d0a 2020 2020 2020 2020 426d 6178  t)..        Bmax
+0001ddb0: 203d 206e 702e 6969 6e66 6f28 5f42 2e64   = np.iinfo(_B.d
+0001ddc0: 7479 7065 292e 6d61 7820 6966 205f 422e  type).max if _B.
+0001ddd0: 6474 7970 652e 6b69 6e64 2069 6e20 2275  dtype.kind in "u
+0001dde0: 6922 2065 6c73 6520 310d 0a20 2020 2020  i" else 1..     
+0001ddf0: 2020 205f 4220 2f3d 2042 6d61 780d 0a20     _B /= Bmax.. 
+0001de00: 2020 2020 2020 205f 425b 6e70 2e69 736e         _B[np.isn
+0001de10: 616e 285f 4229 5d20 3d20 300d 0a0d 0a20  an(_B)] = 0.... 
+0001de20: 2020 2020 2020 205f 4276 203d 206e 702e         _Bv = np.
+0001de30: 7673 7461 636b 285f 422c 2073 656c 662e  vstack(_B, self.
+0001de40: 5f76 290d 0a0d 0a20 2020 2020 2020 2069  _v)....        i
+0001de50: 6620 6e6f 7420 6e70 2e61 7272 6179 5f65  f not np.array_e
+0001de60: 7175 616c 2873 656c 662e 5f42 762c 205f  qual(self._Bv, _
+0001de70: 4276 293a 0d0a 2020 2020 2020 2020 2020  Bv):..          
+0001de80: 2020 7365 6c66 2e5f 4276 203d 205f 420d    self._Bv = _B.
+0001de90: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001dea0: 6769 6e67 2e64 6562 7567 2866 2273 656c  ging.debug(f"sel
+0001deb0: 662e 4276 203d 207b 7374 7228 7365 6c66  f.Bv = {str(self
+0001dec0: 2e42 762e 726f 756e 6428 3329 292e 7265  .Bv.round(3)).re
+0001ded0: 706c 6163 6528 6368 7228 3130 292c 2027  place(chr(10), '
+0001dee0: 2c27 297d 2229 0d0a 0d0a 2020 2020 4070  ,')}")....    @p
+0001def0: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
+0001df00: 205f 6d6f 6e6f 6368 726f 6d65 2873 656c   _monochrome(sel
+0001df10: 6629 202d 3e20 626f 6f6c 3a0d 0a20 2020  f) -> bool:..   
+0001df20: 2020 2020 2022 2222 5472 7565 2069 6620       """True if 
+0001df30: 616c 6c20 6875 6573 2061 7265 206d 6f6e  all hues are mon
+0001df40: 6f63 6872 6f6d 6174 6963 2c20 692e 652e  ochromatic, i.e.
+0001df50: 2074 6865 2052 4742 2076 616c 7565 7320   the RGB values 
+0001df60: 6172 6520 6964 656e 7469 6361 6c20 666f  are identical fo
+0001df70: 7220 6561 6368 2068 7565 2e22 2222 0d0a  r each hue."""..
+0001df80: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0001df90: 6c6c 286c 656e 2873 6574 2868 2929 203d  ll(len(set(h)) =
+0001dfa0: 3d20 3120 666f 7220 6820 696e 2073 656c  = 1 for h in sel
+0001dfb0: 662e 6829 0d0a 0d0a 2020 2020 4070 726f  f.h)....    @pro
+0001dfc0: 7065 7274 790d 0a20 2020 2064 6566 205f  perty..    def _
+0001dfd0: 616d 6269 6775 6f75 7328 7365 6c66 2920  ambiguous(self) 
+0001dfe0: 2d3e 2062 6f6f 6c3a 0d0a 2020 2020 2020  -> bool:..      
+0001dff0: 2020 2222 2254 7275 6520 6966 2075 6e61    """True if una
+0001e000: 6d62 6967 756f 7573 206d 6561 7375 6d65  mbiguous measume
+0001e010: 6e74 2072 616e 6765 2069 7320 6c61 7267  nt range is larg
+0001e020: 6572 2074 6861 6e20 7468 6520 7363 7265  er than the scre
+0001e030: 656e 206c 656e 6774 682e 2222 220d 0a20  en length.""".. 
+0001e040: 2020 2020 2020 2072 6574 7572 6e20 626f         return bo
+0001e050: 6f6c 286e 702e 616e 7928 7365 6c66 2e55  ol(np.any(self.U
+0001e060: 4d52 203c 2073 656c 662e 5220 2a20 7365  MR < self.R * se
+0001e070: 6c66 2e61 6c70 6861 2929 0d0a 0d0a 2020  lf.alpha))....  
+0001e080: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+0001e090: 2064 6566 2069 6e64 6578 696e 6728 7365   def indexing(se
+0001e0a0: 6c66 2920 2d3e 2073 7472 3a0d 0a20 2020  lf) -> str:..   
+0001e0b0: 2020 2020 2022 2222 496e 6465 7869 6e67       """Indexing
+0001e0c0: 2063 6f6e 7665 6e74 696f 6e2e 0d0a 0d0a   convention.....
+0001e0d0: 2020 2020 2020 2020 4361 7274 6573 6961          Cartesia
+0001e0e0: 6e20 696e 6465 7869 6e67 2060 7879 6020  n indexing `xy` 
+0001e0f0: 2874 6865 2064 6566 6175 6c74 2920 7769  (the default) wi
+0001e100: 6c6c 2069 6e64 6578 2074 6865 2072 6f77  ll index the row
+0001e110: 2066 6972 7374 2c0d 0a20 2020 2020 2020   first,..       
+0001e120: 2077 6869 6c65 206d 6174 7269 7820 696e   while matrix in
+0001e130: 6465 7869 6e67 2060 696a 6020 7769 6c6c  dexing `ij` will
+0001e140: 2069 6e64 6578 2074 6865 2063 6f6c 756d   index the colum
+0001e150: 2066 6972 7374 2e0d 0a20 2020 2020 2020   first...       
+0001e160: 2022 2222 0d0a 2020 2020 2020 2020 7265   """..        re
+0001e170: 7475 726e 2073 656c 662e 5f69 6e64 6578  turn self._index
+0001e180: 696e 670d 0a0d 0a20 2020 2040 696e 6465  ing....    @inde
+0001e190: 7869 6e67 2e73 6574 7465 720d 0a20 2020  xing.setter..   
+0001e1a0: 2064 6566 2069 6e64 6578 696e 6728 7365   def indexing(se
+0001e1b0: 6c66 2c20 696e 6465 7869 6e67 293a 0d0a  lf, indexing):..
+0001e1c0: 2020 2020 2020 2020 5f69 6e64 6578 696e          _indexin
+0001e1d0: 6720 3d20 7374 7228 696e 6465 7869 6e67  g = str(indexing
+0001e1e0: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
+0001e1f0: 7365 6c66 2e5f 696e 6465 7869 6e67 2021  self._indexing !
+0001e200: 3d20 5f69 6e64 6578 696e 6720 616e 6420  = _indexing and 
+0001e210: 5f69 6e64 6578 696e 6720 696e 2073 656c  _indexing in sel
+0001e220: 662e 5f69 6e64 6578 696e 6773 3a0d 0a20  f._indexings:.. 
+0001e230: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001e240: 5f69 6e64 6578 696e 6720 3d20 5f69 6e64  _indexing = _ind
+0001e250: 6578 696e 670d 0a20 2020 2020 2020 2020  exing..         
+0001e260: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+0001e270: 2866 227b 7365 6c66 2e5f 696e 6465 7869  (f"{self._indexi
+0001e280: 6e67 203d 207d 2229 0d0a 2020 2020 2020  ng = }")..      
+0001e290: 2020 2020 2020 7365 6c66 2e5f 554d 5220        self._UMR 
+0001e2a0: 3d20 4e6f 6e65 0d0a 0d0a 2020 2020 4070  = None....    @p
+0001e2b0: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
+0001e2c0: 2072 6576 6572 7365 2873 656c 6629 202d   reverse(self) -
+0001e2d0: 3e20 626f 6f6c 3a0d 0a20 2020 2020 2020  > bool:..       
+0001e2e0: 2022 2222 466c 6167 2066 6f72 2073 6869   """Flag for shi
+0001e2f0: 6674 696e 6720 6672 696e 6765 7320 696e  fting fringes in
+0001e300: 2072 6576 6572 7365 2064 6972 6563 7469   reverse directi
+0001e310: 6f6e 2e22 2222 0d0a 2020 2020 2020 2020  on."""..        
+0001e320: 7265 7475 726e 2073 656c 662e 5f72 6576  return self._rev
+0001e330: 6572 7365 0d0a 0d0a 2020 2020 4072 6576  erse....    @rev
+0001e340: 6572 7365 2e73 6574 7465 720d 0a20 2020  erse.setter..   
+0001e350: 2064 6566 2072 6576 6572 7365 2873 656c   def reverse(sel
+0001e360: 662c 2072 6576 6572 7365 3a20 626f 6f6c  f, reverse: bool
+0001e370: 293a 0d0a 2020 2020 2020 2020 5f72 6576  ):..        _rev
+0001e380: 6572 7365 203d 2062 6f6f 6c28 7265 7665  erse = bool(reve
+0001e390: 7273 6529 0d0a 0d0a 2020 2020 2020 2020  rse)....        
+0001e3a0: 6966 2073 656c 662e 5f72 6576 6572 7365  if self._reverse
+0001e3b0: 2021 3d20 5f72 6576 6572 7365 3a0d 0a20   != _reverse:.. 
+0001e3c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001e3d0: 5f72 6576 6572 7365 203d 205f 7265 7665  _reverse = _reve
+0001e3e0: 7273 650d 0a20 2020 2020 2020 2020 2020  rse..           
+0001e3f0: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+0001e400: 227b 7365 6c66 2e5f 7265 7665 7273 6520  "{self._reverse 
+0001e410: 3d20 7d22 290d 0a20 2020 2020 2020 2020  = }")..         
+0001e420: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+0001e430: 2866 2273 656c 662e 5f66 203d 207b 7374  (f"self._f = {st
+0001e440: 7228 2873 656c 662e 5f66 202a 2028 2d31  r((self._f * (-1
+0001e450: 2069 6620 7365 6c66 2e72 6576 6572 7365   if self.reverse
+0001e460: 2065 6c73 6520 3129 292e 726f 756e 6428   else 1)).round(
+0001e470: 3329 292e 7265 706c 6163 6528 6368 7228  3)).replace(chr(
+0001e480: 3130 292c 2027 2c27 297d 2229 0d0a 0d0a  10), ',')}")....
+0001e490: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+0001e4a0: 2020 2064 6566 2076 6572 626f 7365 2873     def verbose(s
+0001e4b0: 656c 6629 202d 3e20 626f 6f6c 3a0d 0a20  elf) -> bool:.. 
+0001e4c0: 2020 2020 2020 2022 2222 466c 6167 2066         """Flag f
+0001e4d0: 6f72 2061 6464 6974 696f 6e61 6c6c 7920  or additionally 
+0001e4e0: 7265 7475 726e 696e 6720 696e 7465 726d  returning interm
+0001e4f0: 6564 6961 7465 2061 6e64 2076 6572 626f  ediate and verbo
+0001e500: 7365 2072 6573 756c 7473 3a5c 6e0d 0a20  se results:\n.. 
+0001e510: 2020 2020 2020 202d 2070 6861 7365 206d         - phase m
+0001e520: 6170 735c 6e0d 0a20 2020 2020 2020 202d  aps\n..        -
+0001e530: 2072 6573 6964 7561 6c73 5c6e 0d0a 2020   residuals\n..  
+0001e540: 2020 2020 2020 2d20 6672 696e 6765 206f        - fringe o
+0001e550: 7264 6572 735c 6e0d 0a20 2020 2020 2020  rders\n..       
+0001e560: 202d 2076 6973 6962 696c 6974 795c 6e0d   - visibility\n.
+0001e570: 0a20 2020 2020 2020 202d 2065 7870 6f73  .        - expos
+0001e580: 7572 650d 0a20 2020 2020 2020 2022 2222  ure..        """
+0001e590: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001e5a0: 2073 656c 662e 5f76 6572 626f 7365 0d0a   self._verbose..
+0001e5b0: 0d0a 2020 2020 4076 6572 626f 7365 2e73  ..    @verbose.s
+0001e5c0: 6574 7465 720d 0a20 2020 2064 6566 2076  etter..    def v
+0001e5d0: 6572 626f 7365 2873 656c 662c 2076 6572  erbose(self, ver
+0001e5e0: 626f 7365 3a20 626f 6f6c 293a 0d0a 2020  bose: bool):..  
+0001e5f0: 2020 2020 2020 5f76 6572 626f 7365 203d        _verbose =
+0001e600: 2062 6f6f 6c28 7665 7262 6f73 6529 0d0a   bool(verbose)..
+0001e610: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0001e620: 662e 5f76 6572 626f 7365 2021 3d20 5f76  f._verbose != _v
+0001e630: 6572 626f 7365 3a0d 0a20 2020 2020 2020  erbose:..       
+0001e640: 2020 2020 2073 656c 662e 5f76 6572 626f       self._verbo
+0001e650: 7365 203d 205f 7665 7262 6f73 650d 0a20  se = _verbose.. 
+0001e660: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0001e670: 6e67 2e64 6562 7567 2866 227b 7365 6c66  ng.debug(f"{self
+0001e680: 2e5f 7665 7262 6f73 6520 3d20 7d22 290d  ._verbose = }").
+0001e690: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+0001e6a0: 0d0a 2020 2020 6465 6620 6d6f 6465 2873  ..    def mode(s
+0001e6b0: 656c 6629 202d 3e20 7374 723a 0d0a 2020  elf) -> str:..  
+0001e6c0: 2020 2020 2020 2222 224d 6f64 6520 666f        """Mode fo
+0001e6d0: 7220 7265 6d61 7070 696e 672e 0d0a 0d0a  r remapping.....
+0001e6e0: 2020 2020 2020 2020 5468 6520 666f 6c6c          The foll
+0001e6f0: 6f77 696e 6720 7661 6c75 6573 2063 616e  owing values can
+0001e700: 2062 6520 7365 743a 5c6e 0d0a 2020 2020   be set:\n..    
+0001e710: 2020 2020 2d20 2766 6173 7427 5c6e 0d0a      - 'fast'\n..
+0001e720: 2020 2020 2020 2020 2d20 2770 7265 6369          - 'preci
+0001e730: 7365 270d 0a20 2020 2020 2020 2022 2222  se'..        """
+0001e740: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001e750: 2073 656c 662e 5f6d 6f64 650d 0a0d 0a20   self._mode.... 
+0001e760: 2020 2040 6d6f 6465 2e73 6574 7465 720d     @mode.setter.
+0001e770: 0a20 2020 2064 6566 206d 6f64 6528 7365  .    def mode(se
+0001e780: 6c66 2c20 6d6f 6465 3a20 7374 7229 3a0d  lf, mode: str):.
+0001e790: 0a20 2020 2020 2020 205f 6d6f 6465 203d  .        _mode =
+0001e7a0: 2073 7472 286d 6f64 6529 0d0a 0d0a 2020   str(mode)....  
+0001e7b0: 2020 2020 2020 6966 2073 656c 662e 5f6d        if self._m
+0001e7c0: 6f64 6520 213d 205f 6d6f 6465 2061 6e64  ode != _mode and
+0001e7d0: 205f 6d6f 6465 2069 6e20 7365 6c66 2e5f   _mode in self._
+0001e7e0: 6d6f 6465 733a 0d0a 2020 2020 2020 2020  modes:..        
+0001e7f0: 2020 2020 7365 6c66 2e5f 6d6f 6465 203d      self._mode =
+0001e800: 205f 6d6f 6465 0d0a 2020 2020 2020 2020   _mode..        
+0001e810: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+0001e820: 6728 6622 7b73 656c 662e 5f6d 6f64 6520  g(f"{self._mode 
+0001e830: 3d20 7d22 290d 0a0d 0a20 2020 2040 7072  = }")....    @pr
+0001e840: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
+0001e850: 7577 7228 7365 6c66 2920 2d3e 2073 7472  uwr(self) -> str
+0001e860: 3a0d 0a20 2020 2020 2020 2022 2222 5068  :..        """Ph
+0001e870: 6173 6520 756e 7772 6170 7069 6e67 206d  ase unwrapping m
+0001e880: 6574 686f 642e 2222 220d 0a0d 0a20 2020  ethod."""....   
+0001e890: 2020 2020 2069 6620 7365 6c66 2e4b 203d       if self.K =
+0001e8a0: 3d20 3120 616e 6420 6e70 2e61 6c6c 2873  = 1 and np.all(s
+0001e8b0: 656c 662e 5f4e 203d 3d20 3129 2061 6e64  elf._N == 1) and
+0001e8c0: 2073 656c 662e 6772 6964 2069 6e20 7365   self.grid in se
+0001e8d0: 6c66 2e5f 6772 6964 735b 3a32 5d3a 0d0a  lf._grids[:2]:..
+0001e8e0: 2020 2020 2020 2020 2020 2020 2320 746f              # to
+0001e8f0: 646f 3a20 7620 3e3e 2031 2c20 692e 652e  do: v >> 1, i.e.
+0001e900: 206c 207e 2038 0d0a 2020 2020 2020 2020   l ~ 8..        
+0001e910: 2020 2020 7577 7220 3d20 2246 544d 2220      uwr = "FTM" 
+0001e920: 2023 2046 6f75 7269 6572 2d74 7261 6e73   # Fourier-trans
+0001e930: 666f 726d 206d 6574 686f 640d 0a20 2020  form method..   
+0001e940: 2020 2020 2065 6c69 6620 7365 6c66 2e4b       elif self.K
+0001e950: 203d 3d20 6e70 2e61 6c6c 2873 656c 662e   == np.all(self.
+0001e960: 7620 3c3d 2031 293a 0d0a 2020 2020 2020  v <= 1):..      
+0001e970: 2020 2020 2020 7577 7220 3d20 226e 6f6e        uwr = "non
+0001e980: 6522 0d0a 2020 2020 2020 2020 656c 6966  e"..        elif
+0001e990: 2073 656c 662e 5f61 6d62 6967 756f 7573   self._ambiguous
+0001e9a0: 3a0d 0a20 2020 2020 2020 2020 2020 2075  :..            u
+0001e9b0: 7772 203d 2022 7370 6174 6961 6c22 0d0a  wr = "spatial"..
+0001e9c0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+0001e9d0: 2020 2020 2020 2020 2020 2075 7772 203d             uwr =
+0001e9e0: 2022 7465 6d70 6f72 616c 220d 0a0d 0a20   "temporal".... 
+0001e9f0: 2020 2020 2020 2072 6574 7572 6e20 7577         return uw
+0001ea00: 720d 0a0d 0a20 2020 2040 7072 6f70 6572  r....    @proper
+0001ea10: 7479 0d0a 2020 2020 6465 6620 6761 6d6d  ty..    def gamm
+0001ea20: 6128 7365 6c66 2920 2d3e 2066 6c6f 6174  a(self) -> float
+0001ea30: 3a0d 0a20 2020 2020 2020 2022 2222 4761  :..        """Ga
+0001ea40: 6d6d 6120 636f 7272 6563 7469 6f6e 2066  mma correction f
+0001ea50: 6163 746f 7220 7573 6564 2074 6f20 636f  actor used to co
+0001ea60: 6d70 656e 7361 7465 206e 6f6e 6c69 6e65  mpensate nonline
+0001ea70: 6172 6974 6965 7320 6f66 2074 6865 2064  arities of the d
+0001ea80: 6973 706c 6179 2072 6573 706f 6e73 6520  isplay response 
+0001ea90: 6375 7276 652e 2222 220d 0a20 2020 2020  curve."""..     
+0001eaa0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0001eab0: 6761 6d6d 610d 0a0d 0a20 2020 2040 6761  gamma....    @ga
+0001eac0: 6d6d 612e 7365 7474 6572 0d0a 2020 2020  mma.setter..    
+0001ead0: 6465 6620 6761 6d6d 6128 7365 6c66 2c20  def gamma(self, 
+0001eae0: 6761 6d6d 613a 2066 6c6f 6174 293a 0d0a  gamma: float):..
+0001eaf0: 2020 2020 2020 2020 5f67 616d 6d61 203d          _gamma =
+0001eb00: 2066 6c6f 6174 286d 696e 286d 6178 2830   float(min(max(0
+0001eb10: 2c20 6761 6d6d 6129 2c20 7365 6c66 2e5f  , gamma), self._
+0001eb20: 6761 6d6d 616d 6178 2929 0d0a 0d0a 2020  gammamax))....  
+0001eb30: 2020 2020 2020 6966 2073 656c 662e 5f67        if self._g
+0001eb40: 616d 6d61 2021 3d20 5f67 616d 6d61 2061  amma != _gamma a
+0001eb50: 6e64 205f 6761 6d6d 6120 213d 2030 3a0d  nd _gamma != 0:.
+0001eb60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001eb70: 662e 5f67 616d 6d61 203d 205f 6761 6d6d  f._gamma = _gamm
+0001eb80: 610d 0a20 2020 2020 2020 2020 2020 206c  a..            l
+0001eb90: 6f67 6769 6e67 2e64 6562 7567 2866 227b  ogging.debug(f"{
+0001eba0: 7365 6c66 2e5f 6761 6d6d 6120 3d20 7d22  self._gamma = }"
+0001ebb0: 290d 0a0d 0a20 2020 2040 7072 6f70 6572  )....    @proper
+0001ebc0: 7479 0d0a 2020 2020 6465 6620 7368 6170  ty..    def shap
+0001ebd0: 6528 7365 6c66 2920 2d3e 2074 7570 6c65  e(self) -> tuple
+0001ebe0: 5b69 6e74 5d3a 0d0a 2020 2020 2020 2020  [int]:..        
+0001ebf0: 2222 2253 6861 7065 206f 6620 6672 696e  """Shape of frin
+0001ec00: 6765 2070 6174 7465 726e 2073 6571 7565  ge pattern seque
+0001ec10: 6e63 6520 696e 2076 6964 656f 2073 6861  nce in video sha
+0001ec20: 7065 2028 6672 616d 6573 2c20 6865 6967  pe (frames, heig
+0001ec30: 6874 2c20 7769 7468 2c20 636f 6c6f 7220  ht, with, color 
+0001ec40: 6368 616e 6e65 6c73 292e 2222 220d 0a20  channels).""".. 
+0001ec50: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0001ec60: 6c66 2e54 2c20 7365 6c66 2e59 2c20 7365  lf.T, self.Y, se
+0001ec70: 6c66 2e58 2c20 7365 6c66 2e43 0d0a 0d0a  lf.X, self.C....
+0001ec80: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+0001ec90: 2020 2064 6566 2073 697a 6528 7365 6c66     def size(self
+0001eca0: 2920 2d3e 206e 702e 7569 6e74 3634 3a0d  ) -> np.uint64:.
+0001ecb0: 0a20 2020 2020 2020 2022 2222 4e75 6d62  .        """Numb
+0001ecc0: 6572 206f 6620 7069 7865 6c73 206f 6620  er of pixels of 
+0001ecd0: 6672 696e 6765 2070 6174 7465 726e 2073  fringe pattern s
+0001ece0: 6571 7565 6e63 6520 2866 7261 6d65 7320  equence (frames 
+0001ecf0: 2a20 6865 6967 6874 202a 2077 6964 7468  * height * width
+0001ed00: 202a 2063 6f6c 6f72 2063 6861 6e6e 656c   * color channel
+0001ed10: 7329 2e22 2222 0d0a 2020 2020 2020 2020  s)."""..        
+0001ed20: 7265 7475 726e 2066 6c6f 6174 286e 702e  return float(np.
+0001ed30: 7072 6f64 2873 656c 662e 7368 6170 652c  prod(self.shape,
+0001ed40: 2064 7479 7065 3d6e 702e 7569 6e74 3634   dtype=np.uint64
+0001ed50: 2929 2020 2320 7573 696e 6720 7569 6e74  ))  # using uint
+0001ed60: 3634 2070 7265 7665 6e74 7320 696e 7465  64 prevents inte
+0001ed70: 6765 7220 6f76 6572 666c 6f77 0d0a 0d0a  ger overflow....
+0001ed80: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+0001ed90: 2020 2064 6566 206e 6279 7465 7328 7365     def nbytes(se
+0001eda0: 6c66 2920 2d3e 2069 6e74 3a0d 0a20 2020  lf) -> int:..   
+0001edb0: 2020 2020 2022 2222 546f 7461 6c20 6279       """Total by
+0001edc0: 7465 7320 636f 6e73 756d 6564 2062 7920  tes consumed by 
+0001edd0: 6672 696e 6765 2070 6174 7465 726e 2073  fringe pattern s
+0001ede0: 6571 7565 6e63 652e 0d0a 0d0a 2020 2020  equence.....    
+0001edf0: 2020 2020 446f 6573 206e 6f74 2069 6e63      Does not inc
+0001ee00: 6c75 6465 206d 656d 6f72 7920 636f 6e73  lude memory cons
+0001ee10: 756d 6564 2062 7920 6e6f 6e2d 656c 656d  umed by non-elem
+0001ee20: 656e 7420 6174 7472 6962 7574 6573 206f  ent attributes o
+0001ee30: 6620 7468 6520 6172 7261 7920 6f62 6a65  f the array obje
+0001ee40: 6374 2e0d 0a20 2020 2020 2020 2022 2222  ct...        """
+0001ee50: 0d0a 2020 2020 2020 2020 2320 7265 7475  ..        # retu
+0001ee60: 726e 2073 656c 662e 7369 7a65 202a 2073  rn self.size * s
+0001ee70: 656c 662e 6474 7970 652e 6974 656d 7369  elf.dtype.itemsi
+0001ee80: 7a65 0d0a 2020 2020 2020 2020 7265 7475  ze..        retu
+0001ee90: 726e 2073 656c 662e 5420 2a20 7365 6c66  rn self.T * self
+0001eea0: 2e59 202a 2073 656c 662e 5820 2a20 7365  .Y * self.X * se
+0001eeb0: 6c66 2e43 202a 2073 656c 662e 6474 7970  lf.C * self.dtyp
+0001eec0: 652e 6974 656d 7369 7a65 0d0a 0d0a 2020  e.itemsize....  
+0001eed0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+0001eee0: 2064 6566 2064 7479 7065 2873 656c 6629   def dtype(self)
+0001eef0: 202d 3e20 6e70 2e64 7479 7065 3a0d 0a20   -> np.dtype:.. 
+0001ef00: 2020 2020 2020 2022 2222 4461 7461 2074         """Data t
+0001ef10: 7970 652e 0d0a 0d0a 2020 2020 2020 2020  ype.....        
+0001ef20: 5468 6520 666f 6c6c 6f77 696e 6720 7661  The following va
+0001ef30: 6c75 6573 2063 616e 2062 6520 7365 743a  lues can be set:
+0001ef40: 5c6e 0d0a 2020 2020 2020 2020 2d20 2762  \n..        - 'b
+0001ef50: 6f6f 6c27 5c6e 0d0a 2020 2020 2020 2020  ool'\n..        
+0001ef60: 2d20 2775 696e 7438 275c 6e0d 0a20 2020  - 'uint8'\n..   
+0001ef70: 2020 2020 202d 2027 7569 6e74 3136 275c       - 'uint16'\
+0001ef80: 6e0d 0a20 2020 2020 2020 202d 2027 666c  n..        - 'fl
+0001ef90: 6f61 7433 3227 5c6e 0d0a 2020 2020 2020  oat32'\n..      
+0001efa0: 2020 2d20 2766 6c6f 6174 3634 275c 6e0d    - 'float64'\n.
+0001efb0: 0a20 2020 2020 2020 2022 2222 0d0a 2020  .        """..  
+0001efc0: 2020 2020 2020 7265 7475 726e 206e 702e        return np.
+0001efd0: 6474 7970 6528 7365 6c66 2e5f 6474 7970  dtype(self._dtyp
+0001efe0: 6529 2020 2320 7468 6973 2069 7320 6120  e)  # this is a 
+0001eff0: 686f 7466 6978 2066 6f72 2073 6574 7469  hotfix for setti
+0001f000: 6e67 205f 6474 7970 6520 6469 7265 6374  ng _dtype direct
+0001f010: 6c79 2061 7320 6120 7374 7220 696e 2069  ly as a str in i
+0001f020: 6e69 740d 0a0d 0a20 2020 2040 6474 7970  nit....    @dtyp
+0001f030: 652e 7365 7474 6572 0d0a 2020 2020 6465  e.setter..    de
+0001f040: 6620 6474 7970 6528 7365 6c66 2c20 6474  f dtype(self, dt
+0001f050: 7970 653a 206e 702e 6474 7970 6520 7c20  ype: np.dtype | 
+0001f060: 7374 7229 3a0d 0a20 2020 2020 2020 205f  str):..        _
+0001f070: 6474 7970 6520 3d20 6e70 2e64 7479 7065  dtype = np.dtype
+0001f080: 2864 7479 7065 290d 0a0d 0a20 2020 2020  (dtype)....     
+0001f090: 2020 2069 6620 7365 6c66 2e5f 6474 7970     if self._dtyp
+0001f0a0: 6520 213d 205f 6474 7970 6520 616e 6420  e != _dtype and 
+0001f0b0: 7374 7228 5f64 7479 7065 2920 696e 2073  str(_dtype) in s
+0001f0c0: 656c 662e 5f64 7479 7065 733a 0d0a 2020  elf._dtypes:..  
+0001f0d0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0001f0e0: 6474 7970 6520 3d20 5f64 7479 7065 0d0a  dtype = _dtype..
+0001f0f0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001f100: 696e 672e 6465 6275 6728 6622 7b73 656c  ing.debug(f"{sel
+0001f110: 662e 5f64 7479 7065 203d 207d 2229 0d0a  f._dtype = }")..
+0001f120: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001f130: 696e 672e 6465 6275 6728 6622 7365 6c66  ing.debug(f"self
+0001f140: 2e41 203d 207b 7365 6c66 2e41 7d22 290d  .A = {self.A}").
+0001f150: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001f160: 6769 6e67 2e64 6562 7567 2866 2273 656c  ging.debug(f"sel
+0001f170: 662e 4220 3d20 7b73 656c 662e 427d 2229  f.B = {self.B}")
+0001f180: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+0001f190: 790d 0a20 2020 2064 6566 2049 6d61 7828  y..    def Imax(
+0001f1a0: 7365 6c66 2920 2d3e 2069 6e74 3a0d 0a20  self) -> int:.. 
+0001f1b0: 2020 2020 2020 2022 2222 4d61 7869 6d75         """Maximu
+0001f1c0: 6d20 6772 6179 2076 616c 7565 2e22 2222  m gray value."""
+0001f1d0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001f1e0: 206e 702e 6969 6e66 6f28 7365 6c66 2e64   np.iinfo(self.d
+0001f1f0: 7479 7065 292e 6d61 7820 6966 2073 656c  type).max if sel
+0001f200: 662e 6474 7970 652e 6b69 6e64 2069 6e20  f.dtype.kind in 
+0001f210: 2275 6922 2065 6c73 6520 310d 0a0d 0a20  "ui" else 1.... 
+0001f220: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
+0001f230: 2020 6465 6620 5f41 6d69 6e28 7365 6c66    def _Amin(self
+0001f240: 293a 0d0a 2020 2020 2020 2020 2222 224d  ):..        """M
+0001f250: 696e 696d 756d 2062 6961 732e 2222 220d  inimum bias.""".
+0001f260: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001f270: 7365 6c66 2e42 202f 2073 656c 662e 5f56  self.B / self._V
+0001f280: 6d61 780d 0a0d 0a20 2020 2040 7072 6f70  max....    @prop
+0001f290: 6572 7479 0d0a 2020 2020 6465 6620 5f41  erty..    def _A
+0001f2a0: 6d61 7828 7365 6c66 293a 0d0a 2020 2020  max(self):..    
+0001f2b0: 2020 2020 2222 224d 6178 696d 756d 2062      """Maximum b
+0001f2c0: 6961 732e 2222 220d 0a20 2020 2020 2020  ias."""..       
+0001f2d0: 2072 6574 7572 6e20 7365 6c66 2e49 6d61   return self.Ima
+0001f2e0: 7820 2d20 7365 6c66 2e5f 416d 696e 0d0a  x - self._Amin..
+0001f2f0: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
+0001f300: 0a20 2020 2064 6566 2041 2873 656c 6629  .    def A(self)
+0001f310: 202d 3e20 666c 6f61 743a 0d0a 2020 2020   -> float:..    
+0001f320: 2020 2020 2222 2242 6961 732e 2222 220d      """Bias.""".
+0001f330: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001f340: 7365 6c66 2e49 6d61 7820 2a20 7365 6c66  self.Imax * self
+0001f350: 2e62 6574 610d 0a0d 0a20 2020 2040 412e  .beta....    @A.
+0001f360: 7365 7474 6572 0d0a 2020 2020 6465 6620  setter..    def 
+0001f370: 4128 7365 6c66 2c20 413a 2066 6c6f 6174  A(self, A: float
+0001f380: 293a 0d0a 2020 2020 2020 2020 5f41 203d  ):..        _A =
+0001f390: 2066 6c6f 6174 286d 696e 286d 6178 2873   float(min(max(s
+0001f3a0: 656c 662e 5f41 6d69 6e2c 2041 292c 2073  elf._Amin, A), s
+0001f3b0: 656c 662e 5f41 6d61 7829 290d 0a0d 0a20  elf._Amax)).... 
+0001f3c0: 2020 2020 2020 2069 6620 7365 6c66 2e41         if self.A
+0001f3d0: 2021 3d20 5f41 3a0d 0a20 2020 2020 2020   != _A:..       
+0001f3e0: 2020 2020 2073 656c 662e 6265 7461 203d       self.beta =
+0001f3f0: 205f 4120 2f20 7365 6c66 2e49 6d61 780d   _A / self.Imax.
+0001f400: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001f410: 6769 6e67 2e64 6562 7567 2866 227b 7365  ging.debug(f"{se
+0001f420: 6c66 2e41 203d 207d 2229 0d0a 0d0a 2020  lf.A = }")....  
+0001f430: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+0001f440: 2064 6566 205f 426d 6178 2873 656c 6629   def _Bmax(self)
+0001f450: 3a0d 0a20 2020 2020 2020 2022 2222 4d61  :..        """Ma
+0001f460: 7869 6d75 6d20 616d 706c 6974 7564 652e  ximum amplitude.
+0001f470: 2222 220d 0a20 2020 2020 2020 2072 6574  """..        ret
+0001f480: 7572 6e20 6d69 6e28 7365 6c66 2e41 2c20  urn min(self.A, 
+0001f490: 7365 6c66 2e49 6d61 7820 2d20 7365 6c66  self.Imax - self
+0001f4a0: 2e41 2920 2a20 7365 6c66 2e5f 566d 6178  .A) * self._Vmax
+0001f4b0: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+0001f4c0: 790d 0a20 2020 2064 6566 2042 2873 656c  y..    def B(sel
+0001f4d0: 6629 202d 3e20 666c 6f61 743a 0d0a 2020  f) -> float:..  
+0001f4e0: 2020 2020 2020 2222 2241 6d70 6c69 7475        """Amplitu
+0001f4f0: 6465 2e22 2222 0d0a 2020 2020 2020 2020  de."""..        
+0001f500: 7265 7475 726e 2073 656c 662e 4120 2a20  return self.A * 
+0001f510: 7365 6c66 2e56 0d0a 0d0a 2020 2020 4042  self.V....    @B
+0001f520: 2e73 6574 7465 720d 0a20 2020 2064 6566  .setter..    def
+0001f530: 2042 2873 656c 662c 2042 3a20 666c 6f61   B(self, B: floa
+0001f540: 7429 3a0d 0a20 2020 2020 2020 205f 4220  t):..        _B 
+0001f550: 3d20 666c 6f61 7428 6d69 6e28 6d61 7828  = float(min(max(
+0001f560: 302c 2042 292c 2073 656c 662e 5f42 6d61  0, B), self._Bma
+0001f570: 7829 290d 0a0d 0a20 2020 2020 2020 2069  x))....        i
+0001f580: 6620 7365 6c66 2e42 2021 3d20 5f42 3a20  f self.B != _B: 
+0001f590: 2023 2061 6e64 205f 4220 213d 2030 3a0d   # and _B != 0:.
+0001f5a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001f5b0: 662e 5620 3d20 5f42 202f 2073 656c 662e  f.V = _B / self.
+0001f5c0: 410d 0a20 2020 2020 2020 2020 2020 206c  A..            l
+0001f5d0: 6f67 6769 6e67 2e64 6562 7567 2866 227b  ogging.debug(f"{
+0001f5e0: 7365 6c66 2e42 203d 207d 2229 0d0a 0d0a  self.B = }")....
+0001f5f0: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+0001f600: 2020 2064 6566 205f 6265 7461 6d61 7828     def _betamax(
+0001f610: 7365 6c66 293a 0d0a 2020 2020 2020 2020  self):..        
+0001f620: 2222 224d 6178 696d 756d 2072 656c 6174  """Maximum relat
+0001f630: 6976 6520 6269 6173 2028 6578 706f 7375  ive bias (exposu
+0001f640: 7265 292e 2222 220d 0a20 2020 2020 2020  re)."""..       
+0001f650: 2072 6574 7572 6e20 3120 2f20 2831 202b   return 1 / (1 +
+0001f660: 2073 656c 662e 5629 0d0a 0d0a 2020 2020   self.V)....    
+0001f670: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+0001f680: 6566 2062 6574 6128 7365 6c66 2920 2d3e  ef beta(self) ->
+0001f690: 2066 6c6f 6174 3a0d 0a20 2020 2020 2020   float:..       
+0001f6a0: 2022 2222 5265 6c61 7469 7665 2062 6961   """Relative bia
+0001f6b0: 7320 2865 7870 6f73 7572 6529 2c20 692e  s (exposure), i.
+0001f6c0: 652e 2072 656c 6174 6976 6520 6d65 616e  e. relative mean
+0001f6d0: 2069 6e74 656e 7369 7479 20e2 8888 205b   intensity ... [
+0001f6e0: 302c 2031 5d2e 2222 220d 0a20 2020 2020  0, 1]."""..     
+0001f6f0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0001f700: 6265 7461 0d0a 0d0a 2020 2020 4062 6574  beta....    @bet
+0001f710: 612e 7365 7474 6572 0d0a 2020 2020 6465  a.setter..    de
+0001f720: 6620 6265 7461 2873 656c 662c 2062 6574  f beta(self, bet
+0001f730: 6129 202d 3e20 666c 6f61 743a 0d0a 2020  a) -> float:..  
+0001f740: 2020 2020 2020 5f62 6574 6120 3d20 666c        _beta = fl
+0001f750: 6f61 7428 6d69 6e28 6d61 7828 302c 2062  oat(min(max(0, b
+0001f760: 6574 6129 2c20 7365 6c66 2e5f 6265 7461  eta), self._beta
+0001f770: 6d61 7829 290d 0a0d 0a20 2020 2020 2020  max))....       
+0001f780: 2069 6620 7365 6c66 2e5f 6265 7461 2021   if self._beta !
+0001f790: 3d20 5f62 6574 613a 0d0a 2020 2020 2020  = _beta:..      
+0001f7a0: 2020 2020 2020 7365 6c66 2e5f 6265 7461        self._beta
+0001f7b0: 203d 205f 6265 7461 0d0a 2020 2020 2020   = _beta..      
+0001f7c0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+0001f7d0: 6275 6728 6622 7b73 656c 662e 6265 7461  bug(f"{self.beta
+0001f7e0: 203d 207d 2229 0d0a 0d0a 2020 2020 4070   = }")....    @p
+0001f7f0: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
+0001f800: 205f 566d 6178 2873 656c 6629 3a0d 0a20   _Vmax(self):.. 
+0001f810: 2020 2020 2020 2022 2222 4d61 7869 6d75         """Maximu
+0001f820: 6d20 7669 7369 6269 6c69 7479 2e22 2222  m visibility."""
+0001f830: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0001f840: 662e 4644 4d3a 0d0a 2020 2020 2020 2020  f.FDM:..        
+0001f850: 2020 2020 7265 7475 726e 2031 202f 2028      return 1 / (
+0001f860: 7365 6c66 2e44 202a 2073 656c 662e 4b29  self.D * self.K)
+0001f870: 0d0a 2020 2020 2020 2020 656c 6966 2073  ..        elif s
+0001f880: 656c 662e 5344 4d3a 0d0a 2020 2020 2020  elf.SDM:..      
+0001f890: 2020 2020 2020 7265 7475 726e 2031 202f        return 1 /
+0001f8a0: 2073 656c 662e 440d 0a20 2020 2020 2020   self.D..       
+0001f8b0: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+0001f8c0: 2020 2020 7265 7475 726e 2031 0d0a 0d0a      return 1....
+0001f8d0: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+0001f8e0: 2020 2064 6566 2056 2873 656c 6629 202d     def V(self) -
+0001f8f0: 3e20 666c 6f61 743a 0d0a 2020 2020 2020  > float:..      
+0001f900: 2020 2222 2246 7269 6e67 6520 7669 7369    """Fringe visi
+0001f910: 6269 6c69 7479 2028 6672 696e 6765 2063  bility (fringe c
+0001f920: 6f6e 7472 6173 7429 20e2 8888 205b 302c  ontrast) ... [0,
+0001f930: 2031 5d2e 2222 220d 0a20 2020 2020 2020   1]."""..       
+0001f940: 2072 6574 7572 6e20 7365 6c66 2e5f 560d   return self._V.
+0001f950: 0a0d 0a20 2020 2040 562e 7365 7474 6572  ...    @V.setter
+0001f960: 0d0a 2020 2020 6465 6620 5628 7365 6c66  ..    def V(self
+0001f970: 2c20 563a 2066 6c6f 6174 293a 0d0a 2020  , V: float):..  
+0001f980: 2020 2020 2020 5f56 203d 2066 6c6f 6174        _V = float
+0001f990: 286d 696e 286d 6178 2830 2c20 5629 2c20  (min(max(0, V), 
+0001f9a0: 7365 6c66 2e5f 566d 6178 2929 0d0a 0d0a  self._Vmax))....
+0001f9b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001f9c0: 5f56 2021 3d20 5f56 3a0d 0a20 2020 2020  _V != _V:..     
+0001f9d0: 2020 2020 2020 2073 656c 662e 5f56 203d         self._V =
+0001f9e0: 205f 560d 0a20 2020 2020 2020 2020 2020   _V..           
+0001f9f0: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+0001fa00: 227b 7365 6c66 2e56 203d 207d 2229 0d0a  "{self.V = }")..
+0001fa10: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
+0001fa20: 0a20 2020 2064 6566 2056 6d69 6e28 7365  .    def Vmin(se
+0001fa30: 6c66 2920 2d3e 2066 6c6f 6174 3a0d 0a20  lf) -> float:.. 
+0001fa40: 2020 2020 2020 2022 2222 4d69 6e69 6d75         """Minimu
+0001fa50: 6d20 7669 7369 6269 6c69 7479 2066 6f72  m visibility for
+0001fa60: 206d 6561 7375 7265 6d65 6e74 2074 6f20   measurement to 
+0001fa70: 6265 2076 616c 6964 2e22 2222 0d0a 2020  be valid."""..  
+0001fa80: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001fa90: 662e 5f56 6d69 6e0d 0a0d 0a20 2020 2040  f._Vmin....    @
+0001faa0: 566d 696e 2e73 6574 7465 720d 0a20 2020  Vmin.setter..   
+0001fab0: 2064 6566 2056 6d69 6e28 7365 6c66 2c20   def Vmin(self, 
+0001fac0: 566d 696e 3a20 666c 6f61 7429 3a0d 0a20  Vmin: float):.. 
+0001fad0: 2020 2020 2020 205f 566d 696e 203d 2066         _Vmin = f
+0001fae0: 6c6f 6174 286d 696e 286d 6178 2830 2c20  loat(min(max(0, 
+0001faf0: 566d 696e 292c 2031 2929 0d0a 0d0a 2020  Vmin), 1))....  
+0001fb00: 2020 2020 2020 6966 2073 656c 662e 5f56        if self._V
+0001fb10: 6d69 6e20 213d 205f 566d 696e 3a0d 0a20  min != _Vmin:.. 
+0001fb20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001fb30: 5f56 6d69 6e20 3d20 5f56 6d69 6e0d 0a20  _Vmin = _Vmin.. 
+0001fb40: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0001fb50: 6e67 2e64 6562 7567 2866 227b 7365 6c66  ng.debug(f"{self
+0001fb60: 2e5f 566d 696e 203d 207d 2229 0d0a 0d0a  ._Vmin = }")....
+0001fb70: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
+0001fb80: 2020 2064 6566 2075 6d61 7828 7365 6c66     def umax(self
+0001fb90: 2920 2d3e 2066 6c6f 6174 3a0d 0a20 2020  ) -> float:..   
+0001fba0: 2020 2020 2022 2222 5374 616e 6461 7264       """Standard
+0001fbb0: 2064 6576 6961 7469 6f6e 206f 6620 6d61   deviation of ma
+0001fbc0: 7869 6d75 6d20 756e 6365 7274 6169 6e74  ximum uncertaint
+0001fbd0: 7920 666f 7220 6d65 6173 7572 656d 656e  y for measuremen
+0001fbe0: 7420 746f 2062 6520 7661 6c69 642e 0d0a  t to be valid...
+0001fbf0: 2020 2020 2020 2020 5b75 6d61 785d 203d          [umax] =
+0001fc00: 2070 782e 2222 220d 0a20 2020 2020 2020   px."""..       
+0001fc10: 2072 6574 7572 6e20 7365 6c66 2e5f 756d   return self._um
+0001fc20: 6178 0d0a 0d0a 2020 2020 4075 6d61 782e  ax....    @umax.
+0001fc30: 7365 7474 6572 0d0a 2020 2020 6465 6620  setter..    def 
+0001fc40: 756d 6178 2873 656c 662c 2075 6d61 783a  umax(self, umax:
+0001fc50: 2066 6c6f 6174 293a 0d0a 2020 2020 2020   float):..      
+0001fc60: 2020 5f75 6d61 7820 3d20 666c 6f61 7428    _umax = float(
+0001fc70: 6d69 6e28 6d61 7828 302c 2075 6d61 7829  min(max(0, umax)
+0001fc80: 2c20 7365 6c66 2e4c 2929 2020 2320 746f  , self.L))  # to
+0001fc90: 646f 3a20 4c20 2f20 3220 6475 6520 746f  do: L / 2 due to
+0001fca0: 2063 6972 6375 6c61 7220 6469 7374 7269   circular distri
+0001fcb0: 6275 7469 6f6e 2020 2320 746f 646f 3a20  bution  # todo: 
+0001fcc0: 522e 6d61 7828 2920 2f20 320d 0a0d 0a20  R.max() / 2.... 
+0001fcd0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+0001fce0: 756d 6178 2021 3d20 5f75 6d61 783a 0d0a  umax != _umax:..
+0001fcf0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001fd00: 2e5f 756d 6178 203d 205f 756d 6178 0d0a  ._umax = _umax..
+0001fd10: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001fd20: 696e 672e 6465 6275 6728 6622 7b73 656c  ing.debug(f"{sel
+0001fd30: 662e 5f75 6d61 7820 3d20 7d22 290d 0a0d  f._umax = }")...
+0001fd40: 0a20 2020 2023 2040 7072 6f70 6572 7479  .    # @property
+0001fd50: 0d0a 2020 2020 2320 6465 6620 7228 7365  ..    # def r(se
+0001fd60: 6c66 2920 2d3e 2069 6e74 3a0d 0a20 2020  lf) -> int:..   
+0001fd70: 2023 2020 2020 2022 2222 4e75 6d62 6572   #     """Number
+0001fd80: 206f 6620 7175 616e 7469 7a61 7469 6f6e   of quantization
+0001fd90: 2062 6974 732e 2222 220d 0a20 2020 2023   bits."""..    #
+0001fda0: 2020 2020 2072 6574 7572 6e20 3120 6966       return 1 if
+0001fdb0: 2073 656c 662e 6474 7970 652e 6b69 6e64   self.dtype.kind
+0001fdc0: 2069 6e20 2262 2220 656c 7365 206e 702e   in "b" else np.
+0001fdd0: 6969 6e66 6f28 0d0a 2020 2020 2320 2020  iinfo(..    #   
+0001fde0: 2020 2020 2020 7365 6c66 2e64 7479 7065        self.dtype
+0001fdf0: 292e 6269 7473 2069 6620 7365 6c66 2e64  ).bits if self.d
+0001fe00: 7479 7065 2e6b 696e 6420 696e 2022 7569  type.kind in "ui
+0001fe10: 2220 656c 7365 2031 3020 2a2a 206e 702e  " else 10 ** np.
+0001fe20: 6669 6e66 6f28 7365 6c66 2e64 7479 7065  finfo(self.dtype
+0001fe30: 292e 7072 6563 6973 696f 6e0d 0a0d 0a20  ).precision.... 
+0001fe40: 2020 2023 2040 7072 6f70 6572 7479 0d0a     # @property..
+0001fe50: 2020 2020 2320 6465 6620 5128 7365 6c66      # def Q(self
+0001fe60: 2920 2d3e 2066 6c6f 6174 3a0d 0a20 2020  ) -> float:..   
+0001fe70: 2023 2020 2020 2022 2222 4e75 6d62 6572   #     """Number
+0001fe80: 206f 6620 7175 616e 7469 7a61 7469 6f6e   of quantization
+0001fe90: 206c 6576 656c 732e 2222 220d 0a20 2020   levels."""..   
+0001fea0: 2023 2020 2020 2072 6574 7572 6e20 3220   #     return 2 
+0001feb0: 2a2a 2073 656c 662e 720d 0a0d 0a20 2020  ** self.r....   
+0001fec0: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
+0001fed0: 6465 6620 7128 7365 6c66 2920 2d3e 2066  def q(self) -> f
+0001fee0: 6c6f 6174 3a0d 0a20 2020 2020 2020 2022  loat:..        "
+0001fef0: 2222 5175 616e 7469 7a61 7469 6f6e 2073  ""Quantization s
+0001ff00: 7465 7020 7369 7a65 2e22 2222 0d0a 2020  tep size."""..  
+0001ff10: 2020 2020 2020 2320 4c53 420d 0a20 2020        # LSB..   
+0001ff20: 2020 2020 2072 6574 7572 6e20 312e 3020       return 1.0 
+0001ff30: 6966 2073 656c 662e 6474 7970 652e 6b69  if self.dtype.ki
+0001ff40: 6e64 2069 6e20 2275 6962 2220 656c 7365  nd in "uib" else
+0001ff50: 206e 702e 6669 6e66 6f28 7365 6c66 2e64   np.finfo(self.d
+0001ff60: 7479 7065 292e 7265 736f 6c75 7469 6f6e  type).resolution
+0001ff70: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+0001ff80: 790d 0a20 2020 2064 6566 2071 7561 6e74  y..    def quant
+0001ff90: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+0001ffa0: 0d0a 2020 2020 2020 2020 2222 2251 7561  ..        """Qua
+0001ffb0: 6e74 697a 6174 696f 6e20 6e6f 6973 6520  ntization noise 
+0001ffc0: 2873 7461 6e64 6172 6420 6465 7669 6174  (standard deviat
+0001ffd0: 696f 6e29 2e0d 0a20 2020 2020 2020 205b  ion)...        [
+0001ffe0: 7175 616e 745d 203d 2044 4e2e 2222 220d  quant] = DN.""".
+0001fff0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00020000: 666c 6f61 7428 7365 6c66 2e71 202f 206e  float(self.q / n
+00020010: 702e 7371 7274 2831 3229 2920 2023 2063  p.sqrt(12))  # c
+00020020: 6f6e 7665 7274 204e 756d 7079 2066 6c6f  onvert Numpy flo
+00020030: 6174 3634 2074 6f20 5079 7468 6f6e 2066  at64 to Python f
+00020040: 6c6f 6174 0d0a 0d0a 2020 2020 4070 726f  loat....    @pro
+00020050: 7065 7274 790d 0a20 2020 2064 6566 2064  perty..    def d
+00020060: 6172 6b28 7365 6c66 2920 2d3e 2066 6c6f  ark(self) -> flo
+00020070: 6174 3a0d 0a20 2020 2020 2020 2022 2222  at:..        """
+00020080: 4461 726b 206e 6f69 7365 206f 6620 7468  Dark noise of th
+00020090: 6520 6469 6769 7461 6c20 6361 6d65 7261  e digital camera
+000200a0: 2028 7374 616e 6461 7264 2064 6576 6961   (standard devia
+000200b0: 7469 6f6e 292e 0d0a 2020 2020 2020 2020  tion)...        
+000200c0: 5b64 6172 6b5d 203d 2065 6c65 6374 726f  [dark] = electro
+000200d0: 6e73 2e22 2222 0d0a 2020 2020 2020 2020  ns."""..        
+000200e0: 7265 7475 726e 2073 656c 662e 5f64 6172  return self._dar
+000200f0: 6b0d 0a0d 0a20 2020 2040 6461 726b 2e73  k....    @dark.s
+00020100: 6574 7465 720d 0a20 2020 2064 6566 2064  etter..    def d
+00020110: 6172 6b28 7365 6c66 2c20 6461 726b 3a20  ark(self, dark: 
+00020120: 666c 6f61 7429 3a0d 0a20 2020 2020 2020  float):..       
+00020130: 205f 6461 726b 203d 2066 6c6f 6174 286d   _dark = float(m
+00020140: 696e 286d 6178 2830 2c20 6461 726b 292c  in(max(0, dark),
+00020150: 206e 702e 7371 7274 2873 656c 662e 496d   np.sqrt(self.Im
+00020160: 6178 2929 290d 0a0d 0a20 2020 2020 2020  ax)))....       
+00020170: 2023 205f 6461 726b 203d 206d 6178 285f   # _dark = max(_
+00020180: 6461 726b 2c20 302e 3439 2920 2023 2074  dark, 0.49)  # t
+00020190: 6f64 6f3a 2074 656d 706f 7261 6c20 6e6f  odo: temporal no
+000201a0: 6973 6520 6973 2064 6f6d 696e 6174 6564  ise is dominated
+000201b0: 2062 7920 7175 616e 7469 7a61 7469 6f6e   by quantization
+000201c0: 206e 6f69 7365 202d 3e0d 0a0d 0a20 2020   noise ->....   
+000201d0: 2020 2020 205f 6461 726b 203d 206d 6178       _dark = max
+000201e0: 2830 2c20 5f64 6172 6b20 2d20 7365 6c66  (0, _dark - self
+000201f0: 2e71 7561 6e74 2920 2023 2063 6f72 7265  .quant)  # corre
+00020200: 6374 2066 6f72 2071 7561 6e74 697a 6174  ct for quantizat
+00020210: 696f 6e20 6e6f 6973 6520 636f 6e74 6169  ion noise contai
+00020220: 6e65 6420 696e 2064 6172 6b20 6e6f 6973  ned in dark nois
+00020230: 6520 6d65 6173 7572 656d 656e 740d 0a0d  e measurement...
+00020240: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00020250: 2e5f 6461 726b 2021 3d20 5f64 6172 6b3a  ._dark != _dark:
+00020260: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00020270: 6c66 2e5f 6461 726b 203d 205f 6461 726b  lf._dark = _dark
+00020280: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+00020290: 6767 696e 672e 6465 6275 6728 6622 7b73  gging.debug(f"{s
+000202a0: 656c 662e 5f64 6172 6b20 3d20 7d22 290d  elf._dark = }").
+000202b0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+000202c0: 0d0a 2020 2020 6465 6620 7368 6f74 2873  ..    def shot(s
+000202d0: 656c 6629 202d 3e20 666c 6f61 743a 0d0a  elf) -> float:..
+000202e0: 2020 2020 2020 2020 2222 2253 686f 7420          """Shot 
+000202f0: 6e6f 6973 6520 6f66 2064 6967 6974 616c  noise of digital
+00020300: 2063 616d 6572 6120 2873 7461 6e64 6172   camera (standar
+00020310: 6420 6465 7669 6174 696f 6e29 2e0d 0a20  d deviation)... 
+00020320: 2020 2020 2020 205b 7368 6f74 5d20 3d20         [shot] = 
+00020330: 444e 2e22 2222 0d0a 2020 2020 2020 2020  DN."""..        
+00020340: 4120 3d20 7365 6c66 2e41 202a 2073 656c  A = self.A * sel
+00020350: 662e 4d54 4628 3029 2020 2320 746f 646f  f.MTF(0)  # todo
+00020360: 3a20 5061 7065 7220 6672 6f6d 2028 2129  : Paper from (!)
+00020370: 2069 6e63 6c75 6465 7320 420d 0a20 2020   includes B..   
+00020380: 2020 2020 2072 6574 7572 6e20 6e70 2e73       return np.s
+00020390: 7172 7428 7365 6c66 2e67 6169 6e20 2a20  qrt(self.gain * 
+000203a0: 6d61 7828 302c 2041 202d 2073 656c 662e  max(0, A - self.
+000203b0: 7930 2929 2069 6620 7365 6c66 2e67 6169  y0)) if self.gai
+000203c0: 6e20 213d 2030 2065 6c73 6520 3020 2023  n != 0 else 0  #
+000203d0: 2061 7665 7261 6765 2069 6e74 656e 7369   average intensi
+000203e0: 7479 2069 7320 6269 6173 0d0a 0d0a 2020  ty is bias....  
+000203f0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00020400: 2064 6566 2067 6169 6e28 7365 6c66 2920   def gain(self) 
+00020410: 2d3e 2066 6c6f 6174 3a0d 0a20 2020 2020  -> float:..     
+00020420: 2020 2022 2222 4f76 6572 616c 6c20 7379     """Overall sy
+00020430: 7374 656d 2067 6169 6e20 6f66 2064 6967  stem gain of dig
+00020440: 6974 616c 2063 616d 6572 612e 0d0a 2020  ital camera...  
+00020450: 2020 2020 2020 5b67 6169 6e5d 203d 2044        [gain] = D
+00020460: 4e20 2f20 656c 6563 7472 6f6e 732e 2222  N / electrons.""
+00020470: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+00020480: 6e20 7365 6c66 2e5f 6761 696e 0d0a 0d0a  n self._gain....
+00020490: 2020 2020 4067 6169 6e2e 7365 7474 6572      @gain.setter
+000204a0: 0d0a 2020 2020 6465 6620 6761 696e 2873  ..    def gain(s
+000204b0: 656c 662c 2067 6169 6e3a 2066 6c6f 6174  elf, gain: float
+000204c0: 293a 0d0a 2020 2020 2020 2020 5f67 6169  ):..        _gai
+000204d0: 6e20 3d20 6d69 6e28 6d61 7828 302c 2067  n = min(max(0, g
+000204e0: 6169 6e29 2c20 3129 0d0a 0d0a 2020 2020  ain), 1)....    
+000204f0: 2020 2020 6966 2073 656c 662e 5f67 6169      if self._gai
+00020500: 6e20 213d 205f 6761 696e 3a0d 0a20 2020  n != _gain:..   
+00020510: 2020 2020 2020 2020 2073 656c 662e 5f67           self._g
+00020520: 6169 6e20 3d20 5f67 6169 6e0d 0a20 2020  ain = _gain..   
+00020530: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+00020540: 2e64 6562 7567 2866 227b 7365 6c66 2e5f  .debug(f"{self._
+00020550: 6761 696e 203d 207d 2229 0d0a 0d0a 2020  gain = }")....  
+00020560: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00020570: 2064 6566 2050 5346 2873 656c 6629 202d   def PSF(self) -
+00020580: 3e20 666c 6f61 743a 2020 2320 746f 646f  > float:  # todo
+00020590: 3a20 6d61 676e 6966 6963 6174 696f 6e3f  : magnification?
+000205a0: 0d0a 2020 2020 2020 2020 2222 2253 7461  ..        """Sta
+000205b0: 6e64 6172 6420 6465 7669 6174 696f 6e20  ndard deviation 
+000205c0: 6f66 2050 6f69 6e74 2053 7072 6561 6420  of Point Spread 
+000205d0: 4675 6e63 7469 6f6e 2066 6f72 2064 6566  Function for def
+000205e0: 6f63 7573 2e0d 0a20 2020 2020 2020 205b  ocus...        [
+000205f0: 5053 465d 203d 2070 782e 2222 220d 0a20  PSF] = px.""".. 
+00020600: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00020610: 6c66 2e5f 5053 460d 0a0d 0a20 2020 2040  lf._PSF....    @
+00020620: 5053 462e 7365 7474 6572 0d0a 2020 2020  PSF.setter..    
+00020630: 6465 6620 5053 4628 7365 6c66 2c20 5053  def PSF(self, PS
+00020640: 4629 3a0d 0a20 2020 2020 2020 205f 5053  F):..        _PS
+00020650: 4620 3d20 666c 6f61 7428 6d61 7828 302c  F = float(max(0,
+00020660: 2050 5346 2929 0d0a 0d0a 2020 2020 2020   PSF))....      
+00020670: 2020 6966 2073 656c 662e 5f50 5346 2021    if self._PSF !
+00020680: 3d20 5f50 5346 3a0d 0a20 2020 2020 2020  = _PSF:..       
+00020690: 2020 2020 2073 656c 662e 5f50 5346 203d       self._PSF =
+000206a0: 205f 5053 460d 0a20 2020 2020 2020 2020   _PSF..         
+000206b0: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+000206c0: 2866 227b 7365 6c66 2e5f 5053 4620 3d20  (f"{self._PSF = 
+000206d0: 7d22 290d 0a0d 0a20 2020 2040 7072 6f70  }")....    @prop
+000206e0: 6572 7479 0d0a 2020 2020 6465 6620 7930  erty..    def y0
+000206f0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+00020700: 0d0a 2020 2020 2020 2020 2222 2244 6172  ..        """Dar
+00020710: 6b20 7369 676e 616c 2e0d 0a20 2020 2020  k signal...     
+00020720: 2020 205b 7930 5d20 3d20 444e 2222 220d     [y0] = DN""".
+00020730: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00020740: 7365 6c66 2e5f 7930 0d0a 0d0a 2020 2020  self._y0....    
+00020750: 4079 302e 7365 7474 6572 0d0a 2020 2020  @y0.setter..    
+00020760: 6465 6620 7930 2873 656c 662c 2079 303a  def y0(self, y0:
+00020770: 2069 6e74 207c 2066 6c6f 6174 293a 0d0a   int | float):..
+00020780: 2020 2020 2020 2020 5f79 3020 3d20 666c          _y0 = fl
+00020790: 6f61 7428 6d69 6e28 6d61 7828 302c 2079  oat(min(max(0, y
+000207a0: 3029 2c20 7365 6c66 2e49 6d61 7829 290d  0), self.Imax)).
+000207b0: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
+000207c0: 6c66 2e5f 7930 2021 3d20 5f79 303a 0d0a  lf._y0 != _y0:..
+000207d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000207e0: 2e5f 7930 203d 205f 7930 0d0a 2020 2020  ._y0 = _y0..    
+000207f0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00020800: 6465 6275 6728 6622 7b73 656c 662e 5f79  debug(f"{self._y
+00020810: 3020 3d20 7d22 290d 0a0d 0a20 2020 2040  0 = }")....    @
+00020820: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
+00020830: 6620 554d 5228 7365 6c66 2920 2d3e 206e  f UMR(self) -> n
+00020840: 702e 6e64 6172 7261 793a 0d0a 2020 2020  p.ndarray:..    
+00020850: 2020 2020 2222 2255 6e61 6d62 6967 756f      """Unambiguo
+00020860: 7573 206d 6561 7375 7265 6d65 6e74 2072  us measurement r
+00020870: 616e 6765 2e0d 0a20 2020 2020 2020 205b  ange...        [
+00020880: 554d 525d 203d 2070 780d 0a0d 0a20 2020  UMR] = px....   
+00020890: 2020 2020 2054 6865 2063 6f64 696e 6720       The coding 
+000208a0: 6973 206f 6e6c 7920 756e 6971 7565 2077  is only unique w
+000208b0: 6974 6869 6e20 7468 6520 696e 7465 7276  ithin the interv
+000208c0: 616c 205b 302c 2055 4d52 293b 2061 6674  al [0, UMR); aft
+000208d0: 6572 2074 6861 7420 6974 2072 6570 6561  er that it repea
+000208e0: 7473 2069 7473 656c 662e 0d0a 0d0a 2020  ts itself.....  
+000208f0: 2020 2020 2020 5468 6520 554d 5220 6973        The UMR is
+00020900: 2064 6572 6976 6564 2066 726f 6d20 6c20   derived from l 
+00020910: 616e 6420 763a 5c6e 0d0a 2020 2020 2020  and v:\n..      
+00020920: 2020 2d20 4966 206c 20e2 8888 20e2 8495    - If l ... ...
+00020930: 2c20 554d 5220 3d20 6c63 6d28 6c29 2c20  , UMR = lcm(l), 
+00020940: 7769 7468 206c 636d 2062 6569 6e67 2074  with lcm being t
+00020950: 6865 206c 6561 7374 2063 6f6d 6d6f 6e20  he least common 
+00020960: 6d75 6c74 6970 6c65 2e5c 6e0d 0a20 2020  multiple.\n..   
+00020970: 2020 2020 202d 2045 6c73 652c 2069 6620       - Else, if 
+00020980: 7620 e288 8820 e284 952c 2055 4d52 203d  v ... ..., UMR =
+00020990: 204c 202f 2067 6364 2876 292c 2077 6974   L / gcd(v), wit
+000209a0: 6820 6763 6420 6265 696e 6720 7468 6520  h gcd being the 
+000209b0: 6772 6561 7465 7374 2063 6f6d 6d6f 6e20  greatest common 
+000209c0: 6469 7669 736f 722e 5c6e 0d0a 2020 2020  divisor.\n..    
+000209d0: 2020 2020 2d20 456c 7365 2c20 6966 206c      - Else, if l
+000209e0: 20e2 88a8 2076 20e2 8888 20e2 849a 2c20   ... v ... ..., 
+000209f0: 6c63 6d20 7265 7370 2e20 6763 6420 6172  lcm resp. gcd ar
+00020a00: 6520 6578 7465 6e64 6564 2074 6f20 7261  e extended to ra
+00020a10: 7469 6f6e 616c 206e 756d 6265 7273 2e5c  tional numbers.\
+00020a20: 6e0d 0a20 2020 2020 2020 202d 2045 6c73  n..        - Els
+00020a30: 652c 2069 6620 6c20 e288 a720 7620 e288  e, if l ... v ..
+00020a40: 8820 e284 9d20 e288 9620 e284 9a2c 2055  . ... ... ..., U
+00020a50: 4d52 203d 2070 726f 6428 6c29 2c20 7769  MR = prod(l), wi
+00020a60: 7468 2070 726f 6420 6265 696e 6720 7468  th prod being th
+00020a70: 6520 7072 6f64 7563 7420 6f70 6572 6174  e product operat
+00020a80: 6f72 2e0d 0a20 2020 2020 2020 2022 2222  or...        """
+00020a90: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
+00020aa0: 656c 662e 5f55 4d52 2069 7320 6e6f 7420  elf._UMR is not 
+00020ab0: 4e6f 6e65 3a20 2023 2063 6163 6865 0d0a  None:  # cache..
+00020ac0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00020ad0: 726e 2073 656c 662e 5f55 4d52 2020 2320  rn self._UMR  # 
+00020ae0: 746f 646f 3a20 7265 7365 7474 696e 6720  todo: resetting 
+00020af0: 6361 6368 6520 646f 6573 6e27 7420 776f  cache doesn't wo
+00020b00: 726b 2066 6f72 2073 6f6d 6520 7265 6173  rk for some reas
+00020b10: 6f6e 732e 2e2e 6669 7865 643f 202d 3e20  ons...fixed? -> 
+00020b20: 7465 7374 210d 0a0d 0a20 2020 2020 2020  test!....       
+00020b30: 2023 2070 7265 6369 7369 6f6e 203d 206e   # precision = n
+00020b40: 702e 6669 6e66 6f28 2266 6c6f 6174 3634  p.finfo("float64
+00020b50: 2229 2e70 7265 6369 7369 6f6e 202d 2031  ").precision - 1
+00020b60: 0d0a 2020 2020 2020 2020 7072 6563 6973  ..        precis
+00020b70: 696f 6e20 3d20 3133 0d0a 2020 2020 2020  ion = 13..      
+00020b80: 2020 6174 6f6c 203d 2031 302a 2a2d 7072    atol = 10**-pr
+00020b90: 6563 6973 696f 6e0d 0a0d 0a20 2020 2020  ecision....     
+00020ba0: 2020 2055 4d52 203d 206e 702e 656d 7074     UMR = np.empt
+00020bb0: 7928 7365 6c66 2e44 290d 0a20 2020 2020  y(self.D)..     
+00020bc0: 2020 2066 6f72 2064 2069 6e20 7261 6e67     for d in rang
+00020bd0: 6528 7365 6c66 2e44 293a 0d0a 2020 2020  e(self.D):..    
+00020be0: 2020 2020 2020 2020 6c20 3d20 7365 6c66          l = self
+00020bf0: 2e5f 6c5b 645d 2020 2320 2e63 6f70 7928  ._l[d]  # .copy(
+00020c00: 290d 0a20 2020 2020 2020 2020 2020 2076  )..            v
+00020c10: 203d 2073 656c 662e 5f76 5b64 5d20 2023   = self._v[d]  #
+00020c20: 202e 636f 7079 2829 0d0a 0d0a 2020 2020   .copy()....    
+00020c30: 2020 2020 2020 2020 6966 2031 2069 6e20          if 1 in 
+00020c40: 7365 6c66 2e5f 4e5b 645d 3a20 2023 2068  self._N[d]:  # h
+00020c50: 6572 652c 2069 6e20 5450 5520 7477 6963  ere, in TPU twic
+00020c60: 6520 7468 6520 636f 6d62 696e 6174 696f  e the combinatio
+00020c70: 6e73 2068 6176 6520 746f 2062 6520 7472  ns have to be tr
+00020c80: 6965 640d 0a20 2020 2020 2020 2020 2020  ied..           
+00020c90: 2020 2020 2023 2074 6f64 6f3a 2074 6573       # todo: tes
+00020ca0: 7420 6966 2076 616c 6964 0d0a 2020 2020  t if valid..    
+00020cb0: 2020 2020 2020 2020 2020 2020 6c5b 7365              l[se
+00020cc0: 6c66 2e5f 4e5b 645d 203d 3d20 315d 202f  lf._N[d] == 1] /
+00020cd0: 3d20 320d 0a20 2020 2020 2020 2020 2020  = 2..           
+00020ce0: 2020 2020 2076 5b73 656c 662e 5f4e 5b64       v[self._N[d
+00020cf0: 5d20 3d3d 2031 5d20 2a3d 2032 0d0a 0d0a  ] == 1] *= 2....
+00020d00: 2020 2020 2020 2020 2020 2020 6966 2030              if 0
+00020d10: 2069 6e20 763a 2020 2320 6571 7569 7661   in v:  # equiva
+00020d20: 6c65 6e74 6c79 3a20 6e70 2e69 6e66 2069  lently: np.inf i
+00020d30: 6e20 6c0d 0a20 2020 2020 2020 2020 2020  n l..           
+00020d40: 2020 2020 206c 203d 206c 5b76 2021 3d20       l = l[v != 
+00020d50: 305d 0d0a 2020 2020 2020 2020 2020 2020  0]..            
+00020d60: 2020 2020 7620 3d20 765b 7620 213d 2030      v = v[v != 0
+00020d70: 5d0d 0a0d 0a20 2020 2020 2020 2020 2020  ]....           
+00020d80: 2069 6620 6c65 6e28 6c29 203d 3d20 3020   if len(l) == 0 
+00020d90: 6f72 206c 656e 2876 2920 3d3d 2030 3a0d  or len(v) == 0:.
+00020da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020db0: 2055 4d52 5b64 5d20 3d20 3120 2023 206f   UMR[d] = 1  # o
+00020dc0: 6e65 2073 696e 6365 2077 6520 6361 6e20  ne since we can 
+00020dd0: 6f6e 6c79 2063 6f6e 7472 6f6c 2064 6973  only control dis
+00020de0: 6372 6574 6520 7069 7865 6c73 0d0a 2020  crete pixels..  
+00020df0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00020e00: 6561 6b0d 0a0d 0a20 2020 2020 2020 2020  eak....         
+00020e10: 2020 2069 6620 6e70 2e61 6c6c 286c 2025     if np.all(l %
+00020e20: 2031 203d 3d20 3029 3a20 2023 2061 6c6c   1 == 0):  # all
+00020e30: 206c 2061 7265 2069 6e74 6567 6572 730d   l are integers.
+00020e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020e50: 2055 4d52 5b64 5d20 3d20 6e70 2e6c 636d   UMR[d] = np.lcm
+00020e60: 2e72 6564 7563 6528 6c2e 6173 7479 7065  .reduce(l.astype
+00020e70: 2869 6e74 2c20 636f 7079 3d46 616c 7365  (int, copy=False
+00020e80: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
+00020e90: 656c 6966 206e 702e 616c 6c28 7620 2520  elif np.all(v % 
+00020ea0: 3120 3d3d 2030 293a 2020 2320 616c 6c20  1 == 0):  # all 
+00020eb0: 7620 6172 6520 696e 7465 6765 7273 0d0a  v are integers..
+00020ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ed0: 554d 525b 645d 203d 2073 656c 662e 4c20  UMR[d] = self.L 
+00020ee0: 2f20 6e70 2e67 6364 2e72 6564 7563 6528  / np.gcd.reduce(
+00020ef0: 762e 6173 7479 7065 2869 6e74 2c20 636f  v.astype(int, co
+00020f00: 7079 3d46 616c 7365 2929 0d0a 2020 2020  py=False))..    
+00020f10: 2020 2020 2020 2020 656c 6966 206e 702e          elif np.
+00020f20: 616c 6c63 6c6f 7365 286c 2c20 6e70 2e72  allclose(l, np.r
+00020f30: 696e 7428 6c29 2c20 7274 6f6c 3d30 2c20  int(l), rtol=0, 
+00020f40: 6174 6f6c 3d61 746f 6c29 3a20 2023 2061  atol=atol):  # a
+00020f50: 6c6c 206c 2061 7265 2069 6e74 6567 6572  ll l are integer
+00020f60: 7320 7769 7468 696e 2074 6f6c 6572 616e  s within toleran
+00020f70: 6365 0d0a 2020 2020 2020 2020 2020 2020  ce..            
+00020f80: 2020 2020 554d 525b 645d 203d 206e 702e      UMR[d] = np.
+00020f90: 6c63 6d2e 7265 6475 6365 286e 702e 7269  lcm.reduce(np.ri
+00020fa0: 6e74 286c 292e 6173 7479 7065 2869 6e74  nt(l).astype(int
+00020fb0: 2c20 636f 7079 3d46 616c 7365 2929 0d0a  , copy=False))..
+00020fc0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00020fd0: 206e 702e 616c 6c63 6c6f 7365 2876 2c20   np.allclose(v, 
+00020fe0: 6e70 2e72 696e 7428 7629 2c20 7274 6f6c  np.rint(v), rtol
+00020ff0: 3d30 2c20 6174 6f6c 3d61 746f 6c29 3a20  =0, atol=atol): 
+00021000: 2023 2061 6c6c 2076 2061 7265 2069 6e74   # all v are int
+00021010: 6567 6572 7320 7769 7468 696e 2074 6f6c  egers within tol
+00021020: 6572 616e 6365 0d0a 2020 2020 2020 2020  erance..        
+00021030: 2020 2020 2020 2020 554d 525b 645d 203d          UMR[d] =
+00021040: 2073 656c 662e 4c20 2f20 6e70 2e67 6364   self.L / np.gcd
+00021050: 2e72 6564 7563 6528 6e70 2e72 696e 7428  .reduce(np.rint(
+00021060: 7629 2e61 7374 7970 6528 696e 742c 2063  v).astype(int, c
+00021070: 6f70 793d 4661 6c73 6529 290d 0a20 2020  opy=False))..   
+00021080: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00021090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000210a0: 2320 6d75 7475 616c 2064 6976 6973 6962  # mutual divisib
+000210b0: 696c 6974 7920 7465 7374 0d0a 2020 2020  ility test..    
+000210c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000210d0: 6920 696e 2072 616e 6765 2873 656c 662e  i in range(self.
+000210e0: 4b20 2d20 3129 3a0d 0a20 2020 2020 2020  K - 1):..       
+000210f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00021100: 206a 2069 6e20 7261 6e67 6528 6920 2b20   j in range(i + 
+00021110: 312c 2073 656c 662e 4b29 3a0d 0a20 2020  1, self.K):..   
+00021120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021130: 2020 2020 2069 6620 6c5b 695d 2025 206c       if l[i] % l
+00021140: 5b6a 5d20 3c20 6174 6f6c 206f 7220 3120  [j] < atol or 1 
+00021150: 2d20 6174 6f6c 203c 206c 5b69 5d20 2520  - atol < l[i] % 
+00021160: 6c5b 6a5d 203c 2031 3a0d 0a20 2020 2020  l[j] < 1:..     
+00021170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021180: 2020 2020 2020 206c 5b6a 5d20 3d20 310d         l[j] = 1.
+00021190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000211a0: 2020 2020 2020 2020 2065 6c69 6620 6c5b           elif l[
+000211b0: 6a5d 2025 206c 5b69 5d20 3c20 6174 6f6c  j] % l[i] < atol
+000211c0: 206f 7220 3120 2d20 6174 6f6c 203c 206c   or 1 - atol < l
+000211d0: 5b6a 5d20 2520 6c5b 695d 203c 2031 3a0d  [j] % l[i] < 1:.
+000211e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000211f0: 2020 2020 2020 2020 2020 2020 206c 5b69               l[i
+00021200: 5d20 3d20 310d 0a20 2020 2020 2020 2020  ] = 1..         
+00021210: 2020 2020 2020 2076 203d 2076 5b6c 2021         v = v[l !
+00021220: 3d20 315d 0d0a 2020 2020 2020 2020 2020  = 1]..          
+00021230: 2020 2020 2020 6c20 3d20 6c5b 6c20 213d        l = l[l !=
+00021240: 2031 5d0d 0a0d 0a20 2020 2020 2020 2020   1]....         
+00021250: 2020 2020 2020 2023 206e 756d 6265 7220         # number 
+00021260: 6f66 2064 6563 696d 616c 730d 0a20 2020  of decimals..   
+00021270: 2020 2020 2020 2020 2020 2020 2044 6c20               Dl 
+00021280: 3d20 6d61 7828 7374 7228 6929 5b3a 3a2d  = max(str(i)[::-
+00021290: 315d 2e66 696e 6428 222e 2229 2066 6f72  1].find(".") for
+000212a0: 2069 2069 6e20 6c29 0d0a 2020 2020 2020   i in l)..      
+000212b0: 2020 2020 2020 2020 2020 4476 203d 206d            Dv = m
+000212c0: 6178 2873 7472 2869 295b 3a3a 2d31 5d2e  ax(str(i)[::-1].
+000212d0: 6669 6e64 2822 2e22 2920 666f 7220 6920  find(".") for i 
+000212e0: 696e 2076 290d 0a0d 0a20 2020 2020 2020  in v)....       
+000212f0: 2020 2020 2020 2020 2023 2065 7374 696d           # estim
+00021300: 6174 6520 7768 6574 6865 7220 656c 656d  ate whether elem
+00021310: 656e 7473 2061 7265 2072 6174 696f 6e61  ents are rationa
+00021320: 6c20 6f72 2069 7272 6174 696f 6e61 6c0d  l or irrational.
+00021330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021340: 2069 6620 446c 203c 2070 7265 6369 7369   if Dl < precisi
+00021350: 6f6e 206f 7220 4476 203c 2070 7265 6369  on or Dv < preci
+00021360: 7369 6f6e 3a20 2023 2072 6174 696f 6e61  sion:  # rationa
+00021370: 6c20 6e75 6d62 6572 7320 7769 7468 6f75  l numbers withou
+00021380: 7420 696e 7465 6765 7273 0d0a 2020 2020  t integers..    
+00021390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213a0: 2320 6578 7465 6e64 206c 636d 2f67 6364  # extend lcm/gcd
+000213b0: 2074 6f20 7261 7469 6f6e 616c 206e 756d   to rational num
+000213c0: 6265 7273 0d0a 0d0a 2020 2020 2020 2020  bers....        
+000213d0: 2020 2020 2020 2020 2020 2020 6966 2044              if D
+000213e0: 6c20 3c3d 2044 763a 0d0a 2020 2020 2020  l <= Dv:..      
+000213f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021400: 2020 6c73 203d 206c 202a 2031 302a 2a44    ls = l * 10**D
+00021410: 6c20 2023 2077 6176 656c 656e 6774 6873  l  # wavelengths
+00021420: 2073 6361 6c65 640d 0a20 2020 2020 2020   scaled..       
+00021430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021440: 2055 4d52 5b64 5d20 3d20 6e70 2e6c 636d   UMR[d] = np.lcm
+00021450: 2e72 6564 7563 6528 6c73 2e61 7374 7970  .reduce(ls.astyp
+00021460: 6528 696e 742c 2063 6f70 793d 4661 6c73  e(int, copy=Fals
+00021470: 6529 2920 2f20 3130 2a2a 446c 0d0a 2020  e)) / 10**Dl..  
+00021480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021490: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+000214a0: 6275 6728 2245 7874 656e 6465 6420 6c63  bug("Extended lc
+000214b0: 6d20 746f 2072 6174 696f 6e61 6c20 6e75  m to rational nu
+000214c0: 6d62 6572 732e 2229 0d0a 2020 2020 2020  mbers.")..      
+000214d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000214e0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+000214f0: 2020 2020 2020 2020 2020 2020 2076 7320               vs 
+00021500: 3d20 7620 2a20 3130 2a2a 4476 2020 2320  = v * 10**Dv  # 
+00021510: 7370 6174 6961 6c20 6672 6571 7565 6e63  spatial frequenc
+00021520: 6965 7320 7363 616c 6564 0d0a 2020 2020  ies scaled..    
+00021530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021540: 2020 2020 554d 525b 645d 203d 2073 656c      UMR[d] = sel
+00021550: 662e 4c20 2f20 286e 702e 6763 642e 7265  f.L / (np.gcd.re
+00021560: 6475 6365 2876 732e 6173 7479 7065 2869  duce(vs.astype(i
+00021570: 6e74 2c20 636f 7079 3d46 616c 7365 2929  nt, copy=False))
+00021580: 202f 2031 302a 2a44 7629 0d0a 2020 2020   / 10**Dv)..    
+00021590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215a0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+000215b0: 6728 2245 7874 656e 6465 6420 6763 6420  g("Extended gcd 
+000215c0: 746f 2072 6174 696f 6e61 6c20 6e75 6d62  to rational numb
+000215d0: 6572 732e 2229 0d0a 2020 2020 2020 2020  ers.")..        
+000215e0: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
+000215f0: 2069 7272 6174 696f 6e61 6c20 6e75 6d62   irrational numb
+00021600: 6572 7320 6f72 2072 6174 696f 6e61 6c20  ers or rational 
+00021610: 6e75 6d62 6572 7320 7769 7468 206d 6f72  numbers with mor
+00021620: 6520 6469 6769 7473 2074 6861 6e20 2270  e digits than "p
+00021630: 7265 6369 7369 6f6e 220d 0a20 2020 2020  recision"..     
+00021640: 2020 2020 2020 2020 2020 2020 2020 2055                 U
+00021650: 4d52 5b64 5d20 3d20 6e70 2e70 726f 6428  MR[d] = np.prod(
+00021660: 6c29 0d0a 0d0a 2020 2020 2020 2020 7365  l)....        se
+00021670: 6c66 2e5f 554d 5220 3d20 554d 520d 0a20  lf._UMR = UMR.. 
+00021680: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00021690: 6562 7567 2866 2273 656c 662e 554d 5220  ebug(f"self.UMR 
+000216a0: 3d20 7b73 7472 2873 656c 662e 5f55 4d52  = {str(self._UMR
+000216b0: 297d 2229 0d0a 0d0a 2020 2020 2020 2020  )}")....        
+000216c0: 6966 2073 656c 662e 5f61 6d62 6967 756f  if self._ambiguo
+000216d0: 7573 3a0d 0a20 2020 2020 2020 2020 2020  us:..           
+000216e0: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
+000216f0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+00021700: 2020 2022 554d 5220 3c20 522e 2055 6e77     "UMR < R. Unw
+00021710: 7261 7070 696e 6720 7769 6c6c 206e 6f74  rapping will not
+00021720: 2062 6520 7370 6174 6961 6c6c 7920 696e   be spatially in
+00021730: 6465 7065 6e64 656e 7420 616e 6420 6f6e  dependent and on
+00021740: 6c79 2079 6965 6c64 2061 2072 656c 6174  ly yield a relat
+00021750: 6976 6520 7068 6173 6520 6d61 702e 220d  ive phase map.".
+00021760: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
+00021770: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00021780: 2073 656c 662e 5f55 4d52 0d0a 0d0a 2020   self._UMR....  
+00021790: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+000217a0: 2064 6566 2065 7461 2873 656c 6629 202d   def eta(self) -
+000217b0: 3e20 666c 6f61 743a 0d0a 2020 2020 2020  > float:..      
+000217c0: 2020 2222 2243 6f64 696e 6720 6566 6669    """Coding effi
+000217d0: 6369 656e 6379 2e22 2222 0d0a 2020 2020  ciency."""..    
+000217e0: 2020 2020 6574 6120 3d20 7365 6c66 2e52      eta = self.R
+000217f0: 202f 2073 656c 662e 554d 520d 0a20 2020   / self.UMR..   
+00021800: 2020 2020 2065 7461 5b73 656c 662e 554d       eta[self.UM
+00021810: 5220 3c20 7365 6c66 2e52 5d20 3d20 300d  R < self.R] = 0.
+00021820: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00021830: 6574 610d 0a0d 0a20 2020 2040 7072 6f70  eta....    @prop
+00021840: 6572 7479 0d0a 2020 2020 6465 6620 7569  erty..    def ui
+00021850: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+00021860: 0d0a 2020 2020 2020 2020 2222 2249 6e74  ..        """Int
+00021870: 656e 7369 7479 206e 6f69 7365 2e22 2222  ensity noise."""
+00021880: 0d0a 2020 2020 2020 2020 7175 616e 7420  ..        quant 
+00021890: 3d20 3020 6966 2073 656c 662e 6461 726b  = 0 if self.dark
+000218a0: 203e 2030 2065 6c73 6520 7365 6c66 2e71   > 0 else self.q
+000218b0: 7561 6e74 0d0a 2020 2020 2020 2020 7175  uant..        qu
+000218c0: 616e 7420 3d20 7365 6c66 2e71 7561 6e74  ant = self.quant
+000218d0: 0d0a 2020 2020 2020 2020 7569 203d 206e  ..        ui = n
+000218e0: 702e 7371 7274 2873 656c 662e 6761 696e  p.sqrt(self.gain
+000218f0: 2a2a 3220 2a20 7365 6c66 2e64 6172 6b2a  **2 * self.dark*
+00021900: 2a32 202b 2071 7561 6e74 2a2a 3220 2b20  *2 + quant**2 + 
+00021910: 7365 6c66 2e73 686f 742a 2a32 290d 0a20  self.shot**2).. 
+00021920: 2020 2020 2020 2072 6574 7572 6e20 7569         return ui
+00021930: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+00021940: 790d 0a20 2020 2064 6566 2075 7069 2873  y..    def upi(s
+00021950: 656c 6629 202d 3e20 666c 6f61 743a 0d0a  elf) -> float:..
+00021960: 2020 2020 2020 2020 2222 2250 6861 7365          """Phase
+00021970: 2075 6e63 6572 7461 696e 7479 2e0d 0a20   uncertainty... 
+00021980: 2020 2020 2020 205b 7570 695d 203d 2072         [upi] = r
+00021990: 6164 2222 220d 0a20 2020 2020 2020 2042  ad"""..        B
+000219a0: 203d 2073 656c 662e 4220 2a20 7365 6c66   = self.B * self
+000219b0: 2e4d 5446 2873 656c 662e 5f76 290d 0a20  .MTF(self._v).. 
+000219c0: 2020 2020 2020 2053 4e52 203d 2042 202f         SNR = B /
+000219d0: 2073 656c 662e 7569 0d0a 2020 2020 2020   self.ui..      
+000219e0: 2020 7570 6920 3d20 6e70 2e73 7172 7428    upi = np.sqrt(
+000219f0: 3229 202f 206e 702e 7371 7274 2873 656c  2) / np.sqrt(sel
+00021a00: 662e 4d29 202f 206e 702e 7371 7274 2873  f.M) / np.sqrt(s
+00021a10: 656c 662e 5f4e 2920 2f20 534e 5220 2023  elf._N) / SNR  #
+00021a20: 206c 6f63 616c 2070 6861 7365 2075 6e63   local phase unc
+00021a30: 6572 7461 696e 7469 6573 0d0a 2020 2020  ertainties..    
+00021a40: 2020 2020 7265 7475 726e 2075 7069 0d0a      return upi..
+00021a50: 0d0a 2020 2020 4070 726f 7065 7274 790d  ..    @property.
+00021a60: 0a20 2020 2064 6566 2075 2873 656c 6629  .    def u(self)
+00021a70: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
+00021a80: 0a20 2020 2020 2020 2022 2222 556e 6365  .        """Unce
+00021a90: 7274 6169 6e74 7920 6f66 206d 6561 7375  rtainty of measu
+00021aa0: 7265 6d65 6e74 2028 7374 616e 6461 7264  rement (standard
+00021ab0: 2064 6576 6961 7469 6f6e 292e 0d0a 2020   deviation)...  
+00021ac0: 2020 2020 2020 5b75 5d20 3d20 7078 2e0d        [u] = px..
+00021ad0: 0a0d 0a20 2020 2020 2020 2049 7420 6973  ...        It is
+00021ae0: 2062 6173 6564 206f 6e20 7468 6520 7068   based on the ph
+00021af0: 6173 6520 6e6f 6973 6520 6d6f 6465 6c0d  ase noise model.
+00021b00: 0a20 2020 2020 2020 2061 6e64 2070 726f  .        and pro
+00021b10: 7061 6761 7465 6420 7468 726f 7567 6820  pagated through 
+00021b20: 7468 6520 756e 7772 6170 7069 6e67 2070  the unwrapping p
+00021b30: 726f 6365 7373 2061 6e64 2074 6865 2070  rocess and the p
+00021b40: 6861 7365 2066 7573 696f 6e2e 2222 220d  hase fusion.""".
+00021b50: 0a0d 0a20 2020 2020 2020 2075 7069 6e20  ...        upin 
+00021b60: 3d20 7365 6c66 2e75 7069 202f 2028 3220  = self.upi / (2 
+00021b70: 2a20 6e70 2e70 6929 2020 2320 6e6f 726d  * np.pi)  # norm
+00021b80: 616c 697a 6564 206c 6f63 616c 2070 6861  alized local pha
+00021b90: 7365 2075 6e63 6572 7461 696e 7469 6573  se uncertainties
+00021ba0: 0d0a 2020 2020 2020 2020 7578 6920 3d20  ..        uxi = 
+00021bb0: 7570 696e 202a 2073 656c 662e 5f6c 2020  upin * self._l  
+00021bc0: 2320 6c6f 6361 6c20 706f 7369 7469 6f6e  # local position
+00021bd0: 616c 2075 6e63 6572 7461 696e 7469 6573  al uncertainties
+00021be0: 0d0a 2020 2020 2020 2020 7578 203d 206e  ..        ux = n
+00021bf0: 702e 7371 7274 2831 202f 206e 702e 7375  p.sqrt(1 / np.su
+00021c00: 6d28 3120 2f20 7578 692a 2a32 2c20 6178  m(1 / uxi**2, ax
+00021c10: 6973 3d31 2929 2020 2320 676c 6f62 616c  is=1))  # global
+00021c20: 2070 6f73 6974 696f 6e61 6c20 756e 6365   positional unce
+00021c30: 7274 6169 6e74 7920 2862 7920 696e 7665  rtainty (by inve
+00021c40: 7273 6520 7661 7269 616e 6365 2077 6569  rse variance wei
+00021c50: 6768 7469 6e67 290d 0a20 2020 2020 2020  ghting)..       
+00021c60: 2023 2074 6f64 6f3a 2066 6163 746f 7220   # todo: factor 
+00021c70: 6f75 7420 4c20 3f21 0d0a 2020 2020 2020  out L ?!..      
+00021c80: 2020 7265 7475 726e 2075 780d 0a0d 0a20    return ux.... 
+00021c90: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
+00021ca0: 2020 6465 6620 534e 5228 7365 6c66 2920    def SNR(self) 
+00021cb0: 2d3e 206e 702e 6e64 6172 7261 793a 0d0a  -> np.ndarray:..
+00021cc0: 2020 2020 2020 2020 2222 2253 6967 6e61          """Signa
+00021cd0: 6c2d 746f 2d6e 6f69 7365 2072 6174 696f  l-to-noise ratio
+00021ce0: 206f 6620 7468 6520 7068 6173 6520 7368   of the phase sh
+00021cf0: 6966 7420 636f 6469 6e67 2e0d 0a0d 0a20  ift coding..... 
+00021d00: 2020 2020 2020 2049 7420 6973 2061 206d         It is a m
+00021d10: 6173 7572 6520 6f66 2068 6f77 206d 616e  asure of how man
+00021d20: 7920 706f 696e 7473 2063 616e 2062 6520  y points can be 
+00021d30: 6469 7374 696e 6775 6973 6865 6420 7769  distinguished wi
+00021d40: 7468 696e 2074 6865 2073 6372 6565 6e20  thin the screen 
+00021d50: 6c65 6e67 7468 205b 302c 2052 290d 0a20  length [0, R).. 
+00021d60: 2020 2020 2020 2022 2222 0d0a 2020 2020         """..    
+00021d70: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00021d80: 5220 2f20 7365 6c66 2e75 0d0a 0d0a 2020  R / self.u....  
+00021d90: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00021da0: 2064 6566 2053 4e52 6442 2873 656c 6629   def SNRdB(self)
+00021db0: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
+00021dc0: 0a20 2020 2020 2020 2022 2222 5369 676e  .        """Sign
+00021dd0: 616c 2d74 6f2d 6e6f 6973 6520 7261 7469  al-to-noise rati
+00021de0: 6f2e 0d0a 2020 2020 2020 2020 5b53 4e52  o...        [SNR
+00021df0: 6442 5d20 3d20 6442 2e22 2222 0d0a 2020  dB] = dB."""..  
+00021e00: 2020 2020 2020 7265 7475 726e 2032 3020        return 20 
+00021e10: 2a20 6e70 2e6c 6f67 3130 2873 656c 662e  * np.log10(self.
+00021e20: 534e 5229 0d0a 0d0a 2020 2020 4070 726f  SNR)....    @pro
+00021e30: 7065 7274 790d 0a20 2020 2064 6566 2044  perty..    def D
+00021e40: 5228 7365 6c66 2920 2d3e 206e 702e 6e64  R(self) -> np.nd
+00021e50: 6172 7261 793a 0d0a 2020 2020 2020 2020  array:..        
+00021e60: 2222 2244 796e 616d 6963 2072 616e 6765  """Dynamic range
+00021e70: 206f 6620 7468 6520 7068 6173 6520 7368   of the phase sh
+00021e80: 6966 7420 636f 6469 6e67 2e0d 0a0d 0a20  ift coding..... 
+00021e90: 2020 2020 2020 2049 7420 6973 2061 206d         It is a m
+00021ea0: 6561 7375 7265 206f 6620 686f 7720 6d61  easure of how ma
+00021eb0: 6e79 2070 6f69 6e74 7320 6361 6e20 6265  ny points can be
+00021ec0: 2064 6973 7469 6e67 7569 7368 6564 2077   distinguished w
+00021ed0: 6974 6869 6e20 7468 6520 756e 616d 6269  ithin the unambi
+00021ee0: 6775 6f75 736d 6561 7375 7265 6d65 6e74  guousmeasurement
+00021ef0: 2072 616e 6765 205b 302c 2055 4d52 292e   range [0, UMR).
+00021f00: 0d0a 2020 2020 2020 2020 2222 220d 0a20  ..        """.. 
+00021f10: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00021f20: 6c66 2e55 4d52 202f 2073 656c 662e 750d  lf.UMR / self.u.
+00021f30: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+00021f40: 0d0a 2020 2020 6465 6620 4452 6442 2873  ..    def DRdB(s
+00021f50: 656c 6629 202d 3e20 6e70 2e6e 6461 7272  elf) -> np.ndarr
+00021f60: 6179 3a0d 0a20 2020 2020 2020 2022 2222  ay:..        """
+00021f70: 4479 6e61 6d69 6320 7261 6e67 652e 205b  Dynamic range. [
+00021f80: 4452 6442 5d20 3d20 6442 2e22 2222 0d0a  DRdB] = dB."""..
+00021f90: 2020 2020 2020 2020 7265 7475 726e 2032          return 2
+00021fa0: 3020 2a20 6e70 2e6c 6f67 3130 2873 656c  0 * np.log10(sel
+00021fb0: 662e 4452 290d 0a0d 0a20 2020 2040 7072  f.DR)....    @pr
+00021fc0: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
+00021fd0: 6566 6669 6369 656e 6379 2873 656c 6629  efficiency(self)
+00021fe0: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0d   -> np.ndarray:.
+00021ff0: 0a20 2020 2020 2020 2022 2222 436f 6469  .        """Codi
+00022000: 6e67 2065 6666 6963 6965 6e63 792e 2222  ng efficiency.""
+00022010: 220d 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+00022020: 6e20 7365 6c66 2e53 4e52 202f 2073 656c  n self.SNR / sel
+00022030: 662e 5420 2023 2074 6f64 6f3a 2064 6174  f.T  # todo: dat
+00022040: 6120 7472 616e 7366 6572 2072 6174 653f  a transfer rate?
+00022050: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+00022060: 790d 0a20 2020 2064 6566 2070 6172 616d  y..    def param
+00022070: 7328 7365 6c66 2920 2d3e 2064 6963 743a  s(self) -> dict:
+00022080: 0d0a 2020 2020 2020 2020 2222 2242 6173  ..        """Bas
+00022090: 6520 7061 7261 6d65 7465 7273 2072 6571  e parameters req
+000220a0: 7569 7265 6420 666f 7220 656e 2d20 2620  uired for en- & 
+000220b0: 6465 636f 6469 6e67 2066 7269 6e67 6520  decoding fringe 
+000220c0: 7061 7474 6572 6e73 2e0d 0a0d 0a20 2020  patterns.....   
+000220d0: 2020 2020 2054 6869 7320 636f 6e74 6169       This contai
+000220e0: 6e73 2061 6c6c 2070 726f 7065 7274 7920  ns all property 
+000220f0: 6f62 6a65 6374 7320 6f66 2074 6865 2063  objects of the c
+00022100: 6c61 7373 2077 6869 6368 2068 6176 6520  lass which have 
+00022110: 6120 7365 7474 6572 206d 6574 686f 642c  a setter method,
+00022120: 0d0a 2020 2020 2020 2020 692e 652e 2061  ..        i.e. a
+00022130: 7265 2028 7573 7561 6c6c 7929 206e 6f74  re (usually) not
+00022140: 2064 6572 6976 6564 2066 726f 6d20 6f74   derived from ot
+00022150: 6865 7273 2e0d 0a20 2020 2020 2020 2022  hers...        "
+00022160: 2222 0d0a 0d0a 2020 2020 2020 2020 7061  ""....        pa
+00022170: 7261 6d73 203d 207b 7d0d 0a20 2020 2020  rams = {}..     
+00022180: 2020 2066 6f72 2070 2069 6e20 736f 7274     for p in sort
+00022190: 6564 2864 6972 2873 656c 6629 293a 2020  ed(dir(self)):  
+000221a0: 2320 736f 7274 6564 2829 2065 6e73 7572  # sorted() ensur
+000221b0: 6573 2073 6574 7469 6e67 2070 6172 616d  es setting param
+000221c0: 7320 696e 2074 6865 2072 6967 6874 206f  s in the right o
+000221d0: 7264 6572 2069 6e20 7468 6520 7365 7474  rder in the sett
+000221e0: 6572 206d 6574 686f 640d 0a20 2020 2020  er method..     
+000221f0: 2020 2020 2020 2069 6620 7020 213d 2022         if p != "
+00022200: 7061 7261 6d73 223a 0d0a 2020 2020 2020  params":..      
+00022210: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00022220: 6e73 7461 6e63 6528 6765 7461 7474 7228  nstance(getattr(
+00022230: 7479 7065 2873 656c 6629 2c20 702c 204e  type(self), p, N
+00022240: 6f6e 6529 2c20 7072 6f70 6572 7479 2920  one), property) 
+00022250: 616e 6420 6765 7461 7474 7228 7479 7065  and getattr(type
+00022260: 2873 656c 6629 2c20 702c 204e 6f6e 6529  (self), p, None)
+00022270: 2e66 7365 7420 6973 206e 6f74 204e 6f6e  .fset is not Non
+00022280: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00022290: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000222a0: 7461 6e63 6528 6765 7461 7474 7228 7365  tance(getattr(se
+000222b0: 6c66 2c20 702c 204e 6f6e 6529 2c20 6e70  lf, p, None), np
+000222c0: 2e6e 6461 7272 6179 293a 0d0a 2020 2020  .ndarray):..    
+000222d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222e0: 2020 2020 7061 7261 6d73 5b70 5d20 3d20      params[p] = 
+000222f0: 6765 7461 7474 7228 7365 6c66 2c20 702c  getattr(self, p,
+00022300: 204e 6f6e 6529 2e74 6f6c 6973 7428 290d   None).tolist().
+00022310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022320: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00022330: 616e 6365 2867 6574 6174 7472 2873 656c  ance(getattr(sel
+00022340: 662c 2070 2c20 4e6f 6e65 292c 206e 702e  f, p, None), np.
+00022350: 6474 7970 6529 3a0d 0a20 2020 2020 2020  dtype):..       
+00022360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022370: 2070 6172 616d 735b 705d 203d 2073 7472   params[p] = str
+00022380: 2867 6574 6174 7472 2873 656c 662c 2070  (getattr(self, p
+00022390: 2c20 4e6f 6e65 2929 0d0a 2020 2020 2020  , None))..      
+000223a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000223b0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+000223c0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+000223d0: 616d 735b 705d 203d 2067 6574 6174 7472  ams[p] = getattr
+000223e0: 2873 656c 662c 2070 2c20 4e6f 6e65 290d  (self, p, None).
+000223f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00022400: 7061 7261 6d73 0d0a 0d0a 2020 2020 4070  params....    @p
+00022410: 6172 616d 732e 7365 7474 6572 0d0a 2020  arams.setter..  
+00022420: 2020 6465 6620 7061 7261 6d73 2873 656c    def params(sel
+00022430: 662c 2070 6172 616d 733a 2064 6963 7420  f, params: dict 
+00022440: 3d20 7b7d 293a 0d0a 2020 2020 2020 2020  = {}):..        
+00022450: 2320 6974 6572 6174 696e 6720 7365 6c66  # iterating self
+00022460: 2e70 6172 616d 7320 656e 7375 7265 7320  .params ensures 
+00022470: 7468 6174 206f 6e6c 7920 7072 6f70 6572  that only proper
+00022480: 6965 7320 7769 7468 2061 2073 6574 7465  ies with a sette
+00022490: 7220 6d65 7468 6f64 2061 7265 2073 6574  r method are set
+000224a0: 0d0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
+000224b0: 5f6f 6c64 203d 2073 656c 662e 7061 7261  _old = self.para
+000224c0: 6d73 2e63 6f70 7928 290d 0a20 2020 2020  ms.copy()..     
+000224d0: 2020 2066 6f72 206b 2c20 7620 696e 2070     for k, v in p
+000224e0: 6172 616d 735f 6f6c 642e 6974 656d 7328  arams_old.items(
+000224f0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00022500: 6966 206b 2069 6e20 7061 7261 6d73 2061  if k in params a
+00022510: 6e64 206b 2021 3d20 2254 223a 0d0a 2020  nd k != "T":..  
+00022520: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00022530: 7461 7474 7228 7365 6c66 2c20 6b2c 2070  tattr(self, k, p
+00022540: 6172 616d 735b 6b5d 290d 0a0d 0a20 2020  arams[k])....   
+00022550: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+00022560: 2073 656c 662e 7061 7261 6d73 2e69 7465   self.params.ite
+00022570: 6d73 2829 3a0d 0a20 2020 2020 2020 2020  ms():..         
+00022580: 2020 2069 6620 6b20 696e 2070 6172 616d     if k in param
+00022590: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+000225a0: 2020 2020 6966 206b 2069 6e20 224e 6c76      if k in "Nlv
+000225b0: 6622 2061 6e64 206e 702e 6172 7261 7928  f" and np.array(
+000225c0: 7629 2e6e 6469 6d20 213d 206e 702e 6172  v).ndim != np.ar
+000225d0: 7261 7928 7061 7261 6d73 5b6b 5d29 2e6e  ray(params[k]).n
+000225e0: 6469 6d3a 0d0a 2020 2020 2020 2020 2020  dim:..          
+000225f0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00022600: 206e 702e 6172 7261 795f 6571 7561 6c28   np.array_equal(
+00022610: 762c 2070 6172 616d 735b 6b5d 5b30 5d29  v, params[k][0])
+00022620: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00022630: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00022640: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00022650: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00022660: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00022670: 6e6f 7420 6e70 2e61 7272 6179 5f65 7175  not np.array_equ
+00022680: 616c 2876 2c20 7061 7261 6d73 5b6b 5d29  al(v, params[k])
+00022690: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000226a0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000226b0: 0d0a 2020 2020 2020 2020 656c 7365 3a20  ..        else: 
+000226c0: 2023 2065 6c73 6520 636c 6175 7365 2065   # else clause e
+000226d0: 7865 6375 7465 7320 6f6e 6c79 2061 6674  xecutes only aft
+000226e0: 6572 2074 6865 206c 6f6f 7020 636f 6d70  er the loop comp
+000226f0: 6c65 7465 7320 6e6f 726d 616c 6c79 2c20  letes normally, 
+00022700: 692e 652e 2064 6964 206e 6f74 2065 6e63  i.e. did not enc
+00022710: 6f75 6e74 6572 2061 2062 7265 616b 0d0a  ounter a break..
+00022720: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00022730: 726e 0d0a 0d0a 2020 2020 2020 2020 6c6f  rn....        lo
+00022740: 6767 696e 672e 7761 726e 696e 6728 6622  gging.warning(f"
+00022750: 277b 6b7d 2720 676f 7420 6f76 6572 7772  '{k}' got overwr
+00022760: 6974 7465 6e20 6279 2069 6e74 6572 6465  itten by interde
+00022770: 7065 6e64 656e 6369 6573 2e20 4368 6f6f  pendencies. Choo
+00022780: 7365 2061 2063 6f6e 7369 7374 656e 7420  se a consistent 
+00022790: 7061 7261 6d65 7465 7220 7365 742e 2229  parameter set.")
+000227a0: 0d0a 2020 2020 2020 2020 7365 6c66 2e70  ..        self.p
+000227b0: 6172 616d 7320 3d20 7061 7261 6d73 5f6f  arams = params_o
+000227c0: 6c64 0d0a 0d0a 2020 2020 7479 7065 733a  ld....    types:
+000227d0: 2064 6963 7420 3d20 6469 6374 2873 6f72   dict = dict(sor
+000227e0: 7465 6428 5f5f 696e 6974 5f5f 2e5f 5f61  ted(__init__.__a
+000227f0: 6e6e 6f74 6174 696f 6e73 5f5f 2e69 7465  nnotations__.ite
+00022800: 6d73 2829 2929 0d0a 2020 2020 2222 2254  ms()))..    """T
+00022810: 7970 6573 206f 6620 2770 6172 616d 7327  ypes of 'params'
+00022820: 2076 616c 7565 732e 2222 220d 0a0d 0a20   values.""".... 
+00022830: 2020 2064 6566 6175 6c74 733a 2064 6963     defaults: dic
+00022840: 7420 3d20 6469 6374 2873 6f72 7465 6428  t = dict(sorted(
+00022850: 5f5f 696e 6974 5f5f 2e5f 5f6b 7764 6566  __init__.__kwdef
+00022860: 6175 6c74 735f 5f2e 6974 656d 7328 2929  aults__.items())
+00022870: 290d 0a20 2020 2022 2222 4465 6661 756c  )..    """Defaul
+00022880: 7420 7661 6c75 6573 2066 6f72 2060 7061  t values for `pa
+00022890: 7261 6d73 602e 2222 220d 0a0d 0a20 2020  rams`."""....   
+000228a0: 2067 6c6f 7373 6172 793a 2064 6963 7420   glossary: dict 
+000228b0: 3d20 7b0d 0a20 2020 2020 2020 206b 3a20  = {..        k: 
+000228c0: 762e 5f5f 646f 635f 5f20 666f 7220 6b2c  v.__doc__ for k,
+000228d0: 2076 2069 6e20 736f 7274 6564 2876 6172   v in sorted(var
+000228e0: 7328 292e 6974 656d 7328 2929 2069 6620  s().items()) if 
+000228f0: 6e6f 7420 6b2e 7374 6172 7473 7769 7468  not k.startswith
+00022900: 2822 5f22 2920 616e 6420 6973 696e 7374  ("_") and isinst
+00022910: 616e 6365 2876 2c20 7072 6f70 6572 7479  ance(v, property
+00022920: 290d 0a20 2020 207d 0d0a 2020 2020 2222  )..    }..    ""
+00022930: 2247 6c6f 7373 6172 792e 2222 220d 0a20  "Glossary.""".. 
+00022940: 2020 2023 2061 6e64 2076 2e5f 5f64 6f63     # and v.__doc
+00022950: 5f5f 0d0a 0d0a 2020 2020 2320 7265 7374  __....    # rest
+00022960: 7269 6374 2069 6e73 7461 6e63 6520 6174  rict instance at
+00022970: 7472 6962 7574 6573 2074 6f20 7468 6520  tributes to the 
+00022980: 6f6e 6573 206c 6973 7465 6420 6865 7265  ones listed here
+00022990: 0d0a 2020 2020 2320 2863 6f6d 6d65 6e64  ..    # (commend
+000229a0: 2074 6865 206e 6578 7420 6c69 6e65 206f   the next line o
+000229b0: 7574 2074 6f20 7072 6576 656e 7420 7468  ut to prevent th
+000229c0: 6973 290d 0a20 2020 205f 5f73 6c6f 7473  is)..    __slots
+000229d0: 5f5f 203d 2074 7570 6c65 2822 5f22 202b  __ = tuple("_" +
+000229e0: 206b 2066 6f72 206b 2069 6e20 6465 6661   k for k in defa
+000229f0: 756c 7473 2e6b 6579 7328 2920 6966 206b  ults.keys() if k
+00022a00: 206e 6f74 2069 6e20 2248 4d54 6c41 4222   not in "HMTlAB"
+00022a10: 2920 2b20 2822 6c6f 6767 6572 222c 2022  ) + ("logger", "
+00022a20: 5f55 4d52 222c 2022 5f74 2229 0d0a 0d0a  _UMR", "_t")....
+00022a30: 2020 2020 2320 636f 6e74 696e 7569 6e67      # continuing
+00022a40: 2074 6865 2063 6c61 7373 2064 6f63 7374   the class docst
+00022a50: 7269 6e67 2066 6f6c 6c6f 7769 6e67 2074  ring following t
+00022a60: 6865 204e 756d 5079 2073 7479 6c65 2067  he NumPy style g
+00022a70: 7569 6465 3a0d 0a20 2020 2023 2068 7474  uide:..    # htt
+00022a80: 7073 3a2f 2f6e 756d 7079 646f 632e 7265  ps://numpydoc.re
+00022a90: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
+00022aa0: 6c61 7465 7374 2f66 6f72 6d61 742e 6874  latest/format.ht
+00022ab0: 6d6c 2363 6c61 7373 2d64 6f63 7374 7269  ml#class-docstri
+00022ac0: 6e67 0d0a 2020 2020 5f5f 646f 635f 5f20  ng..    __doc__ 
+00022ad0: 2b3d 2022 5c6e 5c6e 5061 7261 6d65 7465  += "\n\nParamete
+00022ae0: 7273 5c6e 2d2d 2d2d 2d2d 2d2d 2d2d 220d  rs\n----------".
+00022af0: 0a20 2020 205f 5f64 6f63 5f5f 202b 3d20  .    __doc__ += 
+00022b00: 225c 6e2a 6172 6773 203a 2069 7465 7261  "\n*args : itera
+00022b10: 626c 655c 6e20 2020 204e 6f6e 2d6b 6579  ble\n    Non-key
+00022b20: 776f 7264 2061 7267 756d 656e 7473 2061  word arguments a
+00022b30: 7265 2065 7870 6c69 6369 746c 7920 6469  re explicitly di
+00022b40: 7363 6172 6465 642e 220d 0a20 2020 205f  scarded."..    _
+00022b50: 5f64 6f63 5f5f 202b 3d20 225c 6e20 2020  _doc__ += "\n   
+00022b60: 204f 6e6c 7920 6b65 7977 6f72 6420 6172   Only keyword ar
+00022b70: 6775 6d65 6e74 7320 6172 6520 636f 6e73  guments are cons
+00022b80: 6964 6572 6564 2e22 0d0a 2020 2020 666f  idered."..    fo
+00022b90: 7220 5f5f 6b2c 205f 5f76 2069 6e20 5f5f  r __k, __v in __
+00022ba0: 696e 6974 5f5f 2e5f 5f6b 7764 6566 6175  init__.__kwdefau
+00022bb0: 6c74 735f 5f2e 6974 656d 7328 293a 0d0a  lts__.items():..
+00022bc0: 2020 2020 2020 2020 2320 646f 2074 6869          # do thi
+00022bd0: 7320 696e 2066 6f72 206c 6f6f 7020 696e  s in for loop in
+00022be0: 7374 6561 6420 6f66 206c 6973 7420 636f  stead of list co
+00022bf0: 6d70 7265 6865 6e73 696f 6e2c 0d0a 2020  mprehension,..  
+00022c00: 2020 2020 2020 2320 6265 6361 7573 6520        # because 
+00022c10: 666f 7220 7468 6520 6c61 7474 6572 2c20  for the latter, 
+00022c20: 6e61 6d65 7320 696e 2063 6c61 7373 2073  names in class s
+00022c30: 636f 7065 2061 7265 206e 6f74 2061 6363  cope are not acc
+00022c40: 6573 7369 626c 650d 0a20 2020 2020 2020  essible..       
+00022c50: 205f 5f64 6f63 5f5f 202b 3d20 6622 5c6e   __doc__ += f"\n
+00022c60: 7b5f 5f6b 7d20 3a20 7b74 7970 6573 5b5f  {__k} : {types[_
+00022c70: 5f6b 5d7d 2c20 6465 6661 756c 7420 3d20  _k]}, default = 
+00022c80: 7b5f 5f76 7d5c 6e20 2020 207b 676c 6f73  {__v}\n    {glos
+00022c90: 7361 7279 5b5f 5f6b 5d2e 7370 6c69 746c  sary[__k].splitl
+00022ca0: 696e 6573 2829 5b30 5d7d 220d 0a20 2020  ines()[0]}"..   
+00022cb0: 2023 205f 5f64 6f63 5f5f 202b 3d20 225c   # __doc__ += "\
+00022cc0: 6e5c 6e41 7474 7269 6275 7465 735c 6e2d  n\nAttributes\n-
+00022cd0: 2d2d 2d2d 2d2d 2d2d 2d22 0d0a 2020 2020  ---------"..    
+00022ce0: 2320 666f 7220 5f5f 6b2c 205f 5f76 2069  # for __k, __v i
+00022cf0: 6e20 736f 7274 6564 2876 6172 7328 292e  n sorted(vars().
+00022d00: 6974 656d 7328 2929 3a0d 0a20 2020 2023  items()):..    #
+00022d10: 2020 2020 2023 2064 6f20 7468 6973 2069       # do this i
+00022d20: 6e20 666f 7220 6c6f 6f70 2069 6e73 7465  n for loop inste
+00022d30: 6164 206f 6620 6c69 7374 2063 6f6d 7072  ad of list compr
+00022d40: 6568 656e 7369 6f6e 2c0d 0a20 2020 2023  ehension,..    #
+00022d50: 2020 2020 2023 2062 6563 6175 7365 2066       # because f
+00022d60: 6f72 2074 6865 206c 6174 7465 722c 206e  or the latter, n
+00022d70: 616d 6573 2069 6e20 636c 6173 7320 7363  ames in class sc
+00022d80: 6f70 6520 6172 6520 6e6f 7420 6163 6365  ope are not acce
+00022d90: 7373 6962 6c65 0d0a 2020 2020 2320 2020  ssible..    #   
+00022da0: 2020 6966 205f 5f6b 206e 6f74 2069 6e20    if __k not in 
+00022db0: 6465 6661 756c 7473 2061 6e64 206e 6f74  defaults and not
+00022dc0: 205f 5f6b 2e73 7461 7274 7377 6974 6828   __k.startswith(
+00022dd0: 225f 2229 2061 6e64 2069 7369 6e73 7461  "_") and isinsta
+00022de0: 6e63 6528 5f5f 762c 2070 726f 7065 7274  nce(__v, propert
+00022df0: 7929 3a0d 0a20 2020 2023 2020 2020 2020  y):..    #      
+00022e00: 2020 205f 5f64 6f63 5f5f 202b 3d20 6622     __doc__ += f"
+00022e10: 5c6e 7b5f 5f6b 7d20 3a20 7b74 7970 6528  \n{__k} : {type(
+00022e20: 5f5f 7629 7d22 0d0a 2020 2020 2320 5f5f  __v)}"..    # __
+00022e30: 646f 635f 5f20 2b3d 2022 5c6e 7479 7065  doc__ += "\ntype
+00022e40: 7320 3a20 6469 6374 220d 0a20 2020 2023  s : dict"..    #
+00022e50: 205f 5f64 6f63 5f5f 202b 3d20 225c 6e64   __doc__ += "\nd
+00022e60: 6566 6175 6c74 7320 3a20 6469 6374 220d  efaults : dict".
+00022e70: 0a20 2020 2023 205f 5f64 6f63 5f5f 202b  .    # __doc__ +
+00022e80: 3d20 225c 6e67 6c6f 7373 6172 7920 3a20  = "\nglossary : 
+00022e90: 6469 6374 220d 0a20 2020 2023 205f 5f64  dict"..    # __d
+00022ea0: 6f63 5f5f 202b 3d20 6622 5c6e 6c6f 6767  oc__ += f"\nlogg
+00022eb0: 6572 203a 204c 6f67 6765 722c 2064 6566  er : Logger, def
+00022ec0: 6175 6c74 203d 206c 6f67 6765 722e 6765  ault = logger.ge
+00022ed0: 744c 6f67 6765 7228 7b5f 5f71 7561 6c6e  tLogger({__qualn
+00022ee0: 616d 655f 5f7d 2922 2020 2320 746f 646f  ame__})"  # todo
+00022ef0: 0d0a 2020 2020 2320 5f5f 646f 635f 5f20  ..    # __doc__ 
+00022f00: 2b3d 2022 5c6e 2020 2020 6874 7470 733a  += "\n    https:
+00022f10: 2f2f 646f 6373 2e70 7974 686f 6e2e 6f72  //docs.python.or
+00022f20: 672f 332f 6c69 6272 6172 792f 6c6f 6767  g/3/library/logg
+00022f30: 696e 672e 6874 6d6c 236c 6f67 6765 722d  ing.html#logger-
+00022f40: 6f62 6a65 6374 7322 0d0a 2020 2020 2320  objects"..    # 
+00022f50: 5f5f 646f 635f 5f20 2b3d 2022 5c6e 5c6e  __doc__ += "\n\n
+00022f60: 4d65 7468 6f64 735c 6e2d 2d2d 2d2d 2d2d  Methods\n-------
+00022f70: 220d 0a20 2020 2023 205f 5f64 6f63 5f5f  "..    # __doc__
+00022f80: 202b 3d20 6622 5c6e 656e 636f 6465 5c6e   += f"\nencode\n
+00022f90: 2020 2020 7b65 6e63 6f64 652e 5f5f 646f      {encode.__do
+00022fa0: 635f 5f2e 7370 6c69 746c 696e 6573 2829  c__.splitlines()
+00022fb0: 5b30 5d7d 220d 0a20 2020 2023 205f 5f64  [0]}"..    # __d
+00022fc0: 6f63 5f5f 202b 3d20 6622 5c6e 6465 636f  oc__ += f"\ndeco
+00022fd0: 6465 5c6e 2020 2020 7b64 6563 6f64 652e  de\n    {decode.
+00022fe0: 5f5f 646f 635f 5f2e 7370 6c69 746c 696e  __doc__.splitlin
+00022ff0: 6573 2829 5b30 5d7d 220d 0a20 2020 2064  es()[0]}"..    d
+00023000: 656c 205f 5f6b 2c20 5f5f 760d 0a         el __k, __v..
```

### Comparing `fringes-1.0.0/fringes/grid.py` & `fringes-1.1.0/fringes/grid.py`

 * *Files identical despite different names*

### Comparing `fringes-1.0.0/fringes/util.py` & `fringes-1.1.0/fringes/util.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 import time
 import typing as tp
 import itertools as it
-import logging as lg
+import logging
 
 import numpy as np
 import numba as nb
 import scipy as sp
 
 # import sympy.ntheory.generate
 import skimage as ski
@@ -142,56 +142,60 @@
 #     if d > dmax:
 #         d -= c
 #     elif d < -dmax:
 #         d += c
 #     return d
 
 
-def curvature(s: np.ndarray, calibrated: bool = False, map: bool = True) -> np.ndarray:  # todo: test
-    """Curvature map.
+def curvature(s: np.ndarray, calibrated: bool = False, normalize: bool = True) -> np.ndarray:  # todo: test
+    """Mean curvature map.
 
     Combuted by differentiating a slope map.
 
     Parameters
     ----------
     s : np.ndarray
         Slope map.
         It is reshaped to videoshape (frames 'T', height 'Y', width 'X', color channels 'C') before processing.
     calibrated : bool, optional
         Flag indicating whether the input data 's' originates from a calibrated measurement.
         Default is False.
         If this is False, the median value of the computed curvature map is added as an offset,
         so the median value of the final curvature map becomes zero.
-    map : bool
+    normalize : bool
         Flag indicating whether to use the acrtangent function
         to nonlinearly map the codomain from [-inf, inf] to [-1, 1].
         Default is True.
 
     Returns
     -------
     c : np.ndarray
         Curvature map.
     """
 
+    t0 = time.perf_counter()
+
     T, Y, X, C = vshape(s).shape
     s = s.reshape(T, Y, X, C)  # returns a view
 
-    assert T == 2, "More than 2 directions."
+    assert T == 2, "Number of direction doesn't equal 2."
     assert X >= 2 and Y >= 2, "Shape too small to calculate numerical gradient."
 
     c = np.gradient(s[0], axis=0) + np.gradient(s[0], axis=1) + np.gradient(s[1], axis=0) + np.gradient(s[1], axis=1)
 
     if not calibrated:
         # c -= np.mean(c, axis=(0, 1))
         c -= np.median(c, axis=(0, 1))  # Median is a robust estimator for the mean.
 
     if map:
         c = np.arctan(c) * 2 / np.pi  # scale [-inf, inf] to [-1, 1]
 
-    return c
+    logging.debug(f"{1000 * (time.perf_counter() - t0)}ms")
+
+    return c.reshape(-1, Y, X, C)
 
 
 def height(curv: np.ndarray, iterations: int = 3) -> np.ndarray:  # todo: test
     """Local height map.
 
     It is computed by iterative local integration via an inverse laplace filter.
     Think of it as a relief, where height is only relative to the local neighborhood.
@@ -207,14 +211,16 @@
 
     Returns
     -------
     z : np.ndarray
         Local height map.
     """
 
+    t0 = time.perf_counter()
+
     k = np.array([[0, 1, 0], [1, 0, 1], [0, 1, 0]], np.float32)
     # k *= iterations  # todo
 
     T, Y, X, C = vshape(curv).shape
     curv = curv.reshape(T, Y, X, C)  # returns a view
 
     if T == 1:
@@ -227,14 +233,16 @@
     for c in range(C):
         for i in range(iterations):
             z[..., c] = (cv2.filter2D(z[..., c], -1, k) - curv[..., c]) / 4
 
     # todo: residuals
     # filter2(kernel_laplace, z) - cature;
 
+    logging.debug(f"{1000 * (time.perf_counter() - t0)}ms")
+
     return z
 
 
 def bilateral(I: np.ndarray, k: int = 7) -> np.ndarray:  # todo: test
     """Bilateral filter.
 
     Edge-preserving, denoising filter.
@@ -250,61 +258,31 @@
 
     Returns
     -------
     out : np.ndarray
         Filtered data.
     """
 
+    t0 = time.perf_counter()
+
     T, Y, X, C = vshape(I).shape
     I = I.reshape(T, Y, X, C)
     out = np.empty_like(I)
 
     for t in range(T):
         if C in [1, 3]:
             rv = ski.restoration.denoise_bilateral(I[t], win_size=k, sigma_spatial=1, channel_axis=-1)
             out[t] = rv if C == 3 else rv[..., None]
             # out[t] = cv2.bilateralFilter(I[t], d=k, sigmaColor=np.std(I[t]), sigmaSpace=1)
         else:
             for c in range(C):
                 out[t, :, :, c] = ski.restoration.denoise_bilateral(I[t, :, :, c], win_size=k, sigma_spatial=1)
                 # out[t, :, :, c] = cv2.bilateralFilter(I[t], d=k, sigmaColor=np.std(I[t, :, :, c]), sigmaSpace=1)
 
-    return out
-
-
-def median(I: np.ndarray, k: int = 3) -> np.ndarray:  # todo: test
-    """Median filter.
-
-    Removes salt and pepper noise.
-
-    Parameters
-    ----------
-    I : np.ndarray
-        Input data.
-        It is reshaped to videoshape (frames 'T', height 'Y', width 'X', color channels 'C') before processing.
-    k : int, optional
-        Size of the filter kernel.
-        Default is 3.
-
-    Returns
-    -------
-    out : np.ndarray
-        Filtered data.
-    """
-
-    T, Y, X, C = vshape(I).shape
-    I = I.reshape(T, Y, X, C)
-    out = np.empty_like(I)
-
-    for t in range(T):
-        for c in range(C):
-            if 5 >= k > 1 == k % 2 and I.dtype == np.uint8:  # use opencv for faster performance
-                out[t, :, :, c] = cv2.medianBlur(I[t, :, :, c], k=k)
-            else:
-                out[t, :, :, c] = sp.ndimage.median_filter(I[t, :, :, c], size=(k, k), mode="nearest")
+    logging.debug(f"{1000 * (time.perf_counter() - t0)}ms")
 
     return out
 
 
 @nb.jit(cache=True, nopython=True, nogil=True, parallel=True, fastmath=True)
 def _remap_legacy(
     reg: np.ndarray,
@@ -390,90 +368,194 @@
 
     for xc in nb.prange(Xc):
         for yc in nb.prange(Yc):
             for c in nb.prange(Cs):
                 if not np.isnan(reg[0, yc, xc, c]):
                     xs = int(reg[0, yc, xc, c] + 0.5)  # i.e. rint()
 
-                    if not np.isnan(reg[1, yc, xc, c]):
-                        ys = int(reg[1, yc, xc, c] + 0.5)  # i.e. rint()
+                    if xs < Xs:
+                        if not np.isnan(reg[1, yc, xc, c]):
+                            ys = int(reg[1, yc, xc, c] + 0.5)  # i.e. rint()
 
-                        # if mod.ndim > 1:
-                        #     m = mod[yc, xc, c]
-                        #     if not np.isnan(m):
-                        #         src[ys, xs, c] += m
-                        # else:
-                        #     src[ys, xs, c] += 1
-
-                        m = mod[yc, xc, c]
-                        if not np.isnan(m):
-                            src[ys, xs, c] += m
+                            if ys < Ys:
+                                # if mod.ndim > 1 and not np.isnan(mod[yc, xc, c]):  # todo: test shape
+                                #     m = mod[yc, xc, c]
+                                #     src[ys, xs, c] += m
+                                # else:
+                                #     src[ys, xs, c] += 1
+
+                                if not np.isnan(mod[yc, xc, c]):
+                                    m = mod[yc, xc, c]
+                                    src[ys, xs, c] += m
     return src
 
 
-# @nb.jit(cache=True, nopython=True, nogil=True, parallel=True, fastmath=True)  # todo
-def filter(combos, K, L, lmin):
-    kroot = L ** (1 / K)
-    if lmin <= kroot:
-        lcombos = np.array([l for l in combos if np.any(l > kroot) and np.lcm.reduce(l) >= L])
-    else:
-        lcombos = np.array([l for l in combos if np.lcm.reduce(l) >= L])
-
-    return lcombos
-
-
-def coprime(n: list[int] | tuple[int] | np.ndarray) -> bool:  # n: iterable  # todo: extend to rational numbers
-    """Test whether numbers are pairwise co-prime.
-
-    Parameters
-    ----------
-    n : list, tuple, np.ndarray
-        Integer numbers.
-
-    Returns
-    -------
-    iscoprime : bool
-        True if numbers are pairwise co-prime, else False.
-    """
-
-    n = np.array(n).ravel()  # return view
-
-    if n.size == 0:  # check whether iterable has entries
-        return False
-
-    if not np.all([i % 1 == 0 for i in n]):  # check whether numbers are integers
-        return False
-
-    if n.dtype != int:  # convert numbers to integers
-        n = n.astype(int, copy=True)  # return copy
-
-    for i in range(n.size):  # each combination; number of combinations = n.size * (n.size - 1) / 2
-        for j in range(i + 1, n.size):
-            if n[j] == 1 or np.gcd(n[i], n[j]) != 1:
-                return False
-
-    # alternatively: np.lcm.reduce(n) == np.prod(n)
-
-    return True
+# # @nb.jit(cache=True, nopython=True, nogil=True, parallel=True, fastmath=True)  # todo
+# def filter(combos, K, L, lmin):
+#     kroot = L ** (1 / K)
+#     if lmin <= kroot:
+#         lcombos = np.array([l for l in combos if np.any(l > kroot) and np.lcm.reduce(l) >= L])
+#     else:
+#         lcombos = np.array([l for l in combos if np.lcm.reduce(l) >= L])
+#
+#     return lcombos
+#
+#
+# def coprime(n: list[int] | tuple[int] | np.ndarray) -> bool:  # n: iterable  # todo: extend to rational numbers
+#     """Test whether numbers are pairwise co-prime.
+#
+#     Parameters
+#     ----------
+#     n : list, tuple, np.ndarray
+#         Integer numbers.
+#
+#     Returns
+#     -------
+#     iscoprime : bool
+#         True if numbers are pairwise co-prime, else False.
+#     """
+#
+#     # convert to array and flatten
+#     n = np.array(n).ravel()  # returns a view
+#
+#     # check whether iterable has entries
+#     if n.size == 0:
+#         return False
+#
+#     # check whether numbers are integers
+#     if not np.all([i % 1 == 0 for i in n]):
+#         return False
+#
+#     # ensure numbers are integers
+#     if n.dtype != int:
+#         n = n.astype(int, copy=False)
+#
+#     # check pairwise for coprimality, i.e. gcd(a, b) == 1
+#     for i in range(n.size):  # each combination; number of combinations = n.size * (n.size - 1) / 2
+#         for j in range(i + 1, n.size):
+#             if np.gcd(n[i], n[j]) != 1:
+#                 return False
+#
+#     # alternatively: np.lcm.reduce(n) == np.prod(n)
+#
+#     return True
+#
+#
+# def extgcd(a, b):
+#     """Erweiterter euklidischer Algorithmus.
+#
+#     https://hwlang.de/krypto/algo/euklid-erweitert.htm
+#
+#     Parameters
+#     ----------
+#     a : int
+#         Ganzzahl.
+#
+#     b : int
+#         Ganzzahl.
+#
+#     Returns
+#     -------
+#     a : int
+#         Größter gemeinsamer Teiler von 'a' und 'b'.
+#
+#     u : int
+#         Koeffizienten 'u' und 'v' einer Darstellung von 'a' als ganzzahlige Linearmbination.
+#
+#     v : int
+#         Koeffizienten 'u' und 'v' einer Darstellung von 'a' als ganzzahlige Linearmbination.
+#     """
+#
+#     u, v, s, t = 1, 0, 0, 1
+#     while b != 0:
+#         q = a // b
+#         a, b = b, a - q * b
+#         u, s = s, u - q * s
+#         v, t = t, v - q * t
+#     return a, u, v
+#
+#
+# def modinverse(a, n):
+#     """Berechnet das multiplikativ inverse Element von a modulo n.
+#
+#     https://hwlang.de/krypto/grund/inverses-element.htm
+#
+#     Parameters
+#     ----------
+#     a : int
+#         Ganzzahl.
+#
+#     n : int
+#         Modul.
+#
+#     Returns
+#     -------
+#     mi : int
+#         Multiplikativ inverse Element von 'a' modulo 'n'.
+#     """
+#
+#     g, u, v = extgcd(a, n)
+#     return u % n
+#
+#
+# def chineseRemainder(nn, rr):
+#     """Chinesischer-Restsatz-Algorithmus.
+#
+#     Der Vorteil dieser Implementierung nach dem Divide-and-Conquer-Prinzip besteht darin,
+#     dass in den unteren Rekursionsebenen viele Berechnungen mit kleinen Zahlen stattfinden
+#     und erst in den oberen Rekursionsebenen wenige Berechnungen mit großen Zahlen.
+#
+#     https://hwlang.de/krypto/algo/chinese-remainder.htm
+#
+#     Parameters
+#     ----------
+#     nn : np.ndarray, list
+#         Liste paarweise teilerfremder Moduln.
+#
+#     rr : np.ndarray, list
+#         Liste der Reste.
+#
+#     Returns
+#     -------
+#     mn : int
+#         Produkt der Moduln.
+#
+#     x : int
+#         Zahl x nach dem chinesischen Restsatz.
+#     """
+#
+#     if len(nn) == 1:
+#         return nn[0], rr[0]
+#     else:
+#         k = len(nn) // 2
+#         m, a = chineseRemainder(nn[:k], rr[:k])
+#         n, b = chineseRemainder(nn[k:], rr[k:])
+#         g, u, v = extgcd(m, n)
+#         x = (b - a) * u % n * m + a
+#         return m * n, x
+#
+#
+# def modinv(x, p):
+#     """Modular multiplicative inverse.
+#
+#     y = invmod(x, p) such that x*y == 1 (mod p)
+#
+#     https://bugs.python.org/issue36027
+#
+#     Parameters
+#     ----------
+#
+#     x : int
+#         Integer.
+#
+#     p : int
+#         Modul.
+#
+#     Returns
+#     -------
+#     y : Modular multiplicative inverse.
+#     """
+#     return pow(x, -1, p)
 
 
 if __name__ == "__main__":
-    l = np.array([29, 31])
-    # l = np.array([9, 10, 11])
-    # l = np.array([12, 17, 19])
-    # l = np.array([4, 5, 7])
-    X = 1920
-    v = X // l
-
-    # l = v
-    m = coefficients(l)  # todo: numba, LUT?
-    x = 35
-    p = x % l
-    crtOK = np.lcm.reduce(l) == np.prod(l)
-    i, f = np.divmod(p, 1)  # integer and fractional part
-    umr = np.prod(l)  # np.lcm.reduce(l)
-    lcm = np.lcm.reduce(l)
-    x2 = np.sum(m * i) % umr + np.mean(f)
-    x3 = np.sum(m[::-1] * i) % umr + np.mean(f)
-    idx0 = x2 // l
-
-    a = 1
+    pass
```

#### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

### Comparing `fringes-1.0.0/LICENSE.txt` & `fringes-1.1.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `fringes-1.0.0/PKG-INFO` & `fringes-1.1.0/PKG-INFO`

 * *Files 27% similar despite different names*

```diff
@@ -1,60 +1,76 @@
 Metadata-Version: 2.1
-Name: fringes
-Version: 1.0.0
+Name: Fringes
+Version: 1.1.0
 Summary: Phase shifting algorithms for encoding and decoding sinusoidal fringe patterns.
 Home-page: https://github.com/comimag/fringes
 License: CC-BY-NC-SA-4.0
 Keywords: phase shifting,phase unwrapping,fringe analysis,fringe projection,deflectometry,computational imaging
 Author: Christian Kludt
 Requires-Python: >=3.9,<3.13
+Classifier: Intended Audience :: Education
+Classifier: Intended Audience :: Science/Research
 Classifier: License :: Other/Proprietary License
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
-Requires-Dist: asdf (>=2.14.3,<3.0.0)
-Requires-Dist: numba (>=0.58.1,<0.59.0)
+Classifier: Programming Language :: Python :: 3.12
+Classifier: Topic :: Scientific/Engineering :: Image Processing
+Requires-Dist: numba (==0.59.0)
 Requires-Dist: numpy (>=1.26.1,<2.0.0)
 Requires-Dist: opencv-contrib-python (>=4.7.0,<5.0.0)
 Requires-Dist: pyyaml (>=6.0,<7.0)
 Requires-Dist: scikit-image (>=0.22.0,<0.23.0)
 Requires-Dist: scipy (>=1.10.0,<2.0.0)
-Requires-Dist: si-prefix (>=1.2.2,<2.0.0)
 Requires-Dist: sympy (>=1.11.1,<2.0.0)
 Requires-Dist: toml (>=0.10.2,<0.11.0)
 Project-URL: Documentation, https://fringes.readthedocs.io
 Project-URL: Repository, https://github.com/comimag/fringes
 Description-Content-Type: text/markdown
 
 # Fringes
 [![PyPI](https://img.shields.io/pypi/v/fringes)](https://pypi.org/project/fringes/)
 ![PyPI - Python Version](https://img.shields.io/pypi/pyversions/fringes)
-[![Read the Docs](https://img.shields.io/readthedocs/fringes)](https://fringes.readthedocs.io)
 [![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)
+[![Read the Docs](https://img.shields.io/readthedocs/fringes)](https://fringes.readthedocs.io)
 [![PyPI - License](https://img.shields.io/pypi/l/fringes)](https://github.com/comimag/fringes/blob/main/LICENSE.txt)
+[![Static Badge](https://img.shields.io/badge/DOI-10.5281%2Fzenodo.10936353-blue)](https://zenodo.org/doi/10.5281/zenodo.10936353)
 [![PyPI - Downloads](https://img.shields.io/pypi/dm/fringes)](https://pypistats.org/packages/fringes)
-![Liberapay receiving](https://img.shields.io/liberapay/receives/comimag.svg?logo=liberapay)
-[![Static Badge](https://img.shields.io/badge/liberapay-donate-yellow?logo=liberapay)](https://liberapay.com/comimag/donate)
 
 <!---
-[![Liberapay](https://liberapay.com/assets/widgets/donate.svg)](https://liberapay.com/comimag/payment/)
+# todo: DOI
+![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/comimag/fringes/python-package.yml)
 ![GitHub top language](https://img.shields.io/github/languages/top/comimag/fringes)
-![GitHub issues](https://img.shields.io/github/issues/comimag/fringes)
+![https://img.shields.io/badge/python-%3E=3.9-blue](https://img.shields.io/badge/python-%3E=3.9-blue)
 ![GitHub](https://img.shields.io/github/license/comimag/fringes)
+[![Downloads](https://static.pepy.tech/badge/fringes)](https://pepy.tech/project/fringes)
 --->
 
 <!---
 link to  paper, please cite
 --->
 
-User-friendly tool to configure, encode and decode fringe patterns with phase shifting algorithms.
+Easily create customized fringe patterns
+and analyse them using phase shifting algorithms.
+
+![coding-cheme}](https://raw.githubusercontent.com/comimag/fringes/main/docs/getting_started/coding-scheme.gif)\
+Figure 1: Phase Shifting Coding Scheme.
 
-![Coding Scheme](https://raw.githubusercontent.com/comimag/fringes/main/docs/getting_started/coding-scheme.gif)\
-Phase Shift Coding Scheme.
+## Features
+- [Parameterize](https://fringes.readthedocs.io/en/latest/user_guide/params.html) the phase shifting algorithm
+- [Create](https://fringes.readthedocs.io/en/main/getting_started/fundamentals.html#encoding) and
+  [decode](https://fringes.readthedocs.io/en/main/getting_started/fundamentals.html#decoding)
+  customized fringe patterns
+- Generalized Temporal Phase Unwrapping (GTPU)
+- Uncertainty Propagation
+- [Optimal Coding Strategy](https://fringes.readthedocs.io/en/latest/user_guide/optimal.html)
+- [Multiplexing](https://fringes.readthedocs.io/en/latest/user_guide/mux.html)
+- Compute [curvature maps](https://fringes.readthedocs.io/en/latest/user_guide/filter.html#curvature)
+- Use many more [filter](https://fringes.readthedocs.io/en/latest/user_guide/filter.html) methods
 
 ## Installation
 You can install `fringes` directly from [PyPi](https://pypi.org/) via `pip`:
 
 ```
 pip install fringes
 ```
@@ -63,51 +79,75 @@
 You instantiate, parameterize and deploy the `Fringes` class:
 
 ```python
 import fringes as frng  # import module
 
 f = frng.Fringes()      # instantiate class
 
-f.glossary              # get glossary
 f.X = 1920              # set width of the fringe patterns
 f.Y = 1080              # set height of the fringe patterns
 f.K = 2                 # set number of sets
 f.N = 4                 # set number of shifts
 f.v = [9, 10]           # set spatial frequencies
 f.T                     # get number of frames
                             
 I = f.encode()          # encode fringe patterns
-A, B, x = f.decode(I)   # decode fringe patterns
+A, B, X = f.decode(I)   # decode fringe patterns
 ```
 
 All [parameters](https://fringes.readthedocs.io/en/latest/user_guide/params.html)
-are accesible by the respective attributes of the `Fringes` instance
-(a glossary of them is obtained by the attribute `glossary`).
-They are implemented as class properties (managed attributes).
-Note that some attributes have subdependencies, hence dependent attributes might change as well.
-Circular dependencies are resolved automatically.
-
-For generating the fringe pattern sequence `I`, use the method `encode()`.\
-It returns a [NumPy array](https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html) 
-in videoshape (frames `T`, width `X`, height `Y`, color channels `C`).
+are accesible as class properties (managed attributes) of the `Fringes` instance.
 
-For analyzing (recorded) fringe patterns, use the method `decode()`.\
+For generating the fringe pattern sequence `I`, use the method `encode()`.
+It returns a [NumPy array](https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html) in videoshape (frames, height, width, color channels).
+
+For analyzing (recorded) fringe patterns, use the method `decode()`.
 It returns the Numpy arrays brightness `A`, modulation `B` and coordinate `x`.
 
 > Note:\
 For the compitationally expensive ``decoding`` we make use of the just-in-time compiler [Numba](https://numba.pydata.org/).
 During the first execution, an initial compilation is executed. 
-This can take several tens of seconds up to single digit minutes, depending on your CPU.
+This can take several tens of seconds up to single digit minutes, depending on your CPU and energy settings.
 However, for any subsequent execution, the compiled code is cached and the code of the function runs much faster, 
 approaching the speeds of code written in C.
 
 ## Graphical User Interface
 Do you need a GUI? `Fringes` has a sister project which is called `Fringes-GUI`:
+
 https://pypi.org/project/fringes-gui/
 
 ## Documentation
 The documentation can be found here:
+
 https://fringes.readthedocs.io
 
 ## License
 Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International Public License
 
+## Citation
+If you use this software, please cite it using this DOI:
+[10.5281/zenodo.10936353](https://zenodo.org/doi/10.5281/zenodo.10936353)\
+This DOI represents all versions, i.e. the concept of this software package,
+and will always resolve to the latest one.
+
+If you want to cite a specific version,
+please choose the respective DOI from [Zenodo](https://zenodo.org/doi/10.5281/zenodo.10936353) yourself.
+
+## Support
+I was looking for a user-friendly tool to configure,
+encode and decode customized fringe patterns with phase shifting algorithms.
+Since I couldn't find any, I started developing one myself.
+It is intended for [non-commercial](#license), academic and educational use.
+
+However, I do this entirely in my free time.
+If you like this package and can make use of it, I would be happy about a donation.
+It will help me keep it up-to-date and adding more features in the future.
+
+<!---
+[![Liberapay](https://liberapay.com/assets/widgets/donate.svg)](https://liberapay.com/comimag/donate/)
+[![](https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif)](https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=EHBGZ229DKUC4)
+--->
+
+[![paypal](https://img.shields.io/badge/PayPal-00457C?style=for-the-badge&logo=PayPal&logoColor=white)](https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=EHBGZ229DKUC4)
+
+Thank you!
+
```

