# Comparing `tmp/pyfakefs-5.3.5.tar.gz` & `tmp/pyfakefs-5.4.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "pyfakefs-5.3.5.tar", last modified: Tue Jan 30 18:05:49 2024, max compression
+gzip compressed data, was "pyfakefs-5.4.0.tar", last modified: Sun Apr  7 07:12:53 2024, max compression
```

## Comparing `pyfakefs-5.3.5.tar` & `pyfakefs-5.4.0.tar`

### file list

```diff
@@ -1,81 +1,83 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:49.554745 pyfakefs-5.3.5/
--rw-r--r--   0 runner    (1001) docker     (127)    47540 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/CHANGES.md
--rw-r--r--   0 runner    (1001) docker     (127)     3403 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/CONTRIBUTING.md
--rw-r--r--   0 runner    (1001) docker     (127)    10142 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/COPYING
--rwxr-xr-x   0 runner    (1001) docker     (127)       57 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)     7717 2024-01-30 18:05:49.554745 pyfakefs-5.3.5/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     6103 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      801 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/extra_requirements.txt
--rw-r--r--   0 runner    (1001) docker     (127)      518 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/mypy.ini
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:49.546744 pyfakefs-5.3.5/pyfakefs/
--rwxr-xr-x   0 runner    (1001) docker     (127)       56 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)       22 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/_version.py
--rw-r--r--   0 runner    (1001) docker     (127)     1149 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/extra_packages.py
--rw-r--r--   0 runner    (1001) docker     (127)    45951 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_file.py
--rw-r--r--   0 runner    (1001) docker     (127)   120033 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_filesystem.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3755 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_filesystem_shutil.py
--rw-r--r--   0 runner    (1001) docker     (127)    45764 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_filesystem_unittest.py
--rw-r--r--   0 runner    (1001) docker     (127)     6821 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_io.py
--rw-r--r--   0 runner    (1001) docker     (127)    13379 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_open.py
--rw-r--r--   0 runner    (1001) docker     (127)    50658 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_os.py
--rw-r--r--   0 runner    (1001) docker     (127)    18285 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_path.py
--rw-r--r--   0 runner    (1001) docker     (127)    34826 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_pathlib.py
--rw-r--r--   0 runner    (1001) docker     (127)    11341 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/fake_scandir.py
--rw-r--r--   0 runner    (1001) docker     (127)    13183 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/helpers.py
--rw-r--r--   0 runner    (1001) docker     (127)     5393 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/mox3_stubout.py
--rw-r--r--   0 runner    (1001) docker     (127)     4405 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/patched_packages.py
--rw-r--r--   0 runner    (1001) docker     (127)       68 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/py.typed
--rw-r--r--   0 runner    (1001) docker     (127)     2280 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_plugin.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:49.546744 pyfakefs-5.3.5/pyfakefs/pytest_tests/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1333 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/conftest.py
--rw-r--r--   0 runner    (1001) docker     (127)      652 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/example.py
--rw-r--r--   0 runner    (1001) docker     (127)      346 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/io.py
--rw-r--r--   0 runner    (1001) docker     (127)      659 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_check_failed_plugin_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     1429 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_doctest_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     1891 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_fixture_param_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     2079 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_fixture_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     1043 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_module_fixture_test.py
--rw-r--r--   0 runner    (1001) docker     (127)      129 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_plugin_failing_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2381 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_plugin_test.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:49.554745 pyfakefs-5.3.5/pyfakefs/tests/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2502 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/all_tests.py
--rw-r--r--   0 runner    (1001) docker     (127)     1180 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/all_tests_without_extra_packages.py
--rw-r--r--   0 runner    (1001) docker     (127)     2093 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/dynamic_patch_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     3978 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/example.py
--rw-r--r--   0 runner    (1001) docker     (127)     6954 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/example_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     2587 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_glob_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    22226 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_shutil_test.py
--rw-r--r--   0 runner    (1001) docker     (127)   109743 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    34427 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_unittest_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    29625 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_vs_real_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    84326 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_open_test.py
--rw-r--r--   0 runner    (1001) docker     (127)   230931 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_os_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    50409 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_pathlib_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    22291 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_stat_time_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     4182 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fake_tempfile_test.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:49.554745 pyfakefs-5.3.5/pyfakefs/tests/fixtures/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fixtures/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)       37 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fixtures/config_module.py
--rw-r--r--   0 runner    (1001) docker     (127)     1047 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fixtures/deprecated_property.py
--rw-r--r--   0 runner    (1001) docker     (127)     1243 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/fixtures/module_with_attributes.py
--rw-r--r--   0 runner    (1001) docker     (127)     3183 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/import_as_example.py
--rw-r--r--   0 runner    (1001) docker     (127)      832 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/logsio.py
--rw-r--r--   0 runner    (1001) docker     (127)      892 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/mox3_stubout_example.py
--rw-r--r--   0 runner    (1001) docker     (127)     5363 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/mox3_stubout_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     2569 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/patched_packages_test.py
--rw-r--r--   0 runner    (1001) docker     (127)     2620 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/performance_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    16846 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyfakefs/tests/test_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-01-30 18:05:49.554745 pyfakefs-5.3.5/pyfakefs.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)     7717 2024-01-30 18:05:49.000000 pyfakefs-5.3.5/pyfakefs.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2264 2024-01-30 18:05:49.000000 pyfakefs-5.3.5/pyfakefs.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-01-30 18:05:49.000000 pyfakefs-5.3.5/pyfakefs.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       50 2024-01-30 18:05:49.000000 pyfakefs-5.3.5/pyfakefs.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)        9 2024-01-30 18:05:49.000000 pyfakefs-5.3.5/pyfakefs.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (127)       81 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       14 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/requirements.txt
--rw-r--r--   0 runner    (1001) docker     (127)       18 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/requirements_dev.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1779 2024-01-30 18:05:49.554745 pyfakefs-5.3.5/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)       69 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)      322 2024-01-30 18:05:35.000000 pyfakefs-5.3.5/tox.ini
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:53.179854 pyfakefs-5.4.0/
+-rw-r--r--   0 runner    (1001) docker     (127)    49615 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/CHANGES.md
+-rw-r--r--   0 runner    (1001) docker     (127)     3403 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/CONTRIBUTING.md
+-rw-r--r--   0 runner    (1001) docker     (127)    10142 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/COPYING
+-rwxr-xr-x   0 runner    (1001) docker     (127)       57 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)     7718 2024-04-07 07:12:53.179854 pyfakefs-5.4.0/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     6104 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      801 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/extra_requirements.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      518 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/mypy.ini
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:53.167855 pyfakefs-5.4.0/pyfakefs/
+-rwxr-xr-x   0 runner    (1001) docker     (127)       56 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)       22 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/_version.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1149 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/extra_packages.py
+-rw-r--r--   0 runner    (1001) docker     (127)    49019 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_file.py
+-rw-r--r--   0 runner    (1001) docker     (127)   123400 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_filesystem.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3756 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_filesystem_shutil.py
+-rw-r--r--   0 runner    (1001) docker     (127)    45083 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_filesystem_unittest.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6817 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_io.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14251 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_open.py
+-rw-r--r--   0 runner    (1001) docker     (127)    53434 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_os.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18284 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_path.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34844 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_pathlib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11364 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/fake_scandir.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13441 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/helpers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5393 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/mox3_stubout.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6591 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/patched_packages.py
+-rw-r--r--   0 runner    (1001) docker     (127)       68 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/py.typed
+-rw-r--r--   0 runner    (1001) docker     (127)     2280 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_plugin.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:53.171855 pyfakefs-5.4.0/pyfakefs/pytest_tests/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1333 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/conftest.py
+-rw-r--r--   0 runner    (1001) docker     (127)      652 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/example.py
+-rw-r--r--   0 runner    (1001) docker     (127)      346 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/io.py
+-rw-r--r--   0 runner    (1001) docker     (127)      659 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_check_failed_plugin_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1429 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_doctest_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1891 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_fixture_param_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2060 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_fixture_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1043 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_module_fixture_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)      128 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_plugin_failing_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2381 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_plugin_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)      619 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_reload_pandas_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)      390 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/pytest_tests/unhashable.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:53.175855 pyfakefs-5.4.0/pyfakefs/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2502 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/all_tests.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1180 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/all_tests_without_extra_packages.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/dynamic_patch_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4012 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/example.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6954 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/example_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2587 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_glob_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22626 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_shutil_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)   110189 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35456 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_unittest_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29767 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_vs_real_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    87621 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_open_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)   244617 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_os_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    52726 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_pathlib_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22479 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_stat_time_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4199 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fake_tempfile_test.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:53.179854 pyfakefs-5.4.0/pyfakefs/tests/fixtures/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fixtures/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)       37 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fixtures/config_module.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1048 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fixtures/deprecated_property.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1243 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/fixtures/module_with_attributes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3235 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/import_as_example.py
+-rw-r--r--   0 runner    (1001) docker     (127)      832 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/logsio.py
+-rw-r--r--   0 runner    (1001) docker     (127)      893 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/mox3_stubout_example.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5363 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/mox3_stubout_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2570 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/patched_packages_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2621 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/performance_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17536 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyfakefs/tests/test_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 07:12:53.179854 pyfakefs-5.4.0/pyfakefs.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)     7718 2024-04-07 07:12:53.000000 pyfakefs-5.4.0/pyfakefs.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2351 2024-04-07 07:12:53.000000 pyfakefs-5.4.0/pyfakefs.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-07 07:12:53.000000 pyfakefs-5.4.0/pyfakefs.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       50 2024-04-07 07:12:53.000000 pyfakefs-5.4.0/pyfakefs.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        9 2024-04-07 07:12:53.000000 pyfakefs-5.4.0/pyfakefs.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       81 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       14 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/requirements.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       18 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/requirements_dev.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1779 2024-04-07 07:12:53.179854 pyfakefs-5.4.0/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)       69 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)      322 2024-04-07 07:12:47.000000 pyfakefs-5.4.0/tox.ini
```

### Comparing `pyfakefs-5.3.5/CHANGES.md` & `pyfakefs-5.4.0/CHANGES.md`

 * *Files 2% similar despite different names*

```diff
@@ -1,29 +1,68 @@
 # pyfakefs Release Notes
 The released versions correspond to PyPI releases.
 
+## [Version 5.4.0](https://pypi.python.org/pypi/pyfakefs/5.4.0) (2024-04-07)
+Improves permission handling.
+
+### Changes
+* the handling of file permissions under Posix should now mostly match the behavior
+  of the real filesystem, which may change the behavior of some tests
+* removed the argument `module_cleanup_mode`, that was introduced as a temporary workaround
+  in the previous version - related problems shall be handled using a cleanup handler
+
+### Enhancements
+* added support for `O_NOFOLLOW` and `O_DIRECTORY` flags in `os.open`
+  (see [#972](../../issues/972) and [#974](../../issues/974))
+* added support for fake `os.dup`, `os.dup2` and `os.lseek` (see [#970](../../issues/970))
+
+### Fixes
+* fixed a specific problem on reloading a pandas-related module (see [#947](../../issues/947)),
+  added possibility for unload hooks for specific modules
+* use this also to reload django views (see [#932](../../issues/932))
+* fixed `EncodingWarning` for Python >= 3.11 (see [#957](../../issues/957))
+* consider directory ownership while adding or removing directory entries
+  (see [#959](../../issues/959))
+* fixed handling of directory enumeration and search permissions under Posix systems
+  (see [#960](../../issues/960))
+* fixed creation of the temp directory in the fake file system after a filesystem reset
+  (see [#965](../../issues/965))
+* fixed handling of `dirfd` in `os.symlink` (see [#968](../../issues/968))
+* add missing `follow_symlink` argument to `os.link` (see [#973](../../issues/973))
+* fixed handling of missing attribute in `os.getxattr` (see [#971](../../issues/971))
+* fixed permission problem with `shutil.rmtree` if emulating Windows under POSIX
+  (see [#979](../../issues/979))
+* fixed handling of errors on opening files via file descriptor (see [#967](../../issues/967))
+* fixed handling of `umask` - it is now applied by default
+* fixed behavior of `os.makedirs` (see [#987](../../issues/987))
+
+### Infrastructure
+* replace `undefined` by own minimal implementation to avoid importing it
+  (see [#981](../../discussions/981))
+
+
 ## [Version 5.3.5](https://pypi.python.org/pypi/pyfakefs/5.3.5) (2024-01-30)
 Fixes a regression.
 
 ### Fixes
-* Fixes a regression due to the changed behavior of the dynamic patcher cleanup (see [#939](../../issues/939)).
+* Fixed a regression due to the changed behavior of the dynamic patcher cleanup (see [#939](../../issues/939)).
   The change is now by default only made if the `django` module is loaded, and the behavior can
   be changed using the new argument `module_cleanup_mode`.
 
 ### Packaging
-* include `tox.ini` and a few more files into the source distribution (see [#937](../../issues/937))
+* included `tox.ini` and a few more files into the source distribution (see [#937](../../issues/937))
 
 ## [Version 5.3.4](https://pypi.python.org/pypi/pyfakefs/5.3.4) (2024-01-19)
 Bugfix release.
 
 ### Fixes
-* fixes handling of unhashable modules which cannot be cached (see [#923](../../issues/923))
+* fixed handling of unhashable modules which cannot be cached (see [#923](../../issues/923))
 * reload modules loaded by the dynamic patcher instead of removing them - sometimes they may
   not be reloaded automatically (see [#932](../../issues/932))
-* add back argument `use_dynamic_patch` as a fallback for similar problems
+* added back argument `use_dynamic_patch` as a fallback for similar problems
 
 
 ## [Version 5.3.2](https://pypi.python.org/pypi/pyfakefs/5.3.2) (2023-11-30)
 Bugfix release.
 
 ### Fixes
 * fixed a problem with patching `_io` under Python 3.12 (see [#910](../../issues/910))
@@ -38,31 +77,31 @@
 Mostly a bugfix release.
 
 ### Changes
 * changed behavior of `add_real_directory` to be able to map a real directory
   to an existing directory in the fake filesystem (see [#901](../../issues/901))
 
 ### Fixes
-* fixes the problem that filesystem patching was still active in the pytest
+* fixed the problem that filesystem patching was still active in the pytest
   logreport phase (see [#904](../../issues/904))
-* Restores compatibility with PyTorch 2.0 and above, as well as with other
-  classes that have custom __setattr__ methods (see [#905](../../pull/905)).
+* restored compatibility with PyTorch 2.0 and above, as well as with other
+  classes that have custom __setattr__ methods (see [#905](../../pull/905))
 
 ## [Version 5.3.0](https://pypi.python.org/pypi/pyfakefs/5.3.0) (2023-10-11)
 Adds official support for Python 3.12.
 
 ### Changes
-* add official support for Python 3.12
+* added official support for Python 3.12
 
 ### Fixes
 * removed a leftover debug print statement (see [#869](../../issues/869))
 * make sure tests work without HOME environment set (see [#870](../../issues/870))
 * automount drive or UNC path under Windows if needed for `pathlib.Path.mkdir()`
   (see [#890](../../issues/890))
-* adapt patching `io.open` and `io.open_code` to work with Python 3.12
+* adapted patching `io.open` and `io.open_code` to work with Python 3.12
   (see [#836](../../issues/836) and [#892](../../issues/892))
 
 ## [Version 5.2.4](https://pypi.python.org/pypi/pyfakefs/5.2.4) (2023-08-18)
 Fixes a rare problem on pytest shutdown.
 
 ### Fixes
 * Clear the patched module cache on session shutdown (pytest only)
@@ -71,20 +110,20 @@
 
 ## [Version 5.2.3](https://pypi.python.org/pypi/pyfakefs/5.2.3) (2023-07-10)
 Adds compatibility with PyPy 3.10 and Python 3.12.
 
 ### Fixes
 * Re-create temp directory if it had been created before on resetting file system
   (see [#814](../../issues/814)).
-* Exclude pytest `pathlib` modules from patching to avoid mixup of patched/unpatched
+* Excluded pytest `pathlib` modules from patching to avoid mixup of patched/unpatched
   code (see [#814](../../issues/814)).
-* Adapt to changes in Python 3.12 beta1 (only working partially,
+* Adapted to changes in Python 3.12 beta1 (only working partially,
   see [#830](../../issues/830) and [#831](../../issues/831)).
-* Adapt to changes in `shutil` in Python 3.12 beta2 (see [#814](../../issues/814)).
-* Fix support for newer PyPi versions (see [#859](../../issues/859)).
+* Adapted to changes in `shutil` in Python 3.12 beta2 (see [#814](../../issues/814)).
+* Fixed support for newer PyPi versions (see [#859](../../issues/859)).
 
 ### Documentation
 * Added a note regarding the incompatibility of the built-in `sqlite3` module with
   `pyfakefs` (see [#850](../../issues/850))
 
 ### Infrastructure
 * Added pytype check for non-test modules in CI (see [#599](../../issues/599)).
```

### Comparing `pyfakefs-5.3.5/CONTRIBUTING.md` & `pyfakefs-5.4.0/CONTRIBUTING.md`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/COPYING` & `pyfakefs-5.4.0/COPYING`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/PKG-INFO` & `pyfakefs-5.4.0/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: pyfakefs
-Version: 5.3.5
+Version: 5.4.0
 Summary: pyfakefs implements a fake file system that mocks the Python file system modules.
 Home-page: https://github.com/pytest-dev/pyfakefs
 Author: Google
 Author-email: google-pyfakefs@google.com
 Maintainer: John McGehee
 Maintainer-email: pyfakefs@johnnado.com
 License: http://www.apache.org/licenses/LICENSE-2.0
@@ -152,15 +152,15 @@
 [Contributing Guide](https://github.com/pytest-dev/pyfakefs/blob/main/CONTRIBUTING.md)
 for more information.
 
 ## History
 pyfakefs.py was initially developed at Google by Mike Bland as a modest fake
 implementation of core Python modules.  It was introduced to all of Google
 in September 2006. Since then, it has been enhanced to extend its
-functionality and usefulness.  At last count, pyfakefs was used in over 2,000
+functionality and usefulness.  At last count, pyfakefs was used in over 20,000
 Python tests at Google.
 
 Google released pyfakefs to the public in 2011 as Google Code project
 [pyfakefs](http://code.google.com/p/pyfakefs/):
 * Fork
   [jmcgeheeiv-pyfakefs](http://code.google.com/p/jmcgeheeiv-pyfakefs/) added
   [direct support for unittest and doctest](../../wiki/Automatically-find-and-patch-file-functions-and-modules)
```

### Comparing `pyfakefs-5.3.5/README.md` & `pyfakefs-5.4.0/README.md`

 * *Files 0% similar despite different names*

```diff
@@ -116,15 +116,15 @@
 [Contributing Guide](https://github.com/pytest-dev/pyfakefs/blob/main/CONTRIBUTING.md)
 for more information.
 
 ## History
 pyfakefs.py was initially developed at Google by Mike Bland as a modest fake
 implementation of core Python modules.  It was introduced to all of Google
 in September 2006. Since then, it has been enhanced to extend its
-functionality and usefulness.  At last count, pyfakefs was used in over 2,000
+functionality and usefulness.  At last count, pyfakefs was used in over 20,000
 Python tests at Google.
 
 Google released pyfakefs to the public in 2011 as Google Code project
 [pyfakefs](http://code.google.com/p/pyfakefs/):
 * Fork
   [jmcgeheeiv-pyfakefs](http://code.google.com/p/jmcgeheeiv-pyfakefs/) added
   [direct support for unittest and doctest](../../wiki/Automatically-find-and-patch-file-functions-and-modules)
```

### Comparing `pyfakefs-5.3.5/extra_requirements.txt` & `pyfakefs-5.4.0/extra_requirements.txt`

 * *Files 10% similar despite different names*

```diff
@@ -11,10 +11,10 @@
 scandir>=1.8
 
 # pandas + xlrd are used to test pandas-specific patches to allow
 # pyfakefs to work with pandas
 # we use the latest version to see any problems with new versions
 pandas==1.3.5; python_version == '3.7' # pyup: ignore
 pandas==2.0.3; python_version == '3.8' # pyup: ignore
-pandas==2.2.0; python_version > '3.8'
+pandas==2.2.1; python_version > '3.8'
 xlrd==2.0.1
 openpyxl==3.1.2
```

### Comparing `pyfakefs-5.3.5/mypy.ini` & `pyfakefs-5.4.0/mypy.ini`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/extra_packages.py` & `pyfakefs-5.4.0/pyfakefs/extra_packages.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_file.py` & `pyfakefs-5.4.0/pyfakefs/fake_file.py`

 * *Files 5% similar despite different names*

```diff
@@ -8,21 +8,21 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""Fake implementations for different file objects.
-"""
+"""Fake implementations for different file objects."""
+
 import errno
 import io
-import locale
 import os
 import sys
+import traceback
 from stat import (
     S_IFREG,
     S_IFDIR,
 )
 from types import TracebackType
 from typing import (
     List,
@@ -48,14 +48,16 @@
     is_int_type,
     is_unicode_string,
     to_string,
     matching_string,
     real_encoding,
     AnyPath,
     AnyString,
+    get_locale_encoding,
+    _OpenModes,
 )
 
 if TYPE_CHECKING:
     from pyfakefs.fake_filesystem import FakeFilesystem
 
 AnyFileWrapper = Union[
     "FakeFileWrapper",
@@ -129,14 +131,15 @@
         name: AnyStr,
         st_mode: int = S_IFREG | helpers.PERM_DEF_FILE,
         contents: Optional[AnyStr] = None,
         filesystem: Optional["FakeFilesystem"] = None,
         encoding: Optional[str] = None,
         errors: Optional[str] = None,
         side_effect: Optional[Callable[["FakeFile"], None]] = None,
+        open_modes: Optional[_OpenModes] = None,
     ):
         """
         Args:
             name: Name of the file/directory, without parent path information
             st_mode: The stat.S_IF* constant representing the file type (i.e.
                 stat.S_IFREG, stat.S_IFDIR), and the file permissions.
                 If no file type is set (e.g. permission flags only), a
@@ -147,14 +150,15 @@
                 keys for FakeDirectory objects
             filesystem: The fake filesystem where the file is created.
             encoding: If contents is a unicode string, the encoding used
                 for serialization.
             errors: The error mode used for encoding/decoding errors.
             side_effect: function handle that is executed when file is written,
                 must accept the file object as an argument.
+            open_modes: The modes the file was opened with (e.g. can read, write etc.)
         """
         # to be backwards compatible regarding argument order, we raise on None
         if filesystem is None:
             raise ValueError("filesystem shall not be None")
         self.filesystem: "FakeFilesystem" = filesystem
         self._side_effect: Optional[Callable] = side_effect
         self.name: AnyStr = name  # type: ignore[assignment]
@@ -175,26 +179,27 @@
             len(self._byte_contents) if self._byte_contents is not None else 0
         )
         self.epoch: int = 0
         self.parent_dir: Optional[FakeDirectory] = None
         # Linux specific: extended file system attributes
         self.xattr: Dict = {}
         self.opened_as: AnyString = ""
+        self.open_modes = open_modes
 
     @property
     def byte_contents(self) -> Optional[bytes]:
         """Return the contents as raw byte array."""
         return self._byte_contents
 
     @property
     def contents(self) -> Optional[str]:
         """Return the contents as string with the original encoding."""
         if isinstance(self.byte_contents, bytes):
             return self.byte_contents.decode(
-                self.encoding or locale.getpreferredencoding(False),
+                self.encoding or get_locale_encoding(),
                 errors=self.errors,
             )
         return None
 
     @property
     def st_ctime(self) -> float:
         """Return the creation time of the fake file."""
@@ -259,15 +264,15 @@
         """
         return self._byte_contents is None
 
     def _encode_contents(self, contents: Union[str, bytes, None]) -> Optional[bytes]:
         if is_unicode_string(contents):
             contents = bytes(
                 cast(str, contents),
-                self.encoding or locale.getpreferredencoding(False),
+                self.encoding or get_locale_encoding(),
                 self.errors,
             )
         return cast(bytes, contents)
 
     def set_initial_contents(self, contents: AnyStr) -> bool:
         """Sets the file contents and size.
            Called internally after initial file creation.
@@ -387,14 +392,29 @@
         if key in self.stat_types:
             return setattr(self.stat_result, key, value)
         return super().__setattr__(key, value)
 
     def __str__(self) -> str:
         return "%r(%o)" % (self.name, self.st_mode)
 
+    def has_permission(self, permission_bits: int) -> bool:
+        """Checks if the given permissions are set in the fake file.
+
+        Args:
+            permission_bits: The permission bits as set for the user.
+
+        Returns:
+            True if the permissions are set in the correct class (user/group/other).
+        """
+        if helpers.get_uid() == self.stat_result.st_uid:
+            return self.st_mode & permission_bits == permission_bits
+        if helpers.get_gid() == self.stat_result.st_gid:
+            return self.st_mode & (permission_bits >> 3) == permission_bits >> 3
+        return self.st_mode & (permission_bits >> 6) == permission_bits >> 6
+
 
 class FakeNullFile(FakeFile):
     def __init__(self, filesystem: "FakeFilesystem") -> None:
         devnull = "nul" if filesystem.is_windows_fs else "/dev/null"
         super(FakeNullFile, self).__init__(devnull, filesystem=filesystem, contents="")
 
     @property
@@ -500,16 +520,16 @@
 
         Raises:
             OSError: if the directory has no write permission (Posix only)
             OSError: if the file or directory to be added already exists
         """
         if (
             not helpers.is_root()
-            and not self.st_mode & helpers.PERM_WRITE
             and not self.filesystem.is_windows_fs
+            and not self.has_permission(helpers.PERM_WRITE)
         ):
             raise OSError(errno.EACCES, "Permission Denied", self.path)
 
         path_object_name: str = to_string(path_object.name)
         if path_object_name in self.entries:
             self.filesystem.raise_os_error(errno.EEXIST, self.path)
 
@@ -566,19 +586,35 @@
         """
         pathname_name = self._normalized_entryname(pathname_name)
         entry = self.get_entry(pathname_name)
         if self.filesystem.is_windows_fs:
             if entry.st_mode & helpers.PERM_WRITE == 0:
                 self.filesystem.raise_os_error(errno.EACCES, pathname_name)
             if self.filesystem.has_open_file(entry):
-                self.filesystem.raise_os_error(errno.EACCES, pathname_name)
+                raise_error = True
+                if os.name == "posix" and not hasattr(os, "O_TMPFILE"):
+                    # special handling for emulating Windows under macOS and PyPi
+                    # tempfile uses unlink based on the real OS while deleting
+                    # a temporary file, so we ignore that error in this specific case
+                    st = traceback.extract_stack(limit=6)
+                    if sys.version_info < (3, 10):
+                        if (
+                            st[1].name == "TemporaryFile"
+                            and st[1].line == "_os.unlink(name)"
+                        ):
+                            raise_error = False
+                    else:
+                        # TemporaryFile implementation has changed in Python 3.10
+                        if st[0].name == "opener" and st[0].line == "_os.unlink(name)":
+                            raise_error = False
+                if raise_error:
+                    self.filesystem.raise_os_error(errno.EACCES, pathname_name)
         else:
-            if not helpers.is_root() and (
-                self.st_mode & (helpers.PERM_WRITE | helpers.PERM_EXE)
-                != helpers.PERM_WRITE | helpers.PERM_EXE
+            if not helpers.is_root() and not self.has_permission(
+                helpers.PERM_WRITE | helpers.PERM_EXE
             ):
                 self.filesystem.raise_os_error(errno.EACCES, pathname_name)
 
         if recursive and isinstance(entry, FakeDirectory):
             while entry.entries:
                 entry.remove_entry(list(entry.entries)[0])
         elif entry.st_nlink == 1:
@@ -719,37 +755,39 @@
         newline: Optional[str],
         binary: bool,
         closefd: bool,
         encoding: Optional[str],
         errors: Optional[str],
         buffering: int,
         raw_io: bool,
+        opened_as_fd: bool,
         is_stream: bool = False,
     ):
         self.file_object = file_object
         self.file_path = file_path  # type: ignore[var-annotated]
         self._append = append
         self._read = read
         self.allow_update = update
         self._closefd = closefd
         self._file_epoch = file_object.epoch
         self.raw_io = raw_io
         self._binary = binary
+        self.opened_as_fd = opened_as_fd
         self.is_stream = is_stream
         self._changed = False
         self._buffer_size = buffering
         if self._buffer_size == 0 and not binary:
             raise ValueError("can't have unbuffered text I/O")
         # buffer_size is ignored in text mode
         elif self._buffer_size == -1 or not binary:
             self._buffer_size = io.DEFAULT_BUFFER_SIZE
         self._use_line_buffer = not binary and buffering == 1
 
         contents = file_object.byte_contents
-        self._encoding = encoding or locale.getpreferredencoding(False)
+        self._encoding = encoding or get_locale_encoding()
         errors = errors or "strict"
         self._io: Union[BinaryBufferIO, TextBufferIO] = (
             BinaryBufferIO(contents)
             if binary
             else TextBufferIO(
                 contents, encoding=encoding, newline=newline, errors=errors
             )
@@ -803,29 +841,43 @@
         """Return the file descriptor of the file object."""
         if self.filedes is not None:
             return self.filedes
         raise OSError(errno.EBADF, "Invalid file descriptor")
 
     def close(self) -> None:
         """Close the file."""
+        self.close_fd(self.filedes)
+
+    def close_fd(self, fd: Optional[int]) -> None:
+        """Close the file for the given file descriptor."""
+
         # ignore closing a closed file
         if not self._is_open():
             return
 
         # for raw io, all writes are flushed immediately
-        if self.allow_update and not self.raw_io:
-            self.flush()
+        if not self.raw_io:
+            try:
+                self.flush()
+            except OSError as e:
+                if e.errno == errno.EBADF:
+                    # if we get here, we have an open file descriptor
+                    # without write permission, which has to be closed
+                    assert self.filedes
+                    self._filesystem.close_open_file(self.filedes)
+                raise
+
             if self._filesystem.is_windows_fs and self._changed:
                 self.file_object.st_mtime = helpers.now()
 
-        assert self.filedes is not None
+        assert fd is not None
         if self._closefd:
-            self._filesystem._close_open_file(self.filedes)
+            self._filesystem.close_open_file(fd)
         else:
-            open_files = self._filesystem.open_files[self.filedes]
+            open_files = self._filesystem.open_files[fd]
             assert open_files is not None
             open_files.remove(self)
         if self.delete_on_close:
             self._filesystem.remove_object(
                 self.get_object().path  # type: ignore[arg-type]
             )
 
@@ -844,16 +896,20 @@
             self._io.seek(old_pos)
             self._io.truncate()
             self._flush_pos = flush_pos
             raise
 
     def flush(self) -> None:
         """Flush file contents to 'disk'."""
+        if self.is_stream:
+            return
+
         self._check_open_file()
-        if self.allow_update and not self.is_stream:
+
+        if self.allow_update:
             contents = self._io.getvalue()
             if self._append:
                 self._sync_io()
                 old_contents = self.file_object.byte_contents
                 assert old_contents is not None
                 contents = old_contents + contents[self._flush_pos :]
                 self._set_stream_contents(contents)
@@ -865,17 +921,23 @@
                 if self._filesystem.is_windows_fs:
                     self._changed = True
                 else:
                     current_time = helpers.now()
                     self.file_object.st_ctime = current_time
                     self.file_object.st_mtime = current_time
             self._file_epoch = self.file_object.epoch
-
-            if not self.is_stream:
-                self._flush_related_files()
+            self._flush_related_files()
+        else:
+            buf_length = len(self._io.getvalue())
+            content_length = 0
+            if self.file_object.byte_contents is not None:
+                content_length = len(self.file_object.byte_contents)
+            # an error is only raised if there is something to flush
+            if content_length != buf_length:
+                self._filesystem.raise_os_error(errno.EBADF)
 
     def update_flush_pos(self) -> None:
         self._flush_pos = self._io.tell()
 
     def _flush_related_files(self) -> None:
         for open_files in self._filesystem.open_files[3:]:
             if open_files is not None:
@@ -1110,15 +1172,15 @@
         truncate = name == "truncate"
         writing = name.startswith("write") or truncate
 
         if reading or writing:
             self._check_open_file()
         if not self._read and reading:
             return self._read_error()
-        if not self.allow_update and writing:
+        if not self.opened_as_fd and not self.allow_update and writing:
             return self._write_error()
 
         if reading:
             self._sync_io()
             if not self.is_stream:
                 self.flush()
             if not self._filesystem.is_windows_fs:
@@ -1195,14 +1257,17 @@
 
     def read(self, n: int = -1) -> bytes:
         return cast(bytes, self._stream_object.read())
 
     def close(self) -> None:
         """We do not support closing standard streams."""
 
+    def close_fd(self, fd: Optional[int]) -> None:
+        """We do not support closing standard streams."""
+
     def is_stream(self) -> bool:
         return True
 
 
 class FakeDirWrapper:
     """Wrapper for a FakeDirectory object to be used in open files list."""
 
@@ -1226,16 +1291,20 @@
         """Return the file descriptor of the file object."""
         if self.filedes is not None:
             return self.filedes
         raise OSError(errno.EBADF, "Invalid file descriptor")
 
     def close(self) -> None:
         """Close the directory."""
-        assert self.filedes is not None
-        self._filesystem._close_open_file(self.filedes)
+        self.close_fd(self.filedes)
+
+    def close_fd(self, fd: Optional[int]) -> None:
+        """Close the directory."""
+        assert fd is not None
+        self._filesystem.close_open_file(fd)
 
 
 class FakePipeWrapper:
     """Wrapper for a read or write descriptor of a real pipe object to be
     used in open files list.
     """
 
@@ -1290,16 +1359,20 @@
         """Write to the real pipe."""
         if self.real_file:
             return self.real_file.write(contents)
         return os.write(self.fd, contents)
 
     def close(self) -> None:
         """Close the pipe descriptor."""
-        assert self.filedes is not None
-        open_files = self._filesystem.open_files[self.filedes]
+        self.close_fd(self.filedes)
+
+    def close_fd(self, fd: Optional[int]) -> None:
+        """Close the pipe descriptor with the given file descriptor."""
+        assert fd is not None
+        open_files = self._filesystem.open_files[fd]
         assert open_files is not None
         open_files.remove(self)
         if self.real_file:
             self.real_file.close()
         else:
             os.close(self.fd)
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_filesystem.py` & `pyfakefs-5.4.0/pyfakefs/fake_filesystem.py`

 * *Files 3% similar despite different names*

```diff
@@ -76,14 +76,15 @@
 
 >>> import stat
 >>> stat.S_ISREG(os_module.stat(pathname).st_mode)
 True
 >>> stat.S_ISDIR(os_module.stat(os_module.path.dirname(pathname)).st_mode)
 True
 """
+
 import errno
 import heapq
 import os
 import random
 import sys
 import tempfile
 from collections import namedtuple, OrderedDict
@@ -317,15 +318,17 @@
 
     @property
     def os(self) -> OSType:
         """Return the real or simulated type of operating system."""
         return (
             OSType.WINDOWS
             if self.is_windows_fs
-            else OSType.MACOS if self.is_macos else OSType.LINUX
+            else OSType.MACOS
+            if self.is_macos
+            else OSType.LINUX
         )
 
     @os.setter
     def os(self, value: OSType) -> None:
         """Set the simulated type of operating system underlying the fake
         file system."""
         self._is_windows_fs = value == OSType.WINDOWS
@@ -668,22 +671,23 @@
         # stat should return the tuple representing return value of os.stat
         try:
             file_object = self.resolve(
                 entry_path,
                 follow_symlinks,
                 allow_fd=True,
                 check_read_perm=False,
+                check_exe_perm=False,
             )
         except TypeError:
             file_object = self.resolve(entry_path)
         if not is_root():
             # make sure stat raises if a parent dir is not readable
             parent_dir = file_object.parent_dir
             if parent_dir:
-                self.get_object(parent_dir.path)  # type: ignore[arg-type]
+                self.get_object(parent_dir.path, check_read_perm=False)  # type: ignore[arg-type]
 
         self.raise_for_filepath_ending_with_separator(
             entry_path, file_object, follow_symlinks
         )
 
         return file_object.stat_result.copy()
 
@@ -806,35 +810,56 @@
                 "utime: you may specify either 'times' or 'ns' but not both"
             )
         if times is not None and len(times) != 2:
             raise TypeError("utime: 'times' must be either a tuple of two ints or None")
         if ns is not None and len(ns) != 2:
             raise TypeError("utime: 'ns' must be a tuple of two ints")
 
-    def _add_open_file(self, file_obj: AnyFileWrapper) -> int:
+    def add_open_file(self, file_obj: AnyFileWrapper, new_fd: int = -1) -> int:
         """Add file_obj to the list of open files on the filesystem.
         Used internally to manage open files.
 
         The position in the open_files array is the file descriptor number.
 
         Args:
             file_obj: File object to be added to open files list.
+            new_fd: The optional new file descriptor.
 
         Returns:
             File descriptor number for the file object.
         """
+        if new_fd >= 0:
+            size = len(self.open_files)
+            if new_fd < size:
+                open_files = self.open_files[new_fd]
+                if open_files:
+                    for f in open_files:
+                        try:
+                            f.close()
+                        except OSError:
+                            pass
+                if new_fd in self._free_fd_heap:
+                    self._free_fd_heap.remove(new_fd)
+                self.open_files[new_fd] = [file_obj]
+            else:
+                for fd in range(size, new_fd):
+                    self.open_files.append([])
+                    heapq.heappush(self._free_fd_heap, fd)
+                self.open_files.append([file_obj])
+            return new_fd
+
         if self._free_fd_heap:
             open_fd = heapq.heappop(self._free_fd_heap)
             self.open_files[open_fd] = [file_obj]
             return open_fd
 
         self.open_files.append([file_obj])
         return len(self.open_files) - 1
 
-    def _close_open_file(self, file_des: int) -> None:
+    def close_open_file(self, file_des: int) -> None:
         """Remove file object with given descriptor from the list
         of open files.
 
         Sets the entry in open_files to None.
 
         Args:
             file_des: Descriptor of file object to be removed from
@@ -852,21 +877,37 @@
         Raises:
             OSError: an invalid file descriptor.
             TypeError: filedes is not an integer.
 
         Returns:
             Open file object.
         """
+        try:
+            return self.get_open_files(file_des)[0]
+        except IndexError:
+            self.raise_os_error(errno.EBADF, str(file_des))
+
+    def get_open_files(self, file_des: int) -> List[AnyFileWrapper]:
+        """Return the list of open files for a file descriptor.
+
+        Args:
+            file_des: File descriptor of the open files.
+
+        Raises:
+            OSError: an invalid file descriptor.
+            TypeError: filedes is not an integer.
+
+        Returns:
+            List of open file objects.
+        """
         if not is_int_type(file_des):
             raise TypeError("an integer is required")
         valid = file_des < len(self.open_files)
         if valid:
-            file_list = self.open_files[file_des]
-            if file_list is not None:
-                return file_list[0]
+            return self.open_files[file_des] or []
         self.raise_os_error(errno.EBADF, str(file_des))
 
     def has_open_file(self, file_object: FakeFile) -> bool:
         """Return True if the given file object is in the list of open files.
 
         Args:
             file_object: The FakeFile object to be checked.
@@ -924,17 +965,17 @@
         path_str = self.normcase(path)
         drive, path_str = self.splitdrive(path_str)
         sep = self.get_path_separator(path_str)
         is_absolute_path = path_str.startswith(sep)
         path_components: List[AnyStr] = path_str.split(
             sep
         )  # pytype: disable=invalid-annotation
-        collapsed_path_components: List[AnyStr] = (
-            []
-        )  # pytype: disable=invalid-annotation
+        collapsed_path_components: List[
+            AnyStr
+        ] = []  # pytype: disable=invalid-annotation
         dot = matching_string(path_str, ".")
         dotdot = matching_string(path_str, "..")
         for component in path_components:
             if (not component) or (component == dot):
                 continue
             if component == dotdot:
                 if collapsed_path_components and (
@@ -1589,24 +1630,27 @@
             return self.normpath(link_path)  # pytype: disable=bad-return-type
         raise ValueError("Invalid link")
 
     def get_object_from_normpath(
         self,
         file_path: AnyPath,
         check_read_perm: bool = True,
+        check_exe_perm: bool = True,
         check_owner: bool = False,
     ) -> AnyFile:
         """Search for the specified filesystem object within the fake
         filesystem.
 
         Args:
             file_path: Specifies target FakeFile object to retrieve, with a
                 path that has already been normalized/resolved.
             check_read_perm: If True, raises OSError if a parent directory
                 does not have read permission
+            check_exe_perm: If True, raises OSError if a parent directory
+                does not have execute (e.g. search) permission
             check_owner: If True, and check_read_perm is also True,
                 only checks read permission if the current user id is
                 different from the file object user id
 
         Returns:
             The FakeFile object corresponding to file_path.
 
@@ -1630,32 +1674,35 @@
                 if not S_ISDIR(target.st_mode):
                     if not self.is_windows_fs:
                         self.raise_os_error(errno.ENOTDIR, path)
                     self.raise_os_error(errno.ENOENT, path)
                 target = target.get_entry(component)  # type: ignore
                 if (
                     not is_root()
-                    and check_read_perm
+                    and (check_read_perm or check_exe_perm)
                     and target
-                    and not self._can_read(target, check_owner)
+                    and not self._can_read(
+                        target, check_read_perm, check_exe_perm, check_owner
+                    )
                 ):
                     self.raise_os_error(errno.EACCES, target.path)
         except KeyError:
             self.raise_os_error(errno.ENOENT, path)
         return target
 
     @staticmethod
-    def _can_read(target, owner_can_read):
-        if target.st_uid == helpers.get_uid():
-            if owner_can_read or target.st_mode & 0o400:
-                return True
-        if target.st_gid == get_gid():
-            if target.st_mode & 0o040:
-                return True
-        return target.st_mode & 0o004
+    def _can_read(target, check_read_perm, check_exe_perm, owner_can_read):
+        if owner_can_read and target.st_uid == helpers.get_uid():
+            return True
+        permission = helpers.PERM_READ if check_read_perm else 0
+        if S_ISDIR(target.st_mode) and check_exe_perm:
+            permission |= helpers.PERM_EXE
+        if not permission:
+            return True
+        return target.has_permission(permission)
 
     def get_object(self, file_path: AnyPath, check_read_perm: bool = True) -> FakeFile:
         """Search for the specified filesystem object within the fake
         filesystem.
 
         Args:
             file_path: Specifies the target
@@ -1676,25 +1723,28 @@
 
     def resolve(
         self,
         file_path: AnyStr,
         follow_symlinks: bool = True,
         allow_fd: bool = False,
         check_read_perm: bool = True,
+        check_exe_perm: bool = True,
         check_owner: bool = False,
     ) -> FakeFile:
         """Search for the specified filesystem object, resolving all links.
 
         Args:
             file_path: Specifies the target FakeFile object to retrieve.
             follow_symlinks: If `False`, the link itself is resolved,
                 otherwise the object linked to.
             allow_fd: If `True`, `file_path` may be an open file descriptor
             check_read_perm: If True, raises OSError if a parent directory
                 does not have read permission
+            check_read_perm: If True, raises OSError if a parent directory
+                does not have execute permission
             check_owner: If True, and check_read_perm is also True,
                 only checks read permission if the current user id is
                 different from the file object user id
 
         Returns:
           The FakeFile object corresponding to `file_path`.
 
@@ -1706,14 +1756,15 @@
                 return self.get_open_file(file_path).get_object()
             raise TypeError("path should be string, bytes or " "os.PathLike, not int")
 
         if follow_symlinks:
             return self.get_object_from_normpath(
                 self.resolve_path(file_path, allow_fd),
                 check_read_perm,
+                check_exe_perm,
                 check_owner,
             )
         return self.lresolve(file_path)
 
     def lresolve(self, path: AnyPath) -> FakeFile:
         """Search for the specified object, resolving only parent links.
 
@@ -1748,15 +1799,15 @@
         try:
             parent_obj = self.resolve(parent_directory)
             assert parent_obj
             if not isinstance(parent_obj, FakeDirectory):
                 if not self.is_windows_fs and isinstance(parent_obj, FakeFile):
                     self.raise_os_error(errno.ENOTDIR, path_str)
                 self.raise_os_error(errno.ENOENT, path_str)
-            if not parent_obj.st_mode & helpers.PERM_READ:
+            if not parent_obj.has_permission(helpers.PERM_READ):
                 self.raise_os_error(errno.EACCES, parent_directory)
             return (
                 parent_obj.get_entry(to_string(child_name))
                 if child_name
                 else parent_obj
             )
         except KeyError:
@@ -1773,15 +1824,18 @@
         Raises:
             OSError: if file_path does not correspond to a
                 directory.
         """
         if not file_path:
             target_directory = self.root_dir
         else:
-            target_directory = cast(FakeDirectory, self.resolve(file_path))
+            target_directory = cast(
+                FakeDirectory,
+                self.resolve(file_path, check_read_perm=False, check_exe_perm=True),
+            )
             if not S_ISDIR(target_directory.st_mode):
                 error = errno.ENOENT if self.is_windows_fs else errno.ENOTDIR
                 self.raise_os_error(error, file_path)
         target_directory.add_entry(file_object)
 
     def rename(
         self,
@@ -1880,15 +1934,17 @@
     def _handle_broken_link_with_trailing_sep(self, path: AnyStr) -> None:
         # note that the check for trailing sep has to be done earlier
         if self.islink(path):
             if not self.exists(path):
                 error = (
                     errno.ENOENT
                     if self.is_macos
-                    else errno.EINVAL if self.is_windows_fs else errno.ENOTDIR
+                    else errno.EINVAL
+                    if self.is_windows_fs
+                    else errno.ENOTDIR
                 )
                 self.raise_os_error(error, path)
 
     def _handle_posix_dir_link_errors(
         self, new_file_path: AnyStr, old_file_path: AnyStr, ends_with_sep: bool
     ) -> None:
         if self.isdir(old_file_path, follow_symlinks=False) and self.islink(
@@ -2078,26 +2134,26 @@
                 current_dir = cast(FakeDirectory, directory)
                 if directory.st_mode & S_IFDIR != S_IFDIR:
                     self.raise_os_error(errno.ENOTDIR, current_dir.path)
 
         # set the permission after creating the directories
         # to allow directory creation inside a read-only directory
         for new_dir in new_dirs:
-            new_dir.st_mode = S_IFDIR | perm_bits
+            new_dir.st_mode = S_IFDIR | (perm_bits & ~self.umask)
 
         return current_dir
 
     def create_file(
         self,
         file_path: AnyPath,
         st_mode: int = S_IFREG | helpers.PERM_DEF_FILE,
         contents: AnyString = "",
         st_size: Optional[int] = None,
         create_missing_dirs: bool = True,
-        apply_umask: bool = False,
+        apply_umask: bool = True,
         encoding: Optional[str] = None,
         errors: Optional[str] = None,
         side_effect: Optional[Callable] = None,
     ) -> FakeFile:
         """Create `file_path`, including all the parent directories along
         the way, and return the created
         :py:class:`FakeFile<pyfakefs.fake_file.FakeFile>` object.
@@ -2364,15 +2420,15 @@
     def create_file_internally(
         self,
         file_path: AnyPath,
         st_mode: int = S_IFREG | helpers.PERM_DEF_FILE,
         contents: AnyString = "",
         st_size: Optional[int] = None,
         create_missing_dirs: bool = True,
-        apply_umask: bool = False,
+        apply_umask: bool = True,
         encoding: Optional[str] = None,
         errors: Optional[str] = None,
         read_from_real_fs: bool = False,
         side_effect: Optional[Callable] = None,
     ) -> FakeFile:
         """Internal fake file creator that supports both normal fake files
         and fake files based on real files.
@@ -2409,15 +2465,16 @@
         if not parent_directory:
             parent_directory = matching_string(path, self.cwd)
         self._auto_mount_drive_if_needed(parent_directory)
         if not self.exists(parent_directory):
             if not create_missing_dirs:
                 self.raise_os_error(errno.ENOENT, parent_directory)
             parent_directory = matching_string(
-                path, self.create_dir(parent_directory).path  # type: ignore
+                path,
+                self.create_dir(parent_directory).path,  # type: ignore
             )
         else:
             parent_directory = self._original_path(parent_directory)
         if apply_umask:
             st_mode &= ~self.umask
         file_object: FakeFile
         if read_from_real_fs:
@@ -2503,14 +2560,15 @@
         if not self.islink(link_path):
             link_path = self.resolve_path(link_path)
         return self.create_file_internally(
             link_path,
             st_mode=S_IFLNK | helpers.PERM_DEF,
             contents=link_target_path,
             create_missing_dirs=create_missing_dirs,
+            apply_umask=self.is_macos,
         )
 
     def create_link(
         self,
         old_path: AnyPath,
         new_path: AnyPath,
         follow_symlinks: bool = True,
@@ -2750,15 +2808,15 @@
                 not hasattr(current_dir, "entries")
                 or component not in current_dir.entries
             ):
                 break
             else:
                 current_dir = cast(FakeDirectory, current_dir.entries[component])
         try:
-            self.create_dir(dir_name, mode & ~self.umask)
+            self.create_dir(dir_name, mode)
         except OSError as e:
             if e.errno == errno.EACCES:
                 # permission denied - propagate exception
                 raise
             if not exist_ok or not isinstance(self.resolve(dir_name), FakeDirectory):
                 if self.is_windows_fs and e.errno == errno.ENOTDIR:
                     e.errno = errno.ENOENT
@@ -2848,34 +2906,47 @@
     if sys.version_info >= (3, 12):
 
         def isjunction(self, path: AnyPath) -> bool:
             """Returns False. Junctions are never faked."""
             return False
 
     def confirmdir(
-        self, target_directory: AnyStr, check_owner: bool = False
+        self,
+        target_directory: AnyStr,
+        check_read_perm: bool = True,
+        check_exe_perm: bool = True,
+        check_owner: bool = False,
     ) -> FakeDirectory:
         """Test that the target is actually a directory, raising OSError
         if not.
 
         Args:
             target_directory: Path to the target directory within the fake
                 filesystem.
+            check_read_perm: If True, raises OSError if the directory
+                does not have read permission
+            check_exe_perm: If True, raises OSError if the directory
+                does not have execute (e.g. search) permission
             check_owner: If True, only checks read permission if the current
                 user id is different from the file object user id
 
         Returns:
             The FakeDirectory object corresponding to target_directory.
 
         Raises:
             OSError: if the target is not a directory.
         """
         directory = cast(
             FakeDirectory,
-            self.resolve(target_directory, check_owner=check_owner),
+            self.resolve(
+                target_directory,
+                check_read_perm=check_read_perm,
+                check_exe_perm=check_exe_perm,
+                check_owner=check_owner,
+            ),
         )
         if not directory.st_mode & S_IFDIR:
             self.raise_os_error(errno.ENOTDIR, target_directory, 267)
         return directory
 
     def remove(self, path: AnyStr) -> None:
         """Remove the FakeFile object at the specified file path.
@@ -2961,32 +3032,49 @@
             order. If `shuffle_listdir_results` is set, the order is not the
             same in subsequent calls to avoid tests relying on any ordering.
 
         Raises:
             OSError: if the target is not a directory.
         """
         target_directory = self.resolve_path(target_directory, allow_fd=True)
-        directory = self.confirmdir(target_directory)
+        directory = self.confirmdir(target_directory, check_exe_perm=False)
         directory_contents = list(directory.entries.keys())
         if self.shuffle_listdir_results:
             random.shuffle(directory_contents)
         return directory_contents  # type: ignore[return-value]
 
     def __str__(self) -> str:
         return str(self.root_dir)
 
     def _add_standard_streams(self) -> None:
-        self._add_open_file(StandardStreamWrapper(sys.stdin))
-        self._add_open_file(StandardStreamWrapper(sys.stdout))
-        self._add_open_file(StandardStreamWrapper(sys.stderr))
+        self.add_open_file(StandardStreamWrapper(sys.stdin))
+        self.add_open_file(StandardStreamWrapper(sys.stdout))
+        self.add_open_file(StandardStreamWrapper(sys.stderr))
+
+    def _tempdir_name(self):
+        """This logic is extracted from tempdir._candidate_tempdir_list.
+        We cannot rely on tempdir.gettempdir() in an empty filesystem, as it tries
+        to write to the filesystem to ensure that the tempdir is valid.
+        """
+        # reset the cached tempdir in tempfile
+        tempfile.tempdir = None
+        for env_name in "TMPDIR", "TEMP", "TMP":
+            dir_name = os.getenv(env_name)
+            if dir_name:
+                return dir_name
+        # we have to check the real OS temp path here, as this is what
+        # tempfile assumes
+        if os.name == "nt":
+            return os.path.expanduser(r"~\AppData\Local\Temp")
+        return "/tmp"
 
     def _create_temp_dir(self):
         # the temp directory is assumed to exist at least in `tempfile`,
         # so we create it here for convenience
-        temp_dir = tempfile.gettempdir()
+        temp_dir = self._tempdir_name()
         if not self.exists(temp_dir):
             self.create_dir(temp_dir)
         if sys.platform != "win32" and not self.exists("/tmp"):
             # under Posix, we also create a link in /tmp if the path does not exist
             self.create_symlink("/tmp", temp_dir)
             # reset the used size to 0 to avoid having the link size counted
             # which would make disk size tests more complicated
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_filesystem_shutil.py` & `pyfakefs-5.4.0/pyfakefs/fake_filesystem_shutil.py`

 * *Files 0% similar despite different names*

```diff
@@ -22,14 +22,15 @@
     shutil module.
 
 :Usage:
   The fake implementation is automatically involved if using
   `fake_filesystem_unittest.TestCase`, pytest fs fixture,
   or directly `Patcher`.
 """
+
 import os
 import shutil
 import sys
 
 
 class FakeShutilModule:
     """Uses a FakeFilesystem to provide a fake replacement
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_filesystem_unittest.py` & `pyfakefs-5.4.0/pyfakefs/fake_filesystem_unittest.py`

 * *Files 4% similar despite different names*

```diff
@@ -31,27 +31,27 @@
 that even in your test fixture, familiar functions like `open()` and
 `os.makedirs()` manipulate the fake file system.
 
 Existing unit tests that use the real file system can be retrofitted to use
 pyfakefs by simply changing their base class from `:py:class`unittest.TestCase`
 to `:py:class`pyfakefs.fake_filesystem_unittest.TestCase`.
 """
+
 import _io  # type:ignore[import]
 import doctest
 import functools
 import genericpath
 import inspect
 import io
 import linecache
 import os
 import shutil
 import sys
 import tempfile
 import tokenize
-from enum import Enum
 from importlib.abc import Loader, MetaPathFinder
 from types import ModuleType, TracebackType, FunctionType
 from typing import (
     Any,
     Callable,
     Dict,
     List,
@@ -91,35 +91,26 @@
 if use_scandir:
     from pyfakefs import fake_scandir
 
 OS_MODULE = "nt" if sys.platform == "win32" else "posix"
 PATH_MODULE = "ntpath" if sys.platform == "win32" else "posixpath"
 
 
-class ModuleCleanupMode(Enum):
-    """Defines the behavior of module cleanup on dynamic patcher shutdown."""
-
-    AUTO = 1
-    DELETE = 2
-    RELOAD = 3
-
-
 def patchfs(
     _func: Optional[Callable] = None,
     *,
     additional_skip_names: Optional[List[Union[str, ModuleType]]] = None,
     modules_to_reload: Optional[List[ModuleType]] = None,
     modules_to_patch: Optional[Dict[str, ModuleType]] = None,
     allow_root_user: bool = True,
     use_known_patches: bool = True,
     patch_open_code: PatchMode = PatchMode.OFF,
     patch_default_args: bool = False,
     use_cache: bool = True,
     use_dynamic_patch: bool = True,
-    module_cleanup_mode: ModuleCleanupMode = ModuleCleanupMode.AUTO,
 ) -> Callable:
     """Convenience decorator to use patcher with additional parameters in a
     test function.
 
     Usage::
 
         @patchfs
@@ -140,15 +131,14 @@
                 modules_to_patch=modules_to_patch,
                 allow_root_user=allow_root_user,
                 use_known_patches=use_known_patches,
                 patch_open_code=patch_open_code,
                 patch_default_args=patch_default_args,
                 use_cache=use_cache,
                 use_dynamic_patch=use_dynamic_patch,
-                module_cleanup_mode=module_cleanup_mode,
             ) as p:
                 args = list(args)
                 args.append(p.fs)
                 return f(*args, **kwargs)
 
         return wrapped
 
@@ -177,15 +167,14 @@
     modules_to_reload: Optional[List[ModuleType]] = None,
     modules_to_patch: Optional[Dict[str, ModuleType]] = None,
     allow_root_user: bool = True,
     use_known_patches: bool = True,
     patch_open_code: PatchMode = PatchMode.OFF,
     patch_default_args: bool = False,
     use_dynamic_patch: bool = True,
-    module_cleanup_mode: ModuleCleanupMode = ModuleCleanupMode.AUTO,
 ) -> TestSuite:  # pylint:disable=unused-argument
     """Load the doctest tests for the specified module into unittest.
         Args:
             loader, tests, ignore : arguments passed in from `load_tests()`
             module: module under test
             remaining args: see :py:class:`TestCase` for an explanation
 
@@ -198,15 +187,14 @@
             modules_to_reload=modules_to_reload,
             modules_to_patch=modules_to_patch,
             allow_root_user=allow_root_user,
             use_known_patches=use_known_patches,
             patch_open_code=patch_open_code,
             patch_default_args=patch_default_args,
             use_dynamic_patch=use_dynamic_patch,
-            module_cleanup_mode=module_cleanup_mode,
             is_doc_test=True,
         )
     assert Patcher.DOC_PATCHER is not None
     globs = Patcher.DOC_PATCHER.replace_globs(vars(module))
     tests.addTests(
         doctest.DocTestSuite(
             module,
@@ -279,15 +267,14 @@
         modules_to_patch: Optional[Dict[str, ModuleType]] = None,
         allow_root_user: bool = True,
         use_known_patches: bool = True,
         patch_open_code: PatchMode = PatchMode.OFF,
         patch_default_args: bool = False,
         use_cache: bool = True,
         use_dynamic_patch: bool = True,
-        module_cleanup_mode: ModuleCleanupMode = ModuleCleanupMode.AUTO,
     ) -> None:
         """Bind the file-related modules to the :py:class:`pyfakefs` fake file
         system instead of the real file system.  Also bind the fake `open()`
         function.
 
         Invoke this at the beginning of the `setUp()` method in your unit test
         class.
@@ -312,15 +299,14 @@
             modules_to_patch=modules_to_patch,
             allow_root_user=allow_root_user,
             use_known_patches=use_known_patches,
             patch_open_code=patch_open_code,
             patch_default_args=patch_default_args,
             use_cache=use_cache,
             use_dynamic_patch=use_dynamic_patch,
-            module_cleanup_mode=module_cleanup_mode,
         )
 
         self._patcher.setUp()
         cast(TestCase, self).addCleanup(self._patcher.tearDown)
 
     @classmethod
     def setUpClassPyfakefs(
@@ -330,15 +316,14 @@
         modules_to_patch: Optional[Dict[str, ModuleType]] = None,
         allow_root_user: bool = True,
         use_known_patches: bool = True,
         patch_open_code: PatchMode = PatchMode.OFF,
         patch_default_args: bool = False,
         use_cache: bool = True,
         use_dynamic_patch: bool = True,
-        module_cleanup_mode: ModuleCleanupMode = ModuleCleanupMode.AUTO,
     ) -> None:
         """Similar to :py:func:`setUpPyfakefs`, but as a class method that
         can be used in `setUpClass` instead of in `setUp`.
         The fake filesystem will live in all test methods in the test class
         and can be used in the usual way.
         Note that using both :py:func:`setUpClassPyfakefs` and
         :py:func:`setUpPyfakefs` in the same class will not work correctly.
@@ -369,15 +354,14 @@
             modules_to_patch=modules_to_patch,
             allow_root_user=allow_root_user,
             use_known_patches=use_known_patches,
             patch_open_code=patch_open_code,
             patch_default_args=patch_default_args,
             use_cache=use_cache,
             use_dynamic_patch=use_dynamic_patch,
-            module_cleanup_mode=module_cleanup_mode,
         )
 
         Patcher.PATCHER.setUp()
         cast(TestCase, cls).addClassCleanup(Patcher.PATCHER.tearDown)
 
     @classmethod
     def fake_fs(cls):
@@ -535,15 +519,14 @@
         modules_to_patch: Optional[Dict[str, ModuleType]] = None,
         allow_root_user: bool = True,
         use_known_patches: bool = True,
         patch_open_code: PatchMode = PatchMode.OFF,
         patch_default_args: bool = False,
         use_cache: bool = True,
         use_dynamic_patch: bool = True,
-        module_cleanup_mode: ModuleCleanupMode = ModuleCleanupMode.AUTO,
         is_doc_test: bool = False,
     ) -> None:
         """
         Args:
             additional_skip_names: names of modules where no module
                 replacement shall be performed, in addition to the names in
                 :py:attr:`fake_filesystem_unittest.Patcher.SKIPNAMES`.
@@ -571,19 +554,14 @@
             use_cache: If True (default), patched and non-patched modules are
                 cached between tests for performance reasons. As this is a new
                 feature, this argument allows to turn it off in case it
                 causes any problems.
             use_dynamic_patch: If `True`, dynamic patching after setup is used
                 (for example for modules loaded locally inside of functions).
                 Can be switched off if it causes unwanted side effects.
-            module_cleanup_mode: Defines how the modules in the dynamic patcher are
-                cleaned up after the test. The default (AUTO) currently depends
-                on the availability of the `django` module, DELETE will delete
-                all dynamically loaded modules, RELOAD will reload them.
-                This option is subject to change in later versions.
         """
         self.is_doc_test = is_doc_test
         if is_doc_test:
             if self.DOC_REF_COUNT > 0:
                 return
         elif self.REF_COUNT > 0:
             return
@@ -614,27 +592,29 @@
             [] if sys.platform == "win32" else [tempfile]
         )
         if modules_to_reload is not None:
             self.modules_to_reload.extend(modules_to_reload)
         self.patch_default_args = patch_default_args
         self.use_cache = use_cache
         self.use_dynamic_patch = use_dynamic_patch
-        self.module_cleanup_mode = module_cleanup_mode
+        self.cleanup_handlers: Dict[str, Callable[[str], bool]] = {}
 
         if use_known_patches:
             from pyfakefs.patched_packages import (
                 get_modules_to_patch,
                 get_classes_to_patch,
                 get_fake_module_classes,
+                get_cleanup_handlers,
             )
 
             modules_to_patch = modules_to_patch or {}
             modules_to_patch.update(get_modules_to_patch())
             self._class_modules.update(get_classes_to_patch())
             self._fake_module_classes.update(get_fake_module_classes())
+            self.cleanup_handlers.update(get_cleanup_handlers())
 
         if modules_to_patch is not None:
             for name, fake_module in modules_to_patch.items():
                 self._fake_module_classes[name] = fake_module
             patched_module_names = set(modules_to_patch)
         else:
             patched_module_names = set()
@@ -676,14 +656,30 @@
         cls.FS_DEFARGS = []
         cls.SKIPPED_FS_MODULES = {}
 
     def clear_cache(self) -> None:
         """Clear the module cache (convenience instance method)."""
         self.__class__.clear_fs_cache()
 
+    def register_cleanup_handler(self, name: str, handler: Callable[[str], bool]):
+        """Register a handler for cleaning up a module after it had been loaded by
+        the dynamic patcher. This allows to handle modules that cannot be reloaded
+        without unwanted side effects.
+
+        Args:
+            name: The fully qualified module name.
+            handler: A callable that may do any module cleanup, or do nothing
+                and return `True` in case reloading shall be prevented.
+
+        Returns:
+            `True` if no further cleanup/reload shall occur after the handler is
+                executed, `False` if the cleanup/reload shall still happen.
+        """
+        self.cleanup_handlers[name] = handler
+
     def _init_fake_module_classes(self) -> None:
         # IMPORTANT TESTING NOTE: Whenever you add a new module below, test
         # it by adding an attribute in fixtures/module_with_attributes.py
         # and a test in fake_filesystem_unittest_test.py, class
         # TestAttributesWithFakeModuleNames.
         self._fake_module_classes = {
             "os": fake_os.FakeOsModule,
@@ -731,20 +727,20 @@
                                 OS_MODULE
                             ] = module_attr
 
         # special handling for functions in os.path
         fake_module = fake_filesystem.FakePathModule
         for fct_name in fake_module.dir():
             module_attr = (getattr(fake_module, fct_name), PATH_MODULE)
-            self._fake_module_functions.setdefault(fct_name, {})[
-                "genericpath"
-            ] = module_attr
-            self._fake_module_functions.setdefault(fct_name, {})[
-                PATH_MODULE
-            ] = module_attr
+            self._fake_module_functions.setdefault(fct_name, {})["genericpath"] = (
+                module_attr
+            )
+            self._fake_module_functions.setdefault(fct_name, {})[PATH_MODULE] = (
+                module_attr
+            )
 
     def __enter__(self) -> "Patcher":
         """Context manager for usage outside of
         fake_filesystem_unittest.TestCase.
         Ensure that all patched modules are removed in case of an
         unhandled exception.
         """
@@ -919,14 +915,18 @@
             sys.platform == "darwin"
             and hasattr(shutil, "_HAS_FCOPYFILE")
             and shutil._HAS_FCOPYFILE
         )
         if self.has_fcopy_file:
             shutil._HAS_FCOPYFILE = False  # type: ignore[attr-defined]
 
+        # do not use the fd functions, as they may not be available in the target OS
+        if hasattr(shutil, "_use_fd_functions"):
+            shutil._use_fd_functions = False  # type: ignore[module-attr]
+
         with warnings.catch_warnings():
             # ignore warnings, see #542 and #614
             warnings.filterwarnings("ignore")
             self._find_modules()
 
         self._refresh()
 
@@ -948,15 +948,15 @@
 
             self._dyn_patcher = DynamicPatcher(self)
             sys.meta_path.insert(0, self._dyn_patcher)
             for module in self.modules_to_reload:
                 if sys.modules.get(module.__name__) is module:
                     reload(module)
             if not self.use_dynamic_patch:
-                self._dyn_patcher.cleanup(ModuleCleanupMode.DELETE)
+                self._dyn_patcher.cleanup()
                 sys.meta_path.pop(0)
 
     def patch_functions(self) -> None:
         assert self._stubs is not None
         for (name, ft_name, ft_mod), modules in self.FS_FUNCTIONS.items():
             method, mod_name = self._fake_module_functions[ft_name][ft_mod]
             fake_module = self.fake_modules[mod_name]
@@ -1026,15 +1026,15 @@
             self._isStale = True
             self._patching = False
             self._paused = temporary
             if self._stubs:
                 self._stubs.smart_unset_all()
             self.unset_defaults()
             if self.use_dynamic_patch and self._dyn_patcher:
-                self._dyn_patcher.cleanup(self.module_cleanup_mode)
+                self._dyn_patcher.cleanup()
                 sys.meta_path.pop(0)
 
     @property
     def is_patching(self):
         return self._patching
 
     def unset_defaults(self) -> None:
@@ -1107,53 +1107,42 @@
     """
 
     def __init__(self, patcher: Patcher) -> None:
         self._patcher = patcher
         self.sysmodules = {}
         self.modules = self._patcher.fake_modules
         self._loaded_module_names: Set[str] = set()
+        self.cleanup_handlers = patcher.cleanup_handlers
 
         # remove all modules that have to be patched from `sys.modules`,
         # otherwise the find_... methods will not be called
         for name in self.modules:
             if self.needs_patch(name) and name in sys.modules:
                 self.sysmodules[name] = sys.modules[name]
                 del sys.modules[name]
 
         for name, module in self.modules.items():
             sys.modules[name] = module
 
-    def cleanup(self, cleanup_mode: ModuleCleanupMode) -> None:
+    def cleanup(self) -> None:
         for module_name in self.sysmodules:
             sys.modules[module_name] = self.sysmodules[module_name]
         for module in self._patcher.modules_to_reload:
             if module.__name__ in sys.modules:
                 reload(module)
         reloaded_module_names = [
             module.__name__ for module in self._patcher.modules_to_reload
         ]
         # Delete all modules loaded during the test, ensuring that
         # they are reloaded after the test.
-        # If cleanup_mode is set to RELOAD, or it is AUTO and django is imported,
-        # reload the modules instead - this is a workaround related to some internal
-        # module caching by django, that will likely change in the future.
-        if cleanup_mode == ModuleCleanupMode.AUTO:
-            if "django" in sys.modules:
-                cleanup_mode = ModuleCleanupMode.RELOAD
-            else:
-                cleanup_mode = ModuleCleanupMode.DELETE
         for name in self._loaded_module_names:
             if name in sys.modules and name not in reloaded_module_names:
-                if cleanup_mode == ModuleCleanupMode.RELOAD:
-                    try:
-                        reload(sys.modules[name])
-                    except Exception:
-                        del sys.modules[name]
-                else:
-                    del sys.modules[name]
+                if name in self.cleanup_handlers and self.cleanup_handlers[name](name):
+                    continue
+                del sys.modules[name]
 
     def needs_patch(self, name: str) -> bool:
         """Check if the module with the given name shall be replaced."""
         if name not in self.modules:
             self._loaded_module_names.add(name)
             return False
         if name in sys.modules and type(sys.modules[name]) is self.modules[name]:
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_io.py` & `pyfakefs-5.4.0/pyfakefs/fake_io.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,17 +8,18 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-""" Uses :py:class:`FakeIoModule` to provide a
-    fake ``io`` module replacement.
+"""Uses :py:class:`FakeIoModule` to provide a
+fake ``io`` module replacement.
 """
+
 import _io  # pytype: disable=import-error
 import io
 import os
 import sys
 import traceback
 from enum import Enum
 from typing import (
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_open.py` & `pyfakefs-5.4.0/pyfakefs/fake_open.py`

 * *Files 7% similar despite different names*

```diff
@@ -8,20 +8,19 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""A fake open() function replacement. See ``fake_filesystem`` for usage.
-"""
+"""A fake open() function replacement. See ``fake_filesystem`` for usage."""
+
 import errno
 import os
 import sys
-from collections import namedtuple
 from stat import (
     S_ISDIR,
 )
 from typing import (
     Optional,
     Union,
     Any,
@@ -39,25 +38,21 @@
     AnyFileWrapper,
 )
 from pyfakefs.helpers import (
     AnyString,
     is_root,
     PERM_READ,
     PERM_WRITE,
+    _OpenModes,
 )
 
 if TYPE_CHECKING:
     from pyfakefs.fake_filesystem import FakeFilesystem
 
 
-_OpenModes = namedtuple(
-    "_OpenModes",
-    "must_exist can_read can_write truncate append must_not_exist",
-)
-
 _OPEN_MODE_MAP = {
     # mode name:(file must exist, can read, can write,
     #            truncate, append, must not exist)
     "r": (True, True, False, False, False, False),
     "w": (False, False, True, True, False, False),
     "a": (False, False, True, False, True, False),
     "r+": (True, True, True, False, False, False),
@@ -144,24 +139,33 @@
         """
         binary = "b" in mode
 
         if binary and encoding:
             raise ValueError("binary mode doesn't take an encoding argument")
 
         newline, open_modes = self._handle_file_mode(mode, newline, open_modes)
+        opened_as_fd = isinstance(file_, int)
+        if opened_as_fd and not helpers.IS_PYPY:
+            fd: int = cast(int, file_)
+            # cannot open the same file descriptor twice, except in PyPy
+            for f in self.filesystem.get_open_files(fd):
+                if isinstance(f, FakeFileWrapper) and f.opened_as_fd:
+                    raise OSError(errno.EBADF, "Bad file descriptor")
 
         # the pathlib opener is defined in a Path instance that may not be
         # patched under some circumstances; as it just calls standard open(),
         # we may ignore it, as it would not change the behavior
         if opener is not None and opener.__module__ != "pathlib":
             # opener shall return a file descriptor, which will be handled
             # here as if directly passed
             file_ = opener(file_, self._open_flags_from_open_modes(open_modes))
 
-        file_object, file_path, filedes, real_path = self._handle_file_arg(file_)
+        file_object, file_path, filedes, real_path, can_write = self._handle_file_arg(
+            file_
+        )
         if file_object is None and file_path is None:
             # file must be a fake pipe wrapper, find it...
             if (
                 filedes is None
                 or len(self.filesystem.open_files) <= filedes
                 or not self.filesystem.open_files[filedes]
             ):
@@ -172,15 +176,15 @@
             assert isinstance(existing_wrapper, FakePipeWrapper)
             wrapper = FakePipeWrapper(
                 self.filesystem,
                 existing_wrapper.fd,
                 existing_wrapper.can_write,
                 mode,
             )
-            file_des = self.filesystem._add_open_file(wrapper)
+            file_des = self.filesystem.add_open_file(wrapper)
             wrapper.filedes = file_des
             return wrapper
 
         assert file_path is not None
         if not filedes:
             closefd = True
 
@@ -193,15 +197,19 @@
                 and not self.filesystem.is_windows_fs
             )
         ):
             self.filesystem.raise_os_error(errno.EEXIST, file_path)
 
         assert real_path is not None
         file_object = self._init_file_object(
-            file_object, file_path, open_modes, real_path
+            file_object,
+            file_path,
+            open_modes,
+            real_path,
+            check_file_permission=not opened_as_fd,
         )
 
         if S_ISDIR(file_object.st_mode):
             if self.filesystem.is_windows_fs:
                 self.filesystem.raise_os_error(errno.EACCES, file_path)
             else:
                 self.filesystem.raise_os_error(errno.EISDIR, file_path)
@@ -214,35 +222,36 @@
             file_object.st_mtime = current_time
             if not self.filesystem.is_windows_fs:
                 file_object.st_ctime = current_time
 
         fakefile = FakeFileWrapper(
             file_object,
             file_path,
-            update=open_modes.can_write,
+            update=open_modes.can_write and can_write,
             read=open_modes.can_read,
             append=open_modes.append,
             delete_on_close=self._delete_on_close,
             filesystem=self.filesystem,
             newline=newline,
             binary=binary,
             closefd=closefd,
             encoding=encoding,
             errors=errors,
             buffering=buffering,
             raw_io=self.raw_io,
+            opened_as_fd=opened_as_fd,
         )
         if filedes is not None:
             fakefile.filedes = filedes
             # replace the file wrapper
             open_files_list = self.filesystem.open_files[filedes]
             assert open_files_list is not None
             open_files_list.append(fakefile)
         else:
-            fakefile.filedes = self.filesystem._add_open_file(fakefile)
+            fakefile.filedes = self.filesystem.add_open_file(fakefile)
         return fakefile
 
     @staticmethod
     def _open_flags_from_open_modes(open_modes: _OpenModes) -> int:
         flags = 0
         if open_modes.can_read and open_modes.can_write:
             flags |= os.O_RDWR
@@ -263,24 +272,33 @@
 
     def _init_file_object(
         self,
         file_object: Optional[FakeFile],
         file_path: AnyStr,
         open_modes: _OpenModes,
         real_path: AnyString,
+        check_file_permission: bool,
     ) -> FakeFile:
         if file_object:
-            if not is_root() and (
-                (open_modes.can_read and not file_object.st_mode & PERM_READ)
-                or (open_modes.can_write and not file_object.st_mode & PERM_WRITE)
+            if (
+                check_file_permission
+                and not is_root()
+                and (
+                    (open_modes.can_read and not file_object.has_permission(PERM_READ))
+                    or (
+                        open_modes.can_write
+                        and not file_object.has_permission(PERM_WRITE)
+                    )
+                )
             ):
                 self.filesystem.raise_os_error(errno.EACCES, file_path)
             if open_modes.can_write:
                 if open_modes.truncate:
                     file_object.set_contents("")
+            file_object
         else:
             if open_modes.must_exist:
                 self.filesystem.raise_os_error(errno.ENOENT, file_path)
             if self.filesystem.islink(file_path):
                 link_object = self.filesystem.resolve(file_path, follow_symlinks=False)
                 assert link_object.contents is not None
                 target_path = cast(
@@ -288,58 +306,66 @@
                 )  # pytype: disable=invalid-annotation
             else:
                 target_path = file_path
             if self.filesystem.ends_with_path_separator(target_path):
                 error = (
                     errno.EINVAL
                     if self.filesystem.is_windows_fs
-                    else errno.ENOENT if self.filesystem.is_macos else errno.EISDIR
+                    else errno.ENOENT
+                    if self.filesystem.is_macos
+                    else errno.EISDIR
                 )
                 self.filesystem.raise_os_error(error, file_path)
             file_object = self.filesystem.create_file_internally(
                 real_path, create_missing_dirs=False, apply_umask=True
             )
         return file_object
 
     def _handle_file_arg(
         self, file_: Union[AnyStr, int]
-    ) -> Tuple[Optional[FakeFile], Optional[AnyStr], Optional[int], Optional[AnyStr]]:
+    ) -> Tuple[
+        Optional[FakeFile], Optional[AnyStr], Optional[int], Optional[AnyStr], bool
+    ]:
         file_object = None
         if isinstance(file_, int):
             # opening a file descriptor
             filedes: int = file_
             wrapper = self.filesystem.get_open_file(filedes)
+            can_write = True
             if isinstance(wrapper, FakePipeWrapper):
-                return None, None, filedes, None
+                return None, None, filedes, None, can_write
             if isinstance(wrapper, FakeFileWrapper):
                 self._delete_on_close = wrapper.delete_on_close
+                can_write = wrapper.allow_update
+
             file_object = cast(
                 FakeFile, self.filesystem.get_open_file(filedes).get_object()
             )
             assert file_object is not None
             path = file_object.name
             return (  # pytype: disable=bad-return-type
                 file_object,
                 cast(AnyStr, path),  # pytype: disable=invalid-annotation
                 filedes,
                 cast(AnyStr, path),  # pytype: disable=invalid-annotation
+                can_write,
             )
 
         # open a file file by path
         file_path = cast(AnyStr, file_)  # pytype: disable=invalid-annotation
         if file_path == self.filesystem.dev_null.name:
             file_object = self.filesystem.dev_null
             real_path = file_path
         else:
             real_path = self.filesystem.resolve_path(file_path)
             if self.filesystem.exists(file_path):
                 file_object = self.filesystem.get_object_from_normpath(
                     real_path, check_read_perm=False
                 )
-        return file_object, file_path, None, real_path
+        return file_object, file_path, None, real_path, True
 
     def _handle_file_mode(
         self,
         mode: str,
         newline: Optional[str],
         open_modes: Optional[_OpenModes],
     ) -> Tuple[Optional[str], _OpenModes]:
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_os.py` & `pyfakefs-5.4.0/pyfakefs/fake_os.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,17 +8,18 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-""" Uses :py:class:`FakeOsModule` to provide a
-    fake :py:mod:`os` module replacement.
+"""Uses :py:class:`FakeOsModule` to provide a
+fake :py:mod:`os` module replacement.
 """
+
 import errno
 import functools
 import inspect
 import os
 import sys
 import uuid
 from contextlib import contextmanager
@@ -97,20 +98,23 @@
         """
         _dir = [
             "access",
             "chdir",
             "chmod",
             "chown",
             "close",
+            "dup",
+            "dup2",
             "fstat",
             "fsync",
             "getcwd",
             "lchmod",
             "link",
             "listdir",
+            "lseek",
             "lstat",
             "makedirs",
             "mkdir",
             "mknod",
             "open",
             "read",
             "readlink",
@@ -215,15 +219,15 @@
 
     def open(
         self,
         path: AnyStr,
         flags: int,
         mode: Optional[int] = None,
         *,
-        dir_fd: Optional[int] = None
+        dir_fd: Optional[int] = None,
     ) -> int:
         """Return the file descriptor for a FakeFile.
 
         Args:
             path: the path to the file
             flags: low-level bits to indicate io operation
             mode: bits to define default permissions
@@ -243,14 +247,30 @@
         path = self._path_with_dir_fd(path, self.open, dir_fd)
         if mode is None:
             if self.filesystem.is_windows_fs:
                 mode = 0o666
             else:
                 mode = 0o777 & ~self._umask()
 
+        has_directory_flag = (
+            hasattr(os, "O_DIRECTORY") and flags & os.O_DIRECTORY == os.O_DIRECTORY
+        )
+        if (
+            has_directory_flag
+            and self.filesystem.exists(path)
+            and not self.filesystem.isdir(path)
+        ):
+            raise OSError(errno.ENOTDIR, "path is not a directory", path)
+
+        has_follow_flag = (
+            hasattr(os, "O_NOFOLLOW") and flags & os.O_NOFOLLOW == os.O_NOFOLLOW
+        )
+        if has_follow_flag and self.filesystem.islink(path):
+            raise OSError(errno.ELOOP, "path is a symlink", path)
+
         has_tmpfile_flag = (
             hasattr(os, "O_TMPFILE") and flags & os.O_TMPFILE == os.O_TMPFILE
         )
         open_modes = _OpenModes(
             must_exist=not flags & os.O_CREAT and not has_tmpfile_flag,
             can_read=not flags & os.O_WRONLY,
             can_write=flags & (os.O_RDWR | os.O_WRONLY) != 0,
@@ -274,15 +294,15 @@
             obj = self.filesystem.resolve(path)
             if isinstance(obj, FakeDirectory):
                 if (
                     not open_modes.must_exist and not self.filesystem.is_macos
                 ) or open_modes.can_write:
                     self.filesystem.raise_os_error(errno.EISDIR, path)
                 dir_wrapper = FakeDirWrapper(obj, path, self.filesystem)
-                file_des = self.filesystem._add_open_file(dir_wrapper)
+                file_des = self.filesystem.add_open_file(dir_wrapper)
                 dir_wrapper.filedes = file_des
                 return file_des
 
         # low level open is always binary
         str_flags = "b"
         delete_on_close = has_tmpfile_flag
         if hasattr(os, "O_TEMPORARY"):
@@ -302,15 +322,25 @@
             fd: An integer file descriptor for the file object requested.
 
         Raises:
             OSError: bad file descriptor.
             TypeError: if file descriptor is not an integer.
         """
         file_handle = self.filesystem.get_open_file(fd)
-        file_handle.close()
+        file_handle.close_fd(fd)
+
+    def dup(self, fd: int) -> int:
+        file_handle = self.filesystem.get_open_file(fd)
+        return self.filesystem.add_open_file(file_handle)
+
+    def dup2(self, fd: int, fd2: int, inheritable: bool = True) -> int:
+        if fd == fd2:
+            return fd
+        file_handle = self.filesystem.get_open_file(fd)
+        return self.filesystem.add_open_file(file_handle, fd2)
 
     def read(self, fd: int, n: int) -> bytes:
         """Read number of bytes from a file descriptor, returns bytes read.
 
         Args:
             fd: An integer file descriptor for the file object requested.
             n: Number of bytes to read from file.
@@ -353,21 +383,28 @@
         file_handle.raw_io = True
         file_handle._sync_io()
         file_handle.update_flush_pos()
         file_handle.write(contents)
         file_handle.flush()
         return len(contents)
 
+    def lseek(self, fd: int, pos: int, whence: int):
+        file_handle = self.filesystem.get_open_file(fd)
+        if isinstance(file_handle, FakeFileWrapper):
+            file_handle.seek(pos, whence)
+        else:
+            raise OSError(errno.EBADF, "Bad file descriptor for fseek")
+
     def pipe(self) -> Tuple[int, int]:
         read_fd, write_fd = os.pipe()
         read_wrapper = FakePipeWrapper(self.filesystem, read_fd, False)
-        file_des = self.filesystem._add_open_file(read_wrapper)
+        file_des = self.filesystem.add_open_file(read_wrapper)
         read_wrapper.filedes = file_des
         write_wrapper = FakePipeWrapper(self.filesystem, write_fd, True)
-        file_des = self.filesystem._add_open_file(write_wrapper)
+        file_des = self.filesystem.add_open_file(write_wrapper)
         write_wrapper.filedes = file_des
         return read_wrapper.filedes, write_wrapper.filedes
 
     def fstat(self, fd: int) -> FakeStatResult:
         """Return the os.stat-like tuple for the FakeFile object of file_des.
 
         Args:
@@ -418,15 +455,15 @@
             if self.filesystem.is_macos and exc.errno == errno.EBADF:
                 raise OSError(errno.ENOTDIR, "Not a directory: " + str(path))
             raise
         self.filesystem.confirmdir(path)
         directory = self.filesystem.resolve(path)
         # A full implementation would check permissions all the way
         # up the tree.
-        if not is_root() and not directory.st_mode | PERM_EXE:
+        if not is_root() and not directory.has_permission(PERM_EXE):
             self.filesystem.raise_os_error(errno.EACCES, directory.name)
         self.filesystem.cwd = path  # type: ignore[assignment]
 
     def getcwd(self) -> str:
         """Return current working directory."""
         return to_string(self.filesystem.cwd)
 
@@ -474,14 +511,16 @@
         """
         if not self.filesystem.is_linux:
             raise AttributeError("module 'os' has no attribute 'getxattr'")
 
         if isinstance(attribute, bytes):
             attribute = attribute.decode(sys.getfilesystemencoding())
         file_obj = self.filesystem.resolve(path, follow_symlinks, allow_fd=True)
+        if attribute not in file_obj.xattr:
+            raise OSError(errno.ENODATA, "No data available", path)
         return file_obj.xattr.get(attribute)
 
     def listxattr(
         self, path: Optional[AnyStr] = None, *, follow_symlinks: bool = True
     ) -> List[str]:
         """Return a list of the extended filesystem attributes on `path`.
 
@@ -534,15 +573,15 @@
     def setxattr(
         self,
         path: AnyStr,
         attribute: AnyString,
         value: bytes,
         flags: int = 0,
         *,
-        follow_symlinks: bool = True
+        follow_symlinks: bool = True,
     ) -> None:
         """Sets the value of the given extended filesystem attribute for
         `path`.
 
         Args:
             path: File path, file descriptor or path-like object.
             attribute: The attribute name (str or bytes).
@@ -630,15 +669,15 @@
         return self.filesystem.readlink(path)
 
     def stat(
         self,
         path: AnyStr,
         *,
         dir_fd: Optional[int] = None,
-        follow_symlinks: bool = True
+        follow_symlinks: bool = True,
     ) -> FakeStatResult:
         """Return the os.stat-like tuple for the FakeFile object of entry_path.
 
         Args:
             path:  path to filesystem object to retrieve.
             dir_fd: (int) If not `None`, the file descriptor of a directory,
                 with `entry_path` being relative to this directory.
@@ -667,15 +706,15 @@
         Returns:
             the FakeStatResult object corresponding to `path`.
 
         Raises:
             OSError: if the filesystem object doesn't exist.
         """
         # stat should return the tuple representing return value of os.stat
-        path = self._path_with_dir_fd(path, self.lstat, dir_fd)
+        path = self._path_with_dir_fd(path, self.lstat, dir_fd, check_supported=False)
         return self.filesystem.stat(path, follow_symlinks=False)
 
     def remove(self, path: AnyStr, dir_fd: Optional[int] = None) -> None:
         """Remove the FakeFile object at the specified file path.
 
         Args:
             path: Path to file to be removed.
@@ -683,15 +722,15 @@
                 with `path` being relative to this directory.
 
         Raises:
             OSError: if path points to a directory.
             OSError: if path does not exist.
             OSError: if removal failed.
         """
-        path = self._path_with_dir_fd(path, self.remove, dir_fd)
+        path = self._path_with_dir_fd(path, self.remove, dir_fd, check_supported=False)
         self.filesystem.remove(path)
 
     def unlink(self, path: AnyStr, *, dir_fd: Optional[int] = None) -> None:
         """Remove the FakeFile object at the specified file path.
 
         Args:
             path: Path to file to be removed.
@@ -708,15 +747,15 @@
 
     def rename(
         self,
         src: AnyStr,
         dst: AnyStr,
         *,
         src_dir_fd: Optional[int] = None,
-        dst_dir_fd: Optional[int] = None
+        dst_dir_fd: Optional[int] = None,
     ) -> None:
         """Rename a FakeFile object at old_file_path to new_file_path,
         preserving all properties.
         Also replaces existing new_file_path object, if one existed
         (Unix only).
 
         Args:
@@ -770,15 +809,15 @@
 
     def replace(
         self,
         src: AnyStr,
         dst: AnyStr,
         *,
         src_dir_fd: Optional[int] = None,
-        dst_dir_fd: Optional[int] = None
+        dst_dir_fd: Optional[int] = None,
     ) -> None:
         """Renames a FakeFile object at old_file_path to new_file_path,
         preserving all properties.
         Also replaces existing new_file_path object, if one existed.
 
         Arg
             src: Path to filesystem object to rename.
@@ -794,16 +833,20 @@
             OSError: if new_file_path is an existing directory.
             OSError: if new_file_path is an existing file and could
                 not be removed
             OSError: if `dirname(new_file)` does not exist
             OSError: if the file would be moved to another filesystem
                 (e.g. mount point)
         """
-        src = self._path_with_dir_fd(src, self.rename, src_dir_fd)
-        dst = self._path_with_dir_fd(dst, self.rename, dst_dir_fd)
+        src = self._path_with_dir_fd(
+            src, self.rename, src_dir_fd, check_supported=False
+        )
+        dst = self._path_with_dir_fd(
+            dst, self.rename, dst_dir_fd, check_supported=False
+        )
         self.filesystem.rename(src, dst, force_replace=True)
 
     def rmdir(self, path: AnyStr, *, dir_fd: Optional[int] = None) -> None:
         """Remove a leaf Fake directory.
 
         Args:
             path: (str) Name of directory to remove.
@@ -884,28 +927,52 @@
 
         Raises:
             OSError: if the directory already exists and exist_ok=False, or as
                 per :py:meth:`FakeFilesystem.create_dir`.
         """
         if exist_ok is None:
             exist_ok = False
-        self.filesystem.makedirs(name, mode, exist_ok)
+
+        # copied and adapted from real implementation in os.py (Python 3.12)
+        head, tail = self.filesystem.splitpath(name)
+        if not tail:
+            head, tail = self.filesystem.splitpath(head)
+        if head and tail and not self.filesystem.exists(head):
+            try:
+                self.makedirs(head, exist_ok=exist_ok)
+            except FileExistsError:
+                pass
+            cdir = self.filesystem.cwd
+            if isinstance(tail, bytes):
+                if tail == bytes(cdir, "ASCII"):
+                    return
+            elif tail == cdir:
+                return
+        try:
+            self.mkdir(name, mode)
+        except OSError:
+            if not exist_ok or not self.filesystem.isdir(name):
+                raise
 
     def _path_with_dir_fd(
-        self, path: AnyStr, fct: Callable, dir_fd: Optional[int]
+        self,
+        path: AnyStr,
+        fct: Callable,
+        dir_fd: Optional[int],
+        check_supported: bool = True,
     ) -> AnyStr:
         """Return the path considering dir_fd. Raise on invalid parameters."""
         try:
             path = make_string_path(path)
         except TypeError:
             # the error is handled later
             path = path
         if dir_fd is not None:
             # check if fd is supported for the built-in real function
-            if fct not in self.supports_dir_fd:
+            if check_supported and (fct not in self.supports_dir_fd):
                 raise NotImplementedError("dir_fd unavailable on this platform")
             if isinstance(path, int):
                 raise ValueError(
                     "%s: Can't specify dir_fd without "
                     "matching path_str" % fct.__name__
                 )
             if not self.path.isabs(path):
@@ -953,15 +1020,15 @@
     def access(
         self,
         path: AnyStr,
         mode: int,
         *,
         dir_fd: Optional[int] = None,
         effective_ids: bool = False,
-        follow_symlinks: bool = True
+        follow_symlinks: bool = True,
     ) -> bool:
         """Check if a file exists and has the specified permissions.
 
         Args:
             path: (str) Path to the file.
             mode: (int) Permissions represented as a bitwise-OR combination of
                 os.F_OK, os.R_OK, os.W_OK, and os.X_OK.
@@ -991,15 +1058,15 @@
 
     def chmod(
         self,
         path: AnyStr,
         mode: int,
         *,
         dir_fd: Optional[int] = None,
-        follow_symlinks: bool = True
+        follow_symlinks: bool = True,
     ) -> None:
         """Change the permissions of a file as encoded in integer mode.
 
         Args:
             path: (str) Path to the file.
             mode: (int) Permissions.
             dir_fd: If not `None`, the file descriptor of a directory, with
@@ -1063,15 +1130,15 @@
     def chown(
         self,
         path: AnyStr,
         uid: int,
         gid: int,
         *,
         dir_fd: Optional[int] = None,
-        follow_symlinks: bool = True
+        follow_symlinks: bool = True,
     ) -> None:
         """Set ownership of a faked file.
 
         Args:
             path: (str) Path to the file or directory.
             uid: (int) Numeric uid to set the file or directory to.
             gid: (int) Numeric gid to set the file or directory to.
@@ -1098,15 +1165,15 @@
 
     def mknod(
         self,
         path: AnyStr,
         mode: Optional[int] = None,
         device: int = 0,
         *,
-        dir_fd: Optional[int] = None
+        dir_fd: Optional[int] = None,
     ) -> None:
         """Create a filesystem node named 'filename'.
 
         Does not support device special files or named pipes as the real os
         module does.
 
         Args:
@@ -1149,56 +1216,64 @@
 
     def symlink(
         self,
         src: AnyStr,
         dst: AnyStr,
         target_is_directory: bool = False,
         *,
-        dir_fd: Optional[int] = None
+        dir_fd: Optional[int] = None,
     ) -> None:
         """Creates the specified symlink, pointed at the specified link target.
 
         Args:
             src: The target of the symlink.
             dst: Path to the symlink to create.
             target_is_directory: Currently ignored.
             dir_fd: If not `None`, the file descriptor of a directory,
-                with `src` being relative to this directory.
+                with `dst` being relative to this directory.
 
         Raises:
             OSError:  if the file already exists.
         """
-        src = self._path_with_dir_fd(src, self.symlink, dir_fd)
+        dst = self._path_with_dir_fd(dst, self.symlink, dir_fd)
         self.filesystem.create_symlink(dst, src, create_missing_dirs=False)
 
     def link(
         self,
         src: AnyStr,
         dst: AnyStr,
         *,
         src_dir_fd: Optional[int] = None,
-        dst_dir_fd: Optional[int] = None
+        dst_dir_fd: Optional[int] = None,
+        follow_symlinks: Optional[bool] = None,
     ) -> None:
-        """Create a hard link at new_path, pointing at old_path.
+        """Create a hard link at dst, pointing at src.
 
         Args:
             src: An existing path to the target file.
             dst: The destination path to create a new link at.
             src_dir_fd: If not `None`, the file descriptor of a directory,
                 with `src` being relative to this directory.
             dst_dir_fd: If not `None`, the file descriptor of a directory,
                 with `dst` being relative to this directory.
+            follow_symlinks: (bool) If True (the default), symlinks in the
+                path are traversed.
 
         Raises:
             OSError:  if something already exists at new_path.
             OSError:  if the parent directory doesn't exist.
         """
+        if IS_PYPY and follow_symlinks is not None:
+            raise OSError(errno.EINVAL, "Invalid argument: follow_symlinks")
+        if follow_symlinks is None:
+            follow_symlinks = True
+
         src = self._path_with_dir_fd(src, self.link, src_dir_fd)
         dst = self._path_with_dir_fd(dst, self.link, dst_dir_fd)
-        self.filesystem.link(src, dst)
+        self.filesystem.link(src, dst, follow_symlinks=follow_symlinks)
 
     def fsync(self, fd: int) -> None:
         """Perform fsync for a fake file (in other words, do nothing).
 
         Args:
             fd: The file descriptor of the open file.
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_path.py` & `pyfakefs-5.4.0/pyfakefs/fake_path.py`

 * *Files 0% similar despite different names*

```diff
@@ -8,16 +8,16 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-""" Faked ``os.path`` module replacement. See ``fake_filesystem`` for usage.
-"""
+"""Faked ``os.path`` module replacement. See ``fake_filesystem`` for usage."""
+
 import errno
 import os
 import sys
 from stat import (
     S_IFDIR,
     S_IFMT,
 )
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_pathlib.py` & `pyfakefs-5.4.0/pyfakefs/fake_pathlib.py`

 * *Files 0% similar despite different names*

```diff
@@ -24,14 +24,15 @@
   `fake_pathlib_module = fake_filesystem.FakePathlibModule(filesystem)`
   `path = fake_pathlib_module.Path('/foo/bar')`
 
 Note: as the implementation is based on FakeFilesystem, all faked classes
 (including PurePosixPath, PosixPath, PureWindowsPath and WindowsPath)
 get the properties of the underlying fake filesystem.
 """
+
 import errno
 import fnmatch
 import functools
 import inspect
 import ntpath
 import os
 import pathlib
@@ -744,15 +745,15 @@
         self._raise_on_closed()
         if self.exists():
             if exist_ok:
                 self.filesystem.utime(self._path(), times=None)
             else:
                 self.filesystem.raise_os_error(errno.EEXIST, self._path())
         else:
-            fake_file = self.open("w")
+            fake_file = self.open("w", encoding="utf8")
             fake_file.close()
             self.chmod(mode)
 
     if sys.version_info >= (3, 12):
         """These are reimplemented for now because the original implementation
         checks the flavour against ntpath/posixpath.
         """
```

### Comparing `pyfakefs-5.3.5/pyfakefs/fake_scandir.py` & `pyfakefs-5.4.0/pyfakefs/fake_scandir.py`

 * *Files 0% similar despite different names*

```diff
@@ -12,14 +12,15 @@
 
 """A fake implementation for the `scandir` function working with
 FakeFilesystem.
 Works with both the function integrated into the `os` module since Python 3.5
 and the standalone function available in the standalone `scandir` python
 package.
 """
+
 import os
 import sys
 
 from pyfakefs.extra_packages import use_scandir_package
 from pyfakefs.helpers import to_string, make_string_path
 
 if sys.version_info >= (3, 6):
@@ -142,15 +143,15 @@
                 self.filesystem.get_open_file(path).get_object().path
             )
             self.path = ""
         else:
             path = make_string_path(path)
             self.abspath = self.filesystem.absnormpath(path)
             self.path = to_string(path)
-        entries = self.filesystem.confirmdir(self.abspath).entries
+        entries = self.filesystem.confirmdir(self.abspath, check_exe_perm=False).entries
         self.entry_iter = iter(entries)
 
     def __iter__(self):
         return self
 
     def __next__(self):
         entry = self.entry_iter.__next__()
```

### Comparing `pyfakefs-5.3.5/pyfakefs/helpers.py` & `pyfakefs-5.4.0/pyfakefs/helpers.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,21 +7,23 @@
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """Helper classes use for fake file system implementation."""
+
 import io
 import locale
 import os
 import platform
 import stat
 import sys
 import time
+from collections import namedtuple
 from copy import copy
 from stat import S_IFLNK
 from typing import Union, Optional, Any, AnyStr, overload, cast
 
 AnyString = Union[str, bytes]
 AnyPath = Union[AnyStr, os.PathLike]
 
@@ -32,14 +34,19 @@
 PERM_READ = 0o400  # Read permission bit.
 PERM_WRITE = 0o200  # Write permission bit.
 PERM_EXE = 0o100  # Execute permission bit.
 PERM_DEF = 0o777  # Default permission bits.
 PERM_DEF_FILE = 0o666  # Default permission bits (regular file)
 PERM_ALL = 0o7777  # All permission bits.
 
+_OpenModes = namedtuple(
+    "_OpenModes",
+    "must_exist can_read can_write truncate append must_not_exist",
+)
+
 if sys.platform == "win32":
     USER_ID = 1
     GROUP_ID = 1
 else:
     USER_ID = os.getuid()
     GROUP_ID = os.getgid()
 
@@ -105,14 +112,20 @@
 
 def is_unicode_string(val: Any) -> bool:
     """Return True if `val` is a unicode string, False for a bytes-like
     object."""
     return hasattr(val, "encode")
 
 
+def get_locale_encoding():
+    if sys.version_info >= (3, 11):
+        return locale.getencoding()
+    return locale.getpreferredencoding(False)
+
+
 @overload
 def make_string_path(dir_name: AnyStr) -> AnyStr: ...
 
 
 @overload
 def make_string_path(dir_name: os.PathLike) -> str: ...
 
@@ -121,23 +134,23 @@
     return cast(AnyStr, os.fspath(dir_name))  # pytype: disable=invalid-annotation
 
 
 def to_string(path: Union[AnyStr, Union[str, bytes]]) -> str:
     """Return the string representation of a byte string using the preferred
     encoding, or the string itself if path is a str."""
     if isinstance(path, bytes):
-        return path.decode(locale.getpreferredencoding(False))
+        return path.decode(get_locale_encoding())
     return path
 
 
 def to_bytes(path: Union[AnyStr, Union[str, bytes]]) -> bytes:
     """Return the bytes representation of a string using the preferred
     encoding, or the byte string itself if path is a byte string."""
     if isinstance(path, str):
-        return bytes(path, locale.getpreferredencoding(False))
+        return bytes(path, get_locale_encoding())
     return path
 
 
 def join_strings(s1: AnyStr, s2: AnyStr) -> AnyStr:
     """This is a bit of a hack to satisfy mypy - may be refactored."""
     return s1 + s2
 
@@ -172,15 +185,15 @@
 ) -> Optional[AnyString]:
     """Return the string as byte or unicode depending
     on the type of matched, assuming string is an ASCII string.
     """
     if string is None:
         return string
     if isinstance(matched, bytes) and isinstance(string, str):
-        return string.encode(locale.getpreferredencoding(False))
+        return string.encode(get_locale_encoding())
     return string  # pytype: disable=bad-return-type
 
 
 class FakeStatResult:
     """Mimics os.stat_result for use as return type of `stat()` and similar.
     This is needed as `os.stat_result` has no possibility to set
     nanosecond times directly.
```

### Comparing `pyfakefs-5.3.5/pyfakefs/mox3_stubout.py` & `pyfakefs-5.4.0/pyfakefs/mox3_stubout.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/patched_packages.py` & `pyfakefs-5.4.0/pyfakefs/patched_packages.py`

 * *Files 24% similar despite different names*

```diff
@@ -10,30 +10,45 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """
 Provides patches for some commonly used modules that enable them to work
 with pyfakefs.
 """
+
 import sys
+from importlib import reload
 
 try:
     import pandas as pd
-    import pandas.io.parsers as parsers
+
+    try:
+        import pandas.io.parsers as parsers
+    except ImportError:
+        parsers = None
 except ImportError:
+    pd = None
     parsers = None
 
+
 try:
     import xlrd
 except ImportError:
     xlrd = None
 
+
 try:
-    from django.core.files import locks
+    import django
+
+    try:
+        from django.core.files import locks
+    except ImportError:
+        locks = None
 except ImportError:
+    django = None
     locks = None
 
 # From pandas v 1.2 onwards the python fs functions are used even when the engine
 # selected is "c". This means that we don't explicitly have to change the engine.
 patch_pandas = parsers is not None and [int(v) for v in pd.__version__.split(".")] < [
     1,
     2,
@@ -53,14 +68,32 @@
 def get_classes_to_patch():
     classes_to_patch = {}
     if patch_pandas:
         classes_to_patch["TextFileReader"] = ["pandas.io.parsers"]
     return classes_to_patch
 
 
+def reload_handler(name):
+    if name in sys.modules:
+        reload(sys.modules[name])
+    return True
+
+
+def get_cleanup_handlers():
+    handlers = {}
+    if pd is not None:
+        handlers["pandas.core.arrays.arrow.extension_types"] = (
+            handle_extension_type_cleanup
+        )
+    if django is not None:
+        for module_name in django_view_modules():
+            handlers[module_name] = lambda name=module_name: reload_handler(name)
+    return handlers
+
+
 def get_fake_module_classes():
     fake_module_classes = {}
     if patch_pandas:
         fake_module_classes["TextFileReader"] = FakeTextFileReader
     return fake_module_classes
 
 
@@ -130,14 +163,31 @@
                 super().__init__(*args, **kwargs)
 
         def __getattr__(self, name):
             """Forwards any unfaked calls to the standard xlrd module."""
             return getattr(self._parsers_module, name)
 
 
+if pd is not None:
+
+    def handle_extension_type_cleanup(_name):
+        # the module registers two extension types on load
+        # on reload it raises if the extensions have not been unregistered before
+        try:
+            import pyarrow
+
+            # the code to register these types has been in the module
+            # since it was created (in pandas 1.5)
+            pyarrow.unregister_extension_type("pandas.interval")
+            pyarrow.unregister_extension_type("pandas.period")
+        except ImportError:
+            pass
+        return False
+
+
 if locks is not None:
 
     class FakeLocks:
         """django.core.files.locks uses low level OS functions, fake it."""
 
         _locks_module = locks
 
@@ -150,7 +200,35 @@
 
         @staticmethod
         def unlock(f):
             return True
 
         def __getattr__(self, name):
             return getattr(self._locks_module, name)
+
+
+if django is not None:
+
+    def get_all_view_modules(urlpatterns, modules=None):
+        if modules is None:
+            modules = set()
+        for pattern in urlpatterns:
+            if hasattr(pattern, "url_patterns"):
+                get_all_view_modules(pattern.url_patterns, modules=modules)
+            else:
+                if hasattr(pattern.callback, "cls"):
+                    view = pattern.callback.cls
+                elif hasattr(pattern.callback, "view_class"):
+                    view = pattern.callback.view_class
+                else:
+                    view = pattern.callback
+                modules.add(view.__module__)
+        return modules
+
+    def django_view_modules():
+        try:
+            all_urlpatterns = __import__(
+                django.conf.settings.ROOT_URLCONF
+            ).urls.urlpatterns
+            return get_all_view_modules(all_urlpatterns)
+        except Exception:
+            return set()
```

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_plugin.py` & `pyfakefs-5.4.0/pyfakefs/pytest_plugin.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/conftest.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/conftest.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/example.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/example.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_check_failed_plugin_test.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_check_failed_plugin_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_doctest_test.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_doctest_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_fixture_param_test.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_fixture_param_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_fixture_test.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_fixture_test.py`

 * *Files 10% similar despite different names*

```diff
@@ -9,18 +9,18 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 # Example for a test using a custom pytest fixture with an argument to Patcher
 
 import pytest
-import undefined
 
 import pyfakefs.pytest_tests.example as example
 from pyfakefs.fake_filesystem_unittest import Patcher
+from pyfakefs.pytest_tests import unhashable
 
 
 @pytest.mark.xfail
 def test_example_file_failing(fs):
     """Test fails because EXAMPLE_FILE is cached in the module
     and not patched."""
     fs.create_file(example.EXAMPLE_FILE, contents="stuff here")
@@ -38,18 +38,17 @@
     """Test passes if using a Patcher instance that reloads the module
     containing EXAMPLE_FILE"""
     with Patcher(modules_to_reload=[example]) as patcher:
         patcher.fs.create_file(example.EXAMPLE_FILE, contents="stuff here")
         check_that_example_file_is_in_fake_fs()
 
 
-def test_undefined(fs):
+def test_unhashable(fs):
     # regression test for #923
-    with pytest.raises(NotImplementedError):
-        print(undefined)
+    print(unhashable)
 
 
 def check_that_example_file_is_in_fake_fs():
     with open(example.EXAMPLE_FILE) as file:
         assert file.read() == "stuff here"
     with example.EXAMPLE_FILE.open() as file:
         assert file.read() == "stuff here"
```

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_module_fixture_test.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_module_fixture_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/pytest_tests/pytest_plugin_test.py` & `pyfakefs-5.4.0/pyfakefs/pytest_tests/pytest_plugin_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/all_tests.py` & `pyfakefs-5.4.0/pyfakefs/tests/all_tests.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/all_tests_without_extra_packages.py` & `pyfakefs-5.4.0/pyfakefs/tests/all_tests_without_extra_packages.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/dynamic_patch_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/dynamic_patch_test.py`

 * *Files 4% similar despite different names*

```diff
@@ -9,14 +9,15 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """
 Tests for patching modules loaded after `setUpPyfakefs()`.
 """
+
 import pathlib
 import unittest
 
 from pyfakefs import fake_filesystem_unittest
 
 
 class TestPyfakefsUnittestBase(fake_filesystem_unittest.TestCase):
@@ -55,15 +56,15 @@
 
         self.fs.set_disk_usage(100)
         self.assertEqual(100, shutil.disk_usage("/").total)
 
     def test_pathlib_path_patch(self):
         file_path = "test.txt"
         path = pathlib.Path(file_path)
-        with path.open("w") as f:
+        with path.open("w", encoding="utf8") as f:
             f.write("test")
 
         self.assertTrue(self.fs.exists(file_path))
         file_object = self.fs.get_object(file_path)
         self.assertEqual("test", file_object.contents)
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/example.py` & `pyfakefs-5.4.0/pyfakefs/tests/example.py`

 * *Files 1% similar despite different names*

```diff
@@ -57,20 +57,20 @@
     >>> os.path.isdir('/test')
     True
     >>> os.path.exists('/test/file.txt')
     False
     >>> create_file('/test/file.txt')
     >>> os.path.exists('/test/file.txt')
     True
-    >>> with open('/test/file.txt') as f:
+    >>> with open('/test/file.txt', encoding='utf8') as f:
     ...     f.readlines()
     ["This is test file '/test/file.txt'.\\n", \
 'It was created using open().\\n']
     """
-    with open(path, "w") as f:
+    with open(path, "w", encoding="utf8") as f:
         f.write("This is test file '{0}'.\n".format(path))
         f.write("It was created using open().\n")
 
 
 def delete_file(path):
     """Delete the specified file.
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/example_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/example_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_glob_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_glob_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_shutil_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_shutil_test.py`

 * *Files 1% similar despite different names*

```diff
@@ -13,14 +13,15 @@
 # limitations under the License.
 
 """Tests for `fake_filesystem_shutil` if used in
 `fake_filesystem_unittest.TestCase`.
 Note that almost all of the functionality is delegated to the real `shutil`
 and works correctly with the fake filesystem because of the faked `os` module.
 """
+
 import os
 import shutil
 import sys
 import tempfile
 import unittest
 from pathlib import Path
 
@@ -133,26 +134,26 @@
     @unittest.skipIf(is_windows, "Posix specific behavior")
     def test_rmtree_with_open_file_posix(self):
         self.check_posix_only()
         dir_path = self.make_path("foo")
         self.create_file(os.path.join(dir_path, "bar"))
         file_path = os.path.join(dir_path, "baz")
         self.create_file(file_path)
-        with open(file_path):
+        with open(file_path, encoding="utf8"):
             shutil.rmtree(dir_path)
         self.assertFalse(os.path.exists(file_path))
 
     @unittest.skipIf(not is_windows, "Windows specific behavior")
     def test_rmtree_with_open_file_fails_under_windows(self):
         self.check_windows_only()
         dir_path = self.make_path("foo")
         self.create_file(os.path.join(dir_path, "bar"))
         file_path = os.path.join(dir_path, "baz")
         self.create_file(file_path)
-        with open(file_path):
+        with open(file_path, encoding="utf8"):
             with self.assertRaises(OSError):
                 shutil.rmtree(dir_path)
         self.assertTrue(os.path.exists(dir_path))
 
     def test_rmtree_non_existing_dir(self):
         directory = "nonexisting"
         with self.assertRaises(OSError):
@@ -187,14 +188,23 @@
         except OSError:
             self.fail("rmtree raised exception despite ignore_errors True")
         # ignore_errors is True, so the onerror() error handler was
         # not executed
         self.assertFalse(NonLocal.errorHandled)
         self.assertEqual(NonLocal.errorPath, "")
 
+    def test_rmtree_in_windows(self):
+        # regression test for #979
+        self.check_windows_only()
+        base_path = self.make_path("foo", "bar")
+        self.os.makedirs(self.os.path.join(base_path, "res"))
+        self.assertTrue(self.os.path.exists(base_path))
+        shutil.rmtree(base_path)
+        self.assertFalse(self.os.path.exists(base_path))
+
     def test_copy(self):
         src_file = self.make_path("xyzzy")
         dst_file = self.make_path("xyzzy_copy")
         self.create_file(src_file)
         os.chmod(src_file, 0o750)
         self.assertTrue(os.path.exists(src_file))
         self.assertFalse(os.path.exists(dst_file))
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_test.py`

 * *Files 1% similar despite different names*

```diff
@@ -1597,5263 +1597,5291 @@
 000063c0: 290a 2020 2020 2020 2020 7061 7468 203d  ).        path =
 000063d0: 2022 666f 6f2f 6261 722f 6261 7a22 0a20   "foo/bar/baz". 
 000063e0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
 000063f0: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
 00006400: 6c65 2870 6174 682c 2063 6f6e 7465 6e74  le(path, content
 00006410: 733d 4e6f 6e65 290a 2020 2020 2020 2020  s=None).        
 00006420: 7769 7468 2066 616b 655f 6f70 656e 2870  with fake_open(p
-00006430: 6174 6829 2061 7320 663a 0a20 2020 2020  ath) as f:.     
-00006440: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00006450: 7274 4571 7561 6c28 2222 2c20 662e 7265  rtEqual("", f.re
-00006460: 6164 2829 290a 0a20 2020 2064 6566 2074  ad())..    def t
-00006470: 6573 745f 6372 6561 7465 5f66 696c 655f  est_create_file_
-00006480: 7769 7468 5f69 6e63 6f72 7265 6374 5f6d  with_incorrect_m
-00006490: 6f64 655f 7479 7065 2873 656c 6629 3a0a  ode_type(self):.
-000064a0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000064b0: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
-000064c0: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
-000064d0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-000064e0: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
-000064f0: 6c65 2822 666f 6f22 2c20 2262 6172 2229  le("foo", "bar")
-00006500: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-00006510: 7265 6174 655f 6669 6c65 5f61 6c72 6561  reate_file_alrea
-00006520: 6479 5f65 7869 7374 735f 6572 726f 7228  dy_exists_error(
-00006530: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
-00006540: 6174 6820 3d20 2266 6f6f 2f62 6172 2f62  ath = "foo/bar/b
-00006550: 617a 220a 2020 2020 2020 2020 7365 6c66  az".        self
-00006560: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-00006570: 7465 5f66 696c 6528 7061 7468 2c20 636f  te_file(path, co
-00006580: 6e74 656e 7473 3d22 6475 6d6d 795f 6461  ntents="dummy_da
-00006590: 7461 2229 0a20 2020 2020 2020 2077 6974  ta").        wit
-000065a0: 6820 7365 6c66 2e72 6169 7365 735f 6f73  h self.raises_os
-000065b0: 5f65 7272 6f72 2865 7272 6e6f 2e45 4558  _error(errno.EEX
-000065c0: 4953 5429 3a0a 2020 2020 2020 2020 2020  IST):.          
-000065d0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-000065e0: 6d2e 6372 6561 7465 5f66 696c 6528 7061  m.create_file(pa
-000065f0: 7468 290a 0a20 2020 2064 6566 2074 6573  th)..    def tes
-00006600: 745f 6372 6561 7465 5f6c 696e 6b28 7365  t_create_link(se
-00006610: 6c66 293a 0a20 2020 2020 2020 2070 6174  lf):.        pat
-00006620: 6820 3d20 2266 6f6f 2f62 6172 2f62 617a  h = "foo/bar/baz
-00006630: 220a 2020 2020 2020 2020 7461 7267 6574  ".        target
-00006640: 5f70 6174 6820 3d20 2266 6f6f 2f62 6172  _path = "foo/bar
-00006650: 2f71 7575 7822 0a20 2020 2020 2020 206e  /quux".        n
-00006660: 6577 5f66 696c 6520 3d20 7365 6c66 2e66  ew_file = self.f
-00006670: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
-00006680: 5f73 796d 6c69 6e6b 2870 6174 682c 2022  _symlink(path, "
-00006690: 7175 7578 2229 0a20 2020 2020 2020 2023  quux").        #
-000066a0: 204e 6569 7468 6572 2074 6865 2070 6174   Neither the pat
-000066b0: 6820 6e6f 7220 7468 6520 6669 6e61 6c20  h nor the final 
-000066c0: 7461 7267 6574 2065 7869 7374 7320 6265  target exists be
-000066d0: 666f 7265 2077 6520 6163 7475 616c 6c79  fore we actually
-000066e0: 0a20 2020 2020 2020 2023 2077 7269 7465  .        # write
-000066f0: 2074 6f20 6f6e 6520 6f66 2074 6865 6d2c   to one of them,
-00006700: 2065 7665 6e20 7468 6f75 6768 2074 6865   even though the
-00006710: 206c 696e 6b20 6170 7065 6172 7320 696e   link appears in
-00006720: 2074 6865 2066 696c 650a 2020 2020 2020   the file.      
-00006730: 2020 2320 7379 7374 656d 2e0a 2020 2020    # system..    
-00006740: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
-00006750: 616c 7365 2873 656c 662e 6669 6c65 7379  alse(self.filesy
-00006760: 7374 656d 2e65 7869 7374 7328 7061 7468  stem.exists(path
-00006770: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00006780: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
-00006790: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
-000067a0: 7473 2874 6172 6765 745f 7061 7468 2929  ts(target_path))
-000067b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000067c0: 7365 7274 5472 7565 2873 7461 742e 535f  sertTrue(stat.S_
-000067d0: 4946 4c4e 4b20 2620 6e65 775f 6669 6c65  IFLNK & new_file
-000067e0: 2e73 745f 6d6f 6465 290a 0a20 2020 2020  .st_mode)..     
-000067f0: 2020 2023 2062 7574 206f 6e63 6520 7765     # but once we
-00006800: 2077 7269 7465 2074 6865 206c 696e 6b65   write the linke
-00006810: 6420 746f 2066 696c 652c 2074 6865 7920  d to file, they 
-00006820: 626f 7468 2077 696c 6c20 6578 6973 742e  both will exist.
-00006830: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00006840: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-00006850: 6669 6c65 2874 6172 6765 745f 7061 7468  file(target_path
-00006860: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006870: 7373 6572 7454 7275 6528 7365 6c66 2e66  ssertTrue(self.f
-00006880: 696c 6573 7973 7465 6d2e 6578 6973 7473  ilesystem.exists
-00006890: 2870 6174 6829 290a 2020 2020 2020 2020  (path)).        
-000068a0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-000068b0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-000068c0: 6578 6973 7473 2874 6172 6765 745f 7061  exists(target_pa
-000068d0: 7468 2929 0a0a 2020 2020 6465 6620 7465  th))..    def te
-000068e0: 7374 5f72 6573 6f6c 7665 5f6f 626a 6563  st_resolve_objec
-000068f0: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00006900: 2074 6172 6765 745f 7061 7468 203d 2022   target_path = "
-00006910: 6469 722f 7461 7267 6574 220a 2020 2020  dir/target".    
-00006920: 2020 2020 7461 7267 6574 5f63 6f6e 7465      target_conte
-00006930: 6e74 7320 3d20 2230 3132 3334 3536 3738  nts = "012345678
-00006940: 3941 4243 4445 4622 0a20 2020 2020 2020  9ABCDEF".       
-00006950: 206c 696e 6b5f 6e61 6d65 203d 2022 7822   link_name = "x"
-00006960: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00006970: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-00006980: 6469 7228 2264 6972 2229 0a20 2020 2020  dir("dir").     
-00006990: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-000069a0: 656d 2e63 7265 6174 655f 6669 6c65 2822  em.create_file("
-000069b0: 6469 722f 7461 7267 6574 222c 2063 6f6e  dir/target", con
-000069c0: 7465 6e74 733d 7461 7267 6574 5f63 6f6e  tents=target_con
-000069d0: 7465 6e74 7329 0a20 2020 2020 2020 2073  tents).        s
-000069e0: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-000069f0: 7265 6174 655f 7379 6d6c 696e 6b28 6c69  reate_symlink(li
-00006a00: 6e6b 5f6e 616d 652c 2074 6172 6765 745f  nk_name, target_
-00006a10: 7061 7468 290a 2020 2020 2020 2020 6f62  path).        ob
-00006a20: 6a20 3d20 7365 6c66 2e66 696c 6573 7973  j = self.filesys
-00006a30: 7465 6d2e 7265 736f 6c76 6528 6c69 6e6b  tem.resolve(link
-00006a40: 5f6e 616d 6529 0a20 2020 2020 2020 2073  _name).        s
-00006a50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006a60: 2274 6172 6765 7422 2c20 6f62 6a2e 6e61  "target", obj.na
-00006a70: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
-00006a80: 2e61 7373 6572 7445 7175 616c 2874 6172  .assertEqual(tar
-00006a90: 6765 745f 636f 6e74 656e 7473 2c20 6f62  get_contents, ob
-00006aa0: 6a2e 636f 6e74 656e 7473 290a 0a20 2020  j.contents)..   
-00006ab0: 2064 6566 2063 6865 636b 5f6c 7265 736f   def check_lreso
-00006ac0: 6c76 655f 6f62 6a65 6374 2873 656c 6629  lve_object(self)
-00006ad0: 3a0a 2020 2020 2020 2020 7461 7267 6574  :.        target
-00006ae0: 5f70 6174 6820 3d20 2264 6972 2f74 6172  _path = "dir/tar
-00006af0: 6765 7422 0a20 2020 2020 2020 2074 6172  get".        tar
-00006b00: 6765 745f 636f 6e74 656e 7473 203d 2022  get_contents = "
-00006b10: 3031 3233 3435 3637 3839 4142 4344 4546  0123456789ABCDEF
-00006b20: 220a 2020 2020 2020 2020 6c69 6e6b 5f6e  ".        link_n
-00006b30: 616d 6520 3d20 2278 220a 2020 2020 2020  ame = "x".      
-00006b40: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-00006b50: 6d2e 6372 6561 7465 5f64 6972 2822 6469  m.create_dir("di
-00006b60: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
-00006b70: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-00006b80: 7465 5f66 696c 6528 2264 6972 2f74 6172  te_file("dir/tar
-00006b90: 6765 7422 2c20 636f 6e74 656e 7473 3d74  get", contents=t
-00006ba0: 6172 6765 745f 636f 6e74 656e 7473 290a  arget_contents).
-00006bb0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00006bc0: 6573 7973 7465 6d2e 6372 6561 7465 5f73  esystem.create_s
-00006bd0: 796d 6c69 6e6b 286c 696e 6b5f 6e61 6d65  ymlink(link_name
-00006be0: 2c20 7461 7267 6574 5f70 6174 6829 0a20  , target_path). 
-00006bf0: 2020 2020 2020 206f 626a 203d 2073 656c         obj = sel
-00006c00: 662e 6669 6c65 7379 7374 656d 2e6c 7265  f.filesystem.lre
-00006c10: 736f 6c76 6528 6c69 6e6b 5f6e 616d 6529  solve(link_name)
-00006c20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00006c30: 7365 7274 4571 7561 6c28 6c69 6e6b 5f6e  sertEqual(link_n
-00006c40: 616d 652c 206f 626a 2e6e 616d 6529 0a20  ame, obj.name). 
-00006c50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00006c60: 7274 4571 7561 6c28 7461 7267 6574 5f70  rtEqual(target_p
-00006c70: 6174 682c 206f 626a 2e63 6f6e 7465 6e74  ath, obj.content
-00006c80: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
-00006c90: 5f6c 7265 736f 6c76 655f 6f62 6a65 6374  _lresolve_object
-00006ca0: 5f77 696e 646f 7773 2873 656c 6629 3a0a  _windows(self):.
-00006cb0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00006cc0: 6573 7973 7465 6d2e 6973 5f77 696e 646f  esystem.is_windo
-00006cd0: 7773 5f66 7320 3d20 5472 7565 0a20 2020  ws_fs = True.   
-00006ce0: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
-00006cf0: 6c72 6573 6f6c 7665 5f6f 626a 6563 7428  lresolve_object(
-00006d00: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00006d10: 6c72 6573 6f6c 7665 5f6f 626a 6563 745f  lresolve_object_
-00006d20: 706f 7369 7828 7365 6c66 293a 0a20 2020  posix(self):.   
-00006d30: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00006d40: 7374 656d 2e69 735f 7769 6e64 6f77 735f  stem.is_windows_
-00006d50: 6673 203d 2046 616c 7365 0a20 2020 2020  fs = False.     
-00006d60: 2020 2073 656c 662e 6368 6563 6b5f 6c72     self.check_lr
-00006d70: 6573 6f6c 7665 5f6f 626a 6563 7428 290a  esolve_object().
-00006d80: 0a20 2020 2064 6566 2063 6865 636b 5f64  .    def check_d
-00006d90: 6972 6563 746f 7279 5f61 6363 6573 735f  irectory_access_
-00006da0: 6f6e 5f66 696c 6528 7365 6c66 2c20 6572  on_file(self, er
-00006db0: 726f 725f 7375 6274 7970 6529 3a0a 2020  ror_subtype):.  
-00006dc0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00006dd0: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
-00006de0: 6528 226e 6f74 5f61 5f64 6972 2229 0a20  e("not_a_dir"). 
-00006df0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00006e00: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
-00006e10: 2865 7272 6f72 5f73 7562 7479 7065 293a  (error_subtype):
-00006e20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00006e30: 662e 6669 6c65 7379 7374 656d 2e72 6573  f.filesystem.res
-00006e40: 6f6c 7665 2822 6e6f 745f 615f 6469 722f  olve("not_a_dir/
-00006e50: 666f 6f22 290a 2020 2020 2020 2020 7769  foo").        wi
-00006e60: 7468 2073 656c 662e 7261 6973 6573 5f6f  th self.raises_o
-00006e70: 735f 6572 726f 7228 6572 726f 725f 7375  s_error(error_su
-00006e80: 6274 7970 6529 3a0a 2020 2020 2020 2020  btype):.        
-00006e90: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00006ea0: 7465 6d2e 6c72 6573 6f6c 7665 2822 6e6f  tem.lresolve("no
-00006eb0: 745f 615f 6469 722f 666f 6f2f 6261 7222  t_a_dir/foo/bar"
-00006ec0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00006ed0: 6469 7265 6374 6f72 795f 6163 6365 7373  directory_access
-00006ee0: 5f6f 6e5f 6669 6c65 5f77 696e 646f 7773  _on_file_windows
-00006ef0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00006f00: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00006f10: 6973 5f77 696e 646f 7773 5f66 7320 3d20  is_windows_fs = 
-00006f20: 5472 7565 0a20 2020 2020 2020 2073 656c  True.        sel
-00006f30: 662e 6368 6563 6b5f 6469 7265 6374 6f72  f.check_director
-00006f40: 795f 6163 6365 7373 5f6f 6e5f 6669 6c65  y_access_on_file
-00006f50: 2865 7272 6e6f 2e45 4e4f 454e 5429 0a0a  (errno.ENOENT)..
-00006f60: 2020 2020 6465 6620 7465 7374 5f64 6972      def test_dir
-00006f70: 6563 746f 7279 5f61 6363 6573 735f 6f6e  ectory_access_on
-00006f80: 5f66 696c 655f 706f 7369 7828 7365 6c66  _file_posix(self
-00006f90: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00006fa0: 6669 6c65 7379 7374 656d 2e69 735f 7769  filesystem.is_wi
-00006fb0: 6e64 6f77 735f 6673 203d 2046 616c 7365  ndows_fs = False
-00006fc0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-00006fd0: 6563 6b5f 6469 7265 6374 6f72 795f 6163  eck_directory_ac
-00006fe0: 6365 7373 5f6f 6e5f 6669 6c65 2865 7272  cess_on_file(err
-00006ff0: 6e6f 2e45 4e4f 5444 4952 290a 0a20 2020  no.ENOTDIR)..   
-00007000: 2064 6566 2074 6573 745f 7069 636b 6c65   def test_pickle
-00007010: 5f66 7328 7365 6c66 293a 0a20 2020 2020  _fs(self):.     
-00007020: 2020 2022 2222 5265 6772 6573 7369 6f6e     """Regression
-00007030: 2074 6573 7420 666f 7220 2334 3435 2222   test for #445""
-00007040: 220a 2020 2020 2020 2020 696d 706f 7274  ".        import
-00007050: 2070 6963 6b6c 650a 0a20 2020 2020 2020   pickle..       
-00007060: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00007070: 2e6f 7065 6e5f 6669 6c65 7320 3d20 5b5d  .open_files = []
-00007080: 0a20 2020 2020 2020 2070 203d 2070 6963  .        p = pic
-00007090: 6b6c 652e 6475 6d70 7328 7365 6c66 2e66  kle.dumps(self.f
-000070a0: 696c 6573 7973 7465 6d29 0a20 2020 2020  ilesystem).     
-000070b0: 2020 2066 7320 3d20 7069 636b 6c65 2e6c     fs = pickle.l
-000070c0: 6f61 6473 2870 290a 2020 2020 2020 2020  oads(p).        
-000070d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000070e0: 2873 7472 2866 732e 726f 6f74 292c 2073  (str(fs.root), s
-000070f0: 7472 2873 656c 662e 6669 6c65 7379 7374  tr(self.filesyst
-00007100: 656d 2e72 6f6f 7429 290a 2020 2020 2020  em.root)).      
-00007110: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007120: 616c 2866 732e 6d6f 756e 745f 706f 696e  al(fs.mount_poin
-00007130: 7473 2c20 7365 6c66 2e66 696c 6573 7973  ts, self.filesys
-00007140: 7465 6d2e 6d6f 756e 745f 706f 696e 7473  tem.mount_points
-00007150: 290a 0a0a 636c 6173 7320 4361 7365 496e  )...class CaseIn
-00007160: 7365 6e73 6974 6976 6546 616b 6546 696c  sensitiveFakeFil
-00007170: 6573 7973 7465 6d54 6573 7428 5465 7374  esystemTest(Test
-00007180: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
-00007190: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
-000071a0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-000071b0: 7465 6d20 3d20 6661 6b65 5f66 696c 6573  tem = fake_files
-000071c0: 7973 7465 6d2e 4661 6b65 4669 6c65 7379  ystem.FakeFilesy
-000071d0: 7374 656d 2870 6174 685f 7365 7061 7261  stem(path_separa
-000071e0: 746f 723d 222f 2229 0a20 2020 2020 2020  tor="/").       
-000071f0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00007200: 2e69 735f 6361 7365 5f73 656e 7369 7469  .is_case_sensiti
-00007210: 7665 203d 2046 616c 7365 0a20 2020 2020  ve = False.     
-00007220: 2020 2073 656c 662e 6f73 203d 2066 616b     self.os = fak
-00007230: 655f 6f73 2e46 616b 654f 734d 6f64 756c  e_os.FakeOsModul
-00007240: 6528 7365 6c66 2e66 696c 6573 7973 7465  e(self.filesyste
-00007250: 6d29 0a20 2020 2020 2020 2073 656c 662e  m).        self.
-00007260: 7061 7468 203d 2073 656c 662e 6f73 2e70  path = self.os.p
-00007270: 6174 680a 0a20 2020 2064 6566 2074 6573  ath..    def tes
-00007280: 745f 6765 745f 6f62 6a65 6374 2873 656c  t_get_object(sel
-00007290: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-000072a0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-000072b0: 7465 5f64 6972 2822 2f66 6f6f 2f62 6172  te_dir("/foo/bar
-000072c0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-000072d0: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
-000072e0: 655f 6669 6c65 2822 2f66 6f6f 2f62 6172  e_file("/foo/bar
-000072f0: 2f62 617a 2229 0a20 2020 2020 2020 2073  /baz").        s
-00007300: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-00007310: 656c 662e 6669 6c65 7379 7374 656d 2e67  elf.filesystem.g
-00007320: 6574 5f6f 626a 6563 7428 222f 466f 6f2f  et_object("/Foo/
-00007330: 4261 722f 4261 7a22 2929 0a0a 2020 2020  Bar/Baz"))..    
-00007340: 6465 6620 7465 7374 5f72 656d 6f76 655f  def test_remove_
-00007350: 6f62 6a65 6374 2873 656c 6629 3a0a 2020  object(self):.  
-00007360: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00007370: 7973 7465 6d2e 6372 6561 7465 5f64 6972  ystem.create_dir
-00007380: 2822 2f66 6f6f 2f62 6172 2229 0a20 2020  ("/foo/bar").   
-00007390: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-000073a0: 7374 656d 2e63 7265 6174 655f 6669 6c65  stem.create_file
-000073b0: 2822 2f66 6f6f 2f62 6172 2f62 617a 2229  ("/foo/bar/baz")
-000073c0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-000073d0: 6c65 7379 7374 656d 2e72 656d 6f76 655f  lesystem.remove_
-000073e0: 6f62 6a65 6374 2822 2f46 6f6f 2f42 6172  object("/Foo/Bar
-000073f0: 2f42 617a 2229 0a20 2020 2020 2020 2073  /Baz").        s
-00007400: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-00007410: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00007420: 6578 6973 7473 2822 2f66 6f6f 2f62 6172  exists("/foo/bar
-00007430: 2f62 617a 2229 290a 0a20 2020 2064 6566  /baz"))..    def
-00007440: 2074 6573 745f 6578 6973 7473 2873 656c   test_exists(sel
-00007450: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00007460: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-00007470: 7465 5f64 6972 2822 2f46 6f6f 2f42 6172  te_dir("/Foo/Bar
-00007480: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00007490: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
-000074a0: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-000074b0: 7328 222f 466f 6f2f 4261 7222 2929 0a20  s("/Foo/Bar")). 
-000074c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000074d0: 7274 5472 7565 2873 656c 662e 6669 6c65  rtTrue(self.file
-000074e0: 7379 7374 656d 2e65 7869 7374 7328 222f  system.exists("/
-000074f0: 666f 6f2f 6261 7222 2929 0a0a 2020 2020  foo/bar"))..    
-00007500: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00007510: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
-00007520: 222f 666f 6f2f 4261 722f 6261 7a22 290a  "/foo/Bar/baz").
-00007530: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007540: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
-00007550: 6573 7973 7465 6d2e 6578 6973 7473 2822  esystem.exists("
-00007560: 2f46 6f6f 2f62 6172 2f42 415a 2229 290a  /Foo/bar/BAZ")).
-00007570: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007580: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
-00007590: 6573 7973 7465 6d2e 6578 6973 7473 2822  esystem.exists("
-000075a0: 2f66 6f6f 2f62 6172 2f62 617a 2229 290a  /foo/bar/baz")).
-000075b0: 0a20 2020 2064 6566 2074 6573 745f 6372  .    def test_cr
-000075c0: 6561 7465 5f64 6972 6563 746f 7279 5f77  eate_directory_w
-000075d0: 6974 685f 6469 6666 6572 656e 745f 6361  ith_different_ca
-000075e0: 7365 5f72 6f6f 7428 7365 6c66 293a 0a20  se_root(self):. 
-000075f0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-00007600: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
-00007610: 7228 222f 466f 6f2f 4261 7222 290a 2020  r("/Foo/Bar").  
-00007620: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00007630: 7973 7465 6d2e 6372 6561 7465 5f64 6972  ystem.create_dir
-00007640: 2822 2f66 6f6f 2f62 6172 2f62 617a 2229  ("/foo/bar/baz")
-00007650: 0a20 2020 2020 2020 2064 6972 3120 3d20  .        dir1 = 
-00007660: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00007670: 6765 745f 6f62 6a65 6374 2822 2f46 6f6f  get_object("/Foo
-00007680: 2f42 6172 2229 0a20 2020 2020 2020 2064  /Bar").        d
-00007690: 6972 3220 3d20 7365 6c66 2e66 696c 6573  ir2 = self.files
-000076a0: 7973 7465 6d2e 6765 745f 6f62 6a65 6374  ystem.get_object
-000076b0: 2822 2f66 6f6f 2f62 6172 2229 0a20 2020  ("/foo/bar").   
-000076c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000076d0: 4571 7561 6c28 6469 7231 2c20 6469 7232  Equal(dir1, dir2
-000076e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000076f0: 6372 6561 7465 5f66 696c 655f 7769 7468  create_file_with
-00007700: 5f64 6966 6665 7265 6e74 5f63 6173 655f  _different_case_
-00007710: 6469 7228 7365 6c66 293a 0a20 2020 2020  dir(self):.     
-00007720: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-00007730: 656d 2e63 7265 6174 655f 6469 7228 222f  em.create_dir("/
-00007740: 466f 6f2f 4261 7222 290a 2020 2020 2020  Foo/Bar").      
-00007750: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-00007760: 6d2e 6372 6561 7465 5f66 696c 6528 222f  m.create_file("/
-00007770: 666f 6f2f 6261 722f 6261 7a22 290a 2020  foo/bar/baz").  
-00007780: 2020 2020 2020 6469 7231 203d 2073 656c        dir1 = sel
-00007790: 662e 6669 6c65 7379 7374 656d 2e67 6574  f.filesystem.get
-000077a0: 5f6f 626a 6563 7428 222f 466f 6f2f 4261  _object("/Foo/Ba
-000077b0: 7222 290a 2020 2020 2020 2020 6469 7232  r").        dir2
-000077c0: 203d 2073 656c 662e 6669 6c65 7379 7374   = self.filesyst
-000077d0: 656d 2e67 6574 5f6f 626a 6563 7428 222f  em.get_object("/
-000077e0: 666f 6f2f 6261 7222 290a 2020 2020 2020  foo/bar").      
-000077f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007800: 616c 2864 6972 312c 2064 6972 3229 0a0a  al(dir1, dir2)..
-00007810: 2020 2020 6465 6620 7465 7374 5f72 6573      def test_res
-00007820: 6f6c 7665 5f70 6174 6828 7365 6c66 293a  olve_path(self):
-00007830: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00007840: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-00007850: 6469 7228 222f 666f 6f2f 6261 7a22 290a  dir("/foo/baz").
-00007860: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00007870: 6573 7973 7465 6d2e 6372 6561 7465 5f73  esystem.create_s
-00007880: 796d 6c69 6e6b 2822 2f46 6f6f 2f42 6172  ymlink("/Foo/Bar
-00007890: 222c 2022 2e2f 6261 7a2f 6269 7022 290a  ", "./baz/bip").
-000078a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000078b0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-000078c0: 2020 2020 2020 6622 7b73 656c 662e 6669        f"{self.fi
-000078d0: 6c65 7379 7374 656d 2e72 6f6f 745f 6469  lesystem.root_di
-000078e0: 725f 6e61 6d65 7d66 6f6f 2f62 617a 2f62  r_name}foo/baz/b
-000078f0: 6970 222c 0a20 2020 2020 2020 2020 2020  ip",.           
-00007900: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00007910: 2e72 6573 6f6c 7665 5f70 6174 6828 222f  .resolve_path("/
-00007920: 666f 6f2f 6261 7222 292c 0a20 2020 2020  foo/bar"),.     
-00007930: 2020 2029 0a0a 2020 2020 6465 6620 7465     )..    def te
-00007940: 7374 5f69 7364 6972 5f69 7366 696c 6528  st_isdir_isfile(
-00007950: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00007960: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-00007970: 7265 6174 655f 6669 6c65 2822 666f 6f2f  reate_file("foo/
-00007980: 6261 7222 290a 2020 2020 2020 2020 7365  bar").        se
-00007990: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-000079a0: 6c66 2e70 6174 682e 6973 6469 7228 2246  lf.path.isdir("F
-000079b0: 6f6f 2229 290a 2020 2020 2020 2020 7365  oo")).        se
-000079c0: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
-000079d0: 656c 662e 7061 7468 2e69 7366 696c 6528  elf.path.isfile(
-000079e0: 2246 6f6f 2229 290a 2020 2020 2020 2020  "Foo")).        
-000079f0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00007a00: 7365 6c66 2e70 6174 682e 6973 6669 6c65  self.path.isfile
-00007a10: 2822 466f 6f2f 4261 7222 2929 0a20 2020  ("Foo/Bar")).   
-00007a20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007a30: 4661 6c73 6528 7365 6c66 2e70 6174 682e  False(self.path.
-00007a40: 6973 6469 7228 2246 6f6f 2f42 6172 2229  isdir("Foo/Bar")
-00007a50: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00007a60: 6765 7473 697a 6528 7365 6c66 293a 0a20  getsize(self):. 
-00007a70: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-00007a80: 203d 2022 666f 6f2f 6261 722f 6261 7a22   = "foo/bar/baz"
-00007a90: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00007aa0: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-00007ab0: 6669 6c65 2866 696c 655f 7061 7468 2c20  file(file_path, 
-00007ac0: 636f 6e74 656e 7473 3d22 3132 3334 3536  contents="123456
-00007ad0: 3722 290a 2020 2020 2020 2020 7365 6c66  7").        self
-00007ae0: 2e61 7373 6572 7445 7175 616c 2837 2c20  .assertEqual(7, 
-00007af0: 7365 6c66 2e70 6174 682e 6765 7473 697a  self.path.getsiz
-00007b00: 6528 2246 4f4f 2f42 4152 2f42 415a 2229  e("FOO/BAR/BAZ")
-00007b10: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00007b20: 6765 7473 697a 655f 7769 7468 5f6c 6f6f  getsize_with_loo
-00007b30: 7069 6e67 5f73 796d 6c69 6e6b 2873 656c  ping_symlink(sel
-00007b40: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00007b50: 2e66 696c 6573 7973 7465 6d2e 6973 5f77  .filesystem.is_w
-00007b60: 696e 646f 7773 5f66 7320 3d20 4661 6c73  indows_fs = Fals
-00007b70: 650a 2020 2020 2020 2020 6469 725f 7061  e.        dir_pa
-00007b80: 7468 203d 2022 2f66 6f6f 2f62 6172 220a  th = "/foo/bar".
-00007b90: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00007ba0: 6573 7973 7465 6d2e 6372 6561 7465 5f64  esystem.create_d
-00007bb0: 6972 2864 6972 5f70 6174 6829 0a20 2020  ir(dir_path).   
-00007bc0: 2020 2020 206c 696e 6b5f 7061 7468 203d       link_path =
-00007bd0: 2064 6972 5f70 6174 6820 2b20 222f 6c69   dir_path + "/li
-00007be0: 6e6b 220a 2020 2020 2020 2020 6c69 6e6b  nk".        link
-00007bf0: 5f74 6172 6765 7420 3d20 6c69 6e6b 5f70  _target = link_p
-00007c00: 6174 6820 2b20 222f 6c69 6e6b 220a 2020  ath + "/link".  
-00007c10: 2020 2020 2020 7365 6c66 2e6f 732e 7379        self.os.sy
-00007c20: 6d6c 696e 6b28 6c69 6e6b 5f74 6172 6765  mlink(link_targe
-00007c30: 742c 206c 696e 6b5f 7061 7468 290a 2020  t, link_path).  
-00007c40: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00007c50: 7261 6973 6573 5f6f 735f 6572 726f 7228  raises_os_error(
-00007c60: 6572 726e 6f2e 454c 4f4f 5029 3a0a 2020  errno.ELOOP):.  
-00007c70: 2020 2020 2020 2020 2020 7365 6c66 2e6f            self.o
-00007c80: 732e 7061 7468 2e67 6574 7369 7a65 286c  s.path.getsize(l
-00007c90: 696e 6b5f 7061 7468 290a 0a20 2020 2064  ink_path)..    d
-00007ca0: 6566 2074 6573 745f 6765 745f 6d74 696d  ef test_get_mtim
-00007cb0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00007cc0: 2074 6573 745f 6669 6c65 203d 2073 656c   test_file = sel
-00007cd0: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
-00007ce0: 6174 655f 6669 6c65 2822 666f 6f2f 6261  ate_file("foo/ba
-00007cf0: 7231 2e74 7874 2229 0a20 2020 2020 2020  r1.txt").       
-00007d00: 2074 6573 745f 6669 6c65 2e73 745f 6d74   test_file.st_mt
-00007d10: 696d 6520 3d20 3234 0a20 2020 2020 2020  ime = 24.       
-00007d20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007d30: 6c28 3234 2c20 7365 6c66 2e70 6174 682e  l(24, self.path.
-00007d40: 6765 746d 7469 6d65 2822 466f 6f2f 4261  getmtime("Foo/Ba
-00007d50: 7231 2e54 5854 2229 290a 0a20 2020 2064  r1.TXT"))..    d
-00007d60: 6566 2074 6573 745f 6765 745f 6f62 6a65  ef test_get_obje
-00007d70: 6374 5f77 6974 685f 6669 6c65 5f73 697a  ct_with_file_siz
-00007d80: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00007d90: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00007da0: 2e63 7265 6174 655f 6669 6c65 2822 2f46  .create_file("/F
-00007db0: 6f6f 2f42 6172 222c 2073 745f 7369 7a65  oo/Bar", st_size
-00007dc0: 3d31 3029 0a20 2020 2020 2020 2073 656c  =10).        sel
-00007dd0: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-00007de0: 662e 6669 6c65 7379 7374 656d 2e67 6574  f.filesystem.get
-00007df0: 5f6f 626a 6563 7428 222f 666f 6f2f 6261  _object("/foo/ba
-00007e00: 7222 2929 0a0a 0a63 6c61 7373 2043 6173  r"))...class Cas
-00007e10: 6553 656e 7369 7469 7665 4661 6b65 4669  eSensitiveFakeFi
-00007e20: 6c65 7379 7374 656d 5465 7374 2854 6573  lesystemTest(Tes
-00007e30: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
-00007e40: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
-00007e50: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00007e60: 7374 656d 203d 2066 616b 655f 6669 6c65  stem = fake_file
-00007e70: 7379 7374 656d 2e46 616b 6546 696c 6573  system.FakeFiles
-00007e80: 7973 7465 6d28 7061 7468 5f73 6570 6172  ystem(path_separ
-00007e90: 6174 6f72 3d22 2f22 290a 2020 2020 2020  ator="/").      
-00007ea0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-00007eb0: 6d2e 6973 5f63 6173 655f 7365 6e73 6974  m.is_case_sensit
-00007ec0: 6976 6520 3d20 5472 7565 0a20 2020 2020  ive = True.     
-00007ed0: 2020 2073 656c 662e 6f73 203d 2066 616b     self.os = fak
-00007ee0: 655f 6f73 2e46 616b 654f 734d 6f64 756c  e_os.FakeOsModul
-00007ef0: 6528 7365 6c66 2e66 696c 6573 7973 7465  e(self.filesyste
-00007f00: 6d29 0a20 2020 2020 2020 2073 656c 662e  m).        self.
-00007f10: 7061 7468 203d 2073 656c 662e 6f73 2e70  path = self.os.p
-00007f20: 6174 680a 0a20 2020 2064 6566 2074 6573  ath..    def tes
-00007f30: 745f 6765 745f 6f62 6a65 6374 2873 656c  t_get_object(sel
-00007f40: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00007f50: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-00007f60: 7465 5f64 6972 2822 2f66 6f6f 2f62 6172  te_dir("/foo/bar
-00007f70: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00007f80: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
-00007f90: 655f 6669 6c65 2822 2f66 6f6f 2f62 6172  e_file("/foo/bar
-00007fa0: 2f62 617a 2229 0a20 2020 2020 2020 2077  /baz").        w
-00007fb0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00007fc0: 6169 7365 7328 4f53 4572 726f 7229 3a0a  aises(OSError):.
-00007fd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00007fe0: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
-00007ff0: 6f62 6a65 6374 2822 2f46 6f6f 2f42 6172  object("/Foo/Bar
-00008000: 2f42 617a 2229 0a0a 2020 2020 6465 6620  /Baz")..    def 
-00008010: 7465 7374 5f72 656d 6f76 655f 6f62 6a65  test_remove_obje
-00008020: 6374 2873 656c 6629 3a0a 2020 2020 2020  ct(self):.      
-00008030: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-00008040: 6d2e 6372 6561 7465 5f64 6972 2822 2f66  m.create_dir("/f
-00008050: 6f6f 2f62 6172 2229 0a20 2020 2020 2020  oo/bar").       
-00008060: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00008070: 2e63 7265 6174 655f 6669 6c65 2822 2f66  .create_file("/f
-00008080: 6f6f 2f62 6172 2f62 617a 2229 0a20 2020  oo/bar/baz").   
-00008090: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000080a0: 7373 6572 7452 6169 7365 7328 4f53 4572  ssertRaises(OSEr
-000080b0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000080c0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-000080d0: 6d2e 7265 6d6f 7665 5f6f 626a 6563 7428  m.remove_object(
-000080e0: 222f 466f 6f2f 4261 722f 4261 7a22 290a  "/Foo/Bar/Baz").
-000080f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008100: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
-00008110: 6573 7973 7465 6d2e 6578 6973 7473 2822  esystem.exists("
-00008120: 2f66 6f6f 2f62 6172 2f62 617a 2229 290a  /foo/bar/baz")).
-00008130: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
-00008140: 6973 7473 2873 656c 6629 3a0a 2020 2020  ists(self):.    
-00008150: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00008160: 7465 6d2e 6372 6561 7465 5f64 6972 2822  tem.create_dir("
-00008170: 2f46 6f6f 2f42 6172 2229 0a20 2020 2020  /Foo/Bar").     
-00008180: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00008190: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
-000081a0: 656d 2e65 7869 7374 7328 222f 466f 6f2f  em.exists("/Foo/
-000081b0: 4261 7222 2929 0a20 2020 2020 2020 2073  Bar")).        s
-000081c0: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-000081d0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-000081e0: 6578 6973 7473 2822 2f66 6f6f 2f62 6172  exists("/foo/bar
-000081f0: 2229 290a 0a20 2020 2020 2020 2073 656c  "))..        sel
-00008200: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
-00008210: 6174 655f 6669 6c65 2822 2f66 6f6f 2f42  ate_file("/foo/B
-00008220: 6172 2f62 617a 2229 0a20 2020 2020 2020  ar/baz").       
-00008230: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
-00008240: 6528 7365 6c66 2e66 696c 6573 7973 7465  e(self.filesyste
-00008250: 6d2e 6578 6973 7473 2822 2f46 6f6f 2f62  m.exists("/Foo/b
-00008260: 6172 2f42 415a 2229 290a 2020 2020 2020  ar/BAZ")).      
-00008270: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-00008280: 7365 2873 656c 662e 6669 6c65 7379 7374  se(self.filesyst
-00008290: 656d 2e65 7869 7374 7328 222f 666f 6f2f  em.exists("/foo/
-000082a0: 6261 722f 6261 7a22 2929 0a0a 2020 2020  bar/baz"))..    
-000082b0: 6465 6620 7465 7374 5f63 7265 6174 655f  def test_create_
-000082c0: 6469 7265 6374 6f72 795f 7769 7468 5f64  directory_with_d
-000082d0: 6966 6665 7265 6e74 5f63 6173 655f 726f  ifferent_case_ro
-000082e0: 6f74 2873 656c 6629 3a0a 2020 2020 2020  ot(self):.      
-000082f0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-00008300: 6d2e 6372 6561 7465 5f64 6972 2822 2f46  m.create_dir("/F
-00008310: 6f6f 2f42 6172 2229 0a20 2020 2020 2020  oo/Bar").       
-00008320: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00008330: 2e63 7265 6174 655f 6469 7228 222f 666f  .create_dir("/fo
-00008340: 6f2f 6261 722f 6261 7a22 290a 2020 2020  o/bar/baz").    
-00008350: 2020 2020 6469 7231 203d 2073 656c 662e      dir1 = self.
-00008360: 6669 6c65 7379 7374 656d 2e67 6574 5f6f  filesystem.get_o
-00008370: 626a 6563 7428 222f 466f 6f2f 4261 7222  bject("/Foo/Bar"
-00008380: 290a 2020 2020 2020 2020 6469 7232 203d  ).        dir2 =
-00008390: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-000083a0: 2e67 6574 5f6f 626a 6563 7428 222f 666f  .get_object("/fo
-000083b0: 6f2f 6261 7222 290a 2020 2020 2020 2020  o/bar").        
-000083c0: 7365 6c66 2e61 7373 6572 744e 6f74 4571  self.assertNotEq
-000083d0: 7561 6c28 6469 7231 2c20 6469 7232 290a  ual(dir1, dir2).
-000083e0: 0a20 2020 2064 6566 2074 6573 745f 6372  .    def test_cr
-000083f0: 6561 7465 5f66 696c 655f 7769 7468 5f64  eate_file_with_d
-00008400: 6966 6665 7265 6e74 5f63 6173 655f 6469  ifferent_case_di
-00008410: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00008420: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00008430: 2e63 7265 6174 655f 6469 7228 222f 466f  .create_dir("/Fo
-00008440: 6f2f 4261 7222 290a 2020 2020 2020 2020  o/Bar").        
-00008450: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00008460: 6372 6561 7465 5f66 696c 6528 222f 666f  create_file("/fo
-00008470: 6f2f 6261 722f 6261 7a22 290a 2020 2020  o/bar/baz").    
-00008480: 2020 2020 6469 7231 203d 2073 656c 662e      dir1 = self.
-00008490: 6669 6c65 7379 7374 656d 2e67 6574 5f6f  filesystem.get_o
-000084a0: 626a 6563 7428 222f 466f 6f2f 4261 7222  bject("/Foo/Bar"
-000084b0: 290a 2020 2020 2020 2020 6469 7232 203d  ).        dir2 =
-000084c0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-000084d0: 2e67 6574 5f6f 626a 6563 7428 222f 666f  .get_object("/fo
-000084e0: 6f2f 6261 7222 290a 2020 2020 2020 2020  o/bar").        
-000084f0: 7365 6c66 2e61 7373 6572 744e 6f74 4571  self.assertNotEq
-00008500: 7561 6c28 6469 7231 2c20 6469 7232 290a  ual(dir1, dir2).
-00008510: 0a20 2020 2064 6566 2074 6573 745f 6973  .    def test_is
-00008520: 6469 725f 6973 6669 6c65 2873 656c 6629  dir_isfile(self)
-00008530: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-00008540: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
-00008550: 5f66 696c 6528 2266 6f6f 2f62 6172 2229  _file("foo/bar")
-00008560: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008570: 7365 7274 4661 6c73 6528 7365 6c66 2e70  sertFalse(self.p
-00008580: 6174 682e 6973 6469 7228 2246 6f6f 2229  ath.isdir("Foo")
-00008590: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000085a0: 7373 6572 7446 616c 7365 2873 656c 662e  ssertFalse(self.
-000085b0: 7061 7468 2e69 7366 696c 6528 2246 6f6f  path.isfile("Foo
-000085c0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-000085d0: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
-000085e0: 662e 7061 7468 2e69 7366 696c 6528 2246  f.path.isfile("F
-000085f0: 6f6f 2f42 6172 2229 290a 2020 2020 2020  oo/Bar")).      
-00008600: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-00008610: 7365 2873 656c 662e 7061 7468 2e69 7364  se(self.path.isd
-00008620: 6972 2822 466f 6f2f 4261 7222 2929 0a0a  ir("Foo/Bar"))..
-00008630: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-00008640: 7369 7a65 2873 656c 6629 3a0a 2020 2020  size(self):.    
-00008650: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
-00008660: 2266 6f6f 2f62 6172 2f62 617a 220a 2020  "foo/bar/baz".  
-00008670: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00008680: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
-00008690: 6528 6669 6c65 5f70 6174 682c 2063 6f6e  e(file_path, con
-000086a0: 7465 6e74 733d 2231 3233 3435 3637 2229  tents="1234567")
-000086b0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-000086c0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-000086d0: 6f73 2e65 7272 6f72 293a 0a20 2020 2020  os.error):.     
-000086e0: 2020 2020 2020 2073 656c 662e 7061 7468         self.path
-000086f0: 2e67 6574 7369 7a65 2822 464f 4f2f 4241  .getsize("FOO/BA
-00008700: 522f 4241 5a22 290a 0a20 2020 2064 6566  R/BAZ")..    def
-00008710: 2074 6573 745f 6765 745f 6d74 696d 6528   test_get_mtime(
-00008720: 7365 6c66 293a 0a20 2020 2020 2020 2074  self):.        t
-00008730: 6573 745f 6669 6c65 203d 2073 656c 662e  est_file = self.
-00008740: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
-00008750: 655f 6669 6c65 2822 666f 6f2f 6261 7231  e_file("foo/bar1
-00008760: 2e74 7874 2229 0a20 2020 2020 2020 2074  .txt").        t
-00008770: 6573 745f 6669 6c65 2e73 745f 6d74 696d  est_file.st_mtim
-00008780: 6520 3d20 3234 0a20 2020 2020 2020 2077  e = 24.        w
-00008790: 6974 6820 7365 6c66 2e72 6169 7365 735f  ith self.raises_
-000087a0: 6f73 5f65 7272 6f72 2865 7272 6e6f 2e45  os_error(errno.E
-000087b0: 4e4f 454e 5429 3a0a 2020 2020 2020 2020  NOENT):.        
-000087c0: 2020 2020 7365 6c66 2e70 6174 682e 6765      self.path.ge
-000087d0: 746d 7469 6d65 2822 466f 6f2f 4261 7231  tmtime("Foo/Bar1
-000087e0: 2e54 5854 2229 0a0a 0a63 6c61 7373 204f  .TXT")...class O
-000087f0: 7350 6174 6849 6e6a 6563 7469 6f6e 5265  sPathInjectionRe
-00008800: 6772 6573 7369 6f6e 5465 7374 2854 6573  gressionTest(Tes
-00008810: 7443 6173 6529 3a0a 2020 2020 2222 2254  tCase):.    """T
-00008820: 6573 7420 6661 6b69 6e67 206f 732e 7061  est faking os.pa
-00008830: 7468 2062 6566 6f72 6520 6361 6c6c 696e  th before callin
-00008840: 6720 6f73 2e77 616c 6b2e 0a0a 2020 2020  g os.walk...    
-00008850: 466f 756e 6420 7768 656e 2069 6e76 6573  Found when inves
-00008860: 7469 6761 7469 6e67 2061 2070 726f 626c  tigating a probl
-00008870: 656d 2077 6974 680a 2020 2020 6777 732f  em with.    gws/
-00008880: 746f 6f6c 732f 6c61 6272 6174 2f72 6174  tools/labrat/rat
-00008890: 5f75 7469 6c73 5f75 6e69 7474 6573 742c  _utils_unittest,
-000088a0: 2077 6869 6368 2077 6173 2066 616b 696e   which was fakin
-000088b0: 6720 6f75 7420 6f73 2e70 6174 680a 2020  g out os.path.  
-000088c0: 2020 6265 666f 7265 2063 616c 6c69 6e67    before calling
-000088d0: 206f 732e 7761 6c6b 2e0a 2020 2020 2222   os.walk..    ""
-000088e0: 220a 0a20 2020 2064 6566 2073 6574 5570  "..    def setUp
-000088f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00008900: 7365 6c66 2e66 696c 6573 7973 7465 6d20  self.filesystem 
-00008910: 3d20 6661 6b65 5f66 696c 6573 7973 7465  = fake_filesyste
-00008920: 6d2e 4661 6b65 4669 6c65 7379 7374 656d  m.FakeFilesystem
-00008930: 2870 6174 685f 7365 7061 7261 746f 723d  (path_separator=
-00008940: 222f 2229 0a20 2020 2020 2020 2073 656c  "/").        sel
-00008950: 662e 6f73 5f70 6174 6820 3d20 6f73 2e70  f.os_path = os.p
-00008960: 6174 680a 2020 2020 2020 2020 2320 5468  ath.        # Th
-00008970: 6520 6275 6720 7761 7320 7468 6174 2077  e bug was that w
-00008980: 6865 6e20 6f73 2e70 6174 6820 6765 7473  hen os.path gets
-00008990: 2066 616b 6564 2c20 7468 6520 4661 6b65   faked, the Fake
-000089a0: 5061 7468 4d6f 6475 6c65 2064 6f65 736e  PathModule doesn
-000089b0: 2774 0a20 2020 2020 2020 2023 2067 6574  't.        # get
-000089c0: 2063 616c 6c65 6420 696e 2073 656c 662e   called in self.
-000089d0: 6f73 2e77 616c 6b28 292e 2046 616b 6550  os.walk(). FakeP
-000089e0: 6174 684d 6f64 756c 6520 6e6f 7720 696e  athModule now in
-000089f0: 7369 7374 7320 7468 6174 2069 7420 6973  sists that it is
-00008a00: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
-00008a10: 6564 2061 7320 7061 7274 206f 6620 4661  ed as part of Fa
-00008a20: 6b65 4f73 4d6f 6475 6c65 2e0a 2020 2020  keOsModule..    
-00008a30: 2020 2020 7365 6c66 2e6f 7320 3d20 6661      self.os = fa
-00008a40: 6b65 5f6f 732e 4661 6b65 4f73 4d6f 6475  ke_os.FakeOsModu
-00008a50: 6c65 2873 656c 662e 6669 6c65 7379 7374  le(self.filesyst
-00008a60: 656d 290a 0a20 2020 2064 6566 2074 6561  em)..    def tea
-00008a70: 7244 6f77 6e28 7365 6c66 293a 0a20 2020  rDown(self):.   
-00008a80: 2020 2020 206f 732e 7061 7468 203d 2073       os.path = s
-00008a90: 656c 662e 6f73 5f70 6174 680a 0a20 2020  elf.os_path..   
-00008aa0: 2064 6566 2074 6573 745f 6372 6561 7465   def test_create
-00008ab0: 5f74 6f70 5f6c 6576 656c 5f64 6972 6563  _top_level_direc
-00008ac0: 746f 7279 2873 656c 6629 3a0a 2020 2020  tory(self):.    
-00008ad0: 2020 2020 746f 705f 6c65 7665 6c5f 6469      top_level_di
-00008ae0: 7220 3d20 222f 7822 0a20 2020 2020 2020  r = "/x".       
-00008af0: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
-00008b00: 6528 7365 6c66 2e66 696c 6573 7973 7465  e(self.filesyste
-00008b10: 6d2e 6578 6973 7473 2874 6f70 5f6c 6576  m.exists(top_lev
-00008b20: 656c 5f64 6972 2929 0a20 2020 2020 2020  el_dir)).       
-00008b30: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00008b40: 2e63 7265 6174 655f 6469 7228 746f 705f  .create_dir(top_
-00008b50: 6c65 7665 6c5f 6469 7229 0a20 2020 2020  level_dir).     
-00008b60: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00008b70: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
-00008b80: 656d 2e65 7869 7374 7328 222f 2229 290a  em.exists("/")).
-00008b90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008ba0: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
-00008bb0: 6573 7973 7465 6d2e 6578 6973 7473 2874  esystem.exists(t
-00008bc0: 6f70 5f6c 6576 656c 5f64 6972 2929 0a20  op_level_dir)). 
-00008bd0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-00008be0: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
-00008bf0: 7228 2225 732f 706f 2220 2520 746f 705f  r("%s/po" % top_
-00008c00: 6c65 7665 6c5f 6469 7229 0a20 2020 2020  level_dir).     
-00008c10: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-00008c20: 656d 2e63 7265 6174 655f 6669 6c65 2822  em.create_file("
-00008c30: 2573 2f70 6f2f 636f 6e74 726f 6c22 2025  %s/po/control" %
-00008c40: 2074 6f70 5f6c 6576 656c 5f64 6972 290a   top_level_dir).
-00008c50: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00008c60: 6573 7973 7465 6d2e 6372 6561 7465 5f66  esystem.create_f
-00008c70: 696c 6528 2225 732f 706f 2f65 7870 6572  ile("%s/po/exper
-00008c80: 696d 656e 7422 2025 2074 6f70 5f6c 6576  iment" % top_lev
-00008c90: 656c 5f64 6972 290a 2020 2020 2020 2020  el_dir).        
-00008ca0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00008cb0: 6372 6561 7465 5f64 6972 2822 2573 2f67  create_dir("%s/g
-00008cc0: 7622 2025 2074 6f70 5f6c 6576 656c 5f64  v" % top_level_d
-00008cd0: 6972 290a 2020 2020 2020 2020 7365 6c66  ir).        self
-00008ce0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-00008cf0: 7465 5f66 696c 6528 2225 732f 6776 2f63  te_file("%s/gv/c
-00008d00: 6f6e 7472 6f6c 2220 2520 746f 705f 6c65  ontrol" % top_le
-00008d10: 7665 6c5f 6469 7229 0a0a 2020 2020 2020  vel_dir)..      
-00008d20: 2020 6578 7065 6374 6564 203d 205b 0a20    expected = [. 
-00008d30: 2020 2020 2020 2020 2020 2028 222f 222c             ("/",
-00008d40: 205b 2278 225d 2c20 5b5d 292c 0a20 2020   ["x"], []),.   
-00008d50: 2020 2020 2020 2020 2028 222f 7822 2c20           ("/x", 
-00008d60: 5b22 6776 222c 2022 706f 225d 2c20 5b5d  ["gv", "po"], []
-00008d70: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00008d80: 222f 782f 6776 222c 205b 5d2c 205b 2263  "/x/gv", [], ["c
-00008d90: 6f6e 7472 6f6c 225d 292c 0a20 2020 2020  ontrol"]),.     
-00008da0: 2020 2020 2020 2028 222f 782f 706f 222c         ("/x/po",
-00008db0: 205b 5d2c 205b 2263 6f6e 7472 6f6c 222c   [], ["control",
-00008dc0: 2022 6578 7065 7269 6d65 6e74 225d 292c   "experiment"]),
-00008dd0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-00008de0: 2020 2023 2061 7320 7468 6520 7265 7375     # as the resu
-00008df0: 6c74 2069 7320 756e 736f 7274 6564 2c20  lt is unsorted, 
-00008e00: 7765 2068 6176 6520 746f 2063 6865 636b  we have to check
-00008e10: 2061 6761 696e 7374 2073 6f72 7465 6420   against sorted 
-00008e20: 7265 7375 6c74 730a 2020 2020 2020 2020  results.        
-00008e30: 7265 7375 6c74 203d 2073 6f72 7465 6428  result = sorted(
-00008e40: 5b73 7465 7020 666f 7220 7374 6570 2069  [step for step i
-00008e50: 6e20 7365 6c66 2e6f 732e 7761 6c6b 2822  n self.os.walk("
-00008e60: 2f22 295d 2c20 6b65 793d 6c61 6d62 6461  /")], key=lambda
-00008e70: 2076 3a20 765b 305d 290a 2020 2020 2020   v: v[0]).      
-00008e80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00008e90: 616c 286c 656e 2865 7870 6563 7465 6429  al(len(expected)
-00008ea0: 2c20 6c65 6e28 7265 7375 6c74 2929 0a20  , len(result)). 
-00008eb0: 2020 2020 2020 2066 6f72 2065 6e74 7279         for entry
-00008ec0: 2c20 6578 7065 6374 6564 5f65 6e74 7279  , expected_entry
-00008ed0: 2069 6e20 7a69 7028 7265 7375 6c74 2c20   in zip(result, 
-00008ee0: 6578 7065 6374 6564 293a 0a20 2020 2020  expected):.     
-00008ef0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008f00: 7274 4571 7561 6c28 6578 7065 6374 6564  rtEqual(expected
-00008f10: 5f65 6e74 7279 5b30 5d2c 2065 6e74 7279  _entry[0], entry
-00008f20: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
-00008f30: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00008f40: 6c28 6578 7065 6374 6564 5f65 6e74 7279  l(expected_entry
-00008f50: 5b31 5d2c 2073 6f72 7465 6428 656e 7472  [1], sorted(entr
-00008f60: 795b 315d 2929 0a20 2020 2020 2020 2020  y[1])).         
-00008f70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00008f80: 7561 6c28 6578 7065 6374 6564 5f65 6e74  ual(expected_ent
-00008f90: 7279 5b32 5d2c 2073 6f72 7465 6428 656e  ry[2], sorted(en
-00008fa0: 7472 795b 325d 2929 0a0a 0a63 6c61 7373  try[2]))...class
-00008fb0: 2046 616b 6550 6174 684d 6f64 756c 6554   FakePathModuleT
-00008fc0: 6573 7428 5465 7374 4361 7365 293a 0a20  est(TestCase):. 
-00008fd0: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
-00008fe0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00008ff0: 2e66 696c 6573 7973 7465 6d20 3d20 6661  .filesystem = fa
-00009000: 6b65 5f66 696c 6573 7973 7465 6d2e 4661  ke_filesystem.Fa
-00009010: 6b65 4669 6c65 7379 7374 656d 2870 6174  keFilesystem(pat
-00009020: 685f 7365 7061 7261 746f 723d 2221 2229  h_separator="!")
-00009030: 0a20 2020 2020 2020 2073 656c 662e 6f73  .        self.os
-00009040: 203d 2066 616b 655f 6f73 2e46 616b 654f   = fake_os.FakeO
-00009050: 734d 6f64 756c 6528 7365 6c66 2e66 696c  sModule(self.fil
-00009060: 6573 7973 7465 6d29 0a20 2020 2020 2020  esystem).       
-00009070: 2073 656c 662e 7061 7468 203d 2073 656c   self.path = sel
-00009080: 662e 6f73 2e70 6174 680a 0a20 2020 2064  f.os.path..    d
-00009090: 6566 2063 6865 636b 5f61 6273 7061 7468  ef check_abspath
-000090a0: 2873 656c 662c 2069 735f 7769 6e64 6f77  (self, is_window
-000090b0: 7329 3a0a 2020 2020 2020 2020 2320 7468  s):.        # th
-000090c0: 6520 696d 706c 656d 656e 7461 7469 6f6e  e implementation
-000090d0: 2064 6966 6665 7273 2069 6e20 5769 6e64   differs in Wind
-000090e0: 6f77 7320 616e 6420 506f 7369 782c 2073  ows and Posix, s
-000090f0: 6f20 7465 7374 2062 6f74 680a 2020 2020  o test both.    
-00009100: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00009110: 7465 6d2e 6973 5f77 696e 646f 7773 5f66  tem.is_windows_f
-00009120: 7320 3d20 6973 5f77 696e 646f 7773 0a20  s = is_windows. 
-00009130: 2020 2020 2020 2066 696c 656e 616d 6520         filename 
-00009140: 3d20 2266 6f6f 220a 2020 2020 2020 2020  = "foo".        
-00009150: 6162 7370 6174 6820 3d20 7365 6c66 2e66  abspath = self.f
-00009160: 696c 6573 7973 7465 6d2e 726f 6f74 5f64  ilesystem.root_d
-00009170: 6972 5f6e 616d 6520 2b20 6669 6c65 6e61  ir_name + filena
-00009180: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-00009190: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
-000091a0: 655f 6669 6c65 2861 6273 7061 7468 290a  e_file(abspath).
-000091b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000091c0: 6572 7445 7175 616c 2861 6273 7061 7468  ertEqual(abspath
-000091d0: 2c20 7365 6c66 2e70 6174 682e 6162 7370  , self.path.absp
-000091e0: 6174 6828 6162 7370 6174 6829 290a 2020  ath(abspath)).  
-000091f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00009200: 7445 7175 616c 2861 6273 7061 7468 2c20  tEqual(abspath, 
-00009210: 7365 6c66 2e70 6174 682e 6162 7370 6174  self.path.abspat
-00009220: 6828 6669 6c65 6e61 6d65 2929 0a20 2020  h(filename)).   
-00009230: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00009240: 4571 7561 6c28 6162 7370 6174 682c 2073  Equal(abspath, s
-00009250: 656c 662e 7061 7468 2e61 6273 7061 7468  elf.path.abspath
-00009260: 2822 2e2e 2125 7322 2025 2066 696c 656e  ("..!%s" % filen
-00009270: 616d 6529 290a 0a20 2020 2064 6566 2074  ame))..    def t
-00009280: 6573 745f 6162 7370 6174 685f 7769 6e64  est_abspath_wind
-00009290: 6f77 7328 7365 6c66 293a 0a20 2020 2020  ows(self):.     
-000092a0: 2020 2073 656c 662e 6368 6563 6b5f 6162     self.check_ab
-000092b0: 7370 6174 6828 6973 5f77 696e 646f 7773  spath(is_windows
-000092c0: 3d54 7275 6529 0a0a 2020 2020 6465 6620  =True)..    def 
-000092d0: 7465 7374 5f61 6273 7061 7468 5f70 6f73  test_abspath_pos
-000092e0: 6978 2873 656c 6629 3a0a 2020 2020 2020  ix(self):.      
-000092f0: 2020 2222 2261 6273 7061 7468 2073 686f    """abspath sho
-00009300: 756c 6420 7265 7475 726e 2061 2063 6f6e  uld return a con
-00009310: 7369 7374 656e 7420 7265 7072 6573 656e  sistent represen
-00009320: 7461 7469 6f6e 206f 6620 6120 6669 6c65  tation of a file
-00009330: 2e22 2222 0a20 2020 2020 2020 2073 656c  .""".        sel
-00009340: 662e 6368 6563 6b5f 6162 7370 6174 6828  f.check_abspath(
-00009350: 6973 5f77 696e 646f 7773 3d46 616c 7365  is_windows=False
-00009360: 290a 0a20 2020 2064 6566 2063 6865 636b  )..    def check
-00009370: 5f61 6273 7061 7468 5f62 7974 6573 2873  _abspath_bytes(s
-00009380: 656c 662c 2069 735f 7769 6e64 6f77 7329  elf, is_windows)
-00009390: 3a0a 2020 2020 2020 2020 2222 2261 6273  :.        """abs
-000093a0: 7061 7468 2073 686f 756c 6420 7265 7475  path should retu
-000093b0: 726e 2061 2063 6f6e 7369 7374 656e 7420  rn a consistent 
-000093c0: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
-000093d0: 6620 6120 6669 6c65 2e22 2222 0a20 2020  f a file.""".   
-000093e0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-000093f0: 7374 656d 2e69 735f 7769 6e64 6f77 735f  stem.is_windows_
-00009400: 6673 203d 2069 735f 7769 6e64 6f77 730a  fs = is_windows.
-00009410: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-00009420: 203d 2062 2266 6f6f 220a 2020 2020 2020   = b"foo".      
-00009430: 2020 6162 7370 6174 6820 3d20 7365 6c66    abspath = self
-00009440: 2e66 696c 6573 7973 7465 6d2e 726f 6f74  .filesystem.root
-00009450: 5f64 6972 5f6e 616d 652e 656e 636f 6465  _dir_name.encode
-00009460: 2829 202b 2066 696c 656e 616d 650a 2020  () + filename.  
-00009470: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00009480: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
-00009490: 6528 6162 7370 6174 6829 0a20 2020 2020  e(abspath).     
-000094a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000094b0: 7561 6c28 6162 7370 6174 682c 2073 656c  ual(abspath, sel
-000094c0: 662e 7061 7468 2e61 6273 7061 7468 2861  f.path.abspath(a
-000094d0: 6273 7061 7468 2929 0a20 2020 2020 2020  bspath)).       
-000094e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000094f0: 6c28 6162 7370 6174 682c 2073 656c 662e  l(abspath, self.
-00009500: 7061 7468 2e61 6273 7061 7468 2866 696c  path.abspath(fil
-00009510: 656e 616d 6529 290a 2020 2020 2020 2020  ename)).        
-00009520: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00009530: 2861 6273 7061 7468 2c20 7365 6c66 2e70  (abspath, self.p
-00009540: 6174 682e 6162 7370 6174 6828 6222 2e2e  ath.abspath(b"..
-00009550: 2122 202b 2066 696c 656e 616d 6529 290a  !" + filename)).
-00009560: 0a20 2020 2064 6566 2074 6573 745f 6162  .    def test_ab
-00009570: 7370 6174 685f 6279 7465 735f 7769 6e64  spath_bytes_wind
-00009580: 6f77 7328 7365 6c66 293a 0a20 2020 2020  ows(self):.     
-00009590: 2020 2073 656c 662e 6368 6563 6b5f 6162     self.check_ab
-000095a0: 7370 6174 685f 6279 7465 7328 6973 5f77  spath_bytes(is_w
-000095b0: 696e 646f 7773 3d54 7275 6529 0a0a 2020  indows=True)..  
-000095c0: 2020 6465 6620 7465 7374 5f61 6273 7061    def test_abspa
-000095d0: 7468 5f62 7974 6573 5f70 6f73 6978 2873  th_bytes_posix(s
-000095e0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000095f0: 6c66 2e63 6865 636b 5f61 6273 7061 7468  lf.check_abspath
-00009600: 5f62 7974 6573 2869 735f 7769 6e64 6f77  _bytes(is_window
-00009610: 733d 4661 6c73 6529 0a0a 2020 2020 6465  s=False)..    de
-00009620: 6620 7465 7374 5f61 6273 7061 7468 5f64  f test_abspath_d
-00009630: 6561 6c73 5f77 6974 685f 7265 6c61 7469  eals_with_relati
-00009640: 7665 5f6e 6f6e 5f72 6f6f 745f 7061 7468  ve_non_root_path
-00009650: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00009660: 2222 2261 6273 7061 7468 2073 686f 756c  """abspath shoul
-00009670: 6420 636f 7272 6563 746c 7920 6861 6e64  d correctly hand
-00009680: 6c65 2072 656c 6174 6976 6520 7061 7468  le relative path
-00009690: 7320 6672 6f6d 2061 0a20 2020 2020 2020  s from a.       
-000096a0: 206e 6f6e 2d21 2064 6972 6563 746f 7279   non-! directory
-000096b0: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-000096c0: 7465 7374 2069 7320 6469 7374 696e 6374  test is distinct
-000096d0: 2066 726f 6d20 7468 6520 6261 7369 6320   from the basic 
-000096e0: 6675 6e63 7469 6f6e 616c 6974 7920 7465  functionality te
-000096f0: 7374 2062 6563 6175 7365 0a20 2020 2020  st because.     
-00009700: 2020 2066 616b 655f 6669 6c65 7379 7374     fake_filesyst
-00009710: 656d 2068 6173 2068 6973 746f 7269 6361  em has historica
-00009720: 6c6c 7920 6265 656e 2062 6173 6564 2069  lly been based i
-00009730: 6e20 212e 0a20 2020 2020 2020 2022 2222  n !..        """
-00009740: 0a20 2020 2020 2020 2066 696c 656e 616d  .        filenam
-00009750: 6520 3d20 2221 666f 6f21 6261 7221 6261  e = "!foo!bar!ba
-00009760: 7a22 0a20 2020 2020 2020 2066 696c 655f  z".        file_
-00009770: 636f 6d70 6f6e 656e 7473 203d 2066 696c  components = fil
-00009780: 656e 616d 652e 7370 6c69 7428 7365 6c66  ename.split(self
-00009790: 2e70 6174 682e 7365 7029 0a20 2020 2020  .path.sep).     
-000097a0: 2020 2072 6f6f 745f 6e61 6d65 203d 2073     root_name = s
-000097b0: 656c 662e 6669 6c65 7379 7374 656d 2e72  elf.filesystem.r
-000097c0: 6f6f 745f 6469 725f 6e61 6d65 0a20 2020  oot_dir_name.   
-000097d0: 2020 2020 2062 6173 6564 6972 203d 2066       basedir = f
-000097e0: 227b 726f 6f74 5f6e 616d 657d 7b66 696c  "{root_name}{fil
-000097f0: 655f 636f 6d70 6f6e 656e 7473 5b30 5d7d  e_components[0]}
-00009800: 220a 2020 2020 2020 2020 7365 6c66 2e66  ".        self.f
-00009810: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
-00009820: 5f66 696c 6528 6669 6c65 6e61 6d65 290a  _file(filename).
-00009830: 2020 2020 2020 2020 7365 6c66 2e6f 732e          self.os.
-00009840: 6368 6469 7228 6261 7365 6469 7229 0a20  chdir(basedir). 
-00009850: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00009860: 7274 4571 7561 6c28 6261 7365 6469 722c  rtEqual(basedir,
-00009870: 2073 656c 662e 7061 7468 2e61 6273 7061   self.path.abspa
-00009880: 7468 2873 656c 662e 7061 7468 2e63 7572  th(self.path.cur
-00009890: 6469 7229 290a 2020 2020 2020 2020 7365  dir)).        se
-000098a0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-000098b0: 6f6f 745f 6e61 6d65 2c20 7365 6c66 2e70  oot_name, self.p
-000098c0: 6174 682e 6162 7370 6174 6828 222e 2e22  ath.abspath(".."
-000098d0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-000098e0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-000098f0: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
-00009900: 7468 2e6a 6f69 6e28 6261 7365 6469 722c  th.join(basedir,
-00009910: 2066 696c 655f 636f 6d70 6f6e 656e 7473   file_components
-00009920: 5b31 5d29 2c0a 2020 2020 2020 2020 2020  [1]),.          
-00009930: 2020 7365 6c66 2e70 6174 682e 6162 7370    self.path.absp
-00009940: 6174 6828 6669 6c65 5f63 6f6d 706f 6e65  ath(file_compone
-00009950: 6e74 735b 315d 292c 0a20 2020 2020 2020  nts[1]),.       
-00009960: 2029 0a0a 2020 2020 6465 6620 7465 7374   )..    def test
-00009970: 5f61 6273 5f70 6174 685f 7769 7468 5f64  _abs_path_with_d
-00009980: 7269 7665 5f63 6f6d 706f 6e65 6e74 2873  rive_component(s
-00009990: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000099a0: 6c66 2e66 696c 6573 7973 7465 6d2e 6973  lf.filesystem.is
-000099b0: 5f77 696e 646f 7773 5f66 7320 3d20 5472  _windows_fs = Tr
-000099c0: 7565 0a20 2020 2020 2020 2073 656c 662e  ue.        self.
-000099d0: 6669 6c65 7379 7374 656d 2e63 7764 203d  filesystem.cwd =
-000099e0: 2022 433a 2166 6f6f 220a 2020 2020 2020   "C:!foo".      
-000099f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00009a00: 616c 2822 433a 2166 6f6f 2162 6172 222c  al("C:!foo!bar",
-00009a10: 2073 656c 662e 7061 7468 2e61 6273 7061   self.path.abspa
-00009a20: 7468 2822 6261 7222 2929 0a20 2020 2020  th("bar")).     
-00009a30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00009a40: 7561 6c28 2243 3a21 666f 6f21 6261 7222  ual("C:!foo!bar"
-00009a50: 2c20 7365 6c66 2e70 6174 682e 6162 7370  , self.path.absp
-00009a60: 6174 6828 2243 3a62 6172 2229 290a 2020  ath("C:bar")).  
-00009a70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00009a80: 7445 7175 616c 2822 433a 2166 6f6f 2162  tEqual("C:!foo!b
-00009a90: 6172 222c 2073 656c 662e 7061 7468 2e61  ar", self.path.a
-00009aa0: 6273 7061 7468 2822 2166 6f6f 2162 6172  bspath("!foo!bar
-00009ab0: 2229 290a 0a20 2020 2064 6566 2074 6573  "))..    def tes
-00009ac0: 745f 6973 6162 735f 7769 7468 5f64 7269  t_isabs_with_dri
-00009ad0: 7665 5f63 6f6d 706f 6e65 6e74 2873 656c  ve_component(sel
-00009ae0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00009af0: 2e66 696c 6573 7973 7465 6d2e 6973 5f77  .filesystem.is_w
-00009b00: 696e 646f 7773 5f66 7320 3d20 4661 6c73  indows_fs = Fals
-00009b10: 650a 2020 2020 2020 2020 7365 6c66 2e61  e.        self.a
-00009b20: 7373 6572 7446 616c 7365 2873 656c 662e  ssertFalse(self.
-00009b30: 7061 7468 2e69 7361 6273 2822 433a 2166  path.isabs("C:!f
-00009b40: 6f6f 2229 290a 2020 2020 2020 2020 7365  oo")).        se
-00009b50: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
-00009b60: 656c 662e 7061 7468 2e69 7361 6273 2862  elf.path.isabs(b
-00009b70: 2243 3a21 666f 6f22 2929 0a20 2020 2020  "C:!foo")).     
-00009b80: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00009b90: 7565 2873 656c 662e 7061 7468 2e69 7361  ue(self.path.isa
-00009ba0: 6273 2822 2122 2929 0a20 2020 2020 2020  bs("!")).       
-00009bb0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-00009bc0: 2873 656c 662e 7061 7468 2e69 7361 6273  (self.path.isabs
-00009bd0: 2862 2221 2229 290a 2020 2020 2020 2020  (b"!")).        
-00009be0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00009bf0: 6973 5f77 696e 646f 7773 5f66 7320 3d20  is_windows_fs = 
-00009c00: 5472 7565 0a20 2020 2020 2020 2073 656c  True.        sel
-00009c10: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-00009c20: 662e 7061 7468 2e69 7361 6273 2822 433a  f.path.isabs("C:
-00009c30: 2166 6f6f 2229 290a 2020 2020 2020 2020  !foo")).        
-00009c40: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00009c50: 7365 6c66 2e70 6174 682e 6973 6162 7328  self.path.isabs(
-00009c60: 6222 433a 2166 6f6f 2229 290a 2020 2020  b"C:!foo")).    
-00009c70: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00009c80: 7275 6528 7365 6c66 2e70 6174 682e 6973  rue(self.path.is
-00009c90: 6162 7328 2221 2229 290a 2020 2020 2020  abs("!")).      
-00009ca0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-00009cb0: 6528 7365 6c66 2e70 6174 682e 6973 6162  e(self.path.isab
-00009cc0: 7328 6222 2122 2929 0a0a 2020 2020 6465  s(b"!"))..    de
-00009cd0: 6620 7465 7374 5f72 656c 7061 7468 2873  f test_relpath(s
-00009ce0: 656c 6629 3a0a 2020 2020 2020 2020 7061  elf):.        pa
-00009cf0: 7468 5f66 6f6f 203d 2022 2170 6174 6821  th_foo = "!path!
-00009d00: 746f 2166 6f6f 220a 2020 2020 2020 2020  to!foo".        
-00009d10: 7061 7468 5f62 6172 203d 2022 2170 6174  path_bar = "!pat
-00009d20: 6821 746f 2162 6172 220a 2020 2020 2020  h!to!bar".      
-00009d30: 2020 7061 7468 5f6f 7468 6572 203d 2022    path_other = "
-00009d40: 2173 6f6d 6521 7768 6572 6521 656c 7365  !some!where!else
-00009d50: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
-00009d60: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00009d70: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
-00009d80: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00009d90: 6174 682e 7265 6c70 6174 6828 4e6f 6e65  ath.relpath(None
-00009da0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00009db0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00009dc0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
-00009dd0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00009de0: 6174 682e 7265 6c70 6174 6828 2222 290a  ath.relpath("").
-00009df0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00009e00: 6572 7445 7175 616c 2822 7061 7468 2174  ertEqual("path!t
-00009e10: 6f21 666f 6f22 2c20 7365 6c66 2e70 6174  o!foo", self.pat
-00009e20: 682e 7265 6c70 6174 6828 7061 7468 5f66  h.relpath(path_f
-00009e30: 6f6f 2929 0a20 2020 2020 2020 2073 656c  oo)).        sel
-00009e40: 662e 6173 7365 7274 4571 7561 6c28 222e  f.assertEqual(".
-00009e50: 2e21 666f 6f22 2c20 7365 6c66 2e70 6174  .!foo", self.pat
-00009e60: 682e 7265 6c70 6174 6828 7061 7468 5f66  h.relpath(path_f
-00009e70: 6f6f 2c20 7061 7468 5f62 6172 2929 0a20  oo, path_bar)). 
-00009e80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00009e90: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-00009ea0: 2020 2020 2022 2e2e 212e 2e21 2e2e 2573       "..!..!..%s
-00009eb0: 2220 2520 7061 7468 5f6f 7468 6572 2c20  " % path_other, 
-00009ec0: 7365 6c66 2e70 6174 682e 7265 6c70 6174  self.path.relpat
-00009ed0: 6828 7061 7468 5f6f 7468 6572 2c20 7061  h(path_other, pa
-00009ee0: 7468 5f62 6172 290a 2020 2020 2020 2020  th_bar).        
-00009ef0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00009f00: 7373 6572 7445 7175 616c 2822 2e22 2c20  ssertEqual(".", 
-00009f10: 7365 6c66 2e70 6174 682e 7265 6c70 6174  self.path.relpat
-00009f20: 6828 7061 7468 5f62 6172 2c20 7061 7468  h(path_bar, path
-00009f30: 5f62 6172 2929 0a0a 2020 2020 6465 6620  _bar))..    def 
-00009f40: 7465 7374 5f72 6561 6c70 6174 685f 7673  test_realpath_vs
-00009f50: 5f61 6273 7061 7468 2873 656c 6629 3a0a  _abspath(self):.
-00009f60: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00009f70: 6573 7973 7465 6d2e 6973 5f77 696e 646f  esystem.is_windo
-00009f80: 7773 5f66 7320 3d20 4661 6c73 650a 2020  ws_fs = False.  
-00009f90: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00009fa0: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
-00009fb0: 6528 2221 6765 6f72 6765 2177 6173 6869  e("!george!washi
-00009fc0: 6e67 746f 6e21 6272 6964 6765 2229 0a20  ngton!bridge"). 
-00009fd0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-00009fe0: 7379 7374 656d 2e63 7265 6174 655f 7379  system.create_sy
-00009ff0: 6d6c 696e 6b28 2221 6669 7273 7421 7072  mlink("!first!pr
-0000a000: 6573 6964 656e 7422 2c20 2221 6765 6f72  esident", "!geor
-0000a010: 6765 2177 6173 6869 6e67 746f 6e22 290a  ge!washington").
-0000a020: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000a030: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-0000a040: 2020 2020 2020 2221 6669 7273 7421 7072        "!first!pr
-0000a050: 6573 6964 656e 7421 6272 6964 6765 222c  esident!bridge",
-0000a060: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000a070: 662e 6f73 2e70 6174 682e 6162 7370 6174  f.os.path.abspat
-0000a080: 6828 2221 6669 7273 7421 7072 6573 6964  h("!first!presid
-0000a090: 656e 7421 6272 6964 6765 2229 2c0a 2020  ent!bridge"),.  
-0000a0a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a0b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000a0c0: 280a 2020 2020 2020 2020 2020 2020 2221  (.            "!
-0000a0d0: 6765 6f72 6765 2177 6173 6869 6e67 746f  george!washingto
-0000a0e0: 6e21 6272 6964 6765 222c 0a20 2020 2020  n!bridge",.     
-0000a0f0: 2020 2020 2020 2073 656c 662e 6f73 2e70         self.os.p
-0000a100: 6174 682e 7265 616c 7061 7468 2822 2166  ath.realpath("!f
-0000a110: 6972 7374 2170 7265 7369 6465 6e74 2162  irst!president!b
-0000a120: 7269 6467 6522 292c 0a20 2020 2020 2020  ridge"),.       
-0000a130: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0000a140: 6f73 2e63 6864 6972 2822 2166 6972 7374  os.chdir("!first
-0000a150: 2170 7265 7369 6465 6e74 2229 0a20 2020  !president").   
-0000a160: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000a170: 4571 7561 6c28 2221 6765 6f72 6765 2177  Equal("!george!w
-0000a180: 6173 6869 6e67 746f 6e21 6272 6964 6765  ashington!bridge
-0000a190: 222c 2073 656c 662e 6f73 2e70 6174 682e  ", self.os.path.
-0000a1a0: 7265 616c 7061 7468 2822 6272 6964 6765  realpath("bridge
-0000a1b0: 2229 290a 0a20 2020 2040 756e 6974 7465  "))..    @unitte
-0000a1c0: 7374 2e73 6b69 7049 6628 7379 732e 7665  st.skipIf(sys.ve
-0000a1d0: 7273 696f 6e5f 696e 666f 203c 2028 332c  rsion_info < (3,
-0000a1e0: 2031 3029 2c20 2227 7374 7269 6374 2720   10), "'strict' 
-0000a1f0: 6e65 7720 696e 2050 7974 686f 6e20 332e  new in Python 3.
-0000a200: 3130 2229 0a20 2020 2064 6566 2074 6573  10").    def tes
-0000a210: 745f 7265 616c 7061 7468 5f73 7472 6963  t_realpath_stric
-0000a220: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0000a230: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000a240: 2e63 7265 6174 655f 6669 6c65 2822 2166  .create_file("!f
-0000a250: 6f6f 2162 6172 2229 0a20 2020 2020 2020  oo!bar").       
-0000a260: 2072 6f6f 745f 6469 7220 3d20 7365 6c66   root_dir = self
-0000a270: 2e66 696c 6573 7973 7465 6d2e 726f 6f74  .filesystem.root
-0000a280: 5f64 6972 5f6e 616d 650a 2020 2020 2020  _dir_name.      
-0000a290: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-0000a2a0: 6d2e 6377 6420 3d20 6622 7b72 6f6f 745f  m.cwd = f"{root_
-0000a2b0: 6469 727d 666f 6f22 0a20 2020 2020 2020  dir}foo".       
-0000a2c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000a2d0: 6c28 0a20 2020 2020 2020 2020 2020 2066  l(.            f
-0000a2e0: 227b 726f 6f74 5f64 6972 7d66 6f6f 2162  "{root_dir}foo!b
-0000a2f0: 617a 222c 2073 656c 662e 6f73 2e70 6174  az", self.os.pat
-0000a300: 682e 7265 616c 7061 7468 2822 6261 7a22  h.realpath("baz"
-0000a310: 2c20 7374 7269 6374 3d46 616c 7365 290a  , strict=False).
-0000a320: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000a330: 2020 7769 7468 2073 656c 662e 7261 6973    with self.rais
-0000a340: 6573 5f6f 735f 6572 726f 7228 6572 726e  es_os_error(errn
-0000a350: 6f2e 454e 4f45 4e54 293a 0a20 2020 2020  o.ENOENT):.     
-0000a360: 2020 2020 2020 2073 656c 662e 6f73 2e70         self.os.p
-0000a370: 6174 682e 7265 616c 7061 7468 2822 6261  ath.realpath("ba
-0000a380: 7a22 2c20 7374 7269 6374 3d54 7275 6529  z", strict=True)
-0000a390: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000a3a0: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
-0000a3b0: 2020 2020 2020 2066 227b 726f 6f74 5f64         f"{root_d
-0000a3c0: 6972 7d66 6f6f 2162 6172 222c 2073 656c  ir}foo!bar", sel
-0000a3d0: 662e 6f73 2e70 6174 682e 7265 616c 7061  f.os.path.realpa
-0000a3e0: 7468 2822 6261 7222 2c20 7374 7269 6374  th("bar", strict
-0000a3f0: 3d54 7275 6529 0a20 2020 2020 2020 2029  =True).        )
-0000a400: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-0000a410: 616d 6566 696c 6528 7365 6c66 293a 0a20  amefile(self):. 
-0000a420: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-0000a430: 3120 3d20 2221 666f 6f21 6261 7221 6261  1 = "!foo!bar!ba
-0000a440: 7a22 0a20 2020 2020 2020 2066 696c 655f  z".        file_
-0000a450: 7061 7468 3220 3d20 2221 666f 6f21 6261  path2 = "!foo!ba
-0000a460: 7221 626f 6f22 0a20 2020 2020 2020 2073  r!boo".        s
-0000a470: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-0000a480: 7265 6174 655f 6669 6c65 2866 696c 655f  reate_file(file_
-0000a490: 7061 7468 3129 0a20 2020 2020 2020 2073  path1).        s
-0000a4a0: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-0000a4b0: 7265 6174 655f 6669 6c65 2866 696c 655f  reate_file(file_
-0000a4c0: 7061 7468 3229 0a20 2020 2020 2020 2073  path2).        s
-0000a4d0: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-0000a4e0: 656c 662e 7061 7468 2e73 616d 6566 696c  elf.path.samefil
-0000a4f0: 6528 6669 6c65 5f70 6174 6831 2c20 6669  e(file_path1, fi
-0000a500: 6c65 5f70 6174 6831 2929 0a20 2020 2020  le_path1)).     
-0000a510: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
-0000a520: 6c73 6528 7365 6c66 2e70 6174 682e 7361  lse(self.path.sa
-0000a530: 6d65 6669 6c65 2866 696c 655f 7061 7468  mefile(file_path
-0000a540: 312c 2066 696c 655f 7061 7468 3229 290a  1, file_path2)).
-0000a550: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000a560: 6572 7454 7275 6528 7365 6c66 2e70 6174  ertTrue(self.pat
-0000a570: 682e 7361 6d65 6669 6c65 2866 696c 655f  h.samefile(file_
-0000a580: 7061 7468 312c 2022 2166 6f6f 212e 2e21  path1, "!foo!..!
-0000a590: 666f 6f21 6261 7221 2e2e 2162 6172 2162  foo!bar!..!bar!b
-0000a5a0: 617a 2229 290a 2020 2020 2020 2020 7365  az")).        se
-0000a5b0: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-0000a5c0: 6c66 2e70 6174 682e 7361 6d65 6669 6c65  lf.path.samefile
-0000a5d0: 2866 696c 655f 7061 7468 312c 2062 2221  (file_path1, b"!
-0000a5e0: 666f 6f21 2e2e 2166 6f6f 2162 6172 212e  foo!..!foo!bar!.
-0000a5f0: 2e21 6261 7221 6261 7a22 2929 0a0a 2020  .!bar!baz"))..  
-0000a600: 2020 6465 6620 7465 7374 5f65 7869 7374    def test_exist
-0000a610: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-0000a620: 2066 696c 655f 7061 7468 203d 2022 666f   file_path = "fo
-0000a630: 6f21 6261 7221 6261 7a22 0a20 2020 2020  o!bar!baz".     
-0000a640: 2020 2066 696c 655f 7061 7468 5f62 7974     file_path_byt
-0000a650: 6573 203d 2062 2266 6f6f 2162 6172 2162  es = b"foo!bar!b
-0000a660: 617a 220a 2020 2020 2020 2020 7365 6c66  az".        self
-0000a670: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-0000a680: 7465 5f66 696c 6528 6669 6c65 5f70 6174  te_file(file_pat
-0000a690: 6829 0a20 2020 2020 2020 2073 656c 662e  h).        self.
-0000a6a0: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
-0000a6b0: 7061 7468 2e65 7869 7374 7328 6669 6c65  path.exists(file
-0000a6c0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
-0000a6d0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000a6e0: 7365 6c66 2e70 6174 682e 6578 6973 7473  self.path.exists
-0000a6f0: 2866 696c 655f 7061 7468 5f62 7974 6573  (file_path_bytes
-0000a700: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000a710: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
-0000a720: 2e70 6174 682e 6578 6973 7473 2822 2173  .path.exists("!s
-0000a730: 6f6d 6521 6f74 6865 7221 626f 6775 7321  ome!other!bogus!
-0000a740: 7061 7468 2229 290a 0a20 2020 2064 6566  path"))..    def
-0000a750: 2074 6573 745f 6578 6973 7473 5f77 6974   test_exists_wit
-0000a760: 685f 6472 6976 6528 7365 6c66 293a 0a20  h_drive(self):. 
-0000a770: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-0000a780: 7379 7374 656d 2e6f 7320 3d20 4f53 5479  system.os = OSTy
-0000a790: 7065 2e57 494e 444f 5753 0a20 2020 2020  pe.WINDOWS.     
-0000a7a0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-0000a7b0: 656d 2e61 6464 5f6d 6f75 6e74 5f70 6f69  em.add_mount_poi
-0000a7c0: 6e74 2822 463a 2229 0a20 2020 2020 2020  nt("F:").       
-0000a7d0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0000a7e0: 2873 656c 662e 7061 7468 2e65 7869 7374  (self.path.exist
-0000a7f0: 7328 2243 3a22 2929 0a20 2020 2020 2020  s("C:")).       
-0000a800: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0000a810: 2873 656c 662e 7061 7468 2e65 7869 7374  (self.path.exist
-0000a820: 7328 2263 3a5c 5c22 2929 0a20 2020 2020  s("c:\\")).     
-0000a830: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000a840: 7565 2873 656c 662e 7061 7468 2e65 7869  ue(self.path.exi
-0000a850: 7374 7328 2266 3a22 2929 0a20 2020 2020  sts("f:")).     
-0000a860: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000a870: 7565 2873 656c 662e 7061 7468 2e65 7869  ue(self.path.exi
-0000a880: 7374 7328 2246 3a5c 5c22 2929 0a20 2020  sts("F:\\")).   
-0000a890: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000a8a0: 4661 6c73 6528 7365 6c66 2e70 6174 682e  False(self.path.
-0000a8b0: 6578 6973 7473 2822 5a3a 2229 290a 2020  exists("Z:")).  
-0000a8c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000a8d0: 7446 616c 7365 2873 656c 662e 7061 7468  tFalse(self.path
-0000a8e0: 2e65 7869 7374 7328 227a 3a5c 5c22 2929  .exists("z:\\"))
-0000a8f0: 0a0a 2020 2020 6465 6620 7465 7374 5f6c  ..    def test_l
-0000a900: 6578 6973 7473 2873 656c 6629 3a0a 2020  exists(self):.  
-0000a910: 2020 2020 2020 6669 6c65 5f70 6174 6820        file_path 
-0000a920: 3d20 2266 6f6f 2162 6172 2162 617a 220a  = "foo!bar!baz".
-0000a930: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
-0000a940: 685f 6279 7465 7320 3d20 6222 666f 6f21  h_bytes = b"foo!
-0000a950: 6261 7221 6261 7a22 0a20 2020 2020 2020  bar!baz".       
-0000a960: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000a970: 2e63 7265 6174 655f 6469 7228 2266 6f6f  .create_dir("foo
-0000a980: 2162 6172 2229 0a20 2020 2020 2020 2073  !bar").        s
-0000a990: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-0000a9a0: 7265 6174 655f 7379 6d6c 696e 6b28 6669  reate_symlink(fi
-0000a9b0: 6c65 5f70 6174 682c 2022 626f 6775 7322  le_path, "bogus"
-0000a9c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000a9d0: 7373 6572 7454 7275 6528 7365 6c66 2e70  ssertTrue(self.p
-0000a9e0: 6174 682e 6c65 7869 7374 7328 6669 6c65  ath.lexists(file
-0000a9f0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
-0000aa00: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000aa10: 7365 6c66 2e70 6174 682e 6c65 7869 7374  self.path.lexist
-0000aa20: 7328 6669 6c65 5f70 6174 685f 6279 7465  s(file_path_byte
-0000aa30: 7329 290a 2020 2020 2020 2020 7365 6c66  s)).        self
-0000aa40: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
-0000aa50: 662e 7061 7468 2e65 7869 7374 7328 6669  f.path.exists(fi
-0000aa60: 6c65 5f70 6174 6829 290a 2020 2020 2020  le_path)).      
-0000aa70: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-0000aa80: 7365 2873 656c 662e 7061 7468 2e65 7869  se(self.path.exi
-0000aa90: 7374 7328 6669 6c65 5f70 6174 685f 6279  sts(file_path_by
-0000aaa0: 7465 7329 290a 2020 2020 2020 2020 7365  tes)).        se
-0000aab0: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
-0000aac0: 6561 7465 5f66 696c 6528 2266 6f6f 2162  eate_file("foo!b
-0000aad0: 6172 2162 6f67 7573 2229 0a20 2020 2020  ar!bogus").     
-0000aae0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000aaf0: 7565 2873 656c 662e 7061 7468 2e65 7869  ue(self.path.exi
-0000ab00: 7374 7328 6669 6c65 5f70 6174 6829 290a  sts(file_path)).
-0000ab10: 0a20 2020 2064 6566 2074 6573 745f 6469  .    def test_di
-0000ab20: 726e 616d 655f 7769 7468 5f64 7269 7665  rname_with_drive
-0000ab30: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000ab40: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000ab50: 6973 5f77 696e 646f 7773 5f66 7320 3d20  is_windows_fs = 
-0000ab60: 5472 7565 0a20 2020 2020 2020 2073 656c  True.        sel
-0000ab70: 662e 6173 7365 7274 4571 7561 6c28 2263  f.assertEqual("c
-0000ab80: 3a21 666f 6f22 2c20 7365 6c66 2e70 6174  :!foo", self.pat
-0000ab90: 682e 6469 726e 616d 6528 2263 3a21 666f  h.dirname("c:!fo
-0000aba0: 6f21 6261 7222 2929 0a20 2020 2020 2020  o!bar")).       
-0000abb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000abc0: 6c28 6222 633a 2122 2c20 7365 6c66 2e70  l(b"c:!", self.p
-0000abd0: 6174 682e 6469 726e 616d 6528 6222 633a  ath.dirname(b"c:
-0000abe0: 2166 6f6f 2229 290a 2020 2020 2020 2020  !foo")).        
-0000abf0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ac00: 2822 2166 6f6f 222c 2073 656c 662e 7061  ("!foo", self.pa
-0000ac10: 7468 2e64 6972 6e61 6d65 2822 2166 6f6f  th.dirname("!foo
-0000ac20: 2162 6172 2229 290a 2020 2020 2020 2020  !bar")).        
-0000ac30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ac40: 2862 2221 222c 2073 656c 662e 7061 7468  (b"!", self.path
-0000ac50: 2e64 6972 6e61 6d65 2862 2221 666f 6f22  .dirname(b"!foo"
-0000ac60: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000ac70: 6173 7365 7274 4571 7561 6c28 2263 3a66  assertEqual("c:f
-0000ac80: 6f6f 222c 2073 656c 662e 7061 7468 2e64  oo", self.path.d
-0000ac90: 6972 6e61 6d65 2822 633a 666f 6f21 6261  irname("c:foo!ba
-0000aca0: 7222 2929 0a20 2020 2020 2020 2073 656c  r")).        sel
-0000acb0: 662e 6173 7365 7274 4571 7561 6c28 6222  f.assertEqual(b"
-0000acc0: 633a 222c 2073 656c 662e 7061 7468 2e64  c:", self.path.d
-0000acd0: 6972 6e61 6d65 2862 2263 3a66 6f6f 2229  irname(b"c:foo")
-0000ace0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000acf0: 7373 6572 7445 7175 616c 2822 666f 6f22  ssertEqual("foo"
-0000ad00: 2c20 7365 6c66 2e70 6174 682e 6469 726e  , self.path.dirn
-0000ad10: 616d 6528 2266 6f6f 2162 6172 2229 290a  ame("foo!bar")).
-0000ad20: 0a20 2020 2064 6566 2074 6573 745f 6469  .    def test_di
-0000ad30: 726e 616d 6528 7365 6c66 293a 0a20 2020  rname(self):.   
-0000ad40: 2020 2020 2064 6972 6e61 6d65 203d 2022       dirname = "
-0000ad50: 666f 6f21 6261 7222 0a20 2020 2020 2020  foo!bar".       
-0000ad60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000ad70: 6c28 6469 726e 616d 652c 2073 656c 662e  l(dirname, self.
-0000ad80: 7061 7468 2e64 6972 6e61 6d65 2822 2573  path.dirname("%s
-0000ad90: 2162 617a 2220 2520 6469 726e 616d 6529  !baz" % dirname)
-0000ada0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000adb0: 6a6f 696e 5f73 7472 696e 6773 2873 656c  join_strings(sel
-0000adc0: 6629 3a0a 2020 2020 2020 2020 636f 6d70  f):.        comp
-0000add0: 6f6e 656e 7473 203d 205b 2266 6f6f 222c  onents = ["foo",
-0000ade0: 2022 6261 7222 2c20 2262 617a 225d 0a20   "bar", "baz"]. 
-0000adf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ae00: 7274 4571 7561 6c28 2266 6f6f 2162 6172  rtEqual("foo!bar
-0000ae10: 2162 617a 222c 2073 656c 662e 7061 7468  !baz", self.path
-0000ae20: 2e6a 6f69 6e28 2a63 6f6d 706f 6e65 6e74  .join(*component
-0000ae30: 7329 290a 0a20 2020 2064 6566 2074 6573  s))..    def tes
-0000ae40: 745f 6a6f 696e 5f62 7974 6573 2873 656c  t_join_bytes(sel
-0000ae50: 6629 3a0a 2020 2020 2020 2020 636f 6d70  f):.        comp
-0000ae60: 6f6e 656e 7473 203d 205b 6222 666f 6f22  onents = [b"foo"
-0000ae70: 2c20 6222 6261 7222 2c20 6222 6261 7a22  , b"bar", b"baz"
-0000ae80: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-0000ae90: 7373 6572 7445 7175 616c 2862 2266 6f6f  ssertEqual(b"foo
-0000aea0: 2162 6172 2162 617a 222c 2073 656c 662e  !bar!baz", self.
-0000aeb0: 7061 7468 2e6a 6f69 6e28 2a63 6f6d 706f  path.join(*compo
-0000aec0: 6e65 6e74 7329 290a 0a20 2020 2040 756e  nents))..    @un
-0000aed0: 6974 7465 7374 2e73 6b69 7049 6628 0a20  ittest.skipIf(. 
-0000aee0: 2020 2020 2020 2073 7973 2e70 6c61 7466         sys.platf
-0000aef0: 6f72 6d20 213d 2022 7769 6e33 3222 206f  orm != "win32" o
-0000af00: 7220 7379 732e 7665 7273 696f 6e5f 696e  r sys.version_in
-0000af10: 666f 203c 2028 332c 2038 292c 2022 5769  fo < (3, 8), "Wi
-0000af20: 6e64 6f77 7320 7370 6563 6966 6963 2074  ndows specific t
-0000af30: 6573 7422 0a20 2020 2029 0a20 2020 2040  est".    ).    @
-0000af40: 7061 7463 682e 6469 6374 286f 732e 656e  patch.dict(os.en
-0000af50: 7669 726f 6e2c 207b 2255 5345 5250 524f  viron, {"USERPRO
-0000af60: 4649 4c45 223a 2072 2243 3a5c 5573 6572  FILE": r"C:\User
-0000af70: 735c 4a6f 686e 227d 290a 2020 2020 6465  s\John"}).    de
-0000af80: 6620 7465 7374 5f65 7870 616e 645f 7573  f test_expand_us
-0000af90: 6572 5f77 696e 646f 7773 2873 656c 6629  er_windows(self)
-0000afa0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-0000afb0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000afc0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
-0000afd0: 227e 2229 2c20 2243 3a21 5573 6572 7321  "~"), "C:!Users!
-0000afe0: 4a6f 686e 2229 0a0a 2020 2020 4075 6e69  John")..    @uni
-0000aff0: 7474 6573 742e 736b 6970 4966 2873 7973  ttest.skipIf(sys
-0000b000: 2e70 6c61 7466 6f72 6d20 3d3d 2022 7769  .platform == "wi
-0000b010: 6e33 3222 2c20 2250 6f73 6978 2073 7065  n32", "Posix spe
-0000b020: 6369 6669 6320 7465 7374 2229 0a20 2020  cific test").   
-0000b030: 2040 7061 7463 682e 6469 6374 286f 732e   @patch.dict(os.
-0000b040: 656e 7669 726f 6e2c 207b 2248 4f4d 4522  environ, {"HOME"
-0000b050: 3a20 222f 686f 6d65 2f6a 6f68 6e22 7d29  : "/home/john"})
-0000b060: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
-0000b070: 7061 6e64 5f75 7365 7228 7365 6c66 293a  pand_user(self):
-0000b080: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000b090: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
-0000b0a0: 6174 682e 6578 7061 6e64 7573 6572 2822  ath.expanduser("
-0000b0b0: 7e22 292c 2022 2168 6f6d 6521 6a6f 686e  ~"), "!home!john
-0000b0c0: 2229 0a0a 2020 2020 4070 6174 6368 2e64  ")..    @patch.d
-0000b0d0: 6963 7428 6f73 2e65 6e76 6972 6f6e 2c20  ict(os.environ, 
-0000b0e0: 7b7d 2c20 636c 6561 723d 5472 7565 290a  {}, clear=True).
-0000b0f0: 2020 2020 6465 6620 7465 7374 5f65 7870      def test_exp
-0000b100: 616e 645f 7573 6572 5f6e 6f5f 686f 6d65  and_user_no_home
-0000b110: 5f65 6e76 6972 6f6e 6d65 6e74 2873 656c  _environment(sel
-0000b120: 6629 3a0a 2020 2020 2020 2020 2222 224d  f):.        """M
-0000b130: 616b 6520 7375 7265 2074 6869 7320 616c  ake sure this al
-0000b140: 736f 2077 6f72 6b73 2077 6974 686f 7574  so works without
-0000b150: 2048 4f4d 4520 2f20 5553 4552 5052 4f46   HOME / USERPROF
-0000b160: 494c 4520 7365 7422 2222 0a20 2020 2020  ILE set""".     
-0000b170: 2020 2023 2077 6520 6a75 7374 2063 6865     # we just che
-0000b180: 636b 2074 6861 7420 6974 2064 6f65 7320  ck that it does 
-0000b190: 6e6f 7420 6372 6173 6820 616e 6420 6861  not crash and ha
-0000b1a0: 7320 736f 6d65 2072 6573 756c 742c 0a20  s some result,. 
-0000b1b0: 2020 2020 2020 2023 2061 7320 7468 6520         # as the 
-0000b1c0: 7265 7375 6c74 2069 7320 7379 7374 656d  result is system
-0000b1d0: 2d64 6570 656e 6465 6e74 0a20 2020 2020  -dependent.     
-0000b1e0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000b1f0: 7565 2873 656c 662e 7061 7468 2e65 7870  ue(self.path.exp
-0000b200: 616e 6475 7365 7228 227e 2229 290a 0a20  anduser("~")).. 
-0000b210: 2020 2040 756e 6974 7465 7374 2e73 6b69     @unittest.ski
-0000b220: 7049 6628 0a20 2020 2020 2020 2054 6573  pIf(.        Tes
-0000b230: 7443 6173 652e 6973 5f77 696e 646f 7773  tCase.is_windows
-0000b240: 206f 7220 5465 7374 4361 7365 2e69 735f   or TestCase.is_
-0000b250: 6379 6777 696e 2c0a 2020 2020 2020 2020  cygwin,.        
-0000b260: 226f 6e6c 7920 7465 7374 6564 206f 6e20  "only tested on 
-0000b270: 756e 6978 2073 7973 7465 6d73 222c 0a20  unix systems",. 
-0000b280: 2020 2029 0a20 2020 2064 6566 2074 6573     ).    def tes
-0000b290: 745f 6578 7061 6e64 5f72 6f6f 7428 7365  t_expand_root(se
-0000b2a0: 6c66 293a 0a20 2020 2020 2020 2069 6620  lf):.        if 
-0000b2b0: 7379 732e 706c 6174 666f 726d 203d 3d20  sys.platform == 
-0000b2c0: 2264 6172 7769 6e22 3a0a 2020 2020 2020  "darwin":.      
-0000b2d0: 2020 2020 2020 726f 6f74 686f 6d65 203d        roothome =
-0000b2e0: 2022 2176 6172 2172 6f6f 7422 0a20 2020   "!var!root".   
-0000b2f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000b300: 2020 2020 2020 2072 6f6f 7468 6f6d 6520         roothome 
-0000b310: 3d20 2221 726f 6f74 220a 2020 2020 2020  = "!root".      
-0000b320: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000b330: 616c 2873 656c 662e 7061 7468 2e65 7870  al(self.path.exp
-0000b340: 616e 6475 7365 7228 227e 726f 6f74 2229  anduser("~root")
-0000b350: 2c20 726f 6f74 686f 6d65 290a 0a20 2020  , roothome)..   
-0000b360: 2064 6566 2074 6573 745f 6765 7473 697a   def test_getsiz
-0000b370: 655f 7061 7468 5f6e 6f6e 6578 6973 7465  e_path_nonexiste
-0000b380: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
-0000b390: 2020 6669 6c65 5f70 6174 6820 3d20 2266    file_path = "f
-0000b3a0: 6f6f 2162 6172 2162 617a 220a 2020 2020  oo!bar!baz".    
-0000b3b0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000b3c0: 7365 7274 5261 6973 6573 286f 732e 6572  sertRaises(os.er
-0000b3d0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000b3e0: 2020 7365 6c66 2e70 6174 682e 6765 7473    self.path.gets
-0000b3f0: 697a 6528 6669 6c65 5f70 6174 6829 0a0a  ize(file_path)..
-0000b400: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0000b410: 7369 7a65 5f66 696c 655f 656d 7074 7928  size_file_empty(
-0000b420: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0000b430: 696c 655f 7061 7468 203d 2022 666f 6f21  ile_path = "foo!
-0000b440: 6261 7221 6261 7a22 0a20 2020 2020 2020  bar!baz".       
-0000b450: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000b460: 2e63 7265 6174 655f 6669 6c65 2866 696c  .create_file(fil
-0000b470: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
-0000b480: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000b490: 2830 2c20 7365 6c66 2e70 6174 682e 6765  (0, self.path.ge
-0000b4a0: 7473 697a 6528 6669 6c65 5f70 6174 6829  tsize(file_path)
-0000b4b0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000b4c0: 6765 7473 697a 655f 6669 6c65 5f6e 6f6e  getsize_file_non
-0000b4d0: 5f7a 6572 6f5f 7369 7a65 2873 656c 6629  _zero_size(self)
-0000b4e0: 3a0a 2020 2020 2020 2020 6669 6c65 5f70  :.        file_p
-0000b4f0: 6174 6820 3d20 2266 6f6f 2162 6172 2162  ath = "foo!bar!b
-0000b500: 617a 220a 2020 2020 2020 2020 6669 6c65  az".        file
-0000b510: 5f70 6174 685f 6279 7465 7320 3d20 6222  _path_bytes = b"
-0000b520: 666f 6f21 6261 7221 6261 7a22 0a20 2020  foo!bar!baz".   
-0000b530: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-0000b540: 7374 656d 2e63 7265 6174 655f 6669 6c65  stem.create_file
-0000b550: 2866 696c 655f 7061 7468 2c20 636f 6e74  (file_path, cont
-0000b560: 656e 7473 3d22 3132 3334 3536 3722 290a  ents="1234567").
-0000b570: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000b580: 6572 7445 7175 616c 2837 2c20 7365 6c66  ertEqual(7, self
-0000b590: 2e70 6174 682e 6765 7473 697a 6528 6669  .path.getsize(fi
-0000b5a0: 6c65 5f70 6174 6829 290a 2020 2020 2020  le_path)).      
-0000b5b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000b5c0: 616c 2837 2c20 7365 6c66 2e70 6174 682e  al(7, self.path.
-0000b5d0: 6765 7473 697a 6528 6669 6c65 5f70 6174  getsize(file_pat
-0000b5e0: 685f 6279 7465 7329 290a 0a20 2020 2064  h_bytes))..    d
-0000b5f0: 6566 2074 6573 745f 6765 7473 697a 655f  ef test_getsize_
-0000b600: 6469 725f 656d 7074 7928 7365 6c66 293a  dir_empty(self):
-0000b610: 0a20 2020 2020 2020 2023 2046 6f72 2064  .        # For d
-0000b620: 6972 6563 746f 7269 6573 2c20 6f6e 6c79  irectories, only
-0000b630: 2072 6571 7569 7265 2074 6861 7420 7468   require that th
-0000b640: 6520 7369 7a65 2069 7320 6e6f 6e2d 6e65  e size is non-ne
-0000b650: 6761 7469 7665 2e0a 2020 2020 2020 2020  gative..        
-0000b660: 6469 725f 7061 7468 203d 2022 666f 6f21  dir_path = "foo!
-0000b670: 6261 7222 0a20 2020 2020 2020 2073 656c  bar".        sel
-0000b680: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
-0000b690: 6174 655f 6469 7228 6469 725f 7061 7468  ate_dir(dir_path
-0000b6a0: 290a 2020 2020 2020 2020 7369 7a65 203d  ).        size =
-0000b6b0: 2073 656c 662e 7061 7468 2e67 6574 7369   self.path.getsi
-0000b6c0: 7a65 2864 6972 5f70 6174 6829 0a20 2020  ze(dir_path).   
-0000b6d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000b6e0: 4661 6c73 6528 696e 7428 7369 7a65 2920  False(int(size) 
-0000b6f0: 3c20 302c 2022 6578 7065 6374 6564 206e  < 0, "expected n
-0000b700: 6f6e 2d6e 6567 6174 6976 6520 7369 7a65  on-negative size
-0000b710: 3b20 6163 7475 616c 3a20 2573 2220 2520  ; actual: %s" % 
-0000b720: 7369 7a65 290a 0a20 2020 2064 6566 2074  size)..    def t
-0000b730: 6573 745f 6765 7473 697a 655f 6469 725f  est_getsize_dir_
-0000b740: 6e6f 6e5f 7a65 726f 5f73 697a 6528 7365  non_zero_size(se
-0000b750: 6c66 293a 0a20 2020 2020 2020 2023 2046  lf):.        # F
-0000b760: 6f72 2064 6972 6563 746f 7269 6573 2c20  or directories, 
-0000b770: 6f6e 6c79 2072 6571 7569 7265 2074 6861  only require tha
-0000b780: 7420 7468 6520 7369 7a65 2069 7320 6e6f  t the size is no
-0000b790: 6e2d 6e65 6761 7469 7665 2e0a 2020 2020  n-negative..    
-0000b7a0: 2020 2020 6469 725f 7061 7468 203d 2022      dir_path = "
-0000b7b0: 666f 6f21 6261 7222 0a20 2020 2020 2020  foo!bar".       
-0000b7c0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000b7d0: 2e63 7265 6174 655f 6669 6c65 2873 656c  .create_file(sel
-0000b7e0: 662e 6669 6c65 7379 7374 656d 2e6a 6f69  f.filesystem.joi
-0000b7f0: 6e70 6174 6873 2864 6972 5f70 6174 682c  npaths(dir_path,
-0000b800: 2022 6261 7a22 2929 0a20 2020 2020 2020   "baz")).       
-0000b810: 2073 697a 6520 3d20 7365 6c66 2e70 6174   size = self.pat
-0000b820: 682e 6765 7473 697a 6528 6469 725f 7061  h.getsize(dir_pa
-0000b830: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
-0000b840: 2e61 7373 6572 7446 616c 7365 2869 6e74  .assertFalse(int
-0000b850: 2873 697a 6529 203c 2030 2c20 2265 7870  (size) < 0, "exp
-0000b860: 6563 7465 6420 6e6f 6e2d 6e65 6761 7469  ected non-negati
-0000b870: 7665 2073 697a 653b 2061 6374 7561 6c3a  ve size; actual:
-0000b880: 2025 7322 2025 2073 697a 6529 0a0a 2020   %s" % size)..  
-0000b890: 2020 6465 6620 7465 7374 5f69 7364 6972    def test_isdir
-0000b8a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000b8b0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000b8c0: 6372 6561 7465 5f66 696c 6528 2266 6f6f  create_file("foo
-0000b8d0: 2162 6172 2229 0a20 2020 2020 2020 2073  !bar").        s
-0000b8e0: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-0000b8f0: 656c 662e 7061 7468 2e69 7364 6972 2822  elf.path.isdir("
-0000b900: 666f 6f22 2929 0a20 2020 2020 2020 2073  foo")).        s
-0000b910: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-0000b920: 656c 662e 7061 7468 2e69 7364 6972 2862  elf.path.isdir(b
-0000b930: 2266 6f6f 2229 290a 2020 2020 2020 2020  "foo")).        
-0000b940: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
-0000b950: 2873 656c 662e 7061 7468 2e69 7364 6972  (self.path.isdir
-0000b960: 2822 666f 6f21 6261 7222 2929 0a20 2020  ("foo!bar")).   
-0000b970: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000b980: 4661 6c73 6528 7365 6c66 2e70 6174 682e  False(self.path.
-0000b990: 6973 6469 7228 2269 745f 646f 6e74 5f65  isdir("it_dont_e
-0000b9a0: 7869 7374 2229 290a 0a20 2020 2064 6566  xist"))..    def
-0000b9b0: 2074 6573 745f 6973 6469 725f 7769 7468   test_isdir_with
-0000b9c0: 5f63 7764 5f63 6861 6e67 6528 7365 6c66  _cwd_change(self
-0000b9d0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000b9e0: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
-0000b9f0: 655f 6669 6c65 2822 2166 6f6f 2162 6172  e_file("!foo!bar
-0000ba00: 2162 617a 2229 0a20 2020 2020 2020 2073  !baz").        s
-0000ba10: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-0000ba20: 656c 662e 7061 7468 2e69 7364 6972 2822  elf.path.isdir("
-0000ba30: 2166 6f6f 2229 290a 2020 2020 2020 2020  !foo")).        
-0000ba40: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000ba50: 7365 6c66 2e70 6174 682e 6973 6469 7228  self.path.isdir(
-0000ba60: 2221 666f 6f21 6261 7222 2929 0a20 2020  "!foo!bar")).   
-0000ba70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000ba80: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
-0000ba90: 7364 6972 2822 666f 6f22 2929 0a20 2020  sdir("foo")).   
-0000baa0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000bab0: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
-0000bac0: 7364 6972 2822 666f 6f21 6261 7222 2929  sdir("foo!bar"))
-0000bad0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-0000bae0: 6c65 7379 7374 656d 2e63 7764 203d 2066  lesystem.cwd = f
-0000baf0: 227b 7365 6c66 2e66 696c 6573 7973 7465  "{self.filesyste
-0000bb00: 6d2e 726f 6f74 5f64 6972 5f6e 616d 657d  m.root_dir_name}
-0000bb10: 666f 6f22 0a20 2020 2020 2020 2073 656c  foo".        sel
-0000bb20: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-0000bb30: 662e 7061 7468 2e69 7364 6972 2822 2166  f.path.isdir("!f
-0000bb40: 6f6f 2229 290a 2020 2020 2020 2020 7365  oo")).        se
-0000bb50: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-0000bb60: 6c66 2e70 6174 682e 6973 6469 7228 2221  lf.path.isdir("!
-0000bb70: 666f 6f21 6261 7222 2929 0a20 2020 2020  foo!bar")).     
-0000bb80: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000bb90: 7565 2873 656c 662e 7061 7468 2e69 7364  ue(self.path.isd
-0000bba0: 6972 2822 6261 7222 2929 0a0a 2020 2020  ir("bar"))..    
-0000bbb0: 6465 6620 7465 7374 5f69 7366 696c 6528  def test_isfile(
-0000bbc0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000bbd0: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-0000bbe0: 7265 6174 655f 6669 6c65 2822 666f 6f21  reate_file("foo!
-0000bbf0: 6261 7222 290a 2020 2020 2020 2020 7365  bar").        se
-0000bc00: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
-0000bc10: 656c 662e 7061 7468 2e69 7366 696c 6528  elf.path.isfile(
-0000bc20: 2266 6f6f 2229 290a 2020 2020 2020 2020  "foo")).        
-0000bc30: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000bc40: 7365 6c66 2e70 6174 682e 6973 6669 6c65  self.path.isfile
-0000bc50: 2822 666f 6f21 6261 7222 2929 0a20 2020  ("foo!bar")).   
-0000bc60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000bc70: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
-0000bc80: 7366 696c 6528 6222 666f 6f21 6261 7222  sfile(b"foo!bar"
-0000bc90: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000bca0: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
-0000bcb0: 2e70 6174 682e 6973 6669 6c65 2822 6974  .path.isfile("it
-0000bcc0: 5f64 6f6e 745f 6578 6973 7422 2929 0a0a  _dont_exist"))..
-0000bcd0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0000bce0: 5f6d 7469 6d65 2873 656c 6629 3a0a 2020  _mtime(self):.  
-0000bcf0: 2020 2020 2020 7465 7374 5f66 696c 6520        test_file 
-0000bd00: 3d20 7365 6c66 2e66 696c 6573 7973 7465  = self.filesyste
-0000bd10: 6d2e 6372 6561 7465 5f66 696c 6528 2266  m.create_file("f
-0000bd20: 6f6f 2162 6172 312e 7478 7422 290a 2020  oo!bar1.txt").  
-0000bd30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bd40: 744e 6f74 4571 7561 6c28 3234 2c20 7365  tNotEqual(24, se
-0000bd50: 6c66 2e70 6174 682e 6765 746d 7469 6d65  lf.path.getmtime
-0000bd60: 2822 666f 6f21 6261 7231 2e74 7874 2229  ("foo!bar1.txt")
-0000bd70: 290a 2020 2020 2020 2020 7465 7374 5f66  ).        test_f
-0000bd80: 696c 652e 7374 5f6d 7469 6d65 203d 2032  ile.st_mtime = 2
-0000bd90: 340a 2020 2020 2020 2020 7365 6c66 2e61  4.        self.a
-0000bda0: 7373 6572 7445 7175 616c 2832 342c 2073  ssertEqual(24, s
-0000bdb0: 656c 662e 7061 7468 2e67 6574 6d74 696d  elf.path.getmtim
-0000bdc0: 6528 2266 6f6f 2162 6172 312e 7478 7422  e("foo!bar1.txt"
-0000bdd0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000bde0: 6173 7365 7274 4571 7561 6c28 3234 2c20  assertEqual(24, 
-0000bdf0: 7365 6c66 2e70 6174 682e 6765 746d 7469  self.path.getmti
-0000be00: 6d65 2862 2266 6f6f 2162 6172 312e 7478  me(b"foo!bar1.tx
-0000be10: 7422 2929 0a0a 2020 2020 6465 6620 7465  t"))..    def te
-0000be20: 7374 5f67 6574 5f6d 7469 6d65 5f72 6169  st_get_mtime_rai
-0000be30: 7365 735f 6f73 5f65 7272 6f72 2873 656c  ses_os_error(sel
-0000be40: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000be50: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
-0000be60: 662e 7061 7468 2e65 7869 7374 7328 2264  f.path.exists("d
-0000be70: 6f65 735f 6e6f 745f 6578 6973 7422 2929  oes_not_exist"))
-0000be80: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0000be90: 6c66 2e72 6169 7365 735f 6f73 5f65 7272  lf.raises_os_err
-0000bea0: 6f72 2865 7272 6e6f 2e45 4e4f 454e 5429  or(errno.ENOENT)
-0000beb0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000bec0: 6c66 2e70 6174 682e 6765 746d 7469 6d65  lf.path.getmtime
-0000bed0: 2822 646f 6573 5f6e 6f74 5f65 7869 7374  ("does_not_exist
-0000bee0: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
-0000bef0: 5f69 736c 696e 6b28 7365 6c66 293a 0a20  _islink(self):. 
-0000bf00: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-0000bf10: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
-0000bf20: 7228 2266 6f6f 2229 0a20 2020 2020 2020  r("foo").       
-0000bf30: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000bf40: 2e63 7265 6174 655f 6669 6c65 2822 666f  .create_file("fo
-0000bf50: 6f21 7265 6775 6c61 725f 6669 6c65 2229  o!regular_file")
-0000bf60: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-0000bf70: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-0000bf80: 7379 6d6c 696e 6b28 2266 6f6f 216c 696e  symlink("foo!lin
-0000bf90: 6b5f 746f 5f66 696c 6522 2c20 2272 6567  k_to_file", "reg
-0000bfa0: 756c 6172 5f66 696c 6522 290a 2020 2020  ular_file").    
-0000bfb0: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
-0000bfc0: 616c 7365 2873 656c 662e 7061 7468 2e69  alse(self.path.i
-0000bfd0: 736c 696e 6b28 2266 6f6f 2229 290a 0a20  slink("foo")).. 
-0000bfe0: 2020 2020 2020 2023 2041 6e20 6f62 6a65         # An obje
-0000bff0: 6374 2063 616e 2062 6520 626f 7468 2061  ct can be both a
-0000c000: 206c 696e 6b20 616e 6420 6120 6669 6c65   link and a file
-0000c010: 206f 7220 6669 6c65 2c20 6163 636f 7264   or file, accord
-0000c020: 696e 6720 746f 2074 6865 0a20 2020 2020  ing to the.     
-0000c030: 2020 2023 2063 6f6d 6d65 6e74 7320 696e     # comments in
-0000c040: 2050 7974 686f 6e2f 4c69 622f 706f 7369   Python/Lib/posi
-0000c050: 7870 6174 682e 7079 2e0a 2020 2020 2020  xpath.py..      
-0000c060: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000c070: 6528 7365 6c66 2e70 6174 682e 6973 6c69  e(self.path.isli
-0000c080: 6e6b 2822 666f 6f21 6c69 6e6b 5f74 6f5f  nk("foo!link_to_
-0000c090: 6669 6c65 2229 290a 2020 2020 2020 2020  file")).        
-0000c0a0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000c0b0: 7365 6c66 2e70 6174 682e 6973 6669 6c65  self.path.isfile
-0000c0c0: 2822 666f 6f21 6c69 6e6b 5f74 6f5f 6669  ("foo!link_to_fi
-0000c0d0: 6c65 2229 290a 2020 2020 2020 2020 7365  le")).        se
-0000c0e0: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-0000c0f0: 6c66 2e70 6174 682e 6973 6c69 6e6b 2862  lf.path.islink(b
-0000c100: 2266 6f6f 216c 696e 6b5f 746f 5f66 696c  "foo!link_to_fil
-0000c110: 6522 2929 0a20 2020 2020 2020 2073 656c  e")).        sel
-0000c120: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-0000c130: 662e 7061 7468 2e69 7366 696c 6528 6222  f.path.isfile(b"
-0000c140: 666f 6f21 6c69 6e6b 5f74 6f5f 6669 6c65  foo!link_to_file
-0000c150: 2229 290a 0a20 2020 2020 2020 2073 656c  "))..        sel
-0000c160: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-0000c170: 662e 7061 7468 2e69 7366 696c 6528 2266  f.path.isfile("f
-0000c180: 6f6f 2172 6567 756c 6172 5f66 696c 6522  oo!regular_file"
-0000c190: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000c1a0: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
-0000c1b0: 2e70 6174 682e 6973 6c69 6e6b 2822 666f  .path.islink("fo
-0000c1c0: 6f21 7265 6775 6c61 725f 6669 6c65 2229  o!regular_file")
-0000c1d0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000c1e0: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
-0000c1f0: 2e70 6174 682e 6973 6c69 6e6b 2822 6974  .path.islink("it
-0000c200: 5f64 6f6e 745f 6578 6973 7422 2929 0a0a  _dont_exist"))..
-0000c210: 2020 2020 6465 6620 7465 7374 5f69 735f      def test_is_
-0000c220: 6c69 6e6b 5f63 6173 655f 7365 6e73 6974  link_case_sensit
-0000c230: 6976 6528 7365 6c66 293a 0a20 2020 2020  ive(self):.     
-0000c240: 2020 2023 2052 6567 7265 7373 696f 6e20     # Regression 
-0000c250: 7465 7374 2066 6f72 2023 3330 360a 2020  test for #306.  
-0000c260: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-0000c270: 7973 7465 6d2e 6973 5f63 6173 655f 7365  ystem.is_case_se
-0000c280: 6e73 6974 6976 6520 3d20 4661 6c73 650a  nsitive = False.
-0000c290: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-0000c2a0: 6573 7973 7465 6d2e 6372 6561 7465 5f64  esystem.create_d
-0000c2b0: 6972 2822 666f 6f22 290a 2020 2020 2020  ir("foo").      
-0000c2c0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-0000c2d0: 6d2e 6372 6561 7465 5f73 796d 6c69 6e6b  m.create_symlink
-0000c2e0: 2822 666f 6f21 6261 7222 2c20 2266 6f6f  ("foo!bar", "foo
-0000c2f0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0000c300: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
-0000c310: 7061 7468 2e69 736c 696e 6b28 2266 6f6f  path.islink("foo
-0000c320: 2142 6172 2229 290a 0a20 2020 2064 6566  !Bar"))..    def
-0000c330: 2074 6573 745f 6973 6d6f 756e 7428 7365   test_ismount(se
-0000c340: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000c350: 662e 6173 7365 7274 4661 6c73 6528 7365  f.assertFalse(se
-0000c360: 6c66 2e70 6174 682e 6973 6d6f 756e 7428  lf.path.ismount(
-0000c370: 2222 2929 0a20 2020 2020 2020 2073 656c  "")).        sel
-0000c380: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-0000c390: 662e 7061 7468 2e69 736d 6f75 6e74 2822  f.path.ismount("
-0000c3a0: 2122 2929 0a20 2020 2020 2020 2073 656c  !")).        sel
-0000c3b0: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-0000c3c0: 662e 7061 7468 2e69 736d 6f75 6e74 2862  f.path.ismount(b
-0000c3d0: 2221 2229 290a 2020 2020 2020 2020 7365  "!")).        se
-0000c3e0: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
-0000c3f0: 656c 662e 7061 7468 2e69 736d 6f75 6e74  elf.path.ismount
-0000c400: 2822 216d 6f75 6e74 2122 2929 0a20 2020  ("!mount!")).   
-0000c410: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-0000c420: 7374 656d 2e61 6464 5f6d 6f75 6e74 5f70  stem.add_mount_p
-0000c430: 6f69 6e74 2822 216d 6f75 6e74 2229 0a20  oint("!mount"). 
-0000c440: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000c450: 7274 5472 7565 2873 656c 662e 7061 7468  rtTrue(self.path
-0000c460: 2e69 736d 6f75 6e74 2822 216d 6f75 6e74  .ismount("!mount
-0000c470: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-0000c480: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
-0000c490: 2e70 6174 682e 6973 6d6f 756e 7428 6222  .path.ismount(b"
-0000c4a0: 216d 6f75 6e74 2229 290a 2020 2020 2020  !mount")).      
-0000c4b0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000c4c0: 6528 7365 6c66 2e70 6174 682e 6973 6d6f  e(self.path.ismo
-0000c4d0: 756e 7428 2221 6d6f 756e 7421 2229 290a  unt("!mount!")).
-0000c4e0: 0a20 2020 2064 6566 2074 6573 745f 6973  .    def test_is
-0000c4f0: 6d6f 756e 745f 7769 7468 5f64 7269 7665  mount_with_drive
-0000c500: 5f6c 6574 7465 7273 2873 656c 6629 3a0a  _letters(self):.
-0000c510: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-0000c520: 6573 7973 7465 6d2e 6973 5f77 696e 646f  esystem.is_windo
-0000c530: 7773 5f66 7320 3d20 5472 7565 0a20 2020  ws_fs = True.   
-0000c540: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000c550: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
-0000c560: 736d 6f75 6e74 2822 2122 2929 0a20 2020  smount("!")).   
-0000c570: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000c580: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
-0000c590: 736d 6f75 6e74 2822 633a 2122 2929 0a20  smount("c:!")). 
-0000c5a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000c5b0: 7274 4661 6c73 6528 7365 6c66 2e70 6174  rtFalse(self.pat
-0000c5c0: 682e 6973 6d6f 756e 7428 2263 3a22 2929  h.ismount("c:"))
-0000c5d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000c5e0: 7365 7274 5472 7565 2873 656c 662e 7061  sertTrue(self.pa
-0000c5f0: 7468 2e69 736d 6f75 6e74 2822 7a3a 2122  th.ismount("z:!"
-0000c600: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000c610: 6669 6c65 7379 7374 656d 2e61 6464 5f6d  filesystem.add_m
-0000c620: 6f75 6e74 5f70 6f69 6e74 2822 216d 6f75  ount_point("!mou
-0000c630: 6e74 2229 0a20 2020 2020 2020 2073 656c  nt").        sel
-0000c640: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
-0000c650: 662e 7061 7468 2e69 736d 6f75 6e74 2822  f.path.ismount("
-0000c660: 216d 6f75 6e74 2229 290a 2020 2020 2020  !mount")).      
-0000c670: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000c680: 6528 7365 6c66 2e70 6174 682e 6973 6d6f  e(self.path.ismo
-0000c690: 756e 7428 2221 6d6f 756e 7421 2229 290a  unt("!mount!")).
-0000c6a0: 0a20 2020 2064 6566 2074 6573 745f 6973  .    def test_is
-0000c6b0: 6d6f 756e 745f 7769 7468 5f75 6e63 5f70  mount_with_unc_p
-0000c6c0: 6174 6873 2873 656c 6629 3a0a 2020 2020  aths(self):.    
-0000c6d0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-0000c6e0: 7465 6d2e 6973 5f77 696e 646f 7773 5f66  tem.is_windows_f
-0000c6f0: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
-0000c700: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0000c710: 2873 656c 662e 7061 7468 2e69 736d 6f75  (self.path.ismou
-0000c720: 6e74 2822 2121 6121 2229 290a 2020 2020  nt("!!a!")).    
-0000c730: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000c740: 7275 6528 7365 6c66 2e70 6174 682e 6973  rue(self.path.is
-0000c750: 6d6f 756e 7428 2221 2161 2162 2229 290a  mount("!!a!b")).
-0000c760: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000c770: 6572 7454 7275 6528 7365 6c66 2e70 6174  ertTrue(self.pat
-0000c780: 682e 6973 6d6f 756e 7428 2221 2161 2162  h.ismount("!!a!b
-0000c790: 2122 2929 0a20 2020 2020 2020 2073 656c  !")).        sel
-0000c7a0: 662e 6173 7365 7274 4661 6c73 6528 7365  f.assertFalse(se
-0000c7b0: 6c66 2e70 6174 682e 6973 6d6f 756e 7428  lf.path.ismount(
-0000c7c0: 2221 6121 6221 2229 290a 2020 2020 2020  "!a!b!")).      
-0000c7d0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-0000c7e0: 7365 2873 656c 662e 7061 7468 2e69 736d  se(self.path.ism
-0000c7f0: 6f75 6e74 2822 2121 6121 6221 6322 2929  ount("!!a!b!c"))
-0000c800: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
-0000c810: 736d 6f75 6e74 5f77 6974 685f 616c 7465  smount_with_alte
-0000c820: 726e 6174 655f 7061 7468 5f73 6570 6172  rnate_path_separ
-0000c830: 6174 6f72 2873 656c 6629 3a0a 2020 2020  ator(self):.    
-0000c840: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-0000c850: 7465 6d2e 616c 7465 726e 6174 6976 655f  tem.alternative_
-0000c860: 7061 7468 5f73 6570 6172 6174 6f72 203d  path_separator =
-0000c870: 2022 2122 0a20 2020 2020 2020 2073 656c   "!".        sel
-0000c880: 662e 6669 6c65 7379 7374 656d 2e61 6464  f.filesystem.add
-0000c890: 5f6d 6f75 6e74 5f70 6f69 6e74 2822 216d  _mount_point("!m
-0000c8a0: 6f75 6e74 2229 0a20 2020 2020 2020 2073  ount").        s
-0000c8b0: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-0000c8c0: 656c 662e 7061 7468 2e69 736d 6f75 6e74  elf.path.ismount
-0000c8d0: 2822 216d 6f75 6e74 2229 290a 2020 2020  ("!mount")).    
-0000c8e0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000c8f0: 7275 6528 7365 6c66 2e70 6174 682e 6973  rue(self.path.is
-0000c900: 6d6f 756e 7428 2221 6d6f 756e 7421 2229  mount("!mount!")
-0000c910: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c920: 7373 6572 7454 7275 6528 7365 6c66 2e70  ssertTrue(self.p
-0000c930: 6174 682e 6973 6d6f 756e 7428 2221 6d6f  ath.ismount("!mo
-0000c940: 756e 7421 2122 2929 0a20 2020 2020 2020  unt!!")).       
-0000c950: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000c960: 2e69 735f 7769 6e64 6f77 735f 6673 203d  .is_windows_fs =
-0000c970: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
-0000c980: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-0000c990: 6c66 2e70 6174 682e 6973 6d6f 756e 7428  lf.path.ismount(
-0000c9a0: 225a 3a21 2229 290a 0a20 2020 2064 6566  "Z:!"))..    def
-0000c9b0: 2074 6573 745f 6765 7461 7474 725f 666f   test_getattr_fo
-0000c9c0: 7277 6172 645f 746f 5f72 6561 6c5f 6f73  rward_to_real_os
-0000c9d0: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
-0000c9e0: 2020 2020 2022 2222 466f 7277 6172 6473       """Forwards
-0000c9f0: 2061 6e79 206e 6f6e 2d66 616b 6564 2063   any non-faked c
-0000ca00: 616c 6c73 2074 6f20 6f73 2e70 6174 682e  alls to os.path.
-0000ca10: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-0000ca20: 2e61 7373 6572 7454 7275 6528 6861 7361  .assertTrue(hasa
-0000ca30: 7474 7228 7365 6c66 2e70 6174 682c 2022  ttr(self.path, "
-0000ca40: 7365 7022 292c 2022 4765 7420 6120 6661  sep"), "Get a fa
-0000ca50: 6b65 6420 6f73 2e70 6174 6820 6675 6e63  ked os.path func
-0000ca60: 7469 6f6e 2229 0a20 2020 2020 2020 2070  tion").        p
-0000ca70: 7269 7661 7465 5f70 6174 685f 6675 6e63  rivate_path_func
-0000ca80: 7469 6f6e 203d 204e 6f6e 650a 2020 2020  tion = None.    
-0000ca90: 2020 2020 6966 2073 7973 2e76 6572 7369      if sys.versi
-0000caa0: 6f6e 5f69 6e66 6f20 3c20 2833 2c20 3629  on_info < (3, 6)
-0000cab0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000cac0: 2073 656c 662e 6973 5f77 696e 646f 7773   self.is_windows
-0000cad0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cae0: 2020 7072 6976 6174 655f 7061 7468 5f66    private_path_f
-0000caf0: 756e 6374 696f 6e20 3d20 225f 6765 745f  unction = "_get_
-0000cb00: 626f 7468 7365 7073 220a 2020 2020 2020  bothseps".      
-0000cb10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000cb20: 2020 2020 2020 2020 2020 2020 7072 6976              priv
-0000cb30: 6174 655f 7061 7468 5f66 756e 6374 696f  ate_path_functio
-0000cb40: 6e20 3d20 225f 6a6f 696e 5f72 6561 6c5f  n = "_join_real_
-0000cb50: 7061 7468 220a 2020 2020 2020 2020 6966  path".        if
-0000cb60: 2070 7269 7661 7465 5f70 6174 685f 6675   private_path_fu
-0000cb70: 6e63 7469 6f6e 3a0a 2020 2020 2020 2020  nction:.        
-0000cb80: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000cb90: 7275 6528 0a20 2020 2020 2020 2020 2020  rue(.           
-0000cba0: 2020 2020 2068 6173 6174 7472 2873 656c       hasattr(sel
-0000cbb0: 662e 7061 7468 2c20 7072 6976 6174 655f  f.path, private_
-0000cbc0: 7061 7468 5f66 756e 6374 696f 6e29 2c0a  path_function),.
-0000cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbe0: 2247 6574 2061 2072 6561 6c20 6f73 2e70  "Get a real os.p
-0000cbf0: 6174 6820 6675 6e63 7469 6f6e 2022 2022  ath function " "
-0000cc00: 6e6f 7420 696d 706c 656d 656e 7465 6420  not implemented 
-0000cc10: 696e 2066 616b 6520 6f73 2e70 6174 6822  in fake os.path"
-0000cc20: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000cc30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000cc40: 6572 7446 616c 7365 2868 6173 6174 7472  ertFalse(hasattr
-0000cc50: 2873 656c 662e 7061 7468 2c20 226e 6f6e  (self.path, "non
-0000cc60: 6578 6973 7465 6e74 2229 290a 0a20 2020  existent"))..   
-0000cc70: 2064 6566 2074 6573 745f 7370 6c69 7472   def test_splitr
-0000cc80: 6f6f 745f 706f 7369 7828 7365 6c66 293a  oot_posix(self):
-0000cc90: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-0000cca0: 6c65 7379 7374 656d 2e69 735f 7769 6e64  lesystem.is_wind
-0000ccb0: 6f77 735f 6673 203d 2046 616c 7365 0a20  ows_fs = False. 
-0000ccc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ccd0: 7274 4571 7561 6c28 2822 222c 2022 222c  rtEqual(("", "",
-0000cce0: 2022 666f 6f21 6261 7222 292c 2073 656c   "foo!bar"), sel
-0000ccf0: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-0000cd00: 6974 726f 6f74 2822 666f 6f21 6261 7222  itroot("foo!bar"
-0000cd10: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000cd20: 6173 7365 7274 4571 7561 6c28 2822 222c  assertEqual(("",
-0000cd30: 2022 2122 2c20 2266 6f6f 2162 6172 2229   "!", "foo!bar")
-0000cd40: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
-0000cd50: 6d2e 7370 6c69 7472 6f6f 7428 2221 666f  m.splitroot("!fo
-0000cd60: 6f21 6261 7222 2929 0a20 2020 2020 2020  o!bar")).       
-0000cd70: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000cd80: 6c28 0a20 2020 2020 2020 2020 2020 2028  l(.            (
-0000cd90: 2222 2c20 2221 2122 2c20 2266 6f6f 2121  "", "!!", "foo!!
-0000cda0: 6261 7222 292c 2073 656c 662e 6669 6c65  bar"), self.file
-0000cdb0: 7379 7374 656d 2e73 706c 6974 726f 6f74  system.splitroot
-0000cdc0: 2822 2121 666f 6f21 2162 6172 2229 0a20  ("!!foo!!bar"). 
-0000cdd0: 2020 2020 2020 2029 0a0a 0a63 6c61 7373         )...class
-0000cde0: 2050 6174 684d 616e 6970 756c 6174 696f   PathManipulatio
-0000cdf0: 6e54 6573 7442 6173 6528 5465 7374 4361  nTestBase(TestCa
-0000ce00: 7365 293a 0a20 2020 2064 6566 2073 6574  se):.    def set
-0000ce10: 5570 2873 656c 6629 3a0a 2020 2020 2020  Up(self):.      
-0000ce20: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-0000ce30: 6d20 3d20 6661 6b65 5f66 696c 6573 7973  m = fake_filesys
-0000ce40: 7465 6d2e 4661 6b65 4669 6c65 7379 7374  tem.FakeFilesyst
-0000ce50: 656d 2870 6174 685f 7365 7061 7261 746f  em(path_separato
-0000ce60: 723d 227c 2229 0a0a 0a63 6c61 7373 2043  r="|")...class C
-0000ce70: 6f6c 6c61 7073 6550 6174 6850 6970 6553  ollapsePathPipeS
-0000ce80: 6570 6172 6174 6f72 5465 7374 2850 6174  eparatorTest(Pat
-0000ce90: 684d 616e 6970 756c 6174 696f 6e54 6573  hManipulationTes
-0000cea0: 7442 6173 6529 3a0a 2020 2020 2222 2254  tBase):.    """T
-0000ceb0: 6573 7473 2043 6f6c 6c61 7073 6550 6174  ests CollapsePat
-0000cec0: 6820 286d 696d 6963 7320 6f73 2e70 6174  h (mimics os.pat
-0000ced0: 682e 6e6f 726d 7061 7468 2920 7573 696e  h.normpath) usin
-0000cee0: 6720 7c0a 2020 2020 6173 2070 6174 6820  g |.    as path 
-0000cef0: 7365 7061 7261 746f 722e 2222 220a 0a20  separator.""".. 
-0000cf00: 2020 2064 6566 2074 6573 745f 656d 7074     def test_empt
-0000cf10: 795f 7061 7468 5f62 6563 6f6d 6573 5f64  y_path_becomes_d
-0000cf20: 6f74 5f70 6174 6828 7365 6c66 293a 0a20  ot_path(self):. 
-0000cf30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000cf40: 7274 4571 7561 6c28 222e 222c 2073 656c  rtEqual(".", sel
-0000cf50: 662e 6669 6c65 7379 7374 656d 2e6e 6f72  f.filesystem.nor
-0000cf60: 6d70 6174 6828 2222 2929 0a0a 2020 2020  mpath(""))..    
-0000cf70: 6465 6620 7465 7374 5f64 6f74 5f70 6174  def test_dot_pat
-0000cf80: 685f 756e 6368 616e 6765 6428 7365 6c66  h_unchanged(self
-0000cf90: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000cfa0: 6173 7365 7274 4571 7561 6c28 222e 222c  assertEqual(".",
-0000cfb0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000cfc0: 2e6e 6f72 6d70 6174 6828 222e 2229 290a  .normpath(".")).
-0000cfd0: 0a20 2020 2064 6566 2074 6573 745f 736c  .    def test_sl
-0000cfe0: 6173 6865 735f 6172 655f 6e6f 745f 636f  ashes_are_not_co
-0000cff0: 6c6c 6170 7365 6428 7365 6c66 293a 0a20  llapsed(self):. 
-0000d000: 2020 2020 2020 2022 2222 5465 7374 7320         """Tests 
-0000d010: 7468 6174 2027 2f27 2069 7320 6e6f 7420  that '/' is not 
-0000d020: 7472 6561 7465 6420 7370 6563 6961 6c6c  treated speciall
-0000d030: 7920 6966 2074 6865 0a20 2020 2020 2020  y if the.       
-0000d040: 2020 2020 2070 6174 6820 7365 7061 7261       path separa
-0000d050: 746f 7220 6973 2027 7c27 2e0a 0a20 2020  tor is '|'...   
-0000d060: 2020 2020 2049 6e20 7061 7274 6963 756c       In particul
-0000d070: 6172 2c20 6d75 6c74 6970 6c65 2073 6c61  ar, multiple sla
-0000d080: 7368 6573 2073 686f 756c 6420 6e6f 7420  shes should not 
-0000d090: 6265 2063 6f6c 6c61 7073 6564 2e0a 2020  be collapsed..  
-0000d0a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000d0b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000d0c0: 616c 2822 2f22 2c20 7365 6c66 2e66 696c  al("/", self.fil
-0000d0d0: 6573 7973 7465 6d2e 6e6f 726d 7061 7468  esystem.normpath
-0000d0e0: 2822 2f22 2929 0a20 2020 2020 2020 2073  ("/")).        s
-0000d0f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000d100: 222f 2f2f 2f2f 222c 2073 656c 662e 6669  "/////", self.fi
-0000d110: 6c65 7379 7374 656d 2e6e 6f72 6d70 6174  lesystem.normpat
-0000d120: 6828 222f 2f2f 2f2f 2229 290a 0a20 2020  h("/////"))..   
-0000d130: 2064 6566 2074 6573 745f 726f 6f74 5f70   def test_root_p
-0000d140: 6174 6828 7365 6c66 293a 0a20 2020 2020  ath(self):.     
-0000d150: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000d160: 7561 6c28 227c 222c 2073 656c 662e 6669  ual("|", self.fi
-0000d170: 6c65 7379 7374 656d 2e6e 6f72 6d70 6174  lesystem.normpat
-0000d180: 6828 227c 2229 290a 0a20 2020 2064 6566  h("|"))..    def
-0000d190: 2074 6573 745f 6d75 6c74 6970 6c65 5f73   test_multiple_s
-0000d1a0: 6570 6172 6174 6f72 735f 636f 6c6c 6170  eparators_collap
-0000d1b0: 7365 645f 696e 746f 5f72 6f6f 745f 7061  sed_into_root_pa
-0000d1c0: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
-0000d1d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000d1e0: 616c 2822 7c22 2c20 7365 6c66 2e66 696c  al("|", self.fil
-0000d1f0: 6573 7973 7465 6d2e 6e6f 726d 7061 7468  esystem.normpath
-0000d200: 2822 7c7c 7c7c 7c22 2929 0a0a 2020 2020  ("|||||"))..    
-0000d210: 6465 6620 7465 7374 5f61 6c6c 5f64 6f74  def test_all_dot
-0000d220: 5f70 6174 6873 5f72 656d 6f76 6564 5f62  _paths_removed_b
-0000d230: 7574 5f6f 6e65 2873 656c 6629 3a0a 2020  ut_one(self):.  
-0000d240: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000d250: 7445 7175 616c 2822 2e22 2c20 7365 6c66  tEqual(".", self
-0000d260: 2e66 696c 6573 7973 7465 6d2e 6e6f 726d  .filesystem.norm
-0000d270: 7061 7468 2822 2e7c 2e7c 2e7c 2e22 2929  path(".|.|.|."))
-0000d280: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-0000d290: 6c6c 5f64 6f74 5f70 6174 6873 5f72 656d  ll_dot_paths_rem
-0000d2a0: 6f76 6564 5f69 665f 616e 6f74 6865 725f  oved_if_another_
-0000d2b0: 7061 7468 5f63 6f6d 706f 6e65 6e74 5f65  path_component_e
-0000d2c0: 7869 7374 7328 7365 6c66 293a 0a20 2020  xists(self):.   
-0000d2d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000d2e0: 4571 7561 6c28 227c 222c 2073 656c 662e  Equal("|", self.
-0000d2f0: 6669 6c65 7379 7374 656d 2e6e 6f72 6d70  filesystem.normp
-0000d300: 6174 6828 227c 2e7c 2e7c 2e7c 2229 290a  ath("|.|.|.|")).
-0000d310: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000d320: 6572 7445 7175 616c 2822 666f 6f7c 6261  ertEqual("foo|ba
-0000d330: 7222 2c20 7365 6c66 2e66 696c 6573 7973  r", self.filesys
-0000d340: 7465 6d2e 6e6f 726d 7061 7468 2822 666f  tem.normpath("fo
-0000d350: 6f7c 2e7c 2e7c 2e7c 6261 7222 2929 0a0a  o|.|.|.|bar"))..
-0000d360: 2020 2020 6465 6620 7465 7374 5f69 676e      def test_ign
-0000d370: 6f72 6573 5f75 705f 6c65 7665 6c5f 7265  ores_up_level_re
-0000d380: 6665 7265 6e63 6573 5f73 7461 7274 696e  ferences_startin
-0000d390: 675f 6672 6f6d 5f72 6f6f 7428 7365 6c66  g_from_root(self
-0000d3a0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000d3b0: 6173 7365 7274 4571 7561 6c28 227c 222c  assertEqual("|",
-0000d3c0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000d3d0: 2e6e 6f72 6d70 6174 6828 227c 2e2e 7c2e  .normpath("|..|.
-0000d3e0: 2e7c 2e2e 7c22 2929 0a20 2020 2020 2020  .|..|")).       
-0000d3f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000d400: 6c28 227c 222c 2073 656c 662e 6669 6c65  l("|", self.file
-0000d410: 7379 7374 656d 2e6e 6f72 6d70 6174 6828  system.normpath(
-0000d420: 227c 2e2e 7c2e 2e7c 666f 6f7c 6261 727c  "|..|..|foo|bar|
-0000d430: 2e2e 7c2e 2e7c 2229 290a 2020 2020 2020  ..|..|")).      
-0000d440: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-0000d450: 6d2e 6973 5f77 696e 646f 7773 5f66 7320  m.is_windows_fs 
-0000d460: 3d20 4661 6c73 6520 2023 206e 6f74 2061  = False  # not a
-0000d470: 6e20 554e 4320 7061 7468 0a20 2020 2020  n UNC path.     
-0000d480: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000d490: 7561 6c28 227c 222c 2073 656c 662e 6669  ual("|", self.fi
-0000d4a0: 6c65 7379 7374 656d 2e6e 6f72 6d70 6174  lesystem.normpat
-0000d4b0: 6828 227c 7c2e 2e7c 2e7c 2e2e 7c7c 2229  h("||..|.|..||")
-0000d4c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000d4d0: 636f 6e73 6572 7665 735f 7570 5f6c 6576  conserves_up_lev
-0000d4e0: 656c 5f72 6566 6572 656e 6365 735f 7374  el_references_st
-0000d4f0: 6172 7469 6e67 5f66 726f 6d5f 6375 7272  arting_from_curr
-0000d500: 656e 745f 6469 7228 7365 6c66 293a 0a20  ent_dir(self):. 
-0000d510: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d520: 7274 4571 7561 6c28 222e 2e7c 2e2e 222c  rtEqual("..|..",
-0000d530: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000d540: 2e6e 6f72 6d70 6174 6828 222e 2e7c 666f  .normpath("..|fo
-0000d550: 6f7c 6261 727c 2e2e 7c2e 2e7c 2e2e 2229  o|bar|..|..|..")
-0000d560: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000d570: 636f 6d62 696e 655f 646f 745f 616e 645f  combine_dot_and_
-0000d580: 7570 5f6c 6576 656c 5f72 6566 6572 656e  up_level_referen
-0000d590: 6365 735f 696e 5f61 6273 6f6c 7574 655f  ces_in_absolute_
-0000d5a0: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
-0000d5b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000d5c0: 7175 616c 2822 7c79 6573 222c 2073 656c  qual("|yes", sel
-0000d5d0: 662e 6669 6c65 7379 7374 656d 2e6e 6f72  f.filesystem.nor
-0000d5e0: 6d70 6174 6828 227c 7c7c 7c7c 2e7c 2e2e  mpath("|||||.|..
-0000d5f0: 7c7c 7c79 6573 7c6e 6f7c 2e2e 7c2e 7c7c  |||yes|no|..|.||
-0000d600: 7c22 2929 0a0a 2020 2020 6465 6620 7465  |"))..    def te
-0000d610: 7374 5f64 6f74 735f 696e 5f70 6174 685f  st_dots_in_path_
-0000d620: 636f 6c6c 6170 7365 735f 746f 5f6c 6173  collapses_to_las
-0000d630: 745f 7061 7468 2873 656c 6629 3a0a 2020  t_path(self):.  
-0000d640: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000d650: 7445 7175 616c 2822 6261 7222 2c20 7365  tEqual("bar", se
-0000d660: 6c66 2e66 696c 6573 7973 7465 6d2e 6e6f  lf.filesystem.no
-0000d670: 726d 7061 7468 2822 666f 6f7c 2e2e 7c62  rmpath("foo|..|b
-0000d680: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
-0000d690: 6c66 2e61 7373 6572 7445 7175 616c 2822  lf.assertEqual("
-0000d6a0: 6261 7222 2c20 7365 6c66 2e66 696c 6573  bar", self.files
-0000d6b0: 7973 7465 6d2e 6e6f 726d 7061 7468 2822  ystem.normpath("
-0000d6c0: 666f 6f7c 2e2e 7c79 6573 7c2e 2e7c 6e6f  foo|..|yes|..|no
-0000d6d0: 7c2e 2e7c 6261 7222 2929 0a0a 0a63 6c61  |..|bar"))...cla
-0000d6e0: 7373 2053 706c 6974 5061 7468 5465 7374  ss SplitPathTest
-0000d6f0: 2850 6174 684d 616e 6970 756c 6174 696f  (PathManipulatio
-0000d700: 6e54 6573 7442 6173 6529 3a0a 2020 2020  nTestBase):.    
-0000d710: 2222 2254 6573 7473 2053 706c 6974 5061  """Tests SplitPa
-0000d720: 7468 2028 7768 6963 6820 6d69 6d69 6373  th (which mimics
-0000d730: 206f 732e 7061 7468 2e73 706c 6974 290a   os.path.split).
-0000d740: 2020 2020 7573 696e 6720 7c20 6173 2070      using | as p
-0000d750: 6174 6820 7365 7061 7261 746f 722e 2222  ath separator.""
-0000d760: 220a 0a20 2020 2064 6566 2074 6573 745f  "..    def test_
-0000d770: 656d 7074 795f 7061 7468 2873 656c 6629  empty_path(self)
-0000d780: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-0000d790: 7373 6572 7445 7175 616c 2828 2222 2c20  ssertEqual(("", 
-0000d7a0: 2222 292c 2073 656c 662e 6669 6c65 7379  ""), self.filesy
-0000d7b0: 7374 656d 2e73 706c 6974 7061 7468 2822  stem.splitpath("
-0000d7c0: 2229 290a 0a20 2020 2064 6566 2074 6573  "))..    def tes
-0000d7d0: 745f 6e6f 5f73 6570 6172 6174 6f72 7328  t_no_separators(
-0000d7e0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000d7f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000d800: 2822 222c 2022 6162 2229 2c20 7365 6c66  ("", "ab"), self
-0000d810: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-0000d820: 7470 6174 6828 2261 6222 2929 0a0a 2020  tpath("ab"))..  
-0000d830: 2020 6465 6620 7465 7374 5f73 6c61 7368    def test_slash
-0000d840: 6573 5f64 6f5f 6e6f 745f 7370 6c69 7428  es_do_not_split(
-0000d850: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
-0000d860: 2222 5465 7374 7320 7468 6174 2027 2f27  ""Tests that '/'
-0000d870: 2069 7320 6e6f 7420 7472 6561 7465 6420   is not treated 
-0000d880: 7370 6563 6961 6c6c 7920 6966 2074 6865  specially if the
-0000d890: 0a20 2020 2020 2020 2070 6174 6820 7365  .        path se
-0000d8a0: 7061 7261 746f 7220 6973 2027 7c27 2e22  parator is '|'."
-0000d8b0: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
-0000d8c0: 6173 7365 7274 4571 7561 6c28 2822 222c  assertEqual(("",
-0000d8d0: 2022 612f 6222 292c 2073 656c 662e 6669   "a/b"), self.fi
-0000d8e0: 6c65 7379 7374 656d 2e73 706c 6974 7061  lesystem.splitpa
-0000d8f0: 7468 2822 612f 6222 2929 0a0a 2020 2020  th("a/b"))..    
-0000d900: 6465 6620 7465 7374 5f65 6c69 6d69 6e61  def test_elimina
-0000d910: 7465 5f74 7261 696c 696e 675f 7365 7061  te_trailing_sepa
-0000d920: 7261 746f 7273 5f66 726f 6d5f 6865 6164  rators_from_head
-0000d930: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000d940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000d950: 2828 2261 222c 2022 6222 292c 2073 656c  (("a", "b"), sel
-0000d960: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-0000d970: 6974 7061 7468 2822 617c 6222 2929 0a20  itpath("a|b")). 
-0000d980: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d990: 7274 4571 7561 6c28 2822 6122 2c20 2262  rtEqual(("a", "b
-0000d9a0: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
-0000d9b0: 7465 6d2e 7370 6c69 7470 6174 6828 2261  tem.splitpath("a
-0000d9c0: 7c7c 7c62 2229 290a 2020 2020 2020 2020  |||b")).        
-0000d9d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000d9e0: 2828 227c 6122 2c20 2262 2229 2c20 7365  (("|a", "b"), se
-0000d9f0: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
-0000da00: 6c69 7470 6174 6828 227c 617c 7c62 2229  litpath("|a||b")
-0000da10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000da20: 7373 6572 7445 7175 616c 2828 2261 7c62  ssertEqual(("a|b
-0000da30: 222c 2022 6322 292c 2073 656c 662e 6669  ", "c"), self.fi
-0000da40: 6c65 7379 7374 656d 2e73 706c 6974 7061  lesystem.splitpa
-0000da50: 7468 2822 617c 627c 6322 2929 0a20 2020  th("a|b|c")).   
-0000da60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000da70: 4571 7561 6c28 2822 7c61 7c62 222c 2022  Equal(("|a|b", "
-0000da80: 6322 292c 2073 656c 662e 6669 6c65 7379  c"), self.filesy
-0000da90: 7374 656d 2e73 706c 6974 7061 7468 2822  stem.splitpath("
-0000daa0: 7c61 7c62 7c63 2229 290a 0a20 2020 2064  |a|b|c"))..    d
-0000dab0: 6566 2074 6573 745f 726f 6f74 5f73 6570  ef test_root_sep
-0000dac0: 6172 6174 6f72 5f69 735f 6e6f 745f 7374  arator_is_not_st
-0000dad0: 7269 7070 6564 2873 656c 6629 3a0a 2020  ripped(self):.  
-0000dae0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000daf0: 7445 7175 616c 2828 227c 7c7c 222c 2022  tEqual(("|||", "
-0000db00: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
-0000db10: 7465 6d2e 7370 6c69 7470 6174 6828 227c  tem.splitpath("|
-0000db20: 7c7c 2229 290a 2020 2020 2020 2020 7365  ||")).        se
-0000db30: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-0000db40: 227c 222c 2022 6122 292c 2073 656c 662e  "|", "a"), self.
-0000db50: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-0000db60: 7061 7468 2822 7c61 2229 290a 2020 2020  path("|a")).    
-0000db70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000db80: 7175 616c 2828 227c 7c7c 222c 2022 6122  qual(("|||", "a"
-0000db90: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-0000dba0: 656d 2e73 706c 6974 7061 7468 2822 7c7c  em.splitpath("||
-0000dbb0: 7c61 2229 290a 0a20 2020 2064 6566 2074  |a"))..    def t
-0000dbc0: 6573 745f 656d 7074 795f 7461 696c 5f69  est_empty_tail_i
-0000dbd0: 665f 7061 7468 5f65 6e64 735f 696e 5f73  f_path_ends_in_s
-0000dbe0: 6570 6172 6174 6f72 2873 656c 6629 3a0a  eparator(self):.
-0000dbf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000dc00: 6572 7445 7175 616c 2828 2261 7c62 222c  ertEqual(("a|b",
-0000dc10: 2022 2229 2c20 7365 6c66 2e66 696c 6573   ""), self.files
-0000dc20: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
-0000dc30: 2261 7c62 7c22 2929 0a0a 2020 2020 6465  "a|b|"))..    de
-0000dc40: 6620 7465 7374 5f65 6d70 7479 5f70 6174  f test_empty_pat
-0000dc50: 685f 636f 6d70 6f6e 656e 7473 5f61 7265  h_components_are
-0000dc60: 5f70 7265 7365 7276 6564 5f69 6e5f 6865  _preserved_in_he
-0000dc70: 6164 2873 656c 6629 3a0a 2020 2020 2020  ad(self):.      
-0000dc80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000dc90: 616c 2828 227c 617c 7c62 222c 2022 6322  al(("|a||b", "c"
-0000dca0: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-0000dcb0: 656d 2e73 706c 6974 7061 7468 2822 7c61  em.splitpath("|a
-0000dcc0: 7c7c 627c 7c63 2229 290a 0a0a 636c 6173  ||b||c"))...clas
-0000dcd0: 7320 4a6f 696e 5061 7468 5465 7374 2850  s JoinPathTest(P
-0000dce0: 6174 684d 616e 6970 756c 6174 696f 6e54  athManipulationT
-0000dcf0: 6573 7442 6173 6529 3a0a 2020 2020 2222  estBase):.    ""
-0000dd00: 2254 6573 7473 204a 6f69 6e50 6174 6820  "Tests JoinPath 
-0000dd10: 2877 6869 6368 206d 696d 6963 7320 6f73  (which mimics os
-0000dd20: 2e70 6174 682e 6a6f 696e 2920 7573 696e  .path.join) usin
-0000dd30: 6720 7c20 6173 2070 6174 6820 7365 7061  g | as path sepa
-0000dd40: 7261 746f 722e 2222 220a 0a20 2020 2064  rator."""..    d
-0000dd50: 6566 2074 6573 745f 6f6e 655f 656d 7074  ef test_one_empt
-0000dd60: 795f 636f 6d70 6f6e 656e 7428 7365 6c66  y_component(self
-0000dd70: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000dd80: 6173 7365 7274 4571 7561 6c28 2222 2c20  assertEqual("", 
-0000dd90: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000dda0: 6a6f 696e 7061 7468 7328 2222 2929 0a0a  joinpaths(""))..
-0000ddb0: 2020 2020 6465 6620 7465 7374 5f6d 756c      def test_mul
-0000ddc0: 7469 706c 655f 656d 7074 795f 636f 6d70  tiple_empty_comp
-0000ddd0: 6f6e 656e 7473 2873 656c 6629 3a0a 2020  onents(self):.  
-0000dde0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000ddf0: 7445 7175 616c 2822 222c 2073 656c 662e  tEqual("", self.
-0000de00: 6669 6c65 7379 7374 656d 2e6a 6f69 6e70  filesystem.joinp
-0000de10: 6174 6873 2822 222c 2022 222c 2022 2229  aths("", "", "")
-0000de20: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000de30: 7365 7061 7261 746f 7273 5f6e 6f74 5f73  separators_not_s
-0000de40: 7472 6970 7065 645f 6672 6f6d 5f73 696e  tripped_from_sin
-0000de50: 676c 655f 636f 6d70 6f6e 656e 7428 7365  gle_component(se
-0000de60: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000de70: 662e 6173 7365 7274 4571 7561 6c28 227c  f.assertEqual("|
-0000de80: 7c61 7c7c 222c 2073 656c 662e 6669 6c65  |a||", self.file
-0000de90: 7379 7374 656d 2e6a 6f69 6e70 6174 6873  system.joinpaths
-0000dea0: 2822 7c7c 617c 7c22 2929 0a0a 2020 2020  ("||a||"))..    
-0000deb0: 6465 6620 7465 7374 5f6f 6e65 5f73 6570  def test_one_sep
-0000dec0: 6172 6174 6f72 5f61 6464 6564 5f62 6574  arator_added_bet
-0000ded0: 7765 656e 5f63 6f6d 706f 6e65 6e74 7328  ween_components(
-0000dee0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000def0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000df00: 2261 7c62 7c63 7c64 222c 2073 656c 662e  "a|b|c|d", self.
-0000df10: 6669 6c65 7379 7374 656d 2e6a 6f69 6e70  filesystem.joinp
-0000df20: 6174 6873 2822 6122 2c20 2262 222c 2022  aths("a", "b", "
-0000df30: 6322 2c20 2264 2229 290a 0a20 2020 2064  c", "d"))..    d
-0000df40: 6566 2074 6573 745f 6e6f 5f73 6570 6172  ef test_no_separ
-0000df50: 6174 6f72 5f61 6464 6564 5f66 6f72 5f63  ator_added_for_c
-0000df60: 6f6d 706f 6e65 6e74 735f 656e 6469 6e67  omponents_ending
-0000df70: 5f69 6e5f 7365 7061 7261 746f 7228 7365  _in_separator(se
-0000df80: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000df90: 662e 6173 7365 7274 4571 7561 6c28 2261  f.assertEqual("a
-0000dfa0: 7c62 7c63 222c 2073 656c 662e 6669 6c65  |b|c", self.file
-0000dfb0: 7379 7374 656d 2e6a 6f69 6e70 6174 6873  system.joinpaths
-0000dfc0: 2822 617c 222c 2022 627c 222c 2022 6322  ("a|", "b|", "c"
-0000dfd0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000dfe0: 6173 7365 7274 4571 7561 6c28 2261 7c7c  assertEqual("a||
-0000dff0: 7c62 7c7c 7c63 222c 2073 656c 662e 6669  |b|||c", self.fi
-0000e000: 6c65 7379 7374 656d 2e6a 6f69 6e70 6174  lesystem.joinpat
-0000e010: 6873 2822 617c 7c7c 222c 2022 627c 7c7c  hs("a|||", "b|||
-0000e020: 222c 2022 6322 2929 0a0a 2020 2020 6465  ", "c"))..    de
-0000e030: 6620 7465 7374 5f63 6f6d 706f 6e65 6e74  f test_component
-0000e040: 735f 7072 6563 6564 696e 675f 6162 736f  s_preceding_abso
-0000e050: 6c75 7465 5f63 6f6d 706f 6e65 6e74 5f61  lute_component_a
-0000e060: 7265 5f69 676e 6f72 6564 2873 656c 6629  re_ignored(self)
-0000e070: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-0000e080: 7373 6572 7445 7175 616c 2822 7c63 7c64  ssertEqual("|c|d
-0000e090: 222c 2073 656c 662e 6669 6c65 7379 7374  ", self.filesyst
-0000e0a0: 656d 2e6a 6f69 6e70 6174 6873 2822 6122  em.joinpaths("a"
-0000e0b0: 2c20 227c 6222 2c20 227c 6322 2c20 2264  , "|b", "|c", "d
-0000e0c0: 2229 290a 0a20 2020 2064 6566 2074 6573  "))..    def tes
-0000e0d0: 745f 6f6e 655f 7365 7061 7261 746f 725f  t_one_separator_
-0000e0e0: 6164 6465 645f 666f 725f 7472 6169 6c69  added_for_traili
-0000e0f0: 6e67 5f65 6d70 7479 5f63 6f6d 706f 6e65  ng_empty_compone
-0000e100: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
-0000e110: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e120: 7561 6c28 2261 7c22 2c20 7365 6c66 2e66  ual("a|", self.f
-0000e130: 696c 6573 7973 7465 6d2e 6a6f 696e 7061  ilesystem.joinpa
-0000e140: 7468 7328 2261 222c 2022 2229 290a 2020  ths("a", "")).  
-0000e150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e160: 7445 7175 616c 2822 617c 222c 2073 656c  tEqual("a|", sel
-0000e170: 662e 6669 6c65 7379 7374 656d 2e6a 6f69  f.filesystem.joi
-0000e180: 6e70 6174 6873 2822 6122 2c20 2222 2c20  npaths("a", "", 
-0000e190: 2222 2929 0a0a 2020 2020 6465 6620 7465  ""))..    def te
-0000e1a0: 7374 5f6e 6f5f 7365 7061 7261 746f 725f  st_no_separator_
-0000e1b0: 6164 6465 645f 666f 725f 6c65 6164 696e  added_for_leadin
-0000e1c0: 675f 656d 7074 795f 636f 6d70 6f6e 656e  g_empty_componen
-0000e1d0: 7473 2873 656c 6629 3a0a 2020 2020 2020  ts(self):.      
-0000e1e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e1f0: 616c 2822 6122 2c20 7365 6c66 2e66 696c  al("a", self.fil
-0000e200: 6573 7973 7465 6d2e 6a6f 696e 7061 7468  esystem.joinpath
-0000e210: 7328 2222 2c20 2261 2229 290a 0a20 2020  s("", "a"))..   
-0000e220: 2064 6566 2074 6573 745f 696e 7465 726e   def test_intern
-0000e230: 616c 5f65 6d70 7479 5f63 6f6d 706f 6e65  al_empty_compone
-0000e240: 6e74 735f 6967 6e6f 7265 6428 7365 6c66  nts_ignored(self
-0000e250: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000e260: 6173 7365 7274 4571 7561 6c28 2261 7c62  assertEqual("a|b
-0000e270: 222c 2073 656c 662e 6669 6c65 7379 7374  ", self.filesyst
-0000e280: 656d 2e6a 6f69 6e70 6174 6873 2822 6122  em.joinpaths("a"
-0000e290: 2c20 2222 2c20 2262 2229 290a 2020 2020  , "", "b")).    
-0000e2a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000e2b0: 7175 616c 2822 617c 627c 222c 2073 656c  qual("a|b|", sel
-0000e2c0: 662e 6669 6c65 7379 7374 656d 2e6a 6f69  f.filesystem.joi
-0000e2d0: 6e70 6174 6873 2822 617c 222c 2022 222c  npaths("a|", "",
-0000e2e0: 2022 627c 2229 290a 0a0a 636c 6173 7320   "b|"))...class 
-0000e2f0: 5061 7468 5365 7061 7261 746f 7254 6573  PathSeparatorTes
-0000e300: 7428 5465 7374 4361 7365 293a 0a20 2020  t(TestCase):.   
-0000e310: 2064 6566 2074 6573 745f 6f73 5f70 6174   def test_os_pat
-0000e320: 685f 7365 705f 6d61 7463 6865 735f 6661  h_sep_matches_fa
-0000e330: 6b65 5f66 696c 6573 7973 7465 6d5f 7365  ke_filesystem_se
-0000e340: 7061 7261 746f 7228 7365 6c66 293a 0a20  parator(self):. 
-0000e350: 2020 2020 2020 2066 696c 6573 7973 7465         filesyste
-0000e360: 6d20 3d20 6661 6b65 5f66 696c 6573 7973  m = fake_filesys
-0000e370: 7465 6d2e 4661 6b65 4669 6c65 7379 7374  tem.FakeFilesyst
-0000e380: 656d 2870 6174 685f 7365 7061 7261 746f  em(path_separato
-0000e390: 723d 2221 2229 0a20 2020 2020 2020 2066  r="!").        f
-0000e3a0: 616b 655f 6f73 5f6d 6f64 756c 6520 3d20  ake_os_module = 
-0000e3b0: 6661 6b65 5f6f 732e 4661 6b65 4f73 4d6f  fake_os.FakeOsMo
-0000e3c0: 6475 6c65 2866 696c 6573 7973 7465 6d29  dule(filesystem)
-0000e3d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e3e0: 7365 7274 4571 7561 6c28 2221 222c 2066  sertEqual("!", f
-0000e3f0: 616b 655f 6f73 5f6d 6f64 756c 652e 7365  ake_os_module.se
-0000e400: 7029 0a20 2020 2020 2020 2073 656c 662e  p).        self.
-0000e410: 6173 7365 7274 4571 7561 6c28 2221 222c  assertEqual("!",
-0000e420: 2066 616b 655f 6f73 5f6d 6f64 756c 652e   fake_os_module.
-0000e430: 7061 7468 2e73 6570 290a 0a0a 636c 6173  path.sep)...clas
-0000e440: 7320 4e6f 726d 616c 697a 6543 6173 6554  s NormalizeCaseT
-0000e450: 6573 7428 5465 7374 4361 7365 293a 0a20  est(TestCase):. 
-0000e460: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
-0000e470: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000e480: 2e66 696c 6573 7973 7465 6d20 3d20 6661  .filesystem = fa
-0000e490: 6b65 5f66 696c 6573 7973 7465 6d2e 4661  ke_filesystem.Fa
-0000e4a0: 6b65 4669 6c65 7379 7374 656d 2870 6174  keFilesystem(pat
-0000e4b0: 685f 7365 7061 7261 746f 723d 222f 2229  h_separator="/")
-0000e4c0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-0000e4d0: 6c65 7379 7374 656d 2e69 735f 6361 7365  lesystem.is_case
-0000e4e0: 5f73 656e 7369 7469 7665 203d 2046 616c  _sensitive = Fal
-0000e4f0: 7365 0a0a 2020 2020 6465 6620 7465 7374  se..    def test
-0000e500: 5f6e 6f72 6d61 6c69 7a65 5f63 6173 6528  _normalize_case(
-0000e510: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000e520: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-0000e530: 7265 6174 655f 6669 6c65 2822 2f46 6f6f  reate_file("/Foo
-0000e540: 2f42 6172 2229 0a20 2020 2020 2020 2073  /Bar").        s
-0000e550: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000e560: 0a20 2020 2020 2020 2020 2020 2066 227b  .            f"{
-0000e570: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000e580: 726f 6f74 5f64 6972 5f6e 616d 657d 466f  root_dir_name}Fo
-0000e590: 6f2f 4261 7222 2c0a 2020 2020 2020 2020  o/Bar",.        
-0000e5a0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-0000e5b0: 7465 6d2e 5f6f 7269 6769 6e61 6c5f 7061  tem._original_pa
-0000e5c0: 7468 2822 2f66 6f6f 2f62 6172 2229 2c0a  th("/foo/bar"),.
-0000e5d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000e5e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e5f0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-0000e600: 6622 7b73 656c 662e 6669 6c65 7379 7374  f"{self.filesyst
-0000e610: 656d 2e72 6f6f 745f 6469 725f 6e61 6d65  em.root_dir_name
-0000e620: 7d46 6f6f 2f42 6172 222c 0a20 2020 2020  }Foo/Bar",.     
-0000e630: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-0000e640: 7379 7374 656d 2e5f 6f72 6967 696e 616c  system._original
-0000e650: 5f70 6174 6828 222f 464f 4f2f 4241 5222  _path("/FOO/BAR"
-0000e660: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-0000e670: 2020 6465 6620 7465 7374 5f6e 6f72 6d61    def test_norma
-0000e680: 6c69 7a65 5f63 6173 655f 666f 725f 6472  lize_case_for_dr
-0000e690: 6976 6528 7365 6c66 293a 0a20 2020 2020  ive(self):.     
-0000e6a0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-0000e6b0: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
-0000e6c0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0000e6d0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000e6e0: 6372 6561 7465 5f66 696c 6528 2243 3a2f  create_file("C:/
-0000e6f0: 466f 6f2f 4261 7222 290a 2020 2020 2020  Foo/Bar").      
-0000e700: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e710: 616c 2822 433a 2f46 6f6f 2f42 6172 222c  al("C:/Foo/Bar",
-0000e720: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000e730: 2e5f 6f72 6967 696e 616c 5f70 6174 6828  ._original_path(
-0000e740: 2263 3a2f 666f 6f2f 6261 7222 2929 0a20  "c:/foo/bar")). 
-0000e750: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e760: 7274 4571 7561 6c28 2243 3a2f 466f 6f2f  rtEqual("C:/Foo/
-0000e770: 4261 7222 2c20 7365 6c66 2e66 696c 6573  Bar", self.files
-0000e780: 7973 7465 6d2e 5f6f 7269 6769 6e61 6c5f  ystem._original_
-0000e790: 7061 7468 2822 433a 2f46 4f4f 2f42 4152  path("C:/FOO/BAR
-0000e7a0: 2229 290a 0a20 2020 2064 6566 2074 6573  "))..    def tes
-0000e7b0: 745f 6e6f 726d 616c 697a 655f 6361 7365  t_normalize_case
-0000e7c0: 5f66 6f72 5f6e 6f6e 5f65 7869 7374 696e  _for_non_existin
-0000e7d0: 675f 6669 6c65 2873 656c 6629 3a0a 2020  g_file(self):.  
-0000e7e0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-0000e7f0: 7973 7465 6d2e 6372 6561 7465 5f64 6972  ystem.create_dir
-0000e800: 2822 2f46 6f6f 2f42 6172 2229 0a20 2020  ("/Foo/Bar").   
-0000e810: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000e820: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-0000e830: 2020 2066 227b 7365 6c66 2e66 696c 6573     f"{self.files
-0000e840: 7973 7465 6d2e 726f 6f74 5f64 6972 5f6e  ystem.root_dir_n
-0000e850: 616d 657d 466f 6f2f 4261 722f 6261 7a22  ame}Foo/Bar/baz"
-0000e860: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-0000e870: 6c66 2e66 696c 6573 7973 7465 6d2e 5f6f  lf.filesystem._o
-0000e880: 7269 6769 6e61 6c5f 7061 7468 2822 2f66  riginal_path("/f
-0000e890: 6f6f 2f62 6172 2f62 617a 2229 2c0a 2020  oo/bar/baz"),.  
-0000e8a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000e8b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000e8c0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-0000e8d0: 7b73 656c 662e 6669 6c65 7379 7374 656d  {self.filesystem
-0000e8e0: 2e72 6f6f 745f 6469 725f 6e61 6d65 7d46  .root_dir_name}F
-0000e8f0: 6f6f 2f42 6172 2f42 415a 222c 0a20 2020  oo/Bar/BAZ",.   
-0000e900: 2020 2020 2020 2020 2073 656c 662e 6669           self.fi
-0000e910: 6c65 7379 7374 656d 2e5f 6f72 6967 696e  lesystem._origin
-0000e920: 616c 5f70 6174 6828 222f 464f 4f2f 4241  al_path("/FOO/BA
-0000e930: 522f 4241 5a22 292c 0a20 2020 2020 2020  R/BAZ"),.       
-0000e940: 2029 0a0a 2020 2020 4075 6e69 7474 6573   )..    @unittes
-0000e950: 742e 736b 6970 4966 280a 2020 2020 2020  t.skipIf(.      
-0000e960: 2020 6e6f 7420 5465 7374 4361 7365 2e69    not TestCase.i
-0000e970: 735f 7769 6e64 6f77 732c 2022 5265 6772  s_windows, "Regr
-0000e980: 6573 7369 6f6e 2074 6573 7420 666f 7220  ession test for 
-0000e990: 5769 6e64 6f77 7320 7072 6f62 6c65 6d20  Windows problem 
-0000e9a0: 6f6e 6c79 220a 2020 2020 290a 2020 2020  only".    ).    
-0000e9b0: 6465 6620 7465 7374 5f6e 6f72 6d61 6c69  def test_normali
-0000e9c0: 7a65 5f63 6173 655f 666f 725f 6c61 7a69  ze_case_for_lazi
-0000e9d0: 6c79 5f61 6464 6564 5f65 6d70 7479 5f66  ly_added_empty_f
-0000e9e0: 696c 6528 7365 6c66 293a 0a20 2020 2020  ile(self):.     
-0000e9f0: 2020 2023 2072 6567 7265 7373 696f 6e20     # regression 
-0000ea00: 7465 7374 2066 6f72 2073 7065 6369 6669  test for specifi
-0000ea10: 6320 6973 7375 6520 7769 7468 2061 6464  c issue with add
-0000ea20: 6564 2065 6d70 7479 2072 6561 6c20 6669  ed empty real fi
-0000ea30: 6c65 730a 2020 2020 2020 2020 6669 6c65  les.        file
-0000ea40: 7379 7374 656d 203d 2066 616b 655f 6669  system = fake_fi
-0000ea50: 6c65 7379 7374 656d 2e46 616b 6546 696c  lesystem.FakeFil
-0000ea60: 6573 7973 7465 6d28 290a 2020 2020 2020  esystem().      
-0000ea70: 2020 7265 616c 5f64 6972 5f70 6174 6820    real_dir_path 
-0000ea80: 3d20 6f73 2e70 6174 682e 7370 6c69 7428  = os.path.split(
-0000ea90: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-0000eaa0: 6f73 2e70 6174 682e 6162 7370 6174 6828  os.path.abspath(
-0000eab0: 5f5f 6669 6c65 5f5f 2929 295b 305d 0a20  __file__)))[0]. 
-0000eac0: 2020 2020 2020 2066 696c 6573 7973 7465         filesyste
-0000ead0: 6d2e 6164 645f 7265 616c 5f64 6972 6563  m.add_real_direc
-0000eae0: 746f 7279 2872 6561 6c5f 6469 725f 7061  tory(real_dir_pa
-0000eaf0: 7468 290a 2020 2020 2020 2020 696e 6974  th).        init
-0000eb00: 5079 5061 7468 203d 206f 732e 7061 7468  PyPath = os.path
-0000eb10: 2e6a 6f69 6e28 7265 616c 5f64 6972 5f70  .join(real_dir_p
-0000eb20: 6174 682c 2022 5f5f 696e 6974 5f5f 2e70  ath, "__init__.p
-0000eb30: 7922 290a 2020 2020 2020 2020 7365 6c66  y").        self
-0000eb40: 2e61 7373 6572 7445 7175 616c 2869 6e69  .assertEqual(ini
-0000eb50: 7450 7950 6174 682c 2066 696c 6573 7973  tPyPath, filesys
-0000eb60: 7465 6d2e 5f6f 7269 6769 6e61 6c5f 7061  tem._original_pa
-0000eb70: 7468 2869 6e69 7450 7950 6174 682e 7570  th(initPyPath.up
-0000eb80: 7065 7228 2929 290a 0a0a 636c 6173 7320  per()))...class 
-0000eb90: 416c 7465 726e 6174 6976 6550 6174 6853  AlternativePathS
-0000eba0: 6570 6172 6174 6f72 5465 7374 2854 6573  eparatorTest(Tes
-0000ebb0: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
-0000ebc0: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
-0000ebd0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-0000ebe0: 7374 656d 203d 2066 616b 655f 6669 6c65  stem = fake_file
-0000ebf0: 7379 7374 656d 2e46 616b 6546 696c 6573  system.FakeFiles
-0000ec00: 7973 7465 6d28 7061 7468 5f73 6570 6172  ystem(path_separ
-0000ec10: 6174 6f72 3d22 2122 290a 2020 2020 2020  ator="!").      
-0000ec20: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-0000ec30: 6d2e 616c 7465 726e 6174 6976 655f 7061  m.alternative_pa
-0000ec40: 7468 5f73 6570 6172 6174 6f72 203d 2022  th_separator = "
-0000ec50: 3f22 0a0a 2020 2020 6465 6620 7465 7374  ?"..    def test
-0000ec60: 5f69 6e69 7469 616c 5f76 616c 7565 2873  _initial_value(s
-0000ec70: 656c 6629 3a0a 2020 2020 2020 2020 6669  elf):.        fi
-0000ec80: 6c65 7379 7374 656d 203d 2066 616b 655f  lesystem = fake_
-0000ec90: 6669 6c65 7379 7374 656d 2e46 616b 6546  filesystem.FakeF
-0000eca0: 696c 6573 7973 7465 6d28 290a 2020 2020  ilesystem().    
-0000ecb0: 2020 2020 6966 2073 656c 662e 6973 5f77      if self.is_w
-0000ecc0: 696e 646f 7773 3a0a 2020 2020 2020 2020  indows:.        
-0000ecd0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000ece0: 7175 616c 2822 2f22 2c20 6669 6c65 7379  qual("/", filesy
-0000ecf0: 7374 656d 2e61 6c74 6572 6e61 7469 7665  stem.alternative
-0000ed00: 5f70 6174 685f 7365 7061 7261 746f 7229  _path_separator)
-0000ed10: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000ed20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000ed30: 6173 7365 7274 4973 4e6f 6e65 2866 696c  assertIsNone(fil
-0000ed40: 6573 7973 7465 6d2e 616c 7465 726e 6174  esystem.alternat
-0000ed50: 6976 655f 7061 7468 5f73 6570 6172 6174  ive_path_separat
-0000ed60: 6f72 290a 0a20 2020 2020 2020 2066 696c  or)..        fil
-0000ed70: 6573 7973 7465 6d20 3d20 6661 6b65 5f66  esystem = fake_f
-0000ed80: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
-0000ed90: 6c65 7379 7374 656d 2870 6174 685f 7365  lesystem(path_se
-0000eda0: 7061 7261 746f 723d 222f 2229 0a20 2020  parator="/").   
-0000edb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000edc0: 4973 4e6f 6e65 2866 696c 6573 7973 7465  IsNone(filesyste
-0000edd0: 6d2e 616c 7465 726e 6174 6976 655f 7061  m.alternative_pa
-0000ede0: 7468 5f73 6570 6172 6174 6f72 290a 0a20  th_separator).. 
-0000edf0: 2020 2064 6566 2074 6573 745f 616c 745f     def test_alt_
-0000ee00: 7365 7028 7365 6c66 293a 0a20 2020 2020  sep(self):.     
-0000ee10: 2020 2066 616b 655f 6f73 5f6d 6f64 756c     fake_os_modul
-0000ee20: 6520 3d20 6661 6b65 5f6f 732e 4661 6b65  e = fake_os.Fake
-0000ee30: 4f73 4d6f 6475 6c65 2873 656c 662e 6669  OsModule(self.fi
-0000ee40: 6c65 7379 7374 656d 290a 2020 2020 2020  lesystem).      
-0000ee50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000ee60: 616c 2822 3f22 2c20 6661 6b65 5f6f 735f  al("?", fake_os_
-0000ee70: 6d6f 6475 6c65 2e61 6c74 7365 7029 0a20  module.altsep). 
-0000ee80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ee90: 7274 4571 7561 6c28 223f 222c 2066 616b  rtEqual("?", fak
-0000eea0: 655f 6f73 5f6d 6f64 756c 652e 7061 7468  e_os_module.path
-0000eeb0: 2e61 6c74 7365 7029 0a0a 2020 2020 6465  .altsep)..    de
-0000eec0: 6620 7465 7374 5f63 6f6c 6c61 7073 655f  f test_collapse_
-0000eed0: 7061 7468 5f77 6974 685f 6d69 7865 645f  path_with_mixed_
-0000eee0: 7365 7061 7261 746f 7273 2873 656c 6629  separators(self)
-0000eef0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-0000ef00: 7373 6572 7445 7175 616c 2822 2166 6f6f  ssertEqual("!foo
-0000ef10: 2162 6172 222c 2073 656c 662e 6669 6c65  !bar", self.file
-0000ef20: 7379 7374 656d 2e6e 6f72 6d70 6174 6828  system.normpath(
-0000ef30: 2221 666f 6f3f 3f62 6172 2229 290a 0a20  "!foo??bar")).. 
-0000ef40: 2020 2064 6566 2074 6573 745f 6e6f 726d     def test_norm
-0000ef50: 616c 697a 655f 7061 7468 5f77 6974 685f  alize_path_with_
-0000ef60: 6d69 7865 645f 7365 7061 7261 746f 7273  mixed_separators
-0000ef70: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000ef80: 7061 7468 203d 2022 666f 6f3f 2e2e 3f62  path = "foo?..?b
-0000ef90: 6172 220a 2020 2020 2020 2020 7365 6c66  ar".        self
-0000efa0: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
-0000efb0: 2020 2020 2020 2020 2020 6622 7b73 656c            f"{sel
-0000efc0: 662e 6669 6c65 7379 7374 656d 2e72 6f6f  f.filesystem.roo
-0000efd0: 745f 6469 725f 6e61 6d65 7d62 6172 222c  t_dir_name}bar",
-0000efe0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000eff0: 662e 6669 6c65 7379 7374 656d 2e61 6273  f.filesystem.abs
-0000f000: 6e6f 726d 7061 7468 2870 6174 6829 2c0a  normpath(path),.
-0000f010: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-0000f020: 6566 2074 6573 745f 6578 6973 7473 5f77  ef test_exists_w
-0000f030: 6974 685f 6d69 7865 645f 7365 7061 7261  ith_mixed_separa
-0000f040: 746f 7273 2873 656c 6629 3a0a 2020 2020  tors(self):.    
-0000f050: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-0000f060: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
-0000f070: 223f 666f 6f3f 6261 723f 6261 7a22 290a  "?foo?bar?baz").
-0000f080: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-0000f090: 6573 7973 7465 6d2e 6372 6561 7465 5f66  esystem.create_f
-0000f0a0: 696c 6528 2221 666f 6f21 6261 7221 7879  ile("!foo!bar!xy
-0000f0b0: 7a7a 7921 706c 7567 6822 290a 2020 2020  zzy!plugh").    
-0000f0c0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000f0d0: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
-0000f0e0: 7465 6d2e 6578 6973 7473 2822 2166 6f6f  tem.exists("!foo
-0000f0f0: 2162 6172 2162 617a 2229 290a 2020 2020  !bar!baz")).    
-0000f100: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000f110: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
-0000f120: 7465 6d2e 6578 6973 7473 2822 3f66 6f6f  tem.exists("?foo
-0000f130: 3f62 6172 3f78 797a 7a79 3f70 6c75 6768  ?bar?xyzzy?plugh
-0000f140: 2229 290a 0a0a 636c 6173 7320 4472 6976  "))...class Driv
-0000f150: 654c 6574 7465 7253 7570 706f 7274 5465  eLetterSupportTe
-0000f160: 7374 2854 6573 7443 6173 6529 3a0a 2020  st(TestCase):.  
-0000f170: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-0000f180: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000f190: 6669 6c65 7379 7374 656d 203d 2066 616b  filesystem = fak
-0000f1a0: 655f 6669 6c65 7379 7374 656d 2e46 616b  e_filesystem.Fak
-0000f1b0: 6546 696c 6573 7973 7465 6d28 7061 7468  eFilesystem(path
-0000f1c0: 5f73 6570 6172 6174 6f72 3d22 2122 290a  _separator="!").
-0000f1d0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-0000f1e0: 6573 7973 7465 6d2e 616c 7465 726e 6174  esystem.alternat
-0000f1f0: 6976 655f 7061 7468 5f73 6570 6172 6174  ive_path_separat
-0000f200: 6f72 203d 2022 5e22 0a20 2020 2020 2020  or = "^".       
-0000f210: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000f220: 2e69 735f 7769 6e64 6f77 735f 6673 203d  .is_windows_fs =
-0000f230: 2054 7275 650a 0a20 2020 2064 6566 2074   True..    def t
-0000f240: 6573 745f 696e 6974 6961 6c5f 7661 6c75  est_initial_valu
-0000f250: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-0000f260: 2066 696c 6573 7973 7465 6d20 3d20 6661   filesystem = fa
-0000f270: 6b65 5f66 696c 6573 7973 7465 6d2e 4661  ke_filesystem.Fa
-0000f280: 6b65 4669 6c65 7379 7374 656d 2829 0a20  keFilesystem(). 
-0000f290: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-0000f2a0: 735f 7769 6e64 6f77 733a 0a20 2020 2020  s_windows:.     
-0000f2b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000f2c0: 7274 5472 7565 2866 696c 6573 7973 7465  rtTrue(filesyste
-0000f2d0: 6d2e 6973 5f77 696e 646f 7773 5f66 7329  m.is_windows_fs)
-0000f2e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000f2f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000f300: 6173 7365 7274 4661 6c73 6528 6669 6c65  assertFalse(file
-0000f310: 7379 7374 656d 2e69 735f 7769 6e64 6f77  system.is_window
-0000f320: 735f 6673 290a 0a20 2020 2064 6566 2074  s_fs)..    def t
-0000f330: 6573 745f 636f 6c6c 6170 7365 5f70 6174  est_collapse_pat
-0000f340: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
-0000f350: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f360: 6c28 2263 3a21 666f 6f21 6261 7222 2c20  l("c:!foo!bar", 
-0000f370: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000f380: 6e6f 726d 7061 7468 2822 633a 2121 666f  normpath("c:!!fo
-0000f390: 6f21 2162 6172 2229 290a 0a20 2020 2064  o!!bar"))..    d
-0000f3a0: 6566 2074 6573 745f 636f 6c6c 6170 7365  ef test_collapse
-0000f3b0: 5f75 6e63 5f70 6174 6828 7365 6c66 293a  _unc_path(self):
-0000f3c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000f3d0: 7365 7274 4571 7561 6c28 2221 2166 6f6f  sertEqual("!!foo
-0000f3e0: 2162 6172 2162 617a 222c 2073 656c 662e  !bar!baz", self.
-0000f3f0: 6669 6c65 7379 7374 656d 2e6e 6f72 6d70  filesystem.normp
-0000f400: 6174 6828 2221 2166 6f6f 2162 6172 2121  ath("!!foo!bar!!
-0000f410: 6261 7a21 2122 2929 0a0a 2020 2020 6465  baz!!"))..    de
-0000f420: 6620 7465 7374 5f6e 6f72 6d61 6c69 7a65  f test_normalize
-0000f430: 5f70 6174 685f 7374 7228 7365 6c66 293a  _path_str(self):
-0000f440: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-0000f450: 6c65 7379 7374 656d 2e63 7764 203d 2022  lesystem.cwd = "
-0000f460: 220a 2020 2020 2020 2020 7365 6c66 2e61  ".        self.a
-0000f470: 7373 6572 7445 7175 616c 2822 633a 2166  ssertEqual("c:!f
-0000f480: 6f6f 2162 6172 222c 2073 656c 662e 6669  oo!bar", self.fi
-0000f490: 6c65 7379 7374 656d 2e61 6273 6e6f 726d  lesystem.absnorm
-0000f4a0: 7061 7468 2822 633a 2166 6f6f 2121 6261  path("c:!foo!!ba
-0000f4b0: 7222 2929 0a20 2020 2020 2020 2073 656c  r")).        sel
-0000f4c0: 662e 6669 6c65 7379 7374 656d 2e63 7764  f.filesystem.cwd
-0000f4d0: 203d 2022 633a 2166 6f6f 220a 2020 2020   = "c:!foo".    
-0000f4e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000f4f0: 7175 616c 2822 633a 2166 6f6f 2162 6172  qual("c:!foo!bar
-0000f500: 222c 2073 656c 662e 6669 6c65 7379 7374  ", self.filesyst
-0000f510: 656d 2e61 6273 6e6f 726d 7061 7468 2822  em.absnormpath("
-0000f520: 6261 7222 2929 0a0a 2020 2020 6465 6620  bar"))..    def 
-0000f530: 7465 7374 5f6e 6f72 6d61 6c69 7a65 5f70  test_normalize_p
-0000f540: 6174 685f 6279 7465 7328 7365 6c66 293a  ath_bytes(self):
-0000f550: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-0000f560: 6c65 7379 7374 656d 2e63 7764 203d 2062  lesystem.cwd = b
-0000f570: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
-0000f580: 6173 7365 7274 4571 7561 6c28 6222 633a  assertEqual(b"c:
-0000f590: 2166 6f6f 2162 6172 222c 2073 656c 662e  !foo!bar", self.
-0000f5a0: 6669 6c65 7379 7374 656d 2e61 6273 6e6f  filesystem.absno
-0000f5b0: 726d 7061 7468 2862 2263 3a21 666f 6f21  rmpath(b"c:!foo!
-0000f5c0: 2162 6172 2229 290a 2020 2020 2020 2020  !bar")).        
-0000f5d0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000f5e0: 6377 6420 3d20 6222 633a 2166 6f6f 220a  cwd = b"c:!foo".
-0000f5f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000f600: 6572 7445 7175 616c 2862 2263 3a21 666f  ertEqual(b"c:!fo
-0000f610: 6f21 6261 7222 2c20 7365 6c66 2e66 696c  o!bar", self.fil
-0000f620: 6573 7973 7465 6d2e 6162 736e 6f72 6d70  esystem.absnormp
-0000f630: 6174 6828 6222 6261 7222 2929 0a0a 2020  ath(b"bar"))..  
-0000f640: 2020 6465 6620 7465 7374 5f73 706c 6974    def test_split
-0000f650: 5f70 6174 685f 7374 7228 7365 6c66 293a  _path_str(self):
-0000f660: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000f670: 7365 7274 4571 7561 6c28 2822 633a 2166  sertEqual(("c:!f
-0000f680: 6f6f 222c 2022 6261 7222 292c 2073 656c  oo", "bar"), sel
-0000f690: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-0000f6a0: 6974 7061 7468 2822 633a 2166 6f6f 2162  itpath("c:!foo!b
-0000f6b0: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
-0000f6c0: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-0000f6d0: 2263 3a21 222c 2022 666f 6f22 292c 2073  "c:!", "foo"), s
-0000f6e0: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
-0000f6f0: 706c 6974 7061 7468 2822 633a 2166 6f6f  plitpath("c:!foo
-0000f700: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-0000f710: 2e61 7373 6572 7445 7175 616c 2828 2221  .assertEqual(("!
-0000f720: 666f 6f22 2c20 2262 6172 2229 2c20 7365  foo", "bar"), se
-0000f730: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
-0000f740: 6c69 7470 6174 6828 2221 666f 6f21 6261  litpath("!foo!ba
-0000f750: 7222 2929 0a20 2020 2020 2020 2073 656c  r")).        sel
-0000f760: 662e 6173 7365 7274 4571 7561 6c28 2822  f.assertEqual(("
-0000f770: 2122 2c20 2266 6f6f 2229 2c20 7365 6c66  !", "foo"), self
-0000f780: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-0000f790: 7470 6174 6828 2221 666f 6f22 2929 0a20  tpath("!foo")). 
-0000f7a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000f7b0: 7274 4571 7561 6c28 2822 633a 666f 6f22  rtEqual(("c:foo"
-0000f7c0: 2c20 2262 6172 2229 2c20 7365 6c66 2e66  , "bar"), self.f
-0000f7d0: 696c 6573 7973 7465 6d2e 7370 6c69 7470  ilesystem.splitp
-0000f7e0: 6174 6828 2263 3a66 6f6f 2162 6172 2229  ath("c:foo!bar")
-0000f7f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f800: 7373 6572 7445 7175 616c 2828 2263 3a22  ssertEqual(("c:"
-0000f810: 2c20 2266 6f6f 2229 2c20 7365 6c66 2e66  , "foo"), self.f
-0000f820: 696c 6573 7973 7465 6d2e 7370 6c69 7470  ilesystem.splitp
-0000f830: 6174 6828 2263 3a66 6f6f 2229 290a 2020  ath("c:foo")).  
-0000f840: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f850: 7445 7175 616c 2828 2266 6f6f 222c 2022  tEqual(("foo", "
-0000f860: 6261 7222 292c 2073 656c 662e 6669 6c65  bar"), self.file
-0000f870: 7379 7374 656d 2e73 706c 6974 7061 7468  system.splitpath
-0000f880: 2822 666f 6f21 6261 7222 2929 0a0a 2020  ("foo!bar"))..  
-0000f890: 2020 6465 6620 7465 7374 5f73 706c 6974    def test_split
-0000f8a0: 5f77 6974 685f 616c 745f 7365 7061 7261  _with_alt_separa
-0000f8b0: 746f 7228 7365 6c66 293a 0a20 2020 2020  tor(self):.     
-0000f8c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f8d0: 7561 6c28 2822 615e 6222 2c20 2263 2229  ual(("a^b", "c")
-0000f8e0: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
-0000f8f0: 6d2e 7370 6c69 7470 6174 6828 2261 5e62  m.splitpath("a^b
-0000f900: 5e63 2229 290a 2020 2020 2020 2020 7365  ^c")).        se
-0000f910: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-0000f920: 2261 5e62 2163 222c 2022 6422 292c 2073  "a^b!c", "d"), s
-0000f930: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
-0000f940: 706c 6974 7061 7468 2822 615e 6221 635e  plitpath("a^b!c^
-0000f950: 6422 2929 0a20 2020 2020 2020 2073 656c  d")).        sel
-0000f960: 662e 6173 7365 7274 4571 7561 6c28 2822  f.assertEqual(("
-0000f970: 615e 6221 6322 2c20 2264 2229 2c20 7365  a^b!c", "d"), se
-0000f980: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
-0000f990: 6c69 7470 6174 6828 2261 5e62 2163 2164  litpath("a^b!c!d
-0000f9a0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-0000f9b0: 2e61 7373 6572 7445 7175 616c 2828 6222  .assertEqual((b"
-0000f9c0: 615e 6222 2c20 6222 6322 292c 2073 656c  a^b", b"c"), sel
-0000f9d0: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-0000f9e0: 6974 7061 7468 2862 2261 5e62 5e63 2229  itpath(b"a^b^c")
-0000f9f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000fa00: 7373 6572 7445 7175 616c 2828 6222 615e  ssertEqual((b"a^
-0000fa10: 6221 6322 2c20 6222 6422 292c 2073 656c  b!c", b"d"), sel
-0000fa20: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-0000fa30: 6974 7061 7468 2862 2261 5e62 2163 5e64  itpath(b"a^b!c^d
-0000fa40: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-0000fa50: 2e61 7373 6572 7445 7175 616c 2828 6222  .assertEqual((b"
-0000fa60: 615e 6221 6322 2c20 6222 6422 292c 2073  a^b!c", b"d"), s
-0000fa70: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
-0000fa80: 706c 6974 7061 7468 2862 2261 5e62 2163  plitpath(b"a^b!c
-0000fa90: 2164 2229 290a 0a20 2020 2064 6566 2074  !d"))..    def t
-0000faa0: 6573 745f 7370 6c69 745f 7061 7468 5f62  est_split_path_b
-0000fab0: 7974 6573 2873 656c 6629 3a0a 2020 2020  ytes(self):.    
-0000fac0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fad0: 7175 616c 2828 6222 633a 2166 6f6f 222c  qual((b"c:!foo",
-0000fae0: 2062 2262 6172 2229 2c20 7365 6c66 2e66   b"bar"), self.f
-0000faf0: 696c 6573 7973 7465 6d2e 7370 6c69 7470  ilesystem.splitp
-0000fb00: 6174 6828 6222 633a 2166 6f6f 2162 6172  ath(b"c:!foo!bar
-0000fb10: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-0000fb20: 2e61 7373 6572 7445 7175 616c 2828 6222  .assertEqual((b"
-0000fb30: 633a 2122 2c20 6222 666f 6f22 292c 2073  c:!", b"foo"), s
-0000fb40: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
-0000fb50: 706c 6974 7061 7468 2862 2263 3a21 666f  plitpath(b"c:!fo
-0000fb60: 6f22 2929 0a20 2020 2020 2020 2073 656c  o")).        sel
-0000fb70: 662e 6173 7365 7274 4571 7561 6c28 2862  f.assertEqual((b
-0000fb80: 2221 666f 6f22 2c20 6222 6261 7222 292c  "!foo", b"bar"),
-0000fb90: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0000fba0: 2e73 706c 6974 7061 7468 2862 2221 666f  .splitpath(b"!fo
-0000fbb0: 6f21 6261 7222 2929 0a20 2020 2020 2020  o!bar")).       
-0000fbc0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000fbd0: 6c28 2862 2221 222c 2062 2266 6f6f 2229  l((b"!", b"foo")
-0000fbe0: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
-0000fbf0: 6d2e 7370 6c69 7470 6174 6828 6222 2166  m.splitpath(b"!f
-0000fc00: 6f6f 2229 290a 2020 2020 2020 2020 7365  oo")).        se
-0000fc10: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-0000fc20: 6222 633a 666f 6f22 2c20 6222 6261 7222  b"c:foo", b"bar"
-0000fc30: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-0000fc40: 656d 2e73 706c 6974 7061 7468 2862 2263  em.splitpath(b"c
-0000fc50: 3a66 6f6f 2162 6172 2229 290a 2020 2020  :foo!bar")).    
-0000fc60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fc70: 7175 616c 2828 6222 633a 222c 2062 2266  qual((b"c:", b"f
-0000fc80: 6f6f 2229 2c20 7365 6c66 2e66 696c 6573  oo"), self.files
-0000fc90: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
-0000fca0: 6222 633a 666f 6f22 2929 0a20 2020 2020  b"c:foo")).     
-0000fcb0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000fcc0: 7561 6c28 2862 2266 6f6f 222c 2062 2262  ual((b"foo", b"b
-0000fcd0: 6172 2229 2c20 7365 6c66 2e66 696c 6573  ar"), self.files
-0000fce0: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
-0000fcf0: 6222 666f 6f21 6261 7222 2929 0a0a 2020  b"foo!bar"))..  
-0000fd00: 2020 6465 6620 7465 7374 5f63 6861 7261    def test_chara
-0000fd10: 6374 6572 735f 6265 666f 7265 5f72 6f6f  cters_before_roo
-0000fd20: 745f 6967 6e6f 7265 645f 696e 5f6a 6f69  t_ignored_in_joi
-0000fd30: 6e5f 7061 7468 7328 7365 6c66 293a 0a20  n_paths(self):. 
-0000fd40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000fd50: 7274 4571 7561 6c28 2263 3a64 222c 2073  rtEqual("c:d", s
-0000fd60: 656c 662e 6669 6c65 7379 7374 656d 2e6a  elf.filesystem.j
-0000fd70: 6f69 6e70 6174 6873 2822 6222 2c20 2263  oinpaths("b", "c
-0000fd80: 3a22 2c20 2264 2229 290a 0a20 2020 2064  :", "d"))..    d
-0000fd90: 6566 2074 6573 745f 7265 736f 6c76 655f  ef test_resolve_
-0000fda0: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
-0000fdb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fdc0: 7175 616c 2822 433a 2166 6f6f 2162 6172  qual("C:!foo!bar
-0000fdd0: 222c 2073 656c 662e 6669 6c65 7379 7374  ", self.filesyst
-0000fde0: 656d 2e72 6573 6f6c 7665 5f70 6174 6828  em.resolve_path(
-0000fdf0: 2243 3a21 666f 6f21 6261 7222 2929 0a0a  "C:!foo!bar"))..
-0000fe00: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0000fe10: 5f70 6174 685f 636f 6d70 6f6e 656e 7473  _path_components
-0000fe20: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000fe30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000fe40: 280a 2020 2020 2020 2020 2020 2020 5b22  (.            ["
-0000fe50: 633a 222c 2022 666f 6f22 2c20 2262 6172  c:", "foo", "bar
-0000fe60: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-0000fe70: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-0000fe80: 5f70 6174 685f 636f 6d70 6f6e 656e 7473  _path_components
-0000fe90: 2822 633a 2166 6f6f 2162 6172 2229 2c0a  ("c:!foo!bar"),.
-0000fea0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000feb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000fec0: 616c 285b 2263 3a22 5d2c 2073 656c 662e  al(["c:"], self.
-0000fed0: 6669 6c65 7379 7374 656d 2e5f 7061 7468  filesystem._path
-0000fee0: 5f63 6f6d 706f 6e65 6e74 7328 2263 3a22  _components("c:"
-0000fef0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-0000ff00: 5f73 706c 6974 5f64 7269 7665 5f73 7472  _split_drive_str
-0000ff10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000ff20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ff30: 2828 2263 3a22 2c20 2221 666f 6f21 6261  (("c:", "!foo!ba
-0000ff40: 7222 292c 2073 656c 662e 6669 6c65 7379  r"), self.filesy
-0000ff50: 7374 656d 2e73 706c 6974 6472 6976 6528  stem.splitdrive(
-0000ff60: 2263 3a21 666f 6f21 6261 7222 2929 0a20  "c:!foo!bar")). 
-0000ff70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ff80: 7274 4571 7561 6c28 2822 222c 2022 2166  rtEqual(("", "!f
-0000ff90: 6f6f 2162 6172 2229 2c20 7365 6c66 2e66  oo!bar"), self.f
-0000ffa0: 696c 6573 7973 7465 6d2e 7370 6c69 7464  ilesystem.splitd
-0000ffb0: 7269 7665 2822 2166 6f6f 2162 6172 2229  rive("!foo!bar")
-0000ffc0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000ffd0: 7373 6572 7445 7175 616c 2828 2263 3a22  ssertEqual(("c:"
-0000ffe0: 2c20 2266 6f6f 2162 6172 2229 2c20 7365  , "foo!bar"), se
-0000fff0: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
-00010000: 6c69 7464 7269 7665 2822 633a 666f 6f21  litdrive("c:foo!
-00010010: 6261 7222 2929 0a20 2020 2020 2020 2073  bar")).        s
-00010020: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010030: 2822 222c 2022 666f 6f21 6261 7222 292c  ("", "foo!bar"),
-00010040: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00010050: 2e73 706c 6974 6472 6976 6528 2266 6f6f  .splitdrive("foo
-00010060: 2162 6172 2229 290a 0a20 2020 2064 6566  !bar"))..    def
-00010070: 2074 6573 745f 7370 6c69 745f 6472 6976   test_split_driv
-00010080: 655f 6279 7465 7328 7365 6c66 293a 0a20  e_bytes(self):. 
-00010090: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000100a0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-000100b0: 2020 2020 2028 6222 633a 222c 2062 2221       (b"c:", b"!
-000100c0: 666f 6f21 6261 7222 292c 2073 656c 662e  foo!bar"), self.
-000100d0: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-000100e0: 6472 6976 6528 6222 633a 2166 6f6f 2162  drive(b"c:!foo!b
-000100f0: 6172 2229 0a20 2020 2020 2020 2029 0a20  ar").        ). 
-00010100: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010110: 7274 4571 7561 6c28 2862 2222 2c20 6222  rtEqual((b"", b"
-00010120: 2166 6f6f 2162 6172 2229 2c20 7365 6c66  !foo!bar"), self
-00010130: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-00010140: 7464 7269 7665 2862 2221 666f 6f21 6261  tdrive(b"!foo!ba
-00010150: 7222 2929 0a0a 2020 2020 6465 6620 7465  r"))..    def te
-00010160: 7374 5f73 706c 6974 5f64 7269 7665 5f61  st_split_drive_a
-00010170: 6c74 5f73 6570 2873 656c 6629 3a0a 2020  lt_sep(self):.  
-00010180: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010190: 7445 7175 616c 2828 2263 3a22 2c20 225e  tEqual(("c:", "^
-000101a0: 666f 6f5e 6261 7222 292c 2073 656c 662e  foo^bar"), self.
-000101b0: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-000101c0: 6472 6976 6528 2263 3a5e 666f 6f5e 6261  drive("c:^foo^ba
-000101d0: 7222 2929 0a20 2020 2020 2020 2073 656c  r")).        sel
-000101e0: 662e 6173 7365 7274 4571 7561 6c28 2822  f.assertEqual(("
-000101f0: 222c 2022 666f 6f5e 6261 7222 292c 2073  ", "foo^bar"), s
-00010200: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
-00010210: 706c 6974 6472 6976 6528 2266 6f6f 5e62  plitdrive("foo^b
-00010220: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
-00010230: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-00010240: 2222 2c20 2266 6f6f 5e62 6172 2162 617a  "", "foo^bar!baz
-00010250: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
-00010260: 7465 6d2e 7370 6c69 7464 7269 7665 2822  tem.splitdrive("
-00010270: 666f 6f5e 6261 7221 6261 7a22 2929 0a20  foo^bar!baz")). 
-00010280: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010290: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-000102a0: 2020 2020 2028 6222 633a 222c 2062 225e       (b"c:", b"^
-000102b0: 666f 6f5e 6261 7222 292c 2073 656c 662e  foo^bar"), self.
-000102c0: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-000102d0: 6472 6976 6528 6222 633a 5e66 6f6f 5e62  drive(b"c:^foo^b
-000102e0: 6172 2229 0a20 2020 2020 2020 2029 0a20  ar").        ). 
-000102f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010300: 7274 4571 7561 6c28 2862 2222 2c20 6222  rtEqual((b"", b"
-00010310: 5e66 6f6f 5e62 6172 2229 2c20 7365 6c66  ^foo^bar"), self
-00010320: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-00010330: 7464 7269 7665 2862 225e 666f 6f5e 6261  tdrive(b"^foo^ba
-00010340: 7222 2929 0a20 2020 2020 2020 2073 656c  r")).        sel
-00010350: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00010360: 2020 2020 2020 2020 2020 2028 6222 222c             (b"",
-00010370: 2062 225e 666f 6f5e 6261 7221 6261 7a22   b"^foo^bar!baz"
-00010380: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-00010390: 656d 2e73 706c 6974 6472 6976 6528 6222  em.splitdrive(b"
-000103a0: 5e66 6f6f 5e62 6172 2162 617a 2229 0a20  ^foo^bar!baz"). 
-000103b0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000103c0: 6620 7465 7374 5f73 706c 6974 5f64 7269  f test_split_dri
-000103d0: 7665 5f77 6974 685f 756e 635f 7061 7468  ve_with_unc_path
-000103e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000103f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00010400: 280a 2020 2020 2020 2020 2020 2020 2822  (.            ("
-00010410: 2121 666f 6f21 6261 7222 2c20 2221 6261  !!foo!bar", "!ba
-00010420: 7a22 292c 2073 656c 662e 6669 6c65 7379  z"), self.filesy
-00010430: 7374 656d 2e73 706c 6974 6472 6976 6528  stem.splitdrive(
-00010440: 2221 2166 6f6f 2162 6172 2162 617a 2229  "!!foo!bar!baz")
-00010450: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00010460: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00010470: 7561 6c28 2822 222c 2022 2121 666f 6f22  ual(("", "!!foo"
-00010480: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-00010490: 656d 2e73 706c 6974 6472 6976 6528 2221  em.splitdrive("!
-000104a0: 2166 6f6f 2229 290a 2020 2020 2020 2020  !foo")).        
-000104b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000104c0: 2828 2222 2c20 2221 2166 6f6f 2121 6261  (("", "!!foo!!ba
-000104d0: 7222 292c 2073 656c 662e 6669 6c65 7379  r"), self.filesy
-000104e0: 7374 656d 2e73 706c 6974 6472 6976 6528  stem.splitdrive(
-000104f0: 2221 2166 6f6f 2121 6261 7222 2929 0a20  "!!foo!!bar")). 
-00010500: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010510: 7274 4571 7561 6c28 2822 2121 666f 6f21  rtEqual(("!!foo!
-00010520: 6261 7222 2c20 2221 2122 292c 2073 656c  bar", "!!"), sel
-00010530: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-00010540: 6974 6472 6976 6528 2221 2166 6f6f 2162  itdrive("!!foo!b
-00010550: 6172 2121 2229 290a 0a20 2020 2064 6566  ar!!"))..    def
-00010560: 2074 6573 745f 7370 6c69 745f 6472 6976   test_split_driv
-00010570: 655f 7769 7468 5f75 6e63 5f70 6174 685f  e_with_unc_path_
-00010580: 616c 745f 7365 7028 7365 6c66 293a 0a20  alt_sep(self):. 
-00010590: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000105a0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-000105b0: 2020 2020 2028 225e 5e66 6f6f 5e62 6172       ("^^foo^bar
-000105c0: 222c 2022 2162 617a 2229 2c20 7365 6c66  ", "!baz"), self
-000105d0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-000105e0: 7464 7269 7665 2822 5e5e 666f 6f5e 6261  tdrive("^^foo^ba
-000105f0: 7221 6261 7a22 290a 2020 2020 2020 2020  r!baz").        
-00010600: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00010610: 7373 6572 7445 7175 616c 2828 2222 2c20  ssertEqual(("", 
-00010620: 225e 5e66 6f6f 2229 2c20 7365 6c66 2e66  "^^foo"), self.f
-00010630: 696c 6573 7973 7465 6d2e 7370 6c69 7464  ilesystem.splitd
-00010640: 7269 7665 2822 5e5e 666f 6f22 2929 0a20  rive("^^foo")). 
-00010650: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010660: 7274 4571 7561 6c28 2822 222c 2022 5e5e  rtEqual(("", "^^
-00010670: 666f 6f5e 5e62 6172 2229 2c20 7365 6c66  foo^^bar"), self
-00010680: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-00010690: 7464 7269 7665 2822 5e5e 666f 6f5e 5e62  tdrive("^^foo^^b
-000106a0: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
-000106b0: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-000106c0: 225e 5e66 6f6f 5e62 6172 222c 2022 5e5e  "^^foo^bar", "^^
-000106d0: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
-000106e0: 7465 6d2e 7370 6c69 7464 7269 7665 2822  tem.splitdrive("
-000106f0: 5e5e 666f 6f5e 6261 725e 5e22 2929 0a0a  ^^foo^bar^^"))..
-00010700: 2020 2020 6465 6620 7465 7374 5f73 706c      def test_spl
-00010710: 6974 5f70 6174 685f 7769 7468 5f64 7269  it_path_with_dri
-00010720: 7665 2873 656c 6629 3a0a 2020 2020 2020  ve(self):.      
-00010730: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00010740: 616c 2828 2264 3a21 666f 6f22 2c20 2262  al(("d:!foo", "b
-00010750: 617a 2229 2c20 7365 6c66 2e66 696c 6573  az"), self.files
-00010760: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
-00010770: 2264 3a21 666f 6f21 6261 7a22 2929 0a20  "d:!foo!baz")). 
-00010780: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010790: 7274 4571 7561 6c28 2822 643a 2166 6f6f  rtEqual(("d:!foo
-000107a0: 2162 617a 222c 2022 2229 2c20 7365 6c66  !baz", ""), self
-000107b0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
-000107c0: 7470 6174 6828 2264 3a21 666f 6f21 6261  tpath("d:!foo!ba
-000107d0: 7a21 2229 290a 2020 2020 2020 2020 7365  z!")).        se
-000107e0: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-000107f0: 2263 3a22 2c20 2222 292c 2073 656c 662e  "c:", ""), self.
-00010800: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-00010810: 7061 7468 2822 633a 2229 290a 2020 2020  path("c:")).    
-00010820: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00010830: 7175 616c 2828 2263 3a21 222c 2022 2229  qual(("c:!", "")
-00010840: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
-00010850: 6d2e 7370 6c69 7470 6174 6828 2263 3a21  m.splitpath("c:!
-00010860: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-00010870: 2e61 7373 6572 7445 7175 616c 2828 2263  .assertEqual(("c
-00010880: 3a21 2122 2c20 2222 292c 2073 656c 662e  :!!", ""), self.
-00010890: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-000108a0: 7061 7468 2822 633a 2121 2229 290a 0a20  path("c:!!")).. 
-000108b0: 2020 2064 6566 2074 6573 745f 7370 6c69     def test_spli
-000108c0: 745f 7061 7468 5f77 6974 685f 6472 6976  t_path_with_driv
-000108d0: 655f 616c 745f 7365 7028 7365 6c66 293a  e_alt_sep(self):
-000108e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000108f0: 7365 7274 4571 7561 6c28 2822 643a 5e66  sertEqual(("d:^f
-00010900: 6f6f 222c 2022 6261 7a22 292c 2073 656c  oo", "baz"), sel
-00010910: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-00010920: 6974 7061 7468 2822 643a 5e66 6f6f 5e62  itpath("d:^foo^b
-00010930: 617a 2229 290a 2020 2020 2020 2020 7365  az")).        se
-00010940: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
-00010950: 2264 3a5e 666f 6f5e 6261 7a22 2c20 2222  "d:^foo^baz", ""
-00010960: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-00010970: 656d 2e73 706c 6974 7061 7468 2822 643a  em.splitpath("d:
-00010980: 5e66 6f6f 5e62 617a 5e22 2929 0a20 2020  ^foo^baz^")).   
-00010990: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000109a0: 4571 7561 6c28 2822 633a 222c 2022 2229  Equal(("c:", "")
-000109b0: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
-000109c0: 6d2e 7370 6c69 7470 6174 6828 2263 3a22  m.splitpath("c:"
-000109d0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-000109e0: 6173 7365 7274 4571 7561 6c28 2822 633a  assertEqual(("c:
-000109f0: 5e22 2c20 2222 292c 2073 656c 662e 6669  ^", ""), self.fi
-00010a00: 6c65 7379 7374 656d 2e73 706c 6974 7061  lesystem.splitpa
-00010a10: 7468 2822 633a 5e22 2929 0a20 2020 2020  th("c:^")).     
-00010a20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00010a30: 7561 6c28 2822 633a 5e5e 222c 2022 2229  ual(("c:^^", "")
-00010a40: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
-00010a50: 6d2e 7370 6c69 7470 6174 6828 2263 3a5e  m.splitpath("c:^
-00010a60: 5e22 2929 0a0a 2020 2020 6465 6620 7465  ^"))..    def te
-00010a70: 7374 5f73 706c 6974 5f70 6174 685f 7769  st_split_path_wi
-00010a80: 7468 5f75 6e63 5f70 6174 6828 7365 6c66  th_unc_path(self
-00010a90: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00010aa0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-00010ab0: 2020 2020 2020 2020 2028 2221 2166 6f6f           ("!!foo
-00010ac0: 2162 6172 2122 2c20 2262 617a 2229 2c20  !bar!", "baz"), 
-00010ad0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00010ae0: 7370 6c69 7470 6174 6828 2221 2166 6f6f  splitpath("!!foo
-00010af0: 2162 6172 2162 617a 2229 0a20 2020 2020  !bar!baz").     
-00010b00: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00010b10: 662e 6173 7365 7274 4571 7561 6c28 2822  f.assertEqual(("
-00010b20: 2121 666f 6f21 6261 7222 2c20 2222 292c  !!foo!bar", ""),
-00010b30: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00010b40: 2e73 706c 6974 7061 7468 2822 2121 666f  .splitpath("!!fo
-00010b50: 6f21 6261 7222 2929 0a20 2020 2020 2020  o!bar")).       
-00010b60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00010b70: 6c28 2822 2121 666f 6f21 6261 7221 2122  l(("!!foo!bar!!"
-00010b80: 2c20 2222 292c 2073 656c 662e 6669 6c65  , ""), self.file
-00010b90: 7379 7374 656d 2e73 706c 6974 7061 7468  system.splitpath
-00010ba0: 2822 2121 666f 6f21 6261 7221 2122 2929  ("!!foo!bar!!"))
-00010bb0: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-00010bc0: 706c 6974 5f70 6174 685f 7769 7468 5f75  plit_path_with_u
-00010bd0: 6e63 5f70 6174 685f 616c 745f 7365 7028  nc_path_alt_sep(
-00010be0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00010bf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010c00: 0a20 2020 2020 2020 2020 2020 2028 225e  .            ("^
-00010c10: 5e66 6f6f 5e62 6172 5e22 2c20 2262 617a  ^foo^bar^", "baz
-00010c20: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
-00010c30: 7465 6d2e 7370 6c69 7470 6174 6828 225e  tem.splitpath("^
-00010c40: 5e66 6f6f 5e62 6172 5e62 617a 2229 0a20  ^foo^bar^baz"). 
-00010c50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010c60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00010c70: 6c28 2822 5e5e 666f 6f5e 6261 7222 2c20  l(("^^foo^bar", 
-00010c80: 2222 292c 2073 656c 662e 6669 6c65 7379  ""), self.filesy
-00010c90: 7374 656d 2e73 706c 6974 7061 7468 2822  stem.splitpath("
-00010ca0: 5e5e 666f 6f5e 6261 7222 2929 0a20 2020  ^^foo^bar")).   
-00010cb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010cc0: 4571 7561 6c28 2822 5e5e 666f 6f5e 6261  Equal(("^^foo^ba
-00010cd0: 725e 5e22 2c20 2222 292c 2073 656c 662e  r^^", ""), self.
-00010ce0: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
-00010cf0: 7061 7468 2822 5e5e 666f 6f5e 6261 725e  path("^^foo^bar^
-00010d00: 5e22 2929 0a0a 2020 2020 6465 6620 7465  ^"))..    def te
-00010d10: 7374 5f73 706c 6974 726f 6f74 5f77 6974  st_splitroot_wit
-00010d20: 685f 6472 6976 6528 7365 6c66 293a 0a20  h_drive(self):. 
-00010d30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010d40: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-00010d50: 2020 2020 2028 2245 3a22 2c20 2221 222c       ("E:", "!",
-00010d60: 2022 666f 6f21 6261 7222 292c 2073 656c   "foo!bar"), sel
-00010d70: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-00010d80: 6974 726f 6f74 2822 453a 2166 6f6f 2162  itroot("E:!foo!b
-00010d90: 6172 2229 0a20 2020 2020 2020 2029 0a20  ar").        ). 
-00010da0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010db0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-00010dc0: 2020 2020 2028 2245 3a22 2c20 2221 222c       ("E:", "!",
-00010dd0: 2022 2166 6f6f 2121 2162 6172 2229 2c20   "!foo!!!bar"), 
-00010de0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00010df0: 7370 6c69 7472 6f6f 7428 2245 3a21 2166  splitroot("E:!!f
-00010e00: 6f6f 2121 2162 6172 2229 0a20 2020 2020  oo!!!bar").     
-00010e10: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00010e20: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00010e30: 2020 2020 2020 2020 2020 2028 6222 453a             (b"E:
-00010e40: 222c 2062 2221 222c 2062 2221 666f 6f21  ", b"!", b"!foo!
-00010e50: 2121 6261 7222 292c 2073 656c 662e 6669  !!bar"), self.fi
-00010e60: 6c65 7379 7374 656d 2e73 706c 6974 726f  lesystem.splitro
-00010e70: 6f74 2862 2245 3a21 2166 6f6f 2121 2162  ot(b"E:!!foo!!!b
-00010e80: 6172 2229 0a20 2020 2020 2020 2029 0a20  ar").        ). 
-00010e90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010ea0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-00010eb0: 2020 2020 2028 2243 3a22 2c20 225e 222c       ("C:", "^",
-00010ec0: 2022 666f 6f5e 6261 7222 292c 2073 656c   "foo^bar"), sel
-00010ed0: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-00010ee0: 6974 726f 6f74 2822 433a 5e66 6f6f 5e62  itroot("C:^foo^b
-00010ef0: 6172 2229 0a20 2020 2020 2020 2029 0a0a  ar").        )..
-00010f00: 2020 2020 6465 6620 7465 7374 5f73 706c      def test_spl
-00010f10: 6974 726f 6f74 5f77 6974 685f 756e 635f  itroot_with_unc_
-00010f20: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
-00010f30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00010f40: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00010f50: 2020 2822 2121 666f 6f21 6261 7222 2c20    ("!!foo!bar", 
-00010f60: 2221 222c 2022 6261 7a22 292c 2073 656c  "!", "baz"), sel
-00010f70: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-00010f80: 6974 726f 6f74 2822 2121 666f 6f21 6261  itroot("!!foo!ba
-00010f90: 7221 6261 7a22 290a 2020 2020 2020 2020  r!baz").        
-00010fa0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00010fb0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-00010fc0: 2020 2020 2020 2020 2822 2121 3f21 554e          ("!!?!UN
-00010fd0: 4322 2c20 2221 222c 2022 666f 6f21 6261  C", "!", "foo!ba
-00010fe0: 7222 292c 2073 656c 662e 6669 6c65 7379  r"), self.filesy
-00010ff0: 7374 656d 2e73 706c 6974 726f 6f74 2822  stem.splitroot("
-00011000: 2121 3f21 554e 4321 666f 6f21 6261 7222  !!?!UNC!foo!bar"
-00011010: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00011020: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011030: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00011040: 2020 2822 5e5e 666f 6f5e 6261 7222 2c20    ("^^foo^bar", 
-00011050: 225e 222c 2022 6261 7a22 292c 2073 656c  "^", "baz"), sel
-00011060: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-00011070: 6974 726f 6f74 2822 5e5e 666f 6f5e 6261  itroot("^^foo^ba
-00011080: 725e 6261 7a22 290a 2020 2020 2020 2020  r^baz").        
-00011090: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000110a0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-000110b0: 2020 2020 2020 2020 2862 2221 2166 6f6f          (b"!!foo
-000110c0: 2162 6172 222c 2062 2221 222c 2062 2262  !bar", b"!", b"b
-000110d0: 617a 2229 2c20 7365 6c66 2e66 696c 6573  az"), self.files
-000110e0: 7973 7465 6d2e 7370 6c69 7472 6f6f 7428  ystem.splitroot(
-000110f0: 6222 2121 666f 6f21 6261 7221 6261 7a22  b"!!foo!bar!baz"
-00011100: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-00011110: 2064 6566 2074 6573 745f 7370 6c69 7472   def test_splitr
-00011120: 6f6f 745f 7769 7468 5f65 6d70 7479 5f70  oot_with_empty_p
-00011130: 6172 7473 2873 656c 6629 3a0a 2020 2020  arts(self):.    
-00011140: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011150: 7175 616c 2828 2222 2c20 2222 2c20 2222  qual(("", "", ""
-00011160: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
-00011170: 656d 2e73 706c 6974 726f 6f74 2822 2229  em.splitroot("")
-00011180: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011190: 7373 6572 7445 7175 616c 2828 2222 2c20  ssertEqual(("", 
-000111a0: 2221 222c 2022 666f 6f22 292c 2073 656c  "!", "foo"), sel
-000111b0: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
-000111c0: 6974 726f 6f74 2822 2166 6f6f 2229 290a  itroot("!foo")).
-000111d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000111e0: 6572 7445 7175 616c 2828 2221 2166 6f6f  ertEqual(("!!foo
-000111f0: 2162 6172 222c 2022 222c 2022 2229 2c20  !bar", "", ""), 
-00011200: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00011210: 7370 6c69 7472 6f6f 7428 2221 2166 6f6f  splitroot("!!foo
-00011220: 2162 6172 2229 290a 2020 2020 2020 2020  !bar")).        
-00011230: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00011240: 2828 2221 2166 6f6f 222c 2022 222c 2022  (("!!foo", "", "
-00011250: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
-00011260: 7465 6d2e 7370 6c69 7472 6f6f 7428 2221  tem.splitroot("!
-00011270: 2166 6f6f 2229 290a 2020 2020 2020 2020  !foo")).        
-00011280: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00011290: 280a 2020 2020 2020 2020 2020 2020 2822  (.            ("
-000112a0: 2121 666f 6f21 6261 7222 2c20 2221 222c  !!foo!bar", "!",
-000112b0: 2022 2229 2c20 7365 6c66 2e66 696c 6573   ""), self.files
-000112c0: 7973 7465 6d2e 7370 6c69 7472 6f6f 7428  ystem.splitroot(
-000112d0: 2221 2166 6f6f 2162 6172 2122 290a 2020  "!!foo!bar!").  
-000112e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000112f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00011300: 2828 2243 3a22 2c20 2222 2c20 2266 6f6f  (("C:", "", "foo
-00011310: 2162 6172 2229 2c20 7365 6c66 2e66 696c  !bar"), self.fil
-00011320: 6573 7973 7465 6d2e 7370 6c69 7472 6f6f  esystem.splitroo
-00011330: 7428 2243 3a66 6f6f 2162 6172 2229 290a  t("C:foo!bar")).
-00011340: 0a0a 636c 6173 7320 4469 736b 5370 6163  ..class DiskSpac
-00011350: 6554 6573 7428 5465 7374 4361 7365 293a  eTest(TestCase):
-00011360: 0a20 2020 2064 6566 2073 6574 5570 2873  .    def setUp(s
-00011370: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00011380: 6c66 2e66 7320 3d20 6661 6b65 5f66 696c  lf.fs = fake_fil
-00011390: 6573 7973 7465 6d2e 4661 6b65 4669 6c65  esystem.FakeFile
-000113a0: 7379 7374 656d 2870 6174 685f 7365 7061  system(path_sepa
-000113b0: 7261 746f 723d 2221 222c 2074 6f74 616c  rator="!", total
-000113c0: 5f73 697a 653d 3130 3029 0a20 2020 2020  _size=100).     
-000113d0: 2020 2073 656c 662e 6f73 203d 2066 616b     self.os = fak
-000113e0: 655f 6f73 2e46 616b 654f 734d 6f64 756c  e_os.FakeOsModul
-000113f0: 6528 7365 6c66 2e66 7329 0a20 2020 2020  e(self.fs).     
-00011400: 2020 2073 656c 662e 6f70 656e 203d 2066     self.open = f
-00011410: 616b 655f 6f70 656e 2e46 616b 6546 696c  ake_open.FakeFil
-00011420: 654f 7065 6e28 7365 6c66 2e66 7329 0a0a  eOpen(self.fs)..
-00011430: 2020 2020 6465 6620 7465 7374 5f64 6973      def test_dis
-00011440: 6b5f 7573 6167 655f 6f6e 5f66 696c 655f  k_usage_on_file_
-00011450: 6372 6561 7469 6f6e 2873 656c 6629 3a0a  creation(self):.
-00011460: 2020 2020 2020 2020 746f 7461 6c5f 7369          total_si
-00011470: 7a65 203d 2031 3030 0a20 2020 2020 2020  ze = 100.       
-00011480: 2073 656c 662e 6673 2e61 6464 5f6d 6f75   self.fs.add_mou
-00011490: 6e74 5f70 6f69 6e74 2822 216d 6f75 6e74  nt_point("!mount
-000114a0: 222c 2074 6f74 616c 5f73 697a 6529 0a0a  ", total_size)..
-000114b0: 2020 2020 2020 2020 6465 6620 6372 6561          def crea
-000114c0: 7465 5f74 6f6f 5f6c 6172 6765 5f66 696c  te_too_large_fil
-000114d0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-000114e0: 2077 6974 6820 7365 6c66 2e6f 7065 6e28   with self.open(
-000114f0: 2221 6d6f 756e 7421 6669 6c65 222c 2022  "!mount!file", "
-00011500: 7722 2920 6173 2064 6573 743a 0a20 2020  w") as dest:.   
-00011510: 2020 2020 2020 2020 2020 2020 2064 6573               des
-00011520: 742e 7772 6974 6528 2261 2220 2a20 2874  t.write("a" * (t
-00011530: 6f74 616c 5f73 697a 6520 2b20 3129 290a  otal_size + 1)).
-00011540: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00011550: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00011560: 4f53 4572 726f 7229 3a0a 2020 2020 2020  OSError):.      
-00011570: 2020 2020 2020 6372 6561 7465 5f74 6f6f        create_too
-00011580: 5f6c 6172 6765 5f66 696c 6528 290a 0a20  _large_file().. 
-00011590: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000115a0: 7274 4571 7561 6c28 302c 2073 656c 662e  rtEqual(0, self.
-000115b0: 6673 2e67 6574 5f64 6973 6b5f 7573 6167  fs.get_disk_usag
-000115c0: 6528 2221 6d6f 756e 7422 292e 7573 6564  e("!mount").used
-000115d0: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-000115e0: 7365 6c66 2e6f 7065 6e28 2221 6d6f 756e  self.open("!moun
-000115f0: 7421 6669 6c65 222c 2022 7722 2920 6173  t!file", "w") as
-00011600: 2064 6573 743a 0a20 2020 2020 2020 2020   dest:.         
-00011610: 2020 2064 6573 742e 7772 6974 6528 2261     dest.write("a
-00011620: 2220 2a20 746f 7461 6c5f 7369 7a65 290a  " * total_size).
-00011630: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00011640: 7365 7274 4571 7561 6c28 746f 7461 6c5f  sertEqual(total_
-00011650: 7369 7a65 2c20 7365 6c66 2e66 732e 6765  size, self.fs.ge
-00011660: 745f 6469 736b 5f75 7361 6765 2822 216d  t_disk_usage("!m
-00011670: 6f75 6e74 2229 2e75 7365 6429 0a0a 2020  ount").used)..  
-00011680: 2020 6465 6620 7465 7374 5f64 6973 6b5f    def test_disk_
-00011690: 7573 6167 655f 6f6e 5f61 7574 6f6d 6f75  usage_on_automou
-000116a0: 6e74 6564 5f64 7269 7665 2873 656c 6629  nted_drive(self)
-000116b0: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-000116c0: 732e 6973 5f77 696e 646f 7773 5f66 7320  s.is_windows_fs 
-000116d0: 3d20 5472 7565 0a20 2020 2020 2020 2073  = True.        s
-000116e0: 656c 662e 6673 2e72 6573 6574 2874 6f74  elf.fs.reset(tot
-000116f0: 616c 5f73 697a 653d 3130 3029 0a20 2020  al_size=100).   
-00011700: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
-00011710: 6174 655f 6669 6c65 2822 2166 6f6f 2162  ate_file("!foo!b
-00011720: 6172 222c 2073 745f 7369 7a65 3d35 3029  ar", st_size=50)
-00011730: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00011740: 7365 7274 4571 7561 6c28 302c 2073 656c  sertEqual(0, sel
-00011750: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
-00011760: 6167 6528 2244 3a21 2229 2e75 7365 6429  age("D:!").used)
-00011770: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-00011780: 2e63 7764 203d 2022 453a 2166 6f6f 220a  .cwd = "E:!foo".
-00011790: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000117a0: 6572 7445 7175 616c 2830 2c20 7365 6c66  ertEqual(0, self
-000117b0: 2e66 732e 6765 745f 6469 736b 5f75 7361  .fs.get_disk_usa
-000117c0: 6765 2822 2166 6f6f 2229 2e75 7365 6429  ge("!foo").used)
-000117d0: 0a0a 2020 2020 6465 6620 7465 7374 5f64  ..    def test_d
-000117e0: 6973 6b5f 7573 6167 655f 6f6e 5f6d 6f75  isk_usage_on_mou
-000117f0: 6e74 6564 5f70 6174 6873 2873 656c 6629  nted_paths(self)
-00011800: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-00011810: 732e 6164 645f 6d6f 756e 745f 706f 696e  s.add_mount_poin
-00011820: 7428 2221 666f 6f22 2c20 746f 7461 6c5f  t("!foo", total_
-00011830: 7369 7a65 3d32 3030 290a 2020 2020 2020  size=200).      
-00011840: 2020 7365 6c66 2e66 732e 6164 645f 6d6f    self.fs.add_mo
-00011850: 756e 745f 706f 696e 7428 2221 666f 6f21  unt_point("!foo!
-00011860: 6261 7222 2c20 746f 7461 6c5f 7369 7a65  bar", total_size
-00011870: 3d34 3030 290a 2020 2020 2020 2020 7365  =400).        se
-00011880: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00011890: 6528 2221 6261 7a22 2c20 7374 5f73 697a  e("!baz", st_siz
-000118a0: 653d 3530 290a 2020 2020 2020 2020 7365  e=50).        se
-000118b0: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-000118c0: 6528 2221 666f 6f21 6261 7a22 2c20 7374  e("!foo!baz", st
-000118d0: 5f73 697a 653d 3630 290a 2020 2020 2020  _size=60).      
-000118e0: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-000118f0: 5f66 696c 6528 2221 666f 6f21 6261 7221  _file("!foo!bar!
-00011900: 6261 7a22 2c20 7374 5f73 697a 653d 3130  baz", st_size=10
-00011910: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-00011920: 6173 7365 7274 4571 7561 6c28 3530 2c20  assertEqual(50, 
-00011930: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
-00011940: 5f75 7361 6765 2822 2122 292e 7573 6564  _usage("!").used
-00011950: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011960: 7373 6572 7445 7175 616c 2836 302c 2073  ssertEqual(60, s
-00011970: 656c 662e 6673 2e67 6574 5f64 6973 6b5f  elf.fs.get_disk_
-00011980: 7573 6167 6528 2221 666f 6f22 292e 7573  usage("!foo").us
-00011990: 6564 290a 2020 2020 2020 2020 7365 6c66  ed).        self
-000119a0: 2e61 7373 6572 7445 7175 616c 2831 3030  .assertEqual(100
-000119b0: 2c20 7365 6c66 2e66 732e 6765 745f 6469  , self.fs.get_di
-000119c0: 736b 5f75 7361 6765 2822 2166 6f6f 2162  sk_usage("!foo!b
-000119d0: 6172 2229 2e75 7365 6429 0a20 2020 2020  ar").used).     
-000119e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000119f0: 7561 6c28 3430 302c 2073 656c 662e 6673  ual(400, self.fs
-00011a00: 2e67 6574 5f64 6973 6b5f 7573 6167 6528  .get_disk_usage(
-00011a10: 2221 666f 6f21 6261 7222 292e 746f 7461  "!foo!bar").tota
-00011a20: 6c29 0a0a 2020 2020 6465 6620 7465 7374  l)..    def test
-00011a30: 5f66 696c 655f 7379 7374 656d 5f73 697a  _file_system_siz
-00011a40: 655f 6166 7465 725f 6c61 7267 655f 6669  e_after_large_fi
-00011a50: 6c65 5f63 7265 6174 696f 6e28 7365 6c66  le_creation(self
-00011a60: 293a 0a20 2020 2020 2020 2066 696c 6573  ):.        files
-00011a70: 7973 7465 6d20 3d20 6661 6b65 5f66 696c  ystem = fake_fil
-00011a80: 6573 7973 7465 6d2e 4661 6b65 4669 6c65  esystem.FakeFile
-00011a90: 7379 7374 656d 280a 2020 2020 2020 2020  system(.        
-00011aa0: 2020 2020 7061 7468 5f73 6570 6172 6174      path_separat
-00011ab0: 6f72 3d22 2122 2c20 746f 7461 6c5f 7369  or="!", total_si
-00011ac0: 7a65 3d31 3032 3420 2a20 3130 3234 202a  ze=1024 * 1024 *
-00011ad0: 2031 3032 3420 2a20 3130 300a 2020 2020   1024 * 100.    
-00011ae0: 2020 2020 290a 2020 2020 2020 2020 6669      ).        fi
-00011af0: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-00011b00: 6669 6c65 2822 2166 6f6f 2162 617a 222c  file("!foo!baz",
-00011b10: 2073 745f 7369 7a65 3d31 3032 3420 2a20   st_size=1024 * 
-00011b20: 3130 3234 202a 2031 3032 3420 2a20 3130  1024 * 1024 * 10
-00011b30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011b40: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-00011b50: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00011b60: 2020 2020 2020 2020 2020 3130 3234 202a            1024 *
-00011b70: 2031 3032 3420 2a20 3130 3234 202a 2031   1024 * 1024 * 1
-00011b80: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00011b90: 2020 2020 3130 3234 202a 2031 3032 3420      1024 * 1024 
-00011ba0: 2a20 3130 3234 202a 2031 302c 0a20 2020  * 1024 * 10,.   
-00011bb0: 2020 2020 2020 2020 2020 2020 2031 3032               102
-00011bc0: 3420 2a20 3130 3234 202a 2031 3032 3420  4 * 1024 * 1024 
-00011bd0: 2a20 3930 2c0a 2020 2020 2020 2020 2020  * 90,.          
-00011be0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00011bf0: 2066 696c 6573 7973 7465 6d2e 6765 745f   filesystem.get_
-00011c00: 6469 736b 5f75 7361 6765 2829 2c0a 2020  disk_usage(),.  
-00011c10: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00011c20: 2074 6573 745f 6669 6c65 5f73 7973 7465   test_file_syste
-00011c30: 6d5f 7369 7a65 5f61 6674 6572 5f62 696e  m_size_after_bin
-00011c40: 6172 795f 6669 6c65 5f63 7265 6174 696f  ary_file_creatio
-00011c50: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00011c60: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-00011c70: 6669 6c65 2822 2166 6f6f 2162 6172 222c  file("!foo!bar",
-00011c80: 2063 6f6e 7465 6e74 733d 6222 7879 7a7a   contents=b"xyzz
-00011c90: 7922 290a 2020 2020 2020 2020 7365 6c66  y").        self
-00011ca0: 2e61 7373 6572 7445 7175 616c 2828 3130  .assertEqual((10
-00011cb0: 302c 2035 2c20 3935 292c 2073 656c 662e  0, 5, 95), self.
-00011cc0: 6673 2e67 6574 5f64 6973 6b5f 7573 6167  fs.get_disk_usag
-00011cd0: 6528 2929 0a0a 2020 2020 6465 6620 7465  e())..    def te
-00011ce0: 7374 5f66 696c 655f 7379 7374 656d 5f73  st_file_system_s
-00011cf0: 697a 655f 6166 7465 725f 6173 6369 695f  ize_after_ascii_
-00011d00: 7374 7269 6e67 5f66 696c 655f 6372 6561  string_file_crea
-00011d10: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
-00011d20: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
-00011d30: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
-00011d40: 7222 2c20 636f 6e74 656e 7473 3d22 636f  r", contents="co
-00011d50: 6d70 6c69 6361 7465 6422 290a 2020 2020  mplicated").    
-00011d60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00011d70: 7175 616c 2828 3130 302c 2031 312c 2038  qual((100, 11, 8
-00011d80: 3929 2c20 7365 6c66 2e66 732e 6765 745f  9), self.fs.get_
-00011d90: 6469 736b 5f75 7361 6765 2829 290a 0a20  disk_usage()).. 
-00011da0: 2020 2064 6566 2074 6573 745f 6669 6c65     def test_file
-00011db0: 7379 7374 656d 5f73 697a 655f 6166 7465  system_size_afte
-00011dc0: 725f 3262 7974 655f 756e 6963 6f64 655f  r_2byte_unicode_
-00011dd0: 6669 6c65 5f63 7265 6174 696f 6e28 7365  file_creation(se
-00011de0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00011df0: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
-00011e00: 2822 2166 6f6f 2162 6172 222c 2063 6f6e  ("!foo!bar", con
-00011e10: 7465 6e74 733d 22d1 81d0 bbd0 bed0 b6d0  tents=".........
-00011e20: bdd0 be22 2c20 656e 636f 6469 6e67 3d22  ...", encoding="
-00011e30: 7574 662d 3822 290a 2020 2020 2020 2020  utf-8").        
-00011e40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00011e50: 2828 3130 302c 2031 322c 2038 3829 2c20  ((100, 12, 88), 
-00011e60: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
-00011e70: 5f75 7361 6765 2829 290a 0a20 2020 2064  _usage())..    d
-00011e80: 6566 2074 6573 745f 6669 6c65 7379 7374  ef test_filesyst
-00011e90: 656d 5f73 697a 655f 6166 7465 725f 3362  em_size_after_3b
-00011ea0: 7974 655f 756e 6963 6f64 655f 6669 6c65  yte_unicode_file
-00011eb0: 5f63 7265 6174 696f 6e28 7365 6c66 293a  _creation(self):
-00011ec0: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-00011ed0: 2e63 7265 6174 655f 6669 6c65 2822 2166  .create_file("!f
-00011ee0: 6f6f 2162 6172 222c 2063 6f6e 7465 6e74  oo!bar", content
-00011ef0: 733d 22e8 a487 e99b 9122 2c20 656e 636f  s="......", enco
-00011f00: 6469 6e67 3d22 7574 662d 3822 290a 2020  ding="utf-8").  
-00011f10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00011f20: 7445 7175 616c 2828 3130 302c 2036 2c20  tEqual((100, 6, 
-00011f30: 3934 292c 2073 656c 662e 6673 2e67 6574  94), self.fs.get
-00011f40: 5f64 6973 6b5f 7573 6167 6528 2929 0a0a  _disk_usage())..
-00011f50: 2020 2020 6465 6620 7465 7374 5f66 696c      def test_fil
-00011f60: 655f 7379 7374 656d 5f73 697a 655f 6166  e_system_size_af
-00011f70: 7465 725f 6669 6c65 5f64 656c 6574 696f  ter_file_deletio
-00011f80: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00011f90: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-00011fa0: 6669 6c65 2822 2166 6f6f 2162 6172 222c  file("!foo!bar",
-00011fb0: 2063 6f6e 7465 6e74 733d 6222 7879 7a7a   contents=b"xyzz
-00011fc0: 7922 290a 2020 2020 2020 2020 7365 6c66  y").        self
-00011fd0: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
-00011fe0: 2221 666f 6f21 6261 7a22 2c20 7374 5f73  "!foo!baz", st_s
-00011ff0: 697a 653d 3230 290a 2020 2020 2020 2020  ize=20).        
-00012000: 7365 6c66 2e66 732e 7265 6d6f 7665 5f6f  self.fs.remove_o
-00012010: 626a 6563 7428 2221 666f 6f21 6261 7222  bject("!foo!bar"
-00012020: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00012030: 7373 6572 7445 7175 616c 2828 3130 302c  ssertEqual((100,
-00012040: 2032 302c 2038 3029 2c20 7365 6c66 2e66   20, 80), self.f
-00012050: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
-00012060: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
-00012070: 745f 6669 6c65 5f73 7973 7465 6d5f 7369  t_file_system_si
-00012080: 7a65 5f61 6674 6572 5f64 6972 6563 746f  ze_after_directo
-00012090: 7279 5f72 656d 6f76 616c 2873 656c 6629  ry_removal(self)
-000120a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-000120b0: 732e 6372 6561 7465 5f66 696c 6528 2221  s.create_file("!
-000120c0: 666f 6f21 6261 7222 2c20 7374 5f73 697a  foo!bar", st_siz
-000120d0: 653d 3130 290a 2020 2020 2020 2020 7365  e=10).        se
-000120e0: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-000120f0: 6528 2221 666f 6f21 6261 7a22 2c20 7374  e("!foo!baz", st
-00012100: 5f73 697a 653d 3230 290a 2020 2020 2020  _size=20).      
-00012110: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-00012120: 5f66 696c 6528 2221 666f 6f31 2162 6172  _file("!foo1!bar
-00012130: 222c 2073 745f 7369 7a65 3d34 3029 0a20  ", st_size=40). 
-00012140: 2020 2020 2020 2073 656c 662e 6673 2e72         self.fs.r
-00012150: 656d 6f76 655f 6f62 6a65 6374 2822 2166  emove_object("!f
-00012160: 6f6f 2229 0a20 2020 2020 2020 2073 656c  oo").        sel
-00012170: 662e 6173 7365 7274 4571 7561 6c28 2831  f.assertEqual((1
-00012180: 3030 2c20 3430 2c20 3630 292c 2073 656c  00, 40, 60), sel
-00012190: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
-000121a0: 6167 6528 2929 0a0a 2020 2020 6465 6620  age())..    def 
-000121b0: 7465 7374 5f63 7265 6174 696e 675f 6669  test_creating_fi
-000121c0: 6c65 5f77 6974 685f 6669 7474 696e 675f  le_with_fitting_
-000121d0: 636f 6e74 656e 7428 7365 6c66 293a 0a20  content(self):. 
-000121e0: 2020 2020 2020 2069 6e69 7469 616c 5f75         initial_u
-000121f0: 7361 6765 203d 2073 656c 662e 6673 2e67  sage = self.fs.g
-00012200: 6574 5f64 6973 6b5f 7573 6167 6528 290a  et_disk_usage().
-00012210: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00012220: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-00012230: 732e 6372 6561 7465 5f66 696c 6528 2221  s.create_file("!
-00012240: 666f 6f21 6261 7222 2c20 636f 6e74 656e  foo!bar", conten
-00012250: 7473 3d62 2261 2220 2a20 3130 3029 0a20  ts=b"a" * 100). 
-00012260: 2020 2020 2020 2065 7863 6570 7420 4f53         except OS
-00012270: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00012280: 2020 2073 656c 662e 6661 696c 280a 2020     self.fail(.  
-00012290: 2020 2020 2020 2020 2020 2020 2020 2246                "F
-000122a0: 696c 6520 7769 7468 2063 6f6e 7465 6e74  ile with content
-000122b0: 7320 6669 7474 696e 6720 696e 746f 2064  s fitting into d
-000122c0: 6973 6b20 7370 6163 6520 2220 2263 6f75  isk space " "cou
-000122d0: 6c64 206e 6f74 2062 6520 7772 6974 7465  ld not be writte
-000122e0: 6e2e 220a 2020 2020 2020 2020 2020 2020  n.".            
-000122f0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00012300: 6173 7365 7274 4571 7561 6c28 696e 6974  assertEqual(init
-00012310: 6961 6c5f 7573 6167 652e 7573 6564 202b  ial_usage.used +
-00012320: 2031 3030 2c20 7365 6c66 2e66 732e 6765   100, self.fs.ge
-00012330: 745f 6469 736b 5f75 7361 6765 2829 2e75  t_disk_usage().u
-00012340: 7365 6429 0a0a 2020 2020 6465 6620 7465  sed)..    def te
-00012350: 7374 5f63 7265 6174 696e 675f 6669 6c65  st_creating_file
-00012360: 5f77 6974 685f 636f 6e74 656e 745f 746f  _with_content_to
-00012370: 6f5f 6c61 7267 6528 7365 6c66 293a 0a20  o_large(self):. 
-00012380: 2020 2020 2020 2064 6566 2063 7265 6174         def creat
-00012390: 655f 6c61 7267 655f 6669 6c65 2829 3a0a  e_large_file():.
-000123a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000123b0: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
-000123c0: 2221 666f 6f21 6261 7222 2c20 636f 6e74  "!foo!bar", cont
-000123d0: 656e 7473 3d62 2261 2220 2a20 3130 3129  ents=b"a" * 101)
-000123e0: 0a0a 2020 2020 2020 2020 696e 6974 6961  ..        initia
-000123f0: 6c5f 7573 6167 6520 3d20 7365 6c66 2e66  l_usage = self.f
-00012400: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
-00012410: 2829 0a0a 2020 2020 2020 2020 7769 7468  ()..        with
-00012420: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00012430: 6573 284f 5345 7272 6f72 293a 0a20 2020  es(OSError):.   
-00012440: 2020 2020 2020 2020 2063 7265 6174 655f           create_
-00012450: 6c61 7267 655f 6669 6c65 2829 0a0a 2020  large_file()..  
-00012460: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012470: 7445 7175 616c 2869 6e69 7469 616c 5f75  tEqual(initial_u
-00012480: 7361 6765 2c20 7365 6c66 2e66 732e 6765  sage, self.fs.ge
-00012490: 745f 6469 736b 5f75 7361 6765 2829 290a  t_disk_usage()).
-000124a0: 0a20 2020 2064 6566 2074 6573 745f 6372  .    def test_cr
-000124b0: 6561 7469 6e67 5f66 696c 655f 7769 7468  eating_file_with
-000124c0: 5f66 6974 7469 6e67 5f73 697a 6528 7365  _fitting_size(se
-000124d0: 6c66 293a 0a20 2020 2020 2020 2069 6e69  lf):.        ini
-000124e0: 7469 616c 5f75 7361 6765 203d 2073 656c  tial_usage = sel
-000124f0: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
-00012500: 6167 6528 290a 0a20 2020 2020 2020 2074  age()..        t
-00012510: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00012520: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
-00012530: 696c 6528 2221 666f 6f21 6261 7222 2c20  ile("!foo!bar", 
-00012540: 7374 5f73 697a 653d 3130 3029 0a20 2020  st_size=100).   
-00012550: 2020 2020 2065 7863 6570 7420 4f53 4572       except OSEr
-00012560: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00012570: 2073 656c 662e 6661 696c 2822 4669 6c65   self.fail("File
-00012580: 2077 6974 6820 7369 7a65 2066 6974 7469   with size fitti
-00012590: 6e67 2069 6e74 6f20 6469 736b 2073 7061  ng into disk spa
-000125a0: 6365 2063 6f75 6c64 206e 6f74 2062 6520  ce could not be 
-000125b0: 7772 6974 7465 6e2e 2229 0a0a 2020 2020  written.")..    
-000125c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000125d0: 7175 616c 2869 6e69 7469 616c 5f75 7361  qual(initial_usa
-000125e0: 6765 2e75 7365 6420 2b20 3130 302c 2073  ge.used + 100, s
-000125f0: 656c 662e 6673 2e67 6574 5f64 6973 6b5f  elf.fs.get_disk_
-00012600: 7573 6167 6528 292e 7573 6564 290a 0a20  usage().used).. 
-00012610: 2020 2064 6566 2074 6573 745f 6372 6561     def test_crea
-00012620: 7469 6e67 5f66 696c 655f 7769 7468 5f73  ting_file_with_s
-00012630: 697a 655f 746f 6f5f 6c61 7267 6528 7365  ize_too_large(se
-00012640: 6c66 293a 0a20 2020 2020 2020 2069 6e69  lf):.        ini
-00012650: 7469 616c 5f75 7361 6765 203d 2073 656c  tial_usage = sel
-00012660: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
-00012670: 6167 6528 290a 0a20 2020 2020 2020 2064  age()..        d
-00012680: 6566 2063 7265 6174 655f 6c61 7267 655f  ef create_large_
-00012690: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
-000126a0: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
-000126b0: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
-000126c0: 7222 2c20 7374 5f73 697a 653d 3130 3129  r", st_size=101)
-000126d0: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-000126e0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-000126f0: 284f 5345 7272 6f72 293a 0a20 2020 2020  (OSError):.     
-00012700: 2020 2020 2020 2063 7265 6174 655f 6c61         create_la
-00012710: 7267 655f 6669 6c65 2829 0a0a 2020 2020  rge_file()..    
-00012720: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00012730: 7175 616c 2869 6e69 7469 616c 5f75 7361  qual(initial_usa
-00012740: 6765 2c20 7365 6c66 2e66 732e 6765 745f  ge, self.fs.get_
-00012750: 6469 736b 5f75 7361 6765 2829 290a 0a20  disk_usage()).. 
-00012760: 2020 2064 6566 2074 6573 745f 7265 7369     def test_resi
-00012770: 7a65 5f66 696c 655f 7769 7468 5f66 6974  ze_file_with_fit
-00012780: 7469 6e67 5f73 697a 6528 7365 6c66 293a  ting_size(self):
-00012790: 0a20 2020 2020 2020 2066 696c 655f 6f62  .        file_ob
-000127a0: 6a65 6374 203d 2073 656c 662e 6673 2e63  ject = self.fs.c
-000127b0: 7265 6174 655f 6669 6c65 2822 2166 6f6f  reate_file("!foo
-000127c0: 2162 6172 222c 2073 745f 7369 7a65 3d35  !bar", st_size=5
-000127d0: 3029 0a20 2020 2020 2020 2074 7279 3a0a  0).        try:.
-000127e0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-000127f0: 5f6f 626a 6563 742e 7365 745f 6c61 7267  _object.set_larg
-00012800: 655f 6669 6c65 5f73 697a 6528 3130 3029  e_file_size(100)
-00012810: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00012820: 655f 6f62 6a65 6374 2e73 6574 5f63 6f6e  e_object.set_con
-00012830: 7465 6e74 7328 6222 6122 202a 2031 3030  tents(b"a" * 100
-00012840: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00012850: 204f 5345 7272 6f72 3a0a 2020 2020 2020   OSError:.      
-00012860: 2020 2020 2020 7365 6c66 2e66 6169 6c28        self.fail(
-00012870: 2252 6573 697a 696e 6720 6669 6c65 2066  "Resizing file f
-00012880: 6169 6c65 6420 616c 7468 6f75 6768 2064  ailed although d
-00012890: 6973 6b20 7370 6163 6520 7761 7320 7375  isk space was su
-000128a0: 6666 6963 6965 6e74 2e22 290a 0a20 2020  fficient.")..   
-000128b0: 2064 6566 2074 6573 745f 7265 7369 7a65   def test_resize
-000128c0: 5f66 696c 655f 7769 7468 5f73 697a 655f  _file_with_size_
-000128d0: 746f 6f5f 6c61 7267 6528 7365 6c66 293a  too_large(self):
-000128e0: 0a20 2020 2020 2020 2066 696c 655f 6f62  .        file_ob
-000128f0: 6a65 6374 203d 2073 656c 662e 6673 2e63  ject = self.fs.c
-00012900: 7265 6174 655f 6669 6c65 2822 2166 6f6f  reate_file("!foo
-00012910: 2162 6172 222c 2073 745f 7369 7a65 3d35  !bar", st_size=5
-00012920: 3029 0a20 2020 2020 2020 2077 6974 6820  0).        with 
-00012930: 7365 6c66 2e72 6169 7365 735f 6f73 5f65  self.raises_os_e
-00012940: 7272 6f72 2865 7272 6e6f 2e45 4e4f 5350  rror(errno.ENOSP
-00012950: 4329 3a0a 2020 2020 2020 2020 2020 2020  C):.            
-00012960: 6669 6c65 5f6f 626a 6563 742e 7365 745f  file_object.set_
-00012970: 6c61 7267 655f 6669 6c65 5f73 697a 6528  large_file_size(
-00012980: 3230 3029 0a20 2020 2020 2020 2077 6974  200).        wit
-00012990: 6820 7365 6c66 2e72 6169 7365 735f 6f73  h self.raises_os
-000129a0: 5f65 7272 6f72 2865 7272 6e6f 2e45 4e4f  _error(errno.ENO
-000129b0: 5350 4329 3a0a 2020 2020 2020 2020 2020  SPC):.          
-000129c0: 2020 6669 6c65 5f6f 626a 6563 742e 7365    file_object.se
-000129d0: 745f 636f 6e74 656e 7473 2822 6122 202a  t_contents("a" *
-000129e0: 2031 3530 290a 0a20 2020 2064 6566 2074   150)..    def t
-000129f0: 6573 745f 6669 6c65 5f73 7973 7465 6d5f  est_file_system_
-00012a00: 7369 7a65 5f61 6674 6572 5f64 6972 6563  size_after_direc
-00012a10: 746f 7279 5f72 656e 616d 6528 7365 6c66  tory_rename(self
-00012a20: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00012a30: 6673 2e63 7265 6174 655f 6669 6c65 2822  fs.create_file("
-00012a40: 2166 6f6f 2162 6172 222c 2073 745f 7369  !foo!bar", st_si
-00012a50: 7a65 3d32 3029 0a20 2020 2020 2020 2073  ze=20).        s
-00012a60: 656c 662e 6f73 2e72 656e 616d 6528 2221  elf.os.rename("!
-00012a70: 666f 6f22 2c20 2221 6261 7a22 290a 2020  foo", "!baz").  
-00012a80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012a90: 7445 7175 616c 2832 302c 2073 656c 662e  tEqual(20, self.
-00012aa0: 6673 2e67 6574 5f64 6973 6b5f 7573 6167  fs.get_disk_usag
-00012ab0: 6528 292e 7573 6564 290a 0a20 2020 2064  e().used)..    d
-00012ac0: 6566 2074 6573 745f 6669 6c65 5f73 7973  ef test_file_sys
-00012ad0: 7465 6d5f 7369 7a65 5f61 6674 6572 5f66  tem_size_after_f
-00012ae0: 696c 655f 7265 6e61 6d65 2873 656c 6629  ile_rename(self)
-00012af0: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-00012b00: 732e 6372 6561 7465 5f66 696c 6528 2221  s.create_file("!
-00012b10: 666f 6f21 6261 7222 2c20 7374 5f73 697a  foo!bar", st_siz
-00012b20: 653d 3230 290a 2020 2020 2020 2020 7365  e=20).        se
-00012b30: 6c66 2e6f 732e 7265 6e61 6d65 2822 2166  lf.os.rename("!f
-00012b40: 6f6f 2162 6172 222c 2022 2166 6f6f 2162  oo!bar", "!foo!b
-00012b50: 617a 2229 0a20 2020 2020 2020 2073 656c  az").        sel
-00012b60: 662e 6173 7365 7274 4571 7561 6c28 3230  f.assertEqual(20
-00012b70: 2c20 7365 6c66 2e66 732e 6765 745f 6469  , self.fs.get_di
-00012b80: 736b 5f75 7361 6765 2829 2e75 7365 6429  sk_usage().used)
-00012b90: 0a0a 2020 2020 6465 6620 7465 7374 5f74  ..    def test_t
-00012ba0: 6861 745f 6861 7264 5f6c 696e 6b5f 646f  hat_hard_link_do
-00012bb0: 6573 5f6e 6f74 5f63 6861 6e67 655f 7573  es_not_change_us
-00012bc0: 6564 5f73 697a 6528 7365 6c66 293a 0a20  ed_size(self):. 
-00012bd0: 2020 2020 2020 2066 696c 6531 5f70 6174         file1_pat
-00012be0: 6820 3d20 2274 6573 745f 6669 6c65 3122  h = "test_file1"
-00012bf0: 0a20 2020 2020 2020 2066 696c 6532 5f70  .        file2_p
-00012c00: 6174 6820 3d20 2274 6573 745f 6669 6c65  ath = "test_file
-00012c10: 3222 0a20 2020 2020 2020 2073 656c 662e  2".        self.
-00012c20: 6673 2e63 7265 6174 655f 6669 6c65 2866  fs.create_file(f
-00012c30: 696c 6531 5f70 6174 682c 2073 745f 7369  ile1_path, st_si
-00012c40: 7a65 3d32 3029 0a20 2020 2020 2020 2073  ze=20).        s
-00012c50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012c60: 3230 2c20 7365 6c66 2e66 732e 6765 745f  20, self.fs.get_
-00012c70: 6469 736b 5f75 7361 6765 2829 2e75 7365  disk_usage().use
-00012c80: 6429 0a20 2020 2020 2020 2023 2063 7265  d).        # cre
-00012c90: 6174 696e 6720 6120 6861 7264 206c 696e  ating a hard lin
-00012ca0: 6b20 7368 616c 6c20 6e6f 7420 696e 6372  k shall not incr
-00012cb0: 6561 7365 2075 7365 6420 7370 6163 650a  ease used space.
-00012cc0: 2020 2020 2020 2020 7365 6c66 2e6f 732e          self.os.
-00012cd0: 6c69 6e6b 2866 696c 6531 5f70 6174 682c  link(file1_path,
-00012ce0: 2066 696c 6532 5f70 6174 6829 0a20 2020   file2_path).   
-00012cf0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00012d00: 4571 7561 6c28 3230 2c20 7365 6c66 2e66  Equal(20, self.f
-00012d10: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
-00012d20: 2829 2e75 7365 6429 0a20 2020 2020 2020  ().used).       
-00012d30: 2023 2072 656d 6f76 696e 6720 6120 6669   # removing a fi
-00012d40: 6c65 2073 6861 6c6c 206e 6f74 2064 6563  le shall not dec
-00012d50: 7265 6173 6520 7573 6564 2073 7061 6365  rease used space
-00012d60: 0a20 2020 2020 2020 2023 2069 6620 6120  .        # if a 
-00012d70: 6861 7264 206c 696e 6b20 7374 696c 6c20  hard link still 
-00012d80: 6578 6973 7473 0a20 2020 2020 2020 2073  exists.        s
-00012d90: 656c 662e 6f73 2e75 6e6c 696e 6b28 6669  elf.os.unlink(fi
-00012da0: 6c65 315f 7061 7468 290a 2020 2020 2020  le1_path).      
-00012db0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00012dc0: 616c 2832 302c 2073 656c 662e 6673 2e67  al(20, self.fs.g
-00012dd0: 6574 5f64 6973 6b5f 7573 6167 6528 292e  et_disk_usage().
-00012de0: 7573 6564 290a 2020 2020 2020 2020 7365  used).        se
-00012df0: 6c66 2e6f 732e 756e 6c69 6e6b 2866 696c  lf.os.unlink(fil
-00012e00: 6532 5f70 6174 6829 0a20 2020 2020 2020  e2_path).       
-00012e10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00012e20: 6c28 302c 2073 656c 662e 6673 2e67 6574  l(0, self.fs.get
-00012e30: 5f64 6973 6b5f 7573 6167 6528 292e 7573  _disk_usage().us
-00012e40: 6564 290a 0a20 2020 2064 6566 2074 6573  ed)..    def tes
-00012e50: 745f 7468 6174 5f74 6865 5f73 697a 655f  t_that_the_size_
-00012e60: 6f66 5f63 6f72 7265 6374 5f6d 6f75 6e74  of_correct_mount
-00012e70: 5f70 6f69 6e74 5f69 735f 7573 6564 2873  _point_is_used(s
-00012e80: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00012e90: 6c66 2e66 732e 6164 645f 6d6f 756e 745f  lf.fs.add_mount_
-00012ea0: 706f 696e 7428 2221 6d6f 756e 745f 6c69  point("!mount_li
-00012eb0: 6d69 7465 6422 2c20 746f 7461 6c5f 7369  mited", total_si
-00012ec0: 7a65 3d35 3029 0a20 2020 2020 2020 2073  ze=50).        s
-00012ed0: 656c 662e 6673 2e61 6464 5f6d 6f75 6e74  elf.fs.add_mount
-00012ee0: 5f70 6f69 6e74 2822 216d 6f75 6e74 5f75  _point("!mount_u
-00012ef0: 6e6c 696d 6974 6564 2229 0a0a 2020 2020  nlimited")..    
-00012f00: 2020 2020 7769 7468 2073 656c 662e 7261      with self.ra
-00012f10: 6973 6573 5f6f 735f 6572 726f 7228 6572  ises_os_error(er
-00012f20: 726e 6f2e 454e 4f53 5043 293a 0a20 2020  rno.ENOSPC):.   
-00012f30: 2020 2020 2020 2020 2073 656c 662e 6673           self.fs
-00012f40: 2e63 7265 6174 655f 6669 6c65 2822 216d  .create_file("!m
-00012f50: 6f75 6e74 5f6c 696d 6974 6564 2166 6f6f  ount_limited!foo
-00012f60: 222c 2073 745f 7369 7a65 3d36 3029 0a20  ", st_size=60). 
-00012f70: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00012f80: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
-00012f90: 2865 7272 6e6f 2e45 4e4f 5350 4329 3a0a  (errno.ENOSPC):.
-00012fa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012fb0: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
-00012fc0: 2221 6261 7222 2c20 7374 5f73 697a 653d  "!bar", st_size=
-00012fd0: 3131 3029 0a0a 2020 2020 2020 2020 7472  110)..        tr
-00012fe0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-00012ff0: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
-00013000: 6c65 2822 2166 6f6f 222c 2073 745f 7369  le("!foo", st_si
-00013010: 7a65 3d36 3029 0a20 2020 2020 2020 2020  ze=60).         
-00013020: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
-00013030: 655f 6669 6c65 2822 216d 6f75 6e74 5f6c  e_file("!mount_l
-00013040: 696d 6974 6564 2166 6f6f 222c 2073 745f  imited!foo", st_
-00013050: 7369 7a65 3d34 3029 0a20 2020 2020 2020  size=40).       
-00013060: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
-00013070: 6174 655f 6669 6c65 2822 216d 6f75 6e74  ate_file("!mount
-00013080: 5f75 6e6c 696d 6974 6564 2166 6f6f 222c  _unlimited!foo",
-00013090: 2073 745f 7369 7a65 3d31 3030 3030 3030   st_size=1000000
-000130a0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-000130b0: 204f 5345 7272 6f72 3a0a 2020 2020 2020   OSError:.      
-000130c0: 2020 2020 2020 7365 6c66 2e66 6169 6c28        self.fail(
-000130d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000130e0: 2022 4669 6c65 2077 6974 6820 636f 6e74   "File with cont
-000130f0: 656e 7473 2066 6974 7469 6e67 2069 6e74  ents fitting int
-00013100: 6f20 2220 2264 6973 6b20 7370 6163 6520  o " "disk space 
-00013110: 636f 756c 6420 6e6f 7420 6265 2077 7269  could not be wri
-00013120: 7474 656e 2e22 0a20 2020 2020 2020 2020  tten.".         
-00013130: 2020 2029 0a0a 2020 2020 6465 6620 7465     )..    def te
-00013140: 7374 5f74 6861 745f 6469 736b 5f75 7361  st_that_disk_usa
-00013150: 6765 5f6f 665f 636f 7272 6563 745f 6d6f  ge_of_correct_mo
-00013160: 756e 745f 706f 696e 745f 6973 5f75 7365  unt_point_is_use
-00013170: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00013180: 2073 656c 662e 6673 2e61 6464 5f6d 6f75   self.fs.add_mou
-00013190: 6e74 5f70 6f69 6e74 2822 216d 6f75 6e74  nt_point("!mount
-000131a0: 3122 2c20 746f 7461 6c5f 7369 7a65 3d32  1", total_size=2
-000131b0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-000131c0: 6673 2e61 6464 5f6d 6f75 6e74 5f70 6f69  fs.add_mount_poi
-000131d0: 6e74 2822 216d 6f75 6e74 3121 6261 7221  nt("!mount1!bar!
-000131e0: 6d6f 756e 7432 222c 2074 6f74 616c 5f73  mount2", total_s
-000131f0: 697a 653d 3530 290a 0a20 2020 2020 2020  ize=50)..       
-00013200: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-00013210: 6669 6c65 2822 2166 6f6f 2162 6172 222c  file("!foo!bar",
-00013220: 2073 745f 7369 7a65 3d31 3029 0a20 2020   st_size=10).   
-00013230: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
-00013240: 6174 655f 6669 6c65 2822 216d 6f75 6e74  ate_file("!mount
-00013250: 3121 666f 6f21 6261 7222 2c20 7374 5f73  1!foo!bar", st_s
-00013260: 697a 653d 3130 290a 2020 2020 2020 2020  ize=10).        
-00013270: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
-00013280: 696c 6528 2221 6d6f 756e 7431 2162 6172  ile("!mount1!bar
-00013290: 216d 6f75 6e74 3221 666f 6f21 6261 7222  !mount2!foo!bar"
-000132a0: 2c20 7374 5f73 697a 653d 3130 290a 0a20  , st_size=10).. 
-000132b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000132c0: 7274 4571 7561 6c28 3930 2c20 7365 6c66  rtEqual(90, self
-000132d0: 2e66 732e 6765 745f 6469 736b 5f75 7361  .fs.get_disk_usa
-000132e0: 6765 2822 2166 6f6f 2229 2e66 7265 6529  ge("!foo").free)
-000132f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00013300: 7365 7274 4571 7561 6c28 3130 2c20 7365  sertEqual(10, se
-00013310: 6c66 2e66 732e 6765 745f 6469 736b 5f75  lf.fs.get_disk_u
-00013320: 7361 6765 2822 216d 6f75 6e74 3121 666f  sage("!mount1!fo
-00013330: 6f22 292e 6672 6565 290a 2020 2020 2020  o").free).      
-00013340: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00013350: 616c 2834 302c 2073 656c 662e 6673 2e67  al(40, self.fs.g
-00013360: 6574 5f64 6973 6b5f 7573 6167 6528 2221  et_disk_usage("!
-00013370: 6d6f 756e 7431 2162 6172 216d 6f75 6e74  mount1!bar!mount
-00013380: 3222 292e 6672 6565 290a 0a20 2020 2064  2").free)..    d
-00013390: 6566 2074 6573 745f 7365 745f 6c61 7267  ef test_set_larg
-000133a0: 6572 5f64 6973 6b5f 7369 7a65 2873 656c  er_disk_size(sel
-000133b0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-000133c0: 2e66 732e 6164 645f 6d6f 756e 745f 706f  .fs.add_mount_po
-000133d0: 696e 7428 2221 6d6f 756e 7431 222c 2074  int("!mount1", t
-000133e0: 6f74 616c 5f73 697a 653d 3230 290a 2020  otal_size=20).  
-000133f0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00013400: 7261 6973 6573 5f6f 735f 6572 726f 7228  raises_os_error(
-00013410: 6572 726e 6f2e 454e 4f53 5043 293a 0a20  errno.ENOSPC):. 
-00013420: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013430: 6673 2e63 7265 6174 655f 6669 6c65 2822  fs.create_file("
-00013440: 216d 6f75 6e74 3121 666f 6f22 2c20 7374  !mount1!foo", st
-00013450: 5f73 697a 653d 3130 3029 0a20 2020 2020  _size=100).     
-00013460: 2020 2073 656c 662e 6673 2e73 6574 5f64     self.fs.set_d
-00013470: 6973 6b5f 7573 6167 6528 746f 7461 6c5f  isk_usage(total_
-00013480: 7369 7a65 3d32 3030 2c20 7061 7468 3d22  size=200, path="
-00013490: 216d 6f75 6e74 3122 290a 2020 2020 2020  !mount1").      
-000134a0: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-000134b0: 5f66 696c 6528 2221 6d6f 756e 7431 2166  _file("!mount1!f
-000134c0: 6f6f 222c 2073 745f 7369 7a65 3d31 3030  oo", st_size=100
-000134d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000134e0: 7373 6572 7445 7175 616c 2831 3030 2c20  ssertEqual(100, 
-000134f0: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
-00013500: 5f75 7361 6765 2822 216d 6f75 6e74 3121  _usage("!mount1!
-00013510: 666f 6f22 292e 6672 6565 290a 0a20 2020  foo").free)..   
-00013520: 2064 6566 2074 6573 745f 7365 745f 736d   def test_set_sm
-00013530: 616c 6c65 725f 6469 736b 5f73 697a 6528  aller_disk_size(
-00013540: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00013550: 656c 662e 6673 2e61 6464 5f6d 6f75 6e74  elf.fs.add_mount
-00013560: 5f70 6f69 6e74 2822 216d 6f75 6e74 3122  _point("!mount1"
-00013570: 2c20 746f 7461 6c5f 7369 7a65 3d32 3030  , total_size=200
-00013580: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
-00013590: 732e 6372 6561 7465 5f66 696c 6528 2221  s.create_file("!
-000135a0: 6d6f 756e 7431 2166 6f6f 222c 2073 745f  mount1!foo", st_
-000135b0: 7369 7a65 3d31 3030 290a 2020 2020 2020  size=100).      
-000135c0: 2020 7769 7468 2073 656c 662e 7261 6973    with self.rais
-000135d0: 6573 5f6f 735f 6572 726f 7228 6572 726e  es_os_error(errn
-000135e0: 6f2e 454e 4f53 5043 293a 0a20 2020 2020  o.ENOSPC):.     
-000135f0: 2020 2020 2020 2073 656c 662e 6673 2e73         self.fs.s
-00013600: 6574 5f64 6973 6b5f 7573 6167 6528 746f  et_disk_usage(to
-00013610: 7461 6c5f 7369 7a65 3d35 302c 2070 6174  tal_size=50, pat
-00013620: 683d 2221 6d6f 756e 7431 2229 0a20 2020  h="!mount1").   
-00013630: 2020 2020 2073 656c 662e 6673 2e73 6574       self.fs.set
-00013640: 5f64 6973 6b5f 7573 6167 6528 746f 7461  _disk_usage(tota
-00013650: 6c5f 7369 7a65 3d31 3530 2c20 7061 7468  l_size=150, path
-00013660: 3d22 216d 6f75 6e74 3122 290a 2020 2020  ="!mount1").    
-00013670: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013680: 7175 616c 2835 302c 2073 656c 662e 6673  qual(50, self.fs
-00013690: 2e67 6574 5f64 6973 6b5f 7573 6167 6528  .get_disk_usage(
-000136a0: 2221 6d6f 756e 7431 2166 6f6f 2229 2e66  "!mount1!foo").f
-000136b0: 7265 6529 0a0a 2020 2020 6465 6620 7465  ree)..    def te
-000136c0: 7374 5f64 6973 6b5f 7369 7a65 5f6f 6e5f  st_disk_size_on_
-000136d0: 756e 6c69 6d69 7465 645f 6469 736b 2873  unlimited_disk(s
-000136e0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000136f0: 6c66 2e66 732e 6164 645f 6d6f 756e 745f  lf.fs.add_mount_
-00013700: 706f 696e 7428 2221 6d6f 756e 7431 2229  point("!mount1")
-00013710: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-00013720: 2e63 7265 6174 655f 6669 6c65 2822 216d  .create_file("!m
-00013730: 6f75 6e74 3121 666f 6f22 2c20 7374 5f73  ount1!foo", st_s
-00013740: 697a 653d 3130 3029 0a20 2020 2020 2020  ize=100).       
-00013750: 2073 656c 662e 6673 2e73 6574 5f64 6973   self.fs.set_dis
-00013760: 6b5f 7573 6167 6528 746f 7461 6c5f 7369  k_usage(total_si
-00013770: 7a65 3d31 3030 302c 2070 6174 683d 2221  ze=1000, path="!
-00013780: 6d6f 756e 7431 2229 0a20 2020 2020 2020  mount1").       
-00013790: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000137a0: 6c28 3930 302c 2073 656c 662e 6673 2e67  l(900, self.fs.g
-000137b0: 6574 5f64 6973 6b5f 7573 6167 6528 2221  et_disk_usage("!
-000137c0: 6d6f 756e 7431 2166 6f6f 2229 2e66 7265  mount1!foo").fre
-000137d0: 6529 0a0a 2020 2020 6465 6620 7465 7374  e)..    def test
-000137e0: 5f64 6973 6b5f 7369 7a65 5f6f 6e5f 6175  _disk_size_on_au
-000137f0: 746f 5f6d 6f75 6e74 6564 5f64 7269 7665  to_mounted_drive
-00013800: 5f6f 6e5f 6669 6c65 5f63 7265 6174 696f  _on_file_creatio
-00013810: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00013820: 2073 656c 662e 6673 2e69 735f 7769 6e64   self.fs.is_wind
-00013830: 6f77 735f 6673 203d 2054 7275 650a 2020  ows_fs = True.  
-00013840: 2020 2020 2020 2320 6472 6976 6520 643a        # drive d:
-00013850: 2073 6861 6c6c 2062 6520 6175 746f 2d6d   shall be auto-m
-00013860: 6f75 6e74 6564 2061 6e64 2074 6865 2075  ounted and the u
-00013870: 7365 6420 7369 7a65 2061 6461 7074 6564  sed size adapted
-00013880: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-00013890: 2e63 7265 6174 655f 6669 6c65 2822 643a  .create_file("d:
-000138a0: 2166 6f6f 2162 6172 222c 2073 745f 7369  !foo!bar", st_si
-000138b0: 7a65 3d31 3030 290a 2020 2020 2020 2020  ze=100).        
-000138c0: 7365 6c66 2e66 732e 7365 745f 6469 736b  self.fs.set_disk
-000138d0: 5f75 7361 6765 2874 6f74 616c 5f73 697a  _usage(total_siz
-000138e0: 653d 3130 3030 2c20 7061 7468 3d22 643a  e=1000, path="d:
-000138f0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00013900: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-00013910: 2e66 732e 6765 745f 6469 736b 5f75 7361  .fs.get_disk_usa
-00013920: 6765 2822 643a 2166 6f6f 2229 2e66 7265  ge("d:!foo").fre
-00013930: 652c 2039 3030 290a 0a20 2020 2064 6566  e, 900)..    def
-00013940: 2074 6573 745f 6469 736b 5f73 697a 655f   test_disk_size_
-00013950: 6f6e 5f61 7574 6f5f 6d6f 756e 7465 645f  on_auto_mounted_
-00013960: 6472 6976 655f 6f6e 5f64 6972 6563 746f  drive_on_directo
-00013970: 7279 5f63 7265 6174 696f 6e28 7365 6c66  ry_creation(self
-00013980: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00013990: 6673 2e69 735f 7769 6e64 6f77 735f 6673  fs.is_windows_fs
-000139a0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-000139b0: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-000139c0: 6972 2822 643a 2166 6f6f 2162 6172 2229  ir("d:!foo!bar")
-000139d0: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-000139e0: 2e63 7265 6174 655f 6669 6c65 2822 643a  .create_file("d:
-000139f0: 2166 6f6f 2162 6172 2162 617a 222c 2073  !foo!bar!baz", s
-00013a00: 745f 7369 7a65 3d31 3030 290a 2020 2020  t_size=100).    
-00013a10: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
-00013a20: 7465 5f66 696c 6528 2264 3a21 666f 6f21  te_file("d:!foo!
-00013a30: 6261 7a22 2c20 7374 5f73 697a 653d 3130  baz", st_size=10
-00013a40: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-00013a50: 6673 2e73 6574 5f64 6973 6b5f 7573 6167  fs.set_disk_usag
-00013a60: 6528 746f 7461 6c5f 7369 7a65 3d31 3030  e(total_size=100
-00013a70: 302c 2070 6174 683d 2264 3a22 290a 2020  0, path="d:").  
-00013a80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013a90: 7445 7175 616c 2838 3030 2c20 7365 6c66  tEqual(800, self
-00013aa0: 2e66 732e 6765 745f 6469 736b 5f75 7361  .fs.get_disk_usa
-00013ab0: 6765 2822 643a 2166 6f6f 2229 2e66 7265  ge("d:!foo").fre
-00013ac0: 6529 0a0a 2020 2020 6465 6620 7465 7374  e)..    def test
-00013ad0: 5f63 6f70 7969 6e67 5f70 7265 7365 7276  _copying_preserv
-00013ae0: 6573 5f62 7974 655f 636f 6e74 656e 7473  es_byte_contents
-00013af0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00013b00: 736f 7572 6365 5f66 696c 6520 3d20 7365  source_file = se
-00013b10: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00013b20: 6528 2266 6f6f 222c 2063 6f6e 7465 6e74  e("foo", content
-00013b30: 733d 6222 736f 6d65 6279 7465 7322 290a  s=b"somebytes").
-00013b40: 2020 2020 2020 2020 6465 7374 5f66 696c          dest_fil
-00013b50: 6520 3d20 7365 6c66 2e66 732e 6372 6561  e = self.fs.crea
-00013b60: 7465 5f66 696c 6528 2262 6172 2229 0a20  te_file("bar"). 
-00013b70: 2020 2020 2020 2064 6573 745f 6669 6c65         dest_file
-00013b80: 2e73 6574 5f63 6f6e 7465 6e74 7328 736f  .set_contents(so
-00013b90: 7572 6365 5f66 696c 652e 636f 6e74 656e  urce_file.conten
-00013ba0: 7473 290a 2020 2020 2020 2020 7365 6c66  ts).        self
-00013bb0: 2e61 7373 6572 7445 7175 616c 2864 6573  .assertEqual(des
-00013bc0: 745f 6669 6c65 2e63 6f6e 7465 6e74 732c  t_file.contents,
-00013bd0: 2073 6f75 7263 655f 6669 6c65 2e63 6f6e   source_file.con
-00013be0: 7465 6e74 7329 0a0a 2020 2020 6465 6620  tents)..    def 
-00013bf0: 7465 7374 5f64 6973 6b75 7361 6765 5f61  test_diskusage_a
-00013c00: 6674 6572 5f6f 7065 6e5f 7772 6974 6528  fter_open_write(
-00013c10: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-00013c20: 6974 6820 7365 6c66 2e6f 7065 6e28 2262  ith self.open("b
-00013c30: 6172 2e74 7874 222c 2022 7722 2920 6173  ar.txt", "w") as
-00013c40: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00013c50: 662e 7772 6974 6528 2261 2220 2a20 3630  f.write("a" * 60
-00013c60: 290a 2020 2020 2020 2020 2020 2020 662e  ).            f.
-00013c70: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
-00013c80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013c90: 2836 302c 2073 656c 662e 6673 2e67 6574  (60, self.fs.get
-00013ca0: 5f64 6973 6b5f 7573 6167 6528 295b 315d  _disk_usage()[1]
-00013cb0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00013cc0: 6469 736b 5f66 756c 6c5f 6166 7465 725f  disk_full_after_
-00013cd0: 7265 6f70 656e 6564 2873 656c 6629 3a0a  reopened(self):.
-00013ce0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00013cf0: 662e 6f70 656e 2822 6261 722e 7478 7422  f.open("bar.txt"
-00013d00: 2c20 2277 2229 2061 7320 663a 0a20 2020  , "w") as f:.   
-00013d10: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
-00013d20: 2822 6122 202a 2036 3029 0a20 2020 2020  ("a" * 60).     
-00013d30: 2020 2077 6974 6820 7365 6c66 2e6f 7065     with self.ope
-00013d40: 6e28 2262 6172 2e74 7874 2229 2061 7320  n("bar.txt") as 
-00013d50: 663a 0a20 2020 2020 2020 2020 2020 2073  f:.            s
-00013d60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00013d70: 2261 2220 2a20 3630 2c20 662e 7265 6164  "a" * 60, f.read
-00013d80: 2829 290a 2020 2020 2020 2020 7769 7468  ()).        with
-00013d90: 2073 656c 662e 7261 6973 6573 5f6f 735f   self.raises_os_
-00013da0: 6572 726f 7228 6572 726e 6f2e 454e 4f53  error(errno.ENOS
-00013db0: 5043 293a 0a20 2020 2020 2020 2020 2020  PC):.           
-00013dc0: 2077 6974 6820 7365 6c66 2e6f 7065 6e28   with self.open(
-00013dd0: 2262 6172 2e74 7874 222c 2022 7722 2920  "bar.txt", "w") 
-00013de0: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00013df0: 2020 2020 2020 662e 7772 6974 6528 2262        f.write("b
-00013e00: 2220 2a20 3131 3029 0a20 2020 2020 2020  " * 110).       
-00013e10: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-00013e20: 6c66 2e72 6169 7365 735f 6f73 5f65 7272  lf.raises_os_err
-00013e30: 6f72 2865 7272 6e6f 2e45 4e4f 5350 4329  or(errno.ENOSPC)
-00013e40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013e50: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
-00013e60: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00013e70: 662e 6f70 656e 2822 6261 722e 7478 7422  f.open("bar.txt"
-00013e80: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00013e90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013ea0: 7175 616c 2822 222c 2066 2e72 6561 6428  qual("", f.read(
-00013eb0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-00013ec0: 5f64 6973 6b5f 6675 6c6c 5f61 7070 656e  _disk_full_appen
-00013ed0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00013ee0: 2066 696c 655f 7061 7468 203d 2022 6261   file_path = "ba
-00013ef0: 722e 7478 7422 0a20 2020 2020 2020 2077  r.txt".        w
-00013f00: 6974 6820 7365 6c66 2e6f 7065 6e28 6669  ith self.open(fi
-00013f10: 6c65 5f70 6174 682c 2022 7722 2920 6173  le_path, "w") as
-00013f20: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00013f30: 662e 7772 6974 6528 2261 2220 2a20 3630  f.write("a" * 60
-00013f40: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00013f50: 656c 662e 6f70 656e 2866 696c 655f 7061  elf.open(file_pa
-00013f60: 7468 2920 6173 2066 3a0a 2020 2020 2020  th) as f:.      
-00013f70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013f80: 7445 7175 616c 2822 6122 202a 2036 302c  tEqual("a" * 60,
-00013f90: 2066 2e72 6561 6428 2929 0a20 2020 2020   f.read()).     
-00013fa0: 2020 2077 6974 6820 7365 6c66 2e72 6169     with self.rai
-00013fb0: 7365 735f 6f73 5f65 7272 6f72 2865 7272  ses_os_error(err
-00013fc0: 6e6f 2e45 4e4f 5350 4329 3a0a 2020 2020  no.ENOSPC):.    
-00013fd0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00013fe0: 662e 6f70 656e 2866 696c 655f 7061 7468  f.open(file_path
-00013ff0: 2c20 2261 2229 2061 7320 663a 0a20 2020  , "a") as f:.   
-00014000: 2020 2020 2020 2020 2020 2020 2066 2e77               f.w
-00014010: 7269 7465 2822 6222 202a 2034 3129 0a20  rite("b" * 41). 
-00014020: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00014030: 6974 6820 7365 6c66 2e72 6169 7365 735f  ith self.raises_
-00014040: 6f73 5f65 7272 6f72 2865 7272 6e6f 2e45  os_error(errno.E
-00014050: 4e4f 5350 4329 3a0a 2020 2020 2020 2020  NOSPC):.        
-00014060: 2020 2020 2020 2020 2020 2020 662e 666c              f.fl
-00014070: 7573 6828 290a 2020 2020 2020 2020 7769  ush().        wi
-00014080: 7468 2073 656c 662e 6f70 656e 2822 6261  th self.open("ba
-00014090: 722e 7478 7422 2920 6173 2066 3a0a 2020  r.txt") as f:.  
-000140a0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-000140b0: 7373 6572 7445 7175 616c 2866 2e72 6561  ssertEqual(f.rea
-000140c0: 6428 292c 2022 6122 202a 2036 3029 0a0a  d(), "a" * 60)..
-000140d0: 2020 2020 6465 6620 7465 7374 5f64 6973      def test_dis
-000140e0: 6b5f 6675 6c6c 5f61 6674 6572 5f72 656f  k_full_after_reo
-000140f0: 7065 6e65 645f 7270 6c75 735f 7365 656b  pened_rplus_seek
-00014100: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00014110: 7769 7468 2073 656c 662e 6f70 656e 2822  with self.open("
-00014120: 6261 722e 7478 7422 2c20 2277 2229 2061  bar.txt", "w") a
-00014130: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00014140: 2066 2e77 7269 7465 2822 6122 202a 2036   f.write("a" * 6
-00014150: 3029 0a20 2020 2020 2020 2077 6974 6820  0).        with 
-00014160: 7365 6c66 2e6f 7065 6e28 2262 6172 2e74  self.open("bar.t
-00014170: 7874 2229 2061 7320 663a 0a20 2020 2020  xt") as f:.     
-00014180: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00014190: 7274 4571 7561 6c28 662e 7265 6164 2829  rtEqual(f.read()
-000141a0: 2c20 2261 2220 2a20 3630 290a 2020 2020  , "a" * 60).    
-000141b0: 2020 2020 7769 7468 2073 656c 662e 7261      with self.ra
-000141c0: 6973 6573 5f6f 735f 6572 726f 7228 6572  ises_os_error(er
-000141d0: 726e 6f2e 454e 4f53 5043 293a 0a20 2020  rno.ENOSPC):.   
-000141e0: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-000141f0: 6c66 2e6f 7065 6e28 2262 6172 2e74 7874  lf.open("bar.txt
-00014200: 222c 2022 722b 2229 2061 7320 663a 0a20  ", "r+") as f:. 
-00014210: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014220: 2e73 6565 6b28 3530 290a 2020 2020 2020  .seek(50).      
-00014230: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
-00014240: 6528 2262 2220 2a20 3630 290a 2020 2020  e("b" * 60).    
-00014250: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00014260: 2073 656c 662e 7261 6973 6573 5f6f 735f   self.raises_os_
-00014270: 6572 726f 7228 6572 726e 6f2e 454e 4f53  error(errno.ENOS
-00014280: 5043 293a 0a20 2020 2020 2020 2020 2020  PC):.           
-00014290: 2020 2020 2020 2020 2066 2e66 6c75 7368           f.flush
-000142a0: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
-000142b0: 7365 6c66 2e6f 7065 6e28 2262 6172 2e74  self.open("bar.t
-000142c0: 7874 2229 2061 7320 663a 0a20 2020 2020  xt") as f:.     
-000142d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000142e0: 7274 4571 7561 6c28 662e 7265 6164 2829  rtEqual(f.read()
-000142f0: 2c20 2261 2220 2a20 3630 290a 0a0a 636c  , "a" * 60)...cl
-00014300: 6173 7320 4d6f 756e 7450 6f69 6e74 5465  ass MountPointTe
-00014310: 7374 2854 6573 7443 6173 6529 3a0a 2020  st(TestCase):.  
-00014320: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-00014330: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00014340: 6669 6c65 7379 7374 656d 203d 2066 616b  filesystem = fak
-00014350: 655f 6669 6c65 7379 7374 656d 2e46 616b  e_filesystem.Fak
-00014360: 6546 696c 6573 7973 7465 6d28 0a20 2020  eFilesystem(.   
-00014370: 2020 2020 2020 2020 2070 6174 685f 7365           path_se
-00014380: 7061 7261 746f 723d 2221 222c 2074 6f74  parator="!", tot
-00014390: 616c 5f73 697a 653d 3130 300a 2020 2020  al_size=100.    
-000143a0: 2020 2020 290a 0a20 2020 2064 6566 2061      )..    def a
-000143b0: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 7328  dd_mount_points(
-000143c0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-000143d0: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
-000143e0: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 2822  dd_mount_point("
-000143f0: 2166 6f6f 2229 0a20 2020 2020 2020 2073  !foo").        s
-00014400: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
-00014410: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 2822  dd_mount_point("
-00014420: 2162 6172 2229 0a20 2020 2020 2020 2073  !bar").        s
-00014430: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
-00014440: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 2822  dd_mount_point("
-00014450: 2166 6f6f 2162 617a 2229 0a0a 2020 2020  !foo!baz")..    
-00014460: 6465 6620 7465 7374 5f74 6861 745f 6e65  def test_that_ne
-00014470: 775f 6d6f 756e 745f 706f 696e 7473 5f67  w_mount_points_g
-00014480: 6574 5f6e 6577 5f64 6576 6963 655f 6e75  et_new_device_nu
-00014490: 6d62 6572 2873 656c 6629 3a0a 2020 2020  mber(self):.    
-000144a0: 2020 2020 7365 6c66 2e61 6464 5f6d 6f75      self.add_mou
-000144b0: 6e74 5f70 6f69 6e74 7328 290a 2020 2020  nt_points().    
-000144c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000144d0: 7175 616c 2831 2c20 7365 6c66 2e66 696c  qual(1, self.fil
-000144e0: 6573 7973 7465 6d2e 6765 745f 6f62 6a65  esystem.get_obje
-000144f0: 6374 2822 2122 292e 7374 5f64 6576 290a  ct("!").st_dev).
-00014500: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014510: 6572 7445 7175 616c 2832 2c20 7365 6c66  ertEqual(2, self
-00014520: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
-00014530: 6f62 6a65 6374 2822 2166 6f6f 2229 2e73  object("!foo").s
-00014540: 745f 6465 7629 0a20 2020 2020 2020 2073  t_dev).        s
-00014550: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00014560: 332c 2073 656c 662e 6669 6c65 7379 7374  3, self.filesyst
-00014570: 656d 2e67 6574 5f6f 626a 6563 7428 2221  em.get_object("!
-00014580: 6261 7222 292e 7374 5f64 6576 290a 2020  bar").st_dev).  
-00014590: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000145a0: 7445 7175 616c 2834 2c20 7365 6c66 2e66  tEqual(4, self.f
-000145b0: 696c 6573 7973 7465 6d2e 6765 745f 6f62  ilesystem.get_ob
-000145c0: 6a65 6374 2822 2166 6f6f 2162 617a 2229  ject("!foo!baz")
-000145d0: 2e73 745f 6465 7629 0a0a 2020 2020 6465  .st_dev)..    de
-000145e0: 6620 7465 7374 5f74 6861 745f 6e65 775f  f test_that_new_
-000145f0: 6469 7265 6374 6f72 6965 735f 6765 745f  directories_get_
-00014600: 636f 7272 6563 745f 6465 7669 6365 5f6e  correct_device_n
-00014610: 756d 6265 7228 7365 6c66 293a 0a20 2020  umber(self):.   
-00014620: 2020 2020 2073 656c 662e 6164 645f 6d6f       self.add_mo
-00014630: 756e 745f 706f 696e 7473 2829 0a20 2020  unt_points().   
-00014640: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00014650: 4571 7561 6c28 312c 2073 656c 662e 6669  Equal(1, self.fi
-00014660: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
-00014670: 6469 7228 2221 666f 6f31 2162 6172 2229  dir("!foo1!bar")
-00014680: 2e73 745f 6465 7629 0a20 2020 2020 2020  .st_dev).       
-00014690: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000146a0: 6c28 322c 2073 656c 662e 6669 6c65 7379  l(2, self.filesy
-000146b0: 7374 656d 2e63 7265 6174 655f 6469 7228  stem.create_dir(
-000146c0: 2221 666f 6f21 6261 7222 292e 7374 5f64  "!foo!bar").st_d
-000146d0: 6576 290a 2020 2020 2020 2020 7365 6c66  ev).        self
-000146e0: 2e61 7373 6572 7445 7175 616c 2834 2c20  .assertEqual(4, 
-000146f0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00014700: 6372 6561 7465 5f64 6972 2822 2166 6f6f  create_dir("!foo
-00014710: 2162 617a 2166 6f6f 2162 6172 2229 2e73  !baz!foo!bar").s
-00014720: 745f 6465 7629 0a0a 2020 2020 6465 6620  t_dev)..    def 
-00014730: 7465 7374 5f74 6861 745f 6e65 775f 6669  test_that_new_fi
-00014740: 6c65 735f 6765 745f 636f 7272 6563 745f  les_get_correct_
-00014750: 6465 7669 6365 5f6e 756d 6265 7228 7365  device_number(se
-00014760: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00014770: 662e 6164 645f 6d6f 756e 745f 706f 696e  f.add_mount_poin
-00014780: 7473 2829 0a20 2020 2020 2020 2073 656c  ts().        sel
-00014790: 662e 6173 7365 7274 4571 7561 6c28 312c  f.assertEqual(1,
-000147a0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-000147b0: 2e63 7265 6174 655f 6669 6c65 2822 2166  .create_file("!f
-000147c0: 6f6f 3121 6261 7222 292e 7374 5f64 6576  oo1!bar").st_dev
-000147d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000147e0: 7373 6572 7445 7175 616c 2832 2c20 7365  ssertEqual(2, se
-000147f0: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
-00014800: 6561 7465 5f66 696c 6528 2221 666f 6f21  eate_file("!foo!
-00014810: 6261 7222 292e 7374 5f64 6576 290a 2020  bar").st_dev).  
-00014820: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00014830: 7445 7175 616c 2834 2c20 7365 6c66 2e66  tEqual(4, self.f
-00014840: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
-00014850: 5f66 696c 6528 2221 666f 6f21 6261 7a21  _file("!foo!baz!
-00014860: 666f 6f21 6261 7222 292e 7374 5f64 6576  foo!bar").st_dev
-00014870: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00014880: 7468 6174 5f6d 6f75 6e74 5f70 6f69 6e74  that_mount_point
-00014890: 5f63 616e 6e6f 745f 6265 5f61 6464 6564  _cannot_be_added
-000148a0: 5f74 7769 6365 2873 656c 6629 3a0a 2020  _twice(self):.  
-000148b0: 2020 2020 2020 7365 6c66 2e61 6464 5f6d        self.add_m
-000148c0: 6f75 6e74 5f70 6f69 6e74 7328 290a 2020  ount_points().  
-000148d0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000148e0: 7261 6973 6573 5f6f 735f 6572 726f 7228  raises_os_error(
-000148f0: 6572 726e 6f2e 4545 5849 5354 293a 0a20  errno.EEXIST):. 
-00014900: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00014910: 6669 6c65 7379 7374 656d 2e61 6464 5f6d  filesystem.add_m
-00014920: 6f75 6e74 5f70 6f69 6e74 2822 2166 6f6f  ount_point("!foo
-00014930: 2229 0a20 2020 2020 2020 2077 6974 6820  ").        with 
-00014940: 7365 6c66 2e72 6169 7365 735f 6f73 5f65  self.raises_os_e
-00014950: 7272 6f72 2865 7272 6e6f 2e45 4558 4953  rror(errno.EEXIS
-00014960: 5429 3a0a 2020 2020 2020 2020 2020 2020  T):.            
-00014970: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00014980: 6164 645f 6d6f 756e 745f 706f 696e 7428  add_mount_point(
-00014990: 2221 666f 6f21 2229 0a0a 2020 2020 6465  "!foo!")..    de
-000149a0: 6620 7465 7374 5f74 6861 745f 6472 6976  f test_that_driv
-000149b0: 6573 5f61 7265 5f61 7574 6f5f 6d6f 756e  es_are_auto_moun
-000149c0: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
-000149d0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-000149e0: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
-000149f0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00014a00: 7365 6c66 2e61 6464 5f6d 6f75 6e74 5f70  self.add_mount_p
-00014a10: 6f69 6e74 7328 290a 2020 2020 2020 2020  oints().        
-00014a20: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00014a30: 6372 6561 7465 5f64 6972 2822 643a 2166  create_dir("d:!f
-00014a40: 6f6f 2162 6172 2229 0a20 2020 2020 2020  oo!bar").       
-00014a50: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00014a60: 2e63 7265 6174 655f 6669 6c65 2822 643a  .create_file("d:
-00014a70: 2166 6f6f 2162 617a 2229 0a20 2020 2020  !foo!baz").     
-00014a80: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-00014a90: 656d 2e63 7265 6174 655f 6669 6c65 2822  em.create_file("
-00014aa0: 7a3a 2166 6f6f 2162 617a 2229 0a20 2020  z:!foo!baz").   
-00014ab0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00014ac0: 4571 7561 6c28 352c 2073 656c 662e 6669  Equal(5, self.fi
-00014ad0: 6c65 7379 7374 656d 2e67 6574 5f6f 626a  lesystem.get_obj
-00014ae0: 6563 7428 2264 3a22 292e 7374 5f64 6576  ect("d:").st_dev
-00014af0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00014b00: 7373 6572 7445 7175 616c 2835 2c20 7365  ssertEqual(5, se
-00014b10: 6c66 2e66 696c 6573 7973 7465 6d2e 6765  lf.filesystem.ge
-00014b20: 745f 6f62 6a65 6374 2822 643a 2166 6f6f  t_object("d:!foo
-00014b30: 2162 6172 2229 2e73 745f 6465 7629 0a20  !bar").st_dev). 
-00014b40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00014b50: 7274 4571 7561 6c28 352c 2073 656c 662e  rtEqual(5, self.
-00014b60: 6669 6c65 7379 7374 656d 2e67 6574 5f6f  filesystem.get_o
-00014b70: 626a 6563 7428 2264 3a21 666f 6f21 6261  bject("d:!foo!ba
-00014b80: 7a22 292e 7374 5f64 6576 290a 2020 2020  z").st_dev).    
-00014b90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00014ba0: 7175 616c 2836 2c20 7365 6c66 2e66 696c  qual(6, self.fil
-00014bb0: 6573 7973 7465 6d2e 6765 745f 6f62 6a65  esystem.get_obje
-00014bc0: 6374 2822 7a3a 2166 6f6f 2162 617a 2229  ct("z:!foo!baz")
-00014bd0: 2e73 745f 6465 7629 0a0a 2020 2020 6465  .st_dev)..    de
-00014be0: 6620 7465 7374 5f74 6861 745f 6472 6976  f test_that_driv
-00014bf0: 6573 5f61 7265 5f61 7574 6f5f 6d6f 756e  es_are_auto_moun
-00014c00: 7465 645f 6361 7365 5f69 6e73 656e 7369  ted_case_insensi
-00014c10: 7469 7665 2873 656c 6629 3a0a 2020 2020  tive(self):.    
-00014c20: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00014c30: 7465 6d2e 6973 5f77 696e 646f 7773 5f66  tem.is_windows_f
-00014c40: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
-00014c50: 2073 656c 662e 6164 645f 6d6f 756e 745f   self.add_mount_
-00014c60: 706f 696e 7473 2829 0a20 2020 2020 2020  points().       
-00014c70: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00014c80: 2e69 735f 6361 7365 5f73 656e 7369 7469  .is_case_sensiti
-00014c90: 7665 203d 2046 616c 7365 0a20 2020 2020  ve = False.     
-00014ca0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-00014cb0: 656d 2e63 7265 6174 655f 6469 7228 2244  em.create_dir("D
-00014cc0: 3a21 666f 6f21 6261 7222 290a 2020 2020  :!foo!bar").    
-00014cd0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00014ce0: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
-00014cf0: 2265 3a21 666f 6f21 6261 7a22 290a 2020  "e:!foo!baz").  
-00014d00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00014d10: 7445 7175 616c 2835 2c20 7365 6c66 2e66  tEqual(5, self.f
-00014d20: 696c 6573 7973 7465 6d2e 6765 745f 6f62  ilesystem.get_ob
-00014d30: 6a65 6374 2822 443a 2229 2e73 745f 6465  ject("D:").st_de
-00014d40: 7629 0a20 2020 2020 2020 2073 656c 662e  v).        self.
-00014d50: 6173 7365 7274 4571 7561 6c28 352c 2073  assertEqual(5, s
-00014d60: 656c 662e 6669 6c65 7379 7374 656d 2e67  elf.filesystem.g
-00014d70: 6574 5f6f 626a 6563 7428 2264 3a21 666f  et_object("d:!fo
-00014d80: 6f21 6261 7222 292e 7374 5f64 6576 290a  o!bar").st_dev).
-00014d90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014da0: 6572 7445 7175 616c 2836 2c20 7365 6c66  ertEqual(6, self
-00014db0: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
-00014dc0: 6f62 6a65 6374 2822 653a 2166 6f6f 2229  object("e:!foo")
-00014dd0: 2e73 745f 6465 7629 0a20 2020 2020 2020  .st_dev).       
-00014de0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00014df0: 6c28 362c 2073 656c 662e 6669 6c65 7379  l(6, self.filesy
-00014e00: 7374 656d 2e67 6574 5f6f 626a 6563 7428  stem.get_object(
-00014e10: 2245 3a21 466f 6f21 4261 7a22 292e 7374  "E:!Foo!Baz").st
-00014e20: 5f64 6576 290a 0a20 2020 2064 6566 2074  _dev)..    def t
-00014e30: 6573 745f 7468 6174 5f75 6e63 5f70 6174  est_that_unc_pat
-00014e40: 6873 5f61 7265 5f61 7574 6f5f 6d6f 756e  hs_are_auto_moun
-00014e50: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
-00014e60: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-00014e70: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
-00014e80: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00014e90: 7365 6c66 2e61 6464 5f6d 6f75 6e74 5f70  self.add_mount_p
-00014ea0: 6f69 6e74 7328 290a 2020 2020 2020 2020  oints().        
-00014eb0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00014ec0: 6372 6561 7465 5f64 6972 2822 2121 666f  create_dir("!!fo
-00014ed0: 6f21 6261 7221 6261 7a22 290a 2020 2020  o!bar!baz").    
-00014ee0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00014ef0: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
-00014f00: 2221 2166 6f6f 2162 6172 2162 6970 2162  "!!foo!bar!bip!b
-00014f10: 6f70 2229 0a20 2020 2020 2020 2073 656c  op").        sel
-00014f20: 662e 6173 7365 7274 4571 7561 6c28 352c  f.assertEqual(5,
-00014f30: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00014f40: 2e67 6574 5f6f 626a 6563 7428 2221 2166  .get_object("!!f
-00014f50: 6f6f 2162 6172 2229 2e73 745f 6465 7629  oo!bar").st_dev)
-00014f60: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014f70: 7365 7274 4571 7561 6c28 352c 2073 656c  sertEqual(5, sel
-00014f80: 662e 6669 6c65 7379 7374 656d 2e67 6574  f.filesystem.get
-00014f90: 5f6f 626a 6563 7428 2221 2166 6f6f 2162  _object("!!foo!b
-00014fa0: 6172 2162 6970 2162 6f70 2229 2e73 745f  ar!bip!bop").st_
-00014fb0: 6465 7629 0a0a 0a63 6c61 7373 2043 6f6e  dev)...class Con
-00014fc0: 7665 6e69 656e 6365 4d65 7468 6f64 5465  venienceMethodTe
-00014fd0: 7374 2852 6561 6c46 7354 6573 7443 6173  st(RealFsTestCas
-00014fe0: 6529 3a0a 2020 2020 6465 6620 7465 7374  e):.    def test
-00014ff0: 5f63 7265 6174 655f 6c69 6e6b 5f77 6974  _create_link_wit
-00015000: 685f 6e6f 6e5f 6578 6973 7465 6e74 5f70  h_non_existent_p
-00015010: 6172 656e 7428 7365 6c66 293a 0a20 2020  arent(self):.   
-00015020: 2020 2020 2073 656c 662e 736b 6970 5f69       self.skip_i
-00015030: 665f 7379 6d6c 696e 6b5f 6e6f 745f 7375  f_symlink_not_su
-00015040: 7070 6f72 7465 6428 290a 2020 2020 2020  pported().      
-00015050: 2020 6669 6c65 315f 7061 7468 203d 2073    file1_path = s
-00015060: 656c 662e 6d61 6b65 5f70 6174 6828 2274  elf.make_path("t
-00015070: 6573 745f 6669 6c65 3122 290a 2020 2020  est_file1").    
-00015080: 2020 2020 6c69 6e6b 5f70 6174 6820 3d20      link_path = 
-00015090: 7365 6c66 2e6d 616b 655f 7061 7468 2822  self.make_path("
-000150a0: 6e6f 6e65 7869 7374 656e 7422 2c20 2274  nonexistent", "t
-000150b0: 6573 745f 6669 6c65 3222 290a 0a20 2020  est_file2")..   
-000150c0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-000150d0: 7374 656d 2e63 7265 6174 655f 6669 6c65  stem.create_file
-000150e0: 2866 696c 6531 5f70 6174 682c 2063 6f6e  (file1_path, con
-000150f0: 7465 6e74 733d 226c 696e 6b20 7465 7374  tents="link test
-00015100: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00015110: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-00015120: 2e6f 732e 7374 6174 2866 696c 6531 5f70  .os.stat(file1_p
-00015130: 6174 6829 2e73 745f 6e6c 696e 6b2c 2031  ath).st_nlink, 1
-00015140: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
-00015150: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
-00015160: 5f6c 696e 6b28 6669 6c65 315f 7061 7468  _link(file1_path
-00015170: 2c20 6c69 6e6b 5f70 6174 6829 0a20 2020  , link_path).   
-00015180: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00015190: 4571 7561 6c28 7365 6c66 2e6f 732e 7374  Equal(self.os.st
-000151a0: 6174 2866 696c 6531 5f70 6174 6829 2e73  at(file1_path).s
-000151b0: 745f 6e6c 696e 6b2c 2032 290a 2020 2020  t_nlink, 2).    
-000151c0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-000151d0: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
-000151e0: 7465 6d2e 6578 6973 7473 286c 696e 6b5f  tem.exists(link_
-000151f0: 7061 7468 2929 0a0a 2020 2020 6465 6620  path))..    def 
-00015200: 7465 7374 5f63 7265 6174 655f 7379 6d6c  test_create_syml
-00015210: 696e 6b5f 7769 7468 5f6e 6f6e 5f65 7869  ink_with_non_exi
-00015220: 7374 656e 745f 7061 7265 6e74 2873 656c  stent_parent(sel
-00015230: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00015240: 2e73 6b69 705f 6966 5f73 796d 6c69 6e6b  .skip_if_symlink
-00015250: 5f6e 6f74 5f73 7570 706f 7274 6564 2829  _not_supported()
-00015260: 0a20 2020 2020 2020 2066 696c 6531 5f70  .        file1_p
-00015270: 6174 6820 3d20 7365 6c66 2e6d 616b 655f  ath = self.make_
-00015280: 7061 7468 2822 7465 7374 5f66 696c 6531  path("test_file1
-00015290: 2229 0a20 2020 2020 2020 206c 696e 6b5f  ").        link_
-000152a0: 7061 7468 203d 2073 656c 662e 6d61 6b65  path = self.make
-000152b0: 5f70 6174 6828 226e 6f6e 6578 6973 7465  _path("nonexiste
-000152c0: 6e74 222c 2022 7465 7374 5f66 696c 6532  nt", "test_file2
-000152d0: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
-000152e0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-000152f0: 7465 5f66 696c 6528 6669 6c65 315f 7061  te_file(file1_pa
-00015300: 7468 2c20 636f 6e74 656e 7473 3d22 7379  th, contents="sy
-00015310: 6d6c 696e 6b20 7465 7374 2229 0a20 2020  mlink test").   
-00015320: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00015330: 7374 656d 2e63 7265 6174 655f 7379 6d6c  stem.create_syml
-00015340: 696e 6b28 6c69 6e6b 5f70 6174 682c 2066  ink(link_path, f
-00015350: 696c 6531 5f70 6174 6829 0a20 2020 2020  ile1_path).     
-00015360: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00015370: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
-00015380: 656d 2e65 7869 7374 7328 6c69 6e6b 5f70  em.exists(link_p
-00015390: 6174 6829 290a 2020 2020 2020 2020 7365  ath)).        se
-000153a0: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-000153b0: 6c66 2e66 696c 6573 7973 7465 6d2e 6973  lf.filesystem.is
-000153c0: 6c69 6e6b 286c 696e 6b5f 7061 7468 2929  link(link_path))
-000153d0: 0a0a 0a63 6c61 7373 2052 6561 6c46 696c  ...class RealFil
-000153e0: 6553 7973 7465 6d41 6363 6573 7354 6573  eSystemAccessTes
-000153f0: 7428 5265 616c 4673 5465 7374 4361 7365  t(RealFsTestCase
-00015400: 293a 0a20 2020 2064 6566 2073 6574 5570  ):.    def setUp
-00015410: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00015420: 2320 7573 6520 7468 6520 7265 616c 2070  # use the real p
-00015430: 6174 6820 7365 7061 7261 746f 7220 746f  ath separator to
-00015440: 2077 6f72 6b20 7769 7468 2074 6865 2072   work with the r
-00015450: 6561 6c20 6669 6c65 2073 7973 7465 6d0a  eal file system.
-00015460: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00015470: 6573 7973 7465 6d20 3d20 6661 6b65 5f66  esystem = fake_f
-00015480: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
-00015490: 6c65 7379 7374 656d 2829 0a20 2020 2020  lesystem().     
-000154a0: 2020 2073 656c 662e 6661 6b65 5f6f 7065     self.fake_ope
-000154b0: 6e20 3d20 6661 6b65 5f66 696c 6573 7973  n = fake_filesys
-000154c0: 7465 6d2e 4661 6b65 4669 6c65 4f70 656e  tem.FakeFileOpen
-000154d0: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
-000154e0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
-000154f0: 7966 616b 6566 735f 7061 7468 203d 206f  yfakefs_path = o
-00015500: 732e 7061 7468 2e73 706c 6974 286f 732e  s.path.split(os.
-00015510: 7061 7468 2e64 6972 6e61 6d65 286f 732e  path.dirname(os.
-00015520: 7061 7468 2e61 6273 7061 7468 285f 5f66  path.abspath(__f
-00015530: 696c 655f 5f29 2929 5b0a 2020 2020 2020  ile__)))[.      
-00015540: 2020 2020 2020 300a 2020 2020 2020 2020        0.        
-00015550: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
-00015560: 6f6f 745f 7061 7468 203d 206f 732e 7061  oot_path = os.pa
-00015570: 7468 2e73 706c 6974 2873 656c 662e 7079  th.split(self.py
-00015580: 6661 6b65 6673 5f70 6174 6829 5b30 5d0a  fakefs_path)[0].
-00015590: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-000155a0: 645f 6e6f 6e5f 6578 6973 7469 6e67 5f72  d_non_existing_r
-000155b0: 6561 6c5f 6669 6c65 5f72 6169 7365 7328  eal_file_raises(
-000155c0: 7365 6c66 293a 0a20 2020 2020 2020 206e  self):.        n
-000155d0: 6f6e 6578 6973 7469 6e67 5f70 6174 6820  onexisting_path 
-000155e0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2822  = os.path.join("
-000155f0: 6e6f 6e65 7869 7374 696e 6722 2c20 2274  nonexisting", "t
-00015600: 6573 742e 7478 7422 290a 2020 2020 2020  est.txt").      
-00015610: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00015620: 7274 5261 6973 6573 284f 5345 7272 6f72  rtRaises(OSError
-00015630: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00015640: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
-00015650: 6464 5f72 6561 6c5f 6669 6c65 286e 6f6e  dd_real_file(non
-00015660: 6578 6973 7469 6e67 5f70 6174 6829 0a20  existing_path). 
-00015670: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015680: 7274 4661 6c73 6528 7365 6c66 2e66 696c  rtFalse(self.fil
-00015690: 6573 7973 7465 6d2e 6578 6973 7473 286e  esystem.exists(n
-000156a0: 6f6e 6578 6973 7469 6e67 5f70 6174 6829  onexisting_path)
-000156b0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000156c0: 6164 645f 6e6f 6e5f 6578 6973 7469 6e67  add_non_existing
-000156d0: 5f72 6561 6c5f 6469 7265 6374 6f72 795f  _real_directory_
-000156e0: 7261 6973 6573 2873 656c 6629 3a0a 2020  raises(self):.  
-000156f0: 2020 2020 2020 6e6f 6e65 7869 7374 696e        nonexistin
-00015700: 675f 7061 7468 203d 2022 2f6e 6f6e 6578  g_path = "/nonex
-00015710: 6973 7469 6e67 220a 2020 2020 2020 2020  isting".        
-00015720: 7769 7468 2073 656c 662e 7261 6973 6573  with self.raises
-00015730: 5f6f 735f 6572 726f 7228 6572 726e 6f2e  _os_error(errno.
-00015740: 454e 4f45 4e54 293a 0a20 2020 2020 2020  ENOENT):.       
-00015750: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00015760: 7374 656d 2e61 6464 5f72 6561 6c5f 6469  stem.add_real_di
-00015770: 7265 6374 6f72 7928 6e6f 6e65 7869 7374  rectory(nonexist
-00015780: 696e 675f 7061 7468 290a 2020 2020 2020  ing_path).      
-00015790: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-000157a0: 7365 2873 656c 662e 6669 6c65 7379 7374  se(self.filesyst
-000157b0: 656d 2e65 7869 7374 7328 6e6f 6e65 7869  em.exists(nonexi
-000157c0: 7374 696e 675f 7061 7468 2929 0a0a 2020  sting_path))..  
-000157d0: 2020 6465 6620 7465 7374 5f65 7869 7374    def test_exist
-000157e0: 696e 675f 6661 6b65 5f66 696c 655f 7261  ing_fake_file_ra
-000157f0: 6973 6573 2873 656c 6629 3a0a 2020 2020  ises(self):.    
-00015800: 2020 2020 7265 616c 5f66 696c 655f 7061      real_file_pa
-00015810: 7468 203d 205f 5f66 696c 655f 5f0a 2020  th = __file__.  
-00015820: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00015830: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
-00015840: 6528 7265 616c 5f66 696c 655f 7061 7468  e(real_file_path
-00015850: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00015860: 656c 662e 7261 6973 6573 5f6f 735f 6572  elf.raises_os_er
-00015870: 726f 7228 6572 726e 6f2e 4545 5849 5354  ror(errno.EEXIST
-00015880: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00015890: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
-000158a0: 6464 5f72 6561 6c5f 6669 6c65 2872 6561  dd_real_file(rea
-000158b0: 6c5f 6669 6c65 5f70 6174 6829 0a0a 2020  l_file_path)..  
-000158c0: 2020 4063 6f6e 7465 7874 6c69 622e 636f    @contextlib.co
-000158d0: 6e74 6578 746d 616e 6167 6572 0a20 2020  ntextmanager.   
-000158e0: 2064 6566 2063 7265 6174 655f 7265 616c   def create_real
-000158f0: 5f70 6174 6873 2873 656c 6629 3a0a 2020  _paths(self):.  
-00015900: 2020 2020 2020 7265 616c 5f64 6972 5f72        real_dir_r
-00015910: 6f6f 7420 3d20 6f73 2e70 6174 682e 6a6f  oot = os.path.jo
-00015920: 696e 2874 656d 7066 696c 652e 6765 7474  in(tempfile.gett
-00015930: 656d 7064 6972 2829 2c20 2272 6f6f 7422  empdir(), "root"
-00015940: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-00015950: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-00015960: 6972 5f6e 616d 6520 696e 2028 2266 6f6f  ir_name in ("foo
-00015970: 222c 2022 6261 7222 293a 0a20 2020 2020  ", "bar"):.     
-00015980: 2020 2020 2020 2020 2020 2072 6561 6c5f             real_
-00015990: 6469 7220 3d20 6f73 2e70 6174 682e 6a6f  dir = os.path.jo
-000159a0: 696e 2872 6561 6c5f 6469 725f 726f 6f74  in(real_dir_root
-000159b0: 2c20 6469 725f 6e61 6d65 290a 2020 2020  , dir_name).    
-000159c0: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
-000159d0: 616b 6564 6972 7328 7265 616c 5f64 6972  akedirs(real_dir
-000159e0: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
-000159f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015a00: 2077 6974 6820 6f70 656e 286f 732e 7061   with open(os.pa
-00015a10: 7468 2e6a 6f69 6e28 7265 616c 5f64 6972  th.join(real_dir
-00015a20: 2c20 2274 6573 742e 7478 7422 292c 2022  , "test.txt"), "
-00015a30: 7722 2920 6173 2066 3a0a 2020 2020 2020  w") as f:.      
-00015a40: 2020 2020 2020 2020 2020 2020 2020 662e                f.
-00015a50: 7772 6974 6528 2274 6573 7422 290a 2020  write("test").  
-00015a60: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00015a70: 625f 6469 7220 3d20 6f73 2e70 6174 682e  b_dir = os.path.
-00015a80: 6a6f 696e 2872 6561 6c5f 6469 722c 2022  join(real_dir, "
-00015a90: 7375 6222 290a 2020 2020 2020 2020 2020  sub").          
-00015aa0: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
-00015ab0: 7328 7375 625f 6469 722c 2065 7869 7374  s(sub_dir, exist
-00015ac0: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
-00015ad0: 2020 2020 2020 2020 2020 7769 7468 206f            with o
-00015ae0: 7065 6e28 6f73 2e70 6174 682e 6a6f 696e  pen(os.path.join
-00015af0: 2873 7562 5f64 6972 2c20 2273 7562 2e74  (sub_dir, "sub.t
-00015b00: 7874 2229 2c20 2277 2229 2061 7320 663a  xt"), "w") as f:
-00015b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b20: 2020 2020 2066 2e77 7269 7465 2822 7375       f.write("su
-00015b30: 6222 290a 2020 2020 2020 2020 2020 2020  b").            
-00015b40: 7969 656c 6420 7265 616c 5f64 6972 5f72  yield real_dir_r
-00015b50: 6f6f 740a 2020 2020 2020 2020 6669 6e61  oot.        fina
-00015b60: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00015b70: 2073 6875 7469 6c2e 726d 7472 6565 2872   shutil.rmtree(r
-00015b80: 6561 6c5f 6469 725f 726f 6f74 2c20 6967  eal_dir_root, ig
-00015b90: 6e6f 7265 5f65 7272 6f72 733d 5472 7565  nore_errors=True
-00015ba0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00015bb0: 6578 6973 7469 6e67 5f66 616b 655f 6469  existing_fake_di
-00015bc0: 7265 6374 6f72 795f 6973 5f6d 6572 6765  rectory_is_merge
-00015bd0: 645f 6c61 7a69 6c79 2873 656c 6629 3a0a  d_lazily(self):.
-00015be0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00015bf0: 6573 7973 7465 6d2e 6372 6561 7465 5f66  esystem.create_f
-00015c00: 696c 6528 6f73 2e70 6174 682e 6a6f 696e  ile(os.path.join
-00015c10: 2822 2f22 2c20 2272 6f6f 7422 2c20 2266  ("/", "root", "f
-00015c20: 6f6f 222c 2022 7465 7374 312e 7478 7422  oo", "test1.txt"
-00015c30: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00015c40: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
-00015c50: 655f 6469 7228 6f73 2e70 6174 682e 6a6f  e_dir(os.path.jo
-00015c60: 696e 2822 726f 6f74 222c 2022 6261 7a22  in("root", "baz"
-00015c70: 2929 0a20 2020 2020 2020 2077 6974 6820  )).        with 
-00015c80: 7365 6c66 2e63 7265 6174 655f 7265 616c  self.create_real
-00015c90: 5f70 6174 6873 2829 2061 7320 726f 6f74  _paths() as root
-00015ca0: 5f64 6972 3a0a 2020 2020 2020 2020 2020  _dir:.          
-00015cb0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-00015cc0: 6d2e 6164 645f 7265 616c 5f64 6972 6563  m.add_real_direc
-00015cd0: 746f 7279 2872 6f6f 745f 6469 722c 2074  tory(root_dir, t
-00015ce0: 6172 6765 745f 7061 7468 3d22 2f72 6f6f  arget_path="/roo
-00015cf0: 7422 290a 2020 2020 2020 2020 2020 2020  t").            
-00015d00: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00015d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d20: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00015d30: 2e65 7869 7374 7328 6f73 2e70 6174 682e  .exists(os.path.
-00015d40: 6a6f 696e 2822 726f 6f74 222c 2022 666f  join("root", "fo
-00015d50: 6f22 2c20 2274 6573 742e 7478 7422 2929  o", "test.txt"))
-00015d60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00015d70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00015d80: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
-00015d90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015da0: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
-00015db0: 7473 286f 732e 7061 7468 2e6a 6f69 6e28  ts(os.path.join(
-00015dc0: 2272 6f6f 7422 2c20 2266 6f6f 222c 2022  "root", "foo", "
-00015dd0: 7465 7374 312e 7478 7422 2929 0a20 2020  test1.txt")).   
-00015de0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015df0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015e00: 7274 5472 7565 280a 2020 2020 2020 2020  rtTrue(.        
-00015e10: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00015e20: 6573 7973 7465 6d2e 6578 6973 7473 286f  esystem.exists(o
-00015e30: 732e 7061 7468 2e6a 6f69 6e28 2272 6f6f  s.path.join("roo
-00015e40: 7422 2c20 2262 6172 222c 2022 7375 6222  t", "bar", "sub"
-00015e50: 2c20 2273 7562 2e74 7874 2229 290a 2020  , "sub.txt")).  
-00015e60: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00015e70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00015e80: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
-00015e90: 6573 7973 7465 6d2e 6578 6973 7473 286f  esystem.exists(o
-00015ea0: 732e 7061 7468 2e6a 6f69 6e28 2272 6f6f  s.path.join("roo
-00015eb0: 7422 2c20 2262 617a 2229 2929 0a0a 2020  t", "baz")))..  
-00015ec0: 2020 6465 6620 7465 7374 5f65 7869 7374    def test_exist
-00015ed0: 696e 675f 6661 6b65 5f64 6972 6563 746f  ing_fake_directo
-00015ee0: 7279 5f69 735f 6d65 7267 6564 2873 656c  ry_is_merged(sel
-00015ef0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00015f00: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
-00015f10: 7465 5f66 696c 6528 6f73 2e70 6174 682e  te_file(os.path.
-00015f20: 6a6f 696e 2822 2f22 2c20 2272 6f6f 7422  join("/", "root"
-00015f30: 2c20 2266 6f6f 222c 2022 7465 7374 312e  , "foo", "test1.
-00015f40: 7478 7422 2929 0a20 2020 2020 2020 2073  txt")).        s
-00015f50: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
-00015f60: 7265 6174 655f 6469 7228 6f73 2e70 6174  reate_dir(os.pat
-00015f70: 682e 6a6f 696e 2822 726f 6f74 222c 2022  h.join("root", "
-00015f80: 6261 7a22 2929 0a20 2020 2020 2020 2077  baz")).        w
-00015f90: 6974 6820 7365 6c66 2e63 7265 6174 655f  ith self.create_
-00015fa0: 7265 616c 5f70 6174 6873 2829 2061 7320  real_paths() as 
-00015fb0: 726f 6f74 5f64 6972 3a0a 2020 2020 2020  root_dir:.      
-00015fc0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00015fd0: 7973 7465 6d2e 6164 645f 7265 616c 5f64  ystem.add_real_d
-00015fe0: 6972 6563 746f 7279 280a 2020 2020 2020  irectory(.      
-00015ff0: 2020 2020 2020 2020 2020 726f 6f74 5f64            root_d
-00016000: 6972 2c20 7461 7267 6574 5f70 6174 683d  ir, target_path=
-00016010: 222f 726f 6f74 222c 206c 617a 795f 7265  "/root", lazy_re
-00016020: 6164 3d46 616c 7365 0a20 2020 2020 2020  ad=False.       
-00016030: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00016040: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00016050: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-00016060: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00016070: 7465 6d2e 6578 6973 7473 286f 732e 7061  tem.exists(os.pa
-00016080: 7468 2e6a 6f69 6e28 2272 6f6f 7422 2c20  th.join("root", 
-00016090: 2266 6f6f 222c 2022 7465 7374 2e74 7874  "foo", "test.txt
-000160a0: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
-000160b0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000160c0: 6c66 2e61 7373 6572 7454 7275 6528 0a20  lf.assertTrue(. 
-000160d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000160e0: 656c 662e 6669 6c65 7379 7374 656d 2e65  elf.filesystem.e
-000160f0: 7869 7374 7328 6f73 2e70 6174 682e 6a6f  xists(os.path.jo
-00016100: 696e 2822 726f 6f74 222c 2022 666f 6f22  in("root", "foo"
-00016110: 2c20 2274 6573 7431 2e74 7874 2229 290a  , "test1.txt")).
-00016120: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00016130: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00016140: 7373 6572 7454 7275 6528 0a20 2020 2020  ssertTrue(.     
-00016150: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016160: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-00016170: 7328 6f73 2e70 6174 682e 6a6f 696e 2822  s(os.path.join("
-00016180: 726f 6f74 222c 2022 6261 7222 2c20 2273  root", "bar", "s
-00016190: 7562 222c 2022 7375 622e 7478 7422 2929  ub", "sub.txt"))
-000161a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000161b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000161c0: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
-000161d0: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-000161e0: 7328 6f73 2e70 6174 682e 6a6f 696e 2822  s(os.path.join("
-000161f0: 726f 6f74 222c 2022 6261 7a22 2929 290a  root", "baz"))).
-00016200: 0a20 2020 2064 6566 2074 6573 745f 6661  .    def test_fa
-00016210: 6b65 5f66 696c 6573 5f63 616e 6e6f 745f  ke_files_cannot_
-00016220: 6265 5f6f 7665 7277 7269 7474 656e 2873  be_overwritten(s
-00016230: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00016240: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
-00016250: 6561 7465 5f66 696c 6528 6f73 2e70 6174  eate_file(os.pat
-00016260: 682e 6a6f 696e 2822 2f22 2c20 2272 6f6f  h.join("/", "roo
-00016270: 7422 2c20 2266 6f6f 222c 2022 7465 7374  t", "foo", "test
-00016280: 2e74 7874 2229 290a 2020 2020 2020 2020  .txt")).        
-00016290: 7769 7468 2073 656c 662e 6372 6561 7465  with self.create
-000162a0: 5f72 6561 6c5f 7061 7468 7328 2920 6173  _real_paths() as
-000162b0: 2072 6f6f 745f 6469 723a 0a20 2020 2020   root_dir:.     
-000162c0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000162d0: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
-000162e0: 2865 7272 6e6f 2e45 4558 4953 5429 3a0a  (errno.EEXIST):.
-000162f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016300: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00016310: 6164 645f 7265 616c 5f64 6972 6563 746f  add_real_directo
-00016320: 7279 2872 6f6f 745f 6469 722c 2074 6172  ry(root_dir, tar
-00016330: 6765 745f 7061 7468 3d22 2f72 6f6f 7422  get_path="/root"
-00016340: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00016350: 6361 6e6e 6f74 5f6f 7665 7277 7269 7465  cannot_overwrite
-00016360: 5f66 696c 655f 7769 7468 5f64 6972 2873  _file_with_dir(s
-00016370: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00016380: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
-00016390: 6561 7465 5f66 696c 6528 6f73 2e70 6174  eate_file(os.pat
-000163a0: 682e 6a6f 696e 2822 2f22 2c20 2272 6f6f  h.join("/", "roo
-000163b0: 7422 2c20 2266 6f6f 2229 290a 2020 2020  t", "foo")).    
-000163c0: 2020 2020 7769 7468 2073 656c 662e 6372      with self.cr
-000163d0: 6561 7465 5f72 6561 6c5f 7061 7468 7328  eate_real_paths(
-000163e0: 2920 6173 2072 6f6f 745f 6469 723a 0a20  ) as root_dir:. 
-000163f0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00016400: 7365 6c66 2e72 6169 7365 735f 6f73 5f65  self.raises_os_e
-00016410: 7272 6f72 2865 7272 6e6f 2e45 4e4f 5444  rror(errno.ENOTD
-00016420: 4952 293a 0a20 2020 2020 2020 2020 2020  IR):.           
-00016430: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00016440: 7374 656d 2e61 6464 5f72 6561 6c5f 6469  stem.add_real_di
-00016450: 7265 6374 6f72 7928 726f 6f74 5f64 6972  rectory(root_dir
-00016460: 2c20 7461 7267 6574 5f70 6174 683d 222f  , target_path="/
-00016470: 726f 6f74 2f22 290a 0a20 2020 2064 6566  root/")..    def
-00016480: 2074 6573 745f 6361 6e6e 6f74 5f6f 7665   test_cannot_ove
-00016490: 7277 7269 7465 5f73 796d 6c69 6e6b 5f77  rwrite_symlink_w
-000164a0: 6974 685f 6469 7228 7365 6c66 293a 0a20  ith_dir(self):. 
-000164b0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-000164c0: 7379 7374 656d 2e63 7265 6174 655f 7379  system.create_sy
-000164d0: 6d6c 696e 6b28 0a20 2020 2020 2020 2020  mlink(.         
-000164e0: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
-000164f0: 222f 222c 2022 726f 6f74 222c 2022 666f  "/", "root", "fo
-00016500: 6f22 292c 206f 732e 7061 7468 2e6a 6f69  o"), os.path.joi
-00016510: 6e28 222f 222c 2022 726f 6f74 222c 2022  n("/", "root", "
-00016520: 6c69 6e6b 2229 0a20 2020 2020 2020 2029  link").        )
-00016530: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00016540: 6c66 2e63 7265 6174 655f 7265 616c 5f70  lf.create_real_p
-00016550: 6174 6873 2829 2061 7320 726f 6f74 5f64  aths() as root_d
-00016560: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-00016570: 7769 7468 2073 656c 662e 7261 6973 6573  with self.raises
-00016580: 5f6f 735f 6572 726f 7228 6572 726e 6f2e  _os_error(errno.
-00016590: 4545 5849 5354 293a 0a20 2020 2020 2020  EEXIST):.       
-000165a0: 2020 2020 2020 2020 2073 656c 662e 6669           self.fi
-000165b0: 6c65 7379 7374 656d 2e61 6464 5f72 6561  lesystem.add_rea
-000165c0: 6c5f 6469 7265 6374 6f72 7928 726f 6f74  l_directory(root
-000165d0: 5f64 6972 2c20 7461 7267 6574 5f70 6174  _dir, target_pat
-000165e0: 683d 222f 726f 6f74 2f22 290a 0a20 2020  h="/root/")..   
-000165f0: 2064 6566 2074 6573 745f 7379 6d6c 696e   def test_symlin
-00016600: 6b5f 6973 5f6d 6572 6765 6428 7365 6c66  k_is_merged(self
-00016610: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00016620: 736b 6970 5f69 665f 7379 6d6c 696e 6b5f  skip_if_symlink_
-00016630: 6e6f 745f 7375 7070 6f72 7465 6428 666f  not_supported(fo
-00016640: 7263 655f 7265 616c 5f66 733d 5472 7565  rce_real_fs=True
-00016650: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
-00016660: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
-00016670: 5f64 6972 286f 732e 7061 7468 2e6a 6f69  _dir(os.path.joi
-00016680: 6e28 222f 222c 2022 726f 6f74 222c 2022  n("/", "root", "
-00016690: 666f 6f22 2929 0a20 2020 2020 2020 2077  foo")).        w
-000166a0: 6974 6820 7365 6c66 2e63 7265 6174 655f  ith self.create_
-000166b0: 7265 616c 5f70 6174 6873 2829 2061 7320  real_paths() as 
-000166c0: 726f 6f74 5f64 6972 3a0a 2020 2020 2020  root_dir:.      
-000166d0: 2020 2020 2020 6c69 6e6b 5f70 6174 6820        link_path 
-000166e0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2872  = os.path.join(r
-000166f0: 6f6f 745f 6469 722c 2022 6c69 6e6b 2e74  oot_dir, "link.t
-00016700: 7874 2229 0a20 2020 2020 2020 2020 2020  xt").           
-00016710: 2074 6172 6765 745f 7061 7468 203d 206f   target_path = o
-00016720: 732e 7061 7468 2e6a 6f69 6e28 2266 6f6f  s.path.join("foo
-00016730: 222c 2022 7375 6222 2c20 2273 7562 2e74  ", "sub", "sub.t
-00016740: 7874 2229 0a20 2020 2020 2020 2020 2020  xt").           
-00016750: 206f 732e 7379 6d6c 696e 6b28 7461 7267   os.symlink(targ
-00016760: 6574 5f70 6174 682c 206c 696e 6b5f 7061  et_path, link_pa
-00016770: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00016780: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00016790: 6164 645f 7265 616c 5f64 6972 6563 746f  add_real_directo
-000167a0: 7279 2872 6f6f 745f 6469 722c 2074 6172  ry(root_dir, tar
-000167b0: 6765 745f 7061 7468 3d22 2f72 6f6f 7422  get_path="/root"
-000167c0: 290a 2020 2020 2020 2020 2020 2020 6661  ).            fa
-000167d0: 6b65 5f6c 696e 6b5f 7061 7468 203d 206f  ke_link_path = o
-000167e0: 732e 7061 7468 2e6a 6f69 6e28 222f 222c  s.path.join("/",
-000167f0: 2022 726f 6f74 222c 2022 6c69 6e6b 2e74   "root", "link.t
-00016800: 7874 2229 0a20 2020 2020 2020 2020 2020  xt").           
-00016810: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-00016820: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
-00016830: 2e65 7869 7374 7328 6661 6b65 5f6c 696e  .exists(fake_lin
-00016840: 6b5f 7061 7468 2929 0a20 2020 2020 2020  k_path)).       
-00016850: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00016860: 5472 7565 2873 656c 662e 6669 6c65 7379  True(self.filesy
-00016870: 7374 656d 2e69 736c 696e 6b28 6661 6b65  stem.islink(fake
-00016880: 5f6c 696e 6b5f 7061 7468 2929 0a0a 2020  _link_path))..  
-00016890: 2020 6465 6620 6368 6563 6b5f 6661 6b65    def check_fake
-000168a0: 5f66 696c 655f 7374 6174 2873 656c 662c  _file_stat(self,
-000168b0: 2066 616b 655f 6669 6c65 2c20 7265 616c   fake_file, real
-000168c0: 5f66 696c 655f 7061 7468 2c20 7461 7267  _file_path, targ
-000168d0: 6574 5f70 6174 683d 4e6f 6e65 293a 0a20  et_path=None):. 
-000168e0: 2020 2020 2020 2069 6620 7461 7267 6574         if target
-000168f0: 5f70 6174 6820 6973 204e 6f6e 6520 6f72  _path is None or
-00016900: 2074 6172 6765 745f 7061 7468 203d 3d20   target_path == 
-00016910: 7265 616c 5f66 696c 655f 7061 7468 3a0a  real_file_path:.
-00016920: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00016930: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
-00016940: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
-00016950: 7473 2872 6561 6c5f 6669 6c65 5f70 6174  ts(real_file_pat
-00016960: 6829 290a 2020 2020 2020 2020 656c 7365  h)).        else
-00016970: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00016980: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
-00016990: 656c 662e 6669 6c65 7379 7374 656d 2e65  elf.filesystem.e
-000169a0: 7869 7374 7328 7265 616c 5f66 696c 655f  xists(real_file_
-000169b0: 7061 7468 2929 0a20 2020 2020 2020 2020  path)).         
-000169c0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-000169d0: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
-000169e0: 656d 2e65 7869 7374 7328 7461 7267 6574  em.exists(target
-000169f0: 5f70 6174 6829 290a 0a20 2020 2020 2020  _path))..       
-00016a00: 2072 6561 6c5f 7374 6174 203d 206f 732e   real_stat = os.
-00016a10: 7374 6174 2872 6561 6c5f 6669 6c65 5f70  stat(real_file_p
-00016a20: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
-00016a30: 662e 6173 7365 7274 4973 4e6f 6e65 2866  f.assertIsNone(f
-00016a40: 616b 655f 6669 6c65 2e5f 6279 7465 5f63  ake_file._byte_c
-00016a50: 6f6e 7465 6e74 7329 0a20 2020 2020 2020  ontents).       
-00016a60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00016a70: 6c28 6661 6b65 5f66 696c 652e 7374 5f73  l(fake_file.st_s
-00016a80: 697a 652c 2072 6561 6c5f 7374 6174 2e73  ize, real_stat.s
-00016a90: 745f 7369 7a65 290a 2020 2020 2020 2020  t_size).        
-00016aa0: 7365 6c66 2e61 7373 6572 7441 6c6d 6f73  self.assertAlmos
-00016ab0: 7445 7175 616c 2866 616b 655f 6669 6c65  tEqual(fake_file
-00016ac0: 2e73 745f 6374 696d 652c 2072 6561 6c5f  .st_ctime, real_
-00016ad0: 7374 6174 2e73 745f 6374 696d 652c 2070  stat.st_ctime, p
-00016ae0: 6c61 6365 733d 3529 0a20 2020 2020 2020  laces=5).       
-00016af0: 2073 656c 662e 6173 7365 7274 416c 6d6f   self.assertAlmo
-00016b00: 7374 4571 7561 6c28 6661 6b65 5f66 696c  stEqual(fake_fil
-00016b10: 652e 7374 5f61 7469 6d65 2c20 7265 616c  e.st_atime, real
-00016b20: 5f73 7461 742e 7374 5f61 7469 6d65 2c20  _stat.st_atime, 
-00016b30: 706c 6163 6573 3d35 290a 2020 2020 2020  places=5).      
-00016b40: 2020 7365 6c66 2e61 7373 6572 7441 6c6d    self.assertAlm
-00016b50: 6f73 7445 7175 616c 2866 616b 655f 6669  ostEqual(fake_fi
-00016b60: 6c65 2e73 745f 6d74 696d 652c 2072 6561  le.st_mtime, rea
-00016b70: 6c5f 7374 6174 2e73 745f 6d74 696d 652c  l_stat.st_mtime,
-00016b80: 2070 6c61 6365 733d 3529 0a20 2020 2020   places=5).     
-00016b90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00016ba0: 7561 6c28 6661 6b65 5f66 696c 652e 7374  ual(fake_file.st
-00016bb0: 5f75 6964 2c20 7265 616c 5f73 7461 742e  _uid, real_stat.
-00016bc0: 7374 5f75 6964 290a 2020 2020 2020 2020  st_uid).        
-00016bd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016be0: 2866 616b 655f 6669 6c65 2e73 745f 6769  (fake_file.st_gi
-00016bf0: 642c 2072 6561 6c5f 7374 6174 2e73 745f  d, real_stat.st_
-00016c00: 6769 6429 0a0a 2020 2020 6465 6620 6368  gid)..    def ch
-00016c10: 6563 6b5f 7265 6164 5f6f 6e6c 795f 6669  eck_read_only_fi
-00016c20: 6c65 2873 656c 662c 2066 616b 655f 6669  le(self, fake_fi
-00016c30: 6c65 2c20 7265 616c 5f66 696c 655f 7061  le, real_file_pa
-00016c40: 7468 293a 0a20 2020 2020 2020 2077 6974  th):.        wit
-00016c50: 6820 6f70 656e 2872 6561 6c5f 6669 6c65  h open(real_file
-00016c60: 5f70 6174 682c 2022 7262 2229 2061 7320  _path, "rb") as 
-00016c70: 663a 0a20 2020 2020 2020 2020 2020 2072  f:.            r
-00016c80: 6561 6c5f 636f 6e74 656e 7473 203d 2066  eal_contents = f
-00016c90: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
-00016ca0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016cb0: 2866 616b 655f 6669 6c65 2e62 7974 655f  (fake_file.byte_
-00016cc0: 636f 6e74 656e 7473 2c20 7265 616c 5f63  contents, real_c
-00016cd0: 6f6e 7465 6e74 7329 0a20 2020 2020 2020  ontents).       
-00016ce0: 2069 6620 6e6f 7420 6973 5f72 6f6f 7428   if not is_root(
-00016cf0: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
-00016d00: 6974 6820 7365 6c66 2e72 6169 7365 735f  ith self.raises_
-00016d10: 6f73 5f65 7272 6f72 2865 7272 6e6f 2e45  os_error(errno.E
-00016d20: 4143 4345 5329 3a0a 2020 2020 2020 2020  ACCES):.        
-00016d30: 2020 2020 2020 2020 7365 6c66 2e66 616b          self.fak
-00016d40: 655f 6f70 656e 2872 6561 6c5f 6669 6c65  e_open(real_file
-00016d50: 5f70 6174 682c 2022 7722 290a 2020 2020  _path, "w").    
-00016d60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00016d70: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00016d80: 6661 6b65 5f6f 7065 6e28 7265 616c 5f66  fake_open(real_f
-00016d90: 696c 655f 7061 7468 2c20 2277 2229 3a0a  ile_path, "w"):.
-00016da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016db0: 7061 7373 0a0a 2020 2020 6465 6620 6368  pass..    def ch
-00016dc0: 6563 6b5f 7772 6974 6162 6c65 5f66 696c  eck_writable_fil
-00016dd0: 6528 7365 6c66 2c20 6661 6b65 5f66 696c  e(self, fake_fil
-00016de0: 652c 2072 6561 6c5f 6669 6c65 5f70 6174  e, real_file_pat
-00016df0: 6829 3a0a 2020 2020 2020 2020 7769 7468  h):.        with
-00016e00: 206f 7065 6e28 7265 616c 5f66 696c 655f   open(real_file_
-00016e10: 7061 7468 2c20 2272 6222 2920 6173 2066  path, "rb") as f
-00016e20: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00016e30: 616c 5f63 6f6e 7465 6e74 7320 3d20 662e  al_contents = f.
-00016e40: 7265 6164 2829 0a20 2020 2020 2020 2073  read().        s
-00016e50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00016e60: 6661 6b65 5f66 696c 652e 6279 7465 5f63  fake_file.byte_c
-00016e70: 6f6e 7465 6e74 732c 2072 6561 6c5f 636f  ontents, real_co
-00016e80: 6e74 656e 7473 290a 2020 2020 2020 2020  ntents).        
-00016e90: 7769 7468 2073 656c 662e 6661 6b65 5f6f  with self.fake_o
-00016ea0: 7065 6e28 7265 616c 5f66 696c 655f 7061  pen(real_file_pa
-00016eb0: 7468 2c20 2277 6222 2920 6173 2066 3a0a  th, "wb") as f:.
-00016ec0: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
-00016ed0: 6974 6528 6222 7465 7374 2229 0a20 2020  ite(b"test").   
-00016ee0: 2020 2020 2077 6974 6820 6f70 656e 2872       with open(r
-00016ef0: 6561 6c5f 6669 6c65 5f70 6174 682c 2022  eal_file_path, "
-00016f00: 7262 2229 2061 7320 663a 0a20 2020 2020  rb") as f:.     
-00016f10: 2020 2020 2020 2072 6561 6c5f 636f 6e74         real_cont
-00016f20: 656e 7473 3120 3d20 662e 7265 6164 2829  ents1 = f.read()
-00016f30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00016f40: 7365 7274 4571 7561 6c28 7265 616c 5f63  sertEqual(real_c
-00016f50: 6f6e 7465 6e74 7331 2c20 7265 616c 5f63  ontents1, real_c
-00016f60: 6f6e 7465 6e74 7329 0a20 2020 2020 2020  ontents).       
-00016f70: 2077 6974 6820 7365 6c66 2e66 616b 655f   with self.fake_
-00016f80: 6f70 656e 2872 6561 6c5f 6669 6c65 5f70  open(real_file_p
-00016f90: 6174 682c 2022 7262 2229 2061 7320 663a  ath, "rb") as f:
-00016fa0: 0a20 2020 2020 2020 2020 2020 2066 616b  .            fak
-00016fb0: 655f 636f 6e74 656e 7473 203d 2066 2e72  e_contents = f.r
-00016fc0: 6561 6428 290a 2020 2020 2020 2020 7365  ead().        se
-00016fd0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00016fe0: 616b 655f 636f 6e74 656e 7473 2c20 6222  ake_contents, b"
-00016ff0: 7465 7374 2229 0a0a 2020 2020 6465 6620  test")..    def 
-00017000: 7465 7374 5f61 6464 5f65 7869 7374 696e  test_add_existin
-00017010: 675f 7265 616c 5f66 696c 655f 7265 6164  g_real_file_read
-00017020: 5f6f 6e6c 7928 7365 6c66 293a 0a20 2020  _only(self):.   
-00017030: 2020 2020 2072 6561 6c5f 6669 6c65 5f70       real_file_p
-00017040: 6174 6820 3d20 6f73 2e70 6174 682e 6162  ath = os.path.ab
-00017050: 7370 6174 6828 5f5f 6669 6c65 5f5f 290a  spath(__file__).
-00017060: 2020 2020 2020 2020 6661 6b65 5f66 696c          fake_fil
-00017070: 6520 3d20 7365 6c66 2e66 696c 6573 7973  e = self.filesys
-00017080: 7465 6d2e 6164 645f 7265 616c 5f66 696c  tem.add_real_fil
-00017090: 6528 7265 616c 5f66 696c 655f 7061 7468  e(real_file_path
-000170a0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-000170b0: 6865 636b 5f66 616b 655f 6669 6c65 5f73  heck_fake_file_s
-000170c0: 7461 7428 6661 6b65 5f66 696c 652c 2072  tat(fake_file, r
-000170d0: 6561 6c5f 6669 6c65 5f70 6174 6829 0a20  eal_file_path). 
-000170e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000170f0: 7274 4571 7561 6c28 6661 6b65 5f66 696c  rtEqual(fake_fil
-00017100: 652e 7374 5f6d 6f64 6520 2620 306f 3333  e.st_mode & 0o33
-00017110: 332c 2030 290a 2020 2020 2020 2020 7365  3, 0).        se
-00017120: 6c66 2e63 6865 636b 5f72 6561 645f 6f6e  lf.check_read_on
-00017130: 6c79 5f66 696c 6528 6661 6b65 5f66 696c  ly_file(fake_fil
-00017140: 652c 2072 6561 6c5f 6669 6c65 5f70 6174  e, real_file_pat
-00017150: 6829 0a0a 2020 2020 6465 6620 7465 7374  h)..    def test
-00017160: 5f61 6464 5f65 7869 7374 696e 675f 7265  _add_existing_re
-00017170: 616c 5f66 696c 655f 7265 6164 5f77 7269  al_file_read_wri
-00017180: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-00017190: 2020 7265 616c 5f66 696c 655f 7061 7468    real_file_path
-000171a0: 203d 206f 732e 7061 7468 2e72 6561 6c70   = os.path.realp
-000171b0: 6174 6828 5f5f 6669 6c65 5f5f 290a 2020  ath(__file__).  
-000171c0: 2020 2020 2020 6661 6b65 5f66 696c 6520        fake_file 
-000171d0: 3d20 7365 6c66 2e66 696c 6573 7973 7465  = self.filesyste
-000171e0: 6d2e 6164 645f 7265 616c 5f66 696c 6528  m.add_real_file(
-000171f0: 7265 616c 5f66 696c 655f 7061 7468 2c20  real_file_path, 
-00017200: 7265 6164 5f6f 6e6c 793d 4661 6c73 6529  read_only=False)
-00017210: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-00017220: 6865 636b 5f66 616b 655f 6669 6c65 5f73  heck_fake_file_s
-00017230: 7461 7428 6661 6b65 5f66 696c 652c 2072  tat(fake_file, r
-00017240: 6561 6c5f 6669 6c65 5f70 6174 6829 0a20  eal_file_path). 
-00017250: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00017260: 7274 4571 7561 6c28 6661 6b65 5f66 696c  rtEqual(fake_fil
-00017270: 652e 7374 5f6d 6f64 652c 206f 732e 7374  e.st_mode, os.st
-00017280: 6174 2872 6561 6c5f 6669 6c65 5f70 6174  at(real_file_pat
-00017290: 6829 2e73 745f 6d6f 6465 290a 2020 2020  h).st_mode).    
-000172a0: 2020 2020 7365 6c66 2e63 6865 636b 5f77      self.check_w
-000172b0: 7269 7461 626c 655f 6669 6c65 2866 616b  ritable_file(fak
-000172c0: 655f 6669 6c65 2c20 7265 616c 5f66 696c  e_file, real_fil
-000172d0: 655f 7061 7468 290a 0a20 2020 2064 6566  e_path)..    def
-000172e0: 2074 6573 745f 6164 645f 7265 616c 5f66   test_add_real_f
-000172f0: 696c 655f 746f 5f65 7869 7374 696e 675f  ile_to_existing_
-00017300: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
-00017310: 2020 2020 7265 616c 5f66 696c 655f 7061      real_file_pa
-00017320: 7468 203d 206f 732e 7061 7468 2e61 6273  th = os.path.abs
-00017330: 7061 7468 285f 5f66 696c 655f 5f29 0a20  path(__file__). 
-00017340: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-00017350: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
-00017360: 6c65 2822 2f66 6f6f 2f62 6172 2229 0a20  le("/foo/bar"). 
-00017370: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00017380: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
-00017390: 2865 7272 6e6f 2e45 4558 4953 5429 3a0a  (errno.EEXIST):.
-000173a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000173b0: 2e66 696c 6573 7973 7465 6d2e 6164 645f  .filesystem.add_
-000173c0: 7265 616c 5f66 696c 6528 7265 616c 5f66  real_file(real_f
-000173d0: 696c 655f 7061 7468 2c20 7461 7267 6574  ile_path, target
-000173e0: 5f70 6174 683d 222f 666f 6f2f 6261 7222  _path="/foo/bar"
-000173f0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00017400: 6164 645f 7265 616c 5f66 696c 655f 746f  add_real_file_to
-00017410: 5f6e 6f6e 5f65 7869 7374 696e 675f 7061  _non_existing_pa
-00017420: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
-00017430: 2020 7265 616c 5f66 696c 655f 7061 7468    real_file_path
-00017440: 203d 206f 732e 7061 7468 2e61 6273 7061   = os.path.abspa
-00017450: 7468 285f 5f66 696c 655f 5f29 0a20 2020  th(__file__).   
-00017460: 2020 2020 2066 616b 655f 6669 6c65 203d       fake_file =
-00017470: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00017480: 2e61 6464 5f72 6561 6c5f 6669 6c65 280a  .add_real_file(.
-00017490: 2020 2020 2020 2020 2020 2020 7265 616c              real
-000174a0: 5f66 696c 655f 7061 7468 2c20 7461 7267  _file_path, targ
-000174b0: 6574 5f70 6174 683d 222f 666f 6f2f 6261  et_path="/foo/ba
-000174c0: 7222 0a20 2020 2020 2020 2029 0a20 2020  r".        ).   
-000174d0: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
-000174e0: 6661 6b65 5f66 696c 655f 7374 6174 2866  fake_file_stat(f
-000174f0: 616b 655f 6669 6c65 2c20 7265 616c 5f66  ake_file, real_f
-00017500: 696c 655f 7061 7468 2c20 7461 7267 6574  ile_path, target
-00017510: 5f70 6174 683d 222f 666f 6f2f 6261 7222  _path="/foo/bar"
-00017520: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00017530: 7772 6974 655f 746f 5f72 6561 6c5f 6669  write_to_real_fi
-00017540: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
-00017550: 2020 2320 7265 6772 6573 7369 6f6e 2074    # regression t
-00017560: 6573 7420 666f 7220 2334 3730 0a20 2020  est for #470.   
-00017570: 2020 2020 2072 6561 6c5f 6669 6c65 5f70       real_file_p
-00017580: 6174 6820 3d20 6f73 2e70 6174 682e 6162  ath = os.path.ab
-00017590: 7370 6174 6828 5f5f 6669 6c65 5f5f 290a  spath(__file__).
-000175a0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-000175b0: 6573 7973 7465 6d2e 6164 645f 7265 616c  esystem.add_real
-000175c0: 5f66 696c 6528 7265 616c 5f66 696c 655f  _file(real_file_
-000175d0: 7061 7468 2c20 7265 6164 5f6f 6e6c 793d  path, read_only=
-000175e0: 4661 6c73 6529 0a20 2020 2020 2020 2077  False).        w
-000175f0: 6974 6820 7365 6c66 2e66 616b 655f 6f70  ith self.fake_op
-00017600: 656e 2872 6561 6c5f 6669 6c65 5f70 6174  en(real_file_pat
-00017610: 682c 2022 7722 2920 6173 2066 3a0a 2020  h, "w") as f:.  
-00017620: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
-00017630: 6528 2266 6f6f 2229 0a0a 2020 2020 2020  e("foo")..      
-00017640: 2020 7769 7468 2073 656c 662e 6661 6b65    with self.fake
-00017650: 5f6f 7065 6e28 7265 616c 5f66 696c 655f  _open(real_file_
-00017660: 7061 7468 2c20 2272 6222 2920 6173 2066  path, "rb") as f
-00017670: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00017680: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00017690: 2266 6f6f 222c 2066 2e72 6561 6428 2929  "foo", f.read())
-000176a0: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-000176b0: 6464 5f65 7869 7374 696e 675f 7265 616c  dd_existing_real
-000176c0: 5f64 6972 6563 746f 7279 5f72 6561 645f  _directory_read_
-000176d0: 6f6e 6c79 2873 656c 6629 3a0a 2020 2020  only(self):.    
-000176e0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-000176f0: 7465 6d2e 6164 645f 7265 616c 5f64 6972  tem.add_real_dir
-00017700: 6563 746f 7279 2873 656c 662e 7079 6661  ectory(self.pyfa
-00017710: 6b65 6673 5f70 6174 6829 0a20 2020 2020  kefs_path).     
-00017720: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00017730: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
-00017740: 656d 2e65 7869 7374 7328 7365 6c66 2e70  em.exists(self.p
-00017750: 7966 616b 6566 735f 7061 7468 2929 0a20  yfakefs_path)). 
-00017760: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00017770: 7274 5472 7565 280a 2020 2020 2020 2020  rtTrue(.        
-00017780: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00017790: 7465 6d2e 6578 6973 7473 280a 2020 2020  tem.exists(.    
-000177a0: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
-000177b0: 6174 682e 6a6f 696e 2873 656c 662e 7079  ath.join(self.py
-000177c0: 6661 6b65 6673 5f70 6174 682c 2022 6661  fakefs_path, "fa
-000177d0: 6b65 5f66 696c 6573 7973 7465 6d2e 7079  ke_filesystem.py
-000177e0: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
-000177f0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00017800: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00017810: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-00017820: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00017830: 6578 6973 7473 286f 732e 7061 7468 2e6a  exists(os.path.j
-00017840: 6f69 6e28 7365 6c66 2e70 7966 616b 6566  oin(self.pyfakef
-00017850: 735f 7061 7468 2c20 2266 616b 655f 7061  s_path, "fake_pa
-00017860: 7468 6c69 622e 7079 2229 290a 2020 2020  thlib.py")).    
-00017870: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
-00017880: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
-00017890: 7468 2e6a 6f69 6e28 7365 6c66 2e70 7966  th.join(self.pyf
-000178a0: 616b 6566 735f 7061 7468 2c20 2266 616b  akefs_path, "fak
-000178b0: 655f 6669 6c65 7379 7374 656d 5f73 6875  e_filesystem_shu
-000178c0: 7469 6c2e 7079 2229 0a20 2020 2020 2020  til.py").       
-000178d0: 2066 616b 655f 6669 6c65 203d 2073 656c   fake_file = sel
-000178e0: 662e 6669 6c65 7379 7374 656d 2e72 6573  f.filesystem.res
-000178f0: 6f6c 7665 2866 696c 655f 7061 7468 290a  olve(file_path).
-00017900: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
-00017910: 636b 5f66 616b 655f 6669 6c65 5f73 7461  ck_fake_file_sta
-00017920: 7428 6661 6b65 5f66 696c 652c 2066 696c  t(fake_file, fil
-00017930: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
-00017940: 7365 6c66 2e63 6865 636b 5f72 6561 645f  self.check_read_
-00017950: 6f6e 6c79 5f66 696c 6528 6661 6b65 5f66  only_file(fake_f
-00017960: 696c 652c 2066 696c 655f 7061 7468 290a  ile, file_path).
-00017970: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-00017980: 645f 6578 6973 7469 6e67 5f72 6561 6c5f  d_existing_real_
-00017990: 6469 7265 6374 6f72 795f 7472 6565 2873  directory_tree(s
-000179a0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000179b0: 6c66 2e66 696c 6573 7973 7465 6d2e 6164  lf.filesystem.ad
-000179c0: 645f 7265 616c 5f64 6972 6563 746f 7279  d_real_directory
-000179d0: 2873 656c 662e 726f 6f74 5f70 6174 6829  (self.root_path)
-000179e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000179f0: 7365 7274 5472 7565 280a 2020 2020 2020  sertTrue(.      
-00017a00: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00017a10: 7973 7465 6d2e 6578 6973 7473 280a 2020  ystem.exists(.  
-00017a20: 2020 2020 2020 2020 2020 2020 2020 6f73                os
-00017a30: 2e70 6174 682e 6a6f 696e 280a 2020 2020  .path.join(.    
-00017a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a50: 7365 6c66 2e72 6f6f 745f 7061 7468 2c0a  self.root_path,.
-00017a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a70: 2020 2020 2270 7966 616b 6566 7322 2c0a      "pyfakefs",.
-00017a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a90: 2020 2020 2274 6573 7473 222c 0a20 2020      "tests",.   
-00017aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ab0: 2022 6661 6b65 5f66 696c 6573 7973 7465   "fake_filesyste
-00017ac0: 6d5f 7465 7374 2e70 7922 2c0a 2020 2020  m_test.py",.    
-00017ad0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00017ae0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00017af0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00017b00: 6c66 2e61 7373 6572 7454 7275 6528 0a20  lf.assertTrue(. 
-00017b10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017b20: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-00017b30: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00017b40: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
-00017b50: 7365 6c66 2e72 6f6f 745f 7061 7468 2c20  self.root_path, 
-00017b60: 2270 7966 616b 6566 7322 2c20 2266 616b  "pyfakefs", "fak
-00017b70: 655f 6669 6c65 7379 7374 656d 2e70 7922  e_filesystem.py"
-00017b80: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-00017b90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00017ba0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-00017bb0: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
-00017bc0: 656c 662e 6669 6c65 7379 7374 656d 2e65  elf.filesystem.e
-00017bd0: 7869 7374 7328 0a20 2020 2020 2020 2020  xists(.         
-00017be0: 2020 2020 2020 206f 732e 7061 7468 2e6a         os.path.j
-00017bf0: 6f69 6e28 7365 6c66 2e72 6f6f 745f 7061  oin(self.root_pa
-00017c00: 7468 2c20 2270 7966 616b 6566 7322 2c20  th, "pyfakefs", 
-00017c10: 225f 5f69 6e69 745f 5f2e 7079 2229 0a20  "__init__.py"). 
-00017c20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00017c30: 2020 2020 2029 0a0a 2020 2020 4063 6f6e       )..    @con
-00017c40: 7465 7874 6c69 622e 636f 6e74 6578 746d  textlib.contextm
-00017c50: 616e 6167 6572 0a20 2020 2064 6566 2063  anager.    def c
-00017c60: 7265 6174 655f 7379 6d6c 696e 6b73 2873  reate_symlinks(s
-00017c70: 656c 662c 2073 796d 6c69 6e6b 7329 3a0a  elf, symlinks):.
-00017c80: 2020 2020 2020 2020 666f 7220 6c69 6e6b          for link
-00017c90: 2069 6e20 7379 6d6c 696e 6b73 3a0a 2020   in symlinks:.  
-00017ca0: 2020 2020 2020 2020 2020 6f73 2e73 796d            os.sym
-00017cb0: 6c69 6e6b 286c 696e 6b5b 305d 2c20 6c69  link(link[0], li
-00017cc0: 6e6b 5b31 5d29 0a0a 2020 2020 2020 2020  nk[1])..        
-00017cd0: 7969 656c 640a 0a20 2020 2020 2020 2066  yield..        f
-00017ce0: 6f72 206c 696e 6b20 696e 2073 796d 6c69  or link in symli
-00017cf0: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
-00017d00: 206f 732e 756e 6c69 6e6b 286c 696e 6b5b   os.unlink(link[
-00017d10: 315d 290a 0a20 2020 2064 6566 2074 6573  1])..    def tes
-00017d20: 745f 6164 645f 6578 6973 7469 6e67 5f72  t_add_existing_r
-00017d30: 6561 6c5f 6469 7265 6374 6f72 795f 7379  eal_directory_sy
-00017d40: 6d6c 696e 6b28 7365 6c66 293a 0a20 2020  mlink(self):.   
-00017d50: 2020 2020 2066 616b 655f 6f70 656e 203d       fake_open =
-00017d60: 2066 616b 655f 6669 6c65 7379 7374 656d   fake_filesystem
-00017d70: 2e46 616b 6546 696c 654f 7065 6e28 7365  .FakeFileOpen(se
-00017d80: 6c66 2e66 696c 6573 7973 7465 6d29 0a20  lf.filesystem). 
-00017d90: 2020 2020 2020 2072 6561 6c5f 6469 7265         real_dire
-00017da0: 6374 6f72 7920 3d20 6f73 2e70 6174 682e  ctory = os.path.
-00017db0: 6a6f 696e 2873 656c 662e 726f 6f74 5f70  join(self.root_p
-00017dc0: 6174 682c 2022 7079 6661 6b65 6673 222c  ath, "pyfakefs",
-00017dd0: 2022 7465 7374 7322 290a 2020 2020 2020   "tests").      
-00017de0: 2020 7379 6d6c 696e 6b73 203d 205b 0a20    symlinks = [. 
-00017df0: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
-00017e00: 2020 2020 2020 2020 2020 2020 2022 2e2e               "..
-00017e10: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00017e20: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
-00017e30: 7265 616c 5f64 6972 6563 746f 7279 2c20  real_directory, 
-00017e40: 2266 6978 7475 7265 7322 2c20 2273 796d  "fixtures", "sym
-00017e50: 6c69 6e6b 5f64 6972 5f72 656c 6174 6976  link_dir_relativ
-00017e60: 6522 292c 0a20 2020 2020 2020 2020 2020  e"),.           
-00017e70: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00017e80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00017e90: 2020 222e 2e2f 616c 6c5f 7465 7374 732e    "../all_tests.
-00017ea0: 7079 222c 0a20 2020 2020 2020 2020 2020  py",.           
-00017eb0: 2020 2020 206f 732e 7061 7468 2e6a 6f69       os.path.joi
-00017ec0: 6e28 7265 616c 5f64 6972 6563 746f 7279  n(real_directory
-00017ed0: 2c20 2266 6978 7475 7265 7322 2c20 2273  , "fixtures", "s
-00017ee0: 796d 6c69 6e6b 5f66 696c 655f 7265 6c61  ymlink_file_rela
-00017ef0: 7469 7665 2229 2c0a 2020 2020 2020 2020  tive"),.        
-00017f00: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00017f10: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00017f20: 2020 2020 2072 6561 6c5f 6469 7265 6374       real_direct
-00017f30: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
-00017f40: 2020 2020 206f 732e 7061 7468 2e6a 6f69       os.path.joi
-00017f50: 6e28 7265 616c 5f64 6972 6563 746f 7279  n(real_directory
-00017f60: 2c20 2266 6978 7475 7265 7322 2c20 2273  , "fixtures", "s
-00017f70: 796d 6c69 6e6b 5f64 6972 5f61 6273 6f6c  ymlink_dir_absol
-00017f80: 7574 6522 292c 0a20 2020 2020 2020 2020  ute"),.         
-00017f90: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00017fa0: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
-00017fb0: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
-00017fc0: 2872 6561 6c5f 6469 7265 6374 6f72 792c  (real_directory,
-00017fd0: 2022 616c 6c5f 7465 7374 732e 7079 2229   "all_tests.py")
-00017fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017ff0: 2020 6f73 2e70 6174 682e 6a6f 696e 2872    os.path.join(r
-00018000: 6561 6c5f 6469 7265 6374 6f72 792c 2022  eal_directory, "
-00018010: 6669 7874 7572 6573 222c 2022 7379 6d6c  fixtures", "syml
-00018020: 696e 6b5f 6669 6c65 5f61 6273 6f6c 7574  ink_file_absolut
-00018030: 6522 292c 0a20 2020 2020 2020 2020 2020  e"),.           
-00018040: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00018050: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00018060: 2020 222f 6574 632f 736f 6d65 7468 696e    "/etc/somethin
-00018070: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
-00018080: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
-00018090: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000180a0: 2020 2020 2020 7265 616c 5f64 6972 6563        real_direc
-000180b0: 746f 7279 2c20 2266 6978 7475 7265 7322  tory, "fixtures"
-000180c0: 2c20 2273 796d 6c69 6e6b 5f66 696c 655f  , "symlink_file_
-000180d0: 6162 736f 6c75 7465 5f6f 7574 7369 6465  absolute_outside
-000180e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000180f0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00018100: 2029 2c0a 2020 2020 2020 2020 5d0a 0a20   ),.        ].. 
-00018110: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-00018120: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
-00018130: 6c65 2822 2f65 7463 2f73 6f6d 6574 6869  le("/etc/somethi
-00018140: 6e67 2229 0a0a 2020 2020 2020 2020 7769  ng")..        wi
-00018150: 7468 2066 616b 655f 6f70 656e 2822 2f65  th fake_open("/e
-00018160: 7463 2f73 6f6d 6574 6869 6e67 222c 2022  tc/something", "
-00018170: 7722 2920 6173 2066 3a0a 2020 2020 2020  w") as f:.      
-00018180: 2020 2020 2020 662e 7772 6974 6528 2267        f.write("g
-00018190: 6f6f 6420 6d6f 726e 696e 6722 290a 0a20  ood morning").. 
-000181a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000181b0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000181c0: 662e 6372 6561 7465 5f73 796d 6c69 6e6b  f.create_symlink
-000181d0: 7328 7379 6d6c 696e 6b73 293a 0a20 2020  s(symlinks):.   
-000181e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000181f0: 662e 6669 6c65 7379 7374 656d 2e61 6464  f.filesystem.add
-00018200: 5f72 6561 6c5f 6469 7265 6374 6f72 7928  _real_directory(
-00018210: 7265 616c 5f64 6972 6563 746f 7279 2c20  real_directory, 
-00018220: 6c61 7a79 5f72 6561 643d 4661 6c73 6529  lazy_read=False)
-00018230: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00018240: 4f53 4572 726f 723a 0a20 2020 2020 2020  OSError:.       
-00018250: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
-00018260: 7769 6e64 6f77 733a 0a20 2020 2020 2020  windows:.       
-00018270: 2020 2020 2020 2020 2072 6169 7365 2075           raise u
-00018280: 6e69 7474 6573 742e 536b 6970 5465 7374  nittest.SkipTest
-00018290: 2822 5379 6d6c 696e 6b73 2075 6e64 6572  ("Symlinks under
-000182a0: 2057 696e 646f 7773 206e 6565 6420 6164   Windows need ad
-000182b0: 6d69 6e20 7072 6976 696c 6567 6573 2229  min privileges")
-000182c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000182d0: 7365 0a0a 2020 2020 2020 2020 666f 7220  se..        for 
-000182e0: 6c69 6e6b 2069 6e20 7379 6d6c 696e 6b73  link in symlinks
-000182f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00018300: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
-00018310: 6c66 2e66 696c 6573 7973 7465 6d2e 6973  lf.filesystem.is
-00018320: 6c69 6e6b 286c 696e 6b5b 315d 2929 0a0a  link(link[1]))..
-00018330: 2020 2020 2020 2020 2320 7265 6c61 7469          # relati
-00018340: 7665 0a20 2020 2020 2020 2073 656c 662e  ve.        self.
-00018350: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
-00018360: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00018370: 6573 7973 7465 6d2e 6578 6973 7473 280a  esystem.exists(.
-00018380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018390: 6f73 2e70 6174 682e 6a6f 696e 280a 2020  os.path.join(.  
-000183a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183b0: 2020 7365 6c66 2e72 6f6f 745f 7061 7468    self.root_path
-000183c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000183d0: 2020 2020 2020 2270 7966 616b 6566 7322        "pyfakefs"
-000183e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000183f0: 2020 2020 2020 2274 6573 7473 222c 0a20        "tests",. 
-00018400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018410: 2020 2022 6669 7874 7572 6573 2f73 796d     "fixtures/sym
-00018420: 6c69 6e6b 5f64 6972 5f72 656c 6174 6976  link_dir_relativ
-00018430: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00018440: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00018450: 2020 290a 2020 2020 2020 2020 290a 2020    ).        ).  
-00018460: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00018470: 7454 7275 6528 0a20 2020 2020 2020 2020  tTrue(.         
-00018480: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
-00018490: 656d 2e65 7869 7374 7328 0a20 2020 2020  em.exists(.     
-000184a0: 2020 2020 2020 2020 2020 206f 732e 7061             os.pa
-000184b0: 7468 2e6a 6f69 6e28 0a20 2020 2020 2020  th.join(.       
-000184c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000184d0: 662e 726f 6f74 5f70 6174 682c 0a20 2020  f.root_path,.   
-000184e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184f0: 2022 7079 6661 6b65 6673 222c 0a20 2020   "pyfakefs",.   
-00018500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018510: 2022 7465 7374 7322 2c0a 2020 2020 2020   "tests",.      
-00018520: 2020 2020 2020 2020 2020 2020 2020 2266                "f
-00018530: 6978 7475 7265 732f 7379 6d6c 696e 6b5f  ixtures/symlink_
-00018540: 6469 725f 7265 6c61 7469 7665 2f61 6c6c  dir_relative/all
-00018550: 5f74 6573 7473 2e70 7922 2c0a 2020 2020  _tests.py",.    
-00018560: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00018570: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00018580: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00018590: 6c66 2e61 7373 6572 7454 7275 6528 0a20  lf.assertTrue(. 
-000185a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000185b0: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-000185c0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-000185d0: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
-000185e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000185f0: 2020 2020 2073 656c 662e 726f 6f74 5f70       self.root_p
-00018600: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00018610: 2020 2020 2020 2020 2022 7079 6661 6b65           "pyfake
-00018620: 6673 222c 0a20 2020 2020 2020 2020 2020  fs",.           
-00018630: 2020 2020 2020 2020 2022 7465 7374 7322           "tests"
-00018640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018650: 2020 2020 2020 2266 6978 7475 7265 732f        "fixtures/
-00018660: 7379 6d6c 696e 6b5f 6669 6c65 5f72 656c  symlink_file_rel
-00018670: 6174 6976 6522 2c0a 2020 2020 2020 2020  ative",.        
-00018680: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00018690: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000186a0: 290a 0a20 2020 2020 2020 2023 2061 6273  )..        # abs
-000186b0: 6f6c 7574 650a 2020 2020 2020 2020 7365  olute.        se
-000186c0: 6c66 2e61 7373 6572 7454 7275 6528 0a20  lf.assertTrue(. 
-000186d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000186e0: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-000186f0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00018700: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
-00018710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018720: 2020 2020 2073 656c 662e 726f 6f74 5f70       self.root_p
-00018730: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00018740: 2020 2020 2020 2020 2022 7079 6661 6b65           "pyfake
-00018750: 6673 222c 0a20 2020 2020 2020 2020 2020  fs",.           
-00018760: 2020 2020 2020 2020 2022 7465 7374 7322           "tests"
-00018770: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018780: 2020 2020 2020 2266 6978 7475 7265 732f        "fixtures/
-00018790: 7379 6d6c 696e 6b5f 6469 725f 6162 736f  symlink_dir_abso
-000187a0: 6c75 7465 222c 0a20 2020 2020 2020 2020  lute",.         
-000187b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000187c0: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
-000187d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000187e0: 7365 7274 5472 7565 280a 2020 2020 2020  sertTrue(.      
-000187f0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00018800: 7973 7465 6d2e 6578 6973 7473 280a 2020  ystem.exists(.  
-00018810: 2020 2020 2020 2020 2020 2020 2020 6f73                os
-00018820: 2e70 6174 682e 6a6f 696e 280a 2020 2020  .path.join(.    
-00018830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018840: 7365 6c66 2e72 6f6f 745f 7061 7468 2c0a  self.root_path,.
-00018850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018860: 2020 2020 2270 7966 616b 6566 7322 2c0a      "pyfakefs",.
-00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018880: 2020 2020 2274 6573 7473 222c 0a20 2020      "tests",.   
-00018890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188a0: 2022 6669 7874 7572 6573 2f73 796d 6c69   "fixtures/symli
-000188b0: 6e6b 5f64 6972 5f61 6273 6f6c 7574 652f  nk_dir_absolute/
-000188c0: 616c 6c5f 7465 7374 732e 7079 222c 0a20  all_tests.py",. 
-000188d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000188e0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000188f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00018900: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-00018910: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00018920: 6c66 2e66 696c 6573 7973 7465 6d2e 6578  lf.filesystem.ex
-00018930: 6973 7473 280a 2020 2020 2020 2020 2020  ists(.          
-00018940: 2020 2020 2020 6f73 2e70 6174 682e 6a6f        os.path.jo
-00018950: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-00018960: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00018970: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
-00018980: 2020 2020 2020 2020 2020 2020 2270 7966              "pyf
-00018990: 616b 6566 7322 2c0a 2020 2020 2020 2020  akefs",.        
-000189a0: 2020 2020 2020 2020 2020 2020 2274 6573              "tes
-000189b0: 7473 222c 0a20 2020 2020 2020 2020 2020  ts",.           
-000189c0: 2020 2020 2020 2020 2022 6669 7874 7572           "fixtur
-000189d0: 6573 2f73 796d 6c69 6e6b 5f66 696c 655f  es/symlink_file_
-000189e0: 6162 736f 6c75 7465 222c 0a20 2020 2020  absolute",.     
-000189f0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00018a00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00018a10: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00018a20: 6f75 7473 6964 650a 2020 2020 2020 2020  outside.        
-00018a30: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00018a40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00018a50: 662e 6669 6c65 7379 7374 656d 2e65 7869  f.filesystem.exi
-00018a60: 7374 7328 0a20 2020 2020 2020 2020 2020  sts(.           
-00018a70: 2020 2020 206f 732e 7061 7468 2e6a 6f69       os.path.joi
-00018a80: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00018a90: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00018aa0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-00018ab0: 2020 2020 2020 2020 2020 2022 7079 6661             "pyfa
-00018ac0: 6b65 6673 222c 0a20 2020 2020 2020 2020  kefs",.         
-00018ad0: 2020 2020 2020 2020 2020 2022 7465 7374             "test
-00018ae0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00018af0: 2020 2020 2020 2020 2266 6978 7475 7265          "fixture
-00018b00: 732f 7379 6d6c 696e 6b5f 6669 6c65 5f61  s/symlink_file_a
-00018b10: 6273 6f6c 7574 655f 6f75 7473 6964 6522  bsolute_outside"
-00018b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018b30: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00018b40: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00018b50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00018b60: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00018b70: 2020 6661 6b65 5f6f 7065 6e28 0a20 2020    fake_open(.   
-00018b80: 2020 2020 2020 2020 2020 2020 206f 732e               os.
-00018b90: 7061 7468 2e6a 6f69 6e28 0a20 2020 2020  path.join(.     
-00018ba0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00018bb0: 656c 662e 726f 6f74 5f70 6174 682c 0a20  elf.root_path,. 
-00018bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bd0: 2020 2022 7079 6661 6b65 6673 222c 0a20     "pyfakefs",. 
-00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bf0: 2020 2022 7465 7374 7322 2c0a 2020 2020     "tests",.    
+00006430: 6174 682c 2065 6e63 6f64 696e 673d 2275  ath, encoding="u
+00006440: 7466 3822 2920 6173 2066 3a0a 2020 2020  tf8") as f:.    
+00006450: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00006460: 6572 7445 7175 616c 2822 222c 2066 2e72  ertEqual("", f.r
+00006470: 6561 6428 2929 0a0a 2020 2020 6465 6620  ead())..    def 
+00006480: 7465 7374 5f63 7265 6174 655f 6669 6c65  test_create_file
+00006490: 5f77 6974 685f 696e 636f 7272 6563 745f  _with_incorrect_
+000064a0: 6d6f 6465 5f74 7970 6528 7365 6c66 293a  mode_type(self):
+000064b0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+000064c0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+000064d0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+000064e0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+000064f0: 6573 7973 7465 6d2e 6372 6561 7465 5f66  esystem.create_f
+00006500: 696c 6528 2266 6f6f 222c 2022 6261 7222  ile("foo", "bar"
+00006510: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00006520: 6372 6561 7465 5f66 696c 655f 616c 7265  create_file_alre
+00006530: 6164 795f 6578 6973 7473 5f65 7272 6f72  ady_exists_error
+00006540: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00006550: 7061 7468 203d 2022 666f 6f2f 6261 722f  path = "foo/bar/
+00006560: 6261 7a22 0a20 2020 2020 2020 2073 656c  baz".        sel
+00006570: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+00006580: 6174 655f 6669 6c65 2870 6174 682c 2063  ate_file(path, c
+00006590: 6f6e 7465 6e74 733d 2264 756d 6d79 5f64  ontents="dummy_d
+000065a0: 6174 6122 290a 2020 2020 2020 2020 7769  ata").        wi
+000065b0: 7468 2073 656c 662e 7261 6973 6573 5f6f  th self.raises_o
+000065c0: 735f 6572 726f 7228 6572 726e 6f2e 4545  s_error(errno.EE
+000065d0: 5849 5354 293a 0a20 2020 2020 2020 2020  XIST):.         
+000065e0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+000065f0: 656d 2e63 7265 6174 655f 6669 6c65 2870  em.create_file(p
+00006600: 6174 6829 0a0a 2020 2020 6465 6620 7465  ath)..    def te
+00006610: 7374 5f63 7265 6174 655f 6c69 6e6b 2873  st_create_link(s
+00006620: 656c 6629 3a0a 2020 2020 2020 2020 7061  elf):.        pa
+00006630: 7468 203d 2022 666f 6f2f 6261 722f 6261  th = "foo/bar/ba
+00006640: 7a22 0a20 2020 2020 2020 2074 6172 6765  z".        targe
+00006650: 745f 7061 7468 203d 2022 666f 6f2f 6261  t_path = "foo/ba
+00006660: 722f 7175 7578 220a 2020 2020 2020 2020  r/quux".        
+00006670: 6e65 775f 6669 6c65 203d 2073 656c 662e  new_file = self.
+00006680: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
+00006690: 655f 7379 6d6c 696e 6b28 7061 7468 2c20  e_symlink(path, 
+000066a0: 2271 7575 7822 290a 2020 2020 2020 2020  "quux").        
+000066b0: 2320 4e65 6974 6865 7220 7468 6520 7061  # Neither the pa
+000066c0: 7468 206e 6f72 2074 6865 2066 696e 616c  th nor the final
+000066d0: 2074 6172 6765 7420 6578 6973 7473 2062   target exists b
+000066e0: 6566 6f72 6520 7765 2061 6374 7561 6c6c  efore we actuall
+000066f0: 790a 2020 2020 2020 2020 2320 7772 6974  y.        # writ
+00006700: 6520 746f 206f 6e65 206f 6620 7468 656d  e to one of them
+00006710: 2c20 6576 656e 2074 686f 7567 6820 7468  , even though th
+00006720: 6520 6c69 6e6b 2061 7070 6561 7273 2069  e link appears i
+00006730: 6e20 7468 6520 6669 6c65 0a20 2020 2020  n the file.     
+00006740: 2020 2023 2073 7973 7465 6d2e 0a20 2020     # system..   
+00006750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00006760: 4661 6c73 6528 7365 6c66 2e66 696c 6573  False(self.files
+00006770: 7973 7465 6d2e 6578 6973 7473 2870 6174  ystem.exists(pat
+00006780: 6829 290a 2020 2020 2020 2020 7365 6c66  h)).        self
+00006790: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
+000067a0: 662e 6669 6c65 7379 7374 656d 2e65 7869  f.filesystem.exi
+000067b0: 7374 7328 7461 7267 6574 5f70 6174 6829  sts(target_path)
+000067c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000067d0: 7373 6572 7454 7275 6528 7374 6174 2e53  ssertTrue(stat.S
+000067e0: 5f49 464c 4e4b 2026 206e 6577 5f66 696c  _IFLNK & new_fil
+000067f0: 652e 7374 5f6d 6f64 6529 0a0a 2020 2020  e.st_mode)..    
+00006800: 2020 2020 2320 6275 7420 6f6e 6365 2077      # but once w
+00006810: 6520 7772 6974 6520 7468 6520 6c69 6e6b  e write the link
+00006820: 6564 2074 6f20 6669 6c65 2c20 7468 6579  ed to file, they
+00006830: 2062 6f74 6820 7769 6c6c 2065 7869 7374   both will exist
+00006840: 2e0a 2020 2020 2020 2020 7365 6c66 2e66  ..        self.f
+00006850: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+00006860: 5f66 696c 6528 7461 7267 6574 5f70 6174  _file(target_pat
+00006870: 6829 0a20 2020 2020 2020 2073 656c 662e  h).        self.
+00006880: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
+00006890: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
+000068a0: 7328 7061 7468 2929 0a20 2020 2020 2020  s(path)).       
+000068b0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+000068c0: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
+000068d0: 2e65 7869 7374 7328 7461 7267 6574 5f70  .exists(target_p
+000068e0: 6174 6829 290a 0a20 2020 2064 6566 2074  ath))..    def t
+000068f0: 6573 745f 7265 736f 6c76 655f 6f62 6a65  est_resolve_obje
+00006900: 6374 2873 656c 6629 3a0a 2020 2020 2020  ct(self):.      
+00006910: 2020 7461 7267 6574 5f70 6174 6820 3d20    target_path = 
+00006920: 2264 6972 2f74 6172 6765 7422 0a20 2020  "dir/target".   
+00006930: 2020 2020 2074 6172 6765 745f 636f 6e74       target_cont
+00006940: 656e 7473 203d 2022 3031 3233 3435 3637  ents = "01234567
+00006950: 3839 4142 4344 4546 220a 2020 2020 2020  89ABCDEF".      
+00006960: 2020 6c69 6e6b 5f6e 616d 6520 3d20 2278    link_name = "x
+00006970: 220a 2020 2020 2020 2020 7365 6c66 2e66  ".        self.f
+00006980: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+00006990: 5f64 6972 2822 6469 7222 290a 2020 2020  _dir("dir").    
+000069a0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+000069b0: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
+000069c0: 2264 6972 2f74 6172 6765 7422 2c20 636f  "dir/target", co
+000069d0: 6e74 656e 7473 3d74 6172 6765 745f 636f  ntents=target_co
+000069e0: 6e74 656e 7473 290a 2020 2020 2020 2020  ntents).        
+000069f0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00006a00: 6372 6561 7465 5f73 796d 6c69 6e6b 286c  create_symlink(l
+00006a10: 696e 6b5f 6e61 6d65 2c20 7461 7267 6574  ink_name, target
+00006a20: 5f70 6174 6829 0a20 2020 2020 2020 206f  _path).        o
+00006a30: 626a 203d 2073 656c 662e 6669 6c65 7379  bj = self.filesy
+00006a40: 7374 656d 2e72 6573 6f6c 7665 286c 696e  stem.resolve(lin
+00006a50: 6b5f 6e61 6d65 290a 2020 2020 2020 2020  k_name).        
+00006a60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00006a70: 2822 7461 7267 6574 222c 206f 626a 2e6e  ("target", obj.n
+00006a80: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
+00006a90: 662e 6173 7365 7274 4571 7561 6c28 7461  f.assertEqual(ta
+00006aa0: 7267 6574 5f63 6f6e 7465 6e74 732c 206f  rget_contents, o
+00006ab0: 626a 2e63 6f6e 7465 6e74 7329 0a0a 2020  bj.contents)..  
+00006ac0: 2020 6465 6620 6368 6563 6b5f 6c72 6573    def check_lres
+00006ad0: 6f6c 7665 5f6f 626a 6563 7428 7365 6c66  olve_object(self
+00006ae0: 293a 0a20 2020 2020 2020 2074 6172 6765  ):.        targe
+00006af0: 745f 7061 7468 203d 2022 6469 722f 7461  t_path = "dir/ta
+00006b00: 7267 6574 220a 2020 2020 2020 2020 7461  rget".        ta
+00006b10: 7267 6574 5f63 6f6e 7465 6e74 7320 3d20  rget_contents = 
+00006b20: 2230 3132 3334 3536 3738 3941 4243 4445  "0123456789ABCDE
+00006b30: 4622 0a20 2020 2020 2020 206c 696e 6b5f  F".        link_
+00006b40: 6e61 6d65 203d 2022 7822 0a20 2020 2020  name = "x".     
+00006b50: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00006b60: 656d 2e63 7265 6174 655f 6469 7228 2264  em.create_dir("d
+00006b70: 6972 2229 0a20 2020 2020 2020 2073 656c  ir").        sel
+00006b80: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+00006b90: 6174 655f 6669 6c65 2822 6469 722f 7461  ate_file("dir/ta
+00006ba0: 7267 6574 222c 2063 6f6e 7465 6e74 733d  rget", contents=
+00006bb0: 7461 7267 6574 5f63 6f6e 7465 6e74 7329  target_contents)
+00006bc0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00006bd0: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+00006be0: 7379 6d6c 696e 6b28 6c69 6e6b 5f6e 616d  symlink(link_nam
+00006bf0: 652c 2074 6172 6765 745f 7061 7468 290a  e, target_path).
+00006c00: 2020 2020 2020 2020 6f62 6a20 3d20 7365          obj = se
+00006c10: 6c66 2e66 696c 6573 7973 7465 6d2e 6c72  lf.filesystem.lr
+00006c20: 6573 6f6c 7665 286c 696e 6b5f 6e61 6d65  esolve(link_name
+00006c30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006c40: 7373 6572 7445 7175 616c 286c 696e 6b5f  ssertEqual(link_
+00006c50: 6e61 6d65 2c20 6f62 6a2e 6e61 6d65 290a  name, obj.name).
+00006c60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00006c70: 6572 7445 7175 616c 2874 6172 6765 745f  ertEqual(target_
+00006c80: 7061 7468 2c20 6f62 6a2e 636f 6e74 656e  path, obj.conten
+00006c90: 7473 290a 0a20 2020 2064 6566 2074 6573  ts)..    def tes
+00006ca0: 745f 6c72 6573 6f6c 7665 5f6f 626a 6563  t_lresolve_objec
+00006cb0: 745f 7769 6e64 6f77 7328 7365 6c66 293a  t_windows(self):
+00006cc0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00006cd0: 6c65 7379 7374 656d 2e69 735f 7769 6e64  lesystem.is_wind
+00006ce0: 6f77 735f 6673 203d 2054 7275 650a 2020  ows_fs = True.  
+00006cf0: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
+00006d00: 5f6c 7265 736f 6c76 655f 6f62 6a65 6374  _lresolve_object
+00006d10: 2829 0a0a 2020 2020 6465 6620 7465 7374  ()..    def test
+00006d20: 5f6c 7265 736f 6c76 655f 6f62 6a65 6374  _lresolve_object
+00006d30: 5f70 6f73 6978 2873 656c 6629 3a0a 2020  _posix(self):.  
+00006d40: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+00006d50: 7973 7465 6d2e 6973 5f77 696e 646f 7773  ystem.is_windows
+00006d60: 5f66 7320 3d20 4661 6c73 650a 2020 2020  _fs = False.    
+00006d70: 2020 2020 7365 6c66 2e63 6865 636b 5f6c      self.check_l
+00006d80: 7265 736f 6c76 655f 6f62 6a65 6374 2829  resolve_object()
+00006d90: 0a0a 2020 2020 6465 6620 6368 6563 6b5f  ..    def check_
+00006da0: 6469 7265 6374 6f72 795f 6163 6365 7373  directory_access
+00006db0: 5f6f 6e5f 6669 6c65 2873 656c 662c 2065  _on_file(self, e
+00006dc0: 7272 6f72 5f73 7562 7479 7065 293a 0a20  rror_subtype):. 
+00006dd0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00006de0: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
+00006df0: 6c65 2822 6e6f 745f 615f 6469 7222 290a  le("not_a_dir").
+00006e00: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00006e10: 662e 7261 6973 6573 5f6f 735f 6572 726f  f.raises_os_erro
+00006e20: 7228 6572 726f 725f 7375 6274 7970 6529  r(error_subtype)
+00006e30: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00006e40: 6c66 2e66 696c 6573 7973 7465 6d2e 7265  lf.filesystem.re
+00006e50: 736f 6c76 6528 226e 6f74 5f61 5f64 6972  solve("not_a_dir
+00006e60: 2f66 6f6f 2229 0a20 2020 2020 2020 2077  /foo").        w
+00006e70: 6974 6820 7365 6c66 2e72 6169 7365 735f  ith self.raises_
+00006e80: 6f73 5f65 7272 6f72 2865 7272 6f72 5f73  os_error(error_s
+00006e90: 7562 7479 7065 293a 0a20 2020 2020 2020  ubtype):.       
+00006ea0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00006eb0: 7374 656d 2e6c 7265 736f 6c76 6528 226e  stem.lresolve("n
+00006ec0: 6f74 5f61 5f64 6972 2f66 6f6f 2f62 6172  ot_a_dir/foo/bar
+00006ed0: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
+00006ee0: 5f64 6972 6563 746f 7279 5f61 6363 6573  _directory_acces
+00006ef0: 735f 6f6e 5f66 696c 655f 7769 6e64 6f77  s_on_file_window
+00006f00: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+00006f10: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00006f20: 2e69 735f 7769 6e64 6f77 735f 6673 203d  .is_windows_fs =
+00006f30: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
+00006f40: 6c66 2e63 6865 636b 5f64 6972 6563 746f  lf.check_directo
+00006f50: 7279 5f61 6363 6573 735f 6f6e 5f66 696c  ry_access_on_fil
+00006f60: 6528 6572 726e 6f2e 454e 4f45 4e54 290a  e(errno.ENOENT).
+00006f70: 0a20 2020 2064 6566 2074 6573 745f 6469  .    def test_di
+00006f80: 7265 6374 6f72 795f 6163 6365 7373 5f6f  rectory_access_o
+00006f90: 6e5f 6669 6c65 5f70 6f73 6978 2873 656c  n_file_posix(sel
+00006fa0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00006fb0: 2e66 696c 6573 7973 7465 6d2e 6973 5f77  .filesystem.is_w
+00006fc0: 696e 646f 7773 5f66 7320 3d20 4661 6c73  indows_fs = Fals
+00006fd0: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
+00006fe0: 6865 636b 5f64 6972 6563 746f 7279 5f61  heck_directory_a
+00006ff0: 6363 6573 735f 6f6e 5f66 696c 6528 6572  ccess_on_file(er
+00007000: 726e 6f2e 454e 4f54 4449 5229 0a0a 2020  rno.ENOTDIR)..  
+00007010: 2020 6465 6620 7465 7374 5f70 6963 6b6c    def test_pickl
+00007020: 655f 6673 2873 656c 6629 3a0a 2020 2020  e_fs(self):.    
+00007030: 2020 2020 2222 2252 6567 7265 7373 696f      """Regressio
+00007040: 6e20 7465 7374 2066 6f72 2023 3434 3522  n test for #445"
+00007050: 2222 0a20 2020 2020 2020 2069 6d70 6f72  "".        impor
+00007060: 7420 7069 636b 6c65 0a0a 2020 2020 2020  t pickle..      
+00007070: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00007080: 6d2e 6f70 656e 5f66 696c 6573 203d 205b  m.open_files = [
+00007090: 5d0a 2020 2020 2020 2020 7020 3d20 7069  ].        p = pi
+000070a0: 636b 6c65 2e64 756d 7073 2873 656c 662e  ckle.dumps(self.
+000070b0: 6669 6c65 7379 7374 656d 290a 2020 2020  filesystem).    
+000070c0: 2020 2020 6673 203d 2070 6963 6b6c 652e      fs = pickle.
+000070d0: 6c6f 6164 7328 7029 0a20 2020 2020 2020  loads(p).       
+000070e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000070f0: 6c28 7374 7228 6673 2e72 6f6f 7429 2c20  l(str(fs.root), 
+00007100: 7374 7228 7365 6c66 2e66 696c 6573 7973  str(self.filesys
+00007110: 7465 6d2e 726f 6f74 2929 0a20 2020 2020  tem.root)).     
+00007120: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00007130: 7561 6c28 6673 2e6d 6f75 6e74 5f70 6f69  ual(fs.mount_poi
+00007140: 6e74 732c 2073 656c 662e 6669 6c65 7379  nts, self.filesy
+00007150: 7374 656d 2e6d 6f75 6e74 5f70 6f69 6e74  stem.mount_point
+00007160: 7329 0a0a 0a63 6c61 7373 2043 6173 6549  s)...class CaseI
+00007170: 6e73 656e 7369 7469 7665 4661 6b65 4669  nsensitiveFakeFi
+00007180: 6c65 7379 7374 656d 5465 7374 2854 6573  lesystemTest(Tes
+00007190: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
+000071a0: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
+000071b0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+000071c0: 7374 656d 203d 2066 616b 655f 6669 6c65  stem = fake_file
+000071d0: 7379 7374 656d 2e46 616b 6546 696c 6573  system.FakeFiles
+000071e0: 7973 7465 6d28 7061 7468 5f73 6570 6172  ystem(path_separ
+000071f0: 6174 6f72 3d22 2f22 290a 2020 2020 2020  ator="/").      
+00007200: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00007210: 6d2e 6973 5f63 6173 655f 7365 6e73 6974  m.is_case_sensit
+00007220: 6976 6520 3d20 4661 6c73 650a 2020 2020  ive = False.    
+00007230: 2020 2020 7365 6c66 2e6f 7320 3d20 6661      self.os = fa
+00007240: 6b65 5f6f 732e 4661 6b65 4f73 4d6f 6475  ke_os.FakeOsModu
+00007250: 6c65 2873 656c 662e 6669 6c65 7379 7374  le(self.filesyst
+00007260: 656d 290a 2020 2020 2020 2020 7365 6c66  em).        self
+00007270: 2e70 6174 6820 3d20 7365 6c66 2e6f 732e  .path = self.os.
+00007280: 7061 7468 0a0a 2020 2020 6465 6620 7465  path..    def te
+00007290: 7374 5f67 6574 5f6f 626a 6563 7428 7365  st_get_object(se
+000072a0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000072b0: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+000072c0: 6174 655f 6469 7228 222f 666f 6f2f 6261  ate_dir("/foo/ba
+000072d0: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
+000072e0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
+000072f0: 7465 5f66 696c 6528 222f 666f 6f2f 6261  te_file("/foo/ba
+00007300: 722f 6261 7a22 290a 2020 2020 2020 2020  r/baz").        
+00007310: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+00007320: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00007330: 6765 745f 6f62 6a65 6374 2822 2f46 6f6f  get_object("/Foo
+00007340: 2f42 6172 2f42 617a 2229 290a 0a20 2020  /Bar/Baz"))..   
+00007350: 2064 6566 2074 6573 745f 7265 6d6f 7665   def test_remove
+00007360: 5f6f 626a 6563 7428 7365 6c66 293a 0a20  _object(self):. 
+00007370: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00007380: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
+00007390: 7228 222f 666f 6f2f 6261 7222 290a 2020  r("/foo/bar").  
+000073a0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+000073b0: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
+000073c0: 6528 222f 666f 6f2f 6261 722f 6261 7a22  e("/foo/bar/baz"
+000073d0: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+000073e0: 696c 6573 7973 7465 6d2e 7265 6d6f 7665  ilesystem.remove
+000073f0: 5f6f 626a 6563 7428 222f 466f 6f2f 4261  _object("/Foo/Ba
+00007400: 722f 4261 7a22 290a 2020 2020 2020 2020  r/Baz").        
+00007410: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
+00007420: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
+00007430: 2e65 7869 7374 7328 222f 666f 6f2f 6261  .exists("/foo/ba
+00007440: 722f 6261 7a22 2929 0a0a 2020 2020 6465  r/baz"))..    de
+00007450: 6620 7465 7374 5f65 7869 7374 7328 7365  f test_exists(se
+00007460: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00007470: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+00007480: 6174 655f 6469 7228 222f 466f 6f2f 4261  ate_dir("/Foo/Ba
+00007490: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
+000074a0: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
+000074b0: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
+000074c0: 7473 2822 2f46 6f6f 2f42 6172 2229 290a  ts("/Foo/Bar")).
+000074d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000074e0: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
+000074f0: 6573 7973 7465 6d2e 6578 6973 7473 2822  esystem.exists("
+00007500: 2f66 6f6f 2f62 6172 2229 290a 0a20 2020  /foo/bar"))..   
+00007510: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00007520: 7374 656d 2e63 7265 6174 655f 6669 6c65  stem.create_file
+00007530: 2822 2f66 6f6f 2f42 6172 2f62 617a 2229  ("/foo/Bar/baz")
+00007540: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007550: 7365 7274 5472 7565 2873 656c 662e 6669  sertTrue(self.fi
+00007560: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+00007570: 222f 466f 6f2f 6261 722f 4241 5a22 2929  "/Foo/bar/BAZ"))
+00007580: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007590: 7365 7274 5472 7565 2873 656c 662e 6669  sertTrue(self.fi
+000075a0: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+000075b0: 222f 666f 6f2f 6261 722f 6261 7a22 2929  "/foo/bar/baz"))
+000075c0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
+000075d0: 7265 6174 655f 6469 7265 6374 6f72 795f  reate_directory_
+000075e0: 7769 7468 5f64 6966 6665 7265 6e74 5f63  with_different_c
+000075f0: 6173 655f 726f 6f74 2873 656c 6629 3a0a  ase_root(self):.
+00007600: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00007610: 6573 7973 7465 6d2e 6372 6561 7465 5f64  esystem.create_d
+00007620: 6972 2822 2f46 6f6f 2f42 6172 2229 0a20  ir("/Foo/Bar"). 
+00007630: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00007640: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
+00007650: 7228 222f 666f 6f2f 6261 722f 6261 7a22  r("/foo/bar/baz"
+00007660: 290a 2020 2020 2020 2020 6469 7231 203d  ).        dir1 =
+00007670: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00007680: 2e67 6574 5f6f 626a 6563 7428 222f 466f  .get_object("/Fo
+00007690: 6f2f 4261 7222 290a 2020 2020 2020 2020  o/Bar").        
+000076a0: 6469 7232 203d 2073 656c 662e 6669 6c65  dir2 = self.file
+000076b0: 7379 7374 656d 2e67 6574 5f6f 626a 6563  system.get_objec
+000076c0: 7428 222f 666f 6f2f 6261 7222 290a 2020  t("/foo/bar").  
+000076d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000076e0: 7445 7175 616c 2864 6972 312c 2064 6972  tEqual(dir1, dir
+000076f0: 3229 0a0a 2020 2020 6465 6620 7465 7374  2)..    def test
+00007700: 5f63 7265 6174 655f 6669 6c65 5f77 6974  _create_file_wit
+00007710: 685f 6469 6666 6572 656e 745f 6361 7365  h_different_case
+00007720: 5f64 6972 2873 656c 6629 3a0a 2020 2020  _dir(self):.    
+00007730: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00007740: 7465 6d2e 6372 6561 7465 5f64 6972 2822  tem.create_dir("
+00007750: 2f46 6f6f 2f42 6172 2229 0a20 2020 2020  /Foo/Bar").     
+00007760: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00007770: 656d 2e63 7265 6174 655f 6669 6c65 2822  em.create_file("
+00007780: 2f66 6f6f 2f62 6172 2f62 617a 2229 0a20  /foo/bar/baz"). 
+00007790: 2020 2020 2020 2064 6972 3120 3d20 7365         dir1 = se
+000077a0: 6c66 2e66 696c 6573 7973 7465 6d2e 6765  lf.filesystem.ge
+000077b0: 745f 6f62 6a65 6374 2822 2f46 6f6f 2f42  t_object("/Foo/B
+000077c0: 6172 2229 0a20 2020 2020 2020 2064 6972  ar").        dir
+000077d0: 3220 3d20 7365 6c66 2e66 696c 6573 7973  2 = self.filesys
+000077e0: 7465 6d2e 6765 745f 6f62 6a65 6374 2822  tem.get_object("
+000077f0: 2f66 6f6f 2f62 6172 2229 0a20 2020 2020  /foo/bar").     
+00007800: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00007810: 7561 6c28 6469 7231 2c20 6469 7232 290a  ual(dir1, dir2).
+00007820: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+00007830: 736f 6c76 655f 7061 7468 2873 656c 6629  solve_path(self)
+00007840: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
+00007850: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+00007860: 5f64 6972 2822 2f66 6f6f 2f62 617a 2229  _dir("/foo/baz")
+00007870: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00007880: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+00007890: 7379 6d6c 696e 6b28 222f 466f 6f2f 4261  symlink("/Foo/Ba
+000078a0: 7222 2c20 222e 2f62 617a 2f62 6970 2229  r", "./baz/bip")
+000078b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000078c0: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
+000078d0: 2020 2020 2020 2066 227b 7365 6c66 2e66         f"{self.f
+000078e0: 696c 6573 7973 7465 6d2e 726f 6f74 5f64  ilesystem.root_d
+000078f0: 6972 5f6e 616d 657d 666f 6f2f 6261 7a2f  ir_name}foo/baz/
+00007900: 6269 7022 2c0a 2020 2020 2020 2020 2020  bip",.          
+00007910: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00007920: 6d2e 7265 736f 6c76 655f 7061 7468 2822  m.resolve_path("
+00007930: 2f66 6f6f 2f62 6172 2229 2c0a 2020 2020  /foo/bar"),.    
+00007940: 2020 2020 290a 0a20 2020 2064 6566 2074      )..    def t
+00007950: 6573 745f 6973 6469 725f 6973 6669 6c65  est_isdir_isfile
+00007960: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00007970: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00007980: 6372 6561 7465 5f66 696c 6528 2266 6f6f  create_file("foo
+00007990: 2f62 6172 2229 0a20 2020 2020 2020 2073  /bar").        s
+000079a0: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
+000079b0: 656c 662e 7061 7468 2e69 7364 6972 2822  elf.path.isdir("
+000079c0: 466f 6f22 2929 0a20 2020 2020 2020 2073  Foo")).        s
+000079d0: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+000079e0: 7365 6c66 2e70 6174 682e 6973 6669 6c65  self.path.isfile
+000079f0: 2822 466f 6f22 2929 0a20 2020 2020 2020  ("Foo")).       
+00007a00: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+00007a10: 2873 656c 662e 7061 7468 2e69 7366 696c  (self.path.isfil
+00007a20: 6528 2246 6f6f 2f42 6172 2229 290a 2020  e("Foo/Bar")).  
+00007a30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007a40: 7446 616c 7365 2873 656c 662e 7061 7468  tFalse(self.path
+00007a50: 2e69 7364 6972 2822 466f 6f2f 4261 7222  .isdir("Foo/Bar"
+00007a60: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+00007a70: 5f67 6574 7369 7a65 2873 656c 6629 3a0a  _getsize(self):.
+00007a80: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+00007a90: 6820 3d20 2266 6f6f 2f62 6172 2f62 617a  h = "foo/bar/baz
+00007aa0: 220a 2020 2020 2020 2020 7365 6c66 2e66  ".        self.f
+00007ab0: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+00007ac0: 5f66 696c 6528 6669 6c65 5f70 6174 682c  _file(file_path,
+00007ad0: 2063 6f6e 7465 6e74 733d 2231 3233 3435   contents="12345
+00007ae0: 3637 2229 0a20 2020 2020 2020 2073 656c  67").        sel
+00007af0: 662e 6173 7365 7274 4571 7561 6c28 372c  f.assertEqual(7,
+00007b00: 2073 656c 662e 7061 7468 2e67 6574 7369   self.path.getsi
+00007b10: 7a65 2822 464f 4f2f 4241 522f 4241 5a22  ze("FOO/BAR/BAZ"
+00007b20: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+00007b30: 5f67 6574 7369 7a65 5f77 6974 685f 6c6f  _getsize_with_lo
+00007b40: 6f70 696e 675f 7379 6d6c 696e 6b28 7365  oping_symlink(se
+00007b50: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00007b60: 662e 6669 6c65 7379 7374 656d 2e69 735f  f.filesystem.is_
+00007b70: 7769 6e64 6f77 735f 6673 203d 2046 616c  windows_fs = Fal
+00007b80: 7365 0a20 2020 2020 2020 2064 6972 5f70  se.        dir_p
+00007b90: 6174 6820 3d20 222f 666f 6f2f 6261 7222  ath = "/foo/bar"
+00007ba0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00007bb0: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+00007bc0: 6469 7228 6469 725f 7061 7468 290a 2020  dir(dir_path).  
+00007bd0: 2020 2020 2020 6c69 6e6b 5f70 6174 6820        link_path 
+00007be0: 3d20 6469 725f 7061 7468 202b 2022 2f6c  = dir_path + "/l
+00007bf0: 696e 6b22 0a20 2020 2020 2020 206c 696e  ink".        lin
+00007c00: 6b5f 7461 7267 6574 203d 206c 696e 6b5f  k_target = link_
+00007c10: 7061 7468 202b 2022 2f6c 696e 6b22 0a20  path + "/link". 
+00007c20: 2020 2020 2020 2073 656c 662e 6f73 2e73         self.os.s
+00007c30: 796d 6c69 6e6b 286c 696e 6b5f 7461 7267  ymlink(link_targ
+00007c40: 6574 2c20 6c69 6e6b 5f70 6174 6829 0a20  et, link_path). 
+00007c50: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00007c60: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
+00007c70: 2865 7272 6e6f 2e45 4c4f 4f50 293a 0a20  (errno.ELOOP):. 
+00007c80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00007c90: 6f73 2e70 6174 682e 6765 7473 697a 6528  os.path.getsize(
+00007ca0: 6c69 6e6b 5f70 6174 6829 0a0a 2020 2020  link_path)..    
+00007cb0: 6465 6620 7465 7374 5f67 6574 5f6d 7469  def test_get_mti
+00007cc0: 6d65 2873 656c 6629 3a0a 2020 2020 2020  me(self):.      
+00007cd0: 2020 7465 7374 5f66 696c 6520 3d20 7365    test_file = se
+00007ce0: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
+00007cf0: 6561 7465 5f66 696c 6528 2266 6f6f 2f62  eate_file("foo/b
+00007d00: 6172 312e 7478 7422 290a 2020 2020 2020  ar1.txt").      
+00007d10: 2020 7465 7374 5f66 696c 652e 7374 5f6d    test_file.st_m
+00007d20: 7469 6d65 203d 2032 340a 2020 2020 2020  time = 24.      
+00007d30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00007d40: 616c 2832 342c 2073 656c 662e 7061 7468  al(24, self.path
+00007d50: 2e67 6574 6d74 696d 6528 2246 6f6f 2f42  .getmtime("Foo/B
+00007d60: 6172 312e 5458 5422 2929 0a0a 2020 2020  ar1.TXT"))..    
+00007d70: 6465 6620 7465 7374 5f67 6574 5f6f 626a  def test_get_obj
+00007d80: 6563 745f 7769 7468 5f66 696c 655f 7369  ect_with_file_si
+00007d90: 7a65 2873 656c 6629 3a0a 2020 2020 2020  ze(self):.      
+00007da0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00007db0: 6d2e 6372 6561 7465 5f66 696c 6528 222f  m.create_file("/
+00007dc0: 466f 6f2f 4261 7222 2c20 7374 5f73 697a  Foo/Bar", st_siz
+00007dd0: 653d 3130 290a 2020 2020 2020 2020 7365  e=10).        se
+00007de0: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+00007df0: 6c66 2e66 696c 6573 7973 7465 6d2e 6765  lf.filesystem.ge
+00007e00: 745f 6f62 6a65 6374 2822 2f66 6f6f 2f62  t_object("/foo/b
+00007e10: 6172 2229 290a 0a0a 636c 6173 7320 4361  ar"))...class Ca
+00007e20: 7365 5365 6e73 6974 6976 6546 616b 6546  seSensitiveFakeF
+00007e30: 696c 6573 7973 7465 6d54 6573 7428 5465  ilesystemTest(Te
+00007e40: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+00007e50: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+00007e60: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+00007e70: 7973 7465 6d20 3d20 6661 6b65 5f66 696c  ystem = fake_fil
+00007e80: 6573 7973 7465 6d2e 4661 6b65 4669 6c65  esystem.FakeFile
+00007e90: 7379 7374 656d 2870 6174 685f 7365 7061  system(path_sepa
+00007ea0: 7261 746f 723d 222f 2229 0a20 2020 2020  rator="/").     
+00007eb0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00007ec0: 656d 2e69 735f 6361 7365 5f73 656e 7369  em.is_case_sensi
+00007ed0: 7469 7665 203d 2054 7275 650a 2020 2020  tive = True.    
+00007ee0: 2020 2020 7365 6c66 2e6f 7320 3d20 6661      self.os = fa
+00007ef0: 6b65 5f6f 732e 4661 6b65 4f73 4d6f 6475  ke_os.FakeOsModu
+00007f00: 6c65 2873 656c 662e 6669 6c65 7379 7374  le(self.filesyst
+00007f10: 656d 290a 2020 2020 2020 2020 7365 6c66  em).        self
+00007f20: 2e70 6174 6820 3d20 7365 6c66 2e6f 732e  .path = self.os.
+00007f30: 7061 7468 0a0a 2020 2020 6465 6620 7465  path..    def te
+00007f40: 7374 5f67 6574 5f6f 626a 6563 7428 7365  st_get_object(se
+00007f50: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00007f60: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+00007f70: 6174 655f 6469 7228 222f 666f 6f2f 6261  ate_dir("/foo/ba
+00007f80: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
+00007f90: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
+00007fa0: 7465 5f66 696c 6528 222f 666f 6f2f 6261  te_file("/foo/ba
+00007fb0: 722f 6261 7a22 290a 2020 2020 2020 2020  r/baz").        
+00007fc0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00007fd0: 5261 6973 6573 284f 5345 7272 6f72 293a  Raises(OSError):
+00007fe0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00007ff0: 662e 6669 6c65 7379 7374 656d 2e67 6574  f.filesystem.get
+00008000: 5f6f 626a 6563 7428 222f 466f 6f2f 4261  _object("/Foo/Ba
+00008010: 722f 4261 7a22 290a 0a20 2020 2064 6566  r/Baz")..    def
+00008020: 2074 6573 745f 7265 6d6f 7665 5f6f 626a   test_remove_obj
+00008030: 6563 7428 7365 6c66 293a 0a20 2020 2020  ect(self):.     
+00008040: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00008050: 656d 2e63 7265 6174 655f 6469 7228 222f  em.create_dir("/
+00008060: 666f 6f2f 6261 7222 290a 2020 2020 2020  foo/bar").      
+00008070: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00008080: 6d2e 6372 6561 7465 5f66 696c 6528 222f  m.create_file("/
+00008090: 666f 6f2f 6261 722f 6261 7a22 290a 2020  foo/bar/baz").  
+000080a0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000080b0: 6173 7365 7274 5261 6973 6573 284f 5345  assertRaises(OSE
+000080c0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000080d0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+000080e0: 656d 2e72 656d 6f76 655f 6f62 6a65 6374  em.remove_object
+000080f0: 2822 2f46 6f6f 2f42 6172 2f42 617a 2229  ("/Foo/Bar/Baz")
+00008100: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008110: 7365 7274 5472 7565 2873 656c 662e 6669  sertTrue(self.fi
+00008120: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+00008130: 222f 666f 6f2f 6261 722f 6261 7a22 2929  "/foo/bar/baz"))
+00008140: 0a0a 2020 2020 6465 6620 7465 7374 5f65  ..    def test_e
+00008150: 7869 7374 7328 7365 6c66 293a 0a20 2020  xists(self):.   
+00008160: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00008170: 7374 656d 2e63 7265 6174 655f 6469 7228  stem.create_dir(
+00008180: 222f 466f 6f2f 4261 7222 290a 2020 2020  "/Foo/Bar").    
+00008190: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+000081a0: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
+000081b0: 7465 6d2e 6578 6973 7473 2822 2f46 6f6f  tem.exists("/Foo
+000081c0: 2f42 6172 2229 290a 2020 2020 2020 2020  /Bar")).        
+000081d0: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
+000081e0: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
+000081f0: 2e65 7869 7374 7328 222f 666f 6f2f 6261  .exists("/foo/ba
+00008200: 7222 2929 0a0a 2020 2020 2020 2020 7365  r"))..        se
+00008210: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
+00008220: 6561 7465 5f66 696c 6528 222f 666f 6f2f  eate_file("/foo/
+00008230: 4261 722f 6261 7a22 290a 2020 2020 2020  Bar/baz").      
+00008240: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00008250: 7365 2873 656c 662e 6669 6c65 7379 7374  se(self.filesyst
+00008260: 656d 2e65 7869 7374 7328 222f 466f 6f2f  em.exists("/Foo/
+00008270: 6261 722f 4241 5a22 2929 0a20 2020 2020  bar/BAZ")).     
+00008280: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
+00008290: 6c73 6528 7365 6c66 2e66 696c 6573 7973  lse(self.filesys
+000082a0: 7465 6d2e 6578 6973 7473 2822 2f66 6f6f  tem.exists("/foo
+000082b0: 2f62 6172 2f62 617a 2229 290a 0a20 2020  /bar/baz"))..   
+000082c0: 2064 6566 2074 6573 745f 6372 6561 7465   def test_create
+000082d0: 5f64 6972 6563 746f 7279 5f77 6974 685f  _directory_with_
+000082e0: 6469 6666 6572 656e 745f 6361 7365 5f72  different_case_r
+000082f0: 6f6f 7428 7365 6c66 293a 0a20 2020 2020  oot(self):.     
+00008300: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00008310: 656d 2e63 7265 6174 655f 6469 7228 222f  em.create_dir("/
+00008320: 466f 6f2f 4261 7222 290a 2020 2020 2020  Foo/Bar").      
+00008330: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00008340: 6d2e 6372 6561 7465 5f64 6972 2822 2f66  m.create_dir("/f
+00008350: 6f6f 2f62 6172 2f62 617a 2229 0a20 2020  oo/bar/baz").   
+00008360: 2020 2020 2064 6972 3120 3d20 7365 6c66       dir1 = self
+00008370: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
+00008380: 6f62 6a65 6374 2822 2f46 6f6f 2f42 6172  object("/Foo/Bar
+00008390: 2229 0a20 2020 2020 2020 2064 6972 3220  ").        dir2 
+000083a0: 3d20 7365 6c66 2e66 696c 6573 7973 7465  = self.filesyste
+000083b0: 6d2e 6765 745f 6f62 6a65 6374 2822 2f66  m.get_object("/f
+000083c0: 6f6f 2f62 6172 2229 0a20 2020 2020 2020  oo/bar").       
+000083d0: 2073 656c 662e 6173 7365 7274 4e6f 7445   self.assertNotE
+000083e0: 7175 616c 2864 6972 312c 2064 6972 3229  qual(dir1, dir2)
+000083f0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
+00008400: 7265 6174 655f 6669 6c65 5f77 6974 685f  reate_file_with_
+00008410: 6469 6666 6572 656e 745f 6361 7365 5f64  different_case_d
+00008420: 6972 2873 656c 6629 3a0a 2020 2020 2020  ir(self):.      
+00008430: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00008440: 6d2e 6372 6561 7465 5f64 6972 2822 2f46  m.create_dir("/F
+00008450: 6f6f 2f42 6172 2229 0a20 2020 2020 2020  oo/Bar").       
+00008460: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00008470: 2e63 7265 6174 655f 6669 6c65 2822 2f66  .create_file("/f
+00008480: 6f6f 2f62 6172 2f62 617a 2229 0a20 2020  oo/bar/baz").   
+00008490: 2020 2020 2064 6972 3120 3d20 7365 6c66       dir1 = self
+000084a0: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
+000084b0: 6f62 6a65 6374 2822 2f46 6f6f 2f42 6172  object("/Foo/Bar
+000084c0: 2229 0a20 2020 2020 2020 2064 6972 3220  ").        dir2 
+000084d0: 3d20 7365 6c66 2e66 696c 6573 7973 7465  = self.filesyste
+000084e0: 6d2e 6765 745f 6f62 6a65 6374 2822 2f66  m.get_object("/f
+000084f0: 6f6f 2f62 6172 2229 0a20 2020 2020 2020  oo/bar").       
+00008500: 2073 656c 662e 6173 7365 7274 4e6f 7445   self.assertNotE
+00008510: 7175 616c 2864 6972 312c 2064 6972 3229  qual(dir1, dir2)
+00008520: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
+00008530: 7364 6972 5f69 7366 696c 6528 7365 6c66  sdir_isfile(self
+00008540: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00008550: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
+00008560: 655f 6669 6c65 2822 666f 6f2f 6261 7222  e_file("foo/bar"
+00008570: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00008580: 7373 6572 7446 616c 7365 2873 656c 662e  ssertFalse(self.
+00008590: 7061 7468 2e69 7364 6972 2822 466f 6f22  path.isdir("Foo"
+000085a0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+000085b0: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
+000085c0: 2e70 6174 682e 6973 6669 6c65 2822 466f  .path.isfile("Fo
+000085d0: 6f22 2929 0a20 2020 2020 2020 2073 656c  o")).        sel
+000085e0: 662e 6173 7365 7274 4661 6c73 6528 7365  f.assertFalse(se
+000085f0: 6c66 2e70 6174 682e 6973 6669 6c65 2822  lf.path.isfile("
+00008600: 466f 6f2f 4261 7222 2929 0a20 2020 2020  Foo/Bar")).     
+00008610: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
+00008620: 6c73 6528 7365 6c66 2e70 6174 682e 6973  lse(self.path.is
+00008630: 6469 7228 2246 6f6f 2f42 6172 2229 290a  dir("Foo/Bar")).
+00008640: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+00008650: 7473 697a 6528 7365 6c66 293a 0a20 2020  tsize(self):.   
+00008660: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+00008670: 2022 666f 6f2f 6261 722f 6261 7a22 0a20   "foo/bar/baz". 
+00008680: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00008690: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
+000086a0: 6c65 2866 696c 655f 7061 7468 2c20 636f  le(file_path, co
+000086b0: 6e74 656e 7473 3d22 3132 3334 3536 3722  ntents="1234567"
+000086c0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000086d0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000086e0: 286f 732e 6572 726f 7229 3a0a 2020 2020  (os.error):.    
+000086f0: 2020 2020 2020 2020 7365 6c66 2e70 6174          self.pat
+00008700: 682e 6765 7473 697a 6528 2246 4f4f 2f42  h.getsize("FOO/B
+00008710: 4152 2f42 415a 2229 0a0a 2020 2020 6465  AR/BAZ")..    de
+00008720: 6620 7465 7374 5f67 6574 5f6d 7469 6d65  f test_get_mtime
+00008730: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00008740: 7465 7374 5f66 696c 6520 3d20 7365 6c66  test_file = self
+00008750: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
+00008760: 7465 5f66 696c 6528 2266 6f6f 2f62 6172  te_file("foo/bar
+00008770: 312e 7478 7422 290a 2020 2020 2020 2020  1.txt").        
+00008780: 7465 7374 5f66 696c 652e 7374 5f6d 7469  test_file.st_mti
+00008790: 6d65 203d 2032 340a 2020 2020 2020 2020  me = 24.        
+000087a0: 7769 7468 2073 656c 662e 7261 6973 6573  with self.raises
+000087b0: 5f6f 735f 6572 726f 7228 6572 726e 6f2e  _os_error(errno.
+000087c0: 454e 4f45 4e54 293a 0a20 2020 2020 2020  ENOENT):.       
+000087d0: 2020 2020 2073 656c 662e 7061 7468 2e67       self.path.g
+000087e0: 6574 6d74 696d 6528 2246 6f6f 2f42 6172  etmtime("Foo/Bar
+000087f0: 312e 5458 5422 290a 0a0a 636c 6173 7320  1.TXT")...class 
+00008800: 4f73 5061 7468 496e 6a65 6374 696f 6e52  OsPathInjectionR
+00008810: 6567 7265 7373 696f 6e54 6573 7428 5465  egressionTest(Te
+00008820: 7374 4361 7365 293a 0a20 2020 2022 2222  stCase):.    """
+00008830: 5465 7374 2066 616b 696e 6720 6f73 2e70  Test faking os.p
+00008840: 6174 6820 6265 666f 7265 2063 616c 6c69  ath before calli
+00008850: 6e67 206f 732e 7761 6c6b 2e0a 0a20 2020  ng os.walk...   
+00008860: 2046 6f75 6e64 2077 6865 6e20 696e 7665   Found when inve
+00008870: 7374 6967 6174 696e 6720 6120 7072 6f62  stigating a prob
+00008880: 6c65 6d20 7769 7468 0a20 2020 2067 7773  lem with.    gws
+00008890: 2f74 6f6f 6c73 2f6c 6162 7261 742f 7261  /tools/labrat/ra
+000088a0: 745f 7574 696c 735f 756e 6974 7465 7374  t_utils_unittest
+000088b0: 2c20 7768 6963 6820 7761 7320 6661 6b69  , which was faki
+000088c0: 6e67 206f 7574 206f 732e 7061 7468 0a20  ng out os.path. 
+000088d0: 2020 2062 6566 6f72 6520 6361 6c6c 696e     before callin
+000088e0: 6720 6f73 2e77 616c 6b2e 0a20 2020 2022  g os.walk..    "
+000088f0: 2222 0a0a 2020 2020 6465 6620 7365 7455  ""..    def setU
+00008900: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
+00008910: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00008920: 203d 2066 616b 655f 6669 6c65 7379 7374   = fake_filesyst
+00008930: 656d 2e46 616b 6546 696c 6573 7973 7465  em.FakeFilesyste
+00008940: 6d28 7061 7468 5f73 6570 6172 6174 6f72  m(path_separator
+00008950: 3d22 2f22 290a 2020 2020 2020 2020 7365  ="/").        se
+00008960: 6c66 2e6f 735f 7061 7468 203d 206f 732e  lf.os_path = os.
+00008970: 7061 7468 0a20 2020 2020 2020 2023 2054  path.        # T
+00008980: 6865 2062 7567 2077 6173 2074 6861 7420  he bug was that 
+00008990: 7768 656e 206f 732e 7061 7468 2067 6574  when os.path get
+000089a0: 7320 6661 6b65 642c 2074 6865 2046 616b  s faked, the Fak
+000089b0: 6550 6174 684d 6f64 756c 6520 646f 6573  ePathModule does
+000089c0: 6e27 740a 2020 2020 2020 2020 2320 6765  n't.        # ge
+000089d0: 7420 6361 6c6c 6564 2069 6e20 7365 6c66  t called in self
+000089e0: 2e6f 732e 7761 6c6b 2829 2e20 4661 6b65  .os.walk(). Fake
+000089f0: 5061 7468 4d6f 6475 6c65 206e 6f77 2069  PathModule now i
+00008a00: 6e73 6973 7473 2074 6861 7420 6974 2069  nsists that it i
+00008a10: 730a 2020 2020 2020 2020 2320 6372 6561  s.        # crea
+00008a20: 7465 6420 6173 2070 6172 7420 6f66 2046  ted as part of F
+00008a30: 616b 654f 734d 6f64 756c 652e 0a20 2020  akeOsModule..   
+00008a40: 2020 2020 2073 656c 662e 6f73 203d 2066       self.os = f
+00008a50: 616b 655f 6f73 2e46 616b 654f 734d 6f64  ake_os.FakeOsMod
+00008a60: 756c 6528 7365 6c66 2e66 696c 6573 7973  ule(self.filesys
+00008a70: 7465 6d29 0a0a 2020 2020 6465 6620 7465  tem)..    def te
+00008a80: 6172 446f 776e 2873 656c 6629 3a0a 2020  arDown(self):.  
+00008a90: 2020 2020 2020 6f73 2e70 6174 6820 3d20        os.path = 
+00008aa0: 7365 6c66 2e6f 735f 7061 7468 0a0a 2020  self.os_path..  
+00008ab0: 2020 6465 6620 7465 7374 5f63 7265 6174    def test_creat
+00008ac0: 655f 746f 705f 6c65 7665 6c5f 6469 7265  e_top_level_dire
+00008ad0: 6374 6f72 7928 7365 6c66 293a 0a20 2020  ctory(self):.   
+00008ae0: 2020 2020 2074 6f70 5f6c 6576 656c 5f64       top_level_d
+00008af0: 6972 203d 2022 2f78 220a 2020 2020 2020  ir = "/x".      
+00008b00: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+00008b10: 7365 2873 656c 662e 6669 6c65 7379 7374  se(self.filesyst
+00008b20: 656d 2e65 7869 7374 7328 746f 705f 6c65  em.exists(top_le
+00008b30: 7665 6c5f 6469 7229 290a 2020 2020 2020  vel_dir)).      
+00008b40: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00008b50: 6d2e 6372 6561 7465 5f64 6972 2874 6f70  m.create_dir(top
+00008b60: 5f6c 6576 656c 5f64 6972 290a 2020 2020  _level_dir).    
+00008b70: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00008b80: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
+00008b90: 7465 6d2e 6578 6973 7473 2822 2f22 2929  tem.exists("/"))
+00008ba0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008bb0: 7365 7274 5472 7565 2873 656c 662e 6669  sertTrue(self.fi
+00008bc0: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+00008bd0: 746f 705f 6c65 7665 6c5f 6469 7229 290a  top_level_dir)).
+00008be0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00008bf0: 6573 7973 7465 6d2e 6372 6561 7465 5f64  esystem.create_d
+00008c00: 6972 2822 2573 2f70 6f22 2025 2074 6f70  ir("%s/po" % top
+00008c10: 5f6c 6576 656c 5f64 6972 290a 2020 2020  _level_dir).    
+00008c20: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00008c30: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
+00008c40: 2225 732f 706f 2f63 6f6e 7472 6f6c 2220  "%s/po/control" 
+00008c50: 2520 746f 705f 6c65 7665 6c5f 6469 7229  % top_level_dir)
+00008c60: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00008c70: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+00008c80: 6669 6c65 2822 2573 2f70 6f2f 6578 7065  file("%s/po/expe
+00008c90: 7269 6d65 6e74 2220 2520 746f 705f 6c65  riment" % top_le
+00008ca0: 7665 6c5f 6469 7229 0a20 2020 2020 2020  vel_dir).       
+00008cb0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00008cc0: 2e63 7265 6174 655f 6469 7228 2225 732f  .create_dir("%s/
+00008cd0: 6776 2220 2520 746f 705f 6c65 7665 6c5f  gv" % top_level_
+00008ce0: 6469 7229 0a20 2020 2020 2020 2073 656c  dir).        sel
+00008cf0: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+00008d00: 6174 655f 6669 6c65 2822 2573 2f67 762f  ate_file("%s/gv/
+00008d10: 636f 6e74 726f 6c22 2025 2074 6f70 5f6c  control" % top_l
+00008d20: 6576 656c 5f64 6972 290a 0a20 2020 2020  evel_dir)..     
+00008d30: 2020 2065 7870 6563 7465 6420 3d20 5b0a     expected = [.
+00008d40: 2020 2020 2020 2020 2020 2020 2822 2f22              ("/"
+00008d50: 2c20 5b22 7822 5d2c 205b 5d29 2c0a 2020  , ["x"], []),.  
+00008d60: 2020 2020 2020 2020 2020 2822 2f78 222c            ("/x",
+00008d70: 205b 2267 7622 2c20 2270 6f22 5d2c 205b   ["gv", "po"], [
+00008d80: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+00008d90: 2822 2f78 2f67 7622 2c20 5b5d 2c20 5b22  ("/x/gv", [], ["
+00008da0: 636f 6e74 726f 6c22 5d29 2c0a 2020 2020  control"]),.    
+00008db0: 2020 2020 2020 2020 2822 2f78 2f70 6f22          ("/x/po"
+00008dc0: 2c20 5b5d 2c20 5b22 636f 6e74 726f 6c22  , [], ["control"
+00008dd0: 2c20 2265 7870 6572 696d 656e 7422 5d29  , "experiment"])
+00008de0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+00008df0: 2020 2020 2320 6173 2074 6865 2072 6573      # as the res
+00008e00: 756c 7420 6973 2075 6e73 6f72 7465 642c  ult is unsorted,
+00008e10: 2077 6520 6861 7665 2074 6f20 6368 6563   we have to chec
+00008e20: 6b20 6167 6169 6e73 7420 736f 7274 6564  k against sorted
+00008e30: 2072 6573 756c 7473 0a20 2020 2020 2020   results.       
+00008e40: 2072 6573 756c 7420 3d20 736f 7274 6564   result = sorted
+00008e50: 285b 7374 6570 2066 6f72 2073 7465 7020  ([step for step 
+00008e60: 696e 2073 656c 662e 6f73 2e77 616c 6b28  in self.os.walk(
+00008e70: 222f 2229 5d2c 206b 6579 3d6c 616d 6264  "/")], key=lambd
+00008e80: 6120 763a 2076 5b30 5d29 0a20 2020 2020  a v: v[0]).     
+00008e90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00008ea0: 7561 6c28 6c65 6e28 6578 7065 6374 6564  ual(len(expected
+00008eb0: 292c 206c 656e 2872 6573 756c 7429 290a  ), len(result)).
+00008ec0: 2020 2020 2020 2020 666f 7220 656e 7472          for entr
+00008ed0: 792c 2065 7870 6563 7465 645f 656e 7472  y, expected_entr
+00008ee0: 7920 696e 207a 6970 2872 6573 756c 742c  y in zip(result,
+00008ef0: 2065 7870 6563 7465 6429 3a0a 2020 2020   expected):.    
+00008f00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00008f10: 6572 7445 7175 616c 2865 7870 6563 7465  ertEqual(expecte
+00008f20: 645f 656e 7472 795b 305d 2c20 656e 7472  d_entry[0], entr
+00008f30: 795b 305d 290a 2020 2020 2020 2020 2020  y[0]).          
+00008f40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008f50: 616c 2865 7870 6563 7465 645f 656e 7472  al(expected_entr
+00008f60: 795b 315d 2c20 736f 7274 6564 2865 6e74  y[1], sorted(ent
+00008f70: 7279 5b31 5d29 290a 2020 2020 2020 2020  ry[1])).        
+00008f80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00008f90: 7175 616c 2865 7870 6563 7465 645f 656e  qual(expected_en
+00008fa0: 7472 795b 325d 2c20 736f 7274 6564 2865  try[2], sorted(e
+00008fb0: 6e74 7279 5b32 5d29 290a 0a0a 636c 6173  ntry[2]))...clas
+00008fc0: 7320 4661 6b65 5061 7468 4d6f 6475 6c65  s FakePathModule
+00008fd0: 5465 7374 2854 6573 7443 6173 6529 3a0a  Test(TestCase):.
+00008fe0: 2020 2020 6465 6620 7365 7455 7028 7365      def setUp(se
+00008ff0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00009000: 662e 6669 6c65 7379 7374 656d 203d 2066  f.filesystem = f
+00009010: 616b 655f 6669 6c65 7379 7374 656d 2e46  ake_filesystem.F
+00009020: 616b 6546 696c 6573 7973 7465 6d28 7061  akeFilesystem(pa
+00009030: 7468 5f73 6570 6172 6174 6f72 3d22 2122  th_separator="!"
+00009040: 290a 2020 2020 2020 2020 7365 6c66 2e6f  ).        self.o
+00009050: 7320 3d20 6661 6b65 5f6f 732e 4661 6b65  s = fake_os.Fake
+00009060: 4f73 4d6f 6475 6c65 2873 656c 662e 6669  OsModule(self.fi
+00009070: 6c65 7379 7374 656d 290a 2020 2020 2020  lesystem).      
+00009080: 2020 7365 6c66 2e70 6174 6820 3d20 7365    self.path = se
+00009090: 6c66 2e6f 732e 7061 7468 0a0a 2020 2020  lf.os.path..    
+000090a0: 6465 6620 6368 6563 6b5f 6162 7370 6174  def check_abspat
+000090b0: 6828 7365 6c66 2c20 6973 5f77 696e 646f  h(self, is_windo
+000090c0: 7773 293a 0a20 2020 2020 2020 2023 2074  ws):.        # t
+000090d0: 6865 2069 6d70 6c65 6d65 6e74 6174 696f  he implementatio
+000090e0: 6e20 6469 6666 6572 7320 696e 2057 696e  n differs in Win
+000090f0: 646f 7773 2061 6e64 2050 6f73 6978 2c20  dows and Posix, 
+00009100: 736f 2074 6573 7420 626f 7468 0a20 2020  so test both.   
+00009110: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00009120: 7374 656d 2e69 735f 7769 6e64 6f77 735f  stem.is_windows_
+00009130: 6673 203d 2069 735f 7769 6e64 6f77 730a  fs = is_windows.
+00009140: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+00009150: 203d 2022 666f 6f22 0a20 2020 2020 2020   = "foo".       
+00009160: 2061 6273 7061 7468 203d 2073 656c 662e   abspath = self.
+00009170: 6669 6c65 7379 7374 656d 2e72 6f6f 745f  filesystem.root_
+00009180: 6469 725f 6e61 6d65 202b 2066 696c 656e  dir_name + filen
+00009190: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
+000091a0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
+000091b0: 7465 5f66 696c 6528 6162 7370 6174 6829  te_file(abspath)
+000091c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000091d0: 7365 7274 4571 7561 6c28 6162 7370 6174  sertEqual(abspat
+000091e0: 682c 2073 656c 662e 7061 7468 2e61 6273  h, self.path.abs
+000091f0: 7061 7468 2861 6273 7061 7468 2929 0a20  path(abspath)). 
+00009200: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00009210: 7274 4571 7561 6c28 6162 7370 6174 682c  rtEqual(abspath,
+00009220: 2073 656c 662e 7061 7468 2e61 6273 7061   self.path.abspa
+00009230: 7468 2866 696c 656e 616d 6529 290a 2020  th(filename)).  
+00009240: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00009250: 7445 7175 616c 2861 6273 7061 7468 2c20  tEqual(abspath, 
+00009260: 7365 6c66 2e70 6174 682e 6162 7370 6174  self.path.abspat
+00009270: 6828 222e 2e21 2573 2220 2520 6669 6c65  h("..!%s" % file
+00009280: 6e61 6d65 2929 0a0a 2020 2020 6465 6620  name))..    def 
+00009290: 7465 7374 5f61 6273 7061 7468 5f77 696e  test_abspath_win
+000092a0: 646f 7773 2873 656c 6629 3a0a 2020 2020  dows(self):.    
+000092b0: 2020 2020 7365 6c66 2e63 6865 636b 5f61      self.check_a
+000092c0: 6273 7061 7468 2869 735f 7769 6e64 6f77  bspath(is_window
+000092d0: 733d 5472 7565 290a 0a20 2020 2064 6566  s=True)..    def
+000092e0: 2074 6573 745f 6162 7370 6174 685f 706f   test_abspath_po
+000092f0: 7369 7828 7365 6c66 293a 0a20 2020 2020  six(self):.     
+00009300: 2020 2022 2222 6162 7370 6174 6820 7368     """abspath sh
+00009310: 6f75 6c64 2072 6574 7572 6e20 6120 636f  ould return a co
+00009320: 6e73 6973 7465 6e74 2072 6570 7265 7365  nsistent represe
+00009330: 6e74 6174 696f 6e20 6f66 2061 2066 696c  ntation of a fil
+00009340: 652e 2222 220a 2020 2020 2020 2020 7365  e.""".        se
+00009350: 6c66 2e63 6865 636b 5f61 6273 7061 7468  lf.check_abspath
+00009360: 2869 735f 7769 6e64 6f77 733d 4661 6c73  (is_windows=Fals
+00009370: 6529 0a0a 2020 2020 6465 6620 6368 6563  e)..    def chec
+00009380: 6b5f 6162 7370 6174 685f 6279 7465 7328  k_abspath_bytes(
+00009390: 7365 6c66 2c20 6973 5f77 696e 646f 7773  self, is_windows
+000093a0: 293a 0a20 2020 2020 2020 2022 2222 6162  ):.        """ab
+000093b0: 7370 6174 6820 7368 6f75 6c64 2072 6574  spath should ret
+000093c0: 7572 6e20 6120 636f 6e73 6973 7465 6e74  urn a consistent
+000093d0: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
+000093e0: 6f66 2061 2066 696c 652e 2222 220a 2020  of a file.""".  
+000093f0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+00009400: 7973 7465 6d2e 6973 5f77 696e 646f 7773  ystem.is_windows
+00009410: 5f66 7320 3d20 6973 5f77 696e 646f 7773  _fs = is_windows
+00009420: 0a20 2020 2020 2020 2066 696c 656e 616d  .        filenam
+00009430: 6520 3d20 6222 666f 6f22 0a20 2020 2020  e = b"foo".     
+00009440: 2020 2061 6273 7061 7468 203d 2073 656c     abspath = sel
+00009450: 662e 6669 6c65 7379 7374 656d 2e72 6f6f  f.filesystem.roo
+00009460: 745f 6469 725f 6e61 6d65 2e65 6e63 6f64  t_dir_name.encod
+00009470: 6528 2920 2b20 6669 6c65 6e61 6d65 0a20  e() + filename. 
+00009480: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00009490: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
+000094a0: 6c65 2861 6273 7061 7468 290a 2020 2020  le(abspath).    
+000094b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000094c0: 7175 616c 2861 6273 7061 7468 2c20 7365  qual(abspath, se
+000094d0: 6c66 2e70 6174 682e 6162 7370 6174 6828  lf.path.abspath(
+000094e0: 6162 7370 6174 6829 290a 2020 2020 2020  abspath)).      
+000094f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009500: 616c 2861 6273 7061 7468 2c20 7365 6c66  al(abspath, self
+00009510: 2e70 6174 682e 6162 7370 6174 6828 6669  .path.abspath(fi
+00009520: 6c65 6e61 6d65 2929 0a20 2020 2020 2020  lename)).       
+00009530: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00009540: 6c28 6162 7370 6174 682c 2073 656c 662e  l(abspath, self.
+00009550: 7061 7468 2e61 6273 7061 7468 2862 222e  path.abspath(b".
+00009560: 2e21 2220 2b20 6669 6c65 6e61 6d65 2929  .!" + filename))
+00009570: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+00009580: 6273 7061 7468 5f62 7974 6573 5f77 696e  bspath_bytes_win
+00009590: 646f 7773 2873 656c 6629 3a0a 2020 2020  dows(self):.    
+000095a0: 2020 2020 7365 6c66 2e63 6865 636b 5f61      self.check_a
+000095b0: 6273 7061 7468 5f62 7974 6573 2869 735f  bspath_bytes(is_
+000095c0: 7769 6e64 6f77 733d 5472 7565 290a 0a20  windows=True).. 
+000095d0: 2020 2064 6566 2074 6573 745f 6162 7370     def test_absp
+000095e0: 6174 685f 6279 7465 735f 706f 7369 7828  ath_bytes_posix(
+000095f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00009600: 656c 662e 6368 6563 6b5f 6162 7370 6174  elf.check_abspat
+00009610: 685f 6279 7465 7328 6973 5f77 696e 646f  h_bytes(is_windo
+00009620: 7773 3d46 616c 7365 290a 0a20 2020 2064  ws=False)..    d
+00009630: 6566 2074 6573 745f 6162 7370 6174 685f  ef test_abspath_
+00009640: 6465 616c 735f 7769 7468 5f72 656c 6174  deals_with_relat
+00009650: 6976 655f 6e6f 6e5f 726f 6f74 5f70 6174  ive_non_root_pat
+00009660: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+00009670: 2022 2222 6162 7370 6174 6820 7368 6f75   """abspath shou
+00009680: 6c64 2063 6f72 7265 6374 6c79 2068 616e  ld correctly han
+00009690: 646c 6520 7265 6c61 7469 7665 2070 6174  dle relative pat
+000096a0: 6873 2066 726f 6d20 610a 2020 2020 2020  hs from a.      
+000096b0: 2020 6e6f 6e2d 2120 6469 7265 6374 6f72    non-! director
+000096c0: 792e 0a0a 2020 2020 2020 2020 5468 6973  y...        This
+000096d0: 2074 6573 7420 6973 2064 6973 7469 6e63   test is distinc
+000096e0: 7420 6672 6f6d 2074 6865 2062 6173 6963  t from the basic
+000096f0: 2066 756e 6374 696f 6e61 6c69 7479 2074   functionality t
+00009700: 6573 7420 6265 6361 7573 650a 2020 2020  est because.    
+00009710: 2020 2020 6661 6b65 5f66 696c 6573 7973      fake_filesys
+00009720: 7465 6d20 6861 7320 6869 7374 6f72 6963  tem has historic
+00009730: 616c 6c79 2062 6565 6e20 6261 7365 6420  ally been based 
+00009740: 696e 2021 2e0a 2020 2020 2020 2020 2222  in !..        ""
+00009750: 220a 2020 2020 2020 2020 6669 6c65 6e61  ".        filena
+00009760: 6d65 203d 2022 2166 6f6f 2162 6172 2162  me = "!foo!bar!b
+00009770: 617a 220a 2020 2020 2020 2020 6669 6c65  az".        file
+00009780: 5f63 6f6d 706f 6e65 6e74 7320 3d20 6669  _components = fi
+00009790: 6c65 6e61 6d65 2e73 706c 6974 2873 656c  lename.split(sel
+000097a0: 662e 7061 7468 2e73 6570 290a 2020 2020  f.path.sep).    
+000097b0: 2020 2020 726f 6f74 5f6e 616d 6520 3d20      root_name = 
+000097c0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+000097d0: 726f 6f74 5f64 6972 5f6e 616d 650a 2020  root_dir_name.  
+000097e0: 2020 2020 2020 6261 7365 6469 7220 3d20        basedir = 
+000097f0: 6622 7b72 6f6f 745f 6e61 6d65 7d7b 6669  f"{root_name}{fi
+00009800: 6c65 5f63 6f6d 706f 6e65 6e74 735b 305d  le_components[0]
+00009810: 7d22 0a20 2020 2020 2020 2073 656c 662e  }".        self.
+00009820: 6669 6c65 7379 7374 656d 2e63 7265 6174  filesystem.creat
+00009830: 655f 6669 6c65 2866 696c 656e 616d 6529  e_file(filename)
+00009840: 0a20 2020 2020 2020 2073 656c 662e 6f73  .        self.os
+00009850: 2e63 6864 6972 2862 6173 6564 6972 290a  .chdir(basedir).
+00009860: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00009870: 6572 7445 7175 616c 2862 6173 6564 6972  ertEqual(basedir
+00009880: 2c20 7365 6c66 2e70 6174 682e 6162 7370  , self.path.absp
+00009890: 6174 6828 7365 6c66 2e70 6174 682e 6375  ath(self.path.cu
+000098a0: 7264 6972 2929 0a20 2020 2020 2020 2073  rdir)).        s
+000098b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000098c0: 726f 6f74 5f6e 616d 652c 2073 656c 662e  root_name, self.
+000098d0: 7061 7468 2e61 6273 7061 7468 2822 2e2e  path.abspath("..
+000098e0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+000098f0: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
+00009900: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
+00009910: 6174 682e 6a6f 696e 2862 6173 6564 6972  ath.join(basedir
+00009920: 2c20 6669 6c65 5f63 6f6d 706f 6e65 6e74  , file_component
+00009930: 735b 315d 292c 0a20 2020 2020 2020 2020  s[1]),.         
+00009940: 2020 2073 656c 662e 7061 7468 2e61 6273     self.path.abs
+00009950: 7061 7468 2866 696c 655f 636f 6d70 6f6e  path(file_compon
+00009960: 656e 7473 5b31 5d29 2c0a 2020 2020 2020  ents[1]),.      
+00009970: 2020 290a 0a20 2020 2064 6566 2074 6573    )..    def tes
+00009980: 745f 6162 735f 7061 7468 5f77 6974 685f  t_abs_path_with_
+00009990: 6472 6976 655f 636f 6d70 6f6e 656e 7428  drive_component(
+000099a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+000099b0: 656c 662e 6669 6c65 7379 7374 656d 2e69  elf.filesystem.i
+000099c0: 735f 7769 6e64 6f77 735f 6673 203d 2054  s_windows_fs = T
+000099d0: 7275 650a 2020 2020 2020 2020 7365 6c66  rue.        self
+000099e0: 2e66 696c 6573 7973 7465 6d2e 6377 6420  .filesystem.cwd 
+000099f0: 3d20 2243 3a21 666f 6f22 0a20 2020 2020  = "C:!foo".     
+00009a00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00009a10: 7561 6c28 2243 3a21 666f 6f21 6261 7222  ual("C:!foo!bar"
+00009a20: 2c20 7365 6c66 2e70 6174 682e 6162 7370  , self.path.absp
+00009a30: 6174 6828 2262 6172 2229 290a 2020 2020  ath("bar")).    
+00009a40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00009a50: 7175 616c 2822 433a 2166 6f6f 2162 6172  qual("C:!foo!bar
+00009a60: 222c 2073 656c 662e 7061 7468 2e61 6273  ", self.path.abs
+00009a70: 7061 7468 2822 433a 6261 7222 2929 0a20  path("C:bar")). 
+00009a80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00009a90: 7274 4571 7561 6c28 2243 3a21 666f 6f21  rtEqual("C:!foo!
+00009aa0: 6261 7222 2c20 7365 6c66 2e70 6174 682e  bar", self.path.
+00009ab0: 6162 7370 6174 6828 2221 666f 6f21 6261  abspath("!foo!ba
+00009ac0: 7222 2929 0a0a 2020 2020 6465 6620 7465  r"))..    def te
+00009ad0: 7374 5f69 7361 6273 5f77 6974 685f 6472  st_isabs_with_dr
+00009ae0: 6976 655f 636f 6d70 6f6e 656e 7428 7365  ive_component(se
+00009af0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00009b00: 662e 6669 6c65 7379 7374 656d 2e69 735f  f.filesystem.is_
+00009b10: 7769 6e64 6f77 735f 6673 203d 2046 616c  windows_fs = Fal
+00009b20: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
+00009b30: 6173 7365 7274 4661 6c73 6528 7365 6c66  assertFalse(self
+00009b40: 2e70 6174 682e 6973 6162 7328 2243 3a21  .path.isabs("C:!
+00009b50: 666f 6f22 2929 0a20 2020 2020 2020 2073  foo")).        s
+00009b60: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+00009b70: 7365 6c66 2e70 6174 682e 6973 6162 7328  self.path.isabs(
+00009b80: 6222 433a 2166 6f6f 2229 290a 2020 2020  b"C:!foo")).    
+00009b90: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00009ba0: 7275 6528 7365 6c66 2e70 6174 682e 6973  rue(self.path.is
+00009bb0: 6162 7328 2221 2229 290a 2020 2020 2020  abs("!")).      
+00009bc0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+00009bd0: 6528 7365 6c66 2e70 6174 682e 6973 6162  e(self.path.isab
+00009be0: 7328 6222 2122 2929 0a20 2020 2020 2020  s(b"!")).       
+00009bf0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00009c00: 2e69 735f 7769 6e64 6f77 735f 6673 203d  .is_windows_fs =
+00009c10: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
+00009c20: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+00009c30: 6c66 2e70 6174 682e 6973 6162 7328 2243  lf.path.isabs("C
+00009c40: 3a21 666f 6f22 2929 0a20 2020 2020 2020  :!foo")).       
+00009c50: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+00009c60: 2873 656c 662e 7061 7468 2e69 7361 6273  (self.path.isabs
+00009c70: 2862 2243 3a21 666f 6f22 2929 0a20 2020  (b"C:!foo")).   
+00009c80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00009c90: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
+00009ca0: 7361 6273 2822 2122 2929 0a20 2020 2020  sabs("!")).     
+00009cb0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00009cc0: 7565 2873 656c 662e 7061 7468 2e69 7361  ue(self.path.isa
+00009cd0: 6273 2862 2221 2229 290a 0a20 2020 2064  bs(b"!"))..    d
+00009ce0: 6566 2074 6573 745f 7265 6c70 6174 6828  ef test_relpath(
+00009cf0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+00009d00: 6174 685f 666f 6f20 3d20 2221 7061 7468  ath_foo = "!path
+00009d10: 2174 6f21 666f 6f22 0a20 2020 2020 2020  !to!foo".       
+00009d20: 2070 6174 685f 6261 7220 3d20 2221 7061   path_bar = "!pa
+00009d30: 7468 2174 6f21 6261 7222 0a20 2020 2020  th!to!bar".     
+00009d40: 2020 2070 6174 685f 6f74 6865 7220 3d20     path_other = 
+00009d50: 2221 736f 6d65 2177 6865 7265 2165 6c73  "!some!where!els
+00009d60: 6522 0a20 2020 2020 2020 2077 6974 6820  e".        with 
+00009d70: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00009d80: 7328 5661 6c75 6545 7272 6f72 293a 0a20  s(ValueError):. 
+00009d90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00009da0: 7061 7468 2e72 656c 7061 7468 284e 6f6e  path.relpath(Non
+00009db0: 6529 0a20 2020 2020 2020 2077 6974 6820  e).        with 
+00009dc0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00009dd0: 7328 5661 6c75 6545 7272 6f72 293a 0a20  s(ValueError):. 
+00009de0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00009df0: 7061 7468 2e72 656c 7061 7468 2822 2229  path.relpath("")
+00009e00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00009e10: 7365 7274 4571 7561 6c28 2270 6174 6821  sertEqual("path!
+00009e20: 746f 2166 6f6f 222c 2073 656c 662e 7061  to!foo", self.pa
+00009e30: 7468 2e72 656c 7061 7468 2870 6174 685f  th.relpath(path_
+00009e40: 666f 6f29 290a 2020 2020 2020 2020 7365  foo)).        se
+00009e50: 6c66 2e61 7373 6572 7445 7175 616c 2822  lf.assertEqual("
+00009e60: 2e2e 2166 6f6f 222c 2073 656c 662e 7061  ..!foo", self.pa
+00009e70: 7468 2e72 656c 7061 7468 2870 6174 685f  th.relpath(path_
+00009e80: 666f 6f2c 2070 6174 685f 6261 7229 290a  foo, path_bar)).
+00009e90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00009ea0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00009eb0: 2020 2020 2020 222e 2e21 2e2e 212e 2e25        "..!..!..%
+00009ec0: 7322 2025 2070 6174 685f 6f74 6865 722c  s" % path_other,
+00009ed0: 2073 656c 662e 7061 7468 2e72 656c 7061   self.path.relpa
+00009ee0: 7468 2870 6174 685f 6f74 6865 722c 2070  th(path_other, p
+00009ef0: 6174 685f 6261 7229 0a20 2020 2020 2020  ath_bar).       
+00009f00: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00009f10: 6173 7365 7274 4571 7561 6c28 222e 222c  assertEqual(".",
+00009f20: 2073 656c 662e 7061 7468 2e72 656c 7061   self.path.relpa
+00009f30: 7468 2870 6174 685f 6261 722c 2070 6174  th(path_bar, pat
+00009f40: 685f 6261 7229 290a 0a20 2020 2064 6566  h_bar))..    def
+00009f50: 2074 6573 745f 7265 616c 7061 7468 5f76   test_realpath_v
+00009f60: 735f 6162 7370 6174 6828 7365 6c66 293a  s_abspath(self):
+00009f70: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00009f80: 6c65 7379 7374 656d 2e69 735f 7769 6e64  lesystem.is_wind
+00009f90: 6f77 735f 6673 203d 2046 616c 7365 0a20  ows_fs = False. 
+00009fa0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00009fb0: 7379 7374 656d 2e63 7265 6174 655f 6669  system.create_fi
+00009fc0: 6c65 2822 2167 656f 7267 6521 7761 7368  le("!george!wash
+00009fd0: 696e 6774 6f6e 2162 7269 6467 6522 290a  ington!bridge").
+00009fe0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00009ff0: 6573 7973 7465 6d2e 6372 6561 7465 5f73  esystem.create_s
+0000a000: 796d 6c69 6e6b 2822 2166 6972 7374 2170  ymlink("!first!p
+0000a010: 7265 7369 6465 6e74 222c 2022 2167 656f  resident", "!geo
+0000a020: 7267 6521 7761 7368 696e 6774 6f6e 2229  rge!washington")
+0000a030: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000a040: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
+0000a050: 2020 2020 2020 2022 2166 6972 7374 2170         "!first!p
+0000a060: 7265 7369 6465 6e74 2162 7269 6467 6522  resident!bridge"
+0000a070: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000a080: 6c66 2e6f 732e 7061 7468 2e61 6273 7061  lf.os.path.abspa
+0000a090: 7468 2822 2166 6972 7374 2170 7265 7369  th("!first!presi
+0000a0a0: 6465 6e74 2162 7269 6467 6522 292c 0a20  dent!bridge"),. 
+0000a0b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a0c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000a0d0: 6c28 0a20 2020 2020 2020 2020 2020 2022  l(.            "
+0000a0e0: 2167 656f 7267 6521 7761 7368 696e 6774  !george!washingt
+0000a0f0: 6f6e 2162 7269 6467 6522 2c0a 2020 2020  on!bridge",.    
+0000a100: 2020 2020 2020 2020 7365 6c66 2e6f 732e          self.os.
+0000a110: 7061 7468 2e72 6561 6c70 6174 6828 2221  path.realpath("!
+0000a120: 6669 7273 7421 7072 6573 6964 656e 7421  first!president!
+0000a130: 6272 6964 6765 2229 2c0a 2020 2020 2020  bridge"),.      
+0000a140: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000a150: 2e6f 732e 6368 6469 7228 2221 6669 7273  .os.chdir("!firs
+0000a160: 7421 7072 6573 6964 656e 7422 290a 2020  t!president").  
+0000a170: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000a180: 7445 7175 616c 2822 2167 656f 7267 6521  tEqual("!george!
+0000a190: 7761 7368 696e 6774 6f6e 2162 7269 6467  washington!bridg
+0000a1a0: 6522 2c20 7365 6c66 2e6f 732e 7061 7468  e", self.os.path
+0000a1b0: 2e72 6561 6c70 6174 6828 2262 7269 6467  .realpath("bridg
+0000a1c0: 6522 2929 0a0a 2020 2020 4075 6e69 7474  e"))..    @unitt
+0000a1d0: 6573 742e 736b 6970 4966 2873 7973 2e76  est.skipIf(sys.v
+0000a1e0: 6572 7369 6f6e 5f69 6e66 6f20 3c20 2833  ersion_info < (3
+0000a1f0: 2c20 3130 292c 2022 2773 7472 6963 7427  , 10), "'strict'
+0000a200: 206e 6577 2069 6e20 5079 7468 6f6e 2033   new in Python 3
+0000a210: 2e31 3022 290a 2020 2020 6465 6620 7465  .10").    def te
+0000a220: 7374 5f72 6561 6c70 6174 685f 7374 7269  st_realpath_stri
+0000a230: 6374 2873 656c 6629 3a0a 2020 2020 2020  ct(self):.      
+0000a240: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000a250: 6d2e 6372 6561 7465 5f66 696c 6528 2221  m.create_file("!
+0000a260: 666f 6f21 6261 7222 290a 2020 2020 2020  foo!bar").      
+0000a270: 2020 726f 6f74 5f64 6972 203d 2073 656c    root_dir = sel
+0000a280: 662e 6669 6c65 7379 7374 656d 2e72 6f6f  f.filesystem.roo
+0000a290: 745f 6469 725f 6e61 6d65 0a20 2020 2020  t_dir_name.     
+0000a2a0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0000a2b0: 656d 2e63 7764 203d 2066 227b 726f 6f74  em.cwd = f"{root
+0000a2c0: 5f64 6972 7d66 6f6f 220a 2020 2020 2020  _dir}foo".      
+0000a2d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000a2e0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
+0000a2f0: 6622 7b72 6f6f 745f 6469 727d 666f 6f21  f"{root_dir}foo!
+0000a300: 6261 7a22 2c20 7365 6c66 2e6f 732e 7061  baz", self.os.pa
+0000a310: 7468 2e72 6561 6c70 6174 6828 2262 617a  th.realpath("baz
+0000a320: 222c 2073 7472 6963 743d 4661 6c73 6529  ", strict=False)
+0000a330: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000a340: 2020 2077 6974 6820 7365 6c66 2e72 6169     with self.rai
+0000a350: 7365 735f 6f73 5f65 7272 6f72 2865 7272  ses_os_error(err
+0000a360: 6e6f 2e45 4e4f 454e 5429 3a0a 2020 2020  no.ENOENT):.    
+0000a370: 2020 2020 2020 2020 7365 6c66 2e6f 732e          self.os.
+0000a380: 7061 7468 2e72 6561 6c70 6174 6828 2262  path.realpath("b
+0000a390: 617a 222c 2073 7472 6963 743d 5472 7565  az", strict=True
+0000a3a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000a3b0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
+0000a3c0: 2020 2020 2020 2020 6622 7b72 6f6f 745f          f"{root_
+0000a3d0: 6469 727d 666f 6f21 6261 7222 2c20 7365  dir}foo!bar", se
+0000a3e0: 6c66 2e6f 732e 7061 7468 2e72 6561 6c70  lf.os.path.realp
+0000a3f0: 6174 6828 2262 6172 222c 2073 7472 6963  ath("bar", stric
+0000a400: 743d 5472 7565 290a 2020 2020 2020 2020  t=True).        
+0000a410: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000a420: 7361 6d65 6669 6c65 2873 656c 6629 3a0a  samefile(self):.
+0000a430: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+0000a440: 6831 203d 2022 2166 6f6f 2162 6172 2162  h1 = "!foo!bar!b
+0000a450: 617a 220a 2020 2020 2020 2020 6669 6c65  az".        file
+0000a460: 5f70 6174 6832 203d 2022 2166 6f6f 2162  _path2 = "!foo!b
+0000a470: 6172 2162 6f6f 220a 2020 2020 2020 2020  ar!boo".        
+0000a480: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000a490: 6372 6561 7465 5f66 696c 6528 6669 6c65  create_file(file
+0000a4a0: 5f70 6174 6831 290a 2020 2020 2020 2020  _path1).        
+0000a4b0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000a4c0: 6372 6561 7465 5f66 696c 6528 6669 6c65  create_file(file
+0000a4d0: 5f70 6174 6832 290a 2020 2020 2020 2020  _path2).        
+0000a4e0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000a4f0: 7365 6c66 2e70 6174 682e 7361 6d65 6669  self.path.samefi
+0000a500: 6c65 2866 696c 655f 7061 7468 312c 2066  le(file_path1, f
+0000a510: 696c 655f 7061 7468 3129 290a 2020 2020  ile_path1)).    
+0000a520: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
+0000a530: 616c 7365 2873 656c 662e 7061 7468 2e73  alse(self.path.s
+0000a540: 616d 6566 696c 6528 6669 6c65 5f70 6174  amefile(file_pat
+0000a550: 6831 2c20 6669 6c65 5f70 6174 6832 2929  h1, file_path2))
+0000a560: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000a570: 7365 7274 5472 7565 2873 656c 662e 7061  sertTrue(self.pa
+0000a580: 7468 2e73 616d 6566 696c 6528 6669 6c65  th.samefile(file
+0000a590: 5f70 6174 6831 2c20 2221 666f 6f21 2e2e  _path1, "!foo!..
+0000a5a0: 2166 6f6f 2162 6172 212e 2e21 6261 7221  !foo!bar!..!bar!
+0000a5b0: 6261 7a22 2929 0a20 2020 2020 2020 2073  baz")).        s
+0000a5c0: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
+0000a5d0: 656c 662e 7061 7468 2e73 616d 6566 696c  elf.path.samefil
+0000a5e0: 6528 6669 6c65 5f70 6174 6831 2c20 6222  e(file_path1, b"
+0000a5f0: 2166 6f6f 212e 2e21 666f 6f21 6261 7221  !foo!..!foo!bar!
+0000a600: 2e2e 2162 6172 2162 617a 2229 290a 0a20  ..!bar!baz")).. 
+0000a610: 2020 2064 6566 2074 6573 745f 6578 6973     def test_exis
+0000a620: 7473 2873 656c 6629 3a0a 2020 2020 2020  ts(self):.      
+0000a630: 2020 6669 6c65 5f70 6174 6820 3d20 2266    file_path = "f
+0000a640: 6f6f 2162 6172 2162 617a 220a 2020 2020  oo!bar!baz".    
+0000a650: 2020 2020 6669 6c65 5f70 6174 685f 6279      file_path_by
+0000a660: 7465 7320 3d20 6222 666f 6f21 6261 7221  tes = b"foo!bar!
+0000a670: 6261 7a22 0a20 2020 2020 2020 2073 656c  baz".        sel
+0000a680: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+0000a690: 6174 655f 6669 6c65 2866 696c 655f 7061  ate_file(file_pa
+0000a6a0: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
+0000a6b0: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
+0000a6c0: 2e70 6174 682e 6578 6973 7473 2866 696c  .path.exists(fil
+0000a6d0: 655f 7061 7468 2929 0a20 2020 2020 2020  e_path)).       
+0000a6e0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000a6f0: 2873 656c 662e 7061 7468 2e65 7869 7374  (self.path.exist
+0000a700: 7328 6669 6c65 5f70 6174 685f 6279 7465  s(file_path_byte
+0000a710: 7329 290a 2020 2020 2020 2020 7365 6c66  s)).        self
+0000a720: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
+0000a730: 662e 7061 7468 2e65 7869 7374 7328 2221  f.path.exists("!
+0000a740: 736f 6d65 216f 7468 6572 2162 6f67 7573  some!other!bogus
+0000a750: 2170 6174 6822 2929 0a0a 2020 2020 6465  !path"))..    de
+0000a760: 6620 7465 7374 5f65 7869 7374 735f 7769  f test_exists_wi
+0000a770: 7468 5f64 7269 7665 2873 656c 6629 3a0a  th_drive(self):.
+0000a780: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+0000a790: 6573 7973 7465 6d2e 6f73 203d 204f 5354  esystem.os = OST
+0000a7a0: 7970 652e 5749 4e44 4f57 530a 2020 2020  ype.WINDOWS.    
+0000a7b0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+0000a7c0: 7465 6d2e 6164 645f 6d6f 756e 745f 706f  tem.add_mount_po
+0000a7d0: 696e 7428 2246 3a22 290a 2020 2020 2020  int("F:").      
+0000a7e0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000a7f0: 6528 7365 6c66 2e70 6174 682e 6578 6973  e(self.path.exis
+0000a800: 7473 2822 433a 2229 290a 2020 2020 2020  ts("C:")).      
+0000a810: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000a820: 6528 7365 6c66 2e70 6174 682e 6578 6973  e(self.path.exis
+0000a830: 7473 2822 633a 5c5c 2229 290a 2020 2020  ts("c:\\")).    
+0000a840: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000a850: 7275 6528 7365 6c66 2e70 6174 682e 6578  rue(self.path.ex
+0000a860: 6973 7473 2822 663a 2229 290a 2020 2020  ists("f:")).    
+0000a870: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000a880: 7275 6528 7365 6c66 2e70 6174 682e 6578  rue(self.path.ex
+0000a890: 6973 7473 2822 463a 5c5c 2229 290a 2020  ists("F:\\")).  
+0000a8a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000a8b0: 7446 616c 7365 2873 656c 662e 7061 7468  tFalse(self.path
+0000a8c0: 2e65 7869 7374 7328 225a 3a22 2929 0a20  .exists("Z:")). 
+0000a8d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000a8e0: 7274 4661 6c73 6528 7365 6c66 2e70 6174  rtFalse(self.pat
+0000a8f0: 682e 6578 6973 7473 2822 7a3a 5c5c 2229  h.exists("z:\\")
+0000a900: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000a910: 6c65 7869 7374 7328 7365 6c66 293a 0a20  lexists(self):. 
+0000a920: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+0000a930: 203d 2022 666f 6f21 6261 7221 6261 7a22   = "foo!bar!baz"
+0000a940: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+0000a950: 7468 5f62 7974 6573 203d 2062 2266 6f6f  th_bytes = b"foo
+0000a960: 2162 6172 2162 617a 220a 2020 2020 2020  !bar!baz".      
+0000a970: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000a980: 6d2e 6372 6561 7465 5f64 6972 2822 666f  m.create_dir("fo
+0000a990: 6f21 6261 7222 290a 2020 2020 2020 2020  o!bar").        
+0000a9a0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000a9b0: 6372 6561 7465 5f73 796d 6c69 6e6b 2866  create_symlink(f
+0000a9c0: 696c 655f 7061 7468 2c20 2262 6f67 7573  ile_path, "bogus
+0000a9d0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0000a9e0: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
+0000a9f0: 7061 7468 2e6c 6578 6973 7473 2866 696c  path.lexists(fil
+0000aa00: 655f 7061 7468 2929 0a20 2020 2020 2020  e_path)).       
+0000aa10: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000aa20: 2873 656c 662e 7061 7468 2e6c 6578 6973  (self.path.lexis
+0000aa30: 7473 2866 696c 655f 7061 7468 5f62 7974  ts(file_path_byt
+0000aa40: 6573 2929 0a20 2020 2020 2020 2073 656c  es)).        sel
+0000aa50: 662e 6173 7365 7274 4661 6c73 6528 7365  f.assertFalse(se
+0000aa60: 6c66 2e70 6174 682e 6578 6973 7473 2866  lf.path.exists(f
+0000aa70: 696c 655f 7061 7468 2929 0a20 2020 2020  ile_path)).     
+0000aa80: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
+0000aa90: 6c73 6528 7365 6c66 2e70 6174 682e 6578  lse(self.path.ex
+0000aaa0: 6973 7473 2866 696c 655f 7061 7468 5f62  ists(file_path_b
+0000aab0: 7974 6573 2929 0a20 2020 2020 2020 2073  ytes)).        s
+0000aac0: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
+0000aad0: 7265 6174 655f 6669 6c65 2822 666f 6f21  reate_file("foo!
+0000aae0: 6261 7221 626f 6775 7322 290a 2020 2020  bar!bogus").    
+0000aaf0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000ab00: 7275 6528 7365 6c66 2e70 6174 682e 6578  rue(self.path.ex
+0000ab10: 6973 7473 2866 696c 655f 7061 7468 2929  ists(file_path))
+0000ab20: 0a0a 2020 2020 6465 6620 7465 7374 5f64  ..    def test_d
+0000ab30: 6972 6e61 6d65 5f77 6974 685f 6472 6976  irname_with_driv
+0000ab40: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0000ab50: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000ab60: 2e69 735f 7769 6e64 6f77 735f 6673 203d  .is_windows_fs =
+0000ab70: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
+0000ab80: 6c66 2e61 7373 6572 7445 7175 616c 2822  lf.assertEqual("
+0000ab90: 633a 2166 6f6f 222c 2073 656c 662e 7061  c:!foo", self.pa
+0000aba0: 7468 2e64 6972 6e61 6d65 2822 633a 2166  th.dirname("c:!f
+0000abb0: 6f6f 2162 6172 2229 290a 2020 2020 2020  oo!bar")).      
+0000abc0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000abd0: 616c 2862 2263 3a21 222c 2073 656c 662e  al(b"c:!", self.
+0000abe0: 7061 7468 2e64 6972 6e61 6d65 2862 2263  path.dirname(b"c
+0000abf0: 3a21 666f 6f22 2929 0a20 2020 2020 2020  :!foo")).       
+0000ac00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ac10: 6c28 2221 666f 6f22 2c20 7365 6c66 2e70  l("!foo", self.p
+0000ac20: 6174 682e 6469 726e 616d 6528 2221 666f  ath.dirname("!fo
+0000ac30: 6f21 6261 7222 2929 0a20 2020 2020 2020  o!bar")).       
+0000ac40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ac50: 6c28 6222 2122 2c20 7365 6c66 2e70 6174  l(b"!", self.pat
+0000ac60: 682e 6469 726e 616d 6528 6222 2166 6f6f  h.dirname(b"!foo
+0000ac70: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000ac80: 2e61 7373 6572 7445 7175 616c 2822 633a  .assertEqual("c:
+0000ac90: 666f 6f22 2c20 7365 6c66 2e70 6174 682e  foo", self.path.
+0000aca0: 6469 726e 616d 6528 2263 3a66 6f6f 2162  dirname("c:foo!b
+0000acb0: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
+0000acc0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+0000acd0: 2263 3a22 2c20 7365 6c66 2e70 6174 682e  "c:", self.path.
+0000ace0: 6469 726e 616d 6528 6222 633a 666f 6f22  dirname(b"c:foo"
+0000acf0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000ad00: 6173 7365 7274 4571 7561 6c28 2266 6f6f  assertEqual("foo
+0000ad10: 222c 2073 656c 662e 7061 7468 2e64 6972  ", self.path.dir
+0000ad20: 6e61 6d65 2822 666f 6f21 6261 7222 2929  name("foo!bar"))
+0000ad30: 0a0a 2020 2020 6465 6620 7465 7374 5f64  ..    def test_d
+0000ad40: 6972 6e61 6d65 2873 656c 6629 3a0a 2020  irname(self):.  
+0000ad50: 2020 2020 2020 6469 726e 616d 6520 3d20        dirname = 
+0000ad60: 2266 6f6f 2162 6172 220a 2020 2020 2020  "foo!bar".      
+0000ad70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000ad80: 616c 2864 6972 6e61 6d65 2c20 7365 6c66  al(dirname, self
+0000ad90: 2e70 6174 682e 6469 726e 616d 6528 2225  .path.dirname("%
+0000ada0: 7321 6261 7a22 2025 2064 6972 6e61 6d65  s!baz" % dirname
+0000adb0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0000adc0: 5f6a 6f69 6e5f 7374 7269 6e67 7328 7365  _join_strings(se
+0000add0: 6c66 293a 0a20 2020 2020 2020 2063 6f6d  lf):.        com
+0000ade0: 706f 6e65 6e74 7320 3d20 5b22 666f 6f22  ponents = ["foo"
+0000adf0: 2c20 2262 6172 222c 2022 6261 7a22 5d0a  , "bar", "baz"].
+0000ae00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000ae10: 6572 7445 7175 616c 2822 666f 6f21 6261  ertEqual("foo!ba
+0000ae20: 7221 6261 7a22 2c20 7365 6c66 2e70 6174  r!baz", self.pat
+0000ae30: 682e 6a6f 696e 282a 636f 6d70 6f6e 656e  h.join(*componen
+0000ae40: 7473 2929 0a0a 2020 2020 6465 6620 7465  ts))..    def te
+0000ae50: 7374 5f6a 6f69 6e5f 6279 7465 7328 7365  st_join_bytes(se
+0000ae60: 6c66 293a 0a20 2020 2020 2020 2063 6f6d  lf):.        com
+0000ae70: 706f 6e65 6e74 7320 3d20 5b62 2266 6f6f  ponents = [b"foo
+0000ae80: 222c 2062 2262 6172 222c 2062 2262 617a  ", b"bar", b"baz
+0000ae90: 225d 0a20 2020 2020 2020 2073 656c 662e  "].        self.
+0000aea0: 6173 7365 7274 4571 7561 6c28 6222 666f  assertEqual(b"fo
+0000aeb0: 6f21 6261 7221 6261 7a22 2c20 7365 6c66  o!bar!baz", self
+0000aec0: 2e70 6174 682e 6a6f 696e 282a 636f 6d70  .path.join(*comp
+0000aed0: 6f6e 656e 7473 2929 0a0a 2020 2020 4075  onents))..    @u
+0000aee0: 6e69 7474 6573 742e 736b 6970 4966 280a  nittest.skipIf(.
+0000aef0: 2020 2020 2020 2020 7379 732e 706c 6174          sys.plat
+0000af00: 666f 726d 2021 3d20 2277 696e 3332 2220  form != "win32" 
+0000af10: 6f72 2073 7973 2e76 6572 7369 6f6e 5f69  or sys.version_i
+0000af20: 6e66 6f20 3c20 2833 2c20 3829 2c20 2257  nfo < (3, 8), "W
+0000af30: 696e 646f 7773 2073 7065 6369 6669 6320  indows specific 
+0000af40: 7465 7374 220a 2020 2020 290a 2020 2020  test".    ).    
+0000af50: 4070 6174 6368 2e64 6963 7428 6f73 2e65  @patch.dict(os.e
+0000af60: 6e76 6972 6f6e 2c20 7b22 5553 4552 5052  nviron, {"USERPR
+0000af70: 4f46 494c 4522 3a20 7222 433a 5c55 7365  OFILE": r"C:\Use
+0000af80: 7273 5c4a 6f68 6e22 7d29 0a20 2020 2064  rs\John"}).    d
+0000af90: 6566 2074 6573 745f 6578 7061 6e64 5f75  ef test_expand_u
+0000afa0: 7365 725f 7769 6e64 6f77 7328 7365 6c66  ser_windows(self
+0000afb0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000afc0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000afd0: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
+0000afe0: 2822 7e22 292c 2022 433a 2155 7365 7273  ("~"), "C:!Users
+0000aff0: 214a 6f68 6e22 290a 0a20 2020 2040 756e  !John")..    @un
+0000b000: 6974 7465 7374 2e73 6b69 7049 6628 7379  ittest.skipIf(sy
+0000b010: 732e 706c 6174 666f 726d 203d 3d20 2277  s.platform == "w
+0000b020: 696e 3332 222c 2022 506f 7369 7820 7370  in32", "Posix sp
+0000b030: 6563 6966 6963 2074 6573 7422 290a 2020  ecific test").  
+0000b040: 2020 4070 6174 6368 2e64 6963 7428 6f73    @patch.dict(os
+0000b050: 2e65 6e76 6972 6f6e 2c20 7b22 484f 4d45  .environ, {"HOME
+0000b060: 223a 2022 2f68 6f6d 652f 6a6f 686e 227d  ": "/home/john"}
+0000b070: 290a 2020 2020 6465 6620 7465 7374 5f65  ).    def test_e
+0000b080: 7870 616e 645f 7573 6572 2873 656c 6629  xpand_user(self)
+0000b090: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+0000b0a0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000b0b0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+0000b0c0: 227e 2229 2c20 2221 686f 6d65 216a 6f68  "~"), "!home!joh
+0000b0d0: 6e22 290a 0a20 2020 2040 7061 7463 682e  n")..    @patch.
+0000b0e0: 6469 6374 286f 732e 656e 7669 726f 6e2c  dict(os.environ,
+0000b0f0: 207b 7d2c 2063 6c65 6172 3d54 7275 6529   {}, clear=True)
+0000b100: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
+0000b110: 7061 6e64 5f75 7365 725f 6e6f 5f68 6f6d  pand_user_no_hom
+0000b120: 655f 656e 7669 726f 6e6d 656e 7428 7365  e_environment(se
+0000b130: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+0000b140: 4d61 6b65 2073 7572 6520 7468 6973 2061  Make sure this a
+0000b150: 6c73 6f20 776f 726b 7320 7769 7468 6f75  lso works withou
+0000b160: 7420 484f 4d45 202f 2055 5345 5250 524f  t HOME / USERPRO
+0000b170: 4649 4c45 2073 6574 2222 220a 2020 2020  FILE set""".    
+0000b180: 2020 2020 2320 7765 206a 7573 7420 6368      # we just ch
+0000b190: 6563 6b20 7468 6174 2069 7420 646f 6573  eck that it does
+0000b1a0: 206e 6f74 2063 7261 7368 2061 6e64 2068   not crash and h
+0000b1b0: 6173 2073 6f6d 6520 7265 7375 6c74 2c0a  as some result,.
+0000b1c0: 2020 2020 2020 2020 2320 6173 2074 6865          # as the
+0000b1d0: 2072 6573 756c 7420 6973 2073 7973 7465   result is syste
+0000b1e0: 6d2d 6465 7065 6e64 656e 740a 2020 2020  m-dependent.    
+0000b1f0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000b200: 7275 6528 7365 6c66 2e70 6174 682e 6578  rue(self.path.ex
+0000b210: 7061 6e64 7573 6572 2822 7e22 2929 0a0a  panduser("~"))..
+0000b220: 2020 2020 4075 6e69 7474 6573 742e 736b      @unittest.sk
+0000b230: 6970 4966 280a 2020 2020 2020 2020 5465  ipIf(.        Te
+0000b240: 7374 4361 7365 2e69 735f 7769 6e64 6f77  stCase.is_window
+0000b250: 7320 6f72 2054 6573 7443 6173 652e 6973  s or TestCase.is
+0000b260: 5f63 7967 7769 6e2c 0a20 2020 2020 2020  _cygwin,.       
+0000b270: 2022 6f6e 6c79 2074 6573 7465 6420 6f6e   "only tested on
+0000b280: 2075 6e69 7820 7379 7374 656d 7322 2c0a   unix systems",.
+0000b290: 2020 2020 290a 2020 2020 6465 6620 7465      ).    def te
+0000b2a0: 7374 5f65 7870 616e 645f 726f 6f74 2873  st_expand_root(s
+0000b2b0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+0000b2c0: 2073 7973 2e70 6c61 7466 6f72 6d20 3d3d   sys.platform ==
+0000b2d0: 2022 6461 7277 696e 223a 0a20 2020 2020   "darwin":.     
+0000b2e0: 2020 2020 2020 2072 6f6f 7468 6f6d 6520         roothome 
+0000b2f0: 3d20 2221 7661 7221 726f 6f74 220a 2020  = "!var!root".  
+0000b300: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000b310: 2020 2020 2020 2020 726f 6f74 686f 6d65          roothome
+0000b320: 203d 2022 2172 6f6f 7422 0a20 2020 2020   = "!root".     
+0000b330: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000b340: 7561 6c28 7365 6c66 2e70 6174 682e 6578  ual(self.path.ex
+0000b350: 7061 6e64 7573 6572 2822 7e72 6f6f 7422  panduser("~root"
+0000b360: 292c 2072 6f6f 7468 6f6d 6529 0a0a 2020  ), roothome)..  
+0000b370: 2020 6465 6620 7465 7374 5f67 6574 7369    def test_getsi
+0000b380: 7a65 5f70 6174 685f 6e6f 6e65 7869 7374  ze_path_nonexist
+0000b390: 656e 7428 7365 6c66 293a 0a20 2020 2020  ent(self):.     
+0000b3a0: 2020 2066 696c 655f 7061 7468 203d 2022     file_path = "
+0000b3b0: 666f 6f21 6261 7221 6261 7a22 0a20 2020  foo!bar!baz".   
+0000b3c0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000b3d0: 7373 6572 7452 6169 7365 7328 6f73 2e65  ssertRaises(os.e
+0000b3e0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0000b3f0: 2020 2073 656c 662e 7061 7468 2e67 6574     self.path.get
+0000b400: 7369 7a65 2866 696c 655f 7061 7468 290a  size(file_path).
+0000b410: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+0000b420: 7473 697a 655f 6669 6c65 5f65 6d70 7479  tsize_file_empty
+0000b430: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000b440: 6669 6c65 5f70 6174 6820 3d20 2266 6f6f  file_path = "foo
+0000b450: 2162 6172 2162 617a 220a 2020 2020 2020  !bar!baz".      
+0000b460: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000b470: 6d2e 6372 6561 7465 5f66 696c 6528 6669  m.create_file(fi
+0000b480: 6c65 5f70 6174 6829 0a20 2020 2020 2020  le_path).       
+0000b490: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000b4a0: 6c28 302c 2073 656c 662e 7061 7468 2e67  l(0, self.path.g
+0000b4b0: 6574 7369 7a65 2866 696c 655f 7061 7468  etsize(file_path
+0000b4c0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0000b4d0: 5f67 6574 7369 7a65 5f66 696c 655f 6e6f  _getsize_file_no
+0000b4e0: 6e5f 7a65 726f 5f73 697a 6528 7365 6c66  n_zero_size(self
+0000b4f0: 293a 0a20 2020 2020 2020 2066 696c 655f  ):.        file_
+0000b500: 7061 7468 203d 2022 666f 6f21 6261 7221  path = "foo!bar!
+0000b510: 6261 7a22 0a20 2020 2020 2020 2066 696c  baz".        fil
+0000b520: 655f 7061 7468 5f62 7974 6573 203d 2062  e_path_bytes = b
+0000b530: 2266 6f6f 2162 6172 2162 617a 220a 2020  "foo!bar!baz".  
+0000b540: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+0000b550: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
+0000b560: 6528 6669 6c65 5f70 6174 682c 2063 6f6e  e(file_path, con
+0000b570: 7465 6e74 733d 2231 3233 3435 3637 2229  tents="1234567")
+0000b580: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000b590: 7365 7274 4571 7561 6c28 372c 2073 656c  sertEqual(7, sel
+0000b5a0: 662e 7061 7468 2e67 6574 7369 7a65 2866  f.path.getsize(f
+0000b5b0: 696c 655f 7061 7468 2929 0a20 2020 2020  ile_path)).     
+0000b5c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000b5d0: 7561 6c28 372c 2073 656c 662e 7061 7468  ual(7, self.path
+0000b5e0: 2e67 6574 7369 7a65 2866 696c 655f 7061  .getsize(file_pa
+0000b5f0: 7468 5f62 7974 6573 2929 0a0a 2020 2020  th_bytes))..    
+0000b600: 6465 6620 7465 7374 5f67 6574 7369 7a65  def test_getsize
+0000b610: 5f64 6972 5f65 6d70 7479 2873 656c 6629  _dir_empty(self)
+0000b620: 3a0a 2020 2020 2020 2020 2320 466f 7220  :.        # For 
+0000b630: 6469 7265 6374 6f72 6965 732c 206f 6e6c  directories, onl
+0000b640: 7920 7265 7175 6972 6520 7468 6174 2074  y require that t
+0000b650: 6865 2073 697a 6520 6973 206e 6f6e 2d6e  he size is non-n
+0000b660: 6567 6174 6976 652e 0a20 2020 2020 2020  egative..       
+0000b670: 2064 6972 5f70 6174 6820 3d20 2266 6f6f   dir_path = "foo
+0000b680: 2162 6172 220a 2020 2020 2020 2020 7365  !bar".        se
+0000b690: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
+0000b6a0: 6561 7465 5f64 6972 2864 6972 5f70 6174  eate_dir(dir_pat
+0000b6b0: 6829 0a20 2020 2020 2020 2073 697a 6520  h).        size 
+0000b6c0: 3d20 7365 6c66 2e70 6174 682e 6765 7473  = self.path.gets
+0000b6d0: 697a 6528 6469 725f 7061 7468 290a 2020  ize(dir_path).  
+0000b6e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000b6f0: 7446 616c 7365 2869 6e74 2873 697a 6529  tFalse(int(size)
+0000b700: 203c 2030 2c20 2265 7870 6563 7465 6420   < 0, "expected 
+0000b710: 6e6f 6e2d 6e65 6761 7469 7665 2073 697a  non-negative siz
+0000b720: 653b 2061 6374 7561 6c3a 2025 7322 2025  e; actual: %s" %
+0000b730: 2073 697a 6529 0a0a 2020 2020 6465 6620   size)..    def 
+0000b740: 7465 7374 5f67 6574 7369 7a65 5f64 6972  test_getsize_dir
+0000b750: 5f6e 6f6e 5f7a 6572 6f5f 7369 7a65 2873  _non_zero_size(s
+0000b760: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
+0000b770: 466f 7220 6469 7265 6374 6f72 6965 732c  For directories,
+0000b780: 206f 6e6c 7920 7265 7175 6972 6520 7468   only require th
+0000b790: 6174 2074 6865 2073 697a 6520 6973 206e  at the size is n
+0000b7a0: 6f6e 2d6e 6567 6174 6976 652e 0a20 2020  on-negative..   
+0000b7b0: 2020 2020 2064 6972 5f70 6174 6820 3d20       dir_path = 
+0000b7c0: 2266 6f6f 2162 6172 220a 2020 2020 2020  "foo!bar".      
+0000b7d0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000b7e0: 6d2e 6372 6561 7465 5f66 696c 6528 7365  m.create_file(se
+0000b7f0: 6c66 2e66 696c 6573 7973 7465 6d2e 6a6f  lf.filesystem.jo
+0000b800: 696e 7061 7468 7328 6469 725f 7061 7468  inpaths(dir_path
+0000b810: 2c20 2262 617a 2229 290a 2020 2020 2020  , "baz")).      
+0000b820: 2020 7369 7a65 203d 2073 656c 662e 7061    size = self.pa
+0000b830: 7468 2e67 6574 7369 7a65 2864 6972 5f70  th.getsize(dir_p
+0000b840: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
+0000b850: 662e 6173 7365 7274 4661 6c73 6528 696e  f.assertFalse(in
+0000b860: 7428 7369 7a65 2920 3c20 302c 2022 6578  t(size) < 0, "ex
+0000b870: 7065 6374 6564 206e 6f6e 2d6e 6567 6174  pected non-negat
+0000b880: 6976 6520 7369 7a65 3b20 6163 7475 616c  ive size; actual
+0000b890: 3a20 2573 2220 2520 7369 7a65 290a 0a20  : %s" % size).. 
+0000b8a0: 2020 2064 6566 2074 6573 745f 6973 6469     def test_isdi
+0000b8b0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+0000b8c0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000b8d0: 2e63 7265 6174 655f 6669 6c65 2822 666f  .create_file("fo
+0000b8e0: 6f21 6261 7222 290a 2020 2020 2020 2020  o!bar").        
+0000b8f0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000b900: 7365 6c66 2e70 6174 682e 6973 6469 7228  self.path.isdir(
+0000b910: 2266 6f6f 2229 290a 2020 2020 2020 2020  "foo")).        
+0000b920: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000b930: 7365 6c66 2e70 6174 682e 6973 6469 7228  self.path.isdir(
+0000b940: 6222 666f 6f22 2929 0a20 2020 2020 2020  b"foo")).       
+0000b950: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
+0000b960: 6528 7365 6c66 2e70 6174 682e 6973 6469  e(self.path.isdi
+0000b970: 7228 2266 6f6f 2162 6172 2229 290a 2020  r("foo!bar")).  
+0000b980: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000b990: 7446 616c 7365 2873 656c 662e 7061 7468  tFalse(self.path
+0000b9a0: 2e69 7364 6972 2822 6974 5f64 6f6e 745f  .isdir("it_dont_
+0000b9b0: 6578 6973 7422 2929 0a0a 2020 2020 6465  exist"))..    de
+0000b9c0: 6620 7465 7374 5f69 7364 6972 5f77 6974  f test_isdir_wit
+0000b9d0: 685f 6377 645f 6368 616e 6765 2873 656c  h_cwd_change(sel
+0000b9e0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000b9f0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
+0000ba00: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
+0000ba10: 7221 6261 7a22 290a 2020 2020 2020 2020  r!baz").        
+0000ba20: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000ba30: 7365 6c66 2e70 6174 682e 6973 6469 7228  self.path.isdir(
+0000ba40: 2221 666f 6f22 2929 0a20 2020 2020 2020  "!foo")).       
+0000ba50: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000ba60: 2873 656c 662e 7061 7468 2e69 7364 6972  (self.path.isdir
+0000ba70: 2822 2166 6f6f 2162 6172 2229 290a 2020  ("!foo!bar")).  
+0000ba80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000ba90: 7454 7275 6528 7365 6c66 2e70 6174 682e  tTrue(self.path.
+0000baa0: 6973 6469 7228 2266 6f6f 2229 290a 2020  isdir("foo")).  
+0000bab0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bac0: 7454 7275 6528 7365 6c66 2e70 6174 682e  tTrue(self.path.
+0000bad0: 6973 6469 7228 2266 6f6f 2162 6172 2229  isdir("foo!bar")
+0000bae0: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+0000baf0: 696c 6573 7973 7465 6d2e 6377 6420 3d20  ilesystem.cwd = 
+0000bb00: 6622 7b73 656c 662e 6669 6c65 7379 7374  f"{self.filesyst
+0000bb10: 656d 2e72 6f6f 745f 6469 725f 6e61 6d65  em.root_dir_name
+0000bb20: 7d66 6f6f 220a 2020 2020 2020 2020 7365  }foo".        se
+0000bb30: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000bb40: 6c66 2e70 6174 682e 6973 6469 7228 2221  lf.path.isdir("!
+0000bb50: 666f 6f22 2929 0a20 2020 2020 2020 2073  foo")).        s
+0000bb60: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
+0000bb70: 656c 662e 7061 7468 2e69 7364 6972 2822  elf.path.isdir("
+0000bb80: 2166 6f6f 2162 6172 2229 290a 2020 2020  !foo!bar")).    
+0000bb90: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000bba0: 7275 6528 7365 6c66 2e70 6174 682e 6973  rue(self.path.is
+0000bbb0: 6469 7228 2262 6172 2229 290a 0a20 2020  dir("bar"))..   
+0000bbc0: 2064 6566 2074 6573 745f 6973 6669 6c65   def test_isfile
+0000bbd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000bbe0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000bbf0: 6372 6561 7465 5f66 696c 6528 2266 6f6f  create_file("foo
+0000bc00: 2162 6172 2229 0a20 2020 2020 2020 2073  !bar").        s
+0000bc10: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+0000bc20: 7365 6c66 2e70 6174 682e 6973 6669 6c65  self.path.isfile
+0000bc30: 2822 666f 6f22 2929 0a20 2020 2020 2020  ("foo")).       
+0000bc40: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000bc50: 2873 656c 662e 7061 7468 2e69 7366 696c  (self.path.isfil
+0000bc60: 6528 2266 6f6f 2162 6172 2229 290a 2020  e("foo!bar")).  
+0000bc70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bc80: 7454 7275 6528 7365 6c66 2e70 6174 682e  tTrue(self.path.
+0000bc90: 6973 6669 6c65 2862 2266 6f6f 2162 6172  isfile(b"foo!bar
+0000bca0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000bcb0: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
+0000bcc0: 662e 7061 7468 2e69 7366 696c 6528 2269  f.path.isfile("i
+0000bcd0: 745f 646f 6e74 5f65 7869 7374 2229 290a  t_dont_exist")).
+0000bce0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+0000bcf0: 745f 6d74 696d 6528 7365 6c66 293a 0a20  t_mtime(self):. 
+0000bd00: 2020 2020 2020 2074 6573 745f 6669 6c65         test_file
+0000bd10: 203d 2073 656c 662e 6669 6c65 7379 7374   = self.filesyst
+0000bd20: 656d 2e63 7265 6174 655f 6669 6c65 2822  em.create_file("
+0000bd30: 666f 6f21 6261 7231 2e74 7874 2229 0a20  foo!bar1.txt"). 
+0000bd40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000bd50: 7274 4e6f 7445 7175 616c 2832 342c 2073  rtNotEqual(24, s
+0000bd60: 656c 662e 7061 7468 2e67 6574 6d74 696d  elf.path.getmtim
+0000bd70: 6528 2266 6f6f 2162 6172 312e 7478 7422  e("foo!bar1.txt"
+0000bd80: 2929 0a20 2020 2020 2020 2074 6573 745f  )).        test_
+0000bd90: 6669 6c65 2e73 745f 6d74 696d 6520 3d20  file.st_mtime = 
+0000bda0: 3234 0a20 2020 2020 2020 2073 656c 662e  24.        self.
+0000bdb0: 6173 7365 7274 4571 7561 6c28 3234 2c20  assertEqual(24, 
+0000bdc0: 7365 6c66 2e70 6174 682e 6765 746d 7469  self.path.getmti
+0000bdd0: 6d65 2822 666f 6f21 6261 7231 2e74 7874  me("foo!bar1.txt
+0000bde0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000bdf0: 2e61 7373 6572 7445 7175 616c 2832 342c  .assertEqual(24,
+0000be00: 2073 656c 662e 7061 7468 2e67 6574 6d74   self.path.getmt
+0000be10: 696d 6528 6222 666f 6f21 6261 7231 2e74  ime(b"foo!bar1.t
+0000be20: 7874 2229 290a 0a20 2020 2064 6566 2074  xt"))..    def t
+0000be30: 6573 745f 6765 745f 6d74 696d 655f 7261  est_get_mtime_ra
+0000be40: 6973 6573 5f6f 735f 6572 726f 7228 7365  ises_os_error(se
+0000be50: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0000be60: 662e 6173 7365 7274 4661 6c73 6528 7365  f.assertFalse(se
+0000be70: 6c66 2e70 6174 682e 6578 6973 7473 2822  lf.path.exists("
+0000be80: 646f 6573 5f6e 6f74 5f65 7869 7374 2229  does_not_exist")
+0000be90: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+0000bea0: 656c 662e 7261 6973 6573 5f6f 735f 6572  elf.raises_os_er
+0000beb0: 726f 7228 6572 726e 6f2e 454e 4f45 4e54  ror(errno.ENOENT
+0000bec0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0000bed0: 656c 662e 7061 7468 2e67 6574 6d74 696d  elf.path.getmtim
+0000bee0: 6528 2264 6f65 735f 6e6f 745f 6578 6973  e("does_not_exis
+0000bef0: 7422 290a 0a20 2020 2064 6566 2074 6573  t")..    def tes
+0000bf00: 745f 6973 6c69 6e6b 2873 656c 6629 3a0a  t_islink(self):.
+0000bf10: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+0000bf20: 6573 7973 7465 6d2e 6372 6561 7465 5f64  esystem.create_d
+0000bf30: 6972 2822 666f 6f22 290a 2020 2020 2020  ir("foo").      
+0000bf40: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000bf50: 6d2e 6372 6561 7465 5f66 696c 6528 2266  m.create_file("f
+0000bf60: 6f6f 2172 6567 756c 6172 5f66 696c 6522  oo!regular_file"
+0000bf70: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+0000bf80: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+0000bf90: 5f73 796d 6c69 6e6b 2822 666f 6f21 6c69  _symlink("foo!li
+0000bfa0: 6e6b 5f74 6f5f 6669 6c65 222c 2022 7265  nk_to_file", "re
+0000bfb0: 6775 6c61 725f 6669 6c65 2229 0a20 2020  gular_file").   
+0000bfc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000bfd0: 4661 6c73 6528 7365 6c66 2e70 6174 682e  False(self.path.
+0000bfe0: 6973 6c69 6e6b 2822 666f 6f22 2929 0a0a  islink("foo"))..
+0000bff0: 2020 2020 2020 2020 2320 416e 206f 626a          # An obj
+0000c000: 6563 7420 6361 6e20 6265 2062 6f74 6820  ect can be both 
+0000c010: 6120 6c69 6e6b 2061 6e64 2061 2066 696c  a link and a fil
+0000c020: 6520 6f72 2066 696c 652c 2061 6363 6f72  e or file, accor
+0000c030: 6469 6e67 2074 6f20 7468 650a 2020 2020  ding to the.    
+0000c040: 2020 2020 2320 636f 6d6d 656e 7473 2069      # comments i
+0000c050: 6e20 5079 7468 6f6e 2f4c 6962 2f70 6f73  n Python/Lib/pos
+0000c060: 6978 7061 7468 2e70 792e 0a20 2020 2020  ixpath.py..     
+0000c070: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+0000c080: 7565 2873 656c 662e 7061 7468 2e69 736c  ue(self.path.isl
+0000c090: 696e 6b28 2266 6f6f 216c 696e 6b5f 746f  ink("foo!link_to
+0000c0a0: 5f66 696c 6522 2929 0a20 2020 2020 2020  _file")).       
+0000c0b0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000c0c0: 2873 656c 662e 7061 7468 2e69 7366 696c  (self.path.isfil
+0000c0d0: 6528 2266 6f6f 216c 696e 6b5f 746f 5f66  e("foo!link_to_f
+0000c0e0: 696c 6522 2929 0a20 2020 2020 2020 2073  ile")).        s
+0000c0f0: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
+0000c100: 656c 662e 7061 7468 2e69 736c 696e 6b28  elf.path.islink(
+0000c110: 6222 666f 6f21 6c69 6e6b 5f74 6f5f 6669  b"foo!link_to_fi
+0000c120: 6c65 2229 290a 2020 2020 2020 2020 7365  le")).        se
+0000c130: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000c140: 6c66 2e70 6174 682e 6973 6669 6c65 2862  lf.path.isfile(b
+0000c150: 2266 6f6f 216c 696e 6b5f 746f 5f66 696c  "foo!link_to_fil
+0000c160: 6522 2929 0a0a 2020 2020 2020 2020 7365  e"))..        se
+0000c170: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000c180: 6c66 2e70 6174 682e 6973 6669 6c65 2822  lf.path.isfile("
+0000c190: 666f 6f21 7265 6775 6c61 725f 6669 6c65  foo!regular_file
+0000c1a0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000c1b0: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
+0000c1c0: 662e 7061 7468 2e69 736c 696e 6b28 2266  f.path.islink("f
+0000c1d0: 6f6f 2172 6567 756c 6172 5f66 696c 6522  oo!regular_file"
+0000c1e0: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+0000c1f0: 2e61 7373 6572 7446 616c 7365 2873 656c  .assertFalse(sel
+0000c200: 662e 7061 7468 2e69 736c 696e 6b28 2269  f.path.islink("i
+0000c210: 745f 646f 6e74 5f65 7869 7374 2229 290a  t_dont_exist")).
+0000c220: 0a20 2020 2064 6566 2074 6573 745f 6973  .    def test_is
+0000c230: 5f6c 696e 6b5f 6361 7365 5f73 656e 7369  _link_case_sensi
+0000c240: 7469 7665 2873 656c 6629 3a0a 2020 2020  tive(self):.    
+0000c250: 2020 2020 2320 5265 6772 6573 7369 6f6e      # Regression
+0000c260: 2074 6573 7420 666f 7220 2333 3036 0a20   test for #306. 
+0000c270: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+0000c280: 7379 7374 656d 2e69 735f 6361 7365 5f73  system.is_case_s
+0000c290: 656e 7369 7469 7665 203d 2046 616c 7365  ensitive = False
+0000c2a0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+0000c2b0: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+0000c2c0: 6469 7228 2266 6f6f 2229 0a20 2020 2020  dir("foo").     
+0000c2d0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0000c2e0: 656d 2e63 7265 6174 655f 7379 6d6c 696e  em.create_symlin
+0000c2f0: 6b28 2266 6f6f 2162 6172 222c 2022 666f  k("foo!bar", "fo
+0000c300: 6f22 290a 2020 2020 2020 2020 7365 6c66  o").        self
+0000c310: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
+0000c320: 2e70 6174 682e 6973 6c69 6e6b 2822 666f  .path.islink("fo
+0000c330: 6f21 4261 7222 2929 0a0a 2020 2020 6465  o!Bar"))..    de
+0000c340: 6620 7465 7374 5f69 736d 6f75 6e74 2873  f test_ismount(s
+0000c350: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0000c360: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
+0000c370: 656c 662e 7061 7468 2e69 736d 6f75 6e74  elf.path.ismount
+0000c380: 2822 2229 290a 2020 2020 2020 2020 7365  ("")).        se
+0000c390: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000c3a0: 6c66 2e70 6174 682e 6973 6d6f 756e 7428  lf.path.ismount(
+0000c3b0: 2221 2229 290a 2020 2020 2020 2020 7365  "!")).        se
+0000c3c0: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000c3d0: 6c66 2e70 6174 682e 6973 6d6f 756e 7428  lf.path.ismount(
+0000c3e0: 6222 2122 2929 0a20 2020 2020 2020 2073  b"!")).        s
+0000c3f0: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+0000c400: 7365 6c66 2e70 6174 682e 6973 6d6f 756e  self.path.ismoun
+0000c410: 7428 2221 6d6f 756e 7421 2229 290a 2020  t("!mount!")).  
+0000c420: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+0000c430: 7973 7465 6d2e 6164 645f 6d6f 756e 745f  ystem.add_mount_
+0000c440: 706f 696e 7428 2221 6d6f 756e 7422 290a  point("!mount").
+0000c450: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000c460: 6572 7454 7275 6528 7365 6c66 2e70 6174  ertTrue(self.pat
+0000c470: 682e 6973 6d6f 756e 7428 2221 6d6f 756e  h.ismount("!moun
+0000c480: 7422 2929 0a20 2020 2020 2020 2073 656c  t")).        sel
+0000c490: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
+0000c4a0: 662e 7061 7468 2e69 736d 6f75 6e74 2862  f.path.ismount(b
+0000c4b0: 2221 6d6f 756e 7422 2929 0a20 2020 2020  "!mount")).     
+0000c4c0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+0000c4d0: 7565 2873 656c 662e 7061 7468 2e69 736d  ue(self.path.ism
+0000c4e0: 6f75 6e74 2822 216d 6f75 6e74 2122 2929  ount("!mount!"))
+0000c4f0: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
+0000c500: 736d 6f75 6e74 5f77 6974 685f 6472 6976  smount_with_driv
+0000c510: 655f 6c65 7474 6572 7328 7365 6c66 293a  e_letters(self):
+0000c520: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+0000c530: 6c65 7379 7374 656d 2e69 735f 7769 6e64  lesystem.is_wind
+0000c540: 6f77 735f 6673 203d 2054 7275 650a 2020  ows_fs = True.  
+0000c550: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000c560: 7454 7275 6528 7365 6c66 2e70 6174 682e  tTrue(self.path.
+0000c570: 6973 6d6f 756e 7428 2221 2229 290a 2020  ismount("!")).  
+0000c580: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000c590: 7454 7275 6528 7365 6c66 2e70 6174 682e  tTrue(self.path.
+0000c5a0: 6973 6d6f 756e 7428 2263 3a21 2229 290a  ismount("c:!")).
+0000c5b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000c5c0: 6572 7446 616c 7365 2873 656c 662e 7061  ertFalse(self.pa
+0000c5d0: 7468 2e69 736d 6f75 6e74 2822 633a 2229  th.ismount("c:")
+0000c5e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c5f0: 7373 6572 7454 7275 6528 7365 6c66 2e70  ssertTrue(self.p
+0000c600: 6174 682e 6973 6d6f 756e 7428 227a 3a21  ath.ismount("z:!
+0000c610: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000c620: 2e66 696c 6573 7973 7465 6d2e 6164 645f  .filesystem.add_
+0000c630: 6d6f 756e 745f 706f 696e 7428 2221 6d6f  mount_point("!mo
+0000c640: 756e 7422 290a 2020 2020 2020 2020 7365  unt").        se
+0000c650: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000c660: 6c66 2e70 6174 682e 6973 6d6f 756e 7428  lf.path.ismount(
+0000c670: 2221 6d6f 756e 7422 2929 0a20 2020 2020  "!mount")).     
+0000c680: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+0000c690: 7565 2873 656c 662e 7061 7468 2e69 736d  ue(self.path.ism
+0000c6a0: 6f75 6e74 2822 216d 6f75 6e74 2122 2929  ount("!mount!"))
+0000c6b0: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
+0000c6c0: 736d 6f75 6e74 5f77 6974 685f 756e 635f  smount_with_unc_
+0000c6d0: 7061 7468 7328 7365 6c66 293a 0a20 2020  paths(self):.   
+0000c6e0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+0000c6f0: 7374 656d 2e69 735f 7769 6e64 6f77 735f  stem.is_windows_
+0000c700: 6673 203d 2054 7275 650a 2020 2020 2020  fs = True.      
+0000c710: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000c720: 6528 7365 6c66 2e70 6174 682e 6973 6d6f  e(self.path.ismo
+0000c730: 756e 7428 2221 2161 2122 2929 0a20 2020  unt("!!a!")).   
+0000c740: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c750: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
+0000c760: 736d 6f75 6e74 2822 2121 6121 6222 2929  smount("!!a!b"))
+0000c770: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000c780: 7365 7274 5472 7565 2873 656c 662e 7061  sertTrue(self.pa
+0000c790: 7468 2e69 736d 6f75 6e74 2822 2121 6121  th.ismount("!!a!
+0000c7a0: 6221 2229 290a 2020 2020 2020 2020 7365  b!")).        se
+0000c7b0: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
+0000c7c0: 656c 662e 7061 7468 2e69 736d 6f75 6e74  elf.path.ismount
+0000c7d0: 2822 2161 2162 2122 2929 0a20 2020 2020  ("!a!b!")).     
+0000c7e0: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
+0000c7f0: 6c73 6528 7365 6c66 2e70 6174 682e 6973  lse(self.path.is
+0000c800: 6d6f 756e 7428 2221 2161 2162 2163 2229  mount("!!a!b!c")
+0000c810: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000c820: 6973 6d6f 756e 745f 7769 7468 5f61 6c74  ismount_with_alt
+0000c830: 6572 6e61 7465 5f70 6174 685f 7365 7061  ernate_path_sepa
+0000c840: 7261 746f 7228 7365 6c66 293a 0a20 2020  rator(self):.   
+0000c850: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+0000c860: 7374 656d 2e61 6c74 6572 6e61 7469 7665  stem.alternative
+0000c870: 5f70 6174 685f 7365 7061 7261 746f 7220  _path_separator 
+0000c880: 3d20 2221 220a 2020 2020 2020 2020 7365  = "!".        se
+0000c890: 6c66 2e66 696c 6573 7973 7465 6d2e 6164  lf.filesystem.ad
+0000c8a0: 645f 6d6f 756e 745f 706f 696e 7428 2221  d_mount_point("!
+0000c8b0: 6d6f 756e 7422 290a 2020 2020 2020 2020  mount").        
+0000c8c0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0000c8d0: 7365 6c66 2e70 6174 682e 6973 6d6f 756e  self.path.ismoun
+0000c8e0: 7428 2221 6d6f 756e 7422 2929 0a20 2020  t("!mount")).   
+0000c8f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c900: 5472 7565 2873 656c 662e 7061 7468 2e69  True(self.path.i
+0000c910: 736d 6f75 6e74 2822 216d 6f75 6e74 2122  smount("!mount!"
+0000c920: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000c930: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
+0000c940: 7061 7468 2e69 736d 6f75 6e74 2822 216d  path.ismount("!m
+0000c950: 6f75 6e74 2121 2229 290a 2020 2020 2020  ount!!")).      
+0000c960: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000c970: 6d2e 6973 5f77 696e 646f 7773 5f66 7320  m.is_windows_fs 
+0000c980: 3d20 5472 7565 0a20 2020 2020 2020 2073  = True.        s
+0000c990: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
+0000c9a0: 656c 662e 7061 7468 2e69 736d 6f75 6e74  elf.path.ismount
+0000c9b0: 2822 5a3a 2122 2929 0a0a 2020 2020 6465  ("Z:!"))..    de
+0000c9c0: 6620 7465 7374 5f67 6574 6174 7472 5f66  f test_getattr_f
+0000c9d0: 6f72 7761 7264 5f74 6f5f 7265 616c 5f6f  orward_to_real_o
+0000c9e0: 735f 7061 7468 2873 656c 6629 3a0a 2020  s_path(self):.  
+0000c9f0: 2020 2020 2020 2222 2246 6f72 7761 7264        """Forward
+0000ca00: 7320 616e 7920 6e6f 6e2d 6661 6b65 6420  s any non-faked 
+0000ca10: 6361 6c6c 7320 746f 206f 732e 7061 7468  calls to os.path
+0000ca20: 2e22 2222 0a20 2020 2020 2020 2073 656c  .""".        sel
+0000ca30: 662e 6173 7365 7274 5472 7565 2868 6173  f.assertTrue(has
+0000ca40: 6174 7472 2873 656c 662e 7061 7468 2c20  attr(self.path, 
+0000ca50: 2273 6570 2229 2c20 2247 6574 2061 2066  "sep"), "Get a f
+0000ca60: 616b 6564 206f 732e 7061 7468 2066 756e  aked os.path fun
+0000ca70: 6374 696f 6e22 290a 2020 2020 2020 2020  ction").        
+0000ca80: 7072 6976 6174 655f 7061 7468 5f66 756e  private_path_fun
+0000ca90: 6374 696f 6e20 3d20 4e6f 6e65 0a20 2020  ction = None.   
+0000caa0: 2020 2020 2069 6620 7379 732e 7665 7273       if sys.vers
+0000cab0: 696f 6e5f 696e 666f 203c 2028 332c 2036  ion_info < (3, 6
+0000cac0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0000cad0: 6620 7365 6c66 2e69 735f 7769 6e64 6f77  f self.is_window
+0000cae0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000caf0: 2020 2070 7269 7661 7465 5f70 6174 685f     private_path_
+0000cb00: 6675 6e63 7469 6f6e 203d 2022 5f67 6574  function = "_get
+0000cb10: 5f62 6f74 6873 6570 7322 0a20 2020 2020  _bothseps".     
+0000cb20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000cb30: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000cb40: 7661 7465 5f70 6174 685f 6675 6e63 7469  vate_path_functi
+0000cb50: 6f6e 203d 2022 5f6a 6f69 6e5f 7265 616c  on = "_join_real
+0000cb60: 5f70 6174 6822 0a20 2020 2020 2020 2069  _path".        i
+0000cb70: 6620 7072 6976 6174 655f 7061 7468 5f66  f private_path_f
+0000cb80: 756e 6374 696f 6e3a 0a20 2020 2020 2020  unction:.       
+0000cb90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000cba0: 5472 7565 280a 2020 2020 2020 2020 2020  True(.          
+0000cbb0: 2020 2020 2020 6861 7361 7474 7228 7365        hasattr(se
+0000cbc0: 6c66 2e70 6174 682c 2070 7269 7661 7465  lf.path, private
+0000cbd0: 5f70 6174 685f 6675 6e63 7469 6f6e 292c  _path_function),
+0000cbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cbf0: 2022 4765 7420 6120 7265 616c 206f 732e   "Get a real os.
+0000cc00: 7061 7468 2066 756e 6374 696f 6e20 2220  path function " 
+0000cc10: 226e 6f74 2069 6d70 6c65 6d65 6e74 6564  "not implemented
+0000cc20: 2069 6e20 6661 6b65 206f 732e 7061 7468   in fake os.path
+0000cc30: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+0000cc40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000cc50: 7365 7274 4661 6c73 6528 6861 7361 7474  sertFalse(hasatt
+0000cc60: 7228 7365 6c66 2e70 6174 682c 2022 6e6f  r(self.path, "no
+0000cc70: 6e65 7869 7374 656e 7422 2929 0a0a 2020  nexistent"))..  
+0000cc80: 2020 6465 6620 7465 7374 5f73 706c 6974    def test_split
+0000cc90: 726f 6f74 5f70 6f73 6978 2873 656c 6629  root_posix(self)
+0000cca0: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
+0000ccb0: 696c 6573 7973 7465 6d2e 6973 5f77 696e  ilesystem.is_win
+0000ccc0: 646f 7773 5f66 7320 3d20 4661 6c73 650a  dows_fs = False.
+0000ccd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000cce0: 6572 7445 7175 616c 2828 2222 2c20 2222  ertEqual(("", ""
+0000ccf0: 2c20 2266 6f6f 2162 6172 2229 2c20 7365  , "foo!bar"), se
+0000cd00: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+0000cd10: 6c69 7472 6f6f 7428 2266 6f6f 2162 6172  litroot("foo!bar
+0000cd20: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000cd30: 2e61 7373 6572 7445 7175 616c 2828 2222  .assertEqual((""
+0000cd40: 2c20 2221 222c 2022 666f 6f21 6261 7222  , "!", "foo!bar"
+0000cd50: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
+0000cd60: 656d 2e73 706c 6974 726f 6f74 2822 2166  em.splitroot("!f
+0000cd70: 6f6f 2162 6172 2229 290a 2020 2020 2020  oo!bar")).      
+0000cd80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000cd90: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
+0000cda0: 2822 222c 2022 2121 222c 2022 666f 6f21  ("", "!!", "foo!
+0000cdb0: 2162 6172 2229 2c20 7365 6c66 2e66 696c  !bar"), self.fil
+0000cdc0: 6573 7973 7465 6d2e 7370 6c69 7472 6f6f  esystem.splitroo
+0000cdd0: 7428 2221 2166 6f6f 2121 6261 7222 290a  t("!!foo!!bar").
+0000cde0: 2020 2020 2020 2020 290a 0a0a 636c 6173          )...clas
+0000cdf0: 7320 5061 7468 4d61 6e69 7075 6c61 7469  s PathManipulati
+0000ce00: 6f6e 5465 7374 4261 7365 2854 6573 7443  onTestBase(TestC
+0000ce10: 6173 6529 3a0a 2020 2020 6465 6620 7365  ase):.    def se
+0000ce20: 7455 7028 7365 6c66 293a 0a20 2020 2020  tUp(self):.     
+0000ce30: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0000ce40: 656d 203d 2066 616b 655f 6669 6c65 7379  em = fake_filesy
+0000ce50: 7374 656d 2e46 616b 6546 696c 6573 7973  stem.FakeFilesys
+0000ce60: 7465 6d28 7061 7468 5f73 6570 6172 6174  tem(path_separat
+0000ce70: 6f72 3d22 7c22 290a 0a0a 636c 6173 7320  or="|")...class 
+0000ce80: 436f 6c6c 6170 7365 5061 7468 5069 7065  CollapsePathPipe
+0000ce90: 5365 7061 7261 746f 7254 6573 7428 5061  SeparatorTest(Pa
+0000cea0: 7468 4d61 6e69 7075 6c61 7469 6f6e 5465  thManipulationTe
+0000ceb0: 7374 4261 7365 293a 0a20 2020 2022 2222  stBase):.    """
+0000cec0: 5465 7374 7320 436f 6c6c 6170 7365 5061  Tests CollapsePa
+0000ced0: 7468 2028 6d69 6d69 6373 206f 732e 7061  th (mimics os.pa
+0000cee0: 7468 2e6e 6f72 6d70 6174 6829 2075 7369  th.normpath) usi
+0000cef0: 6e67 207c 0a20 2020 2061 7320 7061 7468  ng |.    as path
+0000cf00: 2073 6570 6172 6174 6f72 2e22 2222 0a0a   separator."""..
+0000cf10: 2020 2020 6465 6620 7465 7374 5f65 6d70      def test_emp
+0000cf20: 7479 5f70 6174 685f 6265 636f 6d65 735f  ty_path_becomes_
+0000cf30: 646f 745f 7061 7468 2873 656c 6629 3a0a  dot_path(self):.
+0000cf40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000cf50: 6572 7445 7175 616c 2822 2e22 2c20 7365  ertEqual(".", se
+0000cf60: 6c66 2e66 696c 6573 7973 7465 6d2e 6e6f  lf.filesystem.no
+0000cf70: 726d 7061 7468 2822 2229 290a 0a20 2020  rmpath(""))..   
+0000cf80: 2064 6566 2074 6573 745f 646f 745f 7061   def test_dot_pa
+0000cf90: 7468 5f75 6e63 6861 6e67 6564 2873 656c  th_unchanged(sel
+0000cfa0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000cfb0: 2e61 7373 6572 7445 7175 616c 2822 2e22  .assertEqual("."
+0000cfc0: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+0000cfd0: 6d2e 6e6f 726d 7061 7468 2822 2e22 2929  m.normpath("."))
+0000cfe0: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+0000cff0: 6c61 7368 6573 5f61 7265 5f6e 6f74 5f63  lashes_are_not_c
+0000d000: 6f6c 6c61 7073 6564 2873 656c 6629 3a0a  ollapsed(self):.
+0000d010: 2020 2020 2020 2020 2222 2254 6573 7473          """Tests
+0000d020: 2074 6861 7420 272f 2720 6973 206e 6f74   that '/' is not
+0000d030: 2074 7265 6174 6564 2073 7065 6369 616c   treated special
+0000d040: 6c79 2069 6620 7468 650a 2020 2020 2020  ly if the.      
+0000d050: 2020 2020 2020 7061 7468 2073 6570 6172        path separ
+0000d060: 6174 6f72 2069 7320 277c 272e 0a0a 2020  ator is '|'...  
+0000d070: 2020 2020 2020 496e 2070 6172 7469 6375        In particu
+0000d080: 6c61 722c 206d 756c 7469 706c 6520 736c  lar, multiple sl
+0000d090: 6173 6865 7320 7368 6f75 6c64 206e 6f74  ashes should not
+0000d0a0: 2062 6520 636f 6c6c 6170 7365 642e 0a20   be collapsed.. 
+0000d0b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000d0c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000d0d0: 7561 6c28 222f 222c 2073 656c 662e 6669  ual("/", self.fi
+0000d0e0: 6c65 7379 7374 656d 2e6e 6f72 6d70 6174  lesystem.normpat
+0000d0f0: 6828 222f 2229 290a 2020 2020 2020 2020  h("/")).        
+0000d100: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000d110: 2822 2f2f 2f2f 2f22 2c20 7365 6c66 2e66  ("/////", self.f
+0000d120: 696c 6573 7973 7465 6d2e 6e6f 726d 7061  ilesystem.normpa
+0000d130: 7468 2822 2f2f 2f2f 2f22 2929 0a0a 2020  th("/////"))..  
+0000d140: 2020 6465 6620 7465 7374 5f72 6f6f 745f    def test_root_
+0000d150: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
+0000d160: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000d170: 7175 616c 2822 7c22 2c20 7365 6c66 2e66  qual("|", self.f
+0000d180: 696c 6573 7973 7465 6d2e 6e6f 726d 7061  ilesystem.normpa
+0000d190: 7468 2822 7c22 2929 0a0a 2020 2020 6465  th("|"))..    de
+0000d1a0: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
+0000d1b0: 7365 7061 7261 746f 7273 5f63 6f6c 6c61  separators_colla
+0000d1c0: 7073 6564 5f69 6e74 6f5f 726f 6f74 5f70  psed_into_root_p
+0000d1d0: 6174 6828 7365 6c66 293a 0a20 2020 2020  ath(self):.     
+0000d1e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000d1f0: 7561 6c28 227c 222c 2073 656c 662e 6669  ual("|", self.fi
+0000d200: 6c65 7379 7374 656d 2e6e 6f72 6d70 6174  lesystem.normpat
+0000d210: 6828 227c 7c7c 7c7c 2229 290a 0a20 2020  h("|||||"))..   
+0000d220: 2064 6566 2074 6573 745f 616c 6c5f 646f   def test_all_do
+0000d230: 745f 7061 7468 735f 7265 6d6f 7665 645f  t_paths_removed_
+0000d240: 6275 745f 6f6e 6528 7365 6c66 293a 0a20  but_one(self):. 
+0000d250: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000d260: 7274 4571 7561 6c28 222e 222c 2073 656c  rtEqual(".", sel
+0000d270: 662e 6669 6c65 7379 7374 656d 2e6e 6f72  f.filesystem.nor
+0000d280: 6d70 6174 6828 222e 7c2e 7c2e 7c2e 2229  mpath(".|.|.|.")
+0000d290: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000d2a0: 616c 6c5f 646f 745f 7061 7468 735f 7265  all_dot_paths_re
+0000d2b0: 6d6f 7665 645f 6966 5f61 6e6f 7468 6572  moved_if_another
+0000d2c0: 5f70 6174 685f 636f 6d70 6f6e 656e 745f  _path_component_
+0000d2d0: 6578 6973 7473 2873 656c 6629 3a0a 2020  exists(self):.  
+0000d2e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000d2f0: 7445 7175 616c 2822 7c22 2c20 7365 6c66  tEqual("|", self
+0000d300: 2e66 696c 6573 7973 7465 6d2e 6e6f 726d  .filesystem.norm
+0000d310: 7061 7468 2822 7c2e 7c2e 7c2e 7c22 2929  path("|.|.|.|"))
+0000d320: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000d330: 7365 7274 4571 7561 6c28 2266 6f6f 7c62  sertEqual("foo|b
+0000d340: 6172 222c 2073 656c 662e 6669 6c65 7379  ar", self.filesy
+0000d350: 7374 656d 2e6e 6f72 6d70 6174 6828 2266  stem.normpath("f
+0000d360: 6f6f 7c2e 7c2e 7c2e 7c62 6172 2229 290a  oo|.|.|.|bar")).
+0000d370: 0a20 2020 2064 6566 2074 6573 745f 6967  .    def test_ig
+0000d380: 6e6f 7265 735f 7570 5f6c 6576 656c 5f72  nores_up_level_r
+0000d390: 6566 6572 656e 6365 735f 7374 6172 7469  eferences_starti
+0000d3a0: 6e67 5f66 726f 6d5f 726f 6f74 2873 656c  ng_from_root(sel
+0000d3b0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000d3c0: 2e61 7373 6572 7445 7175 616c 2822 7c22  .assertEqual("|"
+0000d3d0: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+0000d3e0: 6d2e 6e6f 726d 7061 7468 2822 7c2e 2e7c  m.normpath("|..|
+0000d3f0: 2e2e 7c2e 2e7c 2229 290a 2020 2020 2020  ..|..|")).      
+0000d400: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000d410: 616c 2822 7c22 2c20 7365 6c66 2e66 696c  al("|", self.fil
+0000d420: 6573 7973 7465 6d2e 6e6f 726d 7061 7468  esystem.normpath
+0000d430: 2822 7c2e 2e7c 2e2e 7c66 6f6f 7c62 6172  ("|..|..|foo|bar
+0000d440: 7c2e 2e7c 2e2e 7c22 2929 0a20 2020 2020  |..|..|")).     
+0000d450: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0000d460: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
+0000d470: 203d 2046 616c 7365 2020 2320 6e6f 7420   = False  # not 
+0000d480: 616e 2055 4e43 2070 6174 680a 2020 2020  an UNC path.    
+0000d490: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000d4a0: 7175 616c 2822 7c22 2c20 7365 6c66 2e66  qual("|", self.f
+0000d4b0: 696c 6573 7973 7465 6d2e 6e6f 726d 7061  ilesystem.normpa
+0000d4c0: 7468 2822 7c7c 2e2e 7c2e 7c2e 2e7c 7c22  th("||..|.|..||"
+0000d4d0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0000d4e0: 5f63 6f6e 7365 7276 6573 5f75 705f 6c65  _conserves_up_le
+0000d4f0: 7665 6c5f 7265 6665 7265 6e63 6573 5f73  vel_references_s
+0000d500: 7461 7274 696e 675f 6672 6f6d 5f63 7572  tarting_from_cur
+0000d510: 7265 6e74 5f64 6972 2873 656c 6629 3a0a  rent_dir(self):.
+0000d520: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000d530: 6572 7445 7175 616c 2822 2e2e 7c2e 2e22  ertEqual("..|.."
+0000d540: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+0000d550: 6d2e 6e6f 726d 7061 7468 2822 2e2e 7c66  m.normpath("..|f
+0000d560: 6f6f 7c62 6172 7c2e 2e7c 2e2e 7c2e 2e22  oo|bar|..|..|.."
+0000d570: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0000d580: 5f63 6f6d 6269 6e65 5f64 6f74 5f61 6e64  _combine_dot_and
+0000d590: 5f75 705f 6c65 7665 6c5f 7265 6665 7265  _up_level_refere
+0000d5a0: 6e63 6573 5f69 6e5f 6162 736f 6c75 7465  nces_in_absolute
+0000d5b0: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
+0000d5c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000d5d0: 4571 7561 6c28 227c 7965 7322 2c20 7365  Equal("|yes", se
+0000d5e0: 6c66 2e66 696c 6573 7973 7465 6d2e 6e6f  lf.filesystem.no
+0000d5f0: 726d 7061 7468 2822 7c7c 7c7c 7c2e 7c2e  rmpath("|||||.|.
+0000d600: 2e7c 7c7c 7965 737c 6e6f 7c2e 2e7c 2e7c  .|||yes|no|..|.|
+0000d610: 7c7c 2229 290a 0a20 2020 2064 6566 2074  ||"))..    def t
+0000d620: 6573 745f 646f 7473 5f69 6e5f 7061 7468  est_dots_in_path
+0000d630: 5f63 6f6c 6c61 7073 6573 5f74 6f5f 6c61  _collapses_to_la
+0000d640: 7374 5f70 6174 6828 7365 6c66 293a 0a20  st_path(self):. 
+0000d650: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000d660: 7274 4571 7561 6c28 2262 6172 222c 2073  rtEqual("bar", s
+0000d670: 656c 662e 6669 6c65 7379 7374 656d 2e6e  elf.filesystem.n
+0000d680: 6f72 6d70 6174 6828 2266 6f6f 7c2e 2e7c  ormpath("foo|..|
+0000d690: 6261 7222 2929 0a20 2020 2020 2020 2073  bar")).        s
+0000d6a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000d6b0: 2262 6172 222c 2073 656c 662e 6669 6c65  "bar", self.file
+0000d6c0: 7379 7374 656d 2e6e 6f72 6d70 6174 6828  system.normpath(
+0000d6d0: 2266 6f6f 7c2e 2e7c 7965 737c 2e2e 7c6e  "foo|..|yes|..|n
+0000d6e0: 6f7c 2e2e 7c62 6172 2229 290a 0a0a 636c  o|..|bar"))...cl
+0000d6f0: 6173 7320 5370 6c69 7450 6174 6854 6573  ass SplitPathTes
+0000d700: 7428 5061 7468 4d61 6e69 7075 6c61 7469  t(PathManipulati
+0000d710: 6f6e 5465 7374 4261 7365 293a 0a20 2020  onTestBase):.   
+0000d720: 2022 2222 5465 7374 7320 5370 6c69 7450   """Tests SplitP
+0000d730: 6174 6820 2877 6869 6368 206d 696d 6963  ath (which mimic
+0000d740: 7320 6f73 2e70 6174 682e 7370 6c69 7429  s os.path.split)
+0000d750: 0a20 2020 2075 7369 6e67 207c 2061 7320  .    using | as 
+0000d760: 7061 7468 2073 6570 6172 6174 6f72 2e22  path separator."
+0000d770: 2222 0a0a 2020 2020 6465 6620 7465 7374  ""..    def test
+0000d780: 5f65 6d70 7479 5f70 6174 6828 7365 6c66  _empty_path(self
+0000d790: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000d7a0: 6173 7365 7274 4571 7561 6c28 2822 222c  assertEqual(("",
+0000d7b0: 2022 2229 2c20 7365 6c66 2e66 696c 6573   ""), self.files
+0000d7c0: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
+0000d7d0: 2222 2929 0a0a 2020 2020 6465 6620 7465  ""))..    def te
+0000d7e0: 7374 5f6e 6f5f 7365 7061 7261 746f 7273  st_no_separators
+0000d7f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000d800: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000d810: 2828 2222 2c20 2261 6222 292c 2073 656c  (("", "ab"), sel
+0000d820: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+0000d830: 6974 7061 7468 2822 6162 2229 290a 0a20  itpath("ab")).. 
+0000d840: 2020 2064 6566 2074 6573 745f 736c 6173     def test_slas
+0000d850: 6865 735f 646f 5f6e 6f74 5f73 706c 6974  hes_do_not_split
+0000d860: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000d870: 2222 2254 6573 7473 2074 6861 7420 272f  """Tests that '/
+0000d880: 2720 6973 206e 6f74 2074 7265 6174 6564  ' is not treated
+0000d890: 2073 7065 6369 616c 6c79 2069 6620 7468   specially if th
+0000d8a0: 650a 2020 2020 2020 2020 7061 7468 2073  e.        path s
+0000d8b0: 6570 6172 6174 6f72 2069 7320 277c 272e  eparator is '|'.
+0000d8c0: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
+0000d8d0: 2e61 7373 6572 7445 7175 616c 2828 2222  .assertEqual((""
+0000d8e0: 2c20 2261 2f62 2229 2c20 7365 6c66 2e66  , "a/b"), self.f
+0000d8f0: 696c 6573 7973 7465 6d2e 7370 6c69 7470  ilesystem.splitp
+0000d900: 6174 6828 2261 2f62 2229 290a 0a20 2020  ath("a/b"))..   
+0000d910: 2064 6566 2074 6573 745f 656c 696d 696e   def test_elimin
+0000d920: 6174 655f 7472 6169 6c69 6e67 5f73 6570  ate_trailing_sep
+0000d930: 6172 6174 6f72 735f 6672 6f6d 5f68 6561  arators_from_hea
+0000d940: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+0000d950: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000d960: 6c28 2822 6122 2c20 2262 2229 2c20 7365  l(("a", "b"), se
+0000d970: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+0000d980: 6c69 7470 6174 6828 2261 7c62 2229 290a  litpath("a|b")).
+0000d990: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000d9a0: 6572 7445 7175 616c 2828 2261 222c 2022  ertEqual(("a", "
+0000d9b0: 6222 292c 2073 656c 662e 6669 6c65 7379  b"), self.filesy
+0000d9c0: 7374 656d 2e73 706c 6974 7061 7468 2822  stem.splitpath("
+0000d9d0: 617c 7c7c 6222 2929 0a20 2020 2020 2020  a|||b")).       
+0000d9e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000d9f0: 6c28 2822 7c61 222c 2022 6222 292c 2073  l(("|a", "b"), s
+0000da00: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
+0000da10: 706c 6974 7061 7468 2822 7c61 7c7c 6222  plitpath("|a||b"
+0000da20: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000da30: 6173 7365 7274 4571 7561 6c28 2822 617c  assertEqual(("a|
+0000da40: 6222 2c20 2263 2229 2c20 7365 6c66 2e66  b", "c"), self.f
+0000da50: 696c 6573 7973 7465 6d2e 7370 6c69 7470  ilesystem.splitp
+0000da60: 6174 6828 2261 7c62 7c63 2229 290a 2020  ath("a|b|c")).  
+0000da70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000da80: 7445 7175 616c 2828 227c 617c 6222 2c20  tEqual(("|a|b", 
+0000da90: 2263 2229 2c20 7365 6c66 2e66 696c 6573  "c"), self.files
+0000daa0: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
+0000dab0: 227c 617c 627c 6322 2929 0a0a 2020 2020  "|a|b|c"))..    
+0000dac0: 6465 6620 7465 7374 5f72 6f6f 745f 7365  def test_root_se
+0000dad0: 7061 7261 746f 725f 6973 5f6e 6f74 5f73  parator_is_not_s
+0000dae0: 7472 6970 7065 6428 7365 6c66 293a 0a20  tripped(self):. 
+0000daf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000db00: 7274 4571 7561 6c28 2822 7c7c 7c22 2c20  rtEqual(("|||", 
+0000db10: 2222 292c 2073 656c 662e 6669 6c65 7379  ""), self.filesy
+0000db20: 7374 656d 2e73 706c 6974 7061 7468 2822  stem.splitpath("
+0000db30: 7c7c 7c22 2929 0a20 2020 2020 2020 2073  |||")).        s
+0000db40: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000db50: 2822 7c22 2c20 2261 2229 2c20 7365 6c66  ("|", "a"), self
+0000db60: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+0000db70: 7470 6174 6828 227c 6122 2929 0a20 2020  tpath("|a")).   
+0000db80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000db90: 4571 7561 6c28 2822 7c7c 7c22 2c20 2261  Equal(("|||", "a
+0000dba0: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+0000dbb0: 7465 6d2e 7370 6c69 7470 6174 6828 227c  tem.splitpath("|
+0000dbc0: 7c7c 6122 2929 0a0a 2020 2020 6465 6620  ||a"))..    def 
+0000dbd0: 7465 7374 5f65 6d70 7479 5f74 6169 6c5f  test_empty_tail_
+0000dbe0: 6966 5f70 6174 685f 656e 6473 5f69 6e5f  if_path_ends_in_
+0000dbf0: 7365 7061 7261 746f 7228 7365 6c66 293a  separator(self):
+0000dc00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000dc10: 7365 7274 4571 7561 6c28 2822 617c 6222  sertEqual(("a|b"
+0000dc20: 2c20 2222 292c 2073 656c 662e 6669 6c65  , ""), self.file
+0000dc30: 7379 7374 656d 2e73 706c 6974 7061 7468  system.splitpath
+0000dc40: 2822 617c 627c 2229 290a 0a20 2020 2064  ("a|b|"))..    d
+0000dc50: 6566 2074 6573 745f 656d 7074 795f 7061  ef test_empty_pa
+0000dc60: 7468 5f63 6f6d 706f 6e65 6e74 735f 6172  th_components_ar
+0000dc70: 655f 7072 6573 6572 7665 645f 696e 5f68  e_preserved_in_h
+0000dc80: 6561 6428 7365 6c66 293a 0a20 2020 2020  ead(self):.     
+0000dc90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000dca0: 7561 6c28 2822 7c61 7c7c 6222 2c20 2263  ual(("|a||b", "c
+0000dcb0: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+0000dcc0: 7465 6d2e 7370 6c69 7470 6174 6828 227c  tem.splitpath("|
+0000dcd0: 617c 7c62 7c7c 6322 2929 0a0a 0a63 6c61  a||b||c"))...cla
+0000dce0: 7373 204a 6f69 6e50 6174 6854 6573 7428  ss JoinPathTest(
+0000dcf0: 5061 7468 4d61 6e69 7075 6c61 7469 6f6e  PathManipulation
+0000dd00: 5465 7374 4261 7365 293a 0a20 2020 2022  TestBase):.    "
+0000dd10: 2222 5465 7374 7320 4a6f 696e 5061 7468  ""Tests JoinPath
+0000dd20: 2028 7768 6963 6820 6d69 6d69 6373 206f   (which mimics o
+0000dd30: 732e 7061 7468 2e6a 6f69 6e29 2075 7369  s.path.join) usi
+0000dd40: 6e67 207c 2061 7320 7061 7468 2073 6570  ng | as path sep
+0000dd50: 6172 6174 6f72 2e22 2222 0a0a 2020 2020  arator."""..    
+0000dd60: 6465 6620 7465 7374 5f6f 6e65 5f65 6d70  def test_one_emp
+0000dd70: 7479 5f63 6f6d 706f 6e65 6e74 2873 656c  ty_component(sel
+0000dd80: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000dd90: 2e61 7373 6572 7445 7175 616c 2822 222c  .assertEqual("",
+0000dda0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000ddb0: 2e6a 6f69 6e70 6174 6873 2822 2229 290a  .joinpaths("")).
+0000ddc0: 0a20 2020 2064 6566 2074 6573 745f 6d75  .    def test_mu
+0000ddd0: 6c74 6970 6c65 5f65 6d70 7479 5f63 6f6d  ltiple_empty_com
+0000dde0: 706f 6e65 6e74 7328 7365 6c66 293a 0a20  ponents(self):. 
+0000ddf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000de00: 7274 4571 7561 6c28 2222 2c20 7365 6c66  rtEqual("", self
+0000de10: 2e66 696c 6573 7973 7465 6d2e 6a6f 696e  .filesystem.join
+0000de20: 7061 7468 7328 2222 2c20 2222 2c20 2222  paths("", "", ""
+0000de30: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+0000de40: 5f73 6570 6172 6174 6f72 735f 6e6f 745f  _separators_not_
+0000de50: 7374 7269 7070 6564 5f66 726f 6d5f 7369  stripped_from_si
+0000de60: 6e67 6c65 5f63 6f6d 706f 6e65 6e74 2873  ngle_component(s
+0000de70: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0000de80: 6c66 2e61 7373 6572 7445 7175 616c 2822  lf.assertEqual("
+0000de90: 7c7c 617c 7c22 2c20 7365 6c66 2e66 696c  ||a||", self.fil
+0000dea0: 6573 7973 7465 6d2e 6a6f 696e 7061 7468  esystem.joinpath
+0000deb0: 7328 227c 7c61 7c7c 2229 290a 0a20 2020  s("||a||"))..   
+0000dec0: 2064 6566 2074 6573 745f 6f6e 655f 7365   def test_one_se
+0000ded0: 7061 7261 746f 725f 6164 6465 645f 6265  parator_added_be
+0000dee0: 7477 6565 6e5f 636f 6d70 6f6e 656e 7473  tween_components
+0000def0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000df00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000df10: 2822 617c 627c 637c 6422 2c20 7365 6c66  ("a|b|c|d", self
+0000df20: 2e66 696c 6573 7973 7465 6d2e 6a6f 696e  .filesystem.join
+0000df30: 7061 7468 7328 2261 222c 2022 6222 2c20  paths("a", "b", 
+0000df40: 2263 222c 2022 6422 2929 0a0a 2020 2020  "c", "d"))..    
+0000df50: 6465 6620 7465 7374 5f6e 6f5f 7365 7061  def test_no_sepa
+0000df60: 7261 746f 725f 6164 6465 645f 666f 725f  rator_added_for_
+0000df70: 636f 6d70 6f6e 656e 7473 5f65 6e64 696e  components_endin
+0000df80: 675f 696e 5f73 6570 6172 6174 6f72 2873  g_in_separator(s
+0000df90: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0000dfa0: 6c66 2e61 7373 6572 7445 7175 616c 2822  lf.assertEqual("
+0000dfb0: 617c 627c 6322 2c20 7365 6c66 2e66 696c  a|b|c", self.fil
+0000dfc0: 6573 7973 7465 6d2e 6a6f 696e 7061 7468  esystem.joinpath
+0000dfd0: 7328 2261 7c22 2c20 2262 7c22 2c20 2263  s("a|", "b|", "c
+0000dfe0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0000dff0: 2e61 7373 6572 7445 7175 616c 2822 617c  .assertEqual("a|
+0000e000: 7c7c 627c 7c7c 6322 2c20 7365 6c66 2e66  ||b|||c", self.f
+0000e010: 696c 6573 7973 7465 6d2e 6a6f 696e 7061  ilesystem.joinpa
+0000e020: 7468 7328 2261 7c7c 7c22 2c20 2262 7c7c  ths("a|||", "b||
+0000e030: 7c22 2c20 2263 2229 290a 0a20 2020 2064  |", "c"))..    d
+0000e040: 6566 2074 6573 745f 636f 6d70 6f6e 656e  ef test_componen
+0000e050: 7473 5f70 7265 6365 6469 6e67 5f61 6273  ts_preceding_abs
+0000e060: 6f6c 7574 655f 636f 6d70 6f6e 656e 745f  olute_component_
+0000e070: 6172 655f 6967 6e6f 7265 6428 7365 6c66  are_ignored(self
+0000e080: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000e090: 6173 7365 7274 4571 7561 6c28 227c 637c  assertEqual("|c|
+0000e0a0: 6422 2c20 7365 6c66 2e66 696c 6573 7973  d", self.filesys
+0000e0b0: 7465 6d2e 6a6f 696e 7061 7468 7328 2261  tem.joinpaths("a
+0000e0c0: 222c 2022 7c62 222c 2022 7c63 222c 2022  ", "|b", "|c", "
+0000e0d0: 6422 2929 0a0a 2020 2020 6465 6620 7465  d"))..    def te
+0000e0e0: 7374 5f6f 6e65 5f73 6570 6172 6174 6f72  st_one_separator
+0000e0f0: 5f61 6464 6564 5f66 6f72 5f74 7261 696c  _added_for_trail
+0000e100: 696e 675f 656d 7074 795f 636f 6d70 6f6e  ing_empty_compon
+0000e110: 656e 7473 2873 656c 6629 3a0a 2020 2020  ents(self):.    
+0000e120: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000e130: 7175 616c 2822 617c 222c 2073 656c 662e  qual("a|", self.
+0000e140: 6669 6c65 7379 7374 656d 2e6a 6f69 6e70  filesystem.joinp
+0000e150: 6174 6873 2822 6122 2c20 2222 2929 0a20  aths("a", "")). 
+0000e160: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000e170: 7274 4571 7561 6c28 2261 7c22 2c20 7365  rtEqual("a|", se
+0000e180: 6c66 2e66 696c 6573 7973 7465 6d2e 6a6f  lf.filesystem.jo
+0000e190: 696e 7061 7468 7328 2261 222c 2022 222c  inpaths("a", "",
+0000e1a0: 2022 2229 290a 0a20 2020 2064 6566 2074   ""))..    def t
+0000e1b0: 6573 745f 6e6f 5f73 6570 6172 6174 6f72  est_no_separator
+0000e1c0: 5f61 6464 6564 5f66 6f72 5f6c 6561 6469  _added_for_leadi
+0000e1d0: 6e67 5f65 6d70 7479 5f63 6f6d 706f 6e65  ng_empty_compone
+0000e1e0: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
+0000e1f0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e200: 7561 6c28 2261 222c 2073 656c 662e 6669  ual("a", self.fi
+0000e210: 6c65 7379 7374 656d 2e6a 6f69 6e70 6174  lesystem.joinpat
+0000e220: 6873 2822 222c 2022 6122 2929 0a0a 2020  hs("", "a"))..  
+0000e230: 2020 6465 6620 7465 7374 5f69 6e74 6572    def test_inter
+0000e240: 6e61 6c5f 656d 7074 795f 636f 6d70 6f6e  nal_empty_compon
+0000e250: 656e 7473 5f69 676e 6f72 6564 2873 656c  ents_ignored(sel
+0000e260: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000e270: 2e61 7373 6572 7445 7175 616c 2822 617c  .assertEqual("a|
+0000e280: 6222 2c20 7365 6c66 2e66 696c 6573 7973  b", self.filesys
+0000e290: 7465 6d2e 6a6f 696e 7061 7468 7328 2261  tem.joinpaths("a
+0000e2a0: 222c 2022 222c 2022 6222 2929 0a20 2020  ", "", "b")).   
+0000e2b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000e2c0: 4571 7561 6c28 2261 7c62 7c22 2c20 7365  Equal("a|b|", se
+0000e2d0: 6c66 2e66 696c 6573 7973 7465 6d2e 6a6f  lf.filesystem.jo
+0000e2e0: 696e 7061 7468 7328 2261 7c22 2c20 2222  inpaths("a|", ""
+0000e2f0: 2c20 2262 7c22 2929 0a0a 0a63 6c61 7373  , "b|"))...class
+0000e300: 2050 6174 6853 6570 6172 6174 6f72 5465   PathSeparatorTe
+0000e310: 7374 2854 6573 7443 6173 6529 3a0a 2020  st(TestCase):.  
+0000e320: 2020 6465 6620 7465 7374 5f6f 735f 7061    def test_os_pa
+0000e330: 7468 5f73 6570 5f6d 6174 6368 6573 5f66  th_sep_matches_f
+0000e340: 616b 655f 6669 6c65 7379 7374 656d 5f73  ake_filesystem_s
+0000e350: 6570 6172 6174 6f72 2873 656c 6629 3a0a  eparator(self):.
+0000e360: 2020 2020 2020 2020 6669 6c65 7379 7374          filesyst
+0000e370: 656d 203d 2066 616b 655f 6669 6c65 7379  em = fake_filesy
+0000e380: 7374 656d 2e46 616b 6546 696c 6573 7973  stem.FakeFilesys
+0000e390: 7465 6d28 7061 7468 5f73 6570 6172 6174  tem(path_separat
+0000e3a0: 6f72 3d22 2122 290a 2020 2020 2020 2020  or="!").        
+0000e3b0: 6661 6b65 5f6f 735f 6d6f 6475 6c65 203d  fake_os_module =
+0000e3c0: 2066 616b 655f 6f73 2e46 616b 654f 734d   fake_os.FakeOsM
+0000e3d0: 6f64 756c 6528 6669 6c65 7379 7374 656d  odule(filesystem
+0000e3e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000e3f0: 7373 6572 7445 7175 616c 2822 2122 2c20  ssertEqual("!", 
+0000e400: 6661 6b65 5f6f 735f 6d6f 6475 6c65 2e73  fake_os_module.s
+0000e410: 6570 290a 2020 2020 2020 2020 7365 6c66  ep).        self
+0000e420: 2e61 7373 6572 7445 7175 616c 2822 2122  .assertEqual("!"
+0000e430: 2c20 6661 6b65 5f6f 735f 6d6f 6475 6c65  , fake_os_module
+0000e440: 2e70 6174 682e 7365 7029 0a0a 0a63 6c61  .path.sep)...cla
+0000e450: 7373 204e 6f72 6d61 6c69 7a65 4361 7365  ss NormalizeCase
+0000e460: 5465 7374 2854 6573 7443 6173 6529 3a0a  Test(TestCase):.
+0000e470: 2020 2020 6465 6620 7365 7455 7028 7365      def setUp(se
+0000e480: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0000e490: 662e 6669 6c65 7379 7374 656d 203d 2066  f.filesystem = f
+0000e4a0: 616b 655f 6669 6c65 7379 7374 656d 2e46  ake_filesystem.F
+0000e4b0: 616b 6546 696c 6573 7973 7465 6d28 7061  akeFilesystem(pa
+0000e4c0: 7468 5f73 6570 6172 6174 6f72 3d22 2f22  th_separator="/"
+0000e4d0: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+0000e4e0: 696c 6573 7973 7465 6d2e 6973 5f63 6173  ilesystem.is_cas
+0000e4f0: 655f 7365 6e73 6974 6976 6520 3d20 4661  e_sensitive = Fa
+0000e500: 6c73 650a 0a20 2020 2064 6566 2074 6573  lse..    def tes
+0000e510: 745f 6e6f 726d 616c 697a 655f 6361 7365  t_normalize_case
+0000e520: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000e530: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000e540: 6372 6561 7465 5f66 696c 6528 222f 466f  create_file("/Fo
+0000e550: 6f2f 4261 7222 290a 2020 2020 2020 2020  o/Bar").        
+0000e560: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000e570: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+0000e580: 7b73 656c 662e 6669 6c65 7379 7374 656d  {self.filesystem
+0000e590: 2e72 6f6f 745f 6469 725f 6e61 6d65 7d46  .root_dir_name}F
+0000e5a0: 6f6f 2f42 6172 222c 0a20 2020 2020 2020  oo/Bar",.       
+0000e5b0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+0000e5c0: 7374 656d 2e5f 6f72 6967 696e 616c 5f70  stem._original_p
+0000e5d0: 6174 6828 222f 666f 6f2f 6261 7222 292c  ath("/foo/bar"),
+0000e5e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000e5f0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e600: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+0000e610: 2066 227b 7365 6c66 2e66 696c 6573 7973   f"{self.filesys
+0000e620: 7465 6d2e 726f 6f74 5f64 6972 5f6e 616d  tem.root_dir_nam
+0000e630: 657d 466f 6f2f 4261 7222 2c0a 2020 2020  e}Foo/Bar",.    
+0000e640: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+0000e650: 6573 7973 7465 6d2e 5f6f 7269 6769 6e61  esystem._origina
+0000e660: 6c5f 7061 7468 2822 2f46 4f4f 2f42 4152  l_path("/FOO/BAR
+0000e670: 2229 2c0a 2020 2020 2020 2020 290a 0a20  "),.        ).. 
+0000e680: 2020 2064 6566 2074 6573 745f 6e6f 726d     def test_norm
+0000e690: 616c 697a 655f 6361 7365 5f66 6f72 5f64  alize_case_for_d
+0000e6a0: 7269 7665 2873 656c 6629 3a0a 2020 2020  rive(self):.    
+0000e6b0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+0000e6c0: 7465 6d2e 6973 5f77 696e 646f 7773 5f66  tem.is_windows_f
+0000e6d0: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
+0000e6e0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000e6f0: 2e63 7265 6174 655f 6669 6c65 2822 433a  .create_file("C:
+0000e700: 2f46 6f6f 2f42 6172 2229 0a20 2020 2020  /Foo/Bar").     
+0000e710: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e720: 7561 6c28 2243 3a2f 466f 6f2f 4261 7222  ual("C:/Foo/Bar"
+0000e730: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+0000e740: 6d2e 5f6f 7269 6769 6e61 6c5f 7061 7468  m._original_path
+0000e750: 2822 633a 2f66 6f6f 2f62 6172 2229 290a  ("c:/foo/bar")).
+0000e760: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000e770: 6572 7445 7175 616c 2822 433a 2f46 6f6f  ertEqual("C:/Foo
+0000e780: 2f42 6172 222c 2073 656c 662e 6669 6c65  /Bar", self.file
+0000e790: 7379 7374 656d 2e5f 6f72 6967 696e 616c  system._original
+0000e7a0: 5f70 6174 6828 2243 3a2f 464f 4f2f 4241  _path("C:/FOO/BA
+0000e7b0: 5222 2929 0a0a 2020 2020 6465 6620 7465  R"))..    def te
+0000e7c0: 7374 5f6e 6f72 6d61 6c69 7a65 5f63 6173  st_normalize_cas
+0000e7d0: 655f 666f 725f 6e6f 6e5f 6578 6973 7469  e_for_non_existi
+0000e7e0: 6e67 5f66 696c 6528 7365 6c66 293a 0a20  ng_file(self):. 
+0000e7f0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+0000e800: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
+0000e810: 7228 222f 466f 6f2f 4261 7222 290a 2020  r("/Foo/Bar").  
+0000e820: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000e830: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+0000e840: 2020 2020 6622 7b73 656c 662e 6669 6c65      f"{self.file
+0000e850: 7379 7374 656d 2e72 6f6f 745f 6469 725f  system.root_dir_
+0000e860: 6e61 6d65 7d46 6f6f 2f42 6172 2f62 617a  name}Foo/Bar/baz
+0000e870: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+0000e880: 656c 662e 6669 6c65 7379 7374 656d 2e5f  elf.filesystem._
+0000e890: 6f72 6967 696e 616c 5f70 6174 6828 222f  original_path("/
+0000e8a0: 666f 6f2f 6261 722f 6261 7a22 292c 0a20  foo/bar/baz"),. 
+0000e8b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000e8c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000e8d0: 6c28 0a20 2020 2020 2020 2020 2020 2066  l(.            f
+0000e8e0: 227b 7365 6c66 2e66 696c 6573 7973 7465  "{self.filesyste
+0000e8f0: 6d2e 726f 6f74 5f64 6972 5f6e 616d 657d  m.root_dir_name}
+0000e900: 466f 6f2f 4261 722f 4241 5a22 2c0a 2020  Foo/Bar/BAZ",.  
+0000e910: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+0000e920: 696c 6573 7973 7465 6d2e 5f6f 7269 6769  ilesystem._origi
+0000e930: 6e61 6c5f 7061 7468 2822 2f46 4f4f 2f42  nal_path("/FOO/B
+0000e940: 4152 2f42 415a 2229 2c0a 2020 2020 2020  AR/BAZ"),.      
+0000e950: 2020 290a 0a20 2020 2040 756e 6974 7465    )..    @unitte
+0000e960: 7374 2e73 6b69 7049 6628 0a20 2020 2020  st.skipIf(.     
+0000e970: 2020 206e 6f74 2054 6573 7443 6173 652e     not TestCase.
+0000e980: 6973 5f77 696e 646f 7773 2c20 2252 6567  is_windows, "Reg
+0000e990: 7265 7373 696f 6e20 7465 7374 2066 6f72  ression test for
+0000e9a0: 2057 696e 646f 7773 2070 726f 626c 656d   Windows problem
+0000e9b0: 206f 6e6c 7922 0a20 2020 2029 0a20 2020   only".    ).   
+0000e9c0: 2064 6566 2074 6573 745f 6e6f 726d 616c   def test_normal
+0000e9d0: 697a 655f 6361 7365 5f66 6f72 5f6c 617a  ize_case_for_laz
+0000e9e0: 696c 795f 6164 6465 645f 656d 7074 795f  ily_added_empty_
+0000e9f0: 6669 6c65 2873 656c 6629 3a0a 2020 2020  file(self):.    
+0000ea00: 2020 2020 2320 7265 6772 6573 7369 6f6e      # regression
+0000ea10: 2074 6573 7420 666f 7220 7370 6563 6966   test for specif
+0000ea20: 6963 2069 7373 7565 2077 6974 6820 6164  ic issue with ad
+0000ea30: 6465 6420 656d 7074 7920 7265 616c 2066  ded empty real f
+0000ea40: 696c 6573 0a20 2020 2020 2020 2066 696c  iles.        fil
+0000ea50: 6573 7973 7465 6d20 3d20 6661 6b65 5f66  esystem = fake_f
+0000ea60: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
+0000ea70: 6c65 7379 7374 656d 2829 0a20 2020 2020  lesystem().     
+0000ea80: 2020 2072 6561 6c5f 6469 725f 7061 7468     real_dir_path
+0000ea90: 203d 206f 732e 7061 7468 2e73 706c 6974   = os.path.split
+0000eaa0: 286f 732e 7061 7468 2e64 6972 6e61 6d65  (os.path.dirname
+0000eab0: 286f 732e 7061 7468 2e61 6273 7061 7468  (os.path.abspath
+0000eac0: 285f 5f66 696c 655f 5f29 2929 5b30 5d0a  (__file__)))[0].
+0000ead0: 2020 2020 2020 2020 6669 6c65 7379 7374          filesyst
+0000eae0: 656d 2e61 6464 5f72 6561 6c5f 6469 7265  em.add_real_dire
+0000eaf0: 6374 6f72 7928 7265 616c 5f64 6972 5f70  ctory(real_dir_p
+0000eb00: 6174 6829 0a20 2020 2020 2020 2069 6e69  ath).        ini
+0000eb10: 7450 7950 6174 6820 3d20 6f73 2e70 6174  tPyPath = os.pat
+0000eb20: 682e 6a6f 696e 2872 6561 6c5f 6469 725f  h.join(real_dir_
+0000eb30: 7061 7468 2c20 225f 5f69 6e69 745f 5f2e  path, "__init__.
+0000eb40: 7079 2229 0a20 2020 2020 2020 2073 656c  py").        sel
+0000eb50: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
+0000eb60: 6974 5079 5061 7468 2c20 6669 6c65 7379  itPyPath, filesy
+0000eb70: 7374 656d 2e5f 6f72 6967 696e 616c 5f70  stem._original_p
+0000eb80: 6174 6828 696e 6974 5079 5061 7468 2e75  ath(initPyPath.u
+0000eb90: 7070 6572 2829 2929 0a0a 0a63 6c61 7373  pper()))...class
+0000eba0: 2041 6c74 6572 6e61 7469 7665 5061 7468   AlternativePath
+0000ebb0: 5365 7061 7261 746f 7254 6573 7428 5465  SeparatorTest(Te
+0000ebc0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+0000ebd0: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0000ebe0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+0000ebf0: 7973 7465 6d20 3d20 6661 6b65 5f66 696c  ystem = fake_fil
+0000ec00: 6573 7973 7465 6d2e 4661 6b65 4669 6c65  esystem.FakeFile
+0000ec10: 7379 7374 656d 2870 6174 685f 7365 7061  system(path_sepa
+0000ec20: 7261 746f 723d 2221 2229 0a20 2020 2020  rator="!").     
+0000ec30: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0000ec40: 656d 2e61 6c74 6572 6e61 7469 7665 5f70  em.alternative_p
+0000ec50: 6174 685f 7365 7061 7261 746f 7220 3d20  ath_separator = 
+0000ec60: 223f 220a 0a20 2020 2064 6566 2074 6573  "?"..    def tes
+0000ec70: 745f 696e 6974 6961 6c5f 7661 6c75 6528  t_initial_value(
+0000ec80: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0000ec90: 696c 6573 7973 7465 6d20 3d20 6661 6b65  ilesystem = fake
+0000eca0: 5f66 696c 6573 7973 7465 6d2e 4661 6b65  _filesystem.Fake
+0000ecb0: 4669 6c65 7379 7374 656d 2829 0a20 2020  Filesystem().   
+0000ecc0: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
+0000ecd0: 7769 6e64 6f77 733a 0a20 2020 2020 2020  windows:.       
+0000ece0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000ecf0: 4571 7561 6c28 222f 222c 2066 696c 6573  Equal("/", files
+0000ed00: 7973 7465 6d2e 616c 7465 726e 6174 6976  ystem.alternativ
+0000ed10: 655f 7061 7468 5f73 6570 6172 6174 6f72  e_path_separator
+0000ed20: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000ed30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000ed40: 2e61 7373 6572 7449 734e 6f6e 6528 6669  .assertIsNone(fi
+0000ed50: 6c65 7379 7374 656d 2e61 6c74 6572 6e61  lesystem.alterna
+0000ed60: 7469 7665 5f70 6174 685f 7365 7061 7261  tive_path_separa
+0000ed70: 746f 7229 0a0a 2020 2020 2020 2020 6669  tor)..        fi
+0000ed80: 6c65 7379 7374 656d 203d 2066 616b 655f  lesystem = fake_
+0000ed90: 6669 6c65 7379 7374 656d 2e46 616b 6546  filesystem.FakeF
+0000eda0: 696c 6573 7973 7465 6d28 7061 7468 5f73  ilesystem(path_s
+0000edb0: 6570 6172 6174 6f72 3d22 2f22 290a 2020  eparator="/").  
+0000edc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000edd0: 7449 734e 6f6e 6528 6669 6c65 7379 7374  tIsNone(filesyst
+0000ede0: 656d 2e61 6c74 6572 6e61 7469 7665 5f70  em.alternative_p
+0000edf0: 6174 685f 7365 7061 7261 746f 7229 0a0a  ath_separator)..
+0000ee00: 2020 2020 6465 6620 7465 7374 5f61 6c74      def test_alt
+0000ee10: 5f73 6570 2873 656c 6629 3a0a 2020 2020  _sep(self):.    
+0000ee20: 2020 2020 6661 6b65 5f6f 735f 6d6f 6475      fake_os_modu
+0000ee30: 6c65 203d 2066 616b 655f 6f73 2e46 616b  le = fake_os.Fak
+0000ee40: 654f 734d 6f64 756c 6528 7365 6c66 2e66  eOsModule(self.f
+0000ee50: 696c 6573 7973 7465 6d29 0a20 2020 2020  ilesystem).     
+0000ee60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ee70: 7561 6c28 223f 222c 2066 616b 655f 6f73  ual("?", fake_os
+0000ee80: 5f6d 6f64 756c 652e 616c 7473 6570 290a  _module.altsep).
+0000ee90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000eea0: 6572 7445 7175 616c 2822 3f22 2c20 6661  ertEqual("?", fa
+0000eeb0: 6b65 5f6f 735f 6d6f 6475 6c65 2e70 6174  ke_os_module.pat
+0000eec0: 682e 616c 7473 6570 290a 0a20 2020 2064  h.altsep)..    d
+0000eed0: 6566 2074 6573 745f 636f 6c6c 6170 7365  ef test_collapse
+0000eee0: 5f70 6174 685f 7769 7468 5f6d 6978 6564  _path_with_mixed
+0000eef0: 5f73 6570 6172 6174 6f72 7328 7365 6c66  _separators(self
+0000ef00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000ef10: 6173 7365 7274 4571 7561 6c28 2221 666f  assertEqual("!fo
+0000ef20: 6f21 6261 7222 2c20 7365 6c66 2e66 696c  o!bar", self.fil
+0000ef30: 6573 7973 7465 6d2e 6e6f 726d 7061 7468  esystem.normpath
+0000ef40: 2822 2166 6f6f 3f3f 6261 7222 2929 0a0a  ("!foo??bar"))..
+0000ef50: 2020 2020 6465 6620 7465 7374 5f6e 6f72      def test_nor
+0000ef60: 6d61 6c69 7a65 5f70 6174 685f 7769 7468  malize_path_with
+0000ef70: 5f6d 6978 6564 5f73 6570 6172 6174 6f72  _mixed_separator
+0000ef80: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000ef90: 2070 6174 6820 3d20 2266 6f6f 3f2e 2e3f   path = "foo?..?
+0000efa0: 6261 7222 0a20 2020 2020 2020 2073 656c  bar".        sel
+0000efb0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+0000efc0: 2020 2020 2020 2020 2020 2066 227b 7365             f"{se
+0000efd0: 6c66 2e66 696c 6573 7973 7465 6d2e 726f  lf.filesystem.ro
+0000efe0: 6f74 5f64 6972 5f6e 616d 657d 6261 7222  ot_dir_name}bar"
+0000eff0: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000f000: 6c66 2e66 696c 6573 7973 7465 6d2e 6162  lf.filesystem.ab
+0000f010: 736e 6f72 6d70 6174 6828 7061 7468 292c  snormpath(path),
+0000f020: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000f030: 6465 6620 7465 7374 5f65 7869 7374 735f  def test_exists_
+0000f040: 7769 7468 5f6d 6978 6564 5f73 6570 6172  with_mixed_separ
+0000f050: 6174 6f72 7328 7365 6c66 293a 0a20 2020  ators(self):.   
+0000f060: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+0000f070: 7374 656d 2e63 7265 6174 655f 6669 6c65  stem.create_file
+0000f080: 2822 3f66 6f6f 3f62 6172 3f62 617a 2229  ("?foo?bar?baz")
+0000f090: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+0000f0a0: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+0000f0b0: 6669 6c65 2822 2166 6f6f 2162 6172 2178  file("!foo!bar!x
+0000f0c0: 797a 7a79 2170 6c75 6768 2229 0a20 2020  yzzy!plugh").   
+0000f0d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000f0e0: 5472 7565 2873 656c 662e 6669 6c65 7379  True(self.filesy
+0000f0f0: 7374 656d 2e65 7869 7374 7328 2221 666f  stem.exists("!fo
+0000f100: 6f21 6261 7221 6261 7a22 2929 0a20 2020  o!bar!baz")).   
+0000f110: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000f120: 5472 7565 2873 656c 662e 6669 6c65 7379  True(self.filesy
+0000f130: 7374 656d 2e65 7869 7374 7328 223f 666f  stem.exists("?fo
+0000f140: 6f3f 6261 723f 7879 7a7a 793f 706c 7567  o?bar?xyzzy?plug
+0000f150: 6822 2929 0a0a 0a63 6c61 7373 2044 7269  h"))...class Dri
+0000f160: 7665 4c65 7474 6572 5375 7070 6f72 7454  veLetterSupportT
+0000f170: 6573 7428 5465 7374 4361 7365 293a 0a20  est(TestCase):. 
+0000f180: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
+0000f190: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000f1a0: 2e66 696c 6573 7973 7465 6d20 3d20 6661  .filesystem = fa
+0000f1b0: 6b65 5f66 696c 6573 7973 7465 6d2e 4661  ke_filesystem.Fa
+0000f1c0: 6b65 4669 6c65 7379 7374 656d 2870 6174  keFilesystem(pat
+0000f1d0: 685f 7365 7061 7261 746f 723d 2221 2229  h_separator="!")
+0000f1e0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+0000f1f0: 6c65 7379 7374 656d 2e61 6c74 6572 6e61  lesystem.alterna
+0000f200: 7469 7665 5f70 6174 685f 7365 7061 7261  tive_path_separa
+0000f210: 746f 7220 3d20 225e 220a 2020 2020 2020  tor = "^".      
+0000f220: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0000f230: 6d2e 6973 5f77 696e 646f 7773 5f66 7320  m.is_windows_fs 
+0000f240: 3d20 5472 7565 0a0a 2020 2020 6465 6620  = True..    def 
+0000f250: 7465 7374 5f69 6e69 7469 616c 5f76 616c  test_initial_val
+0000f260: 7565 2873 656c 6629 3a0a 2020 2020 2020  ue(self):.      
+0000f270: 2020 6669 6c65 7379 7374 656d 203d 2066    filesystem = f
+0000f280: 616b 655f 6669 6c65 7379 7374 656d 2e46  ake_filesystem.F
+0000f290: 616b 6546 696c 6573 7973 7465 6d28 290a  akeFilesystem().
+0000f2a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000f2b0: 6973 5f77 696e 646f 7773 3a0a 2020 2020  is_windows:.    
+0000f2c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000f2d0: 6572 7454 7275 6528 6669 6c65 7379 7374  ertTrue(filesyst
+0000f2e0: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
+0000f2f0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000f300: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000f310: 2e61 7373 6572 7446 616c 7365 2866 696c  .assertFalse(fil
+0000f320: 6573 7973 7465 6d2e 6973 5f77 696e 646f  esystem.is_windo
+0000f330: 7773 5f66 7329 0a0a 2020 2020 6465 6620  ws_fs)..    def 
+0000f340: 7465 7374 5f63 6f6c 6c61 7073 655f 7061  test_collapse_pa
+0000f350: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
+0000f360: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000f370: 616c 2822 633a 2166 6f6f 2162 6172 222c  al("c:!foo!bar",
+0000f380: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000f390: 2e6e 6f72 6d70 6174 6828 2263 3a21 2166  .normpath("c:!!f
+0000f3a0: 6f6f 2121 6261 7222 2929 0a0a 2020 2020  oo!!bar"))..    
+0000f3b0: 6465 6620 7465 7374 5f63 6f6c 6c61 7073  def test_collaps
+0000f3c0: 655f 756e 635f 7061 7468 2873 656c 6629  e_unc_path(self)
+0000f3d0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+0000f3e0: 7373 6572 7445 7175 616c 2822 2121 666f  ssertEqual("!!fo
+0000f3f0: 6f21 6261 7221 6261 7a22 2c20 7365 6c66  o!bar!baz", self
+0000f400: 2e66 696c 6573 7973 7465 6d2e 6e6f 726d  .filesystem.norm
+0000f410: 7061 7468 2822 2121 666f 6f21 6261 7221  path("!!foo!bar!
+0000f420: 2162 617a 2121 2229 290a 0a20 2020 2064  !baz!!"))..    d
+0000f430: 6566 2074 6573 745f 6e6f 726d 616c 697a  ef test_normaliz
+0000f440: 655f 7061 7468 5f73 7472 2873 656c 6629  e_path_str(self)
+0000f450: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
+0000f460: 696c 6573 7973 7465 6d2e 6377 6420 3d20  ilesystem.cwd = 
+0000f470: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
+0000f480: 6173 7365 7274 4571 7561 6c28 2263 3a21  assertEqual("c:!
+0000f490: 666f 6f21 6261 7222 2c20 7365 6c66 2e66  foo!bar", self.f
+0000f4a0: 696c 6573 7973 7465 6d2e 6162 736e 6f72  ilesystem.absnor
+0000f4b0: 6d70 6174 6828 2263 3a21 666f 6f21 2162  mpath("c:!foo!!b
+0000f4c0: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
+0000f4d0: 6c66 2e66 696c 6573 7973 7465 6d2e 6377  lf.filesystem.cw
+0000f4e0: 6420 3d20 2263 3a21 666f 6f22 0a20 2020  d = "c:!foo".   
+0000f4f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000f500: 4571 7561 6c28 2263 3a21 666f 6f21 6261  Equal("c:!foo!ba
+0000f510: 7222 2c20 7365 6c66 2e66 696c 6573 7973  r", self.filesys
+0000f520: 7465 6d2e 6162 736e 6f72 6d70 6174 6828  tem.absnormpath(
+0000f530: 2262 6172 2229 290a 0a20 2020 2064 6566  "bar"))..    def
+0000f540: 2074 6573 745f 6e6f 726d 616c 697a 655f   test_normalize_
+0000f550: 7061 7468 5f62 7974 6573 2873 656c 6629  path_bytes(self)
+0000f560: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
+0000f570: 696c 6573 7973 7465 6d2e 6377 6420 3d20  ilesystem.cwd = 
+0000f580: 6222 220a 2020 2020 2020 2020 7365 6c66  b"".        self
+0000f590: 2e61 7373 6572 7445 7175 616c 2862 2263  .assertEqual(b"c
+0000f5a0: 3a21 666f 6f21 6261 7222 2c20 7365 6c66  :!foo!bar", self
+0000f5b0: 2e66 696c 6573 7973 7465 6d2e 6162 736e  .filesystem.absn
+0000f5c0: 6f72 6d70 6174 6828 6222 633a 2166 6f6f  ormpath(b"c:!foo
+0000f5d0: 2121 6261 7222 2929 0a20 2020 2020 2020  !!bar")).       
+0000f5e0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000f5f0: 2e63 7764 203d 2062 2263 3a21 666f 6f22  .cwd = b"c:!foo"
+0000f600: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000f610: 7365 7274 4571 7561 6c28 6222 633a 2166  sertEqual(b"c:!f
+0000f620: 6f6f 2162 6172 222c 2073 656c 662e 6669  oo!bar", self.fi
+0000f630: 6c65 7379 7374 656d 2e61 6273 6e6f 726d  lesystem.absnorm
+0000f640: 7061 7468 2862 2262 6172 2229 290a 0a20  path(b"bar")).. 
+0000f650: 2020 2064 6566 2074 6573 745f 7370 6c69     def test_spli
+0000f660: 745f 7061 7468 5f73 7472 2873 656c 6629  t_path_str(self)
+0000f670: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+0000f680: 7373 6572 7445 7175 616c 2828 2263 3a21  ssertEqual(("c:!
+0000f690: 666f 6f22 2c20 2262 6172 2229 2c20 7365  foo", "bar"), se
+0000f6a0: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+0000f6b0: 6c69 7470 6174 6828 2263 3a21 666f 6f21  litpath("c:!foo!
+0000f6c0: 6261 7222 2929 0a20 2020 2020 2020 2073  bar")).        s
+0000f6d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f6e0: 2822 633a 2122 2c20 2266 6f6f 2229 2c20  ("c:!", "foo"), 
+0000f6f0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000f700: 7370 6c69 7470 6174 6828 2263 3a21 666f  splitpath("c:!fo
+0000f710: 6f22 2929 0a20 2020 2020 2020 2073 656c  o")).        sel
+0000f720: 662e 6173 7365 7274 4571 7561 6c28 2822  f.assertEqual(("
+0000f730: 2166 6f6f 222c 2022 6261 7222 292c 2073  !foo", "bar"), s
+0000f740: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
+0000f750: 706c 6974 7061 7468 2822 2166 6f6f 2162  plitpath("!foo!b
+0000f760: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
+0000f770: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
+0000f780: 2221 222c 2022 666f 6f22 292c 2073 656c  "!", "foo"), sel
+0000f790: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+0000f7a0: 6974 7061 7468 2822 2166 6f6f 2229 290a  itpath("!foo")).
+0000f7b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000f7c0: 6572 7445 7175 616c 2828 2263 3a66 6f6f  ertEqual(("c:foo
+0000f7d0: 222c 2022 6261 7222 292c 2073 656c 662e  ", "bar"), self.
+0000f7e0: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
+0000f7f0: 7061 7468 2822 633a 666f 6f21 6261 7222  path("c:foo!bar"
+0000f800: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000f810: 6173 7365 7274 4571 7561 6c28 2822 633a  assertEqual(("c:
+0000f820: 222c 2022 666f 6f22 292c 2073 656c 662e  ", "foo"), self.
+0000f830: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
+0000f840: 7061 7468 2822 633a 666f 6f22 2929 0a20  path("c:foo")). 
+0000f850: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f860: 7274 4571 7561 6c28 2822 666f 6f22 2c20  rtEqual(("foo", 
+0000f870: 2262 6172 2229 2c20 7365 6c66 2e66 696c  "bar"), self.fil
+0000f880: 6573 7973 7465 6d2e 7370 6c69 7470 6174  esystem.splitpat
+0000f890: 6828 2266 6f6f 2162 6172 2229 290a 0a20  h("foo!bar")).. 
+0000f8a0: 2020 2064 6566 2074 6573 745f 7370 6c69     def test_spli
+0000f8b0: 745f 7769 7468 5f61 6c74 5f73 6570 6172  t_with_alt_separ
+0000f8c0: 6174 6f72 2873 656c 6629 3a0a 2020 2020  ator(self):.    
+0000f8d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000f8e0: 7175 616c 2828 2261 5e62 222c 2022 6322  qual(("a^b", "c"
+0000f8f0: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
+0000f900: 656d 2e73 706c 6974 7061 7468 2822 615e  em.splitpath("a^
+0000f910: 625e 6322 2929 0a20 2020 2020 2020 2073  b^c")).        s
+0000f920: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f930: 2822 615e 6221 6322 2c20 2264 2229 2c20  ("a^b!c", "d"), 
+0000f940: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000f950: 7370 6c69 7470 6174 6828 2261 5e62 2163  splitpath("a^b!c
+0000f960: 5e64 2229 290a 2020 2020 2020 2020 7365  ^d")).        se
+0000f970: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
+0000f980: 2261 5e62 2163 222c 2022 6422 292c 2073  "a^b!c", "d"), s
+0000f990: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
+0000f9a0: 706c 6974 7061 7468 2822 615e 6221 6321  plitpath("a^b!c!
+0000f9b0: 6422 2929 0a20 2020 2020 2020 2073 656c  d")).        sel
+0000f9c0: 662e 6173 7365 7274 4571 7561 6c28 2862  f.assertEqual((b
+0000f9d0: 2261 5e62 222c 2062 2263 2229 2c20 7365  "a^b", b"c"), se
+0000f9e0: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+0000f9f0: 6c69 7470 6174 6828 6222 615e 625e 6322  litpath(b"a^b^c"
+0000fa00: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000fa10: 6173 7365 7274 4571 7561 6c28 2862 2261  assertEqual((b"a
+0000fa20: 5e62 2163 222c 2062 2264 2229 2c20 7365  ^b!c", b"d"), se
+0000fa30: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+0000fa40: 6c69 7470 6174 6828 6222 615e 6221 635e  litpath(b"a^b!c^
+0000fa50: 6422 2929 0a20 2020 2020 2020 2073 656c  d")).        sel
+0000fa60: 662e 6173 7365 7274 4571 7561 6c28 2862  f.assertEqual((b
+0000fa70: 2261 5e62 2163 222c 2062 2264 2229 2c20  "a^b!c", b"d"), 
+0000fa80: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000fa90: 7370 6c69 7470 6174 6828 6222 615e 6221  splitpath(b"a^b!
+0000faa0: 6321 6422 2929 0a0a 2020 2020 6465 6620  c!d"))..    def 
+0000fab0: 7465 7374 5f73 706c 6974 5f70 6174 685f  test_split_path_
+0000fac0: 6279 7465 7328 7365 6c66 293a 0a20 2020  bytes(self):.   
+0000fad0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000fae0: 4571 7561 6c28 2862 2263 3a21 666f 6f22  Equal((b"c:!foo"
+0000faf0: 2c20 6222 6261 7222 292c 2073 656c 662e  , b"bar"), self.
+0000fb00: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
+0000fb10: 7061 7468 2862 2263 3a21 666f 6f21 6261  path(b"c:!foo!ba
+0000fb20: 7222 2929 0a20 2020 2020 2020 2073 656c  r")).        sel
+0000fb30: 662e 6173 7365 7274 4571 7561 6c28 2862  f.assertEqual((b
+0000fb40: 2263 3a21 222c 2062 2266 6f6f 2229 2c20  "c:!", b"foo"), 
+0000fb50: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000fb60: 7370 6c69 7470 6174 6828 6222 633a 2166  splitpath(b"c:!f
+0000fb70: 6f6f 2229 290a 2020 2020 2020 2020 7365  oo")).        se
+0000fb80: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
+0000fb90: 6222 2166 6f6f 222c 2062 2262 6172 2229  b"!foo", b"bar")
+0000fba0: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+0000fbb0: 6d2e 7370 6c69 7470 6174 6828 6222 2166  m.splitpath(b"!f
+0000fbc0: 6f6f 2162 6172 2229 290a 2020 2020 2020  oo!bar")).      
+0000fbd0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000fbe0: 616c 2828 6222 2122 2c20 6222 666f 6f22  al((b"!", b"foo"
+0000fbf0: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
+0000fc00: 656d 2e73 706c 6974 7061 7468 2862 2221  em.splitpath(b"!
+0000fc10: 666f 6f22 2929 0a20 2020 2020 2020 2073  foo")).        s
+0000fc20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000fc30: 2862 2263 3a66 6f6f 222c 2062 2262 6172  (b"c:foo", b"bar
+0000fc40: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+0000fc50: 7465 6d2e 7370 6c69 7470 6174 6828 6222  tem.splitpath(b"
+0000fc60: 633a 666f 6f21 6261 7222 2929 0a20 2020  c:foo!bar")).   
+0000fc70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000fc80: 4571 7561 6c28 2862 2263 3a22 2c20 6222  Equal((b"c:", b"
+0000fc90: 666f 6f22 292c 2073 656c 662e 6669 6c65  foo"), self.file
+0000fca0: 7379 7374 656d 2e73 706c 6974 7061 7468  system.splitpath
+0000fcb0: 2862 2263 3a66 6f6f 2229 290a 2020 2020  (b"c:foo")).    
+0000fcc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000fcd0: 7175 616c 2828 6222 666f 6f22 2c20 6222  qual((b"foo", b"
+0000fce0: 6261 7222 292c 2073 656c 662e 6669 6c65  bar"), self.file
+0000fcf0: 7379 7374 656d 2e73 706c 6974 7061 7468  system.splitpath
+0000fd00: 2862 2266 6f6f 2162 6172 2229 290a 0a20  (b"foo!bar")).. 
+0000fd10: 2020 2064 6566 2074 6573 745f 6368 6172     def test_char
+0000fd20: 6163 7465 7273 5f62 6566 6f72 655f 726f  acters_before_ro
+0000fd30: 6f74 5f69 676e 6f72 6564 5f69 6e5f 6a6f  ot_ignored_in_jo
+0000fd40: 696e 5f70 6174 6873 2873 656c 6629 3a0a  in_paths(self):.
+0000fd50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000fd60: 6572 7445 7175 616c 2822 633a 6422 2c20  ertEqual("c:d", 
+0000fd70: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0000fd80: 6a6f 696e 7061 7468 7328 2262 222c 2022  joinpaths("b", "
+0000fd90: 633a 222c 2022 6422 2929 0a0a 2020 2020  c:", "d"))..    
+0000fda0: 6465 6620 7465 7374 5f72 6573 6f6c 7665  def test_resolve
+0000fdb0: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
+0000fdc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000fdd0: 4571 7561 6c28 2243 3a21 666f 6f21 6261  Equal("C:!foo!ba
+0000fde0: 7222 2c20 7365 6c66 2e66 696c 6573 7973  r", self.filesys
+0000fdf0: 7465 6d2e 7265 736f 6c76 655f 7061 7468  tem.resolve_path
+0000fe00: 2822 433a 2166 6f6f 2162 6172 2229 290a  ("C:!foo!bar")).
+0000fe10: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+0000fe20: 745f 7061 7468 5f63 6f6d 706f 6e65 6e74  t_path_component
+0000fe30: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000fe40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000fe50: 6c28 0a20 2020 2020 2020 2020 2020 205b  l(.            [
+0000fe60: 2263 3a22 2c20 2266 6f6f 222c 2022 6261  "c:", "foo", "ba
+0000fe70: 7222 5d2c 0a20 2020 2020 2020 2020 2020  r"],.           
+0000fe80: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0000fe90: 2e5f 7061 7468 5f63 6f6d 706f 6e65 6e74  ._path_component
+0000fea0: 7328 2263 3a21 666f 6f21 6261 7222 292c  s("c:!foo!bar"),
+0000feb0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000fec0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000fed0: 7561 6c28 5b22 633a 225d 2c20 7365 6c66  ual(["c:"], self
+0000fee0: 2e66 696c 6573 7973 7465 6d2e 5f70 6174  .filesystem._pat
+0000fef0: 685f 636f 6d70 6f6e 656e 7473 2822 633a  h_components("c:
+0000ff00: 2229 290a 0a20 2020 2064 6566 2074 6573  "))..    def tes
+0000ff10: 745f 7370 6c69 745f 6472 6976 655f 7374  t_split_drive_st
+0000ff20: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+0000ff30: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ff40: 6c28 2822 633a 222c 2022 2166 6f6f 2162  l(("c:", "!foo!b
+0000ff50: 6172 2229 2c20 7365 6c66 2e66 696c 6573  ar"), self.files
+0000ff60: 7973 7465 6d2e 7370 6c69 7464 7269 7665  ystem.splitdrive
+0000ff70: 2822 633a 2166 6f6f 2162 6172 2229 290a  ("c:!foo!bar")).
+0000ff80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000ff90: 6572 7445 7175 616c 2828 2222 2c20 2221  ertEqual(("", "!
+0000ffa0: 666f 6f21 6261 7222 292c 2073 656c 662e  foo!bar"), self.
+0000ffb0: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
+0000ffc0: 6472 6976 6528 2221 666f 6f21 6261 7222  drive("!foo!bar"
+0000ffd0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000ffe0: 6173 7365 7274 4571 7561 6c28 2822 633a  assertEqual(("c:
+0000fff0: 222c 2022 666f 6f21 6261 7222 292c 2073  ", "foo!bar"), s
+00010000: 656c 662e 6669 6c65 7379 7374 656d 2e73  elf.filesystem.s
+00010010: 706c 6974 6472 6976 6528 2263 3a66 6f6f  plitdrive("c:foo
+00010020: 2162 6172 2229 290a 2020 2020 2020 2020  !bar")).        
+00010030: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00010040: 2828 2222 2c20 2266 6f6f 2162 6172 2229  (("", "foo!bar")
+00010050: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+00010060: 6d2e 7370 6c69 7464 7269 7665 2822 666f  m.splitdrive("fo
+00010070: 6f21 6261 7222 2929 0a0a 2020 2020 6465  o!bar"))..    de
+00010080: 6620 7465 7374 5f73 706c 6974 5f64 7269  f test_split_dri
+00010090: 7665 5f62 7974 6573 2873 656c 6629 3a0a  ve_bytes(self):.
+000100a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000100b0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+000100c0: 2020 2020 2020 2862 2263 3a22 2c20 6222        (b"c:", b"
+000100d0: 2166 6f6f 2162 6172 2229 2c20 7365 6c66  !foo!bar"), self
+000100e0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+000100f0: 7464 7269 7665 2862 2263 3a21 666f 6f21  tdrive(b"c:!foo!
+00010100: 6261 7222 290a 2020 2020 2020 2020 290a  bar").        ).
+00010110: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010120: 6572 7445 7175 616c 2828 6222 222c 2062  ertEqual((b"", b
+00010130: 2221 666f 6f21 6261 7222 292c 2073 656c  "!foo!bar"), sel
+00010140: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+00010150: 6974 6472 6976 6528 6222 2166 6f6f 2162  itdrive(b"!foo!b
+00010160: 6172 2229 290a 0a20 2020 2064 6566 2074  ar"))..    def t
+00010170: 6573 745f 7370 6c69 745f 6472 6976 655f  est_split_drive_
+00010180: 616c 745f 7365 7028 7365 6c66 293a 0a20  alt_sep(self):. 
+00010190: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000101a0: 7274 4571 7561 6c28 2822 633a 222c 2022  rtEqual(("c:", "
+000101b0: 5e66 6f6f 5e62 6172 2229 2c20 7365 6c66  ^foo^bar"), self
+000101c0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+000101d0: 7464 7269 7665 2822 633a 5e66 6f6f 5e62  tdrive("c:^foo^b
+000101e0: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
+000101f0: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
+00010200: 2222 2c20 2266 6f6f 5e62 6172 2229 2c20  "", "foo^bar"), 
+00010210: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00010220: 7370 6c69 7464 7269 7665 2822 666f 6f5e  splitdrive("foo^
+00010230: 6261 7222 2929 0a20 2020 2020 2020 2073  bar")).        s
+00010240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010250: 2822 222c 2022 666f 6f5e 6261 7221 6261  ("", "foo^bar!ba
+00010260: 7a22 292c 2073 656c 662e 6669 6c65 7379  z"), self.filesy
+00010270: 7374 656d 2e73 706c 6974 6472 6976 6528  stem.splitdrive(
+00010280: 2266 6f6f 5e62 6172 2162 617a 2229 290a  "foo^bar!baz")).
+00010290: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000102a0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+000102b0: 2020 2020 2020 2862 2263 3a22 2c20 6222        (b"c:", b"
+000102c0: 5e66 6f6f 5e62 6172 2229 2c20 7365 6c66  ^foo^bar"), self
+000102d0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+000102e0: 7464 7269 7665 2862 2263 3a5e 666f 6f5e  tdrive(b"c:^foo^
+000102f0: 6261 7222 290a 2020 2020 2020 2020 290a  bar").        ).
+00010300: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010310: 6572 7445 7175 616c 2828 6222 222c 2062  ertEqual((b"", b
+00010320: 225e 666f 6f5e 6261 7222 292c 2073 656c  "^foo^bar"), sel
+00010330: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+00010340: 6974 6472 6976 6528 6222 5e66 6f6f 5e62  itdrive(b"^foo^b
+00010350: 6172 2229 290a 2020 2020 2020 2020 7365  ar")).        se
+00010360: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+00010370: 2020 2020 2020 2020 2020 2020 2862 2222              (b""
+00010380: 2c20 6222 5e66 6f6f 5e62 6172 2162 617a  , b"^foo^bar!baz
+00010390: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+000103a0: 7465 6d2e 7370 6c69 7464 7269 7665 2862  tem.splitdrive(b
+000103b0: 225e 666f 6f5e 6261 7221 6261 7a22 290a  "^foo^bar!baz").
+000103c0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+000103d0: 6566 2074 6573 745f 7370 6c69 745f 6472  ef test_split_dr
+000103e0: 6976 655f 7769 7468 5f75 6e63 5f70 6174  ive_with_unc_pat
+000103f0: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+00010400: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00010410: 6c28 0a20 2020 2020 2020 2020 2020 2028  l(.            (
+00010420: 2221 2166 6f6f 2162 6172 222c 2022 2162  "!!foo!bar", "!b
+00010430: 617a 2229 2c20 7365 6c66 2e66 696c 6573  az"), self.files
+00010440: 7973 7465 6d2e 7370 6c69 7464 7269 7665  ystem.splitdrive
+00010450: 2822 2121 666f 6f21 6261 7221 6261 7a22  ("!!foo!bar!baz"
+00010460: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00010470: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00010480: 7175 616c 2828 2222 2c20 2221 2166 6f6f  qual(("", "!!foo
+00010490: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+000104a0: 7465 6d2e 7370 6c69 7464 7269 7665 2822  tem.splitdrive("
+000104b0: 2121 666f 6f22 2929 0a20 2020 2020 2020  !!foo")).       
+000104c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000104d0: 6c28 2822 222c 2022 2121 666f 6f21 2162  l(("", "!!foo!!b
+000104e0: 6172 2229 2c20 7365 6c66 2e66 696c 6573  ar"), self.files
+000104f0: 7973 7465 6d2e 7370 6c69 7464 7269 7665  ystem.splitdrive
+00010500: 2822 2121 666f 6f21 2162 6172 2229 290a  ("!!foo!!bar")).
+00010510: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010520: 6572 7445 7175 616c 2828 2221 2166 6f6f  ertEqual(("!!foo
+00010530: 2162 6172 222c 2022 2121 2229 2c20 7365  !bar", "!!"), se
+00010540: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+00010550: 6c69 7464 7269 7665 2822 2121 666f 6f21  litdrive("!!foo!
+00010560: 6261 7221 2122 2929 0a0a 2020 2020 6465  bar!!"))..    de
+00010570: 6620 7465 7374 5f73 706c 6974 5f64 7269  f test_split_dri
+00010580: 7665 5f77 6974 685f 756e 635f 7061 7468  ve_with_unc_path
+00010590: 5f61 6c74 5f73 6570 2873 656c 6629 3a0a  _alt_sep(self):.
+000105a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000105b0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+000105c0: 2020 2020 2020 2822 5e5e 666f 6f5e 6261        ("^^foo^ba
+000105d0: 7222 2c20 2221 6261 7a22 292c 2073 656c  r", "!baz"), sel
+000105e0: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+000105f0: 6974 6472 6976 6528 225e 5e66 6f6f 5e62  itdrive("^^foo^b
+00010600: 6172 2162 617a 2229 0a20 2020 2020 2020  ar!baz").       
+00010610: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00010620: 6173 7365 7274 4571 7561 6c28 2822 222c  assertEqual(("",
+00010630: 2022 5e5e 666f 6f22 292c 2073 656c 662e   "^^foo"), self.
+00010640: 6669 6c65 7379 7374 656d 2e73 706c 6974  filesystem.split
+00010650: 6472 6976 6528 225e 5e66 6f6f 2229 290a  drive("^^foo")).
+00010660: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010670: 6572 7445 7175 616c 2828 2222 2c20 225e  ertEqual(("", "^
+00010680: 5e66 6f6f 5e5e 6261 7222 292c 2073 656c  ^foo^^bar"), sel
+00010690: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+000106a0: 6974 6472 6976 6528 225e 5e66 6f6f 5e5e  itdrive("^^foo^^
+000106b0: 6261 7222 2929 0a20 2020 2020 2020 2073  bar")).        s
+000106c0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000106d0: 2822 5e5e 666f 6f5e 6261 7222 2c20 225e  ("^^foo^bar", "^
+000106e0: 5e22 292c 2073 656c 662e 6669 6c65 7379  ^"), self.filesy
+000106f0: 7374 656d 2e73 706c 6974 6472 6976 6528  stem.splitdrive(
+00010700: 225e 5e66 6f6f 5e62 6172 5e5e 2229 290a  "^^foo^bar^^")).
+00010710: 0a20 2020 2064 6566 2074 6573 745f 7370  .    def test_sp
+00010720: 6c69 745f 7061 7468 5f77 6974 685f 6472  lit_path_with_dr
+00010730: 6976 6528 7365 6c66 293a 0a20 2020 2020  ive(self):.     
+00010740: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00010750: 7561 6c28 2822 643a 2166 6f6f 222c 2022  ual(("d:!foo", "
+00010760: 6261 7a22 292c 2073 656c 662e 6669 6c65  baz"), self.file
+00010770: 7379 7374 656d 2e73 706c 6974 7061 7468  system.splitpath
+00010780: 2822 643a 2166 6f6f 2162 617a 2229 290a  ("d:!foo!baz")).
+00010790: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000107a0: 6572 7445 7175 616c 2828 2264 3a21 666f  ertEqual(("d:!fo
+000107b0: 6f21 6261 7a22 2c20 2222 292c 2073 656c  o!baz", ""), sel
+000107c0: 662e 6669 6c65 7379 7374 656d 2e73 706c  f.filesystem.spl
+000107d0: 6974 7061 7468 2822 643a 2166 6f6f 2162  itpath("d:!foo!b
+000107e0: 617a 2122 2929 0a20 2020 2020 2020 2073  az!")).        s
+000107f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010800: 2822 633a 222c 2022 2229 2c20 7365 6c66  ("c:", ""), self
+00010810: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+00010820: 7470 6174 6828 2263 3a22 2929 0a20 2020  tpath("c:")).   
+00010830: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010840: 4571 7561 6c28 2822 633a 2122 2c20 2222  Equal(("c:!", ""
+00010850: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
+00010860: 656d 2e73 706c 6974 7061 7468 2822 633a  em.splitpath("c:
+00010870: 2122 2929 0a20 2020 2020 2020 2073 656c  !")).        sel
+00010880: 662e 6173 7365 7274 4571 7561 6c28 2822  f.assertEqual(("
+00010890: 633a 2121 222c 2022 2229 2c20 7365 6c66  c:!!", ""), self
+000108a0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+000108b0: 7470 6174 6828 2263 3a21 2122 2929 0a0a  tpath("c:!!"))..
+000108c0: 2020 2020 6465 6620 7465 7374 5f73 706c      def test_spl
+000108d0: 6974 5f70 6174 685f 7769 7468 5f64 7269  it_path_with_dri
+000108e0: 7665 5f61 6c74 5f73 6570 2873 656c 6629  ve_alt_sep(self)
+000108f0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+00010900: 7373 6572 7445 7175 616c 2828 2264 3a5e  ssertEqual(("d:^
+00010910: 666f 6f22 2c20 2262 617a 2229 2c20 7365  foo", "baz"), se
+00010920: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+00010930: 6c69 7470 6174 6828 2264 3a5e 666f 6f5e  litpath("d:^foo^
+00010940: 6261 7a22 2929 0a20 2020 2020 2020 2073  baz")).        s
+00010950: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010960: 2822 643a 5e66 6f6f 5e62 617a 222c 2022  ("d:^foo^baz", "
+00010970: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+00010980: 7465 6d2e 7370 6c69 7470 6174 6828 2264  tem.splitpath("d
+00010990: 3a5e 666f 6f5e 6261 7a5e 2229 290a 2020  :^foo^baz^")).  
+000109a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000109b0: 7445 7175 616c 2828 2263 3a22 2c20 2222  tEqual(("c:", ""
+000109c0: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
+000109d0: 656d 2e73 706c 6974 7061 7468 2822 633a  em.splitpath("c:
+000109e0: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+000109f0: 2e61 7373 6572 7445 7175 616c 2828 2263  .assertEqual(("c
+00010a00: 3a5e 222c 2022 2229 2c20 7365 6c66 2e66  :^", ""), self.f
+00010a10: 696c 6573 7973 7465 6d2e 7370 6c69 7470  ilesystem.splitp
+00010a20: 6174 6828 2263 3a5e 2229 290a 2020 2020  ath("c:^")).    
+00010a30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00010a40: 7175 616c 2828 2263 3a5e 5e22 2c20 2222  qual(("c:^^", ""
+00010a50: 292c 2073 656c 662e 6669 6c65 7379 7374  ), self.filesyst
+00010a60: 656d 2e73 706c 6974 7061 7468 2822 633a  em.splitpath("c:
+00010a70: 5e5e 2229 290a 0a20 2020 2064 6566 2074  ^^"))..    def t
+00010a80: 6573 745f 7370 6c69 745f 7061 7468 5f77  est_split_path_w
+00010a90: 6974 685f 756e 635f 7061 7468 2873 656c  ith_unc_path(sel
+00010aa0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00010ab0: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
+00010ac0: 2020 2020 2020 2020 2020 2822 2121 666f            ("!!fo
+00010ad0: 6f21 6261 7221 222c 2022 6261 7a22 292c  o!bar!", "baz"),
+00010ae0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00010af0: 2e73 706c 6974 7061 7468 2822 2121 666f  .splitpath("!!fo
+00010b00: 6f21 6261 7221 6261 7a22 290a 2020 2020  o!bar!baz").    
+00010b10: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00010b20: 6c66 2e61 7373 6572 7445 7175 616c 2828  lf.assertEqual((
+00010b30: 2221 2166 6f6f 2162 6172 222c 2022 2229  "!!foo!bar", "")
+00010b40: 2c20 7365 6c66 2e66 696c 6573 7973 7465  , self.filesyste
+00010b50: 6d2e 7370 6c69 7470 6174 6828 2221 2166  m.splitpath("!!f
+00010b60: 6f6f 2162 6172 2229 290a 2020 2020 2020  oo!bar")).      
+00010b70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00010b80: 616c 2828 2221 2166 6f6f 2162 6172 2121  al(("!!foo!bar!!
+00010b90: 222c 2022 2229 2c20 7365 6c66 2e66 696c  ", ""), self.fil
+00010ba0: 6573 7973 7465 6d2e 7370 6c69 7470 6174  esystem.splitpat
+00010bb0: 6828 2221 2166 6f6f 2162 6172 2121 2229  h("!!foo!bar!!")
+00010bc0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00010bd0: 7370 6c69 745f 7061 7468 5f77 6974 685f  split_path_with_
+00010be0: 756e 635f 7061 7468 5f61 6c74 5f73 6570  unc_path_alt_sep
+00010bf0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00010c00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00010c10: 280a 2020 2020 2020 2020 2020 2020 2822  (.            ("
+00010c20: 5e5e 666f 6f5e 6261 725e 222c 2022 6261  ^^foo^bar^", "ba
+00010c30: 7a22 292c 2073 656c 662e 6669 6c65 7379  z"), self.filesy
+00010c40: 7374 656d 2e73 706c 6974 7061 7468 2822  stem.splitpath("
+00010c50: 5e5e 666f 6f5e 6261 725e 6261 7a22 290a  ^^foo^bar^baz").
+00010c60: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00010c70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00010c80: 616c 2828 225e 5e66 6f6f 5e62 6172 222c  al(("^^foo^bar",
+00010c90: 2022 2229 2c20 7365 6c66 2e66 696c 6573   ""), self.files
+00010ca0: 7973 7465 6d2e 7370 6c69 7470 6174 6828  ystem.splitpath(
+00010cb0: 225e 5e66 6f6f 5e62 6172 2229 290a 2020  "^^foo^bar")).  
+00010cc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010cd0: 7445 7175 616c 2828 225e 5e66 6f6f 5e62  tEqual(("^^foo^b
+00010ce0: 6172 5e5e 222c 2022 2229 2c20 7365 6c66  ar^^", ""), self
+00010cf0: 2e66 696c 6573 7973 7465 6d2e 7370 6c69  .filesystem.spli
+00010d00: 7470 6174 6828 225e 5e66 6f6f 5e62 6172  tpath("^^foo^bar
+00010d10: 5e5e 2229 290a 0a20 2020 2064 6566 2074  ^^"))..    def t
+00010d20: 6573 745f 7370 6c69 7472 6f6f 745f 7769  est_splitroot_wi
+00010d30: 7468 5f64 7269 7665 2873 656c 6629 3a0a  th_drive(self):.
+00010d40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010d50: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00010d60: 2020 2020 2020 2822 453a 222c 2022 2122        ("E:", "!"
+00010d70: 2c20 2266 6f6f 2162 6172 2229 2c20 7365  , "foo!bar"), se
+00010d80: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+00010d90: 6c69 7472 6f6f 7428 2245 3a21 666f 6f21  litroot("E:!foo!
+00010da0: 6261 7222 290a 2020 2020 2020 2020 290a  bar").        ).
+00010db0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010dc0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00010dd0: 2020 2020 2020 2822 453a 222c 2022 2122        ("E:", "!"
+00010de0: 2c20 2221 666f 6f21 2121 6261 7222 292c  , "!foo!!!bar"),
+00010df0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00010e00: 2e73 706c 6974 726f 6f74 2822 453a 2121  .splitroot("E:!!
+00010e10: 666f 6f21 2121 6261 7222 290a 2020 2020  foo!!!bar").    
+00010e20: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00010e30: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+00010e40: 2020 2020 2020 2020 2020 2020 2862 2245              (b"E
+00010e50: 3a22 2c20 6222 2122 2c20 6222 2166 6f6f  :", b"!", b"!foo
+00010e60: 2121 2162 6172 2229 2c20 7365 6c66 2e66  !!!bar"), self.f
+00010e70: 696c 6573 7973 7465 6d2e 7370 6c69 7472  ilesystem.splitr
+00010e80: 6f6f 7428 6222 453a 2121 666f 6f21 2121  oot(b"E:!!foo!!!
+00010e90: 6261 7222 290a 2020 2020 2020 2020 290a  bar").        ).
+00010ea0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010eb0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+00010ec0: 2020 2020 2020 2822 433a 222c 2022 5e22        ("C:", "^"
+00010ed0: 2c20 2266 6f6f 5e62 6172 2229 2c20 7365  , "foo^bar"), se
+00010ee0: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+00010ef0: 6c69 7472 6f6f 7428 2243 3a5e 666f 6f5e  litroot("C:^foo^
+00010f00: 6261 7222 290a 2020 2020 2020 2020 290a  bar").        ).
+00010f10: 0a20 2020 2064 6566 2074 6573 745f 7370  .    def test_sp
+00010f20: 6c69 7472 6f6f 745f 7769 7468 5f75 6e63  litroot_with_unc
+00010f30: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
+00010f40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010f50: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
+00010f60: 2020 2028 2221 2166 6f6f 2162 6172 222c     ("!!foo!bar",
+00010f70: 2022 2122 2c20 2262 617a 2229 2c20 7365   "!", "baz"), se
+00010f80: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+00010f90: 6c69 7472 6f6f 7428 2221 2166 6f6f 2162  litroot("!!foo!b
+00010fa0: 6172 2162 617a 2229 0a20 2020 2020 2020  ar!baz").       
+00010fb0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00010fc0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+00010fd0: 2020 2020 2020 2020 2028 2221 213f 2155           ("!!?!U
+00010fe0: 4e43 222c 2022 2122 2c20 2266 6f6f 2162  NC", "!", "foo!b
+00010ff0: 6172 2229 2c20 7365 6c66 2e66 696c 6573  ar"), self.files
+00011000: 7973 7465 6d2e 7370 6c69 7472 6f6f 7428  ystem.splitroot(
+00011010: 2221 213f 2155 4e43 2166 6f6f 2162 6172  "!!?!UNC!foo!bar
+00011020: 2229 0a20 2020 2020 2020 2029 0a20 2020  ").        ).   
+00011030: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00011040: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
+00011050: 2020 2028 225e 5e66 6f6f 5e62 6172 222c     ("^^foo^bar",
+00011060: 2022 5e22 2c20 2262 617a 2229 2c20 7365   "^", "baz"), se
+00011070: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+00011080: 6c69 7472 6f6f 7428 225e 5e66 6f6f 5e62  litroot("^^foo^b
+00011090: 6172 5e62 617a 2229 0a20 2020 2020 2020  ar^baz").       
+000110a0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+000110b0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+000110c0: 2020 2020 2020 2020 2028 6222 2121 666f           (b"!!fo
+000110d0: 6f21 6261 7222 2c20 6222 2122 2c20 6222  o!bar", b"!", b"
+000110e0: 6261 7a22 292c 2073 656c 662e 6669 6c65  baz"), self.file
+000110f0: 7379 7374 656d 2e73 706c 6974 726f 6f74  system.splitroot
+00011100: 2862 2221 2166 6f6f 2162 6172 2162 617a  (b"!!foo!bar!baz
+00011110: 2229 0a20 2020 2020 2020 2029 0a0a 2020  ").        )..  
+00011120: 2020 6465 6620 7465 7374 5f73 706c 6974    def test_split
+00011130: 726f 6f74 5f77 6974 685f 656d 7074 795f  root_with_empty_
+00011140: 7061 7274 7328 7365 6c66 293a 0a20 2020  parts(self):.   
+00011150: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00011160: 4571 7561 6c28 2822 222c 2022 222c 2022  Equal(("", "", "
+00011170: 2229 2c20 7365 6c66 2e66 696c 6573 7973  "), self.filesys
+00011180: 7465 6d2e 7370 6c69 7472 6f6f 7428 2222  tem.splitroot(""
+00011190: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+000111a0: 6173 7365 7274 4571 7561 6c28 2822 222c  assertEqual(("",
+000111b0: 2022 2122 2c20 2266 6f6f 2229 2c20 7365   "!", "foo"), se
+000111c0: 6c66 2e66 696c 6573 7973 7465 6d2e 7370  lf.filesystem.sp
+000111d0: 6c69 7472 6f6f 7428 2221 666f 6f22 2929  litroot("!foo"))
+000111e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000111f0: 7365 7274 4571 7561 6c28 2822 2121 666f  sertEqual(("!!fo
+00011200: 6f21 6261 7222 2c20 2222 2c20 2222 292c  o!bar", "", ""),
+00011210: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00011220: 2e73 706c 6974 726f 6f74 2822 2121 666f  .splitroot("!!fo
+00011230: 6f21 6261 7222 2929 0a20 2020 2020 2020  o!bar")).       
+00011240: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00011250: 6c28 2822 2121 666f 6f22 2c20 2222 2c20  l(("!!foo", "", 
+00011260: 2222 292c 2073 656c 662e 6669 6c65 7379  ""), self.filesy
+00011270: 7374 656d 2e73 706c 6974 726f 6f74 2822  stem.splitroot("
+00011280: 2121 666f 6f22 2929 0a20 2020 2020 2020  !!foo")).       
+00011290: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000112a0: 6c28 0a20 2020 2020 2020 2020 2020 2028  l(.            (
+000112b0: 2221 2166 6f6f 2162 6172 222c 2022 2122  "!!foo!bar", "!"
+000112c0: 2c20 2222 292c 2073 656c 662e 6669 6c65  , ""), self.file
+000112d0: 7379 7374 656d 2e73 706c 6974 726f 6f74  system.splitroot
+000112e0: 2822 2121 666f 6f21 6261 7221 2229 0a20  ("!!foo!bar!"). 
+000112f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00011300: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00011310: 6c28 2822 433a 222c 2022 222c 2022 666f  l(("C:", "", "fo
+00011320: 6f21 6261 7222 292c 2073 656c 662e 6669  o!bar"), self.fi
+00011330: 6c65 7379 7374 656d 2e73 706c 6974 726f  lesystem.splitro
+00011340: 6f74 2822 433a 666f 6f21 6261 7222 2929  ot("C:foo!bar"))
+00011350: 0a0a 0a63 6c61 7373 2044 6973 6b53 7061  ...class DiskSpa
+00011360: 6365 5465 7374 2854 6573 7443 6173 6529  ceTest(TestCase)
+00011370: 3a0a 2020 2020 6465 6620 7365 7455 7028  :.    def setUp(
+00011380: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00011390: 656c 662e 6673 203d 2066 616b 655f 6669  elf.fs = fake_fi
+000113a0: 6c65 7379 7374 656d 2e46 616b 6546 696c  lesystem.FakeFil
+000113b0: 6573 7973 7465 6d28 7061 7468 5f73 6570  esystem(path_sep
+000113c0: 6172 6174 6f72 3d22 2122 2c20 746f 7461  arator="!", tota
+000113d0: 6c5f 7369 7a65 3d31 3030 290a 2020 2020  l_size=100).    
+000113e0: 2020 2020 7365 6c66 2e6f 7320 3d20 6661      self.os = fa
+000113f0: 6b65 5f6f 732e 4661 6b65 4f73 4d6f 6475  ke_os.FakeOsModu
+00011400: 6c65 2873 656c 662e 6673 290a 2020 2020  le(self.fs).    
+00011410: 2020 2020 7365 6c66 2e6f 7065 6e20 3d20      self.open = 
+00011420: 6661 6b65 5f6f 7065 6e2e 4661 6b65 4669  fake_open.FakeFi
+00011430: 6c65 4f70 656e 2873 656c 662e 6673 290a  leOpen(self.fs).
+00011440: 0a20 2020 2064 6566 2074 6573 745f 6469  .    def test_di
+00011450: 736b 5f75 7361 6765 5f6f 6e5f 6669 6c65  sk_usage_on_file
+00011460: 5f63 7265 6174 696f 6e28 7365 6c66 293a  _creation(self):
+00011470: 0a20 2020 2020 2020 2074 6f74 616c 5f73  .        total_s
+00011480: 697a 6520 3d20 3130 300a 2020 2020 2020  ize = 100.      
+00011490: 2020 7365 6c66 2e66 732e 6164 645f 6d6f    self.fs.add_mo
+000114a0: 756e 745f 706f 696e 7428 2221 6d6f 756e  unt_point("!moun
+000114b0: 7422 2c20 746f 7461 6c5f 7369 7a65 290a  t", total_size).
+000114c0: 0a20 2020 2020 2020 2064 6566 2063 7265  .        def cre
+000114d0: 6174 655f 746f 6f5f 6c61 7267 655f 6669  ate_too_large_fi
+000114e0: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
+000114f0: 2020 7769 7468 2073 656c 662e 6f70 656e    with self.open
+00011500: 2822 216d 6f75 6e74 2166 696c 6522 2c20  ("!mount!file", 
+00011510: 2277 222c 2065 6e63 6f64 696e 673d 2275  "w", encoding="u
+00011520: 7466 3822 2920 6173 2064 6573 743a 0a20  tf8") as dest:. 
+00011530: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011540: 6573 742e 7772 6974 6528 2261 2220 2a20  est.write("a" * 
+00011550: 2874 6f74 616c 5f73 697a 6520 2b20 3129  (total_size + 1)
+00011560: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+00011570: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00011580: 7328 4f53 4572 726f 7229 3a0a 2020 2020  s(OSError):.    
+00011590: 2020 2020 2020 2020 6372 6561 7465 5f74          create_t
+000115a0: 6f6f 5f6c 6172 6765 5f66 696c 6528 290a  oo_large_file().
+000115b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000115c0: 7365 7274 4571 7561 6c28 302c 2073 656c  sertEqual(0, sel
+000115d0: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
+000115e0: 6167 6528 2221 6d6f 756e 7422 292e 7573  age("!mount").us
+000115f0: 6564 290a 0a20 2020 2020 2020 2077 6974  ed)..        wit
+00011600: 6820 7365 6c66 2e6f 7065 6e28 2221 6d6f  h self.open("!mo
+00011610: 756e 7421 6669 6c65 222c 2022 7722 2c20  unt!file", "w", 
+00011620: 656e 636f 6469 6e67 3d22 7574 6638 2229  encoding="utf8")
+00011630: 2061 7320 6465 7374 3a0a 2020 2020 2020   as dest:.      
+00011640: 2020 2020 2020 6465 7374 2e77 7269 7465        dest.write
+00011650: 2822 6122 202a 2074 6f74 616c 5f73 697a  ("a" * total_siz
+00011660: 6529 0a0a 2020 2020 2020 2020 7365 6c66  e)..        self
+00011670: 2e61 7373 6572 7445 7175 616c 2874 6f74  .assertEqual(tot
+00011680: 616c 5f73 697a 652c 2073 656c 662e 6673  al_size, self.fs
+00011690: 2e67 6574 5f64 6973 6b5f 7573 6167 6528  .get_disk_usage(
+000116a0: 2221 6d6f 756e 7422 292e 7573 6564 290a  "!mount").used).
+000116b0: 0a20 2020 2064 6566 2074 6573 745f 6469  .    def test_di
+000116c0: 736b 5f75 7361 6765 5f6f 6e5f 6175 746f  sk_usage_on_auto
+000116d0: 6d6f 756e 7465 645f 6472 6976 6528 7365  mounted_drive(se
+000116e0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000116f0: 662e 6673 2e69 735f 7769 6e64 6f77 735f  f.fs.is_windows_
+00011700: 6673 203d 2054 7275 650a 2020 2020 2020  fs = True.      
+00011710: 2020 7365 6c66 2e66 732e 7265 7365 7428    self.fs.reset(
+00011720: 746f 7461 6c5f 7369 7a65 3d31 3030 290a  total_size=100).
+00011730: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
+00011740: 6372 6561 7465 5f66 696c 6528 2221 666f  create_file("!fo
+00011750: 6f21 6261 7222 2c20 7374 5f73 697a 653d  o!bar", st_size=
+00011760: 3530 290a 2020 2020 2020 2020 7365 6c66  50).        self
+00011770: 2e61 7373 6572 7445 7175 616c 2830 2c20  .assertEqual(0, 
+00011780: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
+00011790: 5f75 7361 6765 2822 443a 2122 292e 7573  _usage("D:!").us
+000117a0: 6564 290a 2020 2020 2020 2020 7365 6c66  ed).        self
+000117b0: 2e66 732e 6377 6420 3d20 2245 3a21 666f  .fs.cwd = "E:!fo
+000117c0: 6f22 0a20 2020 2020 2020 2073 656c 662e  o".        self.
+000117d0: 6173 7365 7274 4571 7561 6c28 302c 2073  assertEqual(0, s
+000117e0: 656c 662e 6673 2e67 6574 5f64 6973 6b5f  elf.fs.get_disk_
+000117f0: 7573 6167 6528 2221 666f 6f22 292e 7573  usage("!foo").us
+00011800: 6564 290a 0a20 2020 2064 6566 2074 6573  ed)..    def tes
+00011810: 745f 6469 736b 5f75 7361 6765 5f6f 6e5f  t_disk_usage_on_
+00011820: 6d6f 756e 7465 645f 7061 7468 7328 7365  mounted_paths(se
+00011830: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00011840: 662e 6673 2e61 6464 5f6d 6f75 6e74 5f70  f.fs.add_mount_p
+00011850: 6f69 6e74 2822 2166 6f6f 222c 2074 6f74  oint("!foo", tot
+00011860: 616c 5f73 697a 653d 3230 3029 0a20 2020  al_size=200).   
+00011870: 2020 2020 2073 656c 662e 6673 2e61 6464       self.fs.add
+00011880: 5f6d 6f75 6e74 5f70 6f69 6e74 2822 2166  _mount_point("!f
+00011890: 6f6f 2162 6172 222c 2074 6f74 616c 5f73  oo!bar", total_s
+000118a0: 697a 653d 3430 3029 0a20 2020 2020 2020  ize=400).       
+000118b0: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
+000118c0: 6669 6c65 2822 2162 617a 222c 2073 745f  file("!baz", st_
+000118d0: 7369 7a65 3d35 3029 0a20 2020 2020 2020  size=50).       
+000118e0: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
+000118f0: 6669 6c65 2822 2166 6f6f 2162 617a 222c  file("!foo!baz",
+00011900: 2073 745f 7369 7a65 3d36 3029 0a20 2020   st_size=60).   
+00011910: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
+00011920: 6174 655f 6669 6c65 2822 2166 6f6f 2162  ate_file("!foo!b
+00011930: 6172 2162 617a 222c 2073 745f 7369 7a65  ar!baz", st_size
+00011940: 3d31 3030 290a 2020 2020 2020 2020 7365  =100).        se
+00011950: 6c66 2e61 7373 6572 7445 7175 616c 2835  lf.assertEqual(5
+00011960: 302c 2073 656c 662e 6673 2e67 6574 5f64  0, self.fs.get_d
+00011970: 6973 6b5f 7573 6167 6528 2221 2229 2e75  isk_usage("!").u
+00011980: 7365 6429 0a20 2020 2020 2020 2073 656c  sed).        sel
+00011990: 662e 6173 7365 7274 4571 7561 6c28 3630  f.assertEqual(60
+000119a0: 2c20 7365 6c66 2e66 732e 6765 745f 6469  , self.fs.get_di
+000119b0: 736b 5f75 7361 6765 2822 2166 6f6f 2229  sk_usage("!foo")
+000119c0: 2e75 7365 6429 0a20 2020 2020 2020 2073  .used).        s
+000119d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000119e0: 3130 302c 2073 656c 662e 6673 2e67 6574  100, self.fs.get
+000119f0: 5f64 6973 6b5f 7573 6167 6528 2221 666f  _disk_usage("!fo
+00011a00: 6f21 6261 7222 292e 7573 6564 290a 2020  o!bar").used).  
+00011a10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00011a20: 7445 7175 616c 2834 3030 2c20 7365 6c66  tEqual(400, self
+00011a30: 2e66 732e 6765 745f 6469 736b 5f75 7361  .fs.get_disk_usa
+00011a40: 6765 2822 2166 6f6f 2162 6172 2229 2e74  ge("!foo!bar").t
+00011a50: 6f74 616c 290a 0a20 2020 2064 6566 2074  otal)..    def t
+00011a60: 6573 745f 6669 6c65 5f73 7973 7465 6d5f  est_file_system_
+00011a70: 7369 7a65 5f61 6674 6572 5f6c 6172 6765  size_after_large
+00011a80: 5f66 696c 655f 6372 6561 7469 6f6e 2873  _file_creation(s
+00011a90: 656c 6629 3a0a 2020 2020 2020 2020 6669  elf):.        fi
+00011aa0: 6c65 7379 7374 656d 203d 2066 616b 655f  lesystem = fake_
+00011ab0: 6669 6c65 7379 7374 656d 2e46 616b 6546  filesystem.FakeF
+00011ac0: 696c 6573 7973 7465 6d28 0a20 2020 2020  ilesystem(.     
+00011ad0: 2020 2020 2020 2070 6174 685f 7365 7061         path_sepa
+00011ae0: 7261 746f 723d 2221 222c 2074 6f74 616c  rator="!", total
+00011af0: 5f73 697a 653d 3130 3234 202a 2031 3032  _size=1024 * 102
+00011b00: 3420 2a20 3130 3234 202a 2031 3030 0a20  4 * 1024 * 100. 
+00011b10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00011b20: 2066 696c 6573 7973 7465 6d2e 6372 6561   filesystem.crea
+00011b30: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
+00011b40: 7a22 2c20 7374 5f73 697a 653d 3130 3234  z", st_size=1024
+00011b50: 202a 2031 3032 3420 2a20 3130 3234 202a   * 1024 * 1024 *
+00011b60: 2031 3029 0a20 2020 2020 2020 2073 656c   10).        sel
+00011b70: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00011b80: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+00011b90: 2020 2020 2020 2020 2020 2020 2031 3032               102
+00011ba0: 3420 2a20 3130 3234 202a 2031 3032 3420  4 * 1024 * 1024 
+00011bb0: 2a20 3130 302c 0a20 2020 2020 2020 2020  * 100,.         
+00011bc0: 2020 2020 2020 2031 3032 3420 2a20 3130         1024 * 10
+00011bd0: 3234 202a 2031 3032 3420 2a20 3130 2c0a  24 * 1024 * 10,.
+00011be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bf0: 3130 3234 202a 2031 3032 3420 2a20 3130  1024 * 1024 * 10
+00011c00: 3234 202a 2039 302c 0a20 2020 2020 2020  24 * 90,.       
+00011c10: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00011c20: 2020 2020 6669 6c65 7379 7374 656d 2e67      filesystem.g
+00011c30: 6574 5f64 6973 6b5f 7573 6167 6528 292c  et_disk_usage(),
+00011c40: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00011c50: 6465 6620 7465 7374 5f66 696c 655f 7379  def test_file_sy
+00011c60: 7374 656d 5f73 697a 655f 6166 7465 725f  stem_size_after_
+00011c70: 6269 6e61 7279 5f66 696c 655f 6372 6561  binary_file_crea
+00011c80: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
+00011c90: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
+00011ca0: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
+00011cb0: 7222 2c20 636f 6e74 656e 7473 3d62 2278  r", contents=b"x
+00011cc0: 797a 7a79 2229 0a20 2020 2020 2020 2073  yzzy").        s
+00011cd0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00011ce0: 2831 3030 2c20 352c 2039 3529 2c20 7365  (100, 5, 95), se
+00011cf0: 6c66 2e66 732e 6765 745f 6469 736b 5f75  lf.fs.get_disk_u
+00011d00: 7361 6765 2829 290a 0a20 2020 2064 6566  sage())..    def
+00011d10: 2074 6573 745f 6669 6c65 5f73 7973 7465   test_file_syste
+00011d20: 6d5f 7369 7a65 5f61 6674 6572 5f61 7363  m_size_after_asc
+00011d30: 6969 5f73 7472 696e 675f 6669 6c65 5f63  ii_string_file_c
+00011d40: 7265 6174 696f 6e28 7365 6c66 293a 0a20  reation(self):. 
+00011d50: 2020 2020 2020 2073 656c 662e 6673 2e63         self.fs.c
+00011d60: 7265 6174 655f 6669 6c65 2822 2166 6f6f  reate_file("!foo
+00011d70: 2162 6172 222c 2063 6f6e 7465 6e74 733d  !bar", contents=
+00011d80: 2263 6f6d 706c 6963 6174 6564 2229 0a20  "complicated"). 
+00011d90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00011da0: 7274 4571 7561 6c28 2831 3030 2c20 3131  rtEqual((100, 11
+00011db0: 2c20 3839 292c 2073 656c 662e 6673 2e67  , 89), self.fs.g
+00011dc0: 6574 5f64 6973 6b5f 7573 6167 6528 2929  et_disk_usage())
+00011dd0: 0a0a 2020 2020 6465 6620 7465 7374 5f66  ..    def test_f
+00011de0: 696c 6573 7973 7465 6d5f 7369 7a65 5f61  ilesystem_size_a
+00011df0: 6674 6572 5f32 6279 7465 5f75 6e69 636f  fter_2byte_unico
+00011e00: 6465 5f66 696c 655f 6372 6561 7469 6f6e  de_file_creation
+00011e10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00011e20: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
+00011e30: 696c 6528 2221 666f 6f21 6261 7222 2c20  ile("!foo!bar", 
+00011e40: 636f 6e74 656e 7473 3d22 d181 d0bb d0be  contents="......
+00011e50: d0b6 d0bd d0be 222c 2065 6e63 6f64 696e  ......", encodin
+00011e60: 673d 2275 7466 2d38 2229 0a20 2020 2020  g="utf-8").     
+00011e70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00011e80: 7561 6c28 2831 3030 2c20 3132 2c20 3838  ual((100, 12, 88
+00011e90: 292c 2073 656c 662e 6673 2e67 6574 5f64  ), self.fs.get_d
+00011ea0: 6973 6b5f 7573 6167 6528 2929 0a0a 2020  isk_usage())..  
+00011eb0: 2020 6465 6620 7465 7374 5f66 696c 6573    def test_files
+00011ec0: 7973 7465 6d5f 7369 7a65 5f61 6674 6572  ystem_size_after
+00011ed0: 5f33 6279 7465 5f75 6e69 636f 6465 5f66  _3byte_unicode_f
+00011ee0: 696c 655f 6372 6561 7469 6f6e 2873 656c  ile_creation(sel
+00011ef0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00011f00: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
+00011f10: 2221 666f 6f21 6261 7222 2c20 636f 6e74  "!foo!bar", cont
+00011f20: 656e 7473 3d22 e8a4 87e9 9b91 222c 2065  ents="......", e
+00011f30: 6e63 6f64 696e 673d 2275 7466 2d38 2229  ncoding="utf-8")
+00011f40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00011f50: 7365 7274 4571 7561 6c28 2831 3030 2c20  sertEqual((100, 
+00011f60: 362c 2039 3429 2c20 7365 6c66 2e66 732e  6, 94), self.fs.
+00011f70: 6765 745f 6469 736b 5f75 7361 6765 2829  get_disk_usage()
+00011f80: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00011f90: 6669 6c65 5f73 7973 7465 6d5f 7369 7a65  file_system_size
+00011fa0: 5f61 6674 6572 5f66 696c 655f 6465 6c65  _after_file_dele
+00011fb0: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
+00011fc0: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
+00011fd0: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
+00011fe0: 7222 2c20 636f 6e74 656e 7473 3d62 2278  r", contents=b"x
+00011ff0: 797a 7a79 2229 0a20 2020 2020 2020 2073  yzzy").        s
+00012000: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
+00012010: 6c65 2822 2166 6f6f 2162 617a 222c 2073  le("!foo!baz", s
+00012020: 745f 7369 7a65 3d32 3029 0a20 2020 2020  t_size=20).     
+00012030: 2020 2073 656c 662e 6673 2e72 656d 6f76     self.fs.remov
+00012040: 655f 6f62 6a65 6374 2822 2166 6f6f 2162  e_object("!foo!b
+00012050: 6172 2229 0a20 2020 2020 2020 2073 656c  ar").        sel
+00012060: 662e 6173 7365 7274 4571 7561 6c28 2831  f.assertEqual((1
+00012070: 3030 2c20 3230 2c20 3830 292c 2073 656c  00, 20, 80), sel
+00012080: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
+00012090: 6167 6528 2929 0a0a 2020 2020 6465 6620  age())..    def 
+000120a0: 7465 7374 5f66 696c 655f 7379 7374 656d  test_file_system
+000120b0: 5f73 697a 655f 6166 7465 725f 6469 7265  _size_after_dire
+000120c0: 6374 6f72 795f 7265 6d6f 7661 6c28 7365  ctory_removal(se
+000120d0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000120e0: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
+000120f0: 2822 2166 6f6f 2162 6172 222c 2073 745f  ("!foo!bar", st_
+00012100: 7369 7a65 3d31 3029 0a20 2020 2020 2020  size=10).       
+00012110: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
+00012120: 6669 6c65 2822 2166 6f6f 2162 617a 222c  file("!foo!baz",
+00012130: 2073 745f 7369 7a65 3d32 3029 0a20 2020   st_size=20).   
+00012140: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
+00012150: 6174 655f 6669 6c65 2822 2166 6f6f 3121  ate_file("!foo1!
+00012160: 6261 7222 2c20 7374 5f73 697a 653d 3430  bar", st_size=40
+00012170: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+00012180: 732e 7265 6d6f 7665 5f6f 626a 6563 7428  s.remove_object(
+00012190: 2221 666f 6f22 290a 2020 2020 2020 2020  "!foo").        
+000121a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000121b0: 2828 3130 302c 2034 302c 2036 3029 2c20  ((100, 40, 60), 
+000121c0: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
+000121d0: 5f75 7361 6765 2829 290a 0a20 2020 2064  _usage())..    d
+000121e0: 6566 2074 6573 745f 6372 6561 7469 6e67  ef test_creating
+000121f0: 5f66 696c 655f 7769 7468 5f66 6974 7469  _file_with_fitti
+00012200: 6e67 5f63 6f6e 7465 6e74 2873 656c 6629  ng_content(self)
+00012210: 3a0a 2020 2020 2020 2020 696e 6974 6961  :.        initia
+00012220: 6c5f 7573 6167 6520 3d20 7365 6c66 2e66  l_usage = self.f
+00012230: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
+00012240: 2829 0a0a 2020 2020 2020 2020 7472 793a  ()..        try:
+00012250: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00012260: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
+00012270: 2822 2166 6f6f 2162 6172 222c 2063 6f6e  ("!foo!bar", con
+00012280: 7465 6e74 733d 6222 6122 202a 2031 3030  tents=b"a" * 100
+00012290: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+000122a0: 204f 5345 7272 6f72 3a0a 2020 2020 2020   OSError:.      
+000122b0: 2020 2020 2020 7365 6c66 2e66 6169 6c28        self.fail(
+000122c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000122d0: 2022 4669 6c65 2077 6974 6820 636f 6e74   "File with cont
+000122e0: 656e 7473 2066 6974 7469 6e67 2069 6e74  ents fitting int
+000122f0: 6f20 6469 736b 2073 7061 6365 2022 2022  o disk space " "
+00012300: 636f 756c 6420 6e6f 7420 6265 2077 7269  could not be wri
+00012310: 7474 656e 2e22 0a20 2020 2020 2020 2020  tten.".         
+00012320: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00012330: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+00012340: 6e69 7469 616c 5f75 7361 6765 2e75 7365  nitial_usage.use
+00012350: 6420 2b20 3130 302c 2073 656c 662e 6673  d + 100, self.fs
+00012360: 2e67 6574 5f64 6973 6b5f 7573 6167 6528  .get_disk_usage(
+00012370: 292e 7573 6564 290a 0a20 2020 2064 6566  ).used)..    def
+00012380: 2074 6573 745f 6372 6561 7469 6e67 5f66   test_creating_f
+00012390: 696c 655f 7769 7468 5f63 6f6e 7465 6e74  ile_with_content
+000123a0: 5f74 6f6f 5f6c 6172 6765 2873 656c 6629  _too_large(self)
+000123b0: 3a0a 2020 2020 2020 2020 6465 6620 6372  :.        def cr
+000123c0: 6561 7465 5f6c 6172 6765 5f66 696c 6528  eate_large_file(
+000123d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000123e0: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
+000123f0: 6c65 2822 2166 6f6f 2162 6172 222c 2063  le("!foo!bar", c
+00012400: 6f6e 7465 6e74 733d 6222 6122 202a 2031  ontents=b"a" * 1
+00012410: 3031 290a 0a20 2020 2020 2020 2069 6e69  01)..        ini
+00012420: 7469 616c 5f75 7361 6765 203d 2073 656c  tial_usage = sel
+00012430: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
+00012440: 6167 6528 290a 0a20 2020 2020 2020 2077  age()..        w
+00012450: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00012460: 6169 7365 7328 4f53 4572 726f 7229 3a0a  aises(OSError):.
+00012470: 2020 2020 2020 2020 2020 2020 6372 6561              crea
+00012480: 7465 5f6c 6172 6765 5f66 696c 6528 290a  te_large_file().
+00012490: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000124a0: 7365 7274 4571 7561 6c28 696e 6974 6961  sertEqual(initia
+000124b0: 6c5f 7573 6167 652c 2073 656c 662e 6673  l_usage, self.fs
+000124c0: 2e67 6574 5f64 6973 6b5f 7573 6167 6528  .get_disk_usage(
+000124d0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
+000124e0: 5f63 7265 6174 696e 675f 6669 6c65 5f77  _creating_file_w
+000124f0: 6974 685f 6669 7474 696e 675f 7369 7a65  ith_fitting_size
+00012500: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00012510: 696e 6974 6961 6c5f 7573 6167 6520 3d20  initial_usage = 
+00012520: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
+00012530: 5f75 7361 6765 2829 0a0a 2020 2020 2020  _usage()..      
+00012540: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00012550: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
+00012560: 655f 6669 6c65 2822 2166 6f6f 2162 6172  e_file("!foo!bar
+00012570: 222c 2073 745f 7369 7a65 3d31 3030 290a  ", st_size=100).
+00012580: 2020 2020 2020 2020 6578 6365 7074 204f          except O
+00012590: 5345 7272 6f72 3a0a 2020 2020 2020 2020  SError:.        
+000125a0: 2020 2020 7365 6c66 2e66 6169 6c28 2246      self.fail("F
+000125b0: 696c 6520 7769 7468 2073 697a 6520 6669  ile with size fi
+000125c0: 7474 696e 6720 696e 746f 2064 6973 6b20  tting into disk 
+000125d0: 7370 6163 6520 636f 756c 6420 6e6f 7420  space could not 
+000125e0: 6265 2077 7269 7474 656e 2e22 290a 0a20  be written.").. 
+000125f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00012600: 7274 4571 7561 6c28 696e 6974 6961 6c5f  rtEqual(initial_
+00012610: 7573 6167 652e 7573 6564 202b 2031 3030  usage.used + 100
+00012620: 2c20 7365 6c66 2e66 732e 6765 745f 6469  , self.fs.get_di
+00012630: 736b 5f75 7361 6765 2829 2e75 7365 6429  sk_usage().used)
+00012640: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
+00012650: 7265 6174 696e 675f 6669 6c65 5f77 6974  reating_file_wit
+00012660: 685f 7369 7a65 5f74 6f6f 5f6c 6172 6765  h_size_too_large
+00012670: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00012680: 696e 6974 6961 6c5f 7573 6167 6520 3d20  initial_usage = 
+00012690: 7365 6c66 2e66 732e 6765 745f 6469 736b  self.fs.get_disk
+000126a0: 5f75 7361 6765 2829 0a0a 2020 2020 2020  _usage()..      
+000126b0: 2020 6465 6620 6372 6561 7465 5f6c 6172    def create_lar
+000126c0: 6765 5f66 696c 6528 293a 0a20 2020 2020  ge_file():.     
+000126d0: 2020 2020 2020 2073 656c 662e 6673 2e63         self.fs.c
+000126e0: 7265 6174 655f 6669 6c65 2822 2166 6f6f  reate_file("!foo
+000126f0: 2162 6172 222c 2073 745f 7369 7a65 3d31  !bar", st_size=1
+00012700: 3031 290a 0a20 2020 2020 2020 2077 6974  01)..        wit
+00012710: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00012720: 7365 7328 4f53 4572 726f 7229 3a0a 2020  ses(OSError):.  
+00012730: 2020 2020 2020 2020 2020 6372 6561 7465            create
+00012740: 5f6c 6172 6765 5f66 696c 6528 290a 0a20  _large_file().. 
+00012750: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00012760: 7274 4571 7561 6c28 696e 6974 6961 6c5f  rtEqual(initial_
+00012770: 7573 6167 652c 2073 656c 662e 6673 2e67  usage, self.fs.g
+00012780: 6574 5f64 6973 6b5f 7573 6167 6528 2929  et_disk_usage())
+00012790: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
+000127a0: 6573 697a 655f 6669 6c65 5f77 6974 685f  esize_file_with_
+000127b0: 6669 7474 696e 675f 7369 7a65 2873 656c  fitting_size(sel
+000127c0: 6629 3a0a 2020 2020 2020 2020 6669 6c65  f):.        file
+000127d0: 5f6f 626a 6563 7420 3d20 7365 6c66 2e66  _object = self.f
+000127e0: 732e 6372 6561 7465 5f66 696c 6528 2221  s.create_file("!
+000127f0: 666f 6f21 6261 7222 2c20 7374 5f73 697a  foo!bar", st_siz
+00012800: 653d 3530 290a 2020 2020 2020 2020 7472  e=50).        tr
+00012810: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
+00012820: 696c 655f 6f62 6a65 6374 2e73 6574 5f6c  ile_object.set_l
+00012830: 6172 6765 5f66 696c 655f 7369 7a65 2831  arge_file_size(1
+00012840: 3030 290a 2020 2020 2020 2020 2020 2020  00).            
+00012850: 6669 6c65 5f6f 626a 6563 742e 7365 745f  file_object.set_
+00012860: 636f 6e74 656e 7473 2862 2261 2220 2a20  contents(b"a" * 
+00012870: 3130 3029 0a20 2020 2020 2020 2065 7863  100).        exc
+00012880: 6570 7420 4f53 4572 726f 723a 0a20 2020  ept OSError:.   
+00012890: 2020 2020 2020 2020 2073 656c 662e 6661           self.fa
+000128a0: 696c 2822 5265 7369 7a69 6e67 2066 696c  il("Resizing fil
+000128b0: 6520 6661 696c 6564 2061 6c74 686f 7567  e failed althoug
+000128c0: 6820 6469 736b 2073 7061 6365 2077 6173  h disk space was
+000128d0: 2073 7566 6669 6369 656e 742e 2229 0a0a   sufficient.")..
+000128e0: 2020 2020 6465 6620 7465 7374 5f72 6573      def test_res
+000128f0: 697a 655f 6669 6c65 5f77 6974 685f 7369  ize_file_with_si
+00012900: 7a65 5f74 6f6f 5f6c 6172 6765 2873 656c  ze_too_large(sel
+00012910: 6629 3a0a 2020 2020 2020 2020 6669 6c65  f):.        file
+00012920: 5f6f 626a 6563 7420 3d20 7365 6c66 2e66  _object = self.f
+00012930: 732e 6372 6561 7465 5f66 696c 6528 2221  s.create_file("!
+00012940: 666f 6f21 6261 7222 2c20 7374 5f73 697a  foo!bar", st_siz
+00012950: 653d 3530 290a 2020 2020 2020 2020 7769  e=50).        wi
+00012960: 7468 2073 656c 662e 7261 6973 6573 5f6f  th self.raises_o
+00012970: 735f 6572 726f 7228 6572 726e 6f2e 454e  s_error(errno.EN
+00012980: 4f53 5043 293a 0a20 2020 2020 2020 2020  OSPC):.         
+00012990: 2020 2066 696c 655f 6f62 6a65 6374 2e73     file_object.s
+000129a0: 6574 5f6c 6172 6765 5f66 696c 655f 7369  et_large_file_si
+000129b0: 7a65 2832 3030 290a 2020 2020 2020 2020  ze(200).        
+000129c0: 7769 7468 2073 656c 662e 7261 6973 6573  with self.raises
+000129d0: 5f6f 735f 6572 726f 7228 6572 726e 6f2e  _os_error(errno.
+000129e0: 454e 4f53 5043 293a 0a20 2020 2020 2020  ENOSPC):.       
+000129f0: 2020 2020 2066 696c 655f 6f62 6a65 6374       file_object
+00012a00: 2e73 6574 5f63 6f6e 7465 6e74 7328 2261  .set_contents("a
+00012a10: 2220 2a20 3135 3029 0a0a 2020 2020 6465  " * 150)..    de
+00012a20: 6620 7465 7374 5f66 696c 655f 7379 7374  f test_file_syst
+00012a30: 656d 5f73 697a 655f 6166 7465 725f 6469  em_size_after_di
+00012a40: 7265 6374 6f72 795f 7265 6e61 6d65 2873  rectory_rename(s
+00012a50: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+00012a60: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
+00012a70: 6528 2221 666f 6f21 6261 7222 2c20 7374  e("!foo!bar", st
+00012a80: 5f73 697a 653d 3230 290a 2020 2020 2020  _size=20).      
+00012a90: 2020 7365 6c66 2e6f 732e 7265 6e61 6d65    self.os.rename
+00012aa0: 2822 2166 6f6f 222c 2022 2162 617a 2229  ("!foo", "!baz")
+00012ab0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00012ac0: 7365 7274 4571 7561 6c28 3230 2c20 7365  sertEqual(20, se
+00012ad0: 6c66 2e66 732e 6765 745f 6469 736b 5f75  lf.fs.get_disk_u
+00012ae0: 7361 6765 2829 2e75 7365 6429 0a0a 2020  sage().used)..  
+00012af0: 2020 6465 6620 7465 7374 5f66 696c 655f    def test_file_
+00012b00: 7379 7374 656d 5f73 697a 655f 6166 7465  system_size_afte
+00012b10: 725f 6669 6c65 5f72 656e 616d 6528 7365  r_file_rename(se
+00012b20: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00012b30: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
+00012b40: 2822 2166 6f6f 2162 6172 222c 2073 745f  ("!foo!bar", st_
+00012b50: 7369 7a65 3d32 3029 0a20 2020 2020 2020  size=20).       
+00012b60: 2073 656c 662e 6f73 2e72 656e 616d 6528   self.os.rename(
+00012b70: 2221 666f 6f21 6261 7222 2c20 2221 666f  "!foo!bar", "!fo
+00012b80: 6f21 6261 7a22 290a 2020 2020 2020 2020  o!baz").        
+00012b90: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012ba0: 2832 302c 2073 656c 662e 6673 2e67 6574  (20, self.fs.get
+00012bb0: 5f64 6973 6b5f 7573 6167 6528 292e 7573  _disk_usage().us
+00012bc0: 6564 290a 0a20 2020 2064 6566 2074 6573  ed)..    def tes
+00012bd0: 745f 7468 6174 5f68 6172 645f 6c69 6e6b  t_that_hard_link
+00012be0: 5f64 6f65 735f 6e6f 745f 6368 616e 6765  _does_not_change
+00012bf0: 5f75 7365 645f 7369 7a65 2873 656c 6629  _used_size(self)
+00012c00: 3a0a 2020 2020 2020 2020 6669 6c65 315f  :.        file1_
+00012c10: 7061 7468 203d 2022 7465 7374 5f66 696c  path = "test_fil
+00012c20: 6531 220a 2020 2020 2020 2020 6669 6c65  e1".        file
+00012c30: 325f 7061 7468 203d 2022 7465 7374 5f66  2_path = "test_f
+00012c40: 696c 6532 220a 2020 2020 2020 2020 7365  ile2".        se
+00012c50: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
+00012c60: 6528 6669 6c65 315f 7061 7468 2c20 7374  e(file1_path, st
+00012c70: 5f73 697a 653d 3230 290a 2020 2020 2020  _size=20).      
+00012c80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00012c90: 616c 2832 302c 2073 656c 662e 6673 2e67  al(20, self.fs.g
+00012ca0: 6574 5f64 6973 6b5f 7573 6167 6528 292e  et_disk_usage().
+00012cb0: 7573 6564 290a 2020 2020 2020 2020 2320  used).        # 
+00012cc0: 6372 6561 7469 6e67 2061 2068 6172 6420  creating a hard 
+00012cd0: 6c69 6e6b 2073 6861 6c6c 206e 6f74 2069  link shall not i
+00012ce0: 6e63 7265 6173 6520 7573 6564 2073 7061  ncrease used spa
+00012cf0: 6365 0a20 2020 2020 2020 2073 656c 662e  ce.        self.
+00012d00: 6f73 2e6c 696e 6b28 6669 6c65 315f 7061  os.link(file1_pa
+00012d10: 7468 2c20 6669 6c65 325f 7061 7468 290a  th, file2_path).
+00012d20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00012d30: 6572 7445 7175 616c 2832 302c 2073 656c  ertEqual(20, sel
+00012d40: 662e 6673 2e67 6574 5f64 6973 6b5f 7573  f.fs.get_disk_us
+00012d50: 6167 6528 292e 7573 6564 290a 2020 2020  age().used).    
+00012d60: 2020 2020 2320 7265 6d6f 7669 6e67 2061      # removing a
+00012d70: 2066 696c 6520 7368 616c 6c20 6e6f 7420   file shall not 
+00012d80: 6465 6372 6561 7365 2075 7365 6420 7370  decrease used sp
+00012d90: 6163 650a 2020 2020 2020 2020 2320 6966  ace.        # if
+00012da0: 2061 2068 6172 6420 6c69 6e6b 2073 7469   a hard link sti
+00012db0: 6c6c 2065 7869 7374 730a 2020 2020 2020  ll exists.      
+00012dc0: 2020 7365 6c66 2e6f 732e 756e 6c69 6e6b    self.os.unlink
+00012dd0: 2866 696c 6531 5f70 6174 6829 0a20 2020  (file1_path).   
+00012de0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00012df0: 4571 7561 6c28 3230 2c20 7365 6c66 2e66  Equal(20, self.f
+00012e00: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
+00012e10: 2829 2e75 7365 6429 0a20 2020 2020 2020  ().used).       
+00012e20: 2073 656c 662e 6f73 2e75 6e6c 696e 6b28   self.os.unlink(
+00012e30: 6669 6c65 325f 7061 7468 290a 2020 2020  file2_path).    
+00012e40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00012e50: 7175 616c 2830 2c20 7365 6c66 2e66 732e  qual(0, self.fs.
+00012e60: 6765 745f 6469 736b 5f75 7361 6765 2829  get_disk_usage()
+00012e70: 2e75 7365 6429 0a0a 2020 2020 6465 6620  .used)..    def 
+00012e80: 7465 7374 5f74 6861 745f 7468 655f 7369  test_that_the_si
+00012e90: 7a65 5f6f 665f 636f 7272 6563 745f 6d6f  ze_of_correct_mo
+00012ea0: 756e 745f 706f 696e 745f 6973 5f75 7365  unt_point_is_use
+00012eb0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+00012ec0: 2073 656c 662e 6673 2e61 6464 5f6d 6f75   self.fs.add_mou
+00012ed0: 6e74 5f70 6f69 6e74 2822 216d 6f75 6e74  nt_point("!mount
+00012ee0: 5f6c 696d 6974 6564 222c 2074 6f74 616c  _limited", total
+00012ef0: 5f73 697a 653d 3530 290a 2020 2020 2020  _size=50).      
+00012f00: 2020 7365 6c66 2e66 732e 6164 645f 6d6f    self.fs.add_mo
+00012f10: 756e 745f 706f 696e 7428 2221 6d6f 756e  unt_point("!moun
+00012f20: 745f 756e 6c69 6d69 7465 6422 290a 0a20  t_unlimited").. 
+00012f30: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00012f40: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
+00012f50: 2865 7272 6e6f 2e45 4e4f 5350 4329 3a0a  (errno.ENOSPC):.
+00012f60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012f70: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
+00012f80: 2221 6d6f 756e 745f 6c69 6d69 7465 6421  "!mount_limited!
+00012f90: 666f 6f22 2c20 7374 5f73 697a 653d 3630  foo", st_size=60
+00012fa0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00012fb0: 656c 662e 7261 6973 6573 5f6f 735f 6572  elf.raises_os_er
+00012fc0: 726f 7228 6572 726e 6f2e 454e 4f53 5043  ror(errno.ENOSPC
+00012fd0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00012fe0: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
+00012ff0: 6c65 2822 2162 6172 222c 2073 745f 7369  le("!bar", st_si
+00013000: 7a65 3d31 3130 290a 0a20 2020 2020 2020  ze=110)..       
+00013010: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00013020: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
+00013030: 5f66 696c 6528 2221 666f 6f22 2c20 7374  _file("!foo", st
+00013040: 5f73 697a 653d 3630 290a 2020 2020 2020  _size=60).      
+00013050: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
+00013060: 6561 7465 5f66 696c 6528 2221 6d6f 756e  eate_file("!moun
+00013070: 745f 6c69 6d69 7465 6421 666f 6f22 2c20  t_limited!foo", 
+00013080: 7374 5f73 697a 653d 3430 290a 2020 2020  st_size=40).    
+00013090: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
+000130a0: 6372 6561 7465 5f66 696c 6528 2221 6d6f  create_file("!mo
+000130b0: 756e 745f 756e 6c69 6d69 7465 6421 666f  unt_unlimited!fo
+000130c0: 6f22 2c20 7374 5f73 697a 653d 3130 3030  o", st_size=1000
+000130d0: 3030 3029 0a20 2020 2020 2020 2065 7863  000).        exc
+000130e0: 6570 7420 4f53 4572 726f 723a 0a20 2020  ept OSError:.   
+000130f0: 2020 2020 2020 2020 2073 656c 662e 6661           self.fa
+00013100: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
+00013110: 2020 2020 2246 696c 6520 7769 7468 2063      "File with c
+00013120: 6f6e 7465 6e74 7320 6669 7474 696e 6720  ontents fitting 
+00013130: 696e 746f 2022 2022 6469 736b 2073 7061  into " "disk spa
+00013140: 6365 2063 6f75 6c64 206e 6f74 2062 6520  ce could not be 
+00013150: 7772 6974 7465 6e2e 220a 2020 2020 2020  written.".      
+00013160: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00013170: 2074 6573 745f 7468 6174 5f64 6973 6b5f   test_that_disk_
+00013180: 7573 6167 655f 6f66 5f63 6f72 7265 6374  usage_of_correct
+00013190: 5f6d 6f75 6e74 5f70 6f69 6e74 5f69 735f  _mount_point_is_
+000131a0: 7573 6564 2873 656c 6629 3a0a 2020 2020  used(self):.    
+000131b0: 2020 2020 7365 6c66 2e66 732e 6164 645f      self.fs.add_
+000131c0: 6d6f 756e 745f 706f 696e 7428 2221 6d6f  mount_point("!mo
+000131d0: 756e 7431 222c 2074 6f74 616c 5f73 697a  unt1", total_siz
+000131e0: 653d 3230 290a 2020 2020 2020 2020 7365  e=20).        se
+000131f0: 6c66 2e66 732e 6164 645f 6d6f 756e 745f  lf.fs.add_mount_
+00013200: 706f 696e 7428 2221 6d6f 756e 7431 2162  point("!mount1!b
+00013210: 6172 216d 6f75 6e74 3222 2c20 746f 7461  ar!mount2", tota
+00013220: 6c5f 7369 7a65 3d35 3029 0a0a 2020 2020  l_size=50)..    
+00013230: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
+00013240: 7465 5f66 696c 6528 2221 666f 6f21 6261  te_file("!foo!ba
+00013250: 7222 2c20 7374 5f73 697a 653d 3130 290a  r", st_size=10).
+00013260: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
+00013270: 6372 6561 7465 5f66 696c 6528 2221 6d6f  create_file("!mo
+00013280: 756e 7431 2166 6f6f 2162 6172 222c 2073  unt1!foo!bar", s
+00013290: 745f 7369 7a65 3d31 3029 0a20 2020 2020  t_size=10).     
+000132a0: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
+000132b0: 655f 6669 6c65 2822 216d 6f75 6e74 3121  e_file("!mount1!
+000132c0: 6261 7221 6d6f 756e 7432 2166 6f6f 2162  bar!mount2!foo!b
+000132d0: 6172 222c 2073 745f 7369 7a65 3d31 3029  ar", st_size=10)
+000132e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000132f0: 7373 6572 7445 7175 616c 2839 302c 2073  ssertEqual(90, s
+00013300: 656c 662e 6673 2e67 6574 5f64 6973 6b5f  elf.fs.get_disk_
+00013310: 7573 6167 6528 2221 666f 6f22 292e 6672  usage("!foo").fr
+00013320: 6565 290a 2020 2020 2020 2020 7365 6c66  ee).        self
+00013330: 2e61 7373 6572 7445 7175 616c 2831 302c  .assertEqual(10,
+00013340: 2073 656c 662e 6673 2e67 6574 5f64 6973   self.fs.get_dis
+00013350: 6b5f 7573 6167 6528 2221 6d6f 756e 7431  k_usage("!mount1
+00013360: 2166 6f6f 2229 2e66 7265 6529 0a20 2020  !foo").free).   
+00013370: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013380: 4571 7561 6c28 3430 2c20 7365 6c66 2e66  Equal(40, self.f
+00013390: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
+000133a0: 2822 216d 6f75 6e74 3121 6261 7221 6d6f  ("!mount1!bar!mo
+000133b0: 756e 7432 2229 2e66 7265 6529 0a0a 2020  unt2").free)..  
+000133c0: 2020 6465 6620 7465 7374 5f73 6574 5f6c    def test_set_l
+000133d0: 6172 6765 725f 6469 736b 5f73 697a 6528  arger_disk_size(
+000133e0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+000133f0: 656c 662e 6673 2e61 6464 5f6d 6f75 6e74  elf.fs.add_mount
+00013400: 5f70 6f69 6e74 2822 216d 6f75 6e74 3122  _point("!mount1"
+00013410: 2c20 746f 7461 6c5f 7369 7a65 3d32 3029  , total_size=20)
+00013420: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00013430: 6c66 2e72 6169 7365 735f 6f73 5f65 7272  lf.raises_os_err
+00013440: 6f72 2865 7272 6e6f 2e45 4e4f 5350 4329  or(errno.ENOSPC)
+00013450: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00013460: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
+00013470: 6528 2221 6d6f 756e 7431 2166 6f6f 222c  e("!mount1!foo",
+00013480: 2073 745f 7369 7a65 3d31 3030 290a 2020   st_size=100).  
+00013490: 2020 2020 2020 7365 6c66 2e66 732e 7365        self.fs.se
+000134a0: 745f 6469 736b 5f75 7361 6765 2874 6f74  t_disk_usage(tot
+000134b0: 616c 5f73 697a 653d 3230 302c 2070 6174  al_size=200, pat
+000134c0: 683d 2221 6d6f 756e 7431 2229 0a20 2020  h="!mount1").   
+000134d0: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
+000134e0: 6174 655f 6669 6c65 2822 216d 6f75 6e74  ate_file("!mount
+000134f0: 3121 666f 6f22 2c20 7374 5f73 697a 653d  1!foo", st_size=
+00013500: 3130 3029 0a20 2020 2020 2020 2073 656c  100).        sel
+00013510: 662e 6173 7365 7274 4571 7561 6c28 3130  f.assertEqual(10
+00013520: 302c 2073 656c 662e 6673 2e67 6574 5f64  0, self.fs.get_d
+00013530: 6973 6b5f 7573 6167 6528 2221 6d6f 756e  isk_usage("!moun
+00013540: 7431 2166 6f6f 2229 2e66 7265 6529 0a0a  t1!foo").free)..
+00013550: 2020 2020 6465 6620 7465 7374 5f73 6574      def test_set
+00013560: 5f73 6d61 6c6c 6572 5f64 6973 6b5f 7369  _smaller_disk_si
+00013570: 7a65 2873 656c 6629 3a0a 2020 2020 2020  ze(self):.      
+00013580: 2020 7365 6c66 2e66 732e 6164 645f 6d6f    self.fs.add_mo
+00013590: 756e 745f 706f 696e 7428 2221 6d6f 756e  unt_point("!moun
+000135a0: 7431 222c 2074 6f74 616c 5f73 697a 653d  t1", total_size=
+000135b0: 3230 3029 0a20 2020 2020 2020 2073 656c  200).        sel
+000135c0: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
+000135d0: 2822 216d 6f75 6e74 3121 666f 6f22 2c20  ("!mount1!foo", 
+000135e0: 7374 5f73 697a 653d 3130 3029 0a20 2020  st_size=100).   
+000135f0: 2020 2020 2077 6974 6820 7365 6c66 2e72       with self.r
+00013600: 6169 7365 735f 6f73 5f65 7272 6f72 2865  aises_os_error(e
+00013610: 7272 6e6f 2e45 4e4f 5350 4329 3a0a 2020  rrno.ENOSPC):.  
+00013620: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+00013630: 732e 7365 745f 6469 736b 5f75 7361 6765  s.set_disk_usage
+00013640: 2874 6f74 616c 5f73 697a 653d 3530 2c20  (total_size=50, 
+00013650: 7061 7468 3d22 216d 6f75 6e74 3122 290a  path="!mount1").
+00013660: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
+00013670: 7365 745f 6469 736b 5f75 7361 6765 2874  set_disk_usage(t
+00013680: 6f74 616c 5f73 697a 653d 3135 302c 2070  otal_size=150, p
+00013690: 6174 683d 2221 6d6f 756e 7431 2229 0a20  ath="!mount1"). 
+000136a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000136b0: 7274 4571 7561 6c28 3530 2c20 7365 6c66  rtEqual(50, self
+000136c0: 2e66 732e 6765 745f 6469 736b 5f75 7361  .fs.get_disk_usa
+000136d0: 6765 2822 216d 6f75 6e74 3121 666f 6f22  ge("!mount1!foo"
+000136e0: 292e 6672 6565 290a 0a20 2020 2064 6566  ).free)..    def
+000136f0: 2074 6573 745f 6469 736b 5f73 697a 655f   test_disk_size_
+00013700: 6f6e 5f75 6e6c 696d 6974 6564 5f64 6973  on_unlimited_dis
+00013710: 6b28 7365 6c66 293a 0a20 2020 2020 2020  k(self):.       
+00013720: 2073 656c 662e 6673 2e61 6464 5f6d 6f75   self.fs.add_mou
+00013730: 6e74 5f70 6f69 6e74 2822 216d 6f75 6e74  nt_point("!mount
+00013740: 3122 290a 2020 2020 2020 2020 7365 6c66  1").        self
+00013750: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
+00013760: 2221 6d6f 756e 7431 2166 6f6f 222c 2073  "!mount1!foo", s
+00013770: 745f 7369 7a65 3d31 3030 290a 2020 2020  t_size=100).    
+00013780: 2020 2020 7365 6c66 2e66 732e 7365 745f      self.fs.set_
+00013790: 6469 736b 5f75 7361 6765 2874 6f74 616c  disk_usage(total
+000137a0: 5f73 697a 653d 3130 3030 2c20 7061 7468  _size=1000, path
+000137b0: 3d22 216d 6f75 6e74 3122 290a 2020 2020  ="!mount1").    
+000137c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000137d0: 7175 616c 2839 3030 2c20 7365 6c66 2e66  qual(900, self.f
+000137e0: 732e 6765 745f 6469 736b 5f75 7361 6765  s.get_disk_usage
+000137f0: 2822 216d 6f75 6e74 3121 666f 6f22 292e  ("!mount1!foo").
+00013800: 6672 6565 290a 0a20 2020 2064 6566 2074  free)..    def t
+00013810: 6573 745f 6469 736b 5f73 697a 655f 6f6e  est_disk_size_on
+00013820: 5f61 7574 6f5f 6d6f 756e 7465 645f 6472  _auto_mounted_dr
+00013830: 6976 655f 6f6e 5f66 696c 655f 6372 6561  ive_on_file_crea
+00013840: 7469 6f6e 2873 656c 6629 3a0a 2020 2020  tion(self):.    
+00013850: 2020 2020 7365 6c66 2e66 732e 6973 5f77      self.fs.is_w
+00013860: 696e 646f 7773 5f66 7320 3d20 5472 7565  indows_fs = True
+00013870: 0a20 2020 2020 2020 2023 2064 7269 7665  .        # drive
+00013880: 2064 3a20 7368 616c 6c20 6265 2061 7574   d: shall be aut
+00013890: 6f2d 6d6f 756e 7465 6420 616e 6420 7468  o-mounted and th
+000138a0: 6520 7573 6564 2073 697a 6520 6164 6170  e used size adap
+000138b0: 7465 640a 2020 2020 2020 2020 7365 6c66  ted.        self
+000138c0: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
+000138d0: 2264 3a21 666f 6f21 6261 7222 2c20 7374  "d:!foo!bar", st
+000138e0: 5f73 697a 653d 3130 3029 0a20 2020 2020  _size=100).     
+000138f0: 2020 2073 656c 662e 6673 2e73 6574 5f64     self.fs.set_d
+00013900: 6973 6b5f 7573 6167 6528 746f 7461 6c5f  isk_usage(total_
+00013910: 7369 7a65 3d31 3030 302c 2070 6174 683d  size=1000, path=
+00013920: 2264 3a22 290a 2020 2020 2020 2020 7365  "d:").        se
+00013930: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00013940: 656c 662e 6673 2e67 6574 5f64 6973 6b5f  elf.fs.get_disk_
+00013950: 7573 6167 6528 2264 3a21 666f 6f22 292e  usage("d:!foo").
+00013960: 6672 6565 2c20 3930 3029 0a0a 2020 2020  free, 900)..    
+00013970: 6465 6620 7465 7374 5f64 6973 6b5f 7369  def test_disk_si
+00013980: 7a65 5f6f 6e5f 6175 746f 5f6d 6f75 6e74  ze_on_auto_mount
+00013990: 6564 5f64 7269 7665 5f6f 6e5f 6469 7265  ed_drive_on_dire
+000139a0: 6374 6f72 795f 6372 6561 7469 6f6e 2873  ctory_creation(s
+000139b0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+000139c0: 6c66 2e66 732e 6973 5f77 696e 646f 7773  lf.fs.is_windows
+000139d0: 5f66 7320 3d20 5472 7565 0a20 2020 2020  _fs = True.     
+000139e0: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
+000139f0: 655f 6469 7228 2264 3a21 666f 6f21 6261  e_dir("d:!foo!ba
+00013a00: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
+00013a10: 2e66 732e 6372 6561 7465 5f66 696c 6528  .fs.create_file(
+00013a20: 2264 3a21 666f 6f21 6261 7221 6261 7a22  "d:!foo!bar!baz"
+00013a30: 2c20 7374 5f73 697a 653d 3130 3029 0a20  , st_size=100). 
+00013a40: 2020 2020 2020 2073 656c 662e 6673 2e63         self.fs.c
+00013a50: 7265 6174 655f 6669 6c65 2822 643a 2166  reate_file("d:!f
+00013a60: 6f6f 2162 617a 222c 2073 745f 7369 7a65  oo!baz", st_size
+00013a70: 3d31 3030 290a 2020 2020 2020 2020 7365  =100).        se
+00013a80: 6c66 2e66 732e 7365 745f 6469 736b 5f75  lf.fs.set_disk_u
+00013a90: 7361 6765 2874 6f74 616c 5f73 697a 653d  sage(total_size=
+00013aa0: 3130 3030 2c20 7061 7468 3d22 643a 2229  1000, path="d:")
+00013ab0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00013ac0: 7365 7274 4571 7561 6c28 3830 302c 2073  sertEqual(800, s
+00013ad0: 656c 662e 6673 2e67 6574 5f64 6973 6b5f  elf.fs.get_disk_
+00013ae0: 7573 6167 6528 2264 3a21 666f 6f22 292e  usage("d:!foo").
+00013af0: 6672 6565 290a 0a20 2020 2064 6566 2074  free)..    def t
+00013b00: 6573 745f 636f 7079 696e 675f 7072 6573  est_copying_pres
+00013b10: 6572 7665 735f 6279 7465 5f63 6f6e 7465  erves_byte_conte
+00013b20: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
+00013b30: 2020 2073 6f75 7263 655f 6669 6c65 203d     source_file =
+00013b40: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
+00013b50: 6669 6c65 2822 666f 6f22 2c20 636f 6e74  file("foo", cont
+00013b60: 656e 7473 3d62 2273 6f6d 6562 7974 6573  ents=b"somebytes
+00013b70: 2229 0a20 2020 2020 2020 2064 6573 745f  ").        dest_
+00013b80: 6669 6c65 203d 2073 656c 662e 6673 2e63  file = self.fs.c
+00013b90: 7265 6174 655f 6669 6c65 2822 6261 7222  reate_file("bar"
+00013ba0: 290a 2020 2020 2020 2020 6465 7374 5f66  ).        dest_f
+00013bb0: 696c 652e 7365 745f 636f 6e74 656e 7473  ile.set_contents
+00013bc0: 2873 6f75 7263 655f 6669 6c65 2e63 6f6e  (source_file.con
+00013bd0: 7465 6e74 7329 0a20 2020 2020 2020 2073  tents).        s
+00013be0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00013bf0: 6465 7374 5f66 696c 652e 636f 6e74 656e  dest_file.conten
+00013c00: 7473 2c20 736f 7572 6365 5f66 696c 652e  ts, source_file.
+00013c10: 636f 6e74 656e 7473 290a 0a20 2020 2064  contents)..    d
+00013c20: 6566 2074 6573 745f 6469 736b 7573 6167  ef test_diskusag
+00013c30: 655f 6166 7465 725f 6f70 656e 5f77 7269  e_after_open_wri
+00013c40: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00013c50: 2020 7769 7468 2073 656c 662e 6f70 656e    with self.open
+00013c60: 2822 6261 722e 7478 7422 2c20 2277 222c  ("bar.txt", "w",
+00013c70: 2065 6e63 6f64 696e 673d 2275 7466 3822   encoding="utf8"
+00013c80: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00013c90: 2020 2020 662e 7772 6974 6528 2261 2220      f.write("a" 
+00013ca0: 2a20 3630 290a 2020 2020 2020 2020 2020  * 60).          
+00013cb0: 2020 662e 666c 7573 6828 290a 2020 2020    f.flush().    
+00013cc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013cd0: 7175 616c 2836 302c 2073 656c 662e 6673  qual(60, self.fs
+00013ce0: 2e67 6574 5f64 6973 6b5f 7573 6167 6528  .get_disk_usage(
+00013cf0: 295b 315d 290a 0a20 2020 2064 6566 2074  )[1])..    def t
+00013d00: 6573 745f 6469 736b 5f66 756c 6c5f 6166  est_disk_full_af
+00013d10: 7465 725f 7265 6f70 656e 6564 2873 656c  ter_reopened(sel
+00013d20: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+00013d30: 2073 656c 662e 6f70 656e 2822 6261 722e   self.open("bar.
+00013d40: 7478 7422 2c20 2277 222c 2065 6e63 6f64  txt", "w", encod
+00013d50: 696e 673d 2275 7466 3822 2920 6173 2066  ing="utf8") as f
+00013d60: 3a0a 2020 2020 2020 2020 2020 2020 662e  :.            f.
+00013d70: 7772 6974 6528 2261 2220 2a20 3630 290a  write("a" * 60).
+00013d80: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00013d90: 662e 6f70 656e 2822 6261 722e 7478 7422  f.open("bar.txt"
+00013da0: 2c20 656e 636f 6469 6e67 3d22 7574 6638  , encoding="utf8
+00013db0: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
+00013dc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013dd0: 4571 7561 6c28 2261 2220 2a20 3630 2c20  Equal("a" * 60, 
+00013de0: 662e 7265 6164 2829 290a 2020 2020 2020  f.read()).      
+00013df0: 2020 7769 7468 2073 656c 662e 7261 6973    with self.rais
+00013e00: 6573 5f6f 735f 6572 726f 7228 6572 726e  es_os_error(errn
+00013e10: 6f2e 454e 4f53 5043 293a 0a20 2020 2020  o.ENOSPC):.     
+00013e20: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00013e30: 2e6f 7065 6e28 2262 6172 2e74 7874 222c  .open("bar.txt",
+00013e40: 2022 7722 2c20 656e 636f 6469 6e67 3d22   "w", encoding="
+00013e50: 7574 6638 2229 2061 7320 663a 0a20 2020  utf8") as f:.   
+00013e60: 2020 2020 2020 2020 2020 2020 2066 2e77               f.w
+00013e70: 7269 7465 2822 6222 202a 2031 3130 290a  rite("b" * 110).
+00013e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e90: 7769 7468 2073 656c 662e 7261 6973 6573  with self.raises
+00013ea0: 5f6f 735f 6572 726f 7228 6572 726e 6f2e  _os_error(errno.
+00013eb0: 454e 4f53 5043 293a 0a20 2020 2020 2020  ENOSPC):.       
+00013ec0: 2020 2020 2020 2020 2020 2020 2066 2e66               f.f
+00013ed0: 6c75 7368 2829 0a20 2020 2020 2020 2077  lush().        w
+00013ee0: 6974 6820 7365 6c66 2e6f 7065 6e28 2262  ith self.open("b
+00013ef0: 6172 2e74 7874 222c 2065 6e63 6f64 696e  ar.txt", encodin
+00013f00: 673d 2275 7466 3822 2920 6173 2066 3a0a  g="utf8") as f:.
+00013f10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00013f20: 2e61 7373 6572 7445 7175 616c 2822 222c  .assertEqual("",
+00013f30: 2066 2e72 6561 6428 2929 0a0a 2020 2020   f.read())..    
+00013f40: 6465 6620 7465 7374 5f64 6973 6b5f 6675  def test_disk_fu
+00013f50: 6c6c 5f61 7070 656e 6428 7365 6c66 293a  ll_append(self):
+00013f60: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+00013f70: 7468 203d 2022 6261 722e 7478 7422 0a20  th = "bar.txt". 
+00013f80: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00013f90: 2e6f 7065 6e28 6669 6c65 5f70 6174 682c  .open(file_path,
+00013fa0: 2022 7722 2c20 656e 636f 6469 6e67 3d22   "w", encoding="
+00013fb0: 7574 6638 2229 2061 7320 663a 0a20 2020  utf8") as f:.   
+00013fc0: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
+00013fd0: 2822 6122 202a 2036 3029 0a20 2020 2020  ("a" * 60).     
+00013fe0: 2020 2077 6974 6820 7365 6c66 2e6f 7065     with self.ope
+00013ff0: 6e28 6669 6c65 5f70 6174 682c 2065 6e63  n(file_path, enc
+00014000: 6f64 696e 673d 2275 7466 3822 2920 6173  oding="utf8") as
+00014010: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00014020: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00014030: 2822 6122 202a 2036 302c 2066 2e72 6561  ("a" * 60, f.rea
+00014040: 6428 2929 0a20 2020 2020 2020 2077 6974  d()).        wit
+00014050: 6820 7365 6c66 2e72 6169 7365 735f 6f73  h self.raises_os
+00014060: 5f65 7272 6f72 2865 7272 6e6f 2e45 4e4f  _error(errno.ENO
+00014070: 5350 4329 3a0a 2020 2020 2020 2020 2020  SPC):.          
+00014080: 2020 7769 7468 2073 656c 662e 6f70 656e    with self.open
+00014090: 2866 696c 655f 7061 7468 2c20 2261 222c  (file_path, "a",
+000140a0: 2065 6e63 6f64 696e 673d 2275 7466 3822   encoding="utf8"
+000140b0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+000140c0: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
+000140d0: 2262 2220 2a20 3431 290a 2020 2020 2020  "b" * 41).      
+000140e0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+000140f0: 656c 662e 7261 6973 6573 5f6f 735f 6572  elf.raises_os_er
+00014100: 726f 7228 6572 726e 6f2e 454e 4f53 5043  ror(errno.ENOSPC
+00014110: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00014120: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
+00014130: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00014140: 6c66 2e6f 7065 6e28 2262 6172 2e74 7874  lf.open("bar.txt
+00014150: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
+00014160: 3822 2920 6173 2066 3a0a 2020 2020 2020  8") as f:.      
+00014170: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014180: 7445 7175 616c 2866 2e72 6561 6428 292c  tEqual(f.read(),
+00014190: 2022 6122 202a 2036 3029 0a0a 2020 2020   "a" * 60)..    
+000141a0: 6465 6620 7465 7374 5f64 6973 6b5f 6675  def test_disk_fu
+000141b0: 6c6c 5f61 6674 6572 5f72 656f 7065 6e65  ll_after_reopene
+000141c0: 645f 7270 6c75 735f 7365 656b 2873 656c  d_rplus_seek(sel
+000141d0: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+000141e0: 2073 656c 662e 6f70 656e 2822 6261 722e   self.open("bar.
+000141f0: 7478 7422 2c20 2277 222c 2065 6e63 6f64  txt", "w", encod
+00014200: 696e 673d 2275 7466 3822 2920 6173 2066  ing="utf8") as f
+00014210: 3a0a 2020 2020 2020 2020 2020 2020 662e  :.            f.
+00014220: 7772 6974 6528 2261 2220 2a20 3630 290a  write("a" * 60).
+00014230: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00014240: 662e 6f70 656e 2822 6261 722e 7478 7422  f.open("bar.txt"
+00014250: 2c20 656e 636f 6469 6e67 3d22 7574 6638  , encoding="utf8
+00014260: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
+00014270: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00014280: 4571 7561 6c28 662e 7265 6164 2829 2c20  Equal(f.read(), 
+00014290: 2261 2220 2a20 3630 290a 2020 2020 2020  "a" * 60).      
+000142a0: 2020 7769 7468 2073 656c 662e 7261 6973    with self.rais
+000142b0: 6573 5f6f 735f 6572 726f 7228 6572 726e  es_os_error(errn
+000142c0: 6f2e 454e 4f53 5043 293a 0a20 2020 2020  o.ENOSPC):.     
+000142d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000142e0: 2e6f 7065 6e28 2262 6172 2e74 7874 222c  .open("bar.txt",
+000142f0: 2022 722b 222c 2065 6e63 6f64 696e 673d   "r+", encoding=
+00014300: 2275 7466 3822 2920 6173 2066 3a0a 2020  "utf8") as f:.  
+00014310: 2020 2020 2020 2020 2020 2020 2020 662e                f.
+00014320: 7365 656b 2835 3029 0a20 2020 2020 2020  seek(50).       
+00014330: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
+00014340: 2822 6222 202a 2036 3029 0a20 2020 2020  ("b" * 60).     
+00014350: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00014360: 7365 6c66 2e72 6169 7365 735f 6f73 5f65  self.raises_os_e
+00014370: 7272 6f72 2865 7272 6e6f 2e45 4e4f 5350  rror(errno.ENOSP
+00014380: 4329 3a0a 2020 2020 2020 2020 2020 2020  C):.            
+00014390: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+000143a0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000143b0: 656c 662e 6f70 656e 2822 6261 722e 7478  elf.open("bar.tx
+000143c0: 7422 2c20 656e 636f 6469 6e67 3d22 7574  t", encoding="ut
+000143d0: 6638 2229 2061 7320 663a 0a20 2020 2020  f8") as f:.     
+000143e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000143f0: 7274 4571 7561 6c28 662e 7265 6164 2829  rtEqual(f.read()
+00014400: 2c20 2261 2220 2a20 3630 290a 0a0a 636c  , "a" * 60)...cl
+00014410: 6173 7320 4d6f 756e 7450 6f69 6e74 5465  ass MountPointTe
+00014420: 7374 2854 6573 7443 6173 6529 3a0a 2020  st(TestCase):.  
+00014430: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
+00014440: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00014450: 6669 6c65 7379 7374 656d 203d 2066 616b  filesystem = fak
+00014460: 655f 6669 6c65 7379 7374 656d 2e46 616b  e_filesystem.Fak
+00014470: 6546 696c 6573 7973 7465 6d28 0a20 2020  eFilesystem(.   
+00014480: 2020 2020 2020 2020 2070 6174 685f 7365           path_se
+00014490: 7061 7261 746f 723d 2221 222c 2074 6f74  parator="!", tot
+000144a0: 616c 5f73 697a 653d 3130 300a 2020 2020  al_size=100.    
+000144b0: 2020 2020 290a 0a20 2020 2064 6566 2061      )..    def a
+000144c0: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 7328  dd_mount_points(
+000144d0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+000144e0: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
+000144f0: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 2822  dd_mount_point("
+00014500: 2166 6f6f 2229 0a20 2020 2020 2020 2073  !foo").        s
+00014510: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
+00014520: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 2822  dd_mount_point("
+00014530: 2162 6172 2229 0a20 2020 2020 2020 2073  !bar").        s
+00014540: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
+00014550: 6464 5f6d 6f75 6e74 5f70 6f69 6e74 2822  dd_mount_point("
+00014560: 2166 6f6f 2162 617a 2229 0a0a 2020 2020  !foo!baz")..    
+00014570: 6465 6620 7465 7374 5f74 6861 745f 6e65  def test_that_ne
+00014580: 775f 6d6f 756e 745f 706f 696e 7473 5f67  w_mount_points_g
+00014590: 6574 5f6e 6577 5f64 6576 6963 655f 6e75  et_new_device_nu
+000145a0: 6d62 6572 2873 656c 6629 3a0a 2020 2020  mber(self):.    
+000145b0: 2020 2020 7365 6c66 2e61 6464 5f6d 6f75      self.add_mou
+000145c0: 6e74 5f70 6f69 6e74 7328 290a 2020 2020  nt_points().    
+000145d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000145e0: 7175 616c 2831 2c20 7365 6c66 2e66 696c  qual(1, self.fil
+000145f0: 6573 7973 7465 6d2e 6765 745f 6f62 6a65  esystem.get_obje
+00014600: 6374 2822 2122 292e 7374 5f64 6576 290a  ct("!").st_dev).
+00014610: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00014620: 6572 7445 7175 616c 2832 2c20 7365 6c66  ertEqual(2, self
+00014630: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
+00014640: 6f62 6a65 6374 2822 2166 6f6f 2229 2e73  object("!foo").s
+00014650: 745f 6465 7629 0a20 2020 2020 2020 2073  t_dev).        s
+00014660: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00014670: 332c 2073 656c 662e 6669 6c65 7379 7374  3, self.filesyst
+00014680: 656d 2e67 6574 5f6f 626a 6563 7428 2221  em.get_object("!
+00014690: 6261 7222 292e 7374 5f64 6576 290a 2020  bar").st_dev).  
+000146a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000146b0: 7445 7175 616c 2834 2c20 7365 6c66 2e66  tEqual(4, self.f
+000146c0: 696c 6573 7973 7465 6d2e 6765 745f 6f62  ilesystem.get_ob
+000146d0: 6a65 6374 2822 2166 6f6f 2162 617a 2229  ject("!foo!baz")
+000146e0: 2e73 745f 6465 7629 0a0a 2020 2020 6465  .st_dev)..    de
+000146f0: 6620 7465 7374 5f74 6861 745f 6e65 775f  f test_that_new_
+00014700: 6469 7265 6374 6f72 6965 735f 6765 745f  directories_get_
+00014710: 636f 7272 6563 745f 6465 7669 6365 5f6e  correct_device_n
+00014720: 756d 6265 7228 7365 6c66 293a 0a20 2020  umber(self):.   
+00014730: 2020 2020 2073 656c 662e 6164 645f 6d6f       self.add_mo
+00014740: 756e 745f 706f 696e 7473 2829 0a20 2020  unt_points().   
+00014750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00014760: 4571 7561 6c28 312c 2073 656c 662e 6669  Equal(1, self.fi
+00014770: 6c65 7379 7374 656d 2e63 7265 6174 655f  lesystem.create_
+00014780: 6469 7228 2221 666f 6f31 2162 6172 2229  dir("!foo1!bar")
+00014790: 2e73 745f 6465 7629 0a20 2020 2020 2020  .st_dev).       
+000147a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000147b0: 6c28 322c 2073 656c 662e 6669 6c65 7379  l(2, self.filesy
+000147c0: 7374 656d 2e63 7265 6174 655f 6469 7228  stem.create_dir(
+000147d0: 2221 666f 6f21 6261 7222 292e 7374 5f64  "!foo!bar").st_d
+000147e0: 6576 290a 2020 2020 2020 2020 7365 6c66  ev).        self
+000147f0: 2e61 7373 6572 7445 7175 616c 2834 2c20  .assertEqual(4, 
+00014800: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00014810: 6372 6561 7465 5f64 6972 2822 2166 6f6f  create_dir("!foo
+00014820: 2162 617a 2166 6f6f 2162 6172 2229 2e73  !baz!foo!bar").s
+00014830: 745f 6465 7629 0a0a 2020 2020 6465 6620  t_dev)..    def 
+00014840: 7465 7374 5f74 6861 745f 6e65 775f 6669  test_that_new_fi
+00014850: 6c65 735f 6765 745f 636f 7272 6563 745f  les_get_correct_
+00014860: 6465 7669 6365 5f6e 756d 6265 7228 7365  device_number(se
+00014870: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00014880: 662e 6164 645f 6d6f 756e 745f 706f 696e  f.add_mount_poin
+00014890: 7473 2829 0a20 2020 2020 2020 2073 656c  ts().        sel
+000148a0: 662e 6173 7365 7274 4571 7561 6c28 312c  f.assertEqual(1,
+000148b0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+000148c0: 2e63 7265 6174 655f 6669 6c65 2822 2166  .create_file("!f
+000148d0: 6f6f 3121 6261 7222 292e 7374 5f64 6576  oo1!bar").st_dev
+000148e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000148f0: 7373 6572 7445 7175 616c 2832 2c20 7365  ssertEqual(2, se
+00014900: 6c66 2e66 696c 6573 7973 7465 6d2e 6372  lf.filesystem.cr
+00014910: 6561 7465 5f66 696c 6528 2221 666f 6f21  eate_file("!foo!
+00014920: 6261 7222 292e 7374 5f64 6576 290a 2020  bar").st_dev).  
+00014930: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014940: 7445 7175 616c 2834 2c20 7365 6c66 2e66  tEqual(4, self.f
+00014950: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+00014960: 5f66 696c 6528 2221 666f 6f21 6261 7a21  _file("!foo!baz!
+00014970: 666f 6f21 6261 7222 292e 7374 5f64 6576  foo!bar").st_dev
+00014980: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00014990: 7468 6174 5f6d 6f75 6e74 5f70 6f69 6e74  that_mount_point
+000149a0: 5f63 616e 6e6f 745f 6265 5f61 6464 6564  _cannot_be_added
+000149b0: 5f74 7769 6365 2873 656c 6629 3a0a 2020  _twice(self):.  
+000149c0: 2020 2020 2020 7365 6c66 2e61 6464 5f6d        self.add_m
+000149d0: 6f75 6e74 5f70 6f69 6e74 7328 290a 2020  ount_points().  
+000149e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000149f0: 7261 6973 6573 5f6f 735f 6572 726f 7228  raises_os_error(
+00014a00: 6572 726e 6f2e 4545 5849 5354 293a 0a20  errno.EEXIST):. 
+00014a10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00014a20: 6669 6c65 7379 7374 656d 2e61 6464 5f6d  filesystem.add_m
+00014a30: 6f75 6e74 5f70 6f69 6e74 2822 2166 6f6f  ount_point("!foo
+00014a40: 2229 0a20 2020 2020 2020 2077 6974 6820  ").        with 
+00014a50: 7365 6c66 2e72 6169 7365 735f 6f73 5f65  self.raises_os_e
+00014a60: 7272 6f72 2865 7272 6e6f 2e45 4558 4953  rror(errno.EEXIS
+00014a70: 5429 3a0a 2020 2020 2020 2020 2020 2020  T):.            
+00014a80: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00014a90: 6164 645f 6d6f 756e 745f 706f 696e 7428  add_mount_point(
+00014aa0: 2221 666f 6f21 2229 0a0a 2020 2020 6465  "!foo!")..    de
+00014ab0: 6620 7465 7374 5f74 6861 745f 6472 6976  f test_that_driv
+00014ac0: 6573 5f61 7265 5f61 7574 6f5f 6d6f 756e  es_are_auto_moun
+00014ad0: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
+00014ae0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00014af0: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
+00014b00: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00014b10: 7365 6c66 2e61 6464 5f6d 6f75 6e74 5f70  self.add_mount_p
+00014b20: 6f69 6e74 7328 290a 2020 2020 2020 2020  oints().        
+00014b30: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00014b40: 6372 6561 7465 5f64 6972 2822 643a 2166  create_dir("d:!f
+00014b50: 6f6f 2162 6172 2229 0a20 2020 2020 2020  oo!bar").       
+00014b60: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00014b70: 2e63 7265 6174 655f 6669 6c65 2822 643a  .create_file("d:
+00014b80: 2166 6f6f 2162 617a 2229 0a20 2020 2020  !foo!baz").     
+00014b90: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00014ba0: 656d 2e63 7265 6174 655f 6669 6c65 2822  em.create_file("
+00014bb0: 7a3a 2166 6f6f 2162 617a 2229 0a20 2020  z:!foo!baz").   
+00014bc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00014bd0: 4571 7561 6c28 352c 2073 656c 662e 6669  Equal(5, self.fi
+00014be0: 6c65 7379 7374 656d 2e67 6574 5f6f 626a  lesystem.get_obj
+00014bf0: 6563 7428 2264 3a22 292e 7374 5f64 6576  ect("d:").st_dev
+00014c00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00014c10: 7373 6572 7445 7175 616c 2835 2c20 7365  ssertEqual(5, se
+00014c20: 6c66 2e66 696c 6573 7973 7465 6d2e 6765  lf.filesystem.ge
+00014c30: 745f 6f62 6a65 6374 2822 643a 2166 6f6f  t_object("d:!foo
+00014c40: 2162 6172 2229 2e73 745f 6465 7629 0a20  !bar").st_dev). 
+00014c50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00014c60: 7274 4571 7561 6c28 352c 2073 656c 662e  rtEqual(5, self.
+00014c70: 6669 6c65 7379 7374 656d 2e67 6574 5f6f  filesystem.get_o
+00014c80: 626a 6563 7428 2264 3a21 666f 6f21 6261  bject("d:!foo!ba
+00014c90: 7a22 292e 7374 5f64 6576 290a 2020 2020  z").st_dev).    
+00014ca0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00014cb0: 7175 616c 2836 2c20 7365 6c66 2e66 696c  qual(6, self.fil
+00014cc0: 6573 7973 7465 6d2e 6765 745f 6f62 6a65  esystem.get_obje
+00014cd0: 6374 2822 7a3a 2166 6f6f 2162 617a 2229  ct("z:!foo!baz")
+00014ce0: 2e73 745f 6465 7629 0a0a 2020 2020 6465  .st_dev)..    de
+00014cf0: 6620 7465 7374 5f74 6861 745f 6472 6976  f test_that_driv
+00014d00: 6573 5f61 7265 5f61 7574 6f5f 6d6f 756e  es_are_auto_moun
+00014d10: 7465 645f 6361 7365 5f69 6e73 656e 7369  ted_case_insensi
+00014d20: 7469 7665 2873 656c 6629 3a0a 2020 2020  tive(self):.    
+00014d30: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00014d40: 7465 6d2e 6973 5f77 696e 646f 7773 5f66  tem.is_windows_f
+00014d50: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
+00014d60: 2073 656c 662e 6164 645f 6d6f 756e 745f   self.add_mount_
+00014d70: 706f 696e 7473 2829 0a20 2020 2020 2020  points().       
+00014d80: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00014d90: 2e69 735f 6361 7365 5f73 656e 7369 7469  .is_case_sensiti
+00014da0: 7665 203d 2046 616c 7365 0a20 2020 2020  ve = False.     
+00014db0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00014dc0: 656d 2e63 7265 6174 655f 6469 7228 2244  em.create_dir("D
+00014dd0: 3a21 666f 6f21 6261 7222 290a 2020 2020  :!foo!bar").    
+00014de0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00014df0: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
+00014e00: 2265 3a21 666f 6f21 6261 7a22 290a 2020  "e:!foo!baz").  
+00014e10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00014e20: 7445 7175 616c 2835 2c20 7365 6c66 2e66  tEqual(5, self.f
+00014e30: 696c 6573 7973 7465 6d2e 6765 745f 6f62  ilesystem.get_ob
+00014e40: 6a65 6374 2822 443a 2229 2e73 745f 6465  ject("D:").st_de
+00014e50: 7629 0a20 2020 2020 2020 2073 656c 662e  v).        self.
+00014e60: 6173 7365 7274 4571 7561 6c28 352c 2073  assertEqual(5, s
+00014e70: 656c 662e 6669 6c65 7379 7374 656d 2e67  elf.filesystem.g
+00014e80: 6574 5f6f 626a 6563 7428 2264 3a21 666f  et_object("d:!fo
+00014e90: 6f21 6261 7222 292e 7374 5f64 6576 290a  o!bar").st_dev).
+00014ea0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00014eb0: 6572 7445 7175 616c 2836 2c20 7365 6c66  ertEqual(6, self
+00014ec0: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
+00014ed0: 6f62 6a65 6374 2822 653a 2166 6f6f 2229  object("e:!foo")
+00014ee0: 2e73 745f 6465 7629 0a20 2020 2020 2020  .st_dev).       
+00014ef0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00014f00: 6c28 362c 2073 656c 662e 6669 6c65 7379  l(6, self.filesy
+00014f10: 7374 656d 2e67 6574 5f6f 626a 6563 7428  stem.get_object(
+00014f20: 2245 3a21 466f 6f21 4261 7a22 292e 7374  "E:!Foo!Baz").st
+00014f30: 5f64 6576 290a 0a20 2020 2064 6566 2074  _dev)..    def t
+00014f40: 6573 745f 7468 6174 5f75 6e63 5f70 6174  est_that_unc_pat
+00014f50: 6873 5f61 7265 5f61 7574 6f5f 6d6f 756e  hs_are_auto_moun
+00014f60: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
+00014f70: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00014f80: 656d 2e69 735f 7769 6e64 6f77 735f 6673  em.is_windows_fs
+00014f90: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00014fa0: 7365 6c66 2e61 6464 5f6d 6f75 6e74 5f70  self.add_mount_p
+00014fb0: 6f69 6e74 7328 290a 2020 2020 2020 2020  oints().        
+00014fc0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00014fd0: 6372 6561 7465 5f64 6972 2822 2121 666f  create_dir("!!fo
+00014fe0: 6f21 6261 7221 6261 7a22 290a 2020 2020  o!bar!baz").    
+00014ff0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00015000: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
+00015010: 2221 2166 6f6f 2162 6172 2162 6970 2162  "!!foo!bar!bip!b
+00015020: 6f70 2229 0a20 2020 2020 2020 2073 656c  op").        sel
+00015030: 662e 6173 7365 7274 4571 7561 6c28 352c  f.assertEqual(5,
+00015040: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00015050: 2e67 6574 5f6f 626a 6563 7428 2221 2166  .get_object("!!f
+00015060: 6f6f 2162 6172 2229 2e73 745f 6465 7629  oo!bar").st_dev)
+00015070: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00015080: 7365 7274 4571 7561 6c28 352c 2073 656c  sertEqual(5, sel
+00015090: 662e 6669 6c65 7379 7374 656d 2e67 6574  f.filesystem.get
+000150a0: 5f6f 626a 6563 7428 2221 2166 6f6f 2162  _object("!!foo!b
+000150b0: 6172 2162 6970 2162 6f70 2229 2e73 745f  ar!bip!bop").st_
+000150c0: 6465 7629 0a0a 0a63 6c61 7373 2043 6f6e  dev)...class Con
+000150d0: 7665 6e69 656e 6365 4d65 7468 6f64 5465  venienceMethodTe
+000150e0: 7374 2852 6561 6c46 7354 6573 7443 6173  st(RealFsTestCas
+000150f0: 6529 3a0a 2020 2020 6465 6620 7465 7374  e):.    def test
+00015100: 5f63 7265 6174 655f 6c69 6e6b 5f77 6974  _create_link_wit
+00015110: 685f 6e6f 6e5f 6578 6973 7465 6e74 5f70  h_non_existent_p
+00015120: 6172 656e 7428 7365 6c66 293a 0a20 2020  arent(self):.   
+00015130: 2020 2020 2073 656c 662e 736b 6970 5f69       self.skip_i
+00015140: 665f 7379 6d6c 696e 6b5f 6e6f 745f 7375  f_symlink_not_su
+00015150: 7070 6f72 7465 6428 290a 2020 2020 2020  pported().      
+00015160: 2020 6669 6c65 315f 7061 7468 203d 2073    file1_path = s
+00015170: 656c 662e 6d61 6b65 5f70 6174 6828 2274  elf.make_path("t
+00015180: 6573 745f 6669 6c65 3122 290a 2020 2020  est_file1").    
+00015190: 2020 2020 6c69 6e6b 5f70 6174 6820 3d20      link_path = 
+000151a0: 7365 6c66 2e6d 616b 655f 7061 7468 2822  self.make_path("
+000151b0: 6e6f 6e65 7869 7374 656e 7422 2c20 2274  nonexistent", "t
+000151c0: 6573 745f 6669 6c65 3222 290a 0a20 2020  est_file2")..   
+000151d0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+000151e0: 7374 656d 2e63 7265 6174 655f 6669 6c65  stem.create_file
+000151f0: 2866 696c 6531 5f70 6174 682c 2063 6f6e  (file1_path, con
+00015200: 7465 6e74 733d 226c 696e 6b20 7465 7374  tents="link test
+00015210: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00015220: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+00015230: 2e6f 732e 7374 6174 2866 696c 6531 5f70  .os.stat(file1_p
+00015240: 6174 6829 2e73 745f 6e6c 696e 6b2c 2031  ath).st_nlink, 1
+00015250: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+00015260: 696c 6573 7973 7465 6d2e 6372 6561 7465  ilesystem.create
+00015270: 5f6c 696e 6b28 6669 6c65 315f 7061 7468  _link(file1_path
+00015280: 2c20 6c69 6e6b 5f70 6174 6829 0a20 2020  , link_path).   
+00015290: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000152a0: 4571 7561 6c28 7365 6c66 2e6f 732e 7374  Equal(self.os.st
+000152b0: 6174 2866 696c 6531 5f70 6174 6829 2e73  at(file1_path).s
+000152c0: 745f 6e6c 696e 6b2c 2032 290a 2020 2020  t_nlink, 2).    
+000152d0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+000152e0: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
+000152f0: 7465 6d2e 6578 6973 7473 286c 696e 6b5f  tem.exists(link_
+00015300: 7061 7468 2929 0a0a 2020 2020 6465 6620  path))..    def 
+00015310: 7465 7374 5f63 7265 6174 655f 7379 6d6c  test_create_syml
+00015320: 696e 6b5f 7769 7468 5f6e 6f6e 5f65 7869  ink_with_non_exi
+00015330: 7374 656e 745f 7061 7265 6e74 2873 656c  stent_parent(sel
+00015340: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00015350: 2e73 6b69 705f 6966 5f73 796d 6c69 6e6b  .skip_if_symlink
+00015360: 5f6e 6f74 5f73 7570 706f 7274 6564 2829  _not_supported()
+00015370: 0a20 2020 2020 2020 2066 696c 6531 5f70  .        file1_p
+00015380: 6174 6820 3d20 7365 6c66 2e6d 616b 655f  ath = self.make_
+00015390: 7061 7468 2822 7465 7374 5f66 696c 6531  path("test_file1
+000153a0: 2229 0a20 2020 2020 2020 206c 696e 6b5f  ").        link_
+000153b0: 7061 7468 203d 2073 656c 662e 6d61 6b65  path = self.make
+000153c0: 5f70 6174 6828 226e 6f6e 6578 6973 7465  _path("nonexiste
+000153d0: 6e74 222c 2022 7465 7374 5f66 696c 6532  nt", "test_file2
+000153e0: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
+000153f0: 2e66 696c 6573 7973 7465 6d2e 6372 6561  .filesystem.crea
+00015400: 7465 5f66 696c 6528 6669 6c65 315f 7061  te_file(file1_pa
+00015410: 7468 2c20 636f 6e74 656e 7473 3d22 7379  th, contents="sy
+00015420: 6d6c 696e 6b20 7465 7374 2229 0a20 2020  mlink test").   
+00015430: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00015440: 7374 656d 2e63 7265 6174 655f 7379 6d6c  stem.create_syml
+00015450: 696e 6b28 6c69 6e6b 5f70 6174 682c 2066  ink(link_path, f
+00015460: 696c 6531 5f70 6174 6829 0a20 2020 2020  ile1_path).     
+00015470: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00015480: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
+00015490: 656d 2e65 7869 7374 7328 6c69 6e6b 5f70  em.exists(link_p
+000154a0: 6174 6829 290a 2020 2020 2020 2020 7365  ath)).        se
+000154b0: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+000154c0: 6c66 2e66 696c 6573 7973 7465 6d2e 6973  lf.filesystem.is
+000154d0: 6c69 6e6b 286c 696e 6b5f 7061 7468 2929  link(link_path))
+000154e0: 0a0a 0a63 6c61 7373 2052 6561 6c46 696c  ...class RealFil
+000154f0: 6553 7973 7465 6d41 6363 6573 7354 6573  eSystemAccessTes
+00015500: 7428 5265 616c 4673 5465 7374 4361 7365  t(RealFsTestCase
+00015510: 293a 0a20 2020 2064 6566 2073 6574 5570  ):.    def setUp
+00015520: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00015530: 2320 7573 6520 7468 6520 7265 616c 2070  # use the real p
+00015540: 6174 6820 7365 7061 7261 746f 7220 746f  ath separator to
+00015550: 2077 6f72 6b20 7769 7468 2074 6865 2072   work with the r
+00015560: 6561 6c20 6669 6c65 2073 7973 7465 6d0a  eal file system.
+00015570: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00015580: 6573 7973 7465 6d20 3d20 6661 6b65 5f66  esystem = fake_f
+00015590: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
+000155a0: 6c65 7379 7374 656d 2829 0a20 2020 2020  lesystem().     
+000155b0: 2020 2073 656c 662e 6661 6b65 5f6f 7065     self.fake_ope
+000155c0: 6e20 3d20 6661 6b65 5f66 696c 6573 7973  n = fake_filesys
+000155d0: 7465 6d2e 4661 6b65 4669 6c65 4f70 656e  tem.FakeFileOpen
+000155e0: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
+000155f0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00015600: 7966 616b 6566 735f 7061 7468 203d 206f  yfakefs_path = o
+00015610: 732e 7061 7468 2e73 706c 6974 286f 732e  s.path.split(os.
+00015620: 7061 7468 2e64 6972 6e61 6d65 286f 732e  path.dirname(os.
+00015630: 7061 7468 2e61 6273 7061 7468 285f 5f66  path.abspath(__f
+00015640: 696c 655f 5f29 2929 5b0a 2020 2020 2020  ile__)))[.      
+00015650: 2020 2020 2020 300a 2020 2020 2020 2020        0.        
+00015660: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
+00015670: 6f6f 745f 7061 7468 203d 206f 732e 7061  oot_path = os.pa
+00015680: 7468 2e73 706c 6974 2873 656c 662e 7079  th.split(self.py
+00015690: 6661 6b65 6673 5f70 6174 6829 5b30 5d0a  fakefs_path)[0].
+000156a0: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+000156b0: 645f 6e6f 6e5f 6578 6973 7469 6e67 5f72  d_non_existing_r
+000156c0: 6561 6c5f 6669 6c65 5f72 6169 7365 7328  eal_file_raises(
+000156d0: 7365 6c66 293a 0a20 2020 2020 2020 206e  self):.        n
+000156e0: 6f6e 6578 6973 7469 6e67 5f70 6174 6820  onexisting_path 
+000156f0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2822  = os.path.join("
+00015700: 6e6f 6e65 7869 7374 696e 6722 2c20 2274  nonexisting", "t
+00015710: 6573 742e 7478 7422 290a 2020 2020 2020  est.txt").      
+00015720: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00015730: 7274 5261 6973 6573 284f 5345 7272 6f72  rtRaises(OSError
+00015740: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00015750: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
+00015760: 6464 5f72 6561 6c5f 6669 6c65 286e 6f6e  dd_real_file(non
+00015770: 6578 6973 7469 6e67 5f70 6174 6829 0a20  existing_path). 
+00015780: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015790: 7274 4661 6c73 6528 7365 6c66 2e66 696c  rtFalse(self.fil
+000157a0: 6573 7973 7465 6d2e 6578 6973 7473 286e  esystem.exists(n
+000157b0: 6f6e 6578 6973 7469 6e67 5f70 6174 6829  onexisting_path)
+000157c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000157d0: 6164 645f 6e6f 6e5f 6578 6973 7469 6e67  add_non_existing
+000157e0: 5f72 6561 6c5f 6469 7265 6374 6f72 795f  _real_directory_
+000157f0: 7261 6973 6573 2873 656c 6629 3a0a 2020  raises(self):.  
+00015800: 2020 2020 2020 6e6f 6e65 7869 7374 696e        nonexistin
+00015810: 675f 7061 7468 203d 2022 2f6e 6f6e 6578  g_path = "/nonex
+00015820: 6973 7469 6e67 220a 2020 2020 2020 2020  isting".        
+00015830: 7769 7468 2073 656c 662e 7261 6973 6573  with self.raises
+00015840: 5f6f 735f 6572 726f 7228 6572 726e 6f2e  _os_error(errno.
+00015850: 454e 4f45 4e54 293a 0a20 2020 2020 2020  ENOENT):.       
+00015860: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00015870: 7374 656d 2e61 6464 5f72 6561 6c5f 6469  stem.add_real_di
+00015880: 7265 6374 6f72 7928 6e6f 6e65 7869 7374  rectory(nonexist
+00015890: 696e 675f 7061 7468 290a 2020 2020 2020  ing_path).      
+000158a0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+000158b0: 7365 2873 656c 662e 6669 6c65 7379 7374  se(self.filesyst
+000158c0: 656d 2e65 7869 7374 7328 6e6f 6e65 7869  em.exists(nonexi
+000158d0: 7374 696e 675f 7061 7468 2929 0a0a 2020  sting_path))..  
+000158e0: 2020 6465 6620 7465 7374 5f65 7869 7374    def test_exist
+000158f0: 696e 675f 6661 6b65 5f66 696c 655f 7261  ing_fake_file_ra
+00015900: 6973 6573 2873 656c 6629 3a0a 2020 2020  ises(self):.    
+00015910: 2020 2020 7265 616c 5f66 696c 655f 7061      real_file_pa
+00015920: 7468 203d 205f 5f66 696c 655f 5f0a 2020  th = __file__.  
+00015930: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+00015940: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
+00015950: 6528 7265 616c 5f66 696c 655f 7061 7468  e(real_file_path
+00015960: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00015970: 656c 662e 7261 6973 6573 5f6f 735f 6572  elf.raises_os_er
+00015980: 726f 7228 6572 726e 6f2e 4545 5849 5354  ror(errno.EEXIST
+00015990: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000159a0: 656c 662e 6669 6c65 7379 7374 656d 2e61  elf.filesystem.a
+000159b0: 6464 5f72 6561 6c5f 6669 6c65 2872 6561  dd_real_file(rea
+000159c0: 6c5f 6669 6c65 5f70 6174 6829 0a0a 2020  l_file_path)..  
+000159d0: 2020 4063 6f6e 7465 7874 6c69 622e 636f    @contextlib.co
+000159e0: 6e74 6578 746d 616e 6167 6572 0a20 2020  ntextmanager.   
+000159f0: 2064 6566 2063 7265 6174 655f 7265 616c   def create_real
+00015a00: 5f70 6174 6873 2873 656c 6629 3a0a 2020  _paths(self):.  
+00015a10: 2020 2020 2020 7265 616c 5f64 6972 5f72        real_dir_r
+00015a20: 6f6f 7420 3d20 6f73 2e70 6174 682e 6a6f  oot = os.path.jo
+00015a30: 696e 2874 656d 7066 696c 652e 6765 7474  in(tempfile.gett
+00015a40: 656d 7064 6972 2829 2c20 2272 6f6f 7422  empdir(), "root"
+00015a50: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00015a60: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
+00015a70: 6972 5f6e 616d 6520 696e 2028 2266 6f6f  ir_name in ("foo
+00015a80: 222c 2022 6261 7222 293a 0a20 2020 2020  ", "bar"):.     
+00015a90: 2020 2020 2020 2020 2020 2072 6561 6c5f             real_
+00015aa0: 6469 7220 3d20 6f73 2e70 6174 682e 6a6f  dir = os.path.jo
+00015ab0: 696e 2872 6561 6c5f 6469 725f 726f 6f74  in(real_dir_root
+00015ac0: 2c20 6469 725f 6e61 6d65 290a 2020 2020  , dir_name).    
+00015ad0: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
+00015ae0: 616b 6564 6972 7328 7265 616c 5f64 6972  akedirs(real_dir
+00015af0: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
+00015b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015b10: 2077 6974 6820 6f70 656e 280a 2020 2020   with open(.    
+00015b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b30: 6f73 2e70 6174 682e 6a6f 696e 2872 6561  os.path.join(rea
+00015b40: 6c5f 6469 722c 2022 7465 7374 2e74 7874  l_dir, "test.txt
+00015b50: 2229 2c20 2277 222c 2065 6e63 6f64 696e  "), "w", encodin
+00015b60: 673d 2275 7466 3822 0a20 2020 2020 2020  g="utf8".       
+00015b70: 2020 2020 2020 2020 2029 2061 7320 663a           ) as f:
+00015b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015b90: 2020 2020 2066 2e77 7269 7465 2822 7465       f.write("te
+00015ba0: 7374 2229 0a20 2020 2020 2020 2020 2020  st").           
+00015bb0: 2020 2020 2073 7562 5f64 6972 203d 206f       sub_dir = o
+00015bc0: 732e 7061 7468 2e6a 6f69 6e28 7265 616c  s.path.join(real
+00015bd0: 5f64 6972 2c20 2273 7562 2229 0a20 2020  _dir, "sub").   
+00015be0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00015bf0: 6d61 6b65 6469 7273 2873 7562 5f64 6972  makedirs(sub_dir
+00015c00: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
+00015c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015c20: 2077 6974 6820 6f70 656e 286f 732e 7061   with open(os.pa
+00015c30: 7468 2e6a 6f69 6e28 7375 625f 6469 722c  th.join(sub_dir,
+00015c40: 2022 7375 622e 7478 7422 292c 2022 7722   "sub.txt"), "w"
+00015c50: 2c20 656e 636f 6469 6e67 3d22 7574 6638  , encoding="utf8
+00015c60: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
+00015c70: 2020 2020 2020 2020 2020 2020 2066 2e77               f.w
+00015c80: 7269 7465 2822 7375 6222 290a 2020 2020  rite("sub").    
+00015c90: 2020 2020 2020 2020 7969 656c 6420 7265          yield re
+00015ca0: 616c 5f64 6972 5f72 6f6f 740a 2020 2020  al_dir_root.    
+00015cb0: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+00015cc0: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
+00015cd0: 726d 7472 6565 2872 6561 6c5f 6469 725f  rmtree(real_dir_
+00015ce0: 726f 6f74 2c20 6967 6e6f 7265 5f65 7272  root, ignore_err
+00015cf0: 6f72 733d 5472 7565 290a 0a20 2020 2064  ors=True)..    d
+00015d00: 6566 2074 6573 745f 6578 6973 7469 6e67  ef test_existing
+00015d10: 5f66 616b 655f 6469 7265 6374 6f72 795f  _fake_directory_
+00015d20: 6973 5f6d 6572 6765 645f 6c61 7a69 6c79  is_merged_lazily
+00015d30: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00015d40: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00015d50: 6372 6561 7465 5f66 696c 6528 6f73 2e70  create_file(os.p
+00015d60: 6174 682e 6a6f 696e 2822 2f22 2c20 2272  ath.join("/", "r
+00015d70: 6f6f 7422 2c20 2266 6f6f 222c 2022 7465  oot", "foo", "te
+00015d80: 7374 312e 7478 7422 2929 0a20 2020 2020  st1.txt")).     
+00015d90: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00015da0: 656d 2e63 7265 6174 655f 6469 7228 6f73  em.create_dir(os
+00015db0: 2e70 6174 682e 6a6f 696e 2822 726f 6f74  .path.join("root
+00015dc0: 222c 2022 6261 7a22 2929 0a20 2020 2020  ", "baz")).     
+00015dd0: 2020 2077 6974 6820 7365 6c66 2e63 7265     with self.cre
+00015de0: 6174 655f 7265 616c 5f70 6174 6873 2829  ate_real_paths()
+00015df0: 2061 7320 726f 6f74 5f64 6972 3a0a 2020   as root_dir:.  
+00015e00: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+00015e10: 696c 6573 7973 7465 6d2e 6164 645f 7265  ilesystem.add_re
+00015e20: 616c 5f64 6972 6563 746f 7279 2872 6f6f  al_directory(roo
+00015e30: 745f 6469 722c 2074 6172 6765 745f 7061  t_dir, target_pa
+00015e40: 7468 3d22 2f72 6f6f 7422 290a 2020 2020  th="/root").    
+00015e50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015e60: 6572 7454 7275 6528 0a20 2020 2020 2020  ertTrue(.       
+00015e70: 2020 2020 2020 2020 2073 656c 662e 6669           self.fi
+00015e80: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+00015e90: 6f73 2e70 6174 682e 6a6f 696e 2822 726f  os.path.join("ro
+00015ea0: 6f74 222c 2022 666f 6f22 2c20 2274 6573  ot", "foo", "tes
+00015eb0: 742e 7478 7422 2929 0a20 2020 2020 2020  t.txt")).       
+00015ec0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00015ed0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00015ee0: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
+00015ef0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00015f00: 7465 6d2e 6578 6973 7473 286f 732e 7061  tem.exists(os.pa
+00015f10: 7468 2e6a 6f69 6e28 2272 6f6f 7422 2c20  th.join("root", 
+00015f20: 2266 6f6f 222c 2022 7465 7374 312e 7478  "foo", "test1.tx
+00015f30: 7422 2929 0a20 2020 2020 2020 2020 2020  t")).           
+00015f40: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+00015f50: 656c 662e 6173 7365 7274 5472 7565 280a  elf.assertTrue(.
+00015f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f70: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00015f80: 6578 6973 7473 286f 732e 7061 7468 2e6a  exists(os.path.j
+00015f90: 6f69 6e28 2272 6f6f 7422 2c20 2262 6172  oin("root", "bar
+00015fa0: 222c 2022 7375 6222 2c20 2273 7562 2e74  ", "sub", "sub.t
+00015fb0: 7874 2229 290a 2020 2020 2020 2020 2020  xt")).          
+00015fc0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00015fd0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+00015fe0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00015ff0: 6578 6973 7473 286f 732e 7061 7468 2e6a  exists(os.path.j
+00016000: 6f69 6e28 2272 6f6f 7422 2c20 2262 617a  oin("root", "baz
+00016010: 2229 2929 0a0a 2020 2020 6465 6620 7465  ")))..    def te
+00016020: 7374 5f65 7869 7374 696e 675f 6661 6b65  st_existing_fake
+00016030: 5f64 6972 6563 746f 7279 5f69 735f 6d65  _directory_is_me
+00016040: 7267 6564 2873 656c 6629 3a0a 2020 2020  rged(self):.    
+00016050: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00016060: 7465 6d2e 6372 6561 7465 5f66 696c 6528  tem.create_file(
+00016070: 6f73 2e70 6174 682e 6a6f 696e 2822 2f22  os.path.join("/"
+00016080: 2c20 2272 6f6f 7422 2c20 2266 6f6f 222c  , "root", "foo",
+00016090: 2022 7465 7374 312e 7478 7422 2929 0a20   "test1.txt")). 
+000160a0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+000160b0: 7379 7374 656d 2e63 7265 6174 655f 6469  system.create_di
+000160c0: 7228 6f73 2e70 6174 682e 6a6f 696e 2822  r(os.path.join("
+000160d0: 726f 6f74 222c 2022 6261 7a22 2929 0a20  root", "baz")). 
+000160e0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000160f0: 2e63 7265 6174 655f 7265 616c 5f70 6174  .create_real_pat
+00016100: 6873 2829 2061 7320 726f 6f74 5f64 6972  hs() as root_dir
+00016110: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00016120: 6c66 2e66 696c 6573 7973 7465 6d2e 6164  lf.filesystem.ad
+00016130: 645f 7265 616c 5f64 6972 6563 746f 7279  d_real_directory
+00016140: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016150: 2020 726f 6f74 5f64 6972 2c20 7461 7267    root_dir, targ
+00016160: 6574 5f70 6174 683d 222f 726f 6f74 222c  et_path="/root",
+00016170: 206c 617a 795f 7265 6164 3d46 616c 7365   lazy_read=False
+00016180: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00016190: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000161a0: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
+000161b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000161c0: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
+000161d0: 7473 286f 732e 7061 7468 2e6a 6f69 6e28  ts(os.path.join(
+000161e0: 2272 6f6f 7422 2c20 2266 6f6f 222c 2022  "root", "foo", "
+000161f0: 7465 7374 2e74 7874 2229 290a 2020 2020  test.txt")).    
+00016200: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00016210: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00016220: 7454 7275 6528 0a20 2020 2020 2020 2020  tTrue(.         
+00016230: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00016240: 7379 7374 656d 2e65 7869 7374 7328 6f73  system.exists(os
+00016250: 2e70 6174 682e 6a6f 696e 2822 726f 6f74  .path.join("root
+00016260: 222c 2022 666f 6f22 2c20 2274 6573 7431  ", "foo", "test1
+00016270: 2e74 7874 2229 290a 2020 2020 2020 2020  .txt")).        
+00016280: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00016290: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+000162a0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000162b0: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+000162c0: 656d 2e65 7869 7374 7328 6f73 2e70 6174  em.exists(os.pat
+000162d0: 682e 6a6f 696e 2822 726f 6f74 222c 2022  h.join("root", "
+000162e0: 6261 7222 2c20 2273 7562 222c 2022 7375  bar", "sub", "su
+000162f0: 622e 7478 7422 2929 0a20 2020 2020 2020  b.txt")).       
+00016300: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016310: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00016320: 7565 2873 656c 662e 6669 6c65 7379 7374  ue(self.filesyst
+00016330: 656d 2e65 7869 7374 7328 6f73 2e70 6174  em.exists(os.pat
+00016340: 682e 6a6f 696e 2822 726f 6f74 222c 2022  h.join("root", "
+00016350: 6261 7a22 2929 290a 0a20 2020 2064 6566  baz")))..    def
+00016360: 2074 6573 745f 6661 6b65 5f66 696c 6573   test_fake_files
+00016370: 5f63 616e 6e6f 745f 6265 5f6f 7665 7277  _cannot_be_overw
+00016380: 7269 7474 656e 2873 656c 6629 3a0a 2020  ritten(self):.  
+00016390: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+000163a0: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
+000163b0: 6528 6f73 2e70 6174 682e 6a6f 696e 2822  e(os.path.join("
+000163c0: 2f22 2c20 2272 6f6f 7422 2c20 2266 6f6f  /", "root", "foo
+000163d0: 222c 2022 7465 7374 2e74 7874 2229 290a  ", "test.txt")).
+000163e0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000163f0: 662e 6372 6561 7465 5f72 6561 6c5f 7061  f.create_real_pa
+00016400: 7468 7328 2920 6173 2072 6f6f 745f 6469  ths() as root_di
+00016410: 723a 0a20 2020 2020 2020 2020 2020 2077  r:.            w
+00016420: 6974 6820 7365 6c66 2e72 6169 7365 735f  ith self.raises_
+00016430: 6f73 5f65 7272 6f72 2865 7272 6e6f 2e45  os_error(errno.E
+00016440: 4558 4953 5429 3a0a 2020 2020 2020 2020  EXIST):.        
+00016450: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00016460: 6573 7973 7465 6d2e 6164 645f 7265 616c  esystem.add_real
+00016470: 5f64 6972 6563 746f 7279 2872 6f6f 745f  _directory(root_
+00016480: 6469 722c 2074 6172 6765 745f 7061 7468  dir, target_path
+00016490: 3d22 2f72 6f6f 7422 290a 0a20 2020 2064  ="/root")..    d
+000164a0: 6566 2074 6573 745f 6361 6e6e 6f74 5f6f  ef test_cannot_o
+000164b0: 7665 7277 7269 7465 5f66 696c 655f 7769  verwrite_file_wi
+000164c0: 7468 5f64 6972 2873 656c 6629 3a0a 2020  th_dir(self):.  
+000164d0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+000164e0: 7973 7465 6d2e 6372 6561 7465 5f66 696c  ystem.create_fil
+000164f0: 6528 6f73 2e70 6174 682e 6a6f 696e 2822  e(os.path.join("
+00016500: 2f22 2c20 2272 6f6f 7422 2c20 2266 6f6f  /", "root", "foo
+00016510: 2229 290a 2020 2020 2020 2020 7769 7468  ")).        with
+00016520: 2073 656c 662e 6372 6561 7465 5f72 6561   self.create_rea
+00016530: 6c5f 7061 7468 7328 2920 6173 2072 6f6f  l_paths() as roo
+00016540: 745f 6469 723a 0a20 2020 2020 2020 2020  t_dir:.         
+00016550: 2020 2077 6974 6820 7365 6c66 2e72 6169     with self.rai
+00016560: 7365 735f 6f73 5f65 7272 6f72 2865 7272  ses_os_error(err
+00016570: 6e6f 2e45 4e4f 5444 4952 293a 0a20 2020  no.ENOTDIR):.   
+00016580: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00016590: 662e 6669 6c65 7379 7374 656d 2e61 6464  f.filesystem.add
+000165a0: 5f72 6561 6c5f 6469 7265 6374 6f72 7928  _real_directory(
+000165b0: 726f 6f74 5f64 6972 2c20 7461 7267 6574  root_dir, target
+000165c0: 5f70 6174 683d 222f 726f 6f74 2f22 290a  _path="/root/").
+000165d0: 0a20 2020 2064 6566 2074 6573 745f 6361  .    def test_ca
+000165e0: 6e6e 6f74 5f6f 7665 7277 7269 7465 5f73  nnot_overwrite_s
+000165f0: 796d 6c69 6e6b 5f77 6974 685f 6469 7228  ymlink_with_dir(
+00016600: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00016610: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
+00016620: 7265 6174 655f 7379 6d6c 696e 6b28 0a20  reate_symlink(. 
+00016630: 2020 2020 2020 2020 2020 206f 732e 7061             os.pa
+00016640: 7468 2e6a 6f69 6e28 222f 222c 2022 726f  th.join("/", "ro
+00016650: 6f74 222c 2022 666f 6f22 292c 206f 732e  ot", "foo"), os.
+00016660: 7061 7468 2e6a 6f69 6e28 222f 222c 2022  path.join("/", "
+00016670: 726f 6f74 222c 2022 6c69 6e6b 2229 0a20  root", "link"). 
+00016680: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00016690: 2077 6974 6820 7365 6c66 2e63 7265 6174   with self.creat
+000166a0: 655f 7265 616c 5f70 6174 6873 2829 2061  e_real_paths() a
+000166b0: 7320 726f 6f74 5f64 6972 3a0a 2020 2020  s root_dir:.    
+000166c0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000166d0: 662e 7261 6973 6573 5f6f 735f 6572 726f  f.raises_os_erro
+000166e0: 7228 6572 726e 6f2e 4545 5849 5354 293a  r(errno.EEXIST):
+000166f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016700: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00016710: 2e61 6464 5f72 6561 6c5f 6469 7265 6374  .add_real_direct
+00016720: 6f72 7928 726f 6f74 5f64 6972 2c20 7461  ory(root_dir, ta
+00016730: 7267 6574 5f70 6174 683d 222f 726f 6f74  rget_path="/root
+00016740: 2f22 290a 0a20 2020 2064 6566 2074 6573  /")..    def tes
+00016750: 745f 7379 6d6c 696e 6b5f 6973 5f6d 6572  t_symlink_is_mer
+00016760: 6765 6428 7365 6c66 293a 0a20 2020 2020  ged(self):.     
+00016770: 2020 2073 656c 662e 736b 6970 5f69 665f     self.skip_if_
+00016780: 7379 6d6c 696e 6b5f 6e6f 745f 7375 7070  symlink_not_supp
+00016790: 6f72 7465 6428 666f 7263 655f 7265 616c  orted(force_real
+000167a0: 5f66 733d 5472 7565 290a 2020 2020 2020  _fs=True).      
+000167b0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+000167c0: 6d2e 6372 6561 7465 5f64 6972 286f 732e  m.create_dir(os.
+000167d0: 7061 7468 2e6a 6f69 6e28 222f 222c 2022  path.join("/", "
+000167e0: 726f 6f74 222c 2022 666f 6f22 2929 0a20  root", "foo")). 
+000167f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00016800: 2e63 7265 6174 655f 7265 616c 5f70 6174  .create_real_pat
+00016810: 6873 2829 2061 7320 726f 6f74 5f64 6972  hs() as root_dir
+00016820: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
+00016830: 6e6b 5f70 6174 6820 3d20 6f73 2e70 6174  nk_path = os.pat
+00016840: 682e 6a6f 696e 2872 6f6f 745f 6469 722c  h.join(root_dir,
+00016850: 2022 6c69 6e6b 2e74 7874 2229 0a20 2020   "link.txt").   
+00016860: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+00016870: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
+00016880: 6f69 6e28 2266 6f6f 222c 2022 7375 6222  oin("foo", "sub"
+00016890: 2c20 2273 7562 2e74 7874 2229 0a20 2020  , "sub.txt").   
+000168a0: 2020 2020 2020 2020 206f 732e 7379 6d6c           os.syml
+000168b0: 696e 6b28 7461 7267 6574 5f70 6174 682c  ink(target_path,
+000168c0: 206c 696e 6b5f 7061 7468 290a 2020 2020   link_path).    
+000168d0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+000168e0: 6573 7973 7465 6d2e 6164 645f 7265 616c  esystem.add_real
+000168f0: 5f64 6972 6563 746f 7279 2872 6f6f 745f  _directory(root_
+00016900: 6469 722c 2074 6172 6765 745f 7061 7468  dir, target_path
+00016910: 3d22 2f72 6f6f 7422 290a 2020 2020 2020  ="/root").      
+00016920: 2020 2020 2020 6661 6b65 5f6c 696e 6b5f        fake_link_
+00016930: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
+00016940: 6f69 6e28 222f 222c 2022 726f 6f74 222c  oin("/", "root",
+00016950: 2022 6c69 6e6b 2e74 7874 2229 0a20 2020   "link.txt").   
+00016960: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00016970: 7365 7274 5472 7565 2873 656c 662e 6669  sertTrue(self.fi
+00016980: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+00016990: 6661 6b65 5f6c 696e 6b5f 7061 7468 2929  fake_link_path))
+000169a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000169b0: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
+000169c0: 662e 6669 6c65 7379 7374 656d 2e69 736c  f.filesystem.isl
+000169d0: 696e 6b28 6661 6b65 5f6c 696e 6b5f 7061  ink(fake_link_pa
+000169e0: 7468 2929 0a0a 2020 2020 6465 6620 6368  th))..    def ch
+000169f0: 6563 6b5f 6661 6b65 5f66 696c 655f 7374  eck_fake_file_st
+00016a00: 6174 2873 656c 662c 2066 616b 655f 6669  at(self, fake_fi
+00016a10: 6c65 2c20 7265 616c 5f66 696c 655f 7061  le, real_file_pa
+00016a20: 7468 2c20 7461 7267 6574 5f70 6174 683d  th, target_path=
+00016a30: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
+00016a40: 6620 7461 7267 6574 5f70 6174 6820 6973  f target_path is
+00016a50: 204e 6f6e 6520 6f72 2074 6172 6765 745f   None or target_
+00016a60: 7061 7468 203d 3d20 7265 616c 5f66 696c  path == real_fil
+00016a70: 655f 7061 7468 3a0a 2020 2020 2020 2020  e_path:.        
+00016a80: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00016a90: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
+00016aa0: 7465 6d2e 6578 6973 7473 2872 6561 6c5f  tem.exists(real_
+00016ab0: 6669 6c65 5f70 6174 6829 290a 2020 2020  file_path)).    
+00016ac0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00016ad0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00016ae0: 7446 616c 7365 2873 656c 662e 6669 6c65  tFalse(self.file
+00016af0: 7379 7374 656d 2e65 7869 7374 7328 7265  system.exists(re
+00016b00: 616c 5f66 696c 655f 7061 7468 2929 0a20  al_file_path)). 
+00016b10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016b20: 6173 7365 7274 5472 7565 2873 656c 662e  assertTrue(self.
+00016b30: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
+00016b40: 7328 7461 7267 6574 5f70 6174 6829 290a  s(target_path)).
+00016b50: 0a20 2020 2020 2020 2072 6561 6c5f 7374  .        real_st
+00016b60: 6174 203d 206f 732e 7374 6174 2872 6561  at = os.stat(rea
+00016b70: 6c5f 6669 6c65 5f70 6174 6829 0a20 2020  l_file_path).   
+00016b80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00016b90: 4973 4e6f 6e65 2866 616b 655f 6669 6c65  IsNone(fake_file
+00016ba0: 2e5f 6279 7465 5f63 6f6e 7465 6e74 7329  ._byte_contents)
+00016bb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016bc0: 7365 7274 4571 7561 6c28 6661 6b65 5f66  sertEqual(fake_f
+00016bd0: 696c 652e 7374 5f73 697a 652c 2072 6561  ile.st_size, rea
+00016be0: 6c5f 7374 6174 2e73 745f 7369 7a65 290a  l_stat.st_size).
+00016bf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00016c00: 6572 7441 6c6d 6f73 7445 7175 616c 2866  ertAlmostEqual(f
+00016c10: 616b 655f 6669 6c65 2e73 745f 6374 696d  ake_file.st_ctim
+00016c20: 652c 2072 6561 6c5f 7374 6174 2e73 745f  e, real_stat.st_
+00016c30: 6374 696d 652c 2070 6c61 6365 733d 3529  ctime, places=5)
+00016c40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016c50: 7365 7274 416c 6d6f 7374 4571 7561 6c28  sertAlmostEqual(
+00016c60: 6661 6b65 5f66 696c 652e 7374 5f61 7469  fake_file.st_ati
+00016c70: 6d65 2c20 7265 616c 5f73 7461 742e 7374  me, real_stat.st
+00016c80: 5f61 7469 6d65 2c20 706c 6163 6573 3d35  _atime, places=5
+00016c90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00016ca0: 7373 6572 7441 6c6d 6f73 7445 7175 616c  ssertAlmostEqual
+00016cb0: 2866 616b 655f 6669 6c65 2e73 745f 6d74  (fake_file.st_mt
+00016cc0: 696d 652c 2072 6561 6c5f 7374 6174 2e73  ime, real_stat.s
+00016cd0: 745f 6d74 696d 652c 2070 6c61 6365 733d  t_mtime, places=
+00016ce0: 3529 0a20 2020 2020 2020 2073 656c 662e  5).        self.
+00016cf0: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00016d00: 5f66 696c 652e 7374 5f75 6964 2c20 7265  _file.st_uid, re
+00016d10: 616c 5f73 7461 742e 7374 5f75 6964 290a  al_stat.st_uid).
+00016d20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00016d30: 6572 7445 7175 616c 2866 616b 655f 6669  ertEqual(fake_fi
+00016d40: 6c65 2e73 745f 6769 642c 2072 6561 6c5f  le.st_gid, real_
+00016d50: 7374 6174 2e73 745f 6769 6429 0a0a 2020  stat.st_gid)..  
+00016d60: 2020 6465 6620 6368 6563 6b5f 7265 6164    def check_read
+00016d70: 5f6f 6e6c 795f 6669 6c65 2873 656c 662c  _only_file(self,
+00016d80: 2066 616b 655f 6669 6c65 2c20 7265 616c   fake_file, real
+00016d90: 5f66 696c 655f 7061 7468 293a 0a20 2020  _file_path):.   
+00016da0: 2020 2020 2077 6974 6820 6f70 656e 2872       with open(r
+00016db0: 6561 6c5f 6669 6c65 5f70 6174 682c 2022  eal_file_path, "
+00016dc0: 7262 2229 2061 7320 663a 0a20 2020 2020  rb") as f:.     
+00016dd0: 2020 2020 2020 2072 6561 6c5f 636f 6e74         real_cont
+00016de0: 656e 7473 203d 2066 2e72 6561 6428 290a  ents = f.read().
+00016df0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00016e00: 6572 7445 7175 616c 2866 616b 655f 6669  ertEqual(fake_fi
+00016e10: 6c65 2e62 7974 655f 636f 6e74 656e 7473  le.byte_contents
+00016e20: 2c20 7265 616c 5f63 6f6e 7465 6e74 7329  , real_contents)
+00016e30: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00016e40: 6973 5f72 6f6f 7428 293a 0a20 2020 2020  is_root():.     
+00016e50: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00016e60: 2e72 6169 7365 735f 6f73 5f65 7272 6f72  .raises_os_error
+00016e70: 2865 7272 6e6f 2e45 4143 4345 5329 3a0a  (errno.EACCES):.
+00016e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e90: 7365 6c66 2e66 616b 655f 6f70 656e 2872  self.fake_open(r
+00016ea0: 6561 6c5f 6669 6c65 5f70 6174 682c 2022  eal_file_path, "
+00016eb0: 7722 290a 2020 2020 2020 2020 656c 7365  w").        else
+00016ec0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+00016ed0: 7468 2073 656c 662e 6661 6b65 5f6f 7065  th self.fake_ope
+00016ee0: 6e28 7265 616c 5f66 696c 655f 7061 7468  n(real_file_path
+00016ef0: 2c20 2277 2229 3a0a 2020 2020 2020 2020  , "w"):.        
+00016f00: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+00016f10: 2020 6465 6620 6368 6563 6b5f 7772 6974    def check_writ
+00016f20: 6162 6c65 5f66 696c 6528 7365 6c66 2c20  able_file(self, 
+00016f30: 6661 6b65 5f66 696c 652c 2072 6561 6c5f  fake_file, real_
+00016f40: 6669 6c65 5f70 6174 6829 3a0a 2020 2020  file_path):.    
+00016f50: 2020 2020 7769 7468 206f 7065 6e28 7265      with open(re
+00016f60: 616c 5f66 696c 655f 7061 7468 2c20 2272  al_file_path, "r
+00016f70: 6222 2920 6173 2066 3a0a 2020 2020 2020  b") as f:.      
+00016f80: 2020 2020 2020 7265 616c 5f63 6f6e 7465        real_conte
+00016f90: 6e74 7320 3d20 662e 7265 6164 2829 0a20  nts = f.read(). 
+00016fa0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00016fb0: 7274 4571 7561 6c28 6661 6b65 5f66 696c  rtEqual(fake_fil
+00016fc0: 652e 6279 7465 5f63 6f6e 7465 6e74 732c  e.byte_contents,
+00016fd0: 2072 6561 6c5f 636f 6e74 656e 7473 290a   real_contents).
+00016fe0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00016ff0: 662e 6661 6b65 5f6f 7065 6e28 7265 616c  f.fake_open(real
+00017000: 5f66 696c 655f 7061 7468 2c20 2277 6222  _file_path, "wb"
+00017010: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00017020: 2020 2020 662e 7772 6974 6528 6222 7465      f.write(b"te
+00017030: 7374 2229 0a20 2020 2020 2020 2077 6974  st").        wit
+00017040: 6820 6f70 656e 2872 6561 6c5f 6669 6c65  h open(real_file
+00017050: 5f70 6174 682c 2022 7262 2229 2061 7320  _path, "rb") as 
+00017060: 663a 0a20 2020 2020 2020 2020 2020 2072  f:.            r
+00017070: 6561 6c5f 636f 6e74 656e 7473 3120 3d20  eal_contents1 = 
+00017080: 662e 7265 6164 2829 0a20 2020 2020 2020  f.read().       
+00017090: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000170a0: 6c28 7265 616c 5f63 6f6e 7465 6e74 7331  l(real_contents1
+000170b0: 2c20 7265 616c 5f63 6f6e 7465 6e74 7329  , real_contents)
+000170c0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+000170d0: 6c66 2e66 616b 655f 6f70 656e 2872 6561  lf.fake_open(rea
+000170e0: 6c5f 6669 6c65 5f70 6174 682c 2022 7262  l_file_path, "rb
+000170f0: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
+00017100: 2020 2020 2066 616b 655f 636f 6e74 656e       fake_conten
+00017110: 7473 203d 2066 2e72 6561 6428 290a 2020  ts = f.read().  
+00017120: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00017130: 7445 7175 616c 2866 616b 655f 636f 6e74  tEqual(fake_cont
+00017140: 656e 7473 2c20 6222 7465 7374 2229 0a0a  ents, b"test")..
+00017150: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+00017160: 5f65 7869 7374 696e 675f 7265 616c 5f66  _existing_real_f
+00017170: 696c 655f 7265 6164 5f6f 6e6c 7928 7365  ile_read_only(se
+00017180: 6c66 293a 0a20 2020 2020 2020 2072 6561  lf):.        rea
+00017190: 6c5f 6669 6c65 5f70 6174 6820 3d20 6f73  l_file_path = os
+000171a0: 2e70 6174 682e 6162 7370 6174 6828 5f5f  .path.abspath(__
+000171b0: 6669 6c65 5f5f 290a 2020 2020 2020 2020  file__).        
+000171c0: 6661 6b65 5f66 696c 6520 3d20 7365 6c66  fake_file = self
+000171d0: 2e66 696c 6573 7973 7465 6d2e 6164 645f  .filesystem.add_
+000171e0: 7265 616c 5f66 696c 6528 7265 616c 5f66  real_file(real_f
+000171f0: 696c 655f 7061 7468 290a 2020 2020 2020  ile_path).      
+00017200: 2020 7365 6c66 2e63 6865 636b 5f66 616b    self.check_fak
+00017210: 655f 6669 6c65 5f73 7461 7428 6661 6b65  e_file_stat(fake
+00017220: 5f66 696c 652c 2072 6561 6c5f 6669 6c65  _file, real_file
+00017230: 5f70 6174 6829 0a20 2020 2020 2020 2073  _path).        s
+00017240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00017250: 6661 6b65 5f66 696c 652e 7374 5f6d 6f64  fake_file.st_mod
+00017260: 6520 2620 306f 3333 332c 2030 290a 2020  e & 0o333, 0).  
+00017270: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
+00017280: 5f72 6561 645f 6f6e 6c79 5f66 696c 6528  _read_only_file(
+00017290: 6661 6b65 5f66 696c 652c 2072 6561 6c5f  fake_file, real_
+000172a0: 6669 6c65 5f70 6174 6829 0a0a 2020 2020  file_path)..    
+000172b0: 6465 6620 7465 7374 5f61 6464 5f65 7869  def test_add_exi
+000172c0: 7374 696e 675f 7265 616c 5f66 696c 655f  sting_real_file_
+000172d0: 7265 6164 5f77 7269 7465 2873 656c 6629  read_write(self)
+000172e0: 3a0a 2020 2020 2020 2020 7265 616c 5f66  :.        real_f
+000172f0: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
+00017300: 7468 2e72 6561 6c70 6174 6828 5f5f 6669  th.realpath(__fi
+00017310: 6c65 5f5f 290a 2020 2020 2020 2020 6661  le__).        fa
+00017320: 6b65 5f66 696c 6520 3d20 7365 6c66 2e66  ke_file = self.f
+00017330: 696c 6573 7973 7465 6d2e 6164 645f 7265  ilesystem.add_re
+00017340: 616c 5f66 696c 6528 7265 616c 5f66 696c  al_file(real_fil
+00017350: 655f 7061 7468 2c20 7265 6164 5f6f 6e6c  e_path, read_onl
+00017360: 793d 4661 6c73 6529 0a0a 2020 2020 2020  y=False)..      
+00017370: 2020 7365 6c66 2e63 6865 636b 5f66 616b    self.check_fak
+00017380: 655f 6669 6c65 5f73 7461 7428 6661 6b65  e_file_stat(fake
+00017390: 5f66 696c 652c 2072 6561 6c5f 6669 6c65  _file, real_file
+000173a0: 5f70 6174 6829 0a20 2020 2020 2020 2073  _path).        s
+000173b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000173c0: 6661 6b65 5f66 696c 652e 7374 5f6d 6f64  fake_file.st_mod
+000173d0: 652c 206f 732e 7374 6174 2872 6561 6c5f  e, os.stat(real_
+000173e0: 6669 6c65 5f70 6174 6829 2e73 745f 6d6f  file_path).st_mo
+000173f0: 6465 290a 2020 2020 2020 2020 7365 6c66  de).        self
+00017400: 2e63 6865 636b 5f77 7269 7461 626c 655f  .check_writable_
+00017410: 6669 6c65 2866 616b 655f 6669 6c65 2c20  file(fake_file, 
+00017420: 7265 616c 5f66 696c 655f 7061 7468 290a  real_file_path).
+00017430: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+00017440: 645f 7265 616c 5f66 696c 655f 746f 5f65  d_real_file_to_e
+00017450: 7869 7374 696e 675f 7061 7468 2873 656c  xisting_path(sel
+00017460: 6629 3a0a 2020 2020 2020 2020 7265 616c  f):.        real
+00017470: 5f66 696c 655f 7061 7468 203d 206f 732e  _file_path = os.
+00017480: 7061 7468 2e61 6273 7061 7468 285f 5f66  path.abspath(__f
+00017490: 696c 655f 5f29 0a20 2020 2020 2020 2073  ile__).        s
+000174a0: 656c 662e 6669 6c65 7379 7374 656d 2e63  elf.filesystem.c
+000174b0: 7265 6174 655f 6669 6c65 2822 2f66 6f6f  reate_file("/foo
+000174c0: 2f62 6172 2229 0a20 2020 2020 2020 2077  /bar").        w
+000174d0: 6974 6820 7365 6c66 2e72 6169 7365 735f  ith self.raises_
+000174e0: 6f73 5f65 7272 6f72 2865 7272 6e6f 2e45  os_error(errno.E
+000174f0: 4558 4953 5429 3a0a 2020 2020 2020 2020  EXIST):.        
+00017500: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00017510: 7465 6d2e 6164 645f 7265 616c 5f66 696c  tem.add_real_fil
+00017520: 6528 7265 616c 5f66 696c 655f 7061 7468  e(real_file_path
+00017530: 2c20 7461 7267 6574 5f70 6174 683d 222f  , target_path="/
+00017540: 666f 6f2f 6261 7222 290a 0a20 2020 2064  foo/bar")..    d
+00017550: 6566 2074 6573 745f 6164 645f 7265 616c  ef test_add_real
+00017560: 5f66 696c 655f 746f 5f6e 6f6e 5f65 7869  _file_to_non_exi
+00017570: 7374 696e 675f 7061 7468 2873 656c 6629  sting_path(self)
+00017580: 3a0a 2020 2020 2020 2020 7265 616c 5f66  :.        real_f
+00017590: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
+000175a0: 7468 2e61 6273 7061 7468 285f 5f66 696c  th.abspath(__fil
+000175b0: 655f 5f29 0a20 2020 2020 2020 2066 616b  e__).        fak
+000175c0: 655f 6669 6c65 203d 2073 656c 662e 6669  e_file = self.fi
+000175d0: 6c65 7379 7374 656d 2e61 6464 5f72 6561  lesystem.add_rea
+000175e0: 6c5f 6669 6c65 280a 2020 2020 2020 2020  l_file(.        
+000175f0: 2020 2020 7265 616c 5f66 696c 655f 7061      real_file_pa
+00017600: 7468 2c20 7461 7267 6574 5f70 6174 683d  th, target_path=
+00017610: 222f 666f 6f2f 6261 7222 0a20 2020 2020  "/foo/bar".     
+00017620: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00017630: 662e 6368 6563 6b5f 6661 6b65 5f66 696c  f.check_fake_fil
+00017640: 655f 7374 6174 2866 616b 655f 6669 6c65  e_stat(fake_file
+00017650: 2c20 7265 616c 5f66 696c 655f 7061 7468  , real_file_path
+00017660: 2c20 7461 7267 6574 5f70 6174 683d 222f  , target_path="/
+00017670: 666f 6f2f 6261 7222 290a 0a20 2020 2064  foo/bar")..    d
+00017680: 6566 2074 6573 745f 7772 6974 655f 746f  ef test_write_to
+00017690: 5f72 6561 6c5f 6669 6c65 2873 656c 6629  _real_file(self)
+000176a0: 3a0a 2020 2020 2020 2020 2320 7265 6772  :.        # regr
+000176b0: 6573 7369 6f6e 2074 6573 7420 666f 7220  ession test for 
+000176c0: 2334 3730 0a20 2020 2020 2020 2072 6561  #470.        rea
+000176d0: 6c5f 6669 6c65 5f70 6174 6820 3d20 6f73  l_file_path = os
+000176e0: 2e70 6174 682e 6162 7370 6174 6828 5f5f  .path.abspath(__
+000176f0: 6669 6c65 5f5f 290a 2020 2020 2020 2020  file__).        
+00017700: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00017710: 6164 645f 7265 616c 5f66 696c 6528 7265  add_real_file(re
+00017720: 616c 5f66 696c 655f 7061 7468 2c20 7265  al_file_path, re
+00017730: 6164 5f6f 6e6c 793d 4661 6c73 6529 0a20  ad_only=False). 
+00017740: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00017750: 2e66 616b 655f 6f70 656e 2872 6561 6c5f  .fake_open(real_
+00017760: 6669 6c65 5f70 6174 682c 2022 7722 2c20  file_path, "w", 
+00017770: 656e 636f 6469 6e67 3d22 7574 6638 2229  encoding="utf8")
+00017780: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+00017790: 2020 2066 2e77 7269 7465 2822 666f 6f22     f.write("foo"
+000177a0: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+000177b0: 7365 6c66 2e66 616b 655f 6f70 656e 2872  self.fake_open(r
+000177c0: 6561 6c5f 6669 6c65 5f70 6174 682c 2022  eal_file_path, "
+000177d0: 7262 2229 2061 7320 663a 0a20 2020 2020  rb") as f:.     
+000177e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000177f0: 7274 4571 7561 6c28 6222 666f 6f22 2c20  rtEqual(b"foo", 
+00017800: 662e 7265 6164 2829 290a 0a20 2020 2064  f.read())..    d
+00017810: 6566 2074 6573 745f 6164 645f 6578 6973  ef test_add_exis
+00017820: 7469 6e67 5f72 6561 6c5f 6469 7265 6374  ting_real_direct
+00017830: 6f72 795f 7265 6164 5f6f 6e6c 7928 7365  ory_read_only(se
+00017840: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00017850: 662e 6669 6c65 7379 7374 656d 2e61 6464  f.filesystem.add
+00017860: 5f72 6561 6c5f 6469 7265 6374 6f72 7928  _real_directory(
+00017870: 7365 6c66 2e70 7966 616b 6566 735f 7061  self.pyfakefs_pa
+00017880: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
+00017890: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
+000178a0: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
+000178b0: 7473 2873 656c 662e 7079 6661 6b65 6673  ts(self.pyfakefs
+000178c0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
+000178d0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+000178e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000178f0: 662e 6669 6c65 7379 7374 656d 2e65 7869  f.filesystem.exi
+00017900: 7374 7328 0a20 2020 2020 2020 2020 2020  sts(.           
+00017910: 2020 2020 206f 732e 7061 7468 2e6a 6f69       os.path.joi
+00017920: 6e28 7365 6c66 2e70 7966 616b 6566 735f  n(self.pyfakefs_
+00017930: 7061 7468 2c20 2266 616b 655f 6669 6c65  path, "fake_file
+00017940: 7379 7374 656d 2e70 7922 290a 2020 2020  system.py").    
+00017950: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00017960: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00017970: 2e61 7373 6572 7454 7275 6528 0a20 2020  .assertTrue(.   
+00017980: 2020 2020 2020 2020 2073 656c 662e 6669           self.fi
+00017990: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
+000179a0: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
+000179b0: 662e 7079 6661 6b65 6673 5f70 6174 682c  f.pyfakefs_path,
+000179c0: 2022 6661 6b65 5f70 6174 686c 6962 2e70   "fake_pathlib.p
+000179d0: 7922 2929 0a20 2020 2020 2020 2029 0a0a  y")).        )..
+000179e0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+000179f0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+00017a00: 2873 656c 662e 7079 6661 6b65 6673 5f70  (self.pyfakefs_p
+00017a10: 6174 682c 2022 6661 6b65 5f66 696c 6573  ath, "fake_files
+00017a20: 7973 7465 6d5f 7368 7574 696c 2e70 7922  ystem_shutil.py"
+00017a30: 290a 2020 2020 2020 2020 6661 6b65 5f66  ).        fake_f
+00017a40: 696c 6520 3d20 7365 6c66 2e66 696c 6573  ile = self.files
+00017a50: 7973 7465 6d2e 7265 736f 6c76 6528 6669  ystem.resolve(fi
+00017a60: 6c65 5f70 6174 6829 0a20 2020 2020 2020  le_path).       
+00017a70: 2073 656c 662e 6368 6563 6b5f 6661 6b65   self.check_fake
+00017a80: 5f66 696c 655f 7374 6174 2866 616b 655f  _file_stat(fake_
+00017a90: 6669 6c65 2c20 6669 6c65 5f70 6174 6829  file, file_path)
+00017aa0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+00017ab0: 6563 6b5f 7265 6164 5f6f 6e6c 795f 6669  eck_read_only_fi
+00017ac0: 6c65 2866 616b 655f 6669 6c65 2c20 6669  le(fake_file, fi
+00017ad0: 6c65 5f70 6174 6829 0a0a 2020 2020 6465  le_path)..    de
+00017ae0: 6620 7465 7374 5f61 6464 5f65 7869 7374  f test_add_exist
+00017af0: 696e 675f 7265 616c 5f64 6972 6563 746f  ing_real_directo
+00017b00: 7279 5f74 7265 6528 7365 6c66 293a 0a20  ry_tree(self):. 
+00017b10: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00017b20: 7379 7374 656d 2e61 6464 5f72 6561 6c5f  system.add_real_
+00017b30: 6469 7265 6374 6f72 7928 7365 6c66 2e72  directory(self.r
+00017b40: 6f6f 745f 7061 7468 290a 2020 2020 2020  oot_path).      
+00017b50: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+00017b60: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+00017b70: 656c 662e 6669 6c65 7379 7374 656d 2e65  elf.filesystem.e
+00017b80: 7869 7374 7328 0a20 2020 2020 2020 2020  xists(.         
+00017b90: 2020 2020 2020 206f 732e 7061 7468 2e6a         os.path.j
+00017ba0: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
+00017bb0: 2020 2020 2020 2020 2073 656c 662e 726f           self.ro
+00017bc0: 6f74 5f70 6174 682c 0a20 2020 2020 2020  ot_path,.       
+00017bd0: 2020 2020 2020 2020 2020 2020 2022 7079               "py
+00017be0: 6661 6b65 6673 222c 0a20 2020 2020 2020  fakefs",.       
+00017bf0: 2020 2020 2020 2020 2020 2020 2022 7465               "te
+00017c00: 7374 7322 2c0a 2020 2020 2020 2020 2020  sts",.          
+00017c10: 2020 2020 2020 2020 2020 2266 616b 655f            "fake_
+00017c20: 6669 6c65 7379 7374 656d 5f74 6573 742e  filesystem_test.
+00017c30: 7079 222c 0a20 2020 2020 2020 2020 2020  py",.           
+00017c40: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00017c50: 2020 2029 0a20 2020 2020 2020 2029 0a20     ).        ). 
+00017c60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00017c70: 7274 5472 7565 280a 2020 2020 2020 2020  rtTrue(.        
+00017c80: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00017c90: 7465 6d2e 6578 6973 7473 280a 2020 2020  tem.exists(.    
+00017ca0: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
+00017cb0: 6174 682e 6a6f 696e 2873 656c 662e 726f  ath.join(self.ro
+00017cc0: 6f74 5f70 6174 682c 2022 7079 6661 6b65  ot_path, "pyfake
+00017cd0: 6673 222c 2022 6661 6b65 5f66 696c 6573  fs", "fake_files
+00017ce0: 7973 7465 6d2e 7079 2229 0a20 2020 2020  ystem.py").     
+00017cf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00017d00: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00017d10: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
+00017d20: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00017d30: 6573 7973 7465 6d2e 6578 6973 7473 280a  esystem.exists(.
+00017d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d50: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
+00017d60: 662e 726f 6f74 5f70 6174 682c 2022 7079  f.root_path, "py
+00017d70: 6661 6b65 6673 222c 2022 5f5f 696e 6974  fakefs", "__init
+00017d80: 5f5f 2e70 7922 290a 2020 2020 2020 2020  __.py").        
+00017d90: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+00017da0: 0a20 2020 2040 636f 6e74 6578 746c 6962  .    @contextlib
+00017db0: 2e63 6f6e 7465 7874 6d61 6e61 6765 720a  .contextmanager.
+00017dc0: 2020 2020 6465 6620 6372 6561 7465 5f73      def create_s
+00017dd0: 796d 6c69 6e6b 7328 7365 6c66 2c20 7379  ymlinks(self, sy
+00017de0: 6d6c 696e 6b73 293a 0a20 2020 2020 2020  mlinks):.       
+00017df0: 2066 6f72 206c 696e 6b20 696e 2073 796d   for link in sym
+00017e00: 6c69 6e6b 733a 0a20 2020 2020 2020 2020  links:.         
+00017e10: 2020 206f 732e 7379 6d6c 696e 6b28 6c69     os.symlink(li
+00017e20: 6e6b 5b30 5d2c 206c 696e 6b5b 315d 290a  nk[0], link[1]).
+00017e30: 0a20 2020 2020 2020 2079 6965 6c64 0a0a  .        yield..
+00017e40: 2020 2020 2020 2020 666f 7220 6c69 6e6b          for link
+00017e50: 2069 6e20 7379 6d6c 696e 6b73 3a0a 2020   in symlinks:.  
+00017e60: 2020 2020 2020 2020 2020 6f73 2e75 6e6c            os.unl
+00017e70: 696e 6b28 6c69 6e6b 5b31 5d29 0a0a 2020  ink(link[1])..  
+00017e80: 2020 6465 6620 7465 7374 5f61 6464 5f65    def test_add_e
+00017e90: 7869 7374 696e 675f 7265 616c 5f64 6972  xisting_real_dir
+00017ea0: 6563 746f 7279 5f73 796d 6c69 6e6b 2873  ectory_symlink(s
+00017eb0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+00017ec0: 6b65 5f6f 7065 6e20 3d20 6661 6b65 5f66  ke_open = fake_f
+00017ed0: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
+00017ee0: 6c65 4f70 656e 2873 656c 662e 6669 6c65  leOpen(self.file
+00017ef0: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+00017f00: 7265 616c 5f64 6972 6563 746f 7279 203d  real_directory =
+00017f10: 206f 732e 7061 7468 2e6a 6f69 6e28 7365   os.path.join(se
+00017f20: 6c66 2e72 6f6f 745f 7061 7468 2c20 2270  lf.root_path, "p
+00017f30: 7966 616b 6566 7322 2c20 2274 6573 7473  yfakefs", "tests
+00017f40: 2229 0a20 2020 2020 2020 2073 796d 6c69  ").        symli
+00017f50: 6e6b 7320 3d20 5b0a 2020 2020 2020 2020  nks = [.        
+00017f60: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+00017f70: 2020 2020 2020 222e 2e22 2c0a 2020 2020        "..",.    
+00017f80: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
+00017f90: 6174 682e 6a6f 696e 2872 6561 6c5f 6469  ath.join(real_di
+00017fa0: 7265 6374 6f72 792c 2022 6669 7874 7572  rectory, "fixtur
+00017fb0: 6573 222c 2022 7379 6d6c 696e 6b5f 6469  es", "symlink_di
+00017fc0: 725f 7265 6c61 7469 7665 2229 2c0a 2020  r_relative"),.  
+00017fd0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00017fe0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+00017ff0: 2020 2020 2020 2020 2020 2022 2e2e 2f61             "../a
+00018000: 6c6c 5f74 6573 7473 2e70 7922 2c0a 2020  ll_tests.py",.  
+00018010: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+00018020: 2e70 6174 682e 6a6f 696e 2872 6561 6c5f  .path.join(real_
+00018030: 6469 7265 6374 6f72 792c 2022 6669 7874  directory, "fixt
+00018040: 7572 6573 222c 2022 7379 6d6c 696e 6b5f  ures", "symlink_
+00018050: 6669 6c65 5f72 656c 6174 6976 6522 292c  file_relative"),
+00018060: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00018070: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
+00018080: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00018090: 616c 5f64 6972 6563 746f 7279 2c0a 2020  al_directory,.  
+000180a0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+000180b0: 2e70 6174 682e 6a6f 696e 2872 6561 6c5f  .path.join(real_
+000180c0: 6469 7265 6374 6f72 792c 2022 6669 7874  directory, "fixt
+000180d0: 7572 6573 222c 2022 7379 6d6c 696e 6b5f  ures", "symlink_
+000180e0: 6469 725f 6162 736f 6c75 7465 2229 2c0a  dir_absolute"),.
+000180f0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00018100: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+00018110: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00018120: 7061 7468 2e6a 6f69 6e28 7265 616c 5f64  path.join(real_d
+00018130: 6972 6563 746f 7279 2c20 2261 6c6c 5f74  irectory, "all_t
+00018140: 6573 7473 2e70 7922 292c 0a20 2020 2020  ests.py"),.     
+00018150: 2020 2020 2020 2020 2020 206f 732e 7061             os.pa
+00018160: 7468 2e6a 6f69 6e28 7265 616c 5f64 6972  th.join(real_dir
+00018170: 6563 746f 7279 2c20 2266 6978 7475 7265  ectory, "fixture
+00018180: 7322 2c20 2273 796d 6c69 6e6b 5f66 696c  s", "symlink_fil
+00018190: 655f 6162 736f 6c75 7465 2229 2c0a 2020  e_absolute"),.  
+000181a0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+000181b0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+000181c0: 2020 2020 2020 2020 2020 2022 2f65 7463             "/etc
+000181d0: 2f73 6f6d 6574 6869 6e67 222c 0a20 2020  /something",.   
+000181e0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+000181f0: 7061 7468 2e6a 6f69 6e28 0a20 2020 2020  path.join(.     
+00018200: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00018210: 6561 6c5f 6469 7265 6374 6f72 792c 2022  eal_directory, "
+00018220: 6669 7874 7572 6573 222c 2022 7379 6d6c  fixtures", "syml
+00018230: 696e 6b5f 6669 6c65 5f61 6273 6f6c 7574  ink_file_absolut
+00018240: 655f 6f75 7473 6964 6522 0a20 2020 2020  e_outside".     
+00018250: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+00018260: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00018270: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+00018280: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00018290: 6372 6561 7465 5f66 696c 6528 222f 6574  create_file("/et
+000182a0: 632f 736f 6d65 7468 696e 6722 290a 0a20  c/something").. 
+000182b0: 2020 2020 2020 2077 6974 6820 6661 6b65         with fake
+000182c0: 5f6f 7065 6e28 222f 6574 632f 736f 6d65  _open("/etc/some
+000182d0: 7468 696e 6722 2c20 2277 222c 2065 6e63  thing", "w", enc
+000182e0: 6f64 696e 673d 2275 7466 3822 2920 6173  oding="utf8") as
+000182f0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00018300: 662e 7772 6974 6528 2267 6f6f 6420 6d6f  f.write("good mo
+00018310: 726e 696e 6722 290a 0a20 2020 2020 2020  rning")..       
+00018320: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00018330: 2020 7769 7468 2073 656c 662e 6372 6561    with self.crea
+00018340: 7465 5f73 796d 6c69 6e6b 7328 7379 6d6c  te_symlinks(syml
+00018350: 696e 6b73 293a 0a20 2020 2020 2020 2020  inks):.         
+00018360: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00018370: 7379 7374 656d 2e61 6464 5f72 6561 6c5f  system.add_real_
+00018380: 6469 7265 6374 6f72 7928 7265 616c 5f64  directory(real_d
+00018390: 6972 6563 746f 7279 2c20 6c61 7a79 5f72  irectory, lazy_r
+000183a0: 6561 643d 4661 6c73 6529 0a20 2020 2020  ead=False).     
+000183b0: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
+000183c0: 723a 0a20 2020 2020 2020 2020 2020 2069  r:.            i
+000183d0: 6620 7365 6c66 2e69 735f 7769 6e64 6f77  f self.is_window
+000183e0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000183f0: 2020 2072 6169 7365 2075 6e69 7474 6573     raise unittes
+00018400: 742e 536b 6970 5465 7374 2822 5379 6d6c  t.SkipTest("Syml
+00018410: 696e 6b73 2075 6e64 6572 2057 696e 646f  inks under Windo
+00018420: 7773 206e 6565 6420 6164 6d69 6e20 7072  ws need admin pr
+00018430: 6976 696c 6567 6573 2229 0a20 2020 2020  ivileges").     
+00018440: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
+00018450: 2020 2020 2020 666f 7220 6c69 6e6b 2069        for link i
+00018460: 6e20 7379 6d6c 696e 6b73 3a0a 2020 2020  n symlinks:.    
+00018470: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018480: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
+00018490: 6573 7973 7465 6d2e 6973 6c69 6e6b 286c  esystem.islink(l
+000184a0: 696e 6b5b 315d 2929 0a0a 2020 2020 2020  ink[1]))..      
+000184b0: 2020 2320 7265 6c61 7469 7665 0a20 2020    # relative.   
+000184c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000184d0: 5472 7565 280a 2020 2020 2020 2020 2020  True(.          
+000184e0: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+000184f0: 6d2e 6578 6973 7473 280a 2020 2020 2020  m.exists(.      
+00018500: 2020 2020 2020 2020 2020 6f73 2e70 6174            os.pat
+00018510: 682e 6a6f 696e 280a 2020 2020 2020 2020  h.join(.        
+00018520: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00018530: 2e72 6f6f 745f 7061 7468 2c0a 2020 2020  .root_path,.    
+00018540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018550: 2270 7966 616b 6566 7322 2c0a 2020 2020  "pyfakefs",.    
+00018560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018570: 2274 6573 7473 222c 0a20 2020 2020 2020  "tests",.       
+00018580: 2020 2020 2020 2020 2020 2020 2022 6669               "fi
+00018590: 7874 7572 6573 2f73 796d 6c69 6e6b 5f64  xtures/symlink_d
+000185a0: 6972 5f72 656c 6174 6976 6522 2c0a 2020  ir_relative",.  
+000185b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000185c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000185d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000185e0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+000185f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00018600: 662e 6669 6c65 7379 7374 656d 2e65 7869  f.filesystem.exi
+00018610: 7374 7328 0a20 2020 2020 2020 2020 2020  sts(.           
+00018620: 2020 2020 206f 732e 7061 7468 2e6a 6f69       os.path.joi
+00018630: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00018640: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00018650: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+00018660: 2020 2020 2020 2020 2020 2022 7079 6661             "pyfa
+00018670: 6b65 6673 222c 0a20 2020 2020 2020 2020  kefs",.         
+00018680: 2020 2020 2020 2020 2020 2022 7465 7374             "test
+00018690: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+000186a0: 2020 2020 2020 2020 2266 6978 7475 7265          "fixture
+000186b0: 732f 7379 6d6c 696e 6b5f 6469 725f 7265  s/symlink_dir_re
+000186c0: 6c61 7469 7665 2f61 6c6c 5f74 6573 7473  lative/all_tests
+000186d0: 2e70 7922 2c0a 2020 2020 2020 2020 2020  .py",.          
+000186e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000186f0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+00018700: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018710: 6572 7454 7275 6528 0a20 2020 2020 2020  ertTrue(.       
+00018720: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00018730: 7374 656d 2e65 7869 7374 7328 0a20 2020  stem.exists(.   
+00018740: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00018750: 7061 7468 2e6a 6f69 6e28 0a20 2020 2020  path.join(.     
+00018760: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00018770: 656c 662e 726f 6f74 5f70 6174 682c 0a20  elf.root_path,. 
+00018780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018790: 2020 2022 7079 6661 6b65 6673 222c 0a20     "pyfakefs",. 
+000187a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187b0: 2020 2022 7465 7374 7322 2c0a 2020 2020     "tests",.    
+000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187d0: 2266 6978 7475 7265 732f 7379 6d6c 696e  "fixtures/symlin
+000187e0: 6b5f 6669 6c65 5f72 656c 6174 6976 6522  k_file_relative"
+000187f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018800: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00018810: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+00018820: 2020 2020 2023 2061 6273 6f6c 7574 650a       # absolute.
+00018830: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018840: 6572 7454 7275 6528 0a20 2020 2020 2020  ertTrue(.       
+00018850: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+00018860: 7374 656d 2e65 7869 7374 7328 0a20 2020  stem.exists(.   
+00018870: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00018880: 7061 7468 2e6a 6f69 6e28 0a20 2020 2020  path.join(.     
+00018890: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000188a0: 656c 662e 726f 6f74 5f70 6174 682c 0a20  elf.root_path,. 
+000188b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188c0: 2020 2022 7079 6661 6b65 6673 222c 0a20     "pyfakefs",. 
+000188d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188e0: 2020 2022 7465 7374 7322 2c0a 2020 2020     "tests",.    
+000188f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018900: 2266 6978 7475 7265 732f 7379 6d6c 696e  "fixtures/symlin
+00018910: 6b5f 6469 725f 6162 736f 6c75 7465 222c  k_dir_absolute",
+00018920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018930: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
+00018940: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00018950: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00018960: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
+00018970: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00018980: 6578 6973 7473 280a 2020 2020 2020 2020  exists(.        
+00018990: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
+000189a0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+000189b0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+000189c0: 6f6f 745f 7061 7468 2c0a 2020 2020 2020  oot_path,.      
+000189d0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+000189e0: 7966 616b 6566 7322 2c0a 2020 2020 2020  yfakefs",.      
+000189f0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
+00018a00: 6573 7473 222c 0a20 2020 2020 2020 2020  ests",.         
+00018a10: 2020 2020 2020 2020 2020 2022 6669 7874             "fixt
+00018a20: 7572 6573 2f73 796d 6c69 6e6b 5f64 6972  ures/symlink_dir
+00018a30: 5f61 6273 6f6c 7574 652f 616c 6c5f 7465  _absolute/all_te
+00018a40: 7374 732e 7079 222c 0a20 2020 2020 2020  sts.py",.       
+00018a50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00018a60: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00018a70: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00018a80: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
+00018a90: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00018aa0: 6573 7973 7465 6d2e 6578 6973 7473 280a  esystem.exists(.
+00018ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ac0: 6f73 2e70 6174 682e 6a6f 696e 280a 2020  os.path.join(.  
+00018ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ae0: 2020 7365 6c66 2e72 6f6f 745f 7061 7468    self.root_path
+00018af0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018b00: 2020 2020 2020 2270 7966 616b 6566 7322        "pyfakefs"
+00018b10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018b20: 2020 2020 2020 2274 6573 7473 222c 0a20        "tests",. 
+00018b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b40: 2020 2022 6669 7874 7572 6573 2f73 796d     "fixtures/sym
+00018b50: 6c69 6e6b 5f66 696c 655f 6162 736f 6c75  link_file_absolu
+00018b60: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
+00018b70: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00018b80: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
+00018b90: 2020 2020 2020 2020 2320 6f75 7473 6964          # outsid
+00018ba0: 650a 2020 2020 2020 2020 7365 6c66 2e61  e.        self.a
+00018bb0: 7373 6572 7454 7275 6528 0a20 2020 2020  ssertTrue(.     
+00018bc0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+00018bd0: 7379 7374 656d 2e65 7869 7374 7328 0a20  system.exists(. 
+00018be0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00018bf0: 732e 7061 7468 2e6a 6f69 6e28 0a20 2020  s.path.join(.   
 00018c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c10: 2266 6978 7475 7265 732f 7379 6d6c 696e  "fixtures/symlin
-00018c20: 6b5f 6669 6c65 5f61 6273 6f6c 7574 655f  k_file_absolute_
-00018c30: 6f75 7473 6964 6522 2c0a 2020 2020 2020  outside",.      
-00018c40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00018c50: 2020 2020 2020 2020 292e 7265 6164 2829          ).read()
-00018c60: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
-00018c70: 6f6f 6420 6d6f 726e 696e 6722 2c0a 2020  ood morning",.  
-00018c80: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00018c90: 2074 6573 745f 6164 645f 6578 6973 7469   test_add_existi
-00018ca0: 6e67 5f72 6561 6c5f 6469 7265 6374 6f72  ng_real_director
-00018cb0: 795f 7379 6d6c 696e 6b5f 7461 7267 6574  y_symlink_target
-00018cc0: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
-00018cd0: 2020 2020 2073 656c 662e 736b 6970 5f69       self.skip_i
-00018ce0: 665f 7379 6d6c 696e 6b5f 6e6f 745f 7375  f_symlink_not_su
-00018cf0: 7070 6f72 7465 6428 666f 7263 655f 7265  pported(force_re
-00018d00: 616c 5f66 733d 5472 7565 290a 2020 2020  al_fs=True).    
-00018d10: 2020 2020 7265 616c 5f64 6972 6563 746f      real_directo
-00018d20: 7279 203d 206f 732e 7061 7468 2e6a 6f69  ry = os.path.joi
-00018d30: 6e28 7365 6c66 2e72 6f6f 745f 7061 7468  n(self.root_path
-00018d40: 2c20 2270 7966 616b 6566 7322 2c20 2274  , "pyfakefs", "t
-00018d50: 6573 7473 2229 0a20 2020 2020 2020 2073  ests").        s
-00018d60: 796d 6c69 6e6b 7320 3d20 5b0a 2020 2020  ymlinks = [.    
-00018d70: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00018d80: 2020 2020 2020 2020 2020 222e 2e22 2c0a            "..",.
-00018d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018da0: 6f73 2e70 6174 682e 6a6f 696e 2872 6561  os.path.join(rea
-00018db0: 6c5f 6469 7265 6374 6f72 792c 2022 6669  l_directory, "fi
-00018dc0: 7874 7572 6573 222c 2022 7379 6d6c 696e  xtures", "symlin
-00018dd0: 6b5f 6469 725f 7265 6c61 7469 7665 2229  k_dir_relative")
-00018de0: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-00018df0: 0a20 2020 2020 2020 2020 2020 2028 0a20  .            (. 
-00018e00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018e10: 2e2e 2f61 6c6c 5f74 6573 7473 2e70 7922  ../all_tests.py"
-00018e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018e30: 2020 6f73 2e70 6174 682e 6a6f 696e 2872    os.path.join(r
-00018e40: 6561 6c5f 6469 7265 6374 6f72 792c 2022  eal_directory, "
-00018e50: 6669 7874 7572 6573 222c 2022 7379 6d6c  fixtures", "syml
-00018e60: 696e 6b5f 6669 6c65 5f72 656c 6174 6976  ink_file_relativ
-00018e70: 6522 292c 0a20 2020 2020 2020 2020 2020  e"),.           
-00018e80: 2029 2c0a 2020 2020 2020 2020 5d0a 0a20   ),.        ].. 
-00018e90: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00018ea0: 2e63 7265 6174 655f 7379 6d6c 696e 6b73  .create_symlinks
-00018eb0: 2873 796d 6c69 6e6b 7329 3a0a 2020 2020  (symlinks):.    
-00018ec0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00018ed0: 6573 7973 7465 6d2e 6164 645f 7265 616c  esystem.add_real
-00018ee0: 5f64 6972 6563 746f 7279 280a 2020 2020  _directory(.    
-00018ef0: 2020 2020 2020 2020 2020 2020 7265 616c              real
-00018f00: 5f64 6972 6563 746f 7279 2c20 7461 7267  _directory, targ
-00018f10: 6574 5f70 6174 683d 222f 7061 7468 222c  et_path="/path",
-00018f20: 206c 617a 795f 7265 6164 3d46 616c 7365   lazy_read=False
-00018f30: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00018f40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00018f50: 6572 7454 7275 6528 7365 6c66 2e66 696c  ertTrue(self.fil
-00018f60: 6573 7973 7465 6d2e 6578 6973 7473 2822  esystem.exists("
-00018f70: 2f70 6174 682f 6669 7874 7572 6573 2f73  /path/fixtures/s
-00018f80: 796d 6c69 6e6b 5f64 6972 5f72 656c 6174  ymlink_dir_relat
-00018f90: 6976 6522 2929 0a20 2020 2020 2020 2073  ive")).        s
-00018fa0: 656c 662e 6173 7365 7274 5472 7565 280a  elf.assertTrue(.
-00018fb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018fc0: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
-00018fd0: 7473 2822 2f70 6174 682f 6669 7874 7572  ts("/path/fixtur
-00018fe0: 6573 2f73 796d 6c69 6e6b 5f64 6972 5f72  es/symlink_dir_r
-00018ff0: 656c 6174 6976 652f 616c 6c5f 7465 7374  elative/all_test
-00019000: 732e 7079 2229 0a20 2020 2020 2020 2029  s.py").        )
-00019010: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00019020: 7365 7274 5472 7565 2873 656c 662e 6669  sertTrue(self.fi
-00019030: 6c65 7379 7374 656d 2e65 7869 7374 7328  lesystem.exists(
-00019040: 222f 7061 7468 2f66 6978 7475 7265 732f  "/path/fixtures/
-00019050: 7379 6d6c 696e 6b5f 6669 6c65 5f72 656c  symlink_file_rel
-00019060: 6174 6976 6522 2929 0a0a 2020 2020 6465  ative"))..    de
-00019070: 6620 7465 7374 5f61 6464 5f65 7869 7374  f test_add_exist
-00019080: 696e 675f 7265 616c 5f64 6972 6563 746f  ing_real_directo
-00019090: 7279 5f73 796d 6c69 6e6b 5f6c 617a 795f  ry_symlink_lazy_
-000190a0: 7265 6164 2873 656c 6629 3a0a 2020 2020  read(self):.    
-000190b0: 2020 2020 7365 6c66 2e73 6b69 705f 6966      self.skip_if
-000190c0: 5f73 796d 6c69 6e6b 5f6e 6f74 5f73 7570  _symlink_not_sup
-000190d0: 706f 7274 6564 2866 6f72 6365 5f72 6561  ported(force_rea
-000190e0: 6c5f 6673 3d54 7275 6529 0a20 2020 2020  l_fs=True).     
-000190f0: 2020 2072 6561 6c5f 6469 7265 6374 6f72     real_director
-00019100: 7920 3d20 6f73 2e70 6174 682e 6a6f 696e  y = os.path.join
-00019110: 2873 656c 662e 726f 6f74 5f70 6174 682c  (self.root_path,
-00019120: 2022 7079 6661 6b65 6673 222c 2022 7465   "pyfakefs", "te
-00019130: 7374 7322 290a 2020 2020 2020 2020 7379  sts").        sy
-00019140: 6d6c 696e 6b73 203d 205b 0a20 2020 2020  mlinks = [.     
-00019150: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-00019160: 2020 2020 2020 2020 2022 2e2e 222c 0a20           "..",. 
-00019170: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00019180: 732e 7061 7468 2e6a 6f69 6e28 7265 616c  s.path.join(real
-00019190: 5f64 6972 6563 746f 7279 2c20 2266 6978  _directory, "fix
-000191a0: 7475 7265 7322 2c20 2273 796d 6c69 6e6b  tures", "symlink
-000191b0: 5f64 6972 5f72 656c 6174 6976 6522 292c  _dir_relative"),
-000191c0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-000191d0: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
-000191e0: 2020 2020 2020 2020 2020 2020 2020 222e                ".
-000191f0: 2e2f 616c 6c5f 7465 7374 732e 7079 222c  ./all_tests.py",
-00019200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019210: 206f 732e 7061 7468 2e6a 6f69 6e28 7265   os.path.join(re
-00019220: 616c 5f64 6972 6563 746f 7279 2c20 2266  al_directory, "f
-00019230: 6978 7475 7265 7322 2c20 2273 796d 6c69  ixtures", "symli
-00019240: 6e6b 5f66 696c 655f 7265 6c61 7469 7665  nk_file_relative
-00019250: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00019260: 292c 0a20 2020 2020 2020 205d 0a0a 2020  ),.        ]..  
-00019270: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00019280: 6372 6561 7465 5f73 796d 6c69 6e6b 7328  create_symlinks(
-00019290: 7379 6d6c 696e 6b73 293a 0a20 2020 2020  symlinks):.     
-000192a0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-000192b0: 7379 7374 656d 2e61 6464 5f72 6561 6c5f  system.add_real_
-000192c0: 6469 7265 6374 6f72 7928 0a20 2020 2020  directory(.     
-000192d0: 2020 2020 2020 2020 2020 2072 6561 6c5f             real_
-000192e0: 6469 7265 6374 6f72 792c 2074 6172 6765  directory, targe
-000192f0: 745f 7061 7468 3d22 2f70 6174 6822 2c20  t_path="/path", 
-00019300: 6c61 7a79 5f72 6561 643d 5472 7565 0a20  lazy_read=True. 
-00019310: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00019320: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00019330: 7373 6572 7454 7275 6528 0a20 2020 2020  ssertTrue(.     
-00019340: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019350: 6669 6c65 7379 7374 656d 2e65 7869 7374  filesystem.exist
-00019360: 7328 222f 7061 7468 2f66 6978 7475 7265  s("/path/fixture
-00019370: 732f 7379 6d6c 696e 6b5f 6469 725f 7265  s/symlink_dir_re
-00019380: 6c61 7469 7665 2229 0a20 2020 2020 2020  lative").       
-00019390: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000193a0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-000193b0: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-000193c0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-000193d0: 7465 6d2e 6578 6973 7473 280a 2020 2020  tem.exists(.    
-000193e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193f0: 222f 7061 7468 2f66 6978 7475 7265 732f  "/path/fixtures/
-00019400: 7379 6d6c 696e 6b5f 6469 725f 7265 6c61  symlink_dir_rela
-00019410: 7469 7665 2f61 6c6c 5f74 6573 7473 2e70  tive/all_tests.p
-00019420: 7922 0a20 2020 2020 2020 2020 2020 2020  y".             
-00019430: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00019440: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-00019450: 656c 662e 6173 7365 7274 5472 7565 280a  elf.assertTrue(.
-00019460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019470: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00019480: 6578 6973 7473 2822 2f70 6174 682f 6669  exists("/path/fi
-00019490: 7874 7572 6573 2f73 796d 6c69 6e6b 5f66  xtures/symlink_f
-000194a0: 696c 655f 7265 6c61 7469 7665 2229 0a20  ile_relative"). 
-000194b0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-000194c0: 2020 6465 6620 7465 7374 5f61 6464 5f65    def test_add_e
-000194d0: 7869 7374 696e 675f 7265 616c 5f64 6972  xisting_real_dir
-000194e0: 6563 746f 7279 5f74 7265 655f 746f 5f6f  ectory_tree_to_o
-000194f0: 7468 6572 5f70 6174 6828 7365 6c66 293a  ther_path(self):
-00019500: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00019510: 6c65 7379 7374 656d 2e61 6464 5f72 6561  lesystem.add_rea
-00019520: 6c5f 6469 7265 6374 6f72 7928 7365 6c66  l_directory(self
-00019530: 2e72 6f6f 745f 7061 7468 2c20 7461 7267  .root_path, targ
-00019540: 6574 5f70 6174 683d 222f 666f 6f2f 6261  et_path="/foo/ba
-00019550: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
-00019560: 2e61 7373 6572 7446 616c 7365 280a 2020  .assertFalse(.  
-00019570: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-00019580: 696c 6573 7973 7465 6d2e 6578 6973 7473  ilesystem.exists
-00019590: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000195a0: 2020 6f73 2e70 6174 682e 6a6f 696e 2873    os.path.join(s
-000195b0: 656c 662e 7079 6661 6b65 6673 5f70 6174  elf.pyfakefs_pat
-000195c0: 682c 2022 7465 7374 7322 2c20 2266 616b  h, "tests", "fak
-000195d0: 655f 6669 6c65 7379 7374 656d 5f74 6573  e_filesystem_tes
-000195e0: 742e 7079 2229 0a20 2020 2020 2020 2020  t.py").         
-000195f0: 2020 2029 0a20 2020 2020 2020 2029 0a20     ).        ). 
-00019600: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00019610: 7274 5472 7565 280a 2020 2020 2020 2020  rtTrue(.        
-00019620: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00019630: 7465 6d2e 6578 6973 7473 280a 2020 2020  tem.exists(.    
-00019640: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
-00019650: 6174 682e 6a6f 696e 280a 2020 2020 2020  ath.join(.      
-00019660: 2020 2020 2020 2020 2020 2020 2020 2266                "f
-00019670: 6f6f 222c 0a20 2020 2020 2020 2020 2020  oo",.           
-00019680: 2020 2020 2020 2020 2022 6261 7222 2c0a           "bar",.
-00019690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196a0: 2020 2020 2270 7966 616b 6566 7322 2c0a      "pyfakefs",.
-000196b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196c0: 2020 2020 2274 6573 7473 222c 0a20 2020      "tests",.   
-000196d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196e0: 2022 6661 6b65 5f66 696c 6573 7973 7465   "fake_filesyste
-000196f0: 6d5f 7465 7374 2e70 7922 2c0a 2020 2020  m_test.py",.    
-00019700: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00019710: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00019720: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00019730: 6c66 2e61 7373 6572 7446 616c 7365 280a  lf.assertFalse(.
-00019740: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019750: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
-00019760: 7473 280a 2020 2020 2020 2020 2020 2020  ts(.            
-00019770: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
-00019780: 2873 656c 662e 726f 6f74 5f70 6174 682c  (self.root_path,
-00019790: 2022 7079 6661 6b65 6673 222c 2022 6661   "pyfakefs", "fa
-000197a0: 6b65 5f66 696c 6573 7973 7465 6d2e 7079  ke_filesystem.py
-000197b0: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
-000197c0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000197d0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-000197e0: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-000197f0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-00019800: 6578 6973 7473 280a 2020 2020 2020 2020  exists(.        
-00019810: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
-00019820: 6a6f 696e 2822 666f 6f22 2c20 2262 6172  join("foo", "bar
-00019830: 222c 2022 7079 6661 6b65 6673 222c 2022  ", "pyfakefs", "
-00019840: 5f5f 696e 6974 5f5f 2e70 7922 290a 2020  __init__.py").  
-00019850: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00019860: 2020 2020 290a 0a20 2020 2064 6566 2074      )..    def t
-00019870: 6573 745f 6765 745f 6f62 6a65 6374 5f66  est_get_object_f
-00019880: 726f 6d5f 6c61 7a69 6c79 5f61 6464 6564  rom_lazily_added
-00019890: 5f72 6561 6c5f 6469 7265 6374 6f72 7928  _real_directory(
-000198a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-000198b0: 656c 662e 6669 6c65 7379 7374 656d 2e69  elf.filesystem.i
-000198c0: 735f 6361 7365 5f73 656e 7369 7469 7665  s_case_sensitive
-000198d0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-000198e0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-000198f0: 6164 645f 7265 616c 5f64 6972 6563 746f  add_real_directo
-00019900: 7279 2873 656c 662e 726f 6f74 5f70 6174  ry(self.root_pat
-00019910: 6829 0a20 2020 2020 2020 2073 656c 662e  h).        self.
-00019920: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
-00019930: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-00019940: 6573 7973 7465 6d2e 6765 745f 6f62 6a65  esystem.get_obje
-00019950: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-00019960: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
-00019970: 2873 656c 662e 726f 6f74 5f70 6174 682c  (self.root_path,
-00019980: 2022 7079 6661 6b65 6673 222c 2022 6661   "pyfakefs", "fa
-00019990: 6b65 5f66 696c 6573 7973 7465 6d2e 7079  ke_filesystem.py
-000199a0: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
-000199b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000199c0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-000199d0: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-000199e0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
-000199f0: 6765 745f 6f62 6a65 6374 280a 2020 2020  get_object(.    
-00019a00: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
-00019a10: 6174 682e 6a6f 696e 2873 656c 662e 726f  ath.join(self.ro
-00019a20: 6f74 5f70 6174 682c 2022 7079 6661 6b65  ot_path, "pyfake
-00019a30: 6673 222c 2022 5f5f 696e 6974 5f5f 2e70  fs", "__init__.p
-00019a40: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
-00019a50: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-00019a60: 2064 6566 2074 6573 745f 6164 645f 6578   def test_add_ex
-00019a70: 6973 7469 6e67 5f72 6561 6c5f 6469 7265  isting_real_dire
-00019a80: 6374 6f72 795f 6c61 7a69 6c79 2873 656c  ctory_lazily(sel
-00019a90: 6629 3a0a 2020 2020 2020 2020 6469 736b  f):.        disk
-00019aa0: 5f73 697a 6520 3d20 3130 3234 202a 2031  _size = 1024 * 1
-00019ab0: 3032 3420 2a20 3130 3234 0a20 2020 2020  024 * 1024.     
-00019ac0: 2020 2072 6561 6c5f 6469 725f 7061 7468     real_dir_path
-00019ad0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-00019ae0: 7365 6c66 2e72 6f6f 745f 7061 7468 2c20  self.root_path, 
-00019af0: 2270 7966 616b 6566 7322 290a 2020 2020  "pyfakefs").    
-00019b00: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
-00019b10: 7465 6d2e 7365 745f 6469 736b 5f75 7361  tem.set_disk_usa
-00019b20: 6765 2864 6973 6b5f 7369 7a65 2c20 7265  ge(disk_size, re
-00019b30: 616c 5f64 6972 5f70 6174 6829 0a20 2020  al_dir_path).   
-00019b40: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00019b50: 7374 656d 2e61 6464 5f72 6561 6c5f 6469  stem.add_real_di
-00019b60: 7265 6374 6f72 7928 7265 616c 5f64 6972  rectory(real_dir
-00019b70: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00019b80: 2320 7468 6520 6469 7265 6374 6f72 7920  # the directory 
-00019b90: 636f 6e74 656e 7473 2068 6176 6520 6e6f  contents have no
-00019ba0: 7420 6265 656e 2072 6561 642c 2074 6865  t been read, the
-00019bb0: 2064 6973 6b20 7573 6167 650a 2020 2020   disk usage.    
-00019bc0: 2020 2020 2320 6861 7320 6e6f 7420 6368      # has not ch
-00019bd0: 616e 6765 640a 2020 2020 2020 2020 7365  anged.        se
-00019be0: 6c66 2e61 7373 6572 7445 7175 616c 2864  lf.assertEqual(d
-00019bf0: 6973 6b5f 7369 7a65 2c20 7365 6c66 2e66  isk_size, self.f
-00019c00: 696c 6573 7973 7465 6d2e 6765 745f 6469  ilesystem.get_di
-00019c10: 736b 5f75 7361 6765 2872 6561 6c5f 6469  sk_usage(real_di
-00019c20: 725f 7061 7468 292e 6672 6565 290a 2020  r_path).free).  
-00019c30: 2020 2020 2020 2320 6368 6563 6b69 6e67        # checking
-00019c40: 2066 6f72 2065 7869 7374 656e 6365 2073   for existence s
-00019c50: 6861 6c6c 2072 6561 6420 7468 6520 6469  hall read the di
-00019c60: 7265 6374 6f72 7920 636f 6e74 656e 7473  rectory contents
-00019c70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00019c80: 7365 7274 5472 7565 280a 2020 2020 2020  sertTrue(.      
-00019c90: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-00019ca0: 7973 7465 6d2e 6765 745f 6f62 6a65 6374  ystem.get_object
-00019cb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00019cc0: 2020 6f73 2e70 6174 682e 6a6f 696e 2872    os.path.join(r
-00019cd0: 6561 6c5f 6469 725f 7061 7468 2c20 2266  eal_dir_path, "f
-00019ce0: 616b 655f 6669 6c65 7379 7374 656d 2e70  ake_filesystem.p
-00019cf0: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
-00019d00: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00019d10: 2020 2020 2320 736f 206e 6f77 2074 6865      # so now the
-00019d20: 2066 7265 6520 6469 736b 2073 7061 6365   free disk space
-00019d30: 2073 6861 6c6c 2068 6176 6520 6465 6372   shall have decr
-00019d40: 6561 7365 640a 2020 2020 2020 2020 7365  eased.        se
-00019d50: 6c66 2e61 7373 6572 7447 7265 6174 6572  lf.assertGreater
-00019d60: 280a 2020 2020 2020 2020 2020 2020 6469  (.            di
-00019d70: 736b 5f73 697a 652c 2073 656c 662e 6669  sk_size, self.fi
-00019d80: 6c65 7379 7374 656d 2e67 6574 5f64 6973  lesystem.get_dis
-00019d90: 6b5f 7573 6167 6528 7265 616c 5f64 6972  k_usage(real_dir
-00019da0: 5f70 6174 6829 2e66 7265 650a 2020 2020  _path).free.    
-00019db0: 2020 2020 290a 0a20 2020 2064 6566 2074      )..    def t
-00019dc0: 6573 745f 6164 645f 6578 6973 7469 6e67  est_add_existing
-00019dd0: 5f72 6561 6c5f 6469 7265 6374 6f72 795f  _real_directory_
-00019de0: 6e6f 745f 6c61 7a69 6c79 2873 656c 6629  not_lazily(self)
-00019df0: 3a0a 2020 2020 2020 2020 6469 736b 5f73  :.        disk_s
-00019e00: 697a 6520 3d20 3130 3234 202a 2031 3032  ize = 1024 * 102
-00019e10: 3420 2a20 3130 3234 0a20 2020 2020 2020  4 * 1024.       
-00019e20: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-00019e30: 2e73 6574 5f64 6973 6b5f 7573 6167 6528  .set_disk_usage(
-00019e40: 6469 736b 5f73 697a 652c 2073 656c 662e  disk_size, self.
-00019e50: 7079 6661 6b65 6673 5f70 6174 6829 0a20  pyfakefs_path). 
-00019e60: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-00019e70: 7379 7374 656d 2e61 6464 5f72 6561 6c5f  system.add_real_
-00019e80: 6469 7265 6374 6f72 7928 7365 6c66 2e70  directory(self.p
-00019e90: 7966 616b 6566 735f 7061 7468 2c20 6c61  yfakefs_path, la
-00019ea0: 7a79 5f72 6561 643d 4661 6c73 6529 0a0a  zy_read=False)..
-00019eb0: 2020 2020 2020 2020 2320 7468 6520 6469          # the di
-00019ec0: 7265 6374 6f72 7920 6861 7320 6265 656e  rectory has been
-00019ed0: 2072 6561 642c 2073 6f20 7468 6520 6669   read, so the fi
-00019ee0: 6c65 2073 697a 6573 2068 6176 650a 2020  le sizes have.  
-00019ef0: 2020 2020 2020 2320 6265 656e 2073 7562        # been sub
-00019f00: 7472 6163 7465 6420 6672 6f6d 2074 6865  tracted from the
-00019f10: 2066 7265 6520 7370 6163 650a 2020 2020   free space.    
-00019f20: 2020 2020 7365 6c66 2e61 7373 6572 7447      self.assertG
-00019f30: 7265 6174 6572 280a 2020 2020 2020 2020  reater(.        
-00019f40: 2020 2020 6469 736b 5f73 697a 652c 2073      disk_size, s
-00019f50: 656c 662e 6669 6c65 7379 7374 656d 2e67  elf.filesystem.g
-00019f60: 6574 5f64 6973 6b5f 7573 6167 6528 7365  et_disk_usage(se
-00019f70: 6c66 2e70 7966 616b 6566 735f 7061 7468  lf.pyfakefs_path
-00019f80: 292e 6672 6565 0a20 2020 2020 2020 2029  ).free.        )
-00019f90: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
-00019fa0: 6464 5f65 7869 7374 696e 675f 7265 616c  dd_existing_real
-00019fb0: 5f64 6972 6563 746f 7279 5f72 6561 645f  _directory_read_
-00019fc0: 7772 6974 6528 7365 6c66 293a 0a20 2020  write(self):.   
-00019fd0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
-00019fe0: 7374 656d 2e61 6464 5f72 6561 6c5f 6469  stem.add_real_di
-00019ff0: 7265 6374 6f72 7928 7365 6c66 2e70 7966  rectory(self.pyf
-0001a000: 616b 6566 735f 7061 7468 2c20 7265 6164  akefs_path, read
-0001a010: 5f6f 6e6c 793d 4661 6c73 6529 0a20 2020  _only=False).   
-0001a020: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001a030: 5472 7565 2873 656c 662e 6669 6c65 7379  True(self.filesy
-0001a040: 7374 656d 2e65 7869 7374 7328 7365 6c66  stem.exists(self
-0001a050: 2e70 7966 616b 6566 735f 7061 7468 2929  .pyfakefs_path))
-0001a060: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a070: 7365 7274 5472 7565 280a 2020 2020 2020  sertTrue(.      
-0001a080: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-0001a090: 7973 7465 6d2e 6578 6973 7473 280a 2020  ystem.exists(.  
-0001a0a0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
-0001a0b0: 2e70 6174 682e 6a6f 696e 2873 656c 662e  .path.join(self.
-0001a0c0: 7079 6661 6b65 6673 5f70 6174 682c 2022  pyfakefs_path, "
-0001a0d0: 6661 6b65 5f66 696c 6573 7973 7465 6d2e  fake_filesystem.
-0001a0e0: 7079 2229 0a20 2020 2020 2020 2020 2020  py").           
-0001a0f0: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
-0001a100: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001a110: 5472 7565 280a 2020 2020 2020 2020 2020  True(.          
-0001a120: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
-0001a130: 6d2e 6578 6973 7473 286f 732e 7061 7468  m.exists(os.path
-0001a140: 2e6a 6f69 6e28 7365 6c66 2e70 7966 616b  .join(self.pyfak
-0001a150: 6566 735f 7061 7468 2c20 2266 616b 655f  efs_path, "fake_
-0001a160: 7061 7468 6c69 622e 7079 2229 290a 2020  pathlib.py")).  
-0001a170: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001a180: 2066 696c 655f 7061 7468 203d 206f 732e   file_path = os.
-0001a190: 7061 7468 2e6a 6f69 6e28 7365 6c66 2e70  path.join(self.p
-0001a1a0: 7966 616b 6566 735f 7061 7468 2c20 2270  yfakefs_path, "p
-0001a1b0: 7974 6573 745f 706c 7567 696e 2e70 7922  ytest_plugin.py"
-0001a1c0: 290a 2020 2020 2020 2020 6661 6b65 5f66  ).        fake_f
-0001a1d0: 696c 6520 3d20 7365 6c66 2e66 696c 6573  ile = self.files
-0001a1e0: 7973 7465 6d2e 7265 736f 6c76 6528 6669  ystem.resolve(fi
-0001a1f0: 6c65 5f70 6174 6829 0a20 2020 2020 2020  le_path).       
-0001a200: 2073 656c 662e 6368 6563 6b5f 6661 6b65   self.check_fake
-0001a210: 5f66 696c 655f 7374 6174 2866 616b 655f  _file_stat(fake_
-0001a220: 6669 6c65 2c20 6669 6c65 5f70 6174 6829  file, file_path)
-0001a230: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-0001a240: 6563 6b5f 7772 6974 6162 6c65 5f66 696c  eck_writable_fil
-0001a250: 6528 6661 6b65 5f66 696c 652c 2066 696c  e(fake_file, fil
-0001a260: 655f 7061 7468 290a 0a20 2020 2064 6566  e_path)..    def
-0001a270: 2074 6573 745f 6164 645f 6578 6973 7469   test_add_existi
-0001a280: 6e67 5f72 6561 6c5f 7061 7468 735f 7265  ng_real_paths_re
-0001a290: 6164 5f6f 6e6c 7928 7365 6c66 293a 0a20  ad_only(self):. 
-0001a2a0: 2020 2020 2020 2072 6561 6c5f 6669 6c65         real_file
-0001a2b0: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-0001a2c0: 7265 616c 7061 7468 285f 5f66 696c 655f  realpath(__file_
-0001a2d0: 5f29 0a20 2020 2020 2020 2066 6978 7475  _).        fixtu
-0001a2e0: 7265 5f70 6174 6820 3d20 6f73 2e70 6174  re_path = os.pat
-0001a2f0: 682e 6a6f 696e 2873 656c 662e 7079 6661  h.join(self.pyfa
-0001a300: 6b65 6673 5f70 6174 682c 2022 7465 7374  kefs_path, "test
-0001a310: 7322 2c20 2266 6978 7475 7265 7322 290a  s", "fixtures").
-0001a320: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
-0001a330: 6573 7973 7465 6d2e 6164 645f 7265 616c  esystem.add_real
-0001a340: 5f70 6174 6873 285b 7265 616c 5f66 696c  _paths([real_fil
-0001a350: 655f 7061 7468 2c20 6669 7874 7572 655f  e_path, fixture_
-0001a360: 7061 7468 5d29 0a0a 2020 2020 2020 2020  path])..        
-0001a370: 6661 6b65 5f66 696c 6520 3d20 7365 6c66  fake_file = self
-0001a380: 2e66 696c 6573 7973 7465 6d2e 7265 736f  .filesystem.reso
-0001a390: 6c76 6528 7265 616c 5f66 696c 655f 7061  lve(real_file_pa
-0001a3a0: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
-0001a3b0: 2e63 6865 636b 5f66 616b 655f 6669 6c65  .check_fake_file
-0001a3c0: 5f73 7461 7428 6661 6b65 5f66 696c 652c  _stat(fake_file,
-0001a3d0: 2072 6561 6c5f 6669 6c65 5f70 6174 6829   real_file_path)
-0001a3e0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-0001a3f0: 6563 6b5f 7265 6164 5f6f 6e6c 795f 6669  eck_read_only_fi
-0001a400: 6c65 2866 616b 655f 6669 6c65 2c20 7265  le(fake_file, re
-0001a410: 616c 5f66 696c 655f 7061 7468 290a 0a20  al_file_path).. 
-0001a420: 2020 2020 2020 2072 6561 6c5f 6669 6c65         real_file
-0001a430: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-0001a440: 6a6f 696e 2866 6978 7475 7265 5f70 6174  join(fixture_pat
-0001a450: 682c 2022 6d6f 6475 6c65 5f77 6974 685f  h, "module_with_
-0001a460: 6174 7472 6962 7574 6573 2e70 7922 290a  attributes.py").
-0001a470: 2020 2020 2020 2020 6661 6b65 5f66 696c          fake_fil
-0001a480: 6520 3d20 7365 6c66 2e66 696c 6573 7973  e = self.filesys
-0001a490: 7465 6d2e 7265 736f 6c76 6528 7265 616c  tem.resolve(real
-0001a4a0: 5f66 696c 655f 7061 7468 290a 2020 2020  _file_path).    
-0001a4b0: 2020 2020 7365 6c66 2e63 6865 636b 5f66      self.check_f
-0001a4c0: 616b 655f 6669 6c65 5f73 7461 7428 6661  ake_file_stat(fa
-0001a4d0: 6b65 5f66 696c 652c 2072 6561 6c5f 6669  ke_file, real_fi
-0001a4e0: 6c65 5f70 6174 6829 0a20 2020 2020 2020  le_path).       
-0001a4f0: 2073 656c 662e 6368 6563 6b5f 7265 6164   self.check_read
-0001a500: 5f6f 6e6c 795f 6669 6c65 2866 616b 655f  _only_file(fake_
-0001a510: 6669 6c65 2c20 7265 616c 5f66 696c 655f  file, real_file_
-0001a520: 7061 7468 290a 0a20 2020 2064 6566 2074  path)..    def t
-0001a530: 6573 745f 6164 645f 6578 6973 7469 6e67  est_add_existing
-0001a540: 5f72 6561 6c5f 7061 7468 735f 7265 6164  _real_paths_read
-0001a550: 5f77 7269 7465 2873 656c 6629 3a0a 2020  _write(self):.  
-0001a560: 2020 2020 2020 7265 616c 5f66 696c 655f        real_file_
-0001a570: 7061 7468 203d 206f 732e 7061 7468 2e72  path = os.path.r
-0001a580: 6561 6c70 6174 6828 5f5f 6669 6c65 5f5f  ealpath(__file__
-0001a590: 290a 2020 2020 2020 2020 6669 7874 7572  ).        fixtur
-0001a5a0: 655f 7061 7468 203d 206f 732e 7061 7468  e_path = os.path
-0001a5b0: 2e6a 6f69 6e28 7365 6c66 2e70 7966 616b  .join(self.pyfak
-0001a5c0: 6566 735f 7061 7468 2c20 2274 6573 7473  efs_path, "tests
-0001a5d0: 222c 2022 6669 7874 7572 6573 2229 0a20  ", "fixtures"). 
-0001a5e0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
-0001a5f0: 7379 7374 656d 2e61 6464 5f72 6561 6c5f  system.add_real_
-0001a600: 7061 7468 7328 5b72 6561 6c5f 6669 6c65  paths([real_file
-0001a610: 5f70 6174 682c 2066 6978 7475 7265 5f70  _path, fixture_p
-0001a620: 6174 685d 2c20 7265 6164 5f6f 6e6c 793d  ath], read_only=
-0001a630: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
-0001a640: 6661 6b65 5f66 696c 6520 3d20 7365 6c66  fake_file = self
-0001a650: 2e66 696c 6573 7973 7465 6d2e 7265 736f  .filesystem.reso
-0001a660: 6c76 6528 7265 616c 5f66 696c 655f 7061  lve(real_file_pa
-0001a670: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
-0001a680: 2e63 6865 636b 5f66 616b 655f 6669 6c65  .check_fake_file
-0001a690: 5f73 7461 7428 6661 6b65 5f66 696c 652c  _stat(fake_file,
-0001a6a0: 2072 6561 6c5f 6669 6c65 5f70 6174 6829   real_file_path)
-0001a6b0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-0001a6c0: 6563 6b5f 7772 6974 6162 6c65 5f66 696c  eck_writable_fil
-0001a6d0: 6528 6661 6b65 5f66 696c 652c 2072 6561  e(fake_file, rea
-0001a6e0: 6c5f 6669 6c65 5f70 6174 6829 0a0a 2020  l_file_path)..  
-0001a6f0: 2020 2020 2020 7265 616c 5f66 696c 655f        real_file_
-0001a700: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-0001a710: 6f69 6e28 6669 7874 7572 655f 7061 7468  oin(fixture_path
-0001a720: 2c20 226d 6f64 756c 655f 7769 7468 5f61  , "module_with_a
-0001a730: 7474 7269 6275 7465 732e 7079 2229 0a20  ttributes.py"). 
-0001a740: 2020 2020 2020 2066 616b 655f 6669 6c65         fake_file
-0001a750: 203d 2073 656c 662e 6669 6c65 7379 7374   = self.filesyst
-0001a760: 656d 2e72 6573 6f6c 7665 2872 6561 6c5f  em.resolve(real_
-0001a770: 6669 6c65 5f70 6174 6829 0a20 2020 2020  file_path).     
-0001a780: 2020 2073 656c 662e 6368 6563 6b5f 6661     self.check_fa
-0001a790: 6b65 5f66 696c 655f 7374 6174 2866 616b  ke_file_stat(fak
-0001a7a0: 655f 6669 6c65 2c20 7265 616c 5f66 696c  e_file, real_fil
-0001a7b0: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
-0001a7c0: 7365 6c66 2e63 6865 636b 5f77 7269 7461  self.check_writa
-0001a7d0: 626c 655f 6669 6c65 2866 616b 655f 6669  ble_file(fake_fi
-0001a7e0: 6c65 2c20 7265 616c 5f66 696c 655f 7061  le, real_file_pa
-0001a7f0: 7468 290a 0a0a 636c 6173 7320 4669 6c65  th)...class File
-0001a800: 5369 6465 4566 6665 6374 5465 7374 7328  SideEffectTests(
-0001a810: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
-0001a820: 6566 2073 6964 655f 6566 6665 6374 2873  ef side_effect(s
-0001a830: 656c 6629 3a0a 2020 2020 2020 2020 7465  elf):.        te
-0001a840: 7374 5f63 6173 6520 3d20 7365 6c66 0a20  st_case = self. 
-0001a850: 2020 2020 2020 2074 6573 745f 6361 7365         test_case
-0001a860: 2e73 6964 655f 6566 6665 6374 5f63 616c  .side_effect_cal
-0001a870: 6c65 6420 3d20 4661 6c73 650a 0a20 2020  led = False..   
-0001a880: 2020 2020 2064 6566 205f 5f73 6964 655f       def __side_
-0001a890: 6566 6665 6374 2866 696c 655f 6f62 6a65  effect(file_obje
-0001a8a0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-0001a8b0: 2074 6573 745f 6361 7365 2e73 6964 655f   test_case.side_
-0001a8c0: 6566 6665 6374 5f63 616c 6c65 6420 3d20  effect_called = 
-0001a8d0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001a8e0: 2074 6573 745f 6361 7365 2e73 6964 655f   test_case.side_
-0001a8f0: 6566 6665 6374 5f66 696c 655f 6f62 6a65  effect_file_obje
-0001a900: 6374 5f63 6f6e 7465 6e74 203d 2066 696c  ct_content = fil
-0001a910: 655f 6f62 6a65 6374 2e63 6f6e 7465 6e74  e_object.content
-0001a920: 730a 0a20 2020 2020 2020 2072 6574 7572  s..        retur
-0001a930: 6e20 5f5f 7369 6465 5f65 6666 6563 740a  n __side_effect.
-0001a940: 0a20 2020 2064 6566 2073 6574 5570 2873  .    def setUp(s
-0001a950: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-0001a960: 7573 6520 7468 6520 7265 616c 2070 6174  use the real pat
-0001a970: 6820 7365 7061 7261 746f 7220 746f 2077  h separator to w
-0001a980: 6f72 6b20 7769 7468 2074 6865 2072 6561  ork with the rea
-0001a990: 6c20 6669 6c65 2073 7973 7465 6d0a 2020  l file system.  
-0001a9a0: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
-0001a9b0: 7973 7465 6d20 3d20 6661 6b65 5f66 696c  ystem = fake_fil
-0001a9c0: 6573 7973 7465 6d2e 4661 6b65 4669 6c65  esystem.FakeFile
-0001a9d0: 7379 7374 656d 2829 0a20 2020 2020 2020  system().       
-0001a9e0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
-0001a9f0: 2e63 7265 6174 655f 6669 6c65 2822 2f61  .create_file("/a
-0001aa00: 2f62 2f66 696c 655f 6f6e 6522 2c20 7369  /b/file_one", si
-0001aa10: 6465 5f65 6666 6563 743d 7365 6c66 2e73  de_effect=self.s
-0001aa20: 6964 655f 6566 6665 6374 2829 290a 0a20  ide_effect()).. 
-0001aa30: 2020 2064 6566 2074 6573 745f 7369 6465     def test_side
-0001aa40: 5f65 6666 6563 745f 6361 6c6c 6564 2873  _effect_called(s
-0001aa50: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001aa60: 6b65 5f6f 7065 6e20 3d20 6661 6b65 5f66  ke_open = fake_f
-0001aa70: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
-0001aa80: 6c65 4f70 656e 2873 656c 662e 6669 6c65  leOpen(self.file
-0001aa90: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-0001aaa0: 7365 6c66 2e73 6964 655f 6566 6665 6374  self.side_effect
-0001aab0: 5f63 616c 6c65 6420 3d20 4661 6c73 650a  _called = False.
-0001aac0: 2020 2020 2020 2020 7769 7468 2066 616b          with fak
-0001aad0: 655f 6f70 656e 2822 2f61 2f62 2f66 696c  e_open("/a/b/fil
-0001aae0: 655f 6f6e 6522 2c20 2277 2229 2061 7320  e_one", "w") as 
-0001aaf0: 6861 6e64 6c65 3a0a 2020 2020 2020 2020  handle:.        
-0001ab00: 2020 2020 6861 6e64 6c65 2e77 7269 7465      handle.write
-0001ab10: 2822 666f 6f22 290a 2020 2020 2020 2020  ("foo").        
-0001ab20: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0001ab30: 7365 6c66 2e73 6964 655f 6566 6665 6374  self.side_effect
-0001ab40: 5f63 616c 6c65 6429 0a0a 2020 2020 6465  _called)..    de
-0001ab50: 6620 7465 7374 5f73 6964 655f 6566 6665  f test_side_effe
-0001ab60: 6374 5f66 696c 655f 6f62 6a65 6374 2873  ct_file_object(s
-0001ab70: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001ab80: 6b65 5f6f 7065 6e20 3d20 6661 6b65 5f66  ke_open = fake_f
-0001ab90: 696c 6573 7973 7465 6d2e 4661 6b65 4669  ilesystem.FakeFi
-0001aba0: 6c65 4f70 656e 2873 656c 662e 6669 6c65  leOpen(self.file
-0001abb0: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-0001abc0: 7365 6c66 2e73 6964 655f 6566 6665 6374  self.side_effect
-0001abd0: 5f63 616c 6c65 6420 3d20 4661 6c73 650a  _called = False.
-0001abe0: 2020 2020 2020 2020 7769 7468 2066 616b          with fak
-0001abf0: 655f 6f70 656e 2822 2f61 2f62 2f66 696c  e_open("/a/b/fil
-0001ac00: 655f 6f6e 6522 2c20 2277 2229 2061 7320  e_one", "w") as 
-0001ac10: 6861 6e64 6c65 3a0a 2020 2020 2020 2020  handle:.        
-0001ac20: 2020 2020 6861 6e64 6c65 2e77 7269 7465      handle.write
-0001ac30: 2822 666f 6f22 290a 2020 2020 2020 2020  ("foo").        
-0001ac40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001ac50: 2873 656c 662e 7369 6465 5f65 6666 6563  (self.side_effec
-0001ac60: 745f 6669 6c65 5f6f 626a 6563 745f 636f  t_file_object_co
-0001ac70: 6e74 656e 742c 2022 666f 6f22 290a 0a0a  ntent, "foo")...
-0001ac80: 6966 205f 5f6e 616d 655f 5f20 3d3d 2022  if __name__ == "
-0001ac90: 5f5f 6d61 696e 5f5f 223a 0a20 2020 2075  __main__":.    u
-0001aca0: 6e69 7474 6573 742e 6d61 696e 2829 0a    nittest.main().
+00018c10: 2073 656c 662e 726f 6f74 5f70 6174 682c   self.root_path,
+00018c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018c30: 2020 2020 2022 7079 6661 6b65 6673 222c       "pyfakefs",
+00018c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018c50: 2020 2020 2022 7465 7374 7322 2c0a 2020       "tests",.  
+00018c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c70: 2020 2266 6978 7475 7265 732f 7379 6d6c    "fixtures/syml
+00018c80: 696e 6b5f 6669 6c65 5f61 6273 6f6c 7574  ink_file_absolut
+00018c90: 655f 6f75 7473 6964 6522 2c0a 2020 2020  e_outside",.    
+00018ca0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00018cb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00018cc0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00018cd0: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+00018ce0: 2020 2020 2020 2020 2020 2020 6661 6b65              fake
+00018cf0: 5f6f 7065 6e28 0a20 2020 2020 2020 2020  _open(.         
+00018d00: 2020 2020 2020 206f 732e 7061 7468 2e6a         os.path.j
+00018d10: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
+00018d20: 2020 2020 2020 2020 2073 656c 662e 726f           self.ro
+00018d30: 6f74 5f70 6174 682c 0a20 2020 2020 2020  ot_path,.       
+00018d40: 2020 2020 2020 2020 2020 2020 2022 7079               "py
+00018d50: 6661 6b65 6673 222c 0a20 2020 2020 2020  fakefs",.       
+00018d60: 2020 2020 2020 2020 2020 2020 2022 7465               "te
+00018d70: 7374 7322 2c0a 2020 2020 2020 2020 2020  sts",.          
+00018d80: 2020 2020 2020 2020 2020 2266 6978 7475            "fixtu
+00018d90: 7265 732f 7379 6d6c 696e 6b5f 6669 6c65  res/symlink_file
+00018da0: 5f61 6273 6f6c 7574 655f 6f75 7473 6964  _absolute_outsid
+00018db0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00018dc0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00018dd0: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+00018de0: 2275 7466 3822 2c0a 2020 2020 2020 2020  "utf8",.        
+00018df0: 2020 2020 292e 7265 6164 2829 2c0a 2020      ).read(),.  
+00018e00: 2020 2020 2020 2020 2020 2267 6f6f 6420            "good 
+00018e10: 6d6f 726e 696e 6722 2c0a 2020 2020 2020  morning",.      
+00018e20: 2020 290a 0a20 2020 2064 6566 2074 6573    )..    def tes
+00018e30: 745f 6164 645f 6578 6973 7469 6e67 5f72  t_add_existing_r
+00018e40: 6561 6c5f 6469 7265 6374 6f72 795f 7379  eal_directory_sy
+00018e50: 6d6c 696e 6b5f 7461 7267 6574 5f70 6174  mlink_target_pat
+00018e60: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+00018e70: 2073 656c 662e 736b 6970 5f69 665f 7379   self.skip_if_sy
+00018e80: 6d6c 696e 6b5f 6e6f 745f 7375 7070 6f72  mlink_not_suppor
+00018e90: 7465 6428 666f 7263 655f 7265 616c 5f66  ted(force_real_f
+00018ea0: 733d 5472 7565 290a 2020 2020 2020 2020  s=True).        
+00018eb0: 7265 616c 5f64 6972 6563 746f 7279 203d  real_directory =
+00018ec0: 206f 732e 7061 7468 2e6a 6f69 6e28 7365   os.path.join(se
+00018ed0: 6c66 2e72 6f6f 745f 7061 7468 2c20 2270  lf.root_path, "p
+00018ee0: 7966 616b 6566 7322 2c20 2274 6573 7473  yfakefs", "tests
+00018ef0: 2229 0a20 2020 2020 2020 2073 796d 6c69  ").        symli
+00018f00: 6e6b 7320 3d20 5b0a 2020 2020 2020 2020  nks = [.        
+00018f10: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+00018f20: 2020 2020 2020 222e 2e22 2c0a 2020 2020        "..",.    
+00018f30: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
+00018f40: 6174 682e 6a6f 696e 2872 6561 6c5f 6469  ath.join(real_di
+00018f50: 7265 6374 6f72 792c 2022 6669 7874 7572  rectory, "fixtur
+00018f60: 6573 222c 2022 7379 6d6c 696e 6b5f 6469  es", "symlink_di
+00018f70: 725f 7265 6c61 7469 7665 2229 2c0a 2020  r_relative"),.  
+00018f80: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00018f90: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+00018fa0: 2020 2020 2020 2020 2020 2022 2e2e 2f61             "../a
+00018fb0: 6c6c 5f74 6573 7473 2e70 7922 2c0a 2020  ll_tests.py",.  
+00018fc0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+00018fd0: 2e70 6174 682e 6a6f 696e 2872 6561 6c5f  .path.join(real_
+00018fe0: 6469 7265 6374 6f72 792c 2022 6669 7874  directory, "fixt
+00018ff0: 7572 6573 222c 2022 7379 6d6c 696e 6b5f  ures", "symlink_
+00019000: 6669 6c65 5f72 656c 6174 6976 6522 292c  file_relative"),
+00019010: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00019020: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+00019030: 2020 2077 6974 6820 7365 6c66 2e63 7265     with self.cre
+00019040: 6174 655f 7379 6d6c 696e 6b73 2873 796d  ate_symlinks(sym
+00019050: 6c69 6e6b 7329 3a0a 2020 2020 2020 2020  links):.        
+00019060: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00019070: 7465 6d2e 6164 645f 7265 616c 5f64 6972  tem.add_real_dir
+00019080: 6563 746f 7279 280a 2020 2020 2020 2020  ectory(.        
+00019090: 2020 2020 2020 2020 7265 616c 5f64 6972          real_dir
+000190a0: 6563 746f 7279 2c20 7461 7267 6574 5f70  ectory, target_p
+000190b0: 6174 683d 222f 7061 7468 222c 206c 617a  ath="/path", laz
+000190c0: 795f 7265 6164 3d46 616c 7365 0a20 2020  y_read=False.   
+000190d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000190e0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+000190f0: 7275 6528 7365 6c66 2e66 696c 6573 7973  rue(self.filesys
+00019100: 7465 6d2e 6578 6973 7473 2822 2f70 6174  tem.exists("/pat
+00019110: 682f 6669 7874 7572 6573 2f73 796d 6c69  h/fixtures/symli
+00019120: 6e6b 5f64 6972 5f72 656c 6174 6976 6522  nk_dir_relative"
+00019130: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+00019140: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
+00019150: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00019160: 6573 7973 7465 6d2e 6578 6973 7473 2822  esystem.exists("
+00019170: 2f70 6174 682f 6669 7874 7572 6573 2f73  /path/fixtures/s
+00019180: 796d 6c69 6e6b 5f64 6972 5f72 656c 6174  ymlink_dir_relat
+00019190: 6976 652f 616c 6c5f 7465 7374 732e 7079  ive/all_tests.py
+000191a0: 2229 0a20 2020 2020 2020 2029 0a20 2020  ").        ).   
+000191b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000191c0: 5472 7565 2873 656c 662e 6669 6c65 7379  True(self.filesy
+000191d0: 7374 656d 2e65 7869 7374 7328 222f 7061  stem.exists("/pa
+000191e0: 7468 2f66 6978 7475 7265 732f 7379 6d6c  th/fixtures/syml
+000191f0: 696e 6b5f 6669 6c65 5f72 656c 6174 6976  ink_file_relativ
+00019200: 6522 2929 0a0a 2020 2020 6465 6620 7465  e"))..    def te
+00019210: 7374 5f61 6464 5f65 7869 7374 696e 675f  st_add_existing_
+00019220: 7265 616c 5f64 6972 6563 746f 7279 5f73  real_directory_s
+00019230: 796d 6c69 6e6b 5f6c 617a 795f 7265 6164  ymlink_lazy_read
+00019240: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00019250: 7365 6c66 2e73 6b69 705f 6966 5f73 796d  self.skip_if_sym
+00019260: 6c69 6e6b 5f6e 6f74 5f73 7570 706f 7274  link_not_support
+00019270: 6564 2866 6f72 6365 5f72 6561 6c5f 6673  ed(force_real_fs
+00019280: 3d54 7275 6529 0a20 2020 2020 2020 2072  =True).        r
+00019290: 6561 6c5f 6469 7265 6374 6f72 7920 3d20  eal_directory = 
+000192a0: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
+000192b0: 662e 726f 6f74 5f70 6174 682c 2022 7079  f.root_path, "py
+000192c0: 6661 6b65 6673 222c 2022 7465 7374 7322  fakefs", "tests"
+000192d0: 290a 2020 2020 2020 2020 7379 6d6c 696e  ).        symlin
+000192e0: 6b73 203d 205b 0a20 2020 2020 2020 2020  ks = [.         
+000192f0: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
+00019300: 2020 2020 2022 2e2e 222c 0a20 2020 2020       "..",.     
+00019310: 2020 2020 2020 2020 2020 206f 732e 7061             os.pa
+00019320: 7468 2e6a 6f69 6e28 7265 616c 5f64 6972  th.join(real_dir
+00019330: 6563 746f 7279 2c20 2266 6978 7475 7265  ectory, "fixture
+00019340: 7322 2c20 2273 796d 6c69 6e6b 5f64 6972  s", "symlink_dir
+00019350: 5f72 656c 6174 6976 6522 292c 0a20 2020  _relative"),.   
+00019360: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00019370: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
+00019380: 2020 2020 2020 2020 2020 222e 2e2f 616c            "../al
+00019390: 6c5f 7465 7374 732e 7079 222c 0a20 2020  l_tests.py",.   
+000193a0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+000193b0: 7061 7468 2e6a 6f69 6e28 7265 616c 5f64  path.join(real_d
+000193c0: 6972 6563 746f 7279 2c20 2266 6978 7475  irectory, "fixtu
+000193d0: 7265 7322 2c20 2273 796d 6c69 6e6b 5f66  res", "symlink_f
+000193e0: 696c 655f 7265 6c61 7469 7665 2229 2c0a  ile_relative"),.
+000193f0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00019400: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+00019410: 2020 7769 7468 2073 656c 662e 6372 6561    with self.crea
+00019420: 7465 5f73 796d 6c69 6e6b 7328 7379 6d6c  te_symlinks(syml
+00019430: 696e 6b73 293a 0a20 2020 2020 2020 2020  inks):.         
+00019440: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+00019450: 656d 2e61 6464 5f72 6561 6c5f 6469 7265  em.add_real_dire
+00019460: 6374 6f72 7928 0a20 2020 2020 2020 2020  ctory(.         
+00019470: 2020 2020 2020 2072 6561 6c5f 6469 7265         real_dire
+00019480: 6374 6f72 792c 2074 6172 6765 745f 7061  ctory, target_pa
+00019490: 7468 3d22 2f70 6174 6822 2c20 6c61 7a79  th="/path", lazy
+000194a0: 5f72 6561 643d 5472 7565 0a20 2020 2020  _read=True.     
+000194b0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000194c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000194d0: 7454 7275 6528 0a20 2020 2020 2020 2020  tTrue(.         
+000194e0: 2020 2020 2020 2073 656c 662e 6669 6c65         self.file
+000194f0: 7379 7374 656d 2e65 7869 7374 7328 222f  system.exists("/
+00019500: 7061 7468 2f66 6978 7475 7265 732f 7379  path/fixtures/sy
+00019510: 6d6c 696e 6b5f 6469 725f 7265 6c61 7469  mlink_dir_relati
+00019520: 7665 2229 0a20 2020 2020 2020 2020 2020  ve").           
+00019530: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+00019540: 656c 662e 6173 7365 7274 5472 7565 280a  elf.assertTrue(.
+00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019560: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00019570: 6578 6973 7473 280a 2020 2020 2020 2020  exists(.        
+00019580: 2020 2020 2020 2020 2020 2020 222f 7061              "/pa
+00019590: 7468 2f66 6978 7475 7265 732f 7379 6d6c  th/fixtures/syml
+000195a0: 696e 6b5f 6469 725f 7265 6c61 7469 7665  ink_dir_relative
+000195b0: 2f61 6c6c 5f74 6573 7473 2e70 7922 0a20  /all_tests.py". 
+000195c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000195d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000195e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000195f0: 6173 7365 7274 5472 7565 280a 2020 2020  assertTrue(.    
+00019600: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019610: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
+00019620: 7473 2822 2f70 6174 682f 6669 7874 7572  ts("/path/fixtur
+00019630: 6573 2f73 796d 6c69 6e6b 5f66 696c 655f  es/symlink_file_
+00019640: 7265 6c61 7469 7665 2229 0a20 2020 2020  relative").     
+00019650: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00019660: 6620 7465 7374 5f61 6464 5f65 7869 7374  f test_add_exist
+00019670: 696e 675f 7265 616c 5f64 6972 6563 746f  ing_real_directo
+00019680: 7279 5f74 7265 655f 746f 5f6f 7468 6572  ry_tree_to_other
+00019690: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
+000196a0: 2020 2020 2073 656c 662e 6669 6c65 7379       self.filesy
+000196b0: 7374 656d 2e61 6464 5f72 6561 6c5f 6469  stem.add_real_di
+000196c0: 7265 6374 6f72 7928 7365 6c66 2e72 6f6f  rectory(self.roo
+000196d0: 745f 7061 7468 2c20 7461 7267 6574 5f70  t_path, target_p
+000196e0: 6174 683d 222f 666f 6f2f 6261 7222 290a  ath="/foo/bar").
+000196f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019700: 6572 7446 616c 7365 280a 2020 2020 2020  ertFalse(.      
+00019710: 2020 2020 2020 7365 6c66 2e66 696c 6573        self.files
+00019720: 7973 7465 6d2e 6578 6973 7473 280a 2020  ystem.exists(.  
+00019730: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+00019740: 2e70 6174 682e 6a6f 696e 2873 656c 662e  .path.join(self.
+00019750: 7079 6661 6b65 6673 5f70 6174 682c 2022  pyfakefs_path, "
+00019760: 7465 7374 7322 2c20 2266 616b 655f 6669  tests", "fake_fi
+00019770: 6c65 7379 7374 656d 5f74 6573 742e 7079  lesystem_test.py
+00019780: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
+00019790: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000197a0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+000197b0: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
+000197c0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+000197d0: 6578 6973 7473 280a 2020 2020 2020 2020  exists(.        
+000197e0: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
+000197f0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00019800: 2020 2020 2020 2020 2020 2266 6f6f 222c            "foo",
+00019810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019820: 2020 2020 2022 6261 7222 2c0a 2020 2020       "bar",.    
+00019830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019840: 2270 7966 616b 6566 7322 2c0a 2020 2020  "pyfakefs",.    
+00019850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019860: 2274 6573 7473 222c 0a20 2020 2020 2020  "tests",.       
+00019870: 2020 2020 2020 2020 2020 2020 2022 6661               "fa
+00019880: 6b65 5f66 696c 6573 7973 7465 6d5f 7465  ke_filesystem_te
+00019890: 7374 2e70 7922 2c0a 2020 2020 2020 2020  st.py",.        
+000198a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000198b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000198c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000198d0: 7373 6572 7446 616c 7365 280a 2020 2020  ssertFalse(.    
+000198e0: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+000198f0: 6573 7973 7465 6d2e 6578 6973 7473 280a  esystem.exists(.
+00019900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019910: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
+00019920: 662e 726f 6f74 5f70 6174 682c 2022 7079  f.root_path, "py
+00019930: 6661 6b65 6673 222c 2022 6661 6b65 5f66  fakefs", "fake_f
+00019940: 696c 6573 7973 7465 6d2e 7079 2229 0a20  ilesystem.py"). 
+00019950: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00019960: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00019970: 656c 662e 6173 7365 7274 5472 7565 280a  elf.assertTrue(.
+00019980: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019990: 2e66 696c 6573 7973 7465 6d2e 6578 6973  .filesystem.exis
+000199a0: 7473 280a 2020 2020 2020 2020 2020 2020  ts(.            
+000199b0: 2020 2020 6f73 2e70 6174 682e 6a6f 696e      os.path.join
+000199c0: 2822 666f 6f22 2c20 2262 6172 222c 2022  ("foo", "bar", "
+000199d0: 7079 6661 6b65 6673 222c 2022 5f5f 696e  pyfakefs", "__in
+000199e0: 6974 5f5f 2e70 7922 290a 2020 2020 2020  it__.py").      
+000199f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00019a00: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00019a10: 6765 745f 6f62 6a65 6374 5f66 726f 6d5f  get_object_from_
+00019a20: 6c61 7a69 6c79 5f61 6464 6564 5f72 6561  lazily_added_rea
+00019a30: 6c5f 6469 7265 6374 6f72 7928 7365 6c66  l_directory(self
+00019a40: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00019a50: 6669 6c65 7379 7374 656d 2e69 735f 6361  filesystem.is_ca
+00019a60: 7365 5f73 656e 7369 7469 7665 203d 2054  se_sensitive = T
+00019a70: 7275 650a 2020 2020 2020 2020 7365 6c66  rue.        self
+00019a80: 2e66 696c 6573 7973 7465 6d2e 6164 645f  .filesystem.add_
+00019a90: 7265 616c 5f64 6972 6563 746f 7279 2873  real_directory(s
+00019aa0: 656c 662e 726f 6f74 5f70 6174 6829 0a20  elf.root_path). 
+00019ab0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00019ac0: 7274 5472 7565 280a 2020 2020 2020 2020  rtTrue(.        
+00019ad0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+00019ae0: 7465 6d2e 6765 745f 6f62 6a65 6374 280a  tem.get_object(.
+00019af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b00: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
+00019b10: 662e 726f 6f74 5f70 6174 682c 2022 7079  f.root_path, "py
+00019b20: 6661 6b65 6673 222c 2022 6661 6b65 5f66  fakefs", "fake_f
+00019b30: 696c 6573 7973 7465 6d2e 7079 2229 0a20  ilesystem.py"). 
+00019b40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00019b50: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00019b60: 656c 662e 6173 7365 7274 5472 7565 280a  elf.assertTrue(.
+00019b70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019b80: 2e66 696c 6573 7973 7465 6d2e 6765 745f  .filesystem.get_
+00019b90: 6f62 6a65 6374 280a 2020 2020 2020 2020  object(.        
+00019ba0: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
+00019bb0: 6a6f 696e 2873 656c 662e 726f 6f74 5f70  join(self.root_p
+00019bc0: 6174 682c 2022 7079 6661 6b65 6673 222c  ath, "pyfakefs",
+00019bd0: 2022 5f5f 696e 6974 5f5f 2e70 7922 290a   "__init__.py").
+00019be0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00019bf0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00019c00: 2074 6573 745f 6164 645f 6578 6973 7469   test_add_existi
+00019c10: 6e67 5f72 6561 6c5f 6469 7265 6374 6f72  ng_real_director
+00019c20: 795f 6c61 7a69 6c79 2873 656c 6629 3a0a  y_lazily(self):.
+00019c30: 2020 2020 2020 2020 6469 736b 5f73 697a          disk_siz
+00019c40: 6520 3d20 3130 3234 202a 2031 3032 3420  e = 1024 * 1024 
+00019c50: 2a20 3130 3234 0a20 2020 2020 2020 2072  * 1024.        r
+00019c60: 6561 6c5f 6469 725f 7061 7468 203d 206f  eal_dir_path = o
+00019c70: 732e 7061 7468 2e6a 6f69 6e28 7365 6c66  s.path.join(self
+00019c80: 2e72 6f6f 745f 7061 7468 2c20 2270 7966  .root_path, "pyf
+00019c90: 616b 6566 7322 290a 2020 2020 2020 2020  akefs").        
+00019ca0: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+00019cb0: 7365 745f 6469 736b 5f75 7361 6765 2864  set_disk_usage(d
+00019cc0: 6973 6b5f 7369 7a65 2c20 7265 616c 5f64  isk_size, real_d
+00019cd0: 6972 5f70 6174 6829 0a20 2020 2020 2020  ir_path).       
+00019ce0: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+00019cf0: 2e61 6464 5f72 6561 6c5f 6469 7265 6374  .add_real_direct
+00019d00: 6f72 7928 7265 616c 5f64 6972 5f70 6174  ory(real_dir_pat
+00019d10: 6829 0a0a 2020 2020 2020 2020 2320 7468  h)..        # th
+00019d20: 6520 6469 7265 6374 6f72 7920 636f 6e74  e directory cont
+00019d30: 656e 7473 2068 6176 6520 6e6f 7420 6265  ents have not be
+00019d40: 656e 2072 6561 642c 2074 6865 2064 6973  en read, the dis
+00019d50: 6b20 7573 6167 650a 2020 2020 2020 2020  k usage.        
+00019d60: 2320 6861 7320 6e6f 7420 6368 616e 6765  # has not change
+00019d70: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+00019d80: 7373 6572 7445 7175 616c 2864 6973 6b5f  ssertEqual(disk_
+00019d90: 7369 7a65 2c20 7365 6c66 2e66 696c 6573  size, self.files
+00019da0: 7973 7465 6d2e 6765 745f 6469 736b 5f75  ystem.get_disk_u
+00019db0: 7361 6765 2872 6561 6c5f 6469 725f 7061  sage(real_dir_pa
+00019dc0: 7468 292e 6672 6565 290a 2020 2020 2020  th).free).      
+00019dd0: 2020 2320 6368 6563 6b69 6e67 2066 6f72    # checking for
+00019de0: 2065 7869 7374 656e 6365 2073 6861 6c6c   existence shall
+00019df0: 2072 6561 6420 7468 6520 6469 7265 6374   read the direct
+00019e00: 6f72 7920 636f 6e74 656e 7473 0a20 2020  ory contents.   
+00019e10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00019e20: 5472 7565 280a 2020 2020 2020 2020 2020  True(.          
+00019e30: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+00019e40: 6d2e 6765 745f 6f62 6a65 6374 280a 2020  m.get_object(.  
+00019e50: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+00019e60: 2e70 6174 682e 6a6f 696e 2872 6561 6c5f  .path.join(real_
+00019e70: 6469 725f 7061 7468 2c20 2266 616b 655f  dir_path, "fake_
+00019e80: 6669 6c65 7379 7374 656d 2e70 7922 290a  filesystem.py").
+00019e90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00019ea0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00019eb0: 2320 736f 206e 6f77 2074 6865 2066 7265  # so now the fre
+00019ec0: 6520 6469 736b 2073 7061 6365 2073 6861  e disk space sha
+00019ed0: 6c6c 2068 6176 6520 6465 6372 6561 7365  ll have decrease
+00019ee0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+00019ef0: 7373 6572 7447 7265 6174 6572 280a 2020  ssertGreater(.  
+00019f00: 2020 2020 2020 2020 2020 6469 736b 5f73            disk_s
+00019f10: 697a 652c 2073 656c 662e 6669 6c65 7379  ize, self.filesy
+00019f20: 7374 656d 2e67 6574 5f64 6973 6b5f 7573  stem.get_disk_us
+00019f30: 6167 6528 7265 616c 5f64 6972 5f70 6174  age(real_dir_pat
+00019f40: 6829 2e66 7265 650a 2020 2020 2020 2020  h).free.        
+00019f50: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00019f60: 6164 645f 6578 6973 7469 6e67 5f72 6561  add_existing_rea
+00019f70: 6c5f 6469 7265 6374 6f72 795f 6e6f 745f  l_directory_not_
+00019f80: 6c61 7a69 6c79 2873 656c 6629 3a0a 2020  lazily(self):.  
+00019f90: 2020 2020 2020 6469 736b 5f73 697a 6520        disk_size 
+00019fa0: 3d20 3130 3234 202a 2031 3032 3420 2a20  = 1024 * 1024 * 
+00019fb0: 3130 3234 0a20 2020 2020 2020 2073 656c  1024.        sel
+00019fc0: 662e 6669 6c65 7379 7374 656d 2e73 6574  f.filesystem.set
+00019fd0: 5f64 6973 6b5f 7573 6167 6528 6469 736b  _disk_usage(disk
+00019fe0: 5f73 697a 652c 2073 656c 662e 7079 6661  _size, self.pyfa
+00019ff0: 6b65 6673 5f70 6174 6829 0a20 2020 2020  kefs_path).     
+0001a000: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0001a010: 656d 2e61 6464 5f72 6561 6c5f 6469 7265  em.add_real_dire
+0001a020: 6374 6f72 7928 7365 6c66 2e70 7966 616b  ctory(self.pyfak
+0001a030: 6566 735f 7061 7468 2c20 6c61 7a79 5f72  efs_path, lazy_r
+0001a040: 6561 643d 4661 6c73 6529 0a0a 2020 2020  ead=False)..    
+0001a050: 2020 2020 2320 7468 6520 6469 7265 6374      # the direct
+0001a060: 6f72 7920 6861 7320 6265 656e 2072 6561  ory has been rea
+0001a070: 642c 2073 6f20 7468 6520 6669 6c65 2073  d, so the file s
+0001a080: 697a 6573 2068 6176 650a 2020 2020 2020  izes have.      
+0001a090: 2020 2320 6265 656e 2073 7562 7472 6163    # been subtrac
+0001a0a0: 7465 6420 6672 6f6d 2074 6865 2066 7265  ted from the fre
+0001a0b0: 6520 7370 6163 650a 2020 2020 2020 2020  e space.        
+0001a0c0: 7365 6c66 2e61 7373 6572 7447 7265 6174  self.assertGreat
+0001a0d0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0001a0e0: 6469 736b 5f73 697a 652c 2073 656c 662e  disk_size, self.
+0001a0f0: 6669 6c65 7379 7374 656d 2e67 6574 5f64  filesystem.get_d
+0001a100: 6973 6b5f 7573 6167 6528 7365 6c66 2e70  isk_usage(self.p
+0001a110: 7966 616b 6566 735f 7061 7468 292e 6672  yfakefs_path).fr
+0001a120: 6565 0a20 2020 2020 2020 2029 0a0a 2020  ee.        )..  
+0001a130: 2020 6465 6620 7465 7374 5f61 6464 5f65    def test_add_e
+0001a140: 7869 7374 696e 675f 7265 616c 5f64 6972  xisting_real_dir
+0001a150: 6563 746f 7279 5f72 6561 645f 7772 6974  ectory_read_writ
+0001a160: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0001a170: 2073 656c 662e 6669 6c65 7379 7374 656d   self.filesystem
+0001a180: 2e61 6464 5f72 6561 6c5f 6469 7265 6374  .add_real_direct
+0001a190: 6f72 7928 7365 6c66 2e70 7966 616b 6566  ory(self.pyfakef
+0001a1a0: 735f 7061 7468 2c20 7265 6164 5f6f 6e6c  s_path, read_onl
+0001a1b0: 793d 4661 6c73 6529 0a20 2020 2020 2020  y=False).       
+0001a1c0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0001a1d0: 2873 656c 662e 6669 6c65 7379 7374 656d  (self.filesystem
+0001a1e0: 2e65 7869 7374 7328 7365 6c66 2e70 7966  .exists(self.pyf
+0001a1f0: 616b 6566 735f 7061 7468 2929 0a20 2020  akefs_path)).   
+0001a200: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001a210: 5472 7565 280a 2020 2020 2020 2020 2020  True(.          
+0001a220: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0001a230: 6d2e 6578 6973 7473 280a 2020 2020 2020  m.exists(.      
+0001a240: 2020 2020 2020 2020 2020 6f73 2e70 6174            os.pat
+0001a250: 682e 6a6f 696e 2873 656c 662e 7079 6661  h.join(self.pyfa
+0001a260: 6b65 6673 5f70 6174 682c 2022 6661 6b65  kefs_path, "fake
+0001a270: 5f66 696c 6573 7973 7465 6d2e 7079 2229  _filesystem.py")
+0001a280: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001a290: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001a2a0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0001a2b0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0001a2c0: 6c66 2e66 696c 6573 7973 7465 6d2e 6578  lf.filesystem.ex
+0001a2d0: 6973 7473 286f 732e 7061 7468 2e6a 6f69  ists(os.path.joi
+0001a2e0: 6e28 7365 6c66 2e70 7966 616b 6566 735f  n(self.pyfakefs_
+0001a2f0: 7061 7468 2c20 2266 616b 655f 7061 7468  path, "fake_path
+0001a300: 6c69 622e 7079 2229 290a 2020 2020 2020  lib.py")).      
+0001a310: 2020 290a 0a20 2020 2020 2020 2066 696c    )..        fil
+0001a320: 655f 7061 7468 203d 206f 732e 7061 7468  e_path = os.path
+0001a330: 2e6a 6f69 6e28 7365 6c66 2e70 7966 616b  .join(self.pyfak
+0001a340: 6566 735f 7061 7468 2c20 2270 7974 6573  efs_path, "pytes
+0001a350: 745f 706c 7567 696e 2e70 7922 290a 2020  t_plugin.py").  
+0001a360: 2020 2020 2020 6661 6b65 5f66 696c 6520        fake_file 
+0001a370: 3d20 7365 6c66 2e66 696c 6573 7973 7465  = self.filesyste
+0001a380: 6d2e 7265 736f 6c76 6528 6669 6c65 5f70  m.resolve(file_p
+0001a390: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
+0001a3a0: 662e 6368 6563 6b5f 6661 6b65 5f66 696c  f.check_fake_fil
+0001a3b0: 655f 7374 6174 2866 616b 655f 6669 6c65  e_stat(fake_file
+0001a3c0: 2c20 6669 6c65 5f70 6174 6829 0a20 2020  , file_path).   
+0001a3d0: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
+0001a3e0: 7772 6974 6162 6c65 5f66 696c 6528 6661  writable_file(fa
+0001a3f0: 6b65 5f66 696c 652c 2066 696c 655f 7061  ke_file, file_pa
+0001a400: 7468 290a 0a20 2020 2064 6566 2074 6573  th)..    def tes
+0001a410: 745f 6164 645f 6578 6973 7469 6e67 5f72  t_add_existing_r
+0001a420: 6561 6c5f 7061 7468 735f 7265 6164 5f6f  eal_paths_read_o
+0001a430: 6e6c 7928 7365 6c66 293a 0a20 2020 2020  nly(self):.     
+0001a440: 2020 2072 6561 6c5f 6669 6c65 5f70 6174     real_file_pat
+0001a450: 6820 3d20 6f73 2e70 6174 682e 7265 616c  h = os.path.real
+0001a460: 7061 7468 285f 5f66 696c 655f 5f29 0a20  path(__file__). 
+0001a470: 2020 2020 2020 2066 6978 7475 7265 5f70         fixture_p
+0001a480: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
+0001a490: 696e 2873 656c 662e 7079 6661 6b65 6673  in(self.pyfakefs
+0001a4a0: 5f70 6174 682c 2022 7465 7374 7322 2c20  _path, "tests", 
+0001a4b0: 2266 6978 7475 7265 7322 290a 2020 2020  "fixtures").    
+0001a4c0: 2020 2020 7365 6c66 2e66 696c 6573 7973      self.filesys
+0001a4d0: 7465 6d2e 6164 645f 7265 616c 5f70 6174  tem.add_real_pat
+0001a4e0: 6873 285b 7265 616c 5f66 696c 655f 7061  hs([real_file_pa
+0001a4f0: 7468 2c20 6669 7874 7572 655f 7061 7468  th, fixture_path
+0001a500: 5d29 0a0a 2020 2020 2020 2020 6661 6b65  ])..        fake
+0001a510: 5f66 696c 6520 3d20 7365 6c66 2e66 696c  _file = self.fil
+0001a520: 6573 7973 7465 6d2e 7265 736f 6c76 6528  esystem.resolve(
+0001a530: 7265 616c 5f66 696c 655f 7061 7468 290a  real_file_path).
+0001a540: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
+0001a550: 636b 5f66 616b 655f 6669 6c65 5f73 7461  ck_fake_file_sta
+0001a560: 7428 6661 6b65 5f66 696c 652c 2072 6561  t(fake_file, rea
+0001a570: 6c5f 6669 6c65 5f70 6174 6829 0a20 2020  l_file_path).   
+0001a580: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
+0001a590: 7265 6164 5f6f 6e6c 795f 6669 6c65 2866  read_only_file(f
+0001a5a0: 616b 655f 6669 6c65 2c20 7265 616c 5f66  ake_file, real_f
+0001a5b0: 696c 655f 7061 7468 290a 0a20 2020 2020  ile_path)..     
+0001a5c0: 2020 2072 6561 6c5f 6669 6c65 5f70 6174     real_file_pat
+0001a5d0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0001a5e0: 2866 6978 7475 7265 5f70 6174 682c 2022  (fixture_path, "
+0001a5f0: 6d6f 6475 6c65 5f77 6974 685f 6174 7472  module_with_attr
+0001a600: 6962 7574 6573 2e70 7922 290a 2020 2020  ibutes.py").    
+0001a610: 2020 2020 6661 6b65 5f66 696c 6520 3d20      fake_file = 
+0001a620: 7365 6c66 2e66 696c 6573 7973 7465 6d2e  self.filesystem.
+0001a630: 7265 736f 6c76 6528 7265 616c 5f66 696c  resolve(real_fil
+0001a640: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
+0001a650: 7365 6c66 2e63 6865 636b 5f66 616b 655f  self.check_fake_
+0001a660: 6669 6c65 5f73 7461 7428 6661 6b65 5f66  file_stat(fake_f
+0001a670: 696c 652c 2072 6561 6c5f 6669 6c65 5f70  ile, real_file_p
+0001a680: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
+0001a690: 662e 6368 6563 6b5f 7265 6164 5f6f 6e6c  f.check_read_onl
+0001a6a0: 795f 6669 6c65 2866 616b 655f 6669 6c65  y_file(fake_file
+0001a6b0: 2c20 7265 616c 5f66 696c 655f 7061 7468  , real_file_path
+0001a6c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001a6d0: 6164 645f 6578 6973 7469 6e67 5f72 6561  add_existing_rea
+0001a6e0: 6c5f 7061 7468 735f 7265 6164 5f77 7269  l_paths_read_wri
+0001a6f0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+0001a700: 2020 7265 616c 5f66 696c 655f 7061 7468    real_file_path
+0001a710: 203d 206f 732e 7061 7468 2e72 6561 6c70   = os.path.realp
+0001a720: 6174 6828 5f5f 6669 6c65 5f5f 290a 2020  ath(__file__).  
+0001a730: 2020 2020 2020 6669 7874 7572 655f 7061        fixture_pa
+0001a740: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
+0001a750: 6e28 7365 6c66 2e70 7966 616b 6566 735f  n(self.pyfakefs_
+0001a760: 7061 7468 2c20 2274 6573 7473 222c 2022  path, "tests", "
+0001a770: 6669 7874 7572 6573 2229 0a20 2020 2020  fixtures").     
+0001a780: 2020 2073 656c 662e 6669 6c65 7379 7374     self.filesyst
+0001a790: 656d 2e61 6464 5f72 6561 6c5f 7061 7468  em.add_real_path
+0001a7a0: 7328 5b72 6561 6c5f 6669 6c65 5f70 6174  s([real_file_pat
+0001a7b0: 682c 2066 6978 7475 7265 5f70 6174 685d  h, fixture_path]
+0001a7c0: 2c20 7265 6164 5f6f 6e6c 793d 4661 6c73  , read_only=Fals
+0001a7d0: 6529 0a0a 2020 2020 2020 2020 6661 6b65  e)..        fake
+0001a7e0: 5f66 696c 6520 3d20 7365 6c66 2e66 696c  _file = self.fil
+0001a7f0: 6573 7973 7465 6d2e 7265 736f 6c76 6528  esystem.resolve(
+0001a800: 7265 616c 5f66 696c 655f 7061 7468 290a  real_file_path).
+0001a810: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
+0001a820: 636b 5f66 616b 655f 6669 6c65 5f73 7461  ck_fake_file_sta
+0001a830: 7428 6661 6b65 5f66 696c 652c 2072 6561  t(fake_file, rea
+0001a840: 6c5f 6669 6c65 5f70 6174 6829 0a20 2020  l_file_path).   
+0001a850: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
+0001a860: 7772 6974 6162 6c65 5f66 696c 6528 6661  writable_file(fa
+0001a870: 6b65 5f66 696c 652c 2072 6561 6c5f 6669  ke_file, real_fi
+0001a880: 6c65 5f70 6174 6829 0a0a 2020 2020 2020  le_path)..      
+0001a890: 2020 7265 616c 5f66 696c 655f 7061 7468    real_file_path
+0001a8a0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0001a8b0: 6669 7874 7572 655f 7061 7468 2c20 226d  fixture_path, "m
+0001a8c0: 6f64 756c 655f 7769 7468 5f61 7474 7269  odule_with_attri
+0001a8d0: 6275 7465 732e 7079 2229 0a20 2020 2020  butes.py").     
+0001a8e0: 2020 2066 616b 655f 6669 6c65 203d 2073     fake_file = s
+0001a8f0: 656c 662e 6669 6c65 7379 7374 656d 2e72  elf.filesystem.r
+0001a900: 6573 6f6c 7665 2872 6561 6c5f 6669 6c65  esolve(real_file
+0001a910: 5f70 6174 6829 0a20 2020 2020 2020 2073  _path).        s
+0001a920: 656c 662e 6368 6563 6b5f 6661 6b65 5f66  elf.check_fake_f
+0001a930: 696c 655f 7374 6174 2866 616b 655f 6669  ile_stat(fake_fi
+0001a940: 6c65 2c20 7265 616c 5f66 696c 655f 7061  le, real_file_pa
+0001a950: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
+0001a960: 2e63 6865 636b 5f77 7269 7461 626c 655f  .check_writable_
+0001a970: 6669 6c65 2866 616b 655f 6669 6c65 2c20  file(fake_file, 
+0001a980: 7265 616c 5f66 696c 655f 7061 7468 290a  real_file_path).
+0001a990: 0a0a 636c 6173 7320 4669 6c65 5369 6465  ..class FileSide
+0001a9a0: 4566 6665 6374 5465 7374 7328 5465 7374  EffectTests(Test
+0001a9b0: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
+0001a9c0: 6964 655f 6566 6665 6374 2873 656c 6629  ide_effect(self)
+0001a9d0: 3a0a 2020 2020 2020 2020 7465 7374 5f63  :.        test_c
+0001a9e0: 6173 6520 3d20 7365 6c66 0a20 2020 2020  ase = self.     
+0001a9f0: 2020 2074 6573 745f 6361 7365 2e73 6964     test_case.sid
+0001aa00: 655f 6566 6665 6374 5f63 616c 6c65 6420  e_effect_called 
+0001aa10: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+0001aa20: 2064 6566 205f 5f73 6964 655f 6566 6665   def __side_effe
+0001aa30: 6374 2866 696c 655f 6f62 6a65 6374 293a  ct(file_object):
+0001aa40: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+0001aa50: 745f 6361 7365 2e73 6964 655f 6566 6665  t_case.side_effe
+0001aa60: 6374 5f63 616c 6c65 6420 3d20 5472 7565  ct_called = True
+0001aa70: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+0001aa80: 745f 6361 7365 2e73 6964 655f 6566 6665  t_case.side_effe
+0001aa90: 6374 5f66 696c 655f 6f62 6a65 6374 5f63  ct_file_object_c
+0001aaa0: 6f6e 7465 6e74 203d 2066 696c 655f 6f62  ontent = file_ob
+0001aab0: 6a65 6374 2e63 6f6e 7465 6e74 730a 0a20  ject.contents.. 
+0001aac0: 2020 2020 2020 2072 6574 7572 6e20 5f5f         return __
+0001aad0: 7369 6465 5f65 6666 6563 740a 0a20 2020  side_effect..   
+0001aae0: 2064 6566 2073 6574 5570 2873 656c 6629   def setUp(self)
+0001aaf0: 3a0a 2020 2020 2020 2020 2320 7573 6520  :.        # use 
+0001ab00: 7468 6520 7265 616c 2070 6174 6820 7365  the real path se
+0001ab10: 7061 7261 746f 7220 746f 2077 6f72 6b20  parator to work 
+0001ab20: 7769 7468 2074 6865 2072 6561 6c20 6669  with the real fi
+0001ab30: 6c65 2073 7973 7465 6d0a 2020 2020 2020  le system.      
+0001ab40: 2020 7365 6c66 2e66 696c 6573 7973 7465    self.filesyste
+0001ab50: 6d20 3d20 6661 6b65 5f66 696c 6573 7973  m = fake_filesys
+0001ab60: 7465 6d2e 4661 6b65 4669 6c65 7379 7374  tem.FakeFilesyst
+0001ab70: 656d 2829 0a20 2020 2020 2020 2073 656c  em().        sel
+0001ab80: 662e 6669 6c65 7379 7374 656d 2e63 7265  f.filesystem.cre
+0001ab90: 6174 655f 6669 6c65 2822 2f61 2f62 2f66  ate_file("/a/b/f
+0001aba0: 696c 655f 6f6e 6522 2c20 7369 6465 5f65  ile_one", side_e
+0001abb0: 6666 6563 743d 7365 6c66 2e73 6964 655f  ffect=self.side_
+0001abc0: 6566 6665 6374 2829 290a 0a20 2020 2064  effect())..    d
+0001abd0: 6566 2074 6573 745f 7369 6465 5f65 6666  ef test_side_eff
+0001abe0: 6563 745f 6361 6c6c 6564 2873 656c 6629  ect_called(self)
+0001abf0: 3a0a 2020 2020 2020 2020 6661 6b65 5f6f  :.        fake_o
+0001ac00: 7065 6e20 3d20 6661 6b65 5f66 696c 6573  pen = fake_files
+0001ac10: 7973 7465 6d2e 4661 6b65 4669 6c65 4f70  ystem.FakeFileOp
+0001ac20: 656e 2873 656c 662e 6669 6c65 7379 7374  en(self.filesyst
+0001ac30: 656d 290a 2020 2020 2020 2020 7365 6c66  em).        self
+0001ac40: 2e73 6964 655f 6566 6665 6374 5f63 616c  .side_effect_cal
+0001ac50: 6c65 6420 3d20 4661 6c73 650a 2020 2020  led = False.    
+0001ac60: 2020 2020 7769 7468 2066 616b 655f 6f70      with fake_op
+0001ac70: 656e 2822 2f61 2f62 2f66 696c 655f 6f6e  en("/a/b/file_on
+0001ac80: 6522 2c20 2277 222c 2065 6e63 6f64 696e  e", "w", encodin
+0001ac90: 673d 2275 7466 3822 2920 6173 2068 616e  g="utf8") as han
+0001aca0: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
+0001acb0: 2068 616e 646c 652e 7772 6974 6528 2266   handle.write("f
+0001acc0: 6f6f 2229 0a20 2020 2020 2020 2073 656c  oo").        sel
+0001acd0: 662e 6173 7365 7274 5472 7565 2873 656c  f.assertTrue(sel
+0001ace0: 662e 7369 6465 5f65 6666 6563 745f 6361  f.side_effect_ca
+0001acf0: 6c6c 6564 290a 0a20 2020 2064 6566 2074  lled)..    def t
+0001ad00: 6573 745f 7369 6465 5f65 6666 6563 745f  est_side_effect_
+0001ad10: 6669 6c65 5f6f 626a 6563 7428 7365 6c66  file_object(self
+0001ad20: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
+0001ad30: 6f70 656e 203d 2066 616b 655f 6669 6c65  open = fake_file
+0001ad40: 7379 7374 656d 2e46 616b 6546 696c 654f  system.FakeFileO
+0001ad50: 7065 6e28 7365 6c66 2e66 696c 6573 7973  pen(self.filesys
+0001ad60: 7465 6d29 0a20 2020 2020 2020 2073 656c  tem).        sel
+0001ad70: 662e 7369 6465 5f65 6666 6563 745f 6361  f.side_effect_ca
+0001ad80: 6c6c 6564 203d 2046 616c 7365 0a20 2020  lled = False.   
+0001ad90: 2020 2020 2077 6974 6820 6661 6b65 5f6f       with fake_o
+0001ada0: 7065 6e28 222f 612f 622f 6669 6c65 5f6f  pen("/a/b/file_o
+0001adb0: 6e65 222c 2022 7722 2c20 656e 636f 6469  ne", "w", encodi
+0001adc0: 6e67 3d22 7574 6638 2229 2061 7320 6861  ng="utf8") as ha
+0001add0: 6e64 6c65 3a0a 2020 2020 2020 2020 2020  ndle:.          
+0001ade0: 2020 6861 6e64 6c65 2e77 7269 7465 2822    handle.write("
+0001adf0: 666f 6f22 290a 2020 2020 2020 2020 7365  foo").        se
+0001ae00: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001ae10: 656c 662e 7369 6465 5f65 6666 6563 745f  elf.side_effect_
+0001ae20: 6669 6c65 5f6f 626a 6563 745f 636f 6e74  file_object_cont
+0001ae30: 656e 742c 2022 666f 6f22 290a 0a0a 6966  ent, "foo")...if
+0001ae40: 205f 5f6e 616d 655f 5f20 3d3d 2022 5f5f   __name__ == "__
+0001ae50: 6d61 696e 5f5f 223a 0a20 2020 2075 6e69  main__":.    uni
+0001ae60: 7474 6573 742e 6d61 696e 2829 0a         ttest.main().
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_unittest_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_unittest_test.py`

 * *Files 8% similar despite different names*

```diff
@@ -13,14 +13,15 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """
 Test the :py:class`pyfakefs.fake_filesystem_unittest.TestCase` base class.
 """
+
 import glob
 import importlib.util
 import io
 import multiprocessing
 import os
 import pathlib
 import runpy
@@ -51,42 +52,42 @@
     from distutils.dir_util import copy_tree, remove_tree
 
 
 class TestPatcher(TestCase):
     def test_context_manager(self):
         with Patcher() as patcher:
             patcher.fs.create_file("/foo/bar", contents="test")
-            with open("/foo/bar") as f:
+            with open("/foo/bar", encoding="utf8") as f:
                 contents = f.read()
             self.assertEqual("test", contents)
 
     @patchfs
     def test_context_decorator(self, fake_fs):
         fake_fs.create_file("/foo/bar", contents="test")
-        with open("/foo/bar") as f:
+        with open("/foo/bar", encoding="utf8") as f:
             contents = f.read()
         self.assertEqual("test", contents)
 
 
 class TestPatchfsArgumentOrder(TestCase):
     @patchfs
     @mock.patch("os.system")
     def test_argument_order1(self, fake_fs, patched_system):
         fake_fs.create_file("/foo/bar", contents="test")
-        with open("/foo/bar") as f:
+        with open("/foo/bar", encoding="utf8") as f:
             contents = f.read()
         self.assertEqual("test", contents)
         os.system("foo")
         patched_system.assert_called_with("foo")
 
     @mock.patch("os.system")
     @patchfs
     def test_argument_order2(self, patched_system, fake_fs):
         fake_fs.create_file("/foo/bar", contents="test")
-        with open("/foo/bar") as f:
+        with open("/foo/bar", encoding="utf8") as f:
             contents = f.read()
         self.assertEqual("test", contents)
         os.system("foo")
         patched_system.assert_called_with("foo")
 
 
 class TestPyfakefsUnittestBase(fake_filesystem_unittest.TestCase):
@@ -97,31 +98,31 @@
 
 class TestPyfakefsUnittest(TestPyfakefsUnittestBase):  # pylint: disable=R0904
     """Test the `pyfakefs.fake_filesystem_unittest.TestCase` base class."""
 
     def test_open(self):
         """Fake `open()` function is bound"""
         self.assertFalse(os.path.exists("/fake_file.txt"))
-        with open("/fake_file.txt", "w") as f:
+        with open("/fake_file.txt", "w", encoding="utf8") as f:
             f.write("This test file was created using the open() function.\n")
         self.assertTrue(self.fs.exists("/fake_file.txt"))
-        with open("/fake_file.txt") as f:
+        with open("/fake_file.txt", encoding="utf8") as f:
             content = f.read()
         self.assertEqual(
             "This test file was created using the " "open() function.\n",
             content,
         )
 
     def test_io_open(self):
         """Fake io module is bound"""
         self.assertFalse(os.path.exists("/fake_file.txt"))
-        with io.open("/fake_file.txt", "w") as f:
+        with io.open("/fake_file.txt", "w", encoding="utf8") as f:
             f.write("This test file was created using the" " io.open() function.\n")
         self.assertTrue(self.fs.exists("/fake_file.txt"))
-        with open("/fake_file.txt") as f:
+        with open("/fake_file.txt", encoding="utf8") as f:
             content = f.read()
         self.assertEqual(
             "This test file was created using the " "io.open() function.\n",
             content,
         )
 
     def test_os(self):
@@ -155,15 +156,15 @@
         self.assertTrue(self.fs.exists("/test/dir1/dir2a"))
 
         shutil.rmtree("/test/dir1")
         self.assertFalse(self.fs.exists("/test/dir1"))
 
     def test_fakepathlib(self):
         p = pathlib.Path("/fake_file.txt")
-        with p.open("w") as f:
+        with p.open("w", encoding="utf8") as f:
             f.write("text")
         is_windows = sys.platform.startswith("win")
         if is_windows:
             self.assertTrue(self.fs.exists(r"\fake_file.txt"))
         else:
             self.assertTrue(self.fs.exists("/fake_file.txt"))
 
@@ -527,15 +528,15 @@
         with self.assertRaises(OSError):
             self.fs.create_file(file_path)
 
         file_path = "/baz"
         self.fs.create_file(file_path)
         os.chmod(file_path, 0o400)
         with self.assertRaises(OSError):
-            open(file_path, "w")
+            open(file_path, "w", encoding="utf8")
 
 
 class PauseResumeTest(fake_filesystem_unittest.TestCase):
     def setUp(self):
         self.real_temp_file = None
         self.setUpPyfakefs()
 
@@ -819,19 +820,19 @@
     @mock.patch.dict(os.environ, {"HOME": "/home/john"})
     def test_real_file_with_home(self):
         """Regression test for #558"""
         self.fs.is_windows_fs = os.name != "nt"
         if self.fs.is_windows_fs:
             self.fs.is_macos = False
         self.fs.add_real_file(__file__)
-        with open(__file__) as f:
+        with open(__file__, encoding="utf8") as f:
             self.assertTrue(f.read())
         home = Path.home()
         os.chdir(home)
-        with open(__file__) as f:
+        with open(__file__, encoding="utf8") as f:
             self.assertTrue(f.read())
 
     def test_windows(self):
         self.fs.os = OSType.WINDOWS
         path = r"C:\foo\bar"
         self.assertEqual(path, os.path.join("C:\\", "foo", "bar"))
         self.assertEqual(("C:", r"\foo\bar"), os.path.splitdrive(path))
@@ -911,19 +912,45 @@
     @classmethod
     def setUpClass(cls):
         cls.setUpClassPyfakefs()
         cls.fake_fs().create_file("foo/bar", contents="test")
 
     def test_using_fs_functions(self):
         self.assertTrue(os.path.exists("foo/bar"))
-        with open("foo/bar") as f:
+        with open("foo/bar", encoding="utf8") as f:
             contents = f.read()
         self.assertEqual("test", contents)
 
     def test_using_fakefs(self):
         self.assertTrue(self.fs.exists("foo/bar"))
         f = self.fs.get_object("foo/bar")
         self.assertEqual("test", f.contents)
 
 
+class TestTempPathCreation(fake_filesystem_unittest.TestCase):
+    """Regression test for #965. Checks that the temp file system
+    is properly created with a root-owned root path.
+    """
+
+    def setUp(self):
+        self.setUpPyfakefs()
+
+    def check_write_tmp_after_reset(self, os_type):
+        self.fs.os = os_type
+        # Mark '/' to be modifiable by only root
+        os.chown("/", 0, 0)
+        os.chmod("/", 0b111_101_101)
+        with tempfile.TemporaryFile("wb") as f:
+            assert f.write(b"foo") == 3
+
+    def test_write_tmp_linux(self):
+        self.check_write_tmp_after_reset(OSType.LINUX)
+
+    def test_write_tmp_macos(self):
+        self.check_write_tmp_after_reset(OSType.MACOS)
+
+    def test_write_tmp_windows(self):
+        self.check_write_tmp_after_reset(OSType.WINDOWS)
+
+
 if __name__ == "__main__":
     unittest.main()
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_filesystem_vs_real_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_filesystem_vs_real_test.py`

 * *Files 2% similar despite different names*

```diff
@@ -61,18 +61,18 @@
         path = sep(path)
         self._created_files.append([file_type, path, contents])
         real_path, fake_path = self._paths(path)
         if file_type == "d":
             os.mkdir(real_path)
             self.fake_os.mkdir(fake_path)
         if file_type == "f":
-            fh = open(real_path, "w")
+            fh = open(real_path, "w", encoding="utf8")
             fh.write(contents or "")
             fh.close()
-            fh = self.fake_open(fake_path, "w")
+            fh = self.fake_open(fake_path, "w", encoding="utf8")
             fh.write(contents or "")
             fh.close()
         # b for binary file
         if file_type == "b":
             fh = open(real_path, "wb")
             fh.write(contents or "")
             fh.close()
@@ -314,16 +314,19 @@
         behavior of the system provided module against the fake_filesystem
         module.
         We expect results and/or Exceptions raised to be identical.
 
         Returns:
             A description of the difference in behavior, or None.
         """
-        with open(path, mode) as real_fh:
-            with self.fake_open(path, mode) as fake_fh:
+        kwargs = {}
+        if "b" not in mode:
+            kwargs["encoding"] = "utf8"
+        with open(path, mode, **kwargs) as real_fh:
+            with self.fake_open(path, mode, **kwargs) as fake_fh:
                 return self._compare_behaviors(
                     method_name, data, real_fh, fake_fh, method_returns_data
                 )
 
     def diff_os_path_method_behavior(
         self, method_name, path, method_returns_path=False
     ):
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_open_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_open_test.py`

 * *Files 6% similar despite different names*

```diff
@@ -13,23 +13,22 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """Unit tests for fake_open.FakeOsModule."""
 
 import errno
 import io
-import locale
 import os
 import stat
 import sys
 import time
 import unittest
 
 from pyfakefs import fake_filesystem, helpers
-from pyfakefs.helpers import is_root, IS_PYPY
+from pyfakefs.helpers import is_root, IS_PYPY, get_locale_encoding
 from pyfakefs.fake_io import FakeIoModule
 from pyfakefs.fake_filesystem_unittest import PatchMode
 from pyfakefs.tests.test_utils import RealFsTestCase
 
 
 class FakeFileOpenTestBase(RealFsTestCase):
     def setUp(self):
@@ -60,49 +59,49 @@
 
     def test_delete_on_close(self):
         self.skip_real_fs()
         file_dir = "boo"
         file_path = "boo!far"
         self.os.mkdir(file_dir)
         self.open = fake_filesystem.FakeFileOpen(self.filesystem, delete_on_close=True)
-        with self.open(file_path, "w"):
+        with self.open(file_path, "w", encoding="utf8"):
             self.assertTrue(self.filesystem.exists(file_path))
         self.assertFalse(self.filesystem.exists(file_path))
 
     def test_no_delete_on_close_by_default(self):
         file_path = self.make_path("czar")
-        with self.open(file_path, "w"):
+        with self.open(file_path, "w", encoding="utf8"):
             self.assertTrue(self.os.path.exists(file_path))
         self.assertTrue(self.os.path.exists(file_path))
 
     def test_compatibility_of_with_statement(self):
         self.skip_real_fs()
         self.open = fake_filesystem.FakeFileOpen(self.filesystem, delete_on_close=True)
         file_path = "foo"
         self.assertFalse(self.os.path.exists(file_path))
-        with self.open(file_path, "w"):
+        with self.open(file_path, "w", encoding="utf8"):
             self.assertTrue(self.os.path.exists(file_path))
         # After the 'with' statement, the close() method should have been
         # called.
         self.assertFalse(self.os.path.exists(file_path))
 
     def test_unicode_contents(self):
         file_path = self.make_path("foo")
         # note that this will work only if the string can be represented
         # by the locale preferred encoding - which under Windows is
         # usually not UTF-8, but something like Latin1, depending on the locale
         text_fractions = "mlts"
         try:
-            with self.open(file_path, "w") as f:
+            with self.open(file_path, "w", encoding=get_locale_encoding()) as f:
                 f.write(text_fractions)
         except UnicodeEncodeError:
             # see https://github.com/pytest-dev/pyfakefs/issues/623
             self.skipTest("This test does not work with an ASCII locale")
 
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding=get_locale_encoding()) as f:
             contents = f.read()
         self.assertEqual(contents, text_fractions)
 
     def test_byte_contents(self):
         file_path = self.make_path("foo")
         byte_fractions = b"\xe2\x85\x93 \xe2\x85\x94 \xe2\x85\x95 \xe2\x85\x96"
         with self.open(file_path, "wb") as f:
@@ -113,49 +112,52 @@
             contents = f.read()
         self.assertEqual(contents, byte_fractions.decode("utf-8"))
 
     def test_write_str_read_bytes(self):
         file_path = self.make_path("foo")
         str_contents = "sgl"
         try:
-            with self.open(file_path, "w") as f:
+            with self.open(file_path, "w", encoding=get_locale_encoding()) as f:
                 f.write(str_contents)
-        except UnicodeEncodeError:
+            with self.open(file_path, "rb") as f:
+                contents = f.read()
+            self.assertEqual(str_contents, contents.decode(get_locale_encoding()))
+        except UnicodeError:
             # see https://github.com/pytest-dev/pyfakefs/issues/623
             self.skipTest("This test does not work with an ASCII locale")
-        with self.open(file_path, "rb") as f:
-            contents = f.read()
-        self.assertEqual(
-            str_contents, contents.decode(locale.getpreferredencoding(False))
-        )
 
     def test_open_valid_file(self):
         contents = [
             "I am he as\n",
             "you are he as\n",
             "you are me and\n",
             "we are all together\n",
         ]
         file_path = self.make_path("bar.txt")
         self.create_file(file_path, contents="".join(contents))
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             self.assertEqual(contents, fake_file.readlines())
 
     def test_open_valid_args(self):
         contents = [
             "Bang bang Maxwell's silver hammer\n",
             "Came down on her head",
         ]
         file_path = self.make_path("abbey_road", "maxwell")
         self.create_file(file_path, contents="".join(contents))
 
-        with self.open(file_path, buffering=1) as f:
+        with self.open(file_path, encoding="utf8", buffering=1) as f:
             self.assertEqual(contents, f.readlines())
         with self.open(
-            file_path, buffering=1, errors="strict", newline="\n", opener=None
+            file_path,
+            encoding="utf8",
+            buffering=1,
+            errors="strict",
+            newline="\n",
+            opener=None,
         ) as f:
             expected_contents = [
                 contents[0][:-1] + self.os.linesep,
                 contents[1],
             ]
             self.assertEqual(expected_contents, f.readlines())
 
@@ -165,34 +167,34 @@
             "you are he as\n",
             "you are me and\n",
             "we are all together\n",
         ]
         file_path = self.make_path("bar.txt")
         self.create_file(file_path, contents="".join(contents))
         self.os.chdir(self.base_path)
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertEqual(contents, f.readlines())
 
     def test_iterate_over_file(self):
         contents = [
             "Bang bang Maxwell's silver hammer",
             "Came down on her head",
         ]
         file_path = self.make_path("abbey_road", "maxwell")
         self.create_file(file_path, contents="\n".join(contents))
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             result = [line.rstrip() for line in fake_file]
         self.assertEqual(contents, result)
 
     def test_next_over_file(self):
         contents = ["Live long\n", "and prosper\n"]
         result = []
         file_path = self.make_path("foo.txt")
         self.create_file(file_path, contents="".join(contents))
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             result.append(next(fake_file))
             result.append(next(fake_file))
         self.assertEqual(contents, result)
 
     def test_open_directory_error(self):
         directory_path = self.make_path("foo")
         self.os.mkdir(directory_path)
@@ -210,34 +212,34 @@
             "Here comes the sun, little darlin'",
             "Here comes the sun, and I say,",
             "It's alright",
         ]
         file_dir = self.make_path("abbey_road")
         file_path = self.os.path.join(file_dir, "here_comes_the_sun")
         self.os.mkdir(file_dir)
-        with self.open(file_path, "w") as fake_file:
+        with self.open(file_path, "w", encoding="utf8") as fake_file:
             for line in contents:
                 fake_file.write(line + "\n")
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             result = [line.rstrip() for line in fake_file]
         self.assertEqual(contents, result)
 
     def test_create_file_with_append(self):
         contents = [
             "Here comes the sun, little darlin'",
             "Here comes the sun, and I say,",
             "It's alright",
         ]
         file_dir = self.make_path("abbey_road")
         file_path = self.os.path.join(file_dir, "here_comes_the_sun")
         self.os.mkdir(file_dir)
-        with self.open(file_path, "a") as fake_file:
+        with self.open(file_path, "a", encoding="utf8") as fake_file:
             for line in contents:
                 fake_file.write(line + "\n")
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             result = [line.rstrip() for line in fake_file]
         self.assertEqual(contents, result)
 
     def test_exclusive_create_file_failure(self):
         self.skip_if_symlink_not_supported()
         file_path = self.make_path("bar")
         self.create_file(file_path)
@@ -245,17 +247,17 @@
         self.assert_raises_os_error(errno.EEXIST, self.open, file_path, "xb")
 
     def test_exclusive_create_file(self):
         file_dir = self.make_path("foo")
         file_path = self.os.path.join(file_dir, "bar")
         self.os.mkdir(file_dir)
         contents = "String contents"
-        with self.open(file_path, "x") as fake_file:
+        with self.open(file_path, "x", encoding="utf8") as fake_file:
             fake_file.write(contents)
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             self.assertEqual(contents, fake_file.read())
 
     def test_exclusive_create_binary_file(self):
         file_dir = self.make_path("foo")
         file_path = self.os.path.join(file_dir, "bar")
         self.os.mkdir(file_dir)
         contents = b"Binary contents"
@@ -267,97 +269,97 @@
     def test_overwrite_existing_file(self):
         file_path = self.make_path("overwrite")
         self.create_file(file_path, contents="To disappear")
         new_contents = [
             "Only these lines",
             "should be in the file.",
         ]
-        with self.open(file_path, "w") as fake_file:
+        with self.open(file_path, "w", encoding="utf8") as fake_file:
             for line in new_contents:
                 fake_file.write(line + "\n")
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             result = [line.rstrip() for line in fake_file]
         self.assertEqual(new_contents, result)
 
     def test_append_existing_file(self):
         file_path = self.make_path("appendfile")
         contents = [
             "Contents of original file" "Appended contents",
         ]
 
         self.create_file(file_path, contents=contents[0])
-        with self.open(file_path, "a") as fake_file:
+        with self.open(file_path, "a", encoding="utf8") as fake_file:
             for line in contents[1:]:
                 fake_file.write(line + "\n")
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             result = [line.rstrip() for line in fake_file]
         self.assertEqual(contents, result)
 
     def test_open_with_wplus(self):
         # set up
         file_path = self.make_path("wplus_file")
         self.create_file(file_path, contents="old contents")
         self.assertTrue(self.os.path.exists(file_path))
-        with self.open(file_path, "r") as fake_file:
+        with self.open(file_path, "r", encoding="utf8") as fake_file:
             self.assertEqual("old contents", fake_file.read())
         # actual tests
-        with self.open(file_path, "w+") as fake_file:
+        with self.open(file_path, "w+", encoding="utf8") as fake_file:
             fake_file.write("new contents")
             fake_file.seek(0)
             self.assertTrue("new contents", fake_file.read())
 
     def test_open_with_wplus_truncation(self):
         # set up
         file_path = self.make_path("wplus_file")
         self.create_file(file_path, contents="old contents")
         self.assertTrue(self.os.path.exists(file_path))
-        with self.open(file_path, "r") as fake_file:
+        with self.open(file_path, "r", encoding="utf8") as fake_file:
             self.assertEqual("old contents", fake_file.read())
         # actual tests
-        with self.open(file_path, "w+") as fake_file:
+        with self.open(file_path, "w+", encoding="utf8") as fake_file:
             fake_file.seek(0)
             self.assertEqual("", fake_file.read())
 
     def test_open_with_append_flag(self):
         contents = [
             "I am he as\n",
             "you are he as\n",
             "you are me and\n",
             "we are all together\n",
         ]
         additional_contents = ["These new lines\n", "like you a lot.\n"]
         file_path = self.make_path("appendfile")
         self.create_file(file_path, contents="".join(contents))
-        with self.open(file_path, "a") as fake_file:
+        with self.open(file_path, "a", encoding="utf8") as fake_file:
             with self.assertRaises(io.UnsupportedOperation):
                 fake_file.read(0)
             with self.assertRaises(io.UnsupportedOperation):
                 fake_file.readline()
             expected_len = len("".join(contents))
             expected_len += len(contents) * (len(self.os.linesep) - 1)
             self.assertEqual(expected_len, fake_file.tell())
             fake_file.seek(0)
             self.assertEqual(0, fake_file.tell())
             fake_file.writelines(additional_contents)
-        with self.open(file_path) as fake_file:
+        with self.open(file_path, encoding="utf8") as fake_file:
             self.assertEqual(contents + additional_contents, fake_file.readlines())
 
     def check_append_with_aplus(self):
         file_path = self.make_path("aplus_file")
         self.create_file(file_path, contents="old contents")
         self.assertTrue(self.os.path.exists(file_path))
-        with self.open(file_path, "r") as fake_file:
+        with self.open(file_path, "r", encoding="utf8") as fake_file:
             self.assertEqual("old contents", fake_file.read())
 
         if self.filesystem:
             # need to recreate FakeFileOpen for OS specific initialization
             self.open = fake_filesystem.FakeFileOpen(
                 self.filesystem, delete_on_close=True
             )
-        with self.open(file_path, "a+") as fake_file:
+        with self.open(file_path, "a+", encoding="utf8") as fake_file:
             self.assertEqual(12, fake_file.tell())
             fake_file.write("new contents")
             self.assertEqual(24, fake_file.tell())
             fake_file.seek(0)
             self.assertEqual("old contentsnew contents", fake_file.read())
 
     def test_append_with_aplus_mac_os(self):
@@ -369,38 +371,38 @@
         self.check_append_with_aplus()
 
     def test_append_with_aplus_read_with_loop(self):
         # set up
         file_path = self.make_path("aplus_file")
         self.create_file(file_path, contents="old contents")
         self.assertTrue(self.os.path.exists(file_path))
-        with self.open(file_path, "r") as fake_file:
+        with self.open(file_path, "r", encoding="utf8") as fake_file:
             self.assertEqual("old contents", fake_file.read())
         # actual tests
-        with self.open(file_path, "a+") as fake_file:
+        with self.open(file_path, "a+", encoding="utf8") as fake_file:
             fake_file.seek(0)
             fake_file.write("new contents")
             fake_file.seek(0)
             for line in fake_file:
                 self.assertEqual("old contentsnew contents", line)
 
     def test_read_empty_file_with_aplus(self):
         file_path = self.make_path("aplus_file")
-        with self.open(file_path, "a+") as fake_file:
+        with self.open(file_path, "a+", encoding="utf8") as fake_file:
             self.assertEqual("", fake_file.read())
 
     def test_read_with_rplus(self):
         # set up
         file_path = self.make_path("rplus_file")
         self.create_file(file_path, contents="old contents here")
         self.assertTrue(self.os.path.exists(file_path))
-        with self.open(file_path, "r") as fake_file:
+        with self.open(file_path, "r", encoding="utf8") as fake_file:
             self.assertEqual("old contents here", fake_file.read())
         # actual tests
-        with self.open(file_path, "r+") as fake_file:
+        with self.open(file_path, "r+", encoding="utf8") as fake_file:
             self.assertEqual("old contents here", fake_file.read())
             fake_file.seek(0)
             fake_file.write("new contents")
             fake_file.seek(0)
             self.assertEqual("new contents here", fake_file.read())
 
     def create_with_permission(self, file_path, perm_bits):
@@ -414,92 +416,92 @@
 
     def test_open_flags700(self):
         # set up
         self.check_posix_only()
         file_path = self.make_path("target_file")
         self.create_with_permission(file_path, 0o700)
         # actual tests
-        self.open(file_path, "r").close()
-        self.open(file_path, "w").close()
-        self.open(file_path, "w+").close()
+        self.open(file_path, "r", encoding="utf8").close()
+        self.open(file_path, "w", encoding="utf8").close()
+        self.open(file_path, "w+", encoding="utf8").close()
         with self.assertRaises(ValueError):
-            self.open(file_path, "INV")
+            self.open(file_path, "INV", encoding="utf8")
 
     def test_open_flags400(self):
         # set up
         self.check_posix_only()
         file_path = self.make_path("target_file")
         self.create_with_permission(file_path, 0o400)
         # actual tests
-        self.open(file_path, "r").close()
+        self.open(file_path, "r", encoding="utf8").close()
         if not is_root():
             self.assert_raises_os_error(errno.EACCES, self.open, file_path, "w")
             self.assert_raises_os_error(errno.EACCES, self.open, file_path, "w+")
         else:
-            self.open(file_path, "w").close()
-            self.open(file_path, "w+").close()
+            self.open(file_path, "w", encoding="utf8").close()
+            self.open(file_path, "w+", encoding="utf8").close()
 
     def test_open_flags200(self):
         # set up
         self.check_posix_only()
         file_path = self.make_path("target_file")
         self.create_with_permission(file_path, 0o200)
         # actual tests
-        self.open(file_path, "w").close()
+        self.open(file_path, "w", encoding="utf8").close()
         if not is_root():
             with self.assertRaises(OSError):
-                self.open(file_path, "r")
+                self.open(file_path, "r", encoding="utf8")
             with self.assertRaises(OSError):
-                self.open(file_path, "w+")
+                self.open(file_path, "w+", encoding="utf8")
         else:
-            self.open(file_path, "r").close()
-            self.open(file_path, "w+").close()
+            self.open(file_path, "r", encoding="utf8").close()
+            self.open(file_path, "w+", encoding="utf8").close()
 
     def test_open_flags100(self):
         # set up
         self.check_posix_only()
         file_path = self.make_path("target_file")
         self.create_with_permission(file_path, 0o100)
         # actual tests
         if not is_root():
             with self.assertRaises(OSError):
-                self.open(file_path, "r")
+                self.open(file_path, "r", encoding="utf8")
             with self.assertRaises(OSError):
-                self.open(file_path, "w")
+                self.open(file_path, "w", encoding="utf8")
             with self.assertRaises(OSError):
-                self.open(file_path, "w+")
+                self.open(file_path, "w+", encoding="utf8")
         else:
-            self.open(file_path, "r").close()
-            self.open(file_path, "w").close()
-            self.open(file_path, "w+").close()
+            self.open(file_path, "r", encoding="utf8").close()
+            self.open(file_path, "w", encoding="utf8").close()
+            self.open(file_path, "w+", encoding="utf8").close()
 
     def test_follow_link_read(self):
         self.skip_if_symlink_not_supported()
         link_path = self.make_path("foo", "bar", "baz")
         target = self.make_path("tarJAY")
         target_contents = "real baz contents"
         self.create_file(target, contents=target_contents)
         self.create_symlink(link_path, target)
         self.assert_equal_paths(target, self.os.readlink(link_path))
-        fh = self.open(link_path, "r")
+        fh = self.open(link_path, "r", encoding="utf8")
         got_contents = fh.read()
         fh.close()
         self.assertEqual(target_contents, got_contents)
 
     def test_follow_link_write(self):
         self.skip_if_symlink_not_supported()
         link_path = self.make_path("foo", "bar", "TBD")
         target = self.make_path("tarJAY")
         target_contents = "real baz contents"
         self.create_symlink(link_path, target)
         self.assertFalse(self.os.path.exists(target))
 
-        with self.open(link_path, "w") as fh:
+        with self.open(link_path, "w", encoding="utf8") as fh:
             fh.write(target_contents)
-        with self.open(target, "r") as fh:
+        with self.open(target, "r", encoding="utf8") as fh:
             got_contents = fh.read()
         self.assertEqual(target_contents, got_contents)
 
     def test_follow_intra_path_link_write(self):
         # Test a link in the middle of of a file path.
         self.skip_if_symlink_not_supported()
         link_path = self.os.path.join(
@@ -512,17 +514,17 @@
             self.make_path("tmp"),
         )
 
         self.assertFalse(self.os.path.exists(link_path))
         self.assertFalse(self.os.path.exists(target))
 
         target_contents = "real baz contents"
-        with self.open(link_path, "w") as fh:
+        with self.open(link_path, "w", encoding="utf8") as fh:
             fh.write(target_contents)
-        with self.open(target, "r") as fh:
+        with self.open(target, "r", encoding="utf8") as fh:
             got_contents = fh.read()
         self.assertEqual(target_contents, got_contents)
 
     def test_open_raises_on_symlink_loop(self):
         # Regression test for #274
         self.check_posix_only()
         file_dir = self.make_path("foo")
@@ -535,65 +537,65 @@
         first_path = self.make_path("some_file1")
         self.create_file(first_path, contents="contents here1")
         second_path = self.make_path("some_file2")
         self.create_file(second_path, contents="contents here2")
         third_path = self.make_path("some_file3")
         self.create_file(third_path, contents="contents here3")
 
-        with self.open(first_path) as fake_file1:
-            with self.open(second_path) as fake_file2:
-                with self.open(third_path) as fake_file3:
+        with self.open(first_path, encoding="utf8") as fake_file1:
+            with self.open(second_path, encoding="utf8") as fake_file2:
+                with self.open(third_path, encoding="utf8") as fake_file3:
                     fileno2 = fake_file2.fileno()
                     self.assertGreater(fileno2, fake_file1.fileno())
                     self.assertGreater(fake_file3.fileno(), fileno2)
 
     def test_file_descriptors_for_the_same_file_are_different(self):
         first_path = self.make_path("some_file1")
         self.create_file(first_path, contents="contents here1")
         second_path = self.make_path("some_file2")
         self.create_file(second_path, contents="contents here2")
-        with self.open(first_path) as fake_file1:
-            with self.open(second_path) as fake_file2:
-                with self.open(first_path) as fake_file1a:
+        with self.open(first_path, encoding="utf8") as fake_file1:
+            with self.open(second_path, encoding="utf8") as fake_file2:
+                with self.open(first_path, encoding="utf8") as fake_file1a:
                     fileno2 = fake_file2.fileno()
                     self.assertGreater(fileno2, fake_file1.fileno())
                     self.assertGreater(fake_file1a.fileno(), fileno2)
 
     def test_reused_file_descriptors_do_not_affect_others(self):
         first_path = self.make_path("some_file1")
         self.create_file(first_path, contents="contents here1")
         second_path = self.make_path("some_file2")
         self.create_file(second_path, contents="contents here2")
         third_path = self.make_path("some_file3")
         self.create_file(third_path, contents="contents here3")
 
-        with self.open(first_path, "r") as fake_file1:
-            with self.open(second_path, "r") as fake_file2:
-                fake_file3 = self.open(third_path, "r")
-                fake_file1a = self.open(first_path, "r")
+        with self.open(first_path, "r", encoding="utf8") as fake_file1:
+            with self.open(second_path, "r", encoding="utf8") as fake_file2:
+                fake_file3 = self.open(third_path, "r", encoding="utf8")
+                fake_file1a = self.open(first_path, "r", encoding="utf8")
                 fileno1 = fake_file1.fileno()
                 fileno2 = fake_file2.fileno()
                 fileno3 = fake_file3.fileno()
                 fileno4 = fake_file1a.fileno()
 
-        with self.open(second_path, "r") as fake_file2:
-            with self.open(first_path, "r") as fake_file1b:
+        with self.open(second_path, "r", encoding="utf8") as fake_file2:
+            with self.open(first_path, "r", encoding="utf8") as fake_file1b:
                 self.assertEqual(fileno1, fake_file2.fileno())
                 self.assertEqual(fileno2, fake_file1b.fileno())
                 self.assertEqual(fileno3, fake_file3.fileno())
                 self.assertEqual(fileno4, fake_file1a.fileno())
         fake_file3.close()
         fake_file1a.close()
 
     def test_intertwined_read_write(self):
         file_path = self.make_path("some_file")
         self.create_file(file_path)
 
-        with self.open(file_path, "a") as writer:
-            with self.open(file_path, "r") as reader:
+        with self.open(file_path, "a", encoding="utf8") as writer:
+            with self.open(file_path, "r", encoding="utf8") as reader:
                 writes = [
                     "hello",
                     "world\n",
                     "somewhere\nover",
                     "the\n",
                     "rainbow",
                 ]
@@ -638,34 +640,34 @@
                     reads.append(reader.read())
                 self.assertEqual(["" for _ in writes], reads)
 
     def test_open_io_errors(self):
         file_path = self.make_path("some_file")
         self.create_file(file_path)
 
-        with self.open(file_path, "a") as fh:
+        with self.open(file_path, "a", encoding="utf8") as fh:
             with self.assertRaises(OSError):
                 fh.read()
             with self.assertRaises(OSError):
                 fh.readlines()
-        with self.open(file_path, "w") as fh:
+        with self.open(file_path, "w", encoding="utf8") as fh:
             with self.assertRaises(OSError):
                 fh.read()
             with self.assertRaises(OSError):
                 fh.readlines()
-        with self.open(file_path, "r") as fh:
+        with self.open(file_path, "r", encoding="utf8") as fh:
             with self.assertRaises(OSError):
                 fh.truncate()
             with self.assertRaises(OSError):
                 fh.write("contents")
             with self.assertRaises(OSError):
                 fh.writelines(["con", "tents"])
 
         def _iterator_open(mode):
-            with self.open(file_path, mode) as f:
+            with self.open(file_path, mode, encoding="utf8") as f:
                 for _ in f:
                     pass
 
         with self.assertRaises(OSError):
             _iterator_open("w")
         with self.assertRaises(OSError):
             _iterator_open("a")
@@ -701,74 +703,74 @@
         self.check_windows_only()
         self.check_open_with_trailing_sep(errno.EINVAL)
 
     def test_can_read_from_block_device(self):
         self.skip_real_fs()
         device_path = "device"
         self.filesystem.create_file(device_path, stat.S_IFBLK | helpers.PERM_ALL)
-        with self.open(device_path, "r") as fh:
+        with self.open(device_path, "r", encoding="utf8") as fh:
             self.assertEqual("", fh.read())
 
     def test_truncate_flushes_contents(self):
         # Regression test for #285
         file_path = self.make_path("baz")
         self.create_file(file_path)
-        with self.open(file_path, "w") as f0:
+        with self.open(file_path, "w", encoding="utf8") as f0:
             f0.write("test")
             f0.truncate()
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_update_other_instances_of_same_file_on_flush(self):
         # Regression test for #302
         file_path = self.make_path("baz")
-        with self.open(file_path, "w") as f0:
-            with self.open(file_path, "w") as f1:
+        with self.open(file_path, "w", encoding="utf8") as f0:
+            with self.open(file_path, "w", encoding="utf8") as f1:
                 f0.write("test")
                 f0.truncate()
                 f1.flush()
                 self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_getsize_after_truncate(self):
         # Regression test for #412
         file_path = self.make_path("foo")
-        with self.open(file_path, "a") as f:
+        with self.open(file_path, "a", encoding="utf8") as f:
             f.write("a")
             f.seek(0)
             f.truncate()
             f.write("b")
             f.truncate()
             self.assertEqual(1, self.os.path.getsize(file_path))
             self.assertEqual(1, self.os.stat(file_path).st_size)
 
     def test_st_size_after_truncate(self):
         # Regression test for #412
         file_path = self.make_path("foo")
-        with self.open(file_path, "a") as f:
+        with self.open(file_path, "a", encoding="utf8") as f:
             f.write("a")
             f.truncate()
             f.write("b")
             f.truncate()
             self.assertEqual(2, self.os.stat(file_path).st_size)
 
     def test_that_read_over_end_does_not_reset_position(self):
         # Regression test for #286
         file_path = self.make_path("baz")
         self.create_file(file_path)
-        with self.open(file_path) as f0:
+        with self.open(file_path, encoding="utf8") as f0:
             f0.seek(2)
             f0.read()
             self.assertEqual(2, f0.tell())
 
     def test_accessing_closed_file_raises(self):
         # Regression test for #275, #280
         if self.is_pypy:
             raise unittest.SkipTest("Different exceptions with PyPy")
         file_path = self.make_path("foo")
         self.create_file(file_path, contents=b"test")
-        fake_file = self.open(file_path, "r")
+        fake_file = self.open(file_path, "r", encoding="utf8")
         fake_file.close()
         with self.assertRaises(ValueError):
             fake_file.read(1)
         with self.assertRaises(ValueError):
             fake_file.write("a")
         with self.assertRaises(ValueError):
             fake_file.readline()
@@ -783,80 +785,80 @@
 
     def test_accessing_open_file_with_another_handle_raises(self):
         # Regression test for #282
         if self.is_pypy:
             raise unittest.SkipTest("Different exceptions with PyPy")
         file_path = self.make_path("foo")
         f0 = self.os.open(file_path, os.O_CREAT | os.O_WRONLY | os.O_TRUNC)
-        fake_file = self.open(file_path, "r")
+        fake_file = self.open(file_path, "r", encoding="utf8")
         fake_file.close()
         with self.assertRaises(ValueError):
             fake_file.read(1)
         with self.assertRaises(ValueError):
             fake_file.write("a")
         self.os.close(f0)
 
     def test_tell_flushes_under_mac_os(self):
         # Regression test for #288
         self.check_macos_only()
         file_path = self.make_path("foo")
-        with self.open(file_path, "w") as f0:
+        with self.open(file_path, "w", encoding="utf8") as f0:
             f0.write("test")
             self.assertEqual(4, f0.tell())
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_tell_flushes_in_python3(self):
         # Regression test for #288
         self.check_linux_and_windows()
         file_path = self.make_path("foo")
-        with self.open(file_path, "w") as f0:
+        with self.open(file_path, "w", encoding="utf8") as f0:
             f0.write("test")
             self.assertEqual(4, f0.tell())
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_read_flushes_under_posix(self):
         # Regression test for #278
         self.check_posix_only()
         file_path = self.make_path("foo")
-        with self.open(file_path, "a+") as f0:
+        with self.open(file_path, "a+", encoding="utf8") as f0:
             f0.write("test")
             self.assertEqual("", f0.read())
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_read_flushes_under_windows_in_python3(self):
         # Regression test for #278
         self.check_windows_only()
         file_path = self.make_path("foo")
-        with self.open(file_path, "w+") as f0:
+        with self.open(file_path, "w+", encoding="utf8") as f0:
             f0.write("test")
             f0.read()
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_seek_flushes(self):
         # Regression test for #290
         file_path = self.make_path("foo")
-        with self.open(file_path, "w") as f0:
+        with self.open(file_path, "w", encoding="utf8") as f0:
             f0.write("test")
             self.assertEqual(0, self.os.path.getsize(file_path))
             f0.seek(3)
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def test_truncate_flushes(self):
         # Regression test for #291
         file_path = self.make_path("foo")
-        with self.open(file_path, "a") as f0:
+        with self.open(file_path, "a", encoding="utf8") as f0:
             f0.write("test")
             self.assertEqual(0, self.os.path.getsize(file_path))
             f0.truncate()
             self.assertEqual(4, self.os.path.getsize(file_path))
 
     def check_seek_outside_and_truncate_sets_size(self, mode):
         # Regression test for #294 and #296
         file_path = self.make_path("baz")
-        with self.open(file_path, mode) as f0:
+        with self.open(file_path, mode, encoding="utf8") as f0:
             f0.seek(1)
             f0.truncate()
             self.assertEqual(1, f0.tell())
             self.assertEqual(1, self.os.path.getsize(file_path))
             f0.seek(1)
             self.assertEqual(1, self.os.path.getsize(file_path))
         self.assertEqual(1, self.os.path.getsize(file_path))
@@ -867,29 +869,29 @@
 
     def test_seek_outside_and_truncate_sets_size_in_append_mode(self):
         # Regression test for #295
         self.check_seek_outside_and_truncate_sets_size("a")
 
     def test_closed(self):
         file_path = self.make_path("foo")
-        f = self.open(file_path, "w")
+        f = self.open(file_path, "w", encoding="utf8")
         self.assertFalse(f.closed)
         f.close()
         self.assertTrue(f.closed)
-        f = self.open(file_path)
+        f = self.open(file_path, encoding="utf8")
         self.assertFalse(f.closed)
         f.close()
         self.assertTrue(f.closed)
 
     def test_closing_closed_file_does_nothing(self):
         # Regression test for #299
         file_path = self.make_path("baz")
-        f0 = self.open(file_path, "w")
+        f0 = self.open(file_path, "w", encoding="utf8")
         f0.close()
-        with self.open(file_path) as f1:
+        with self.open(file_path, encoding="utf8") as f1:
             # would close f1 if not handled
             f0.close()
             self.assertEqual("", f1.read())
 
     def test_closing_file_with_different_close_mode(self):
         self.skip_real_fs()
         filename = self.make_path("test.txt")
@@ -900,16 +902,16 @@
         self.assertTrue(self.filesystem.has_open_file(file_obj))
         self.os.close(fd)
         self.assertFalse(self.filesystem.has_open_file(file_obj))
 
     def test_truncate_flushes_zeros(self):
         # Regression test for #301
         file_path = self.make_path("baz")
-        with self.open(file_path, "w") as f0:
-            with self.open(file_path) as f1:
+        with self.open(file_path, "w", encoding="utf8") as f0:
+            with self.open(file_path, encoding="utf8") as f1:
                 f0.seek(1)
                 f0.truncate()
                 self.assertEqual("\0", f1.read())
 
     def test_byte_filename(self):
         file_path = self.make_path(b"test")
         with self.open(file_path, "wb") as f:
@@ -922,17 +924,17 @@
         with self.open(file_path, "wb") as f:
             f.write(b"test")
         with self.open(file_path, "rb") as f:
             self.assertEqual(b"test", f.read())
 
     def test_write_devnull(self):
         for mode in ("r+", "w", "w+", "a", "a+"):
-            with self.open(self.os.devnull, mode) as f:
+            with self.open(self.os.devnull, mode, encoding="utf8") as f:
                 f.write("test")
-            with self.open(self.os.devnull) as f:
+            with self.open(self.os.devnull, encoding="utf8") as f:
                 self.assertEqual("", f.read())
 
     def test_utf16_text(self):
         # regression test for #574
         file_path = self.make_path("foo")
         with self.open(file_path, "w", encoding="utf-16") as f:
             assert f.write("1") == 1
@@ -953,91 +955,99 @@
 class FakeFileOpenWithOpenerTest(FakeFileOpenTestBase):
     def opener(self, path, flags):
         return self.os.open(path, flags)
 
     def test_use_opener_with_read(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="test")
-        with self.open(file_path, opener=self.opener) as f:
+        with self.open(file_path, encoding="utf8", opener=self.opener) as f:
+            assert f.read() == "test"
+            with self.assertRaises(OSError):
+                f.write("foo")
+
+    def test_no_opener_with_read(self):
+        file_path = self.make_path("foo")
+        self.create_file(file_path, contents="test")
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "test"
             with self.assertRaises(OSError):
                 f.write("foo")
 
     def test_use_opener_with_read_plus(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="test")
-        with self.open(file_path, "r+", opener=self.opener) as f:
+        with self.open(file_path, "r+", encoding="utf8", opener=self.opener) as f:
             assert f.read() == "test"
             assert f.write("bar") == 3
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "testbar"
 
     def test_use_opener_with_write(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="foo")
-        with self.open(file_path, "w", opener=self.opener) as f:
+        with self.open(file_path, "w", encoding="utf8", opener=self.opener) as f:
             with self.assertRaises(OSError):
                 f.read()
             assert f.write("bar") == 3
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "bar"
 
     def test_use_opener_with_write_plus(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="test")
-        with self.open(file_path, "w+", opener=self.opener) as f:
+        with self.open(file_path, "w+", encoding="utf8", opener=self.opener) as f:
             assert f.read() == ""
             assert f.write("bar") == 3
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "bar"
 
     def test_use_opener_with_append(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="foo")
-        with self.open(file_path, "a", opener=self.opener) as f:
+        with self.open(file_path, "a", encoding="utf8", opener=self.opener) as f:
             assert f.write("bar") == 3
             with self.assertRaises(OSError):
                 f.read()
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "foobar"
 
     def test_use_opener_with_append_plus(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="foo")
-        with self.open(file_path, "a+", opener=self.opener) as f:
+        with self.open(file_path, "a+", encoding="utf8", opener=self.opener) as f:
             assert f.read() == ""
             assert f.write("bar") == 3
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "foobar"
 
     def test_use_opener_with_exclusive_write(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="test")
         with self.assertRaises(OSError):
-            self.open(file_path, "x", opener=self.opener)
+            self.open(file_path, "x", encoding="utf8", opener=self.opener)
 
         file_path = self.make_path("bar")
-        with self.open(file_path, "x", opener=self.opener) as f:
+        with self.open(file_path, "x", encoding="utf8", opener=self.opener) as f:
             assert f.write("bar") == 3
             with self.assertRaises(OSError):
                 f.read()
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "bar"
 
     def test_use_opener_with_exclusive_plus(self):
         file_path = self.make_path("foo")
         self.create_file(file_path, contents="test")
         with self.assertRaises(OSError):
-            self.open(file_path, "x+", opener=self.opener)
+            self.open(file_path, "x+", encoding="utf8", opener=self.opener)
 
         file_path = self.make_path("bar")
-        with self.open(file_path, "x+", opener=self.opener) as f:
+        with self.open(file_path, "x+", encoding="utf8", opener=self.opener) as f:
             assert f.write("bar") == 3
             assert f.read() == ""
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             assert f.read() == "bar"
 
 
 class RealFileOpenWithOpenerTest(FakeFileOpenWithOpenerTest):
     def use_real_fs(self):
         return True
 
@@ -1133,15 +1143,15 @@
             with self.open(file_path, "rb") as r:
                 x = r.read()
                 self.assertEqual(b"a" * 128, x)
 
     def test_no_buffering_not_allowed_in_textmode(self):
         file_path = self.make_path("buffertest.txt")
         with self.assertRaises(ValueError):
-            self.open(file_path, "w", buffering=0)
+            self.open(file_path, "w", encoding="utf8", buffering=0)
 
     def test_default_buffering_no_flush(self):
         file_path = self.make_path("buffertest.bin")
         with self.open(file_path, "wb") as f:
             f.write(b"a" * 2048)
             with self.open(file_path, "rb") as r:
                 x = r.read()
@@ -1187,103 +1197,103 @@
             with self.open(file_path, "rb") as r:
                 x = r.read()
                 # new buffer exceeded (600) -> all written
                 self.assertEqual(1700, len(x))
 
     def test_writing_text_with_line_buffer(self):
         file_path = self.make_path("buffertest.bin")
-        with self.open(file_path, "w", buffering=1) as f:
+        with self.open(file_path, "w", encoding="utf8", buffering=1) as f:
             f.write("test" * 100)
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # no new line - not written
                 self.assertEqual(0, len(x))
             f.write("\ntest")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # new line - buffer written
                 self.assertEqual(405, len(x))
             f.write("test" * 10)
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer not filled - not written
                 self.assertEqual(405, len(x))
             f.write("\ntest")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # new line - buffer written
                 self.assertEqual(450, len(x))
 
     def test_writing_large_text_with_line_buffer(self):
         file_path = self.make_path("buffertest.bin")
-        with self.open(file_path, "w", buffering=1) as f:
+        with self.open(file_path, "w", encoding="utf8", buffering=1) as f:
             f.write("test" * 4000)
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer larger than default - written
                 self.assertEqual(16000, len(x))
             f.write("test")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer not filled - not written
                 self.assertEqual(16000, len(x))
             f.write("\ntest")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # new line - buffer written
                 self.assertEqual(16009, len(x))
             f.write("\ntest")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # another new line - buffer written
                 self.assertEqual(16014, len(x))
 
     def test_writing_text_with_default_buffer(self):
         file_path = self.make_path("buffertest.txt")
-        with self.open(file_path, "w") as f:
+        with self.open(file_path, "w", encoding="utf8") as f:
             f.write("test" * 5)
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer not filled - not written
                 self.assertEqual(0, len(x))
             f.write("\ntest")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer exceeded, but new buffer (400) not - previous written
                 self.assertEqual(0, len(x))
             f.write("test" * 10)
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer not filled - not written
                 self.assertEqual(0, len(x))
             f.write("\ntest")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 self.assertEqual(0, len(x))
 
     def test_writing_text_with_specific_buffer(self):
         file_path = self.make_path("buffertest.txt")
-        with self.open(file_path, "w", buffering=2) as f:
+        with self.open(file_path, "w", encoding="utf8", buffering=2) as f:
             f.write("a" * 8000)
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer not filled - not written
                 self.assertEqual(0, len(x))
             f.write("test")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer exceeded, but new buffer (400) not - previous written
                 self.assertEqual(0, len(x))
             f.write("test")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 # buffer not filled - not written
                 self.assertEqual(0, len(x))
             f.write("test")
-            with self.open(file_path, "r") as r:
+            with self.open(file_path, "r", encoding="utf8") as r:
                 x = r.read()
                 self.assertEqual(0, len(x))
         # with self.open(file_path, "r") as r:
         #     x = r.read()
         #     self.assertEqual(35, len(x))
 
     def test_append_with_specific_buffer(self):
@@ -1527,97 +1537,97 @@
     def setUp(self):
         super(FakeFileOpenLineEndingTest, self).setUp()
 
     def test_read_default_newline_mode(self):
         file_path = self.make_path("some_file")
         for contents in (b"1\n2", b"1\r\n2", b"1\r2"):
             self.create_file(file_path, contents=contents)
-            with self.open(file_path, mode="r") as f:
+            with self.open(file_path, mode="r", encoding="utf8") as f:
                 self.assertEqual(["1\n", "2"], f.readlines())
-            with self.open(file_path, mode="r") as f:
+            with self.open(file_path, mode="r", encoding="utf8") as f:
                 self.assertEqual("1\n2", f.read())
             with self.open(file_path, mode="rb") as f:
                 self.assertEqual(contents, f.read())
 
     def test_write_universal_newline_mode(self):
         file_path = self.make_path("some_file")
-        with self.open(file_path, "w") as f:
+        with self.open(file_path, "w", encoding="utf8") as f:
             f.write("1\n2")
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"1" + self.os.linesep.encode() + b"2", f.read())
 
-        with self.open(file_path, "w") as f:
+        with self.open(file_path, "w", encoding="utf8") as f:
             f.write("1\r\n2")
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"1\r" + self.os.linesep.encode() + b"2", f.read())
 
     def test_read_with_newline_arg(self):
         file_path = self.make_path("some_file")
         file_contents = b"1\r\n2\n3\r4"
         self.create_file(file_path, contents=file_contents)
-        with self.open(file_path, mode="r", newline="") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
-        with self.open(file_path, mode="r", newline="\r") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\r") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
-        with self.open(file_path, mode="r", newline="\n") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\n") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
-        with self.open(file_path, mode="r", newline="\r\n") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\r\n") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
 
     def test_readlines_with_newline_arg(self):
         file_path = self.make_path("some_file")
         file_contents = b"1\r\n2\n3\r4"
         self.create_file(file_path, contents=file_contents)
-        with self.open(file_path, mode="r", newline="") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="") as f:
             self.assertEqual(["1\r\n", "2\n", "3\r", "4"], f.readlines())
-        with self.open(file_path, mode="r", newline="\r") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\r") as f:
             self.assertEqual(["1\r", "\n2\n3\r", "4"], f.readlines())
-        with self.open(file_path, mode="r", newline="\n") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\n") as f:
             self.assertEqual(["1\r\n", "2\n", "3\r4"], f.readlines())
-        with self.open(file_path, mode="r", newline="\r\n") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\r\n") as f:
             self.assertEqual(["1\r\n", "2\n3\r4"], f.readlines())
 
     @unittest.skipIf(sys.version_info >= (3, 10), "U flag no longer supported")
     def test_read_with_ignored_universal_newlines_flag(self):
         file_path = self.make_path("some_file")
         file_contents = b"1\r\n2\n3\r4"
         self.create_file(file_path, contents=file_contents)
-        with self.open(file_path, mode="r", newline="\r") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\r") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
-        with self.open(file_path, mode="r", newline="\r") as f:
+        with self.open(file_path, mode="r", encoding="utf8", newline="\r") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
-        with self.open(file_path, mode="U", newline="\r") as f:
+        with self.open(file_path, mode="U", encoding="utf8", newline="\r") as f:
             self.assertEqual("1\r\n2\n3\r4", f.read())
 
     @unittest.skipIf(sys.version_info < (3, 11), "U flag still supported")
     def test_universal_newlines_flag_not_supported(self):
         file_path = self.make_path("some_file")
         file_contents = b"1\r\n2\n3\r4"
         self.create_file(file_path, contents=file_contents)
         with self.assertRaises(ValueError):
-            self.open(file_path, mode="U", newline="\r")
+            self.open(file_path, mode="U", encoding="utf8", newline="\r")
 
     def test_write_with_newline_arg(self):
         file_path = self.make_path("some_file")
-        with self.open(file_path, "w", newline="") as f:
+        with self.open(file_path, "w", encoding="utf8", newline="") as f:
             f.write("1\r\n2\n3\r4")
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"1\r\n2\n3\r4", f.read())
 
-        with self.open(file_path, "w", newline="\n") as f:
+        with self.open(file_path, "w", encoding="utf8", newline="\n") as f:
             f.write("1\r\n2\n3\r4")
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"1\r\n2\n3\r4", f.read())
 
-        with self.open(file_path, "w", newline="\r\n") as f:
+        with self.open(file_path, "w", encoding="utf8", newline="\r\n") as f:
             f.write("1\r\n2\n3\r4")
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"1\r\r\n2\r\n3\r4", f.read())
 
-        with self.open(file_path, "w", newline="\r") as f:
+        with self.open(file_path, "w", encoding="utf8", newline="\r") as f:
             f.write("1\r\n2\n3\r4")
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"1\r\r2\r3\r4", f.read())
 
     def test_binary_readline(self):
         file_path = self.make_path("some_file")
         file_contents = b"\x80\n\x80\r\x80\r\n\x80"
@@ -1733,24 +1743,24 @@
 
 
 class OpenWithFileDescriptorTest(FakeFileOpenTestBase):
     def test_open_with_file_descriptor(self):
         file_path = self.make_path("this", "file")
         self.create_file(file_path)
         fd = self.os.open(file_path, os.O_CREAT)
-        self.assertEqual(fd, self.open(fd, "r").fileno())
+        self.assertEqual(fd, self.open(fd, "r", encoding="utf8").fileno())
 
     def test_closefd_with_file_descriptor(self):
         file_path = self.make_path("this", "file")
         self.create_file(file_path)
         fd = self.os.open(file_path, os.O_CREAT)
-        fh = self.open(fd, "r", closefd=False)
+        fh = self.open(fd, "r", encoding="utf8", closefd=False)
         fh.close()
         self.assertIsNotNone(self.filesystem.open_files[fd])
-        fh = self.open(fd, "r", closefd=True)
+        fh = self.open(fd, "r", encoding="utf8", closefd=True)
         fh.close()
         self.assertIsNone(self.filesystem.open_files[fd])
 
 
 class OpenWithRealFileDescriptorTest(FakeFileOpenTestBase):
     def use_real_fs(self):
         return True
@@ -1759,15 +1769,18 @@
 class OpenWithFlagsTestBase(FakeFileOpenTestBase):
     def setUp(self):
         super(OpenWithFlagsTestBase, self).setUp()
         self.file_path = self.make_path("some_file")
         self.file_contents = None
 
     def open_file(self, mode):
-        return self.open(self.file_path, mode=mode)
+        kwargs = {"mode": mode}
+        if "b" not in mode:
+            kwargs["encoding"] = "utf8"
+        return self.open(self.file_path, **kwargs)
 
     def open_file_and_seek(self, mode):
         fake_file = self.open(self.file_path, mode=mode)
         fake_file.seek(0, 2)
         return fake_file
 
     def write_and_reopen_file(self, fake_file, mode="r", encoding=None):
@@ -1869,24 +1882,24 @@
 class OpenWithInvalidFlagsRealFsTest(OpenWithInvalidFlagsTest):
     def use_real_fs(self):
         return True
 
 
 class ResolvePathTest(FakeFileOpenTestBase):
     def write_to_file(self, file_name):
-        with self.open(file_name, "w") as fh:
+        with self.open(file_name, "w", encoding="utf8") as fh:
             fh.write("x")
 
     def test_none_filepath_raises_type_error(self):
         with self.assertRaises(TypeError):
-            self.open(None, "w")
+            self.open(None, "w", encoding="utf8")
 
     def test_empty_filepath_raises_io_error(self):
         with self.assertRaises(OSError):
-            self.open("", "w")
+            self.open("", "w", encoding="utf8")
 
     def test_normal_path(self):
         file_path = self.make_path("foo")
         self.write_to_file(file_path)
         self.assertTrue(self.os.path.exists(file_path))
 
     def test_link_within_same_directory(self):
@@ -2007,15 +2020,15 @@
         # Write into the final link target and read back from a file which will
         # point to that.
         self.skip_if_symlink_not_supported()
         link_path = self.make_path("foo", "bar")
         self.create_symlink(link_path, "link")
         self.create_symlink(self.make_path("foo", "link"), "baz")
         self.write_to_file(self.make_path("foo", "baz"))
-        fh = self.open(link_path, "r")
+        fh = self.open(link_path, "r", encoding="utf8")
         self.assertEqual("x", fh.read())
 
     def test_write_link_to_link(self):
         self.skip_if_symlink_not_supported()
         final_target = self.make_path("foo", "baz")
         link_path = self.make_path("foo", "bar")
         self.create_symlink(link_path, "link")
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_os_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_os_test.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,15 +17,15 @@
 
 import errno
 import os
 import stat
 import sys
 import unittest
 
-from pyfakefs.helpers import IN_DOCKER, IS_PYPY, get_uid, get_gid
+from pyfakefs.helpers import IN_DOCKER, IS_PYPY, get_uid, get_gid, reset_ids
 
 from pyfakefs import fake_filesystem, fake_os, fake_open, fake_file
 from pyfakefs.fake_filesystem import (
     FakeFileOpen,
     is_root,
     set_uid,
     set_gid,
@@ -36,34 +36,44 @@
     use_builtin_scandir,
 )
 
 from pyfakefs.tests.test_utils import TestCase, RealFsTestCase
 
 
 class FakeOsModuleTestBase(RealFsTestCase):
+    def setUp(self):
+        super().setUp()
+        self.umask = self.os.umask(0o022)
+
+    def tearDown(self):
+        self.os.umask(self.umask)
+
     def createTestFile(self, path):
         self.create_file(path)
         self.assertTrue(self.os.path.exists(path))
         st = self.os.stat(path)
-        self.assertEqual(0o666, stat.S_IMODE(st.st_mode))
+        # under Windows, the umask has no effect
+        mode = 0o666 if self.is_windows_fs else 0o0644
+        self.assertEqual(mode, stat.S_IMODE(st.st_mode))
         self.assertTrue(st.st_mode & stat.S_IFREG)
         self.assertFalse(st.st_mode & stat.S_IFDIR)
 
     def createTestDirectory(self, path):
         self.create_dir(path)
         self.assertTrue(self.os.path.exists(path))
         st = self.os.stat(path)
-        self.assertEqual(0o777, stat.S_IMODE(st.st_mode))
+        mode = 0o777 if self.is_windows_fs else 0o755
+        self.assertEqual(mode, stat.S_IMODE(st.st_mode))
         self.assertFalse(st.st_mode & stat.S_IFREG)
         self.assertTrue(st.st_mode & stat.S_IFDIR)
 
 
 class FakeOsModuleTest(FakeOsModuleTestBase):
     def setUp(self):
-        super(FakeOsModuleTest, self).setUp()
+        super().setUp()
         self.rwx = self.os.R_OK | self.os.W_OK | self.os.X_OK
         self.rw = self.os.R_OK | self.os.W_OK
 
     def test_chdir(self):
         """chdir should work on a directory."""
         directory = self.make_path("foo")
         self.create_dir(directory)
@@ -174,76 +184,107 @@
             self.create_file(self.make_path(f))
         files.sort()
         self.assertEqual(files, sorted(self.os.listdir(self.base_path)))
 
     def test_fdopen(self):
         file_path1 = self.make_path("some_file1")
         self.create_file(file_path1, contents="contents here1")
-        with self.open(file_path1, "r") as fake_file1:
+        with self.open(file_path1, "r", encoding="utf8") as fake_file1:
             fileno = fake_file1.fileno()
-            fake_file2 = self.os.fdopen(fileno)
+            fake_file2 = self.os.fdopen(fileno, encoding="utf8")
             self.assertNotEqual(fake_file2, fake_file1)
 
         with self.assertRaises(TypeError):
             self.os.fdopen(None)
         with self.assertRaises(TypeError):
             self.os.fdopen("a string")
 
     def test_out_of_range_fdopen(self):
         # test some file descriptor that is clearly out of range
-        self.assert_raises_os_error(errno.EBADF, self.os.fdopen, 500)
+        kwargs = {"encoding": "utf8"}
+        self.assert_raises_os_error(errno.EBADF, self.os.fdopen, 500, **kwargs)
 
     def test_closed_file_descriptor(self):
         first_path = self.make_path("some_file1")
         second_path = self.make_path("some_file2")
         third_path = self.make_path("some_file3")
         self.create_file(first_path, contents="contents here1")
         self.create_file(second_path, contents="contents here2")
         self.create_file(third_path, contents="contents here3")
 
-        fake_file1 = self.open(first_path, "r")
-        fake_file2 = self.open(second_path, "r")
-        fake_file3 = self.open(third_path, "r")
+        fake_file1 = self.open(first_path, "r", encoding="utf8")
+        fake_file2 = self.open(second_path, "r", encoding="utf8")
+        fake_file3 = self.open(third_path, "r", encoding="utf8")
         fileno1 = fake_file1.fileno()
         fileno2 = fake_file2.fileno()
         fileno3 = fake_file3.fileno()
 
         self.os.close(fileno2)
         self.assert_raises_os_error(errno.EBADF, self.os.close, fileno2)
         self.assertEqual(fileno1, fake_file1.fileno())
         self.assertEqual(fileno3, fake_file3.fileno())
 
-        with self.os.fdopen(fileno1) as f:
+        with self.os.fdopen(fileno1, encoding="utf8") as f:
             self.assertFalse(f is fake_file1)
-        with self.os.fdopen(fileno3) as f:
+        with self.os.fdopen(fileno3, encoding="utf8") as f:
             self.assertFalse(f is fake_file3)
-        self.assert_raises_os_error(errno.EBADF, self.os.fdopen, fileno2)
-
-    def test_fdopen_mode(self):
-        self.skip_real_fs()
-        file_path1 = self.make_path("some_file1")
-        self.create_file(file_path1, contents="contents here1")
-        self.os.chmod(file_path1, (stat.S_IFREG | 0o666) ^ stat.S_IWRITE)
+        kwargs = {"encoding": "utf8"}
+        self.assert_raises_os_error(errno.EBADF, self.os.fdopen, fileno2, **kwargs)
 
-        fake_file1 = self.open(file_path1, "r")
-        fileno1 = fake_file1.fileno()
-        self.os.fdopen(fileno1)
-        self.os.fdopen(fileno1, "r")
-        if not is_root():
-            with self.assertRaises(OSError):
-                self.os.fdopen(fileno1, "w")
+    def test_fdopen_twice(self):
+        file_path = self.make_path("some_file1")
+        self.create_file(file_path, contents="contents here1")
+        fake_file = self.open(file_path, "r", encoding="utf8")
+        fd = fake_file.fileno()
+        self.open(fd, encoding="utf8")
+        if not IS_PYPY:
+            with self.assertRaises(OSError) as cm:
+                self.open(fd, encoding="utf8")
+            self.assertEqual(errno.EBADF, cm.exception.errno)
         else:
-            self.os.fdopen(fileno1, "w")
-            self.os.close(fileno1)
+            self.open(fd, encoding="utf8")
+            self.os.close(fd)
+
+    def test_open_fd_write_mode_for_ro_file(self):
+        # Create a writable file handle to a read-only file, see #967
+        file_path = self.make_path("file.txt")
+        fd = self.os.open(file_path, os.O_CREAT | os.O_WRONLY, 0o555)
+        with self.open(fd, "w", encoding="utf8") as out:
+            out.write("hey")
+        with self.open(file_path, encoding="utf8") as f:
+            assert f.read() == "hey"
+        self.os.chmod(file_path, 0o655)
+
+    def test_open_fd_read_mode_for_ro_file(self):
+        # Create a read-only handle to a read-only file, see #967
+        file_path = self.make_path("file.txt")
+        fd = self.os.open(file_path, os.O_CREAT | os.O_RDONLY, 0x555)
+        # Attempt to open a write stream to the underlying file
+        out = self.open(fd, "wb")
+        out.flush()  # Does not fail: The buffer is empty, so no write()
+
+        # Fails: Tries to flush a non-empty buffer
+        out.write(b"a")  # file.write() may fail by an implicit flush!
+        with self.assertRaises(OSError) as cm:
+            out.flush()
+        assert cm.exception.errno == errno.EBADF
+
+        # Fails: Tries to flush() again
+        with self.assertRaises(OSError) as cm:
+            out.close()
+        assert cm.exception.errno == errno.EBADF
+
+        out.close()  # Okay: The file is already closed
+        self.os.chmod(file_path, 0o655)
 
     def test_fstat(self):
         directory = self.make_path("xyzzy")
         file_path = self.os.path.join(directory, "plugh")
         self.create_file(file_path, contents="ABCDE")
-        with self.open(file_path) as file_obj:
+        with self.open(file_path, encoding="utf8") as file_obj:
             fileno = file_obj.fileno()
             self.assertTrue(stat.S_IFREG & self.os.fstat(fileno)[stat.ST_MODE])
             self.assertTrue(stat.S_IFREG & self.os.fstat(fileno).st_mode)
             self.assertEqual(5, self.os.fstat(fileno)[stat.ST_SIZE])
 
     def test_stat(self):
         directory = self.make_path("xyzzy")
@@ -303,15 +344,15 @@
 
     def test_stat_uses_open_fd_as_path(self):
         self.skip_real_fs()
         self.assert_raises_os_error(errno.EBADF, self.os.stat, 5)
         file_path = self.make_path("foo", "bar")
         self.create_file(file_path)
 
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertTrue(stat.S_IFREG & self.os.stat(f.filedes)[stat.ST_MODE])
 
     def test_stat_no_follow_symlinks_posix(self):
         """Test that stat with follow_symlinks=False behaves like lstat."""
         self.check_posix_only()
         directory = self.make_path("xyzzy")
         base_name = "plugh"
@@ -524,15 +565,15 @@
         self.assert_raises_os_error(errno.EBADF, self.os.lstat, 5)
         file_path = self.make_path("foo", "bar")
         link_path = self.make_path("foo", "link")
         file_contents = b"contents"
         self.create_file(file_path, contents=file_contents)
         self.create_symlink(link_path, file_path)
 
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertEqual(len(file_contents), self.os.lstat(f.filedes)[stat.ST_SIZE])
 
     def test_stat_non_existent_file(self):
         # set up
         file_path = self.make_path("non", "existent", "file")
         self.assertFalse(self.os.path.exists(file_path))
         # actual tests
@@ -561,14 +602,52 @@
         self.check_macos_only()
         self.check_open_raises_with_trailing_separator(errno.ENOENT)
 
     def test_open_raises_with_trailing_separator_windows(self):
         self.check_windows_only()
         self.check_open_raises_with_trailing_separator(errno.EINVAL)
 
+    @unittest.skipIf(not hasattr(os, "O_DIRECTORY"), "opening directory not supported")
+    def test_open_with_o_directory(self):
+        self.check_posix_only()
+        with self.assertRaises(FileNotFoundError):
+            self.os.open("bogus", os.O_RDONLY | os.O_DIRECTORY)
+        file_path = self.make_path("file.txt")
+        self.create_file(file_path, contents="foo")
+        with self.assertRaises(NotADirectoryError):
+            self.os.open(file_path, os.O_RDONLY | os.O_DIRECTORY)
+        dir_path = self.make_path("dir")
+        self.create_dir(dir_path)
+        with self.assertRaises(IsADirectoryError):
+            self.os.open(dir_path, os.O_RDWR | os.O_DIRECTORY)
+
+    @unittest.skipIf(not hasattr(os, "O_NOFOLLOW"), "NOFOLLOW attribute not supported")
+    def test_open_nofollow_symlink_raises(self):
+        self.skip_if_symlink_not_supported()
+        file_path = self.make_path("file.txt")
+        self.create_file(file_path, contents="foo")
+        link_path = self.make_path("link")
+        self.create_symlink(link_path, file_path)
+        with self.assertRaises(OSError) as cm:
+            self.os.open(link_path, os.O_RDONLY | os.O_NOFOLLOW)
+        assert cm.exception.errno == errno.ELOOP
+
+    @unittest.skipIf(not hasattr(os, "O_NOFOLLOW"), "NOFOLLOW attribute not supported")
+    def test_open_nofollow_symlink_as_parent_works(self):
+        self.skip_if_symlink_not_supported()
+        dir_path = self.make_path("dir")
+        self.create_dir(dir_path)
+        link_path = self.make_path("link")
+        self.create_symlink(link_path, dir_path)
+        file_path = self.os.path.join(link_path, "file.txt")
+        self.create_file(file_path, contents="foo")
+        fd = self.os.open(file_path, os.O_RDONLY | os.O_NOFOLLOW)
+        self.assertGreater(fd, 0)
+        self.os.close(fd)
+
     def test_lexists_with_trailing_separator_linux_windows(self):
         self.check_linux_and_windows()
         self.skip_if_symlink_not_supported()
         file_path = self.make_path("foo")
         self.os.symlink(file_path, file_path)
         self.assertFalse(self.os.path.lexists(file_path + self.os.sep))
 
@@ -863,23 +942,23 @@
         self.os.remove(path)
         self.assertFalse(self.os.path.exists(path))
 
     def test_remove_open_file_fails_under_windows(self):
         self.check_windows_only()
         path = self.make_path("foo", "bar")
         self.create_file(path)
-        with self.open(path, "r"):
+        with self.open(path, "r", encoding="utf8"):
             self.assert_raises_os_error(errno.EACCES, self.os.remove, path)
         self.assertTrue(self.os.path.exists(path))
 
     def test_remove_open_file_possible_under_posix(self):
         self.check_posix_only()
         path = self.make_path("foo", "bar")
         self.create_file(path)
-        self.open(path, "r")
+        self.open(path, "r", encoding="utf8")
         self.os.remove(path)
         self.assertFalse(self.os.path.exists(path))
 
     def test_remove_file_relative_path(self):
         self.skip_real_fs()
         original_dir = self.os.getcwd()
         directory = self.make_path("zzy")
@@ -1292,16 +1371,16 @@
         self.create_file(file_path)
         self.os.rename(file_path, new_file_path)
         self.assertFalse(self.os.path.exists(file_path))
         self.assertTrue(self.os.path.exists(new_file_path))
 
     def check_append_mode_tell_after_truncate(self, tell_result):
         file_path = self.make_path("baz")
-        with self.open(file_path, "w") as f0:
-            with self.open(file_path, "a") as f1:
+        with self.open(file_path, "w", encoding="utf8") as f0:
+            with self.open(file_path, "a", encoding="utf8") as f1:
                 f1.write("abcde")
                 f0.seek(2)
                 f0.truncate()
                 self.assertEqual(tell_result, f1.tell())
         with self.open(file_path, mode="rb") as f:
             self.assertEqual(b"\0\0abcde", f.read())
 
@@ -1314,22 +1393,22 @@
         # Regression test for #300
         self.check_macos_only()
         self.check_append_mode_tell_after_truncate(7)
 
     def test_tell_after_seek_in_append_mode(self):
         # Regression test for #363
         file_path = self.make_path("foo")
-        with self.open(file_path, "a") as f:
+        with self.open(file_path, "a", encoding="utf8") as f:
             f.seek(1)
             self.assertEqual(1, f.tell())
 
     def test_tell_after_seekback_in_append_mode(self):
         # Regression test for #414
         file_path = self.make_path("foo")
-        with self.open(file_path, "a") as f:
+        with self.open(file_path, "a", encoding="utf8") as f:
             f.write("aa")
             f.seek(1)
             self.assertEqual(1, f.tell())
 
     def test_dir_with_trailing_sep_is_dir(self):
         # regression test for #387
         self.assertTrue(self, self.os.path.isdir(self.base_path + self.os.sep))
@@ -1812,14 +1891,22 @@
             self.os.makedirs(subdir)
             self.assertTrue(self.os.path.exists(subdir))
 
     def test_makedirs_raises_on_empty_path(self):
         self.assert_raises_os_error(errno.ENOENT, self.os.makedirs, "", exist_ok=False)
         self.assert_raises_os_error(errno.ENOENT, self.os.makedirs, "", exist_ok=True)
 
+    def test_makedirs_with_relative_paths(self):
+        # regression test for #987
+        path = self.make_path("base", "foo", "..", "bar")
+        self.os.makedirs(path)
+        self.assertTrue(self.os.path.isdir(self.make_path("base", "bar")))
+        self.assertTrue(self.os.path.isdir(self.make_path("base", "foo")))
+        self.assertFalse(self.os.path.isdir(self.make_path("base", "foo", "bar")))
+
     # test fsync and fdatasync
     def test_fsync_raises_on_non_int(self):
         with self.assertRaises(TypeError):
             self.os.fsync("zero")
 
     def test_fdatasync_raises_on_non_int(self):
         self.check_linux_only()
@@ -1834,41 +1921,41 @@
         self.assert_raises_os_error(errno.EINVAL, self.os.fdatasync, 0)
         self.assert_raises_os_error(errno.EBADF, self.os.fdatasync, 500)
 
     def test_fsync_pass_posix(self):
         self.check_posix_only()
         test_file_path = self.make_path("test_file")
         self.create_file(test_file_path, contents="dummy file contents")
-        with self.open(test_file_path, "r") as test_file:
+        with self.open(test_file_path, "r", encoding="utf8") as test_file:
             test_fd = test_file.fileno()
             # Test that this doesn't raise anything
             self.os.fsync(test_fd)
             # And just for sanity, double-check that this still raises
             self.assert_raises_os_error(errno.EBADF, self.os.fsync, test_fd + 500)
 
     def test_fsync_pass_windows(self):
         self.check_windows_only()
         test_file_path = self.make_path("test_file")
         self.create_file(test_file_path, contents="dummy file contents")
-        with self.open(test_file_path, "r+") as test_file:
+        with self.open(test_file_path, "r+", encoding="utf8") as test_file:
             test_fd = test_file.fileno()
             # Test that this doesn't raise anything
             self.os.fsync(test_fd)
             # And just for sanity, double-check that this still raises
             self.assert_raises_os_error(errno.EBADF, self.os.fsync, test_fd + 500)
-        with self.open(test_file_path, "r") as test_file:
+        with self.open(test_file_path, "r", encoding="utf8") as test_file:
             test_fd = test_file.fileno()
             self.assert_raises_os_error(errno.EBADF, self.os.fsync, test_fd)
 
     def test_fdatasync_pass(self):
         # setup
         self.check_linux_only()
         test_file_path = self.make_path("test_file")
         self.create_file(test_file_path, contents="dummy file contents")
-        test_file = self.open(test_file_path, "r")
+        test_file = self.open(test_file_path, "r", encoding="utf8")
         test_fd = test_file.fileno()
         # Test that this doesn't raise anything
         self.os.fdatasync(test_fd)
         # And just for sanity, double-check that this still raises
         self.assert_raises_os_error(errno.EBADF, self.os.fdatasync, test_fd + 500)
 
     def test_access700(self):
@@ -1982,15 +2069,15 @@
     def test_chmod_uses_open_fd_as_path(self):
         self.check_posix_only()
         self.skip_real_fs()
         self.assert_raises_os_error(errno.EBADF, self.os.chmod, 5, 0o6543)
         path = self.make_path("some_file")
         self.createTestFile(path)
 
-        with self.open(path) as f:
+        with self.open(path, encoding="utf8") as f:
             self.os.chmod(f.filedes, 0o6543)
             st = self.os.stat(path)
             self.assert_mode_equal(0o6543, st.st_mode)
 
     def test_chmod_follow_symlink(self):
         self.check_posix_only()
         path = self.make_path("some_file")
@@ -2013,30 +2100,31 @@
         self.create_symlink(link_path, path)
         if self.os.chmod not in self.os.supports_follow_symlinks or IS_PYPY:
             with self.assertRaises(NotImplementedError):
                 self.os.chmod(link_path, 0o6543, follow_symlinks=False)
         else:
             self.os.chmod(link_path, 0o6543, follow_symlinks=False)
             st = self.os.stat(link_path)
-            self.assert_mode_equal(0o666, st.st_mode)
+            mode = 0o644 if self.is_macos else 0o666
+            self.assert_mode_equal(mode, st.st_mode)
             st = self.os.stat(link_path, follow_symlinks=False)
             self.assert_mode_equal(0o6543, st.st_mode)
 
     def test_lchmod(self):
         """lchmod shall behave like chmod with follow_symlinks=True."""
         self.check_posix_only()
         self.skip_real_fs()
         path = self.make_path("some_file")
         self.createTestFile(path)
         link_path = self.make_path("link_to_some_file")
         self.create_symlink(link_path, path)
         self.os.lchmod(link_path, 0o6543)
 
         st = self.os.stat(link_path)
-        self.assert_mode_equal(0o666, st.st_mode)
+        self.assert_mode_equal(0o644, st.st_mode)
         st = self.os.lstat(link_path)
         self.assert_mode_equal(0o6543, st.st_mode)
 
     def test_chmod_dir(self):
         # set up
         self.check_posix_only()
         self.skip_real_fs()
@@ -2086,15 +2174,15 @@
     def test_chown_uses_open_fd_as_path(self):
         self.check_posix_only()
         self.skip_real_fs()
         self.assert_raises_os_error(errno.EBADF, self.os.chown, 5, 100, 101)
         file_path = self.make_path("foo", "bar")
         self.create_file(file_path)
 
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.os.chown(f.filedes, 100, 101)
             st = self.os.stat(file_path)
             self.assertEqual(st[stat.ST_UID], 100)
 
     def test_chown_follow_symlink(self):
         self.skip_real_fs()
         file_path = self.make_path("some_file")
@@ -2135,14 +2223,35 @@
 
     def test_chown_nonexisting_file_should_raise_os_error(self):
         self.check_posix_only()
         file_path = self.make_path("some_file")
         self.assertFalse(self.os.path.exists(file_path))
         self.assert_raises_os_error(errno.ENOENT, self.os.chown, file_path, 100, 100)
 
+    def test_fail_add_entry_to_readonly_dir(self):
+        # regression test for #959
+        self.check_posix_only()
+        self.skip_real_fs()  # cannot change owner to root
+        if is_root():
+            self.skipTest("Non-root test only")
+
+        # create directory owned by root with permissions 0o755 (rwxr-xr-x)
+        ro_dir = self.make_path("readonly-dir")
+        self.create_dir(ro_dir, perm=0o755)
+        self.os.chown(ro_dir, 0, 0)
+
+        # adding a new entry to the readonly subdirectory should fail
+        with self.assertRaises(PermissionError):
+            with self.open(f"{ro_dir}/file.txt", "w", encoding="utf8"):
+                pass
+        file_path = self.make_path("file.txt")
+        self.create_file(file_path)
+        with self.assertRaises(PermissionError):
+            self.os.link(file_path, self.os.path.join(ro_dir, "file.txt"))
+
     def test_classify_directory_contents(self):
         """Directory classification should work correctly."""
         root_directory = self.make_path("foo")
         test_directories = ["bar1", "baz2"]
         test_files = ["baz1", "bar2", "baz3"]
         self.create_dir(root_directory)
         for directory in test_directories:
@@ -2473,15 +2582,15 @@
         self.check_open_broken_symlink_to_path_with_trailing_sep(errno.EINVAL)
 
     def check_link_path_ending_with_sep(self, error):
         # Regression tests for #399
         self.skip_if_symlink_not_supported()
         file_path = self.make_path("foo")
         link_path = self.make_path("link")
-        with self.open(file_path, "w"):
+        with self.open(file_path, "w", encoding="utf8"):
             self.assert_raises_os_error(
                 error, self.os.link, file_path + self.os.sep, link_path
             )
 
     def test_link_path_ending_with_sep_posix(self):
         self.check_posix_only()
         self.check_link_path_ending_with_sep(errno.ENOTDIR)
@@ -2491,30 +2600,30 @@
         self.check_link_path_ending_with_sep(errno.EINVAL)
 
     def test_link_to_path_ending_with_sep_posix(self):
         # regression test for #407
         self.check_posix_only()
         path0 = self.make_path("foo") + self.os.sep
         path1 = self.make_path("bar")
-        with self.open(path1, "w"):
+        with self.open(path1, "w", encoding="utf8"):
             self.assert_raises_os_error(errno.ENOENT, self.os.link, path1, path0)
 
     def test_link_to_path_ending_with_sep_windows(self):
         self.check_windows_only()
         self.skip_if_symlink_not_supported()
         path0 = self.make_path("foo") + self.os.sep
         path1 = self.make_path("bar")
-        with self.open(path1, "w"):
+        with self.open(path1, "w", encoding="utf8"):
             self.os.link(path1, path0)
             self.assertTrue(self.os.path.exists(path1))
 
     def check_rename_to_path_ending_with_sep(self, error):
         # Regression tests for #400
         file_path = self.make_path("foo")
-        with self.open(file_path, "w"):
+        with self.open(file_path, "w", encoding="utf8"):
             self.assert_raises_os_error(
                 error, self.os.rename, file_path + self.os.sep, file_path
             )
 
     def test_rename_to_path_ending_with_sep_posix(self):
         self.check_posix_only()
         self.check_rename_to_path_ending_with_sep(errno.ENOTDIR)
@@ -2597,35 +2706,35 @@
         self.create_file(file1_path, contents=contents1)
         # link to second file
         self.os.link(file1_path, file2_path)
         # delete first file
         self.os.unlink(file1_path)
         # assert that second file exists, and its contents are the same
         self.assertTrue(self.os.path.exists(file2_path))
-        with self.open(file2_path) as f:
+        with self.open(file2_path, encoding="utf8") as f:
             self.assertEqual(f.read(), contents1)
 
     def test_link_update(self):
         self.skip_if_symlink_not_supported()
 
         file1_path = self.make_path("test_file1")
         file2_path = self.make_path("test_file2")
         contents1 = "abcdef"
         contents2 = "ghijkl"
         # Create file and link
         self.create_file(file1_path, contents=contents1)
         self.os.link(file1_path, file2_path)
         # assert that the second file contains contents1
-        with self.open(file2_path) as f:
+        with self.open(file2_path, encoding="utf8") as f:
             self.assertEqual(f.read(), contents1)
         # update the first file
-        with self.open(file1_path, "w") as f:
+        with self.open(file1_path, "w", encoding="utf8") as f:
             f.write(contents2)
         # assert that second file contains contents2
-        with self.open(file2_path) as f:
+        with self.open(file2_path, encoding="utf8") as f:
             self.assertEqual(f.read(), contents2)
 
     def test_link_non_existent_parent(self):
         self.skip_if_symlink_not_supported()
         file1_path = self.make_path("test_file1")
         breaking_link_path = self.make_path("nonexistent", "test_file2")
         contents1 = "abcdef"
@@ -2680,31 +2789,54 @@
         self.os.unlink(file3_path)
         self.assertEqual(self.os.stat(file1_path).st_nlink, 2)
         self.assertEqual(self.os.stat(file2_path).st_nlink, 2)
         # check that it gets decremented correctly again
         self.os.unlink(file1_path)
         self.assertEqual(self.os.stat(file2_path).st_nlink, 1)
 
+    @unittest.skipIf(IS_PYPY, "follow_symlinks not supported in PyPi")
+    def test_link_no_follow_symlink(self):
+        self.skip_if_symlink_not_supported()
+        target_path = self.make_path("target_path")
+        self.create_file(target_path, contents="foo")
+        symlink_path = self.make_path("symlink_to_file")
+        self.create_symlink(symlink_path, target_path)
+        link_path = self.make_path("link_to_symlink")
+        self.os.link(symlink_path, link_path, follow_symlinks=False)
+        self.assertTrue(self.os.path.islink(link_path))
+
+    @unittest.skipIf(not IS_PYPY, "follow_symlinks only not supported in PyPi")
+    def test_link_follow_symlink_not_supported_inPypy(self):
+        self.skip_if_symlink_not_supported()
+        target_path = self.make_path("target_path")
+        self.create_file(target_path, contents="foo")
+        symlink_path = self.make_path("symlink_to_file")
+        self.create_symlink(symlink_path, target_path)
+        link_path = self.make_path("link_to_symlink")
+        with self.assertRaises(OSError) as cm:
+            self.os.link(symlink_path, link_path, follow_symlinks=False)
+        self.assertEqual(errno.EINVAL, cm.exception.errno)
+
     def test_nlink_for_directories(self):
         self.skip_real_fs()
         self.create_dir(self.make_path("foo", "bar"))
         self.create_file(self.make_path("foo", "baz"))
         self.assertEqual(
             2,
             self.filesystem.get_object(self.make_path("foo", "bar")).st_nlink,
         )
         self.assertEqual(4, self.filesystem.get_object(self.make_path("foo")).st_nlink)
         self.create_file(self.make_path("foo", "baz2"))
         self.assertEqual(5, self.filesystem.get_object(self.make_path("foo")).st_nlink)
 
     def test_umask(self):
         self.check_posix_only()
-        umask = os.umask(0o22)
-        os.umask(umask)
-        self.assertEqual(umask, self.os.umask(0o22))
+        umask = self.os.umask(0o22)
+        self.assertEqual(umask, self.os.umask(0o12))
+        self.os.umask(umask)
 
     def test_mkdir_umask_applied(self):
         """mkdir creates a directory with umask applied."""
         self.check_posix_only()
         self.os.umask(0o22)
         dir1 = self.make_path("dir1")
         self.os.mkdir(dir1)
@@ -2713,26 +2845,27 @@
         dir2 = self.make_path("dir2")
         self.os.mkdir(dir2)
         self.assert_mode_equal(0o710, self.os.stat(dir2).st_mode)
 
     def test_makedirs_umask_applied(self):
         """makedirs creates a directories with umask applied."""
         self.check_posix_only()
-        self.os.umask(0o22)
+        umask = self.os.umask(0o22)
         self.os.makedirs(self.make_path("p1", "dir1"))
         self.assert_mode_equal(0o755, self.os.stat(self.make_path("p1")).st_mode)
         self.assert_mode_equal(
             0o755, self.os.stat(self.make_path("p1", "dir1")).st_mode
         )
         self.os.umask(0o67)
         self.os.makedirs(self.make_path("p2", "dir2"))
         self.assert_mode_equal(0o710, self.os.stat(self.make_path("p2")).st_mode)
         self.assert_mode_equal(
             0o710, self.os.stat(self.make_path("p2", "dir2")).st_mode
         )
+        self.os.umask(umask)
 
     def test_mknod_umask_applied(self):
         """mkdir creates a device with umask applied."""
         # skipping MacOs due to mknod permission issues
         self.check_linux_only()
         self.os.umask(0o22)
         node1 = self.make_path("nod1")
@@ -2744,19 +2877,19 @@
         self.assert_mode_equal(0o640, self.os.stat(node2).st_mode)
 
     def test_open_umask_applied(self):
         """open creates a file with umask applied."""
         self.check_posix_only()
         self.os.umask(0o22)
         file1 = self.make_path("file1")
-        self.open(file1, "w").close()
+        self.open(file1, "w", encoding="utf8").close()
         self.assert_mode_equal(0o644, self.os.stat(file1).st_mode)
         self.os.umask(0o27)
         file2 = self.make_path("file2")
-        self.open(file2, "w").close()
+        self.open(file2, "w", encoding="utf8").close()
         self.assert_mode_equal(0o640, self.os.stat(file2).st_mode)
 
     def test_open_pipe(self):
         read_fd, write_fd = self.os.pipe()
         self.os.close(read_fd)
         self.os.close(write_fd)
 
@@ -2790,15 +2923,15 @@
         # are out of sync (see #581)
         fds = []
         for i in range(5):
             path = self.make_path("file" + str(i))
             fds.append(self.os.open(path, os.O_CREAT))
         file_path = self.make_path("file.txt")
         self.create_file(file_path)
-        with self.open(file_path):
+        with self.open(file_path, encoding="utf8"):
             read_fd, write_fd = self.os.pipe()
             with self.open(write_fd, "wb") as f:
                 self.assertEqual(4, f.write(b"test"))
             with self.open(read_fd, "rb") as f:
                 self.assertEqual(b"test", f.read())
         for fd in fds:
             self.os.close(fd)
@@ -2820,54 +2953,54 @@
         self.os.close(read_fd)
         self.os.close(write_fd)
 
     def test_truncate(self):
         file_path = self.make_path("foo", "bar")
         self.create_file(file_path, contents="012345678901234567")
         self.os.truncate(file_path, 10)
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertEqual("0123456789", f.read())
 
     def test_truncate_non_existing(self):
         self.assert_raises_os_error(errno.ENOENT, self.os.truncate, "foo", 10)
 
     def test_truncate_to_larger(self):
         file_path = self.make_path("foo", "bar")
         self.create_file(file_path, contents="0123456789")
         fd = self.os.open(file_path, os.O_RDWR)
         self.os.truncate(fd, 20)
         self.assertEqual(20, self.os.stat(file_path).st_size)
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertEqual("0123456789" + "\0" * 10, f.read())
 
     def test_truncate_with_fd(self):
         if os.truncate not in os.supports_fd:
             self.skip_real_fs()
         self.assert_raises_os_error(errno.EBADF, self.os.ftruncate, 50, 10)
         file_path = self.make_path("some_file")
         self.create_file(file_path, contents="01234567890123456789")
 
         fd = self.os.open(file_path, os.O_RDWR)
         self.os.truncate(fd, 10)
         self.assertEqual(10, self.os.stat(file_path).st_size)
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertEqual("0123456789", f.read())
 
     def test_ftruncate(self):
         if self.is_pypy:
             # not correctly supported
             self.skip_real_fs()
         self.assert_raises_os_error(errno.EBADF, self.os.ftruncate, 50, 10)
         file_path = self.make_path("some_file")
         self.create_file(file_path, contents="0123456789012345")
 
         fd = self.os.open(file_path, os.O_RDWR)
         self.os.truncate(fd, 10)
         self.assertEqual(10, self.os.stat(file_path).st_size)
-        with self.open(file_path) as f:
+        with self.open(file_path, encoding="utf8") as f:
             self.assertEqual("0123456789", f.read())
 
     def test_capabilities(self):
         """Make sure that the fake capabilities are the same as the real ones."""
         self.assertEqual(
             self.os.stat in self.os.supports_follow_symlinks,
             os.stat in os.supports_follow_symlinks,
@@ -2877,23 +3010,82 @@
             self.os.stat in self.os.supports_dir_fd, os.stat in os.supports_dir_fd
         )
         self.assertEqual(
             self.os.stat in self.os.supports_effective_ids,
             os.stat in os.supports_effective_ids,
         )
 
+    def test_dup(self):
+        with self.assertRaises(OSError) as cm:
+            self.os.dup(500)
+        self.assertEqual(errno.EBADF, cm.exception.errno)
+        file_path = self.make_path("test.txt")
+        self.create_file(file_path, contents="heythere")
+        fd1 = self.os.open(file_path, os.O_RDONLY)
+        fd2 = self.os.dup(fd1)
+        self.assertEqual(b"hey", self.os.read(fd1, 3))
+        self.assertEqual(b"there", self.os.read(fd1, 10))
+        self.os.close(fd2)
+        self.os.close(fd1)
+
+    def test_dup_uses_freed_fd(self):
+        file_path1 = self.make_path("foo.txt")
+        file_path2 = self.make_path("bar.txt")
+        self.create_file(file_path1, contents="foo here")
+        self.create_file(file_path2, contents="bar here")
+        fd1 = self.os.open(file_path1, os.O_RDONLY)
+        fd2 = self.os.open(file_path2, os.O_RDONLY)
+        self.os.close(fd1)
+        fd3 = self.os.dup(fd2)
+        self.assertEqual(fd1, fd3)
+        self.os.close(fd2)
+
+    def test_dup2_uses_existing_fd(self):
+        with self.assertRaises(OSError) as cm:
+            self.os.dup2(500, 501)
+        self.assertEqual(errno.EBADF, cm.exception.errno)
+
+        file_path1 = self.make_path("foo.txt")
+        file_path2 = self.make_path("bar.txt")
+        self.create_file(file_path1, contents="foo here")
+        self.create_file(file_path2, contents="bar here")
+        fd1 = self.os.open(file_path1, os.O_RDONLY)
+        fd2 = self.os.open(file_path2, os.O_RDONLY)
+        self.assertEqual(b"bar", self.os.read(fd2, 3))
+        fd2 = self.os.dup2(fd1, fd2)
+        self.assertEqual(b"foo", self.os.read(fd2, 3))
+        self.os.lseek(fd2, 0, 0)
+        self.assertEqual(b"foo", self.os.read(fd1, 3))
+        self.os.close(fd2)
+
+    def test_dup2_with_new_fd(self):
+        file_path1 = self.make_path("foo.txt")
+        file_path2 = self.make_path("bar.txt")
+        self.create_file(file_path1)
+        self.create_file(file_path2)
+        fd1 = self.os.open(file_path1, os.O_RDONLY)
+        fd2 = fd1 + 2
+        self.assertEqual(fd2, self.os.dup2(fd1, fd2))
+        fd3 = self.os.open(file_path2, os.O_RDONLY)
+        fd4 = self.os.dup(fd3)
+        self.os.close(fd4)
+        self.os.close(fd2)
+        # we have a free position before fd2 that is now filled
+        self.assertEqual(fd1 + 1, fd3)
+        self.assertEqual(fd1 + 3, fd4)
+
 
 class RealOsModuleTest(FakeOsModuleTest):
     def use_real_fs(self):
         return True
 
 
 class FakeOsModuleTestCaseInsensitiveFS(FakeOsModuleTestBase):
     def setUp(self):
-        super(FakeOsModuleTestCaseInsensitiveFS, self).setUp()
+        super().setUp()
         self.check_case_insensitive_fs()
         self.rwx = self.os.R_OK | self.os.W_OK | self.os.X_OK
         self.rw = self.os.R_OK | self.os.W_OK
 
     def test_chdir_fails_non_directory(self):
         """chdir should raise OSError if the target is not a directory."""
         filename = self.make_path("foo", "bar")
@@ -2916,30 +3108,76 @@
         files = ["foo", "bar", "baz"]
         for f in files:
             self.create_file(self.make_path(directory, f))
         self.create_symlink(self.make_path("symlink"), self.make_path("xyzzy"))
         files.sort()
         self.assertEqual(files, sorted(self.os.listdir(self.make_path("SymLink"))))
 
-    def test_fdopen_mode(self):
-        self.skip_real_fs()
+    def test_listdir_possible_without_exe_permission(self):
+        # regression test for #960
+        self.check_posix_only()
+        self.skip_root()
+        directory = self.make_path("testdir")
+        file_path = self.os.path.join(directory, "file.txt")
+        self.create_file(file_path, contents="hey", perm=0o777)
+        self.os.chmod(directory, 0o655)  # rw-r-xr-x
+        # We cannot create any files in the directory, because that requires
+        # searching it
+        another_file = self.make_path("file.txt")
+        self.create_file(another_file, contents="hey")
+        with self.assertRaises(PermissionError):
+            self.os.link(another_file, self.os.path.join(directory, "link.txt"))
+        # We can enumerate the directory using listdir and scandir:
+        assert self.os.listdir(directory) == ["file.txt"]
+        assert len(list(self.os.scandir(directory))) == 1
+
+        # We cannot read files inside of the directory,
+        # even if we have read access to the file
+        with self.assertRaises(PermissionError):
+            self.os.stat(file_path)
+        with self.assertRaises(PermissionError):
+            with self.open(file_path, encoding="utf8") as f:
+                f.read()
+
+    def test_listdir_impossible_without_read_permission(self):
+        # regression test for #960
+        self.check_posix_only()
+        self.skip_root()
+        directory = self.make_path("testdir")
+        file_path = self.os.path.join(directory, "file.txt")
+        self.create_file(file_path, contents="hey", perm=0o777)
+        self.os.chmod(directory, 0o355)  # -wxr-xr-x
+        another_file = self.make_path("file.txt")
+        self.create_file(another_file, contents="hey")
+        self.os.link(another_file, self.os.path.join(directory, "link.txt"))
+        # We cannot enumerate the directory using listdir or scandir:
+        with self.assertRaises(PermissionError):
+            self.os.listdir(directory)
+        with self.assertRaises(PermissionError):
+            self.os.scandir(directory)
+        # we can access the file if we know the file name
+        assert self.os.stat(file_path).st_mode & 0o777 == 0o755
+        with self.open(file_path, encoding="utf8") as f:
+            assert f.read() == "hey"
+
+    def test_fdopen_twice(self):
         file_path1 = self.make_path("some_file1")
-        file_path2 = self.make_path("Some_File1")
-        file_path3 = self.make_path("SOME_file1")
+        file_path2 = self.make_path("SOME_file1")
         self.create_file(file_path1, contents="contents here1")
-        self.os.chmod(file_path2, (stat.S_IFREG | 0o666) ^ stat.S_IWRITE)
 
-        fake_file1 = self.open(file_path3, "r")
+        fake_file1 = self.open(file_path2, "r", encoding="utf8")
         fileno1 = fake_file1.fileno()
-        self.os.fdopen(fileno1)
-        self.os.fdopen(fileno1, "r")
-        if not is_root():
-            self.assertRaises(OSError, self.os.fdopen, fileno1, "w")
+        self.os.fdopen(fileno1, encoding="utf8")
+        if not IS_PYPY:
+            with self.assertRaises(OSError) as cm:
+                self.open(fileno1, encoding="utf8")
+            self.assertEqual(errno.EBADF, cm.exception.errno)
         else:
-            self.os.fdopen(fileno1, "w")
+            self.open(fileno1, encoding="utf8")
+            self.os.close(fileno1)
 
     def test_stat(self):
         directory = self.make_path("xyzzy")
         directory1 = self.make_path("XYZZY")
         file_path = self.os.path.join(directory, "plugh")
         self.create_file(file_path, contents="ABCDE")
         self.assertTrue(stat.S_IFDIR & self.os.stat(directory1)[stat.ST_MODE])
@@ -3089,23 +3327,23 @@
         self.os.remove(file_name.upper())
         self.assertFalse(self.os.path.exists(file_path))
 
     def test_remove_open_file_fails_under_windows(self):
         self.check_windows_only()
         path = self.make_path("foo", "bar")
         self.create_file(path)
-        with self.open(path, "r"):
+        with self.open(path, "r", encoding="utf8"):
             self.assert_raises_os_error(errno.EACCES, self.os.remove, path.upper())
         self.assertTrue(self.os.path.exists(path))
 
     def test_remove_open_file_possible_under_posix(self):
         self.check_posix_only()
         path = self.make_path("foo", "bar")
         self.create_file(path)
-        self.open(path, "r")
+        self.open(path, "r", encoding="utf8")
         self.os.remove(path.upper())
         self.assertFalse(self.os.path.exists(path))
 
     def test_remove_file_relative_path(self):
         self.skip_real_fs()
         original_dir = self.os.getcwd()
         directory = self.make_path("zzy")
@@ -3743,15 +3981,15 @@
         self.os.makedirs(directory.upper(), exist_ok=True)
         self.assertTrue(self.os.path.exists(directory))
 
     # test fsync and fdatasync
     def test_fsync_pass(self):
         test_file_path = self.make_path("test_file")
         self.create_file(test_file_path, contents="dummy file contents")
-        test_file = self.open(test_file_path.upper(), "r+")
+        test_file = self.open(test_file_path.upper(), "r+", encoding="utf8")
         test_fd = test_file.fileno()
         # Test that this doesn't raise anything
         self.os.fsync(test_fd)
         # And just for sanity, double-check that this still raises
         self.assert_raises_os_error(errno.EBADF, self.os.fsync, test_fd + 10)
         test_file.close()
 
@@ -3790,15 +4028,15 @@
         self.create_file(file1_path, contents=contents1)
         # link to second file
         self.os.link(file1_path.upper(), file2_path)
         # delete first file
         self.os.unlink(file1_path)
         # assert that second file exists, and its contents are the same
         self.assertTrue(self.os.path.exists(file2_path))
-        with self.open(file2_path.upper()) as f:
+        with self.open(file2_path.upper(), encoding="utf8") as f:
             self.assertEqual(f.read(), contents1)
 
     def test_link_is_existing_file(self):
         self.skip_if_symlink_not_supported()
         file_path = self.make_path("foo", "bar")
         self.create_file(file_path)
         self.assert_raises_os_error(
@@ -3940,28 +4178,24 @@
     def test_utime_uses_open_fd_as_path(self):
         if os.utime not in os.supports_fd:
             self.skip_real_fs()
         self.assert_raises_os_error(errno.EBADF, self.os.utime, 5, (1, 2))
         path = self.make_path("some_file")
         self.createTestFile(path)
 
-        with FakeFileOpen(self.filesystem)(path) as f:
+        with FakeFileOpen(self.filesystem)(path, encoding="utf8") as f:
             self.os.utime(f.filedes, times=(1, 2))
             st = self.os.stat(path)
             self.assertEqual(1, st.st_atime)
             self.assertEqual(2, st.st_mtime)
 
 
 class FakeOsModuleLowLevelFileOpTest(FakeOsModuleTestBase):
     """Test low level functions `os.open()`, `os.read()` and `os.write()`."""
 
-    def setUp(self):
-        os.umask(0o022)
-        super(FakeOsModuleLowLevelFileOpTest, self).setUp()
-
     def test_open_read_only(self):
         file_path = self.make_path("file1")
         self.create_file(file_path, contents=b"contents")
 
         file_des = self.os.open(file_path, os.O_RDONLY)
         self.assertEqual(b"contents", self.os.read(file_des, 8))
         self.assert_raises_os_error(errno.EBADF, self.os.write, file_des, b"test")
@@ -4393,59 +4627,59 @@
         self.create_file(src_file_path, "testcontent")
         self.create_file(dst_file_path)
         fd1 = self.os.open(src_file_path, os.O_RDONLY)
         fd2 = self.os.open(dst_file_path, os.O_RDWR)
         self.os.sendfile(fd2, fd1, 0, 3)
         self.os.close(fd2)
         self.os.close(fd1)
-        with self.open(dst_file_path) as f:
+        with self.open(dst_file_path, encoding="utf8") as f:
             self.assertEqual("tes", f.read())
 
     def test_sendfile_with_offset(self):
         self.check_linux_only()
         src_file_path = self.make_path("foo")
         dst_file_path = self.make_path("bar")
         self.create_file(src_file_path, "testcontent")
         self.create_file(dst_file_path)
         fd1 = self.os.open(src_file_path, os.O_RDONLY)
         fd2 = self.os.open(dst_file_path, os.O_RDWR)
         self.os.sendfile(fd2, fd1, 4, 4)
         self.os.close(fd2)
         self.os.close(fd1)
-        with self.open(dst_file_path) as f:
+        with self.open(dst_file_path, encoding="utf8") as f:
             self.assertEqual("cont", f.read())
 
     def test_sendfile_twice(self):
         self.check_linux_only()
         src_file_path = self.make_path("foo")
         dst_file_path = self.make_path("bar")
         self.create_file(src_file_path, "testcontent")
         self.create_file(dst_file_path)
         fd1 = self.os.open(src_file_path, os.O_RDONLY)
         fd2 = self.os.open(dst_file_path, os.O_RDWR)
         self.os.sendfile(fd2, fd1, 4, 4)
         self.os.sendfile(fd2, fd1, 4, 4)
         self.os.close(fd2)
         self.os.close(fd1)
-        with self.open(dst_file_path) as f:
+        with self.open(dst_file_path, encoding="utf8") as f:
             self.assertEqual("contcont", f.read())
 
     def test_sendfile_offset_none(self):
         self.check_linux_only()
         src_file_path = self.make_path("foo")
         dst_file_path = self.make_path("bar")
         self.create_file(src_file_path, "testcontent")
         self.create_file(dst_file_path)
         fd1 = self.os.open(src_file_path, os.O_RDONLY)
         fd2 = self.os.open(dst_file_path, os.O_RDWR)
         self.os.sendfile(fd2, fd1, None, 4)
         self.os.sendfile(fd2, fd1, None, 3)
         self.os.close(fd2)
         self.os.close(fd1)
-        with self.open(dst_file_path) as f:
+        with self.open(dst_file_path, encoding="utf8") as f:
             self.assertEqual("testcon", f.read())
 
     @unittest.skipIf(not TestCase.is_macos, "Testing MacOs only behavior")
     def test_no_sendfile_to_regular_file_under_macos(self):
         src_file_path = self.make_path("foo")
         dst_file_path = self.make_path("bar")
         self.create_file(src_file_path, "testcontent")
@@ -4671,252 +4905,276 @@
 class RealOsModuleWalkTest(FakeOsModuleWalkTest):
     def use_real_fs(self):
         return True
 
 
 class FakeOsModuleDirFdTest(FakeOsModuleTestBase):
     def setUp(self):
-        super(FakeOsModuleDirFdTest, self).setUp()
-        self.os.supports_dir_fd.clear()
-        self.filesystem.is_windows_fs = False
-        self.filesystem.create_dir("/foo/bar")
-        self.dir_fd = self.os.open("/foo", os.O_RDONLY)
-        self.filesystem.create_file("/foo/baz")
+        super().setUp()
+        self.check_posix_only()
+        if not self.use_real_fs():
+            # in the real OS, we test the option as is, in the fake OS
+            # we test both the supported and unsupported option
+            self.os.supports_dir_fd.clear()
+        self.dir_fd_path = self.make_path("foo")
+        self.create_dir(self.dir_fd_path)
+        self.dir_fd = self.os.open(self.dir_fd_path, os.O_RDONLY)
+        self.fname = "baz"
+        self.fpath = self.os.path.join(self.dir_fd_path, self.fname)
+        self.create_file(self.fpath)
+
+    def add_supported_function(self, fct):
+        if not self.use_real_fs():
+            self.os.supports_dir_fd.add(fct)
 
     def test_access(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.access,
-            "baz",
-            self.os.F_OK,
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.access)
-        self.assertTrue(self.os.access("baz", self.os.F_OK, dir_fd=self.dir_fd))
+        def os_access():
+            return self.os.access(self.fname, self.os.F_OK, dir_fd=self.dir_fd)
+
+        if self.os.access not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_access()
+        self.add_supported_function(self.os.access)
+        if self.os.access in self.os.supports_dir_fd:
+            self.assertTrue(os_access())
 
     def test_chmod(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.chmod,
-            "baz",
-            0o6543,
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.chmod)
-        self.os.chmod("baz", 0o6543, dir_fd=self.dir_fd)
-        st = self.os.stat("/foo/baz")
-        self.assert_mode_equal(0o6543, st.st_mode)
+        def os_chmod():
+            self.os.chmod(self.fname, 0o6543, dir_fd=self.dir_fd)
+
+        if self.os.chmod not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_chmod()
+        self.add_supported_function(self.os.chmod)
+        if self.os.chmod in self.os.supports_dir_fd:
+            os_chmod()
+            st = self.os.stat(self.fpath)
+            self.assert_mode_equal(0o6543, st.st_mode)
 
     @unittest.skipIf(not hasattr(os, "chown"), "chown not on all platforms available")
     def test_chown(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.chown,
-            "baz",
-            100,
-            101,
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.chown)
-        self.os.chown("baz", 100, 101, dir_fd=self.dir_fd)
-        st = self.os.stat("/foo/baz")
-        self.assertEqual(st[stat.ST_UID], 100)
-        self.assertEqual(st[stat.ST_GID], 101)
+        def os_chown():
+            self.os.chown(self.fname, 100, 101, dir_fd=self.dir_fd)
+
+        self.skip_real_fs()
+        if self.os.chown not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_chown()
+        self.add_supported_function(self.os.chown)
+        os_chown()
+        st = self.os.stat(self.fpath)
+        self.assertEqual(100, st[stat.ST_UID])
+        self.assertEqual(101, st[stat.ST_GID])
 
     def test_link_src_fd(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.link,
-            "baz",
-            "/bat",
-            src_dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.link)
-        self.os.link("baz", "/bat", src_dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/bat"))
+        def os_link():
+            self.os.link(self.fname, link_dest, src_dir_fd=self.dir_fd)
+
+        link_dest = self.make_path("bat")
+        if self.os.link not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_link()
+        self.add_supported_function(self.os.link)
+        if self.os.link in self.os.supports_dir_fd:
+            os_link()
+            self.assertTrue(self.os.path.exists(link_dest))
 
     def test_link_dst_fd(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.link,
-            "baz",
-            "/bat",
-            dst_dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.link)
-        self.os.link("/foo/baz", "bat", dst_dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/bat"))
+        def os_link():
+            self.os.link(self.fpath, "bat", dst_dir_fd=self.dir_fd)
+
+        if self.os.link not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_link()
+        self.add_supported_function(self.os.link)
+        if self.os.link in self.os.supports_dir_fd:
+            os_link()
+            link_path = self.os.path.join(self.dir_fd_path, "bat")
+            self.assertTrue(self.os.path.exists(link_path))
 
     def test_symlink(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.symlink,
-            "baz",
-            "/bat",
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.symlink)
-        self.os.symlink("baz", "/bat", dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/bat"))
+        def os_symlink():
+            self.os.symlink(self.fpath, "bat", dir_fd=self.dir_fd)
+
+        if self.os.symlink not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_symlink()
+        self.add_supported_function(self.os.symlink)
+        if self.os.symlink in self.os.supports_dir_fd:
+            os_symlink()
+            link_path = self.os.path.join(self.dir_fd_path, "bat")
+            self.assertTrue(self.os.path.exists(link_path))
 
     def test_readlink(self):
-        self.skip_if_symlink_not_supported()
-        self.filesystem.create_symlink("/meyer/lemon/pie", "/foo/baz")
-        self.filesystem.create_symlink("/geo/metro", "/meyer")
-        self.assertRaises(
-            NotImplementedError,
-            self.os.readlink,
-            "/geo/metro/lemon/pie",
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.readlink)
-        self.assertEqual(
-            "/foo/baz",
-            self.os.readlink("/geo/metro/lemon/pie", dir_fd=self.dir_fd),
-        )
+        def os_readlink():
+            return self.os.readlink("lemon/tree", dir_fd=self.dir_fd)
+
+        link_dir = self.os.path.join(self.dir_fd_path, "lemon")
+        self.create_dir(link_dir)
+        self.create_symlink(self.os.path.join(link_dir, "tree"), self.fpath)
+        if self.os.readlink not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_readlink()
+        self.add_supported_function(self.os.readlink)
+        if self.os.readlink in self.os.supports_dir_fd:
+            self.assertEqual(self.fpath, os_readlink())
 
     def test_stat(self):
-        self.assertRaises(NotImplementedError, self.os.stat, "baz", dir_fd=self.dir_fd)
-        self.os.supports_dir_fd.add(self.os.stat)
-        st = self.os.stat("baz", dir_fd=self.dir_fd)
-        self.assertEqual(st.st_mode, 0o100666)
+        def os_stat():
+            return self.os.stat(self.fname, dir_fd=self.dir_fd)
+
+        if self.os.stat not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_stat()
+        self.add_supported_function(self.os.stat)
+        if self.os.stat in self.os.supports_dir_fd:
+            self.assertEqual(os_stat().st_mode, 0o100644)
 
     def test_lstat(self):
-        self.assertRaises(NotImplementedError, self.os.lstat, "baz", dir_fd=self.dir_fd)
-        self.os.supports_dir_fd.add(self.os.lstat)
-        st = self.os.lstat("baz", dir_fd=self.dir_fd)
-        self.assertEqual(st.st_mode, 0o100666)
+        st = self.os.lstat(self.fname, dir_fd=self.dir_fd)
+        self.assertEqual(st.st_mode, 0o100644)
 
     def test_mkdir(self):
-        self.assertRaises(
-            NotImplementedError, self.os.mkdir, "newdir", dir_fd=self.dir_fd
-        )
-        self.os.supports_dir_fd.add(self.os.mkdir)
-        self.os.mkdir("newdir", dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/newdir"))
+        def os_mkdir():
+            self.os.mkdir("newdir", dir_fd=self.dir_fd)
+
+        newdir_path = self.os.path.join(self.dir_fd_path, "newdir")
+        if self.os.mkdir not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_mkdir()
+        self.add_supported_function(self.os.mkdir)
+        if self.os.mkdir in self.os.supports_dir_fd:
+            os_mkdir()
+            self.assertTrue(self.os.path.exists(newdir_path))
 
     def test_rmdir(self):
-        self.assertRaises(NotImplementedError, self.os.rmdir, "bar", dir_fd=self.dir_fd)
-        self.os.supports_dir_fd.add(self.os.rmdir)
-        self.os.rmdir("bar", dir_fd=self.dir_fd)
-        self.assertFalse(self.os.path.exists("/foo/bar"))
+        def os_rmdir():
+            self.os.rmdir("dir", dir_fd=self.dir_fd)
+
+        dir_path = self.os.path.join(self.dir_fd_path, "dir")
+        self.create_dir(dir_path)
+        self.assertTrue(self.os.path.exists(dir_path))
+        if self.os.rmdir not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_rmdir()
+        self.add_supported_function(self.os.rmdir)
+        if self.os.rmdir in self.os.supports_dir_fd:
+            os_rmdir()
+            self.assertFalse(self.os.path.exists(dir_path))
 
     @unittest.skipIf(not hasattr(os, "mknod"), "mknod not on all platforms available")
     def test_mknod(self):
-        self.assertRaises(
-            NotImplementedError, self.os.mknod, "newdir", dir_fd=self.dir_fd
-        )
-        self.os.supports_dir_fd.add(self.os.mknod)
-        self.os.mknod("newdir", dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/newdir"))
+        def os_mknod():
+            self.os.mknod("newdir", dir_fd=self.dir_fd)
+
+        if self.os.mknod not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_mknod()
+        self.add_supported_function(self.os.mknod)
+        if self.os.mknod in self.os.supports_dir_fd:
+            os_mknod()
+            newdir_path = self.os.path.join(self.dir_fd_path, "newdir")
+            self.assertTrue(self.os.path.exists(newdir_path))
 
     def test_rename_src_fd(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.rename,
-            "baz",
-            "/foo/batz",
-            src_dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.rename)
-        self.os.rename("bar", "/foo/batz", src_dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/batz"))
+        def os_rename():
+            self.os.rename(self.fname, new_name, src_dir_fd=self.dir_fd)
+
+        new_name = self.os.path.join(self.dir_fd_path, "batz")
+        if self.os.rename not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_rename()
+        self.add_supported_function(self.os.rename)
+        if self.os.rename in self.os.supports_dir_fd:
+            os_rename()
+            self.assertTrue(self.os.path.exists(new_name))
 
     def test_rename_dst_fd(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.rename,
-            "baz",
-            "/foo/batz",
-            dst_dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.rename)
-        self.os.rename("/foo/bar", "batz", dst_dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/batz"))
+        def os_rename():
+            self.os.rename(self.fpath, "batz", dst_dir_fd=self.dir_fd)
+
+        if self.os.rename not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_rename()
+        self.add_supported_function(self.os.rename)
+        if self.os.rename in self.os.supports_dir_fd:
+            os_rename()
+            new_path = self.os.path.join(self.dir_fd_path, "batz")
+            self.assertTrue(self.os.path.exists(new_path))
 
     def test_replace_src_fd(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.rename,
-            "baz",
-            "/foo/batz",
-            src_dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.rename)
-        self.os.replace("bar", "/foo/batz", src_dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/batz"))
+        new_name = self.os.path.join(self.dir_fd_path, "batz")
+        self.os.replace(self.fname, new_name, src_dir_fd=self.dir_fd)
+        self.assertTrue(self.os.path.exists(new_name))
 
     def test_replace_dst_fd(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.rename,
-            "baz",
-            "/foo/batz",
-            dst_dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.rename)
-        self.os.replace("/foo/bar", "batz", dst_dir_fd=self.dir_fd)
-        self.assertTrue(self.os.path.exists("/foo/batz"))
+        self.os.replace(self.fpath, "batz", dst_dir_fd=self.dir_fd)
+        new_path = self.os.path.join(self.dir_fd_path, "batz")
+        self.assertTrue(self.os.path.exists(new_path))
 
     def test_remove(self):
-        self.assertRaises(
-            NotImplementedError, self.os.remove, "baz", dir_fd=self.dir_fd
-        )
-        self.os.supports_dir_fd.add(self.os.remove)
-        self.os.remove("baz", dir_fd=self.dir_fd)
-        self.assertFalse(self.os.path.exists("/foo/baz"))
+        self.os.remove(self.fname, dir_fd=self.dir_fd)
+        self.assertFalse(self.os.path.exists(self.fpath))
 
     def test_unlink(self):
-        self.assertRaises(
-            NotImplementedError, self.os.unlink, "baz", dir_fd=self.dir_fd
-        )
-        self.os.supports_dir_fd.add(self.os.unlink)
-        self.os.unlink("baz", dir_fd=self.dir_fd)
-        self.assertFalse(self.os.path.exists("/foo/baz"))
+        def os_unlink():
+            self.os.unlink(self.fname, dir_fd=self.dir_fd)
+
+        if self.os.unlink not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_unlink()
+        self.add_supported_function(self.os.unlink)
+        if self.os.unlink in self.os.supports_dir_fd:
+            os_unlink()
+            self.assertFalse(self.os.path.exists(self.fpath))
 
     def test_utime(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.utime,
-            "baz",
-            (1, 2),
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.utime)
-        self.os.utime("baz", times=(1, 2), dir_fd=self.dir_fd)
-        st = self.os.stat("/foo/baz")
-        self.assertEqual(1, st.st_atime)
-        self.assertEqual(2, st.st_mtime)
+        def os_utime():
+            self.os.utime(self.fname, times=(1, 2), dir_fd=self.dir_fd)
+
+        if self.os.utime not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_utime()
+        self.add_supported_function(self.os.utime)
+        if self.os.utime in self.os.supports_dir_fd:
+            os_utime()
+            st = self.os.stat(self.fpath)
+            self.assertEqual(1, st.st_atime)
+            self.assertEqual(2, st.st_mtime)
 
     def test_open(self):
-        self.assertRaises(
-            NotImplementedError,
-            self.os.open,
-            "baz",
-            os.O_RDONLY,
-            dir_fd=self.dir_fd,
-        )
-        self.os.supports_dir_fd.add(self.os.open)
-        fd = self.os.open("baz", os.O_RDONLY, dir_fd=self.dir_fd)
-        self.assertLess(0, fd)
+        def os_open():
+            return self.os.open(self.fname, os.O_RDONLY, dir_fd=self.dir_fd)
+
+        if self.os.open not in self.os.supports_dir_fd:
+            with self.assertRaises(NotImplementedError):
+                os_open()
+        self.add_supported_function(self.os.open)
+        if self.os.open in self.os.supports_dir_fd:
+            self.assertLess(0, os_open())
+
+
+class RealOsModuleDirFdTest(FakeOsModuleDirFdTest):
+    def use_real_fs(self):
+        return True
 
 
 class StatPropagationTest(TestCase):
     def setUp(self):
         self.filesystem = fake_filesystem.FakeFilesystem(path_separator="/")
         self.os = fake_os.FakeOsModule(self.filesystem)
         self.open = fake_open.FakeFileOpen(self.filesystem)
 
     def test_file_size_updated_via_close(self):
         """test that file size gets updated via close()."""
         file_dir = "xyzzy"
         file_path = "xyzzy/close"
         content = "This is a test."
         self.os.mkdir(file_dir)
-        fh = self.open(file_path, "w")
+        fh = self.open(file_path, "w", encoding="utf8")
         self.assertEqual(0, self.os.stat(file_path)[stat.ST_SIZE])
         self.assertEqual("", self.filesystem.get_object(file_path).contents)
         fh.write(content)
         self.assertEqual(0, self.os.stat(file_path)[stat.ST_SIZE])
         self.assertEqual("", self.filesystem.get_object(file_path).contents)
         fh.close()
         self.assertEqual(len(content), self.os.stat(file_path)[stat.ST_SIZE])
@@ -4926,51 +5184,53 @@
         file_dir = "xyzzy"
         file_path = "xyzzy/close"
         self.os.mkdir(file_dir)
         size = 1234
         # The file has size, but no content. When the file is opened for
         # reading, its size should be preserved.
         self.filesystem.create_file(file_path, st_size=size)
-        fh = self.open(file_path, "r")
+        fh = self.open(file_path, "r", encoding="utf8")
         fh.close()
-        self.assertEqual(size, self.open(file_path, "r").size())
+        self.assertEqual(size, self.open(file_path, "r", encoding="utf8").size())
 
     def test_file_size_after_write(self):
         file_path = "test_file"
         original_content = "abcdef"
         original_size = len(original_content)
         self.filesystem.create_file(file_path, contents=original_content)
         added_content = "foo bar"
         expected_size = original_size + len(added_content)
-        fh = self.open(file_path, "a")
+        fh = self.open(file_path, "a", encoding="utf8")
         fh.write(added_content)
         self.assertEqual(original_size, fh.size())
         fh.close()
-        self.assertEqual(expected_size, self.open(file_path, "r").size())
+        self.assertEqual(
+            expected_size, self.open(file_path, "r", encoding="utf8").size()
+        )
 
     def test_large_file_size_after_write(self):
         file_path = "test_file"
         original_content = "abcdef"
         original_size = len(original_content)
         self.filesystem.create_file(file_path, st_size=original_size)
         added_content = "foo bar"
-        fh = self.open(file_path, "a")
+        fh = self.open(file_path, "a", encoding="utf8")
         self.assertRaises(
             fake_file.FakeLargeFileIoException,
             lambda: fh.write(added_content),
         )
 
     def test_file_size_updated_via_flush(self):
         """test that file size gets updated via flush()."""
         file_dir = "xyzzy"
         file_name = "flush"
         file_path = self.os.path.join(file_dir, file_name)
         content = "This might be a test."
         self.os.mkdir(file_dir)
-        fh = self.open(file_path, "w")
+        fh = self.open(file_path, "w", encoding="utf8")
         self.assertEqual(0, self.os.stat(file_path)[stat.ST_SIZE])
         self.assertEqual("", self.filesystem.get_object(file_path).contents)
         fh.write(content)
         self.assertEqual(0, self.os.stat(file_path)[stat.ST_SIZE])
         self.assertEqual("", self.filesystem.get_object(file_path).contents)
         fh.flush()
         self.assertEqual(len(content), self.os.stat(file_path)[stat.ST_SIZE])
@@ -4983,34 +5243,34 @@
         """test that file size gets updated via open()."""
         file_dir = "xyzzy"
         file_path = "xyzzy/truncation"
         content = "AAA content."
 
         # pre-create file with content
         self.os.mkdir(file_dir)
-        fh = self.open(file_path, "w")
+        fh = self.open(file_path, "w", encoding="utf8")
         fh.write(content)
         fh.close()
         self.assertEqual(len(content), self.os.stat(file_path)[stat.ST_SIZE])
         self.assertEqual(content, self.filesystem.get_object(file_path).contents)
 
         # test file truncation
-        fh = self.open(file_path, "w")
+        fh = self.open(file_path, "w", encoding="utf8")
         self.assertEqual(0, self.os.stat(file_path)[stat.ST_SIZE])
         self.assertEqual("", self.filesystem.get_object(file_path).contents)
         fh.close()
 
 
 @unittest.skipIf(not use_scandir, "only run if scandir is available")
 class FakeScandirTest(FakeOsModuleTestBase):
     FILE_SIZE = 50
     LINKED_FILE_SIZE = 10
 
     def setUp(self):
-        super(FakeScandirTest, self).setUp()
+        super().setUp()
         self.supports_symlinks = not self.is_windows or not self.use_real_fs()
 
         if use_scandir_package:
             if self.use_real_fs():
                 from scandir import scandir
             else:
                 import pyfakefs.fake_scandir
@@ -5179,15 +5439,14 @@
                 if self.is_windows_fs:
                     self.assertEqual(0, scandir_stat_nlink)
                 else:
                     self.assertEqual(1, scandir_stat_nlink)
                 self.assertEqual(1, self.os.stat(self.file_path).st_nlink)
 
     @unittest.skipIf(not hasattr(os, "O_DIRECTORY"), "opening directory not supported")
-    @unittest.skipIf(sys.version_info < (3, 7), "fd not supported for scandir")
     def test_scandir_with_fd(self):
         # regression test for #723
         temp_dir = self.make_path("tmp", "dir")
         self.create_dir(temp_dir)
         self.create_file(self.os.path.join(temp_dir, "file1"))
         self.create_file(self.os.path.join(temp_dir, "file2"))
         self.create_dir(self.os.path.join(temp_dir, "subdir"))
@@ -5302,15 +5561,15 @@
 
 
 @unittest.skipIf(TestCase.is_windows, "dir_fd not supported for os.scandir in Windows")
 @unittest.skipIf(use_scandir_package, "no dir_fd support for scandir package")
 class FakeScandirFdTest(FakeScandirTest):
     def tearDown(self):
         self.os.close(self.dir_fd)
-        super(FakeScandirFdTest, self).tearDown()
+        super().tearDown()
 
     def scandir_path(self):
         # When scandir is called with a filedescriptor, only the name of the
         # entry is returned in the path attribute of the DirEntry objects.
         return ""
 
     def do_scandir(self):
@@ -5332,54 +5591,55 @@
 class RealScandirFdRelTest(FakeScandirFdRelTest):
     def use_real_fs(self):
         return True
 
 
 class FakeExtendedAttributeTest(FakeOsModuleTestBase):
     def setUp(self):
-        super(FakeExtendedAttributeTest, self).setUp()
+        super().setUp()
         self.check_linux_only()
         self.dir_path = self.make_path("foo")
         self.file_path = self.os.path.join(self.dir_path, "bar")
         self.create_file(self.file_path)
 
     def test_empty_xattr(self):
         self.assertEqual([], self.os.listxattr(self.dir_path))
         self.assertEqual([], self.os.listxattr(self.file_path))
 
+    def test_getxattr_raises_for_non_existing_file(self):
+        with self.assertRaises(FileNotFoundError):
+            self.os.getxattr("bogus_path", "test")
+
+    def test_getxattr_raises_for_non_existing_attribute(self):
+        with self.assertRaises(OSError) as cm:
+            self.os.getxattr(self.file_path, "bogus")
+        self.assertEqual(errno.ENODATA, cm.exception.errno)
+
     def test_setxattr(self):
-        self.assertRaises(TypeError, self.os.setxattr, self.file_path, "test", "value")
-        self.assert_raises_os_error(
-            errno.EEXIST,
-            self.os.setxattr,
-            self.file_path,
-            "test",
-            b"value",
-            self.os.XATTR_REPLACE,
-        )
+        with self.assertRaises(TypeError):
+            self.os.setxattr(self.file_path, "test", "value")
+        with self.assertRaises(FileExistsError):
+            self.os.setxattr(self.file_path, "test", b"value", self.os.XATTR_REPLACE)
         self.os.setxattr(self.file_path, "test", b"value")
         self.assertEqual(b"value", self.os.getxattr(self.file_path, "test"))
-        self.assert_raises_os_error(
-            errno.ENODATA,
-            self.os.setxattr,
-            self.file_path,
-            "test",
-            b"value",
-            self.os.XATTR_CREATE,
-        )
+        with self.assertRaises(OSError) as cm:
+            self.os.setxattr(self.file_path, "test", b"value", self.os.XATTR_CREATE)
+        self.assertEqual(errno.ENODATA, cm.exception.errno)
 
     def test_removeattr(self):
         self.os.removexattr(self.file_path, "test")
         self.assertEqual([], self.os.listxattr(self.file_path))
         self.os.setxattr(self.file_path, b"test", b"value")
         self.assertEqual(["test"], self.os.listxattr(self.file_path))
         self.assertEqual(b"value", self.os.getxattr(self.file_path, "test"))
         self.os.removexattr(self.file_path, "test")
         self.assertEqual([], self.os.listxattr(self.file_path))
-        self.assertIsNone(self.os.getxattr(self.file_path, "test"))
+        with self.assertRaises(OSError) as cm:
+            self.os.getxattr(self.file_path, "test")
+        self.assertEqual(errno.ENODATA, cm.exception.errno)
 
     def test_default_path(self):
         self.os.chdir(self.dir_path)
         self.os.setxattr(self.dir_path, b"test", b"value")
         self.assertEqual(["test"], self.os.listxattr())
         self.assertEqual(b"value", self.os.getxattr(self.dir_path, "test"))
 
@@ -5387,15 +5647,15 @@
 class FakeOsUnreadableDirTest(FakeOsModuleTestBase):
     def setUp(self):
         if self.use_real_fs():
             # unreadable dirs in Windows are only simulated
             # and cannot be created in the real OS using file system
             # functions only
             self.check_posix_only()
-        super(FakeOsUnreadableDirTest, self).setUp()
+        super().setUp()
         self.dir_path = self.make_path("some_dir")
         self.file_path = self.os.path.join(self.dir_path, "some_file")
         self.create_file(self.file_path)
         self.chmod(self.dir_path, 0o000)
 
     def chmod(self, path, mode):
         if self.is_windows_fs:
@@ -5406,25 +5666,25 @@
     def test_getuid(self):
         self.skip_real_fs()  # won't change user in real fs
         self.check_posix_only()
         uid = self.os.getuid()
         set_uid(uid + 10)
         self.assertEqual(uid + 10, self.os.getuid())
         self.assertEqual(uid + 10, get_uid())
-        set_uid(uid)
+        reset_ids()
         self.assertEqual(uid, self.os.getuid())
 
     def test_getgid(self):
         self.skip_real_fs()  # won't change group in real fs
         self.check_posix_only()
         gid = self.os.getgid()
         set_gid(gid + 10)
         self.assertEqual(gid + 10, self.os.getgid())
         self.assertEqual(gid + 10, get_gid())
-        set_gid(gid)
+        reset_ids()
         self.assertEqual(gid, self.os.getgid())
 
     def test_listdir_unreadable_dir(self):
         if not is_root():
             self.assert_raises_os_error(errno.EACCES, self.os.listdir, self.dir_path)
         else:
             self.assertEqual(["some_file"], self.os.listdir(self.dir_path))
@@ -5435,58 +5695,59 @@
         self.chmod(self.dir_path, 0o000)
 
     def test_listdir_user_readable_dir_from_other_user(self):
         self.skip_real_fs()  # won't change user in real fs
         self.check_posix_only()
         user_id = get_uid()
         set_uid(user_id + 1)
-        dir_path = self.make_path("dir1")
+        dir_path = "/dir1"
         self.create_dir(dir_path, perm=0o600)
         self.assertTrue(self.os.path.exists(dir_path))
-        set_uid(user_id)
+        reset_ids()
         if not is_root():
             with self.assertRaises(PermissionError):
                 self.os.listdir(dir_path)
         else:
             self.assertEqual(["some_file"], self.os.listdir(self.dir_path))
 
     def test_listdir_group_readable_dir_from_other_user(self):
         self.skip_real_fs()  # won't change user in real fs
-        user_id = get_uid()
-        set_uid(user_id + 1)
-        dir_path = self.make_path("dir1")
+        self.check_posix_only()
+        set_uid(get_uid() + 1)
+        dir_path = "/dir1"
         self.create_dir(dir_path, perm=0o660)
         self.assertTrue(self.os.path.exists(dir_path))
-        set_uid(user_id)
+        reset_ids()
         self.assertEqual([], self.os.listdir(dir_path))
 
     def test_listdir_group_readable_dir_from_other_group(self):
         self.skip_real_fs()  # won't change user in real fs
         self.check_posix_only()
         group_id = self.os.getgid()
         set_gid(group_id + 1)
-        dir_path = self.make_path("dir1")
+        dir_path = "/dir1"
         self.create_dir(dir_path, perm=0o060)
         self.assertTrue(self.os.path.exists(dir_path))
         set_gid(group_id)
         if not is_root():
             with self.assertRaises(PermissionError):
                 self.os.listdir(dir_path)
         else:
             self.assertEqual([], self.os.listdir(dir_path))
 
     def test_listdir_other_readable_dir_from_other_group(self):
+        self.check_posix_only()
         self.skip_real_fs()  # won't change user in real fs
-        group_id = get_gid()
-        set_gid(group_id + 1)
         dir_path = self.make_path("dir1")
-        self.create_dir(dir_path, perm=0o004)
+        self.create_dir(dir_path, 0o004)
+        set_uid(get_uid() + 1)
+        set_gid(get_gid() + 1)
         self.assertTrue(self.os.path.exists(dir_path))
-        set_gid(group_id)
         self.assertEqual([], self.os.listdir(dir_path))
+        reset_ids()
 
     def test_stat_unreadable_dir(self):
         self.assertEqual(0, self.os.stat(self.dir_path).st_mode & 0o666)
 
     def test_chmod_unreadable_dir(self):
         self.chmod(self.dir_path, 0o666)
         self.assertEqual(0o666, self.os.stat(self.dir_path).st_mode & 0o666)
@@ -5504,21 +5765,21 @@
         dir_path = self.make_path("dir1")
         self.create_dir(dir_path, perm=0o000)
         self.assertTrue(self.os.path.exists(dir_path))
         self.os.rmdir(dir_path)
         self.assertFalse(self.os.path.exists(dir_path))
 
     def test_remove_unreadable_dir_from_other_user(self):
+        self.check_posix_only()
         self.skip_real_fs()  # won't change user in real fs
-        user_id = get_uid()
-        set_uid(user_id + 1)
-        dir_path = self.make_path("dir1")
+        set_uid(get_uid() + 1)
+        dir_path = "/dir1"
         self.create_dir(dir_path, perm=0o000)
         self.assertTrue(self.os.path.exists(dir_path))
-        set_uid(user_id)
+        reset_ids()
         if not is_root():
             with self.assertRaises(PermissionError):
                 self.os.rmdir(dir_path)
             self.assertTrue(self.os.path.exists(dir_path))
         else:
             self.os.rmdir(dir_path)
             self.assertFalse(self.os.path.exists(dir_path))
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_pathlib_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_pathlib_test.py`

 * *Files 8% similar despite different names*

```diff
@@ -282,14 +282,15 @@
     def use_real_fs(self):
         return True
 
 
 class FakePathlibFileObjectPropertyTest(RealPathlibTestCase):
     def setUp(self):
         super(FakePathlibFileObjectPropertyTest, self).setUp()
+        self.umask = self.os.umask(0o022)
         self.file_path = self.make_path("home", "jane", "test.py")
         self.create_file(self.file_path, contents=b"a" * 100)
         self.create_dir(self.make_path("home", "john"))
         try:
             self.skip_if_symlink_not_supported()
         except unittest.SkipTest:
             return
@@ -300,14 +301,17 @@
             self.make_path("broken_dir_link"), self.make_path("home", "none")
         )
         self.create_symlink(
             self.make_path("broken_file_link"),
             self.make_path("home", "none", "test.py"),
         )
 
+    def tearDown(self):
+        self.os.umask(self.umask)
+
     def test_exists(self):
         self.skip_if_symlink_not_supported()
         self.assertTrue(self.path(self.file_path).exists())
         self.assertTrue(self.path(self.make_path("home", "jane")).exists())
         self.assertFalse(self.path(self.make_path("home", "jane", "test")).exists())
         self.assertTrue(self.path(self.make_path("john")).exists())
         self.assertTrue(self.path(self.file_link_path).exists())
@@ -369,33 +373,34 @@
         self.check_lstat(len(self.file_path))
 
     @unittest.skipIf(not is_windows, "Windows specific behavior")
     def test_lstat_windows(self):
         self.skip_if_symlink_not_supported()
         self.check_lstat(0)
 
-    @unittest.skipIf(is_windows, "Linux specific behavior")
+    @unittest.skipIf(is_windows, "POSIX specific behavior")
     def test_chmod(self):
-        self.check_linux_only()
+        self.check_posix_only()
         file_stat = self.os.stat(self.file_path)
-        self.assertEqual(file_stat.st_mode, stat.S_IFREG | 0o666)
+        self.assertEqual(file_stat.st_mode, stat.S_IFREG | 0o644)
         link_stat = self.os.lstat(self.file_link_path)
         # we get stat.S_IFLNK | 0o755 under MacOs
-        self.assertEqual(link_stat.st_mode, stat.S_IFLNK | 0o777)
+        mode = 0o755 if self.is_macos else 0o777
+        self.assertEqual(link_stat.st_mode, stat.S_IFLNK | mode)
 
     def test_lchmod(self):
         self.skip_if_symlink_not_supported()
         file_stat = self.os.stat(self.file_path)
         link_stat = self.os.lstat(self.file_link_path)
         if not hasattr(self.real_os, "lchmod"):
             with self.assertRaises(NotImplementedError):
                 self.path(self.file_link_path).lchmod(0o444)
         else:
             self.path(self.file_link_path).lchmod(0o444)
-            self.assertEqual(file_stat.st_mode, stat.S_IFREG | 0o666)
+            self.assertEqual(file_stat.st_mode, stat.S_IFREG | 0o644)
             # the exact mode depends on OS and Python version
             self.assertEqual(link_stat.st_mode & 0o777700, stat.S_IFLNK | 0o700)
 
     @unittest.skipIf(
         sys.version_info < (3, 10),
         "follow_symlinks argument new in Python 3.10",
     )
@@ -404,15 +409,15 @@
         file_stat = self.os.stat(self.file_path)
         link_stat = self.os.lstat(self.file_link_path)
         if self.os.chmod not in self.os.supports_follow_symlinks or IS_PYPY:
             with self.assertRaises(NotImplementedError):
                 self.path(self.file_link_path).chmod(0o444, follow_symlinks=False)
         else:
             self.path(self.file_link_path).chmod(0o444, follow_symlinks=False)
-            self.assertEqual(file_stat.st_mode, stat.S_IFREG | 0o666)
+            self.assertEqual(file_stat.st_mode, stat.S_IFREG | 0o644)
             # the exact mode depends on OS and Python version
             self.assertEqual(link_stat.st_mode & 0o777700, stat.S_IFLNK | 0o700)
 
     def test_resolve(self):
         self.create_dir(self.make_path("antoine", "docs"))
         self.create_file(self.make_path("antoine", "setup.py"))
         self.os.chdir(self.make_path("antoine"))
@@ -446,14 +451,59 @@
         it = self.path(dir_path).iterdir()
         if not is_root():
             self.assert_raises_os_error(errno.EACCES, list, it)
         else:
             path = str(list(it)[0])
             self.assertTrue(path.endswith("some_file"))
 
+    def test_iterdir_and_glob_without_exe_permission(self):
+        # regression test for #960
+        self.check_posix_only()
+        self.skip_root()
+        directory = self.path(self.make_path("testdir"))
+        file_path = directory / "file.txt"
+        self.create_file(file_path, contents="hey", perm=0o777)
+        directory.chmod(0o655)  # rw-r-xr-x
+        # We cannot create any files in the directory, because that requires
+        # searching it
+        another_file = self.path(self.make_path("file.txt"))
+        self.create_file(another_file, contents="hey")
+        with self.assertRaises(PermissionError):
+            self.os.link(another_file, directory / "link.txt")
+        # We can enumerate the directory using iterdir and glob:
+        assert len(list(directory.iterdir())) == 1
+        assert list(directory.iterdir())[0] == file_path
+        assert len(list(directory.glob("*.txt"))) == 1
+        assert list(directory.glob("*.txt"))[0] == file_path
+
+        # We cannot read files inside of the directory,
+        # even if we have read access to the file
+        with self.assertRaises(PermissionError):
+            file_path.stat()
+        with self.assertRaises(PermissionError):
+            file_path.read_text(encoding="utf8")
+
+    def test_iterdir_impossible_without_read_permission(self):
+        # regression test for #960
+        self.check_posix_only()
+        self.skip_root()
+        directory = self.path(self.make_path("testdir"))
+        file_path = directory / "file.txt"
+        self.create_file(file_path, contents="hey", perm=0o777)
+        directory.chmod(0o355)  # -wxr-xr-x
+
+        # We cannot enumerate the directory using iterdir:
+        with self.assertRaises(PermissionError):
+            list(directory.iterdir())
+        # glob does not find the file
+        assert len(list(directory.glob("*.txt"))) == 0
+        # we can access the file if we know the file name
+        assert file_path.stat().st_mode & 0o777 == 0o755
+        assert file_path.read_text(encoding="utf8") == "hey"
+
     def test_resolve_nonexisting_file(self):
         path = self.path(self.make_path("/path", "to", "file", "this can not exist"))
         self.assertEqual(path, path.resolve())
 
     def test_cwd(self):
         dir_path = self.make_path("jane")
         self.create_dir(dir_path)
@@ -513,22 +563,22 @@
         self.assertTrue(self.path(self.make_path("john")).exists())
         self.assertFalse(self.path(self.make_path("none")).exists())
         self.assertFalse(self.path(self.make_path("home", "jane", "test")).exists())
 
     def test_open(self):
         self.create_dir(self.make_path("foo"))
         with self.assertRaises(OSError):
-            self.path(self.make_path("foo", "bar.txt")).open()
-        self.path(self.make_path("foo", "bar.txt")).open("w").close()
+            self.path(self.make_path("foo", "bar.txt")).open(encoding="utf8")
+        self.path(self.make_path("foo", "bar.txt")).open("w", encoding="utf8").close()
         self.assertTrue(self.os.path.exists(self.make_path("foo", "bar.txt")))
 
     def test_read_text(self):
         self.create_file(self.make_path("text_file"), contents="foo")
         file_path = self.path(self.make_path("text_file"))
-        self.assertEqual(file_path.read_text(), "foo")
+        self.assertEqual(file_path.read_text(encoding="utf8"), "foo")
 
     @unittest.skipIf(
         sys.version_info < (3, 12),
         "is_junction method new in Python 3.12",
     )
     def test_is_junction(self):
         self.create_file(self.make_path("text_file"), contents="foo")
@@ -541,35 +591,35 @@
         )
         file_path = self.path(self.make_path("text_file"))
         self.assertEqual(file_path.read_text(encoding="cyrillic"), "")
 
     def test_write_text(self):
         path_name = self.make_path("text_file")
         file_path = self.path(path_name)
-        file_path.write_text(str("foo"))
+        file_path.write_text("foo", encoding="utf8")
         self.assertTrue(self.os.path.exists(path_name))
         self.check_contents(path_name, "foo")
 
     def test_write_text_with_encoding(self):
         path_name = self.make_path("text_file")
         file_path = self.path(path_name)
         file_path.write_text("", encoding="greek")
         self.assertTrue(self.os.path.exists(path_name))
         self.check_contents(path_name, "".encode("greek"))
 
     @unittest.skipIf(sys.version_info < (3, 10), "newline argument new in Python 3.10")
     def test_write_with_newline_arg(self):
         path = self.path(self.make_path("some_file"))
-        path.write_text("1\r\n2\n3\r4", newline="")
+        path.write_text("1\r\n2\n3\r4", newline="", encoding="utf8")
         self.check_contents(path, b"1\r\n2\n3\r4")
-        path.write_text("1\r\n2\n3\r4", newline="\n")
+        path.write_text("1\r\n2\n3\r4", newline="\n", encoding="utf8")
         self.check_contents(path, b"1\r\n2\n3\r4")
-        path.write_text("1\r\n2\n3\r4", newline="\r\n")
+        path.write_text("1\r\n2\n3\r4", newline="\r\n", encoding="utf8")
         self.check_contents(path, b"1\r\r\n2\r\n3\r4")
-        path.write_text("1\r\n2\n3\r4", newline="\r")
+        path.write_text("1\r\n2\n3\r4", newline="\r", encoding="utf8")
         self.check_contents(path, b"1\r\r2\r3\r4")
 
     def test_read_bytes(self):
         path_name = self.make_path("binary_file")
         self.create_file(path_name, contents=b"Binary file contents")
         file_path = self.path(path_name)
         self.assertEqual(file_path.read_bytes(), b"Binary file contents")
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_stat_time_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_stat_time_test.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,14 +7,15 @@
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """Unit tests for file timestamp updates."""
+
 import time
 import unittest
 from collections import namedtuple
 
 from pyfakefs.tests.test_utils import RealFsTestCase
 
 FileTime = namedtuple("FileTime", "st_ctime, st_atime, st_mtime")
@@ -56,112 +57,112 @@
         if self.is_windows_fs:
             self.assertLess(time1, time2)
         else:
             self.assertEqual(time1, time2)
 
     def open_close_new_file(self):
         with self.mock_time():
-            with self.open(self.file_path, self.mode):
+            with self.open(self.file_path, self.mode, encoding="utf8"):
                 created = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
             return created, closed
 
     def open_write_close_new_file(self):
         with self.mock_time():
-            with self.open(self.file_path, self.mode) as f:
+            with self.open(self.file_path, self.mode, encoding="utf8") as f:
                 created = self.stat_time(self.file_path)
                 f.write("foo")
                 written = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
         return created, written, closed
 
     def open_close(self):
         with self.mock_time():
             self.create_file(self.file_path)
 
             before = self.stat_time(self.file_path)
-            with self.open(self.file_path, self.mode):
+            with self.open(self.file_path, self.mode, encoding="utf8"):
                 opened = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return before, opened, closed
 
     def open_write_close(self):
         with self.mock_time():
             self.create_file(self.file_path)
 
             before = self.stat_time(self.file_path)
-            with self.open(self.file_path, self.mode) as f:
+            with self.open(self.file_path, self.mode, encoding="utf8") as f:
                 opened = self.stat_time(self.file_path)
                 f.write("foo")
                 written = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return before, opened, written, closed
 
     def open_flush_close(self):
         with self.mock_time():
             self.create_file(self.file_path)
 
             before = self.stat_time(self.file_path)
-            with self.open(self.file_path, self.mode) as f:
+            with self.open(self.file_path, self.mode, encoding="utf8") as f:
                 opened = self.stat_time(self.file_path)
                 f.flush()
                 flushed = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return before, opened, flushed, closed
 
     def open_write_flush(self):
         with self.mock_time():
             self.create_file(self.file_path)
 
             before = self.stat_time(self.file_path)
-            with self.open(self.file_path, self.mode) as f:
+            with self.open(self.file_path, self.mode, encoding="utf8") as f:
                 opened = self.stat_time(self.file_path)
                 f.write("foo")
                 written = self.stat_time(self.file_path)
                 f.flush()
                 flushed = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return before, opened, written, flushed, closed
 
     def open_read_flush(self):
         with self.mock_time():
             self.create_file(self.file_path)
 
             before = self.stat_time(self.file_path)
-            with self.open(self.file_path, "r") as f:
+            with self.open(self.file_path, "r", encoding="utf8") as f:
                 opened = self.stat_time(self.file_path)
                 f.read()
                 read = self.stat_time(self.file_path)
                 f.flush()
                 flushed = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return before, opened, read, flushed, closed
 
     def open_read_close_new_file(self):
         with self.mock_time():
-            with self.open(self.file_path, self.mode) as f:
+            with self.open(self.file_path, self.mode, encoding="utf8") as f:
                 created = self.stat_time(self.file_path)
                 f.read()
                 read = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return created, read, closed
 
     def open_read_close(self):
         with self.mock_time():
             self.create_file(self.file_path)
 
             before = self.stat_time(self.file_path)
-            with self.open(self.file_path, self.mode) as f:
+            with self.open(self.file_path, self.mode, encoding="utf8") as f:
                 opened = self.stat_time(self.file_path)
                 f.read()
                 read = self.stat_time(self.file_path)
             closed = self.stat_time(self.file_path)
 
             return before, opened, read, closed
 
@@ -406,15 +407,15 @@
     def test_open_flush_close(self):
         self.check_open_flush_close_w_mode()
 
     def test_open_write_flush_close(self):
         self.check_open_write_flush_close_w_mode()
 
     def test_read_raises(self):
-        with self.open(self.file_path, "w") as f:
+        with self.open(self.file_path, "w", encoding="utf8") as f:
             with self.assertRaises(OSError):
                 f.read()
 
 
 class TestRealModeW(TestFakeModeW):
     def use_real_fs(self):
         return True
@@ -493,15 +494,15 @@
     def test_open_flush_close(self):
         self.check_open_flush_close_non_w_mode()
 
     def test_open_write_flush_close(self):
         self.check_open_write_flush_close_non_w_mode()
 
     def test_read_raises(self):
-        with self.open(self.file_path, "a") as f:
+        with self.open(self.file_path, "a", encoding="utf8") as f:
             with self.assertRaises(OSError):
                 f.read()
 
 
 class TestRealModeA(TestFakeModeA):
     def use_real_fs(self):
         return True
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fake_tempfile_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/fake_tempfile_test.py`

 * *Files 2% similar despite different names*

```diff
@@ -40,15 +40,15 @@
     def test_named_temporary_file_no_delete(self):
         obj = tempfile.NamedTemporaryFile(delete=False)
         obj.write(b"foo")
         obj.close()
         file_obj = self.fs.get_object(obj.name)
         contents = file_obj.contents
         self.assertEqual("foo", contents)
-        obj = tempfile.NamedTemporaryFile(mode="w", delete=False)
+        obj = tempfile.NamedTemporaryFile(mode="w", encoding="utf8", delete=False)
         obj.write("foo")
         obj.close()
         file_obj = self.fs.get_object(obj.name)
         self.assertEqual("foo", file_obj.contents)
 
     def test_mkstemp(self):
         next_fd = len(self.fs.open_files)
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fixtures/deprecated_property.py` & `pyfakefs-5.4.0/pyfakefs/tests/fixtures/deprecated_property.py`

 * *Files 1% similar despite different names*

```diff
@@ -10,14 +10,15 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """Used for testing suppression of deprecation warnings while iterating
 over modules. The code is modeled after code in xmlbuilder.py in Python 3.6.
 See issue #542.
 """
+
 import warnings
 
 
 class DeprecatedProperty:
     def __get__(self, instance, cls):
         warnings.warn("async is deprecated", DeprecationWarning, stacklevel=2)
         warnings.warn("async will be replaced", FutureWarning, stacklevel=2)
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/fixtures/module_with_attributes.py` & `pyfakefs-5.4.0/pyfakefs/tests/fixtures/module_with_attributes.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/import_as_example.py` & `pyfakefs-5.4.0/pyfakefs/tests/import_as_example.py`

 * *Files 4% similar despite different names*

```diff
@@ -10,14 +10,15 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """
 Example module that is used for testing modules that import file system modules
 to be patched under another name.
 """
+
 import os as my_os
 import pathlib
 import sys
 from builtins import open as bltn_open
 from io import open as io_open
 from os import path
 from os import stat
@@ -91,31 +92,31 @@
         from nt import stat as system_stat
     else:
         from posix import stat as system_stat
     return system_stat(filepath)
 
 
 def file_contents1(filepath):
-    with bltn_open(filepath) as f:
+    with bltn_open(filepath, encoding="utf8") as f:
         return f.read()
 
 
 def file_contents2(filepath):
-    with io_open(filepath) as f:
+    with io_open(filepath, encoding="utf8") as f:
         return f.read()
 
 
 def exists_this_file():
     """Returns True in real fs only"""
     return exists(__file__)
 
 
 def open_this_file():
     """Works only in real fs"""
-    with open(__file__):
+    with open(__file__, encoding="utf8"):
         pass
 
 
 def return_this_file_path():
     """Works only in real fs"""
     return Path(__file__)
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/logsio.py` & `pyfakefs-5.4.0/pyfakefs/tests/logsio.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/mox3_stubout_example.py` & `pyfakefs-5.4.0/pyfakefs/tests/mox3_stubout_example.py`

 * *Files 1% similar despite different names*

```diff
@@ -10,14 +10,15 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """
 Example module that is used for testing the functionality of
 :py:class`pyfakefs.mox_stubout.StubOutForTesting`.
 """
+
 import datetime
 import math
 import os
 
 
 def check_if_exists(filepath):
     return os.path.exists(filepath)
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/mox3_stubout_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/mox3_stubout_test.py`

 * *Files identical despite different names*

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/patched_packages_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/patched_packages_test.py`

 * *Files 0% similar despite different names*

```diff
@@ -10,14 +10,15 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """
 Provides patches for some commonly used modules that enable them to work
 with pyfakefs.
 """
+
 import os
 import sys
 import unittest
 
 from pyfakefs import fake_filesystem_unittest
 from pyfakefs.helpers import IS_PYPY
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/performance_test.py` & `pyfakefs-5.4.0/pyfakefs/tests/performance_test.py`

 * *Files 0% similar despite different names*

```diff
@@ -6,14 +6,15 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 """Shall provide tests to check performance overhead of pyfakefs."""
+
 import os
 import time
 import unittest
 
 from pyfakefs.fake_filesystem_unittest import TestCase
 from pyfakefs.helpers import IS_PYPY
```

### Comparing `pyfakefs-5.3.5/pyfakefs/tests/test_utils.py` & `pyfakefs-5.4.0/pyfakefs/tests/test_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -11,26 +11,27 @@
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # Disable attribute errors - attributes not be found in mixin (shall be cleaned up...)
 # pytype: disable=attribute-error
 """Common helper classes used in tests, or as test class base."""
+
 import os
 import platform
 import shutil
 import stat
 import sys
 import tempfile
 import unittest
 from contextlib import contextmanager
 from unittest import mock
 
 from pyfakefs import fake_filesystem, fake_open, fake_os
-from pyfakefs.helpers import is_byte_string, to_string
+from pyfakefs.helpers import is_byte_string, to_string, is_root
 
 
 class DummyTime:
     """Mock replacement for time.time. Increases returned time on access."""
 
     def __init__(self, curr_time, increment):
         self.current_time = curr_time
@@ -223,14 +224,20 @@
         """
         if self.use_real_fs():
             if TestCase.is_windows:
                 raise unittest.SkipTest("Testing Posix specific functionality")
         else:
             self.set_windows_fs(False)
 
+    @staticmethod
+    def skip_root():
+        """Skips the test if run as root."""
+        if is_root():
+            raise unittest.SkipTest("Test only valid for non-root user")
+
     def skip_real_fs(self):
         """If called at test start, no real FS test is executed."""
         if self.use_real_fs():
             raise unittest.SkipTest("Only tests fake FS")
 
     def skip_real_fs_failure(
         self,
@@ -301,15 +308,15 @@
             path = self.base_path
             for arg in args[0]:
                 path = self.os.path.join(path, to_string(arg))
             return path
         args = [to_string(arg) for arg in args]
         return self.os.path.join(self.base_path, *args)
 
-    def create_dir(self, dir_path, perm=0o777):
+    def create_dir(self, dir_path, perm=0o777, apply_umask=True):
         """Create the directory at `dir_path`, including subdirectories.
         `dir_path` shall be composed using `make_path()`.
         """
         if not dir_path:
             return
         existing_path = dir_path
         components = []
@@ -321,44 +328,60 @@
                     self.filesystem.add_mount_point(existing_path)
                 break
             components.insert(0, component)
         for component in components:
             existing_path = self.os.path.join(existing_path, component)
             self.os.mkdir(existing_path)
             self.os.chmod(existing_path, 0o777)
+        if apply_umask:
+            umask = self.os.umask(0o022)
+            perm &= ~umask
+            self.os.umask(umask)
         self.os.chmod(dir_path, perm)
 
-    def create_file(self, file_path, contents=None, encoding=None, perm=0o666):
+    def create_file(
+        self, file_path, contents=None, encoding=None, perm=0o666, apply_umask=True
+    ):
         """Create the given file at `file_path` with optional contents,
         including subdirectories. `file_path` shall be composed using
         `make_path()`.
         """
         self.create_dir(self.os.path.dirname(file_path))
         mode = "wb" if encoding is not None or is_byte_string(contents) else "w"
+        kwargs = {"mode": mode}
 
         if encoding is not None and contents is not None:
             contents = contents.encode(encoding)
-        with self.open(file_path, mode) as f:
+        if mode == "w":
+            kwargs["encoding"] = "utf8"
+        with self.open(file_path, **kwargs) as f:
             if contents is not None:
                 f.write(contents)
+        if apply_umask:
+            umask = self.os.umask(0o022)
+            perm &= ~umask
+            self.os.umask(umask)
         self.os.chmod(file_path, perm)
 
     def create_symlink(self, link_path, target_path):
         """Create the path at `link_path`, and a symlink to this path at
         `target_path`. `link_path` shall be composed using `make_path()`.
         """
         self.create_dir(self.os.path.dirname(link_path))
         self.os.symlink(target_path, link_path)
 
     def check_contents(self, file_path, contents):
         """Compare `contents` with the contents of the file at `file_path`.
         Asserts equality.
         """
         mode = "rb" if is_byte_string(contents) else "r"
-        with self.open(file_path, mode) as f:
+        kwargs = {"mode": mode}
+        if mode == "r":
+            kwargs["encoding"] = "utf8"
+        with self.open(file_path, **kwargs) as f:
             self.assertEqual(contents, f.read())
 
     def create_basepath(self):
         """Create the path used as base path in `make_path`."""
         if self.filesystem is not None:
             old_base_path = self.base_path
             self.base_path = self.filesystem.path_separator + "basepath"
```

### Comparing `pyfakefs-5.3.5/pyfakefs.egg-info/PKG-INFO` & `pyfakefs-5.4.0/pyfakefs.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: pyfakefs
-Version: 5.3.5
+Version: 5.4.0
 Summary: pyfakefs implements a fake file system that mocks the Python file system modules.
 Home-page: https://github.com/pytest-dev/pyfakefs
 Author: Google
 Author-email: google-pyfakefs@google.com
 Maintainer: John McGehee
 Maintainer-email: pyfakefs@johnnado.com
 License: http://www.apache.org/licenses/LICENSE-2.0
@@ -152,15 +152,15 @@
 [Contributing Guide](https://github.com/pytest-dev/pyfakefs/blob/main/CONTRIBUTING.md)
 for more information.
 
 ## History
 pyfakefs.py was initially developed at Google by Mike Bland as a modest fake
 implementation of core Python modules.  It was introduced to all of Google
 in September 2006. Since then, it has been enhanced to extend its
-functionality and usefulness.  At last count, pyfakefs was used in over 2,000
+functionality and usefulness.  At last count, pyfakefs was used in over 20,000
 Python tests at Google.
 
 Google released pyfakefs to the public in 2011 as Google Code project
 [pyfakefs](http://code.google.com/p/pyfakefs/):
 * Fork
   [jmcgeheeiv-pyfakefs](http://code.google.com/p/jmcgeheeiv-pyfakefs/) added
   [direct support for unittest and doctest](../../wiki/Automatically-find-and-patch-file-functions-and-modules)
```

### Comparing `pyfakefs-5.3.5/pyfakefs.egg-info/SOURCES.txt` & `pyfakefs-5.4.0/pyfakefs.egg-info/SOURCES.txt`

 * *Files 3% similar despite different names*

```diff
@@ -41,14 +41,16 @@
 pyfakefs/pytest_tests/pytest_check_failed_plugin_test.py
 pyfakefs/pytest_tests/pytest_doctest_test.py
 pyfakefs/pytest_tests/pytest_fixture_param_test.py
 pyfakefs/pytest_tests/pytest_fixture_test.py
 pyfakefs/pytest_tests/pytest_module_fixture_test.py
 pyfakefs/pytest_tests/pytest_plugin_failing_helper.py
 pyfakefs/pytest_tests/pytest_plugin_test.py
+pyfakefs/pytest_tests/pytest_reload_pandas_test.py
+pyfakefs/pytest_tests/unhashable.py
 pyfakefs/tests/__init__.py
 pyfakefs/tests/all_tests.py
 pyfakefs/tests/all_tests_without_extra_packages.py
 pyfakefs/tests/dynamic_patch_test.py
 pyfakefs/tests/example.py
 pyfakefs/tests/example_test.py
 pyfakefs/tests/fake_filesystem_glob_test.py
```

### Comparing `pyfakefs-5.3.5/setup.cfg` & `pyfakefs-5.4.0/setup.cfg`

 * *Files identical despite different names*

